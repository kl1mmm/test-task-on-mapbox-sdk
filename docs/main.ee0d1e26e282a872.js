(self.webpackChunkMapboxTask=self.webpackChunkMapboxTask||[]).push([[179],{357:function(Zd){Zd.exports=function(){"use strict";var qs=function(I,L){var j={drag:[],click:[],mousemove:[],mousedown:[],mouseup:[],mouseout:[],keydown:[],keyup:[],touchstart:[],touchmove:[],touchend:[],tap:[]},tt={on:function(ut,gt,Et){if(void 0===j[ut])throw new Error("Invalid event type: "+ut);j[ut].push({selector:gt,fn:Et})},render:function(ut){L.store.featureChanged(ut)}},lt=function(ut,gt){for(var Et=j[ut],Xt=Et.length;Xt--;){var ce=Et[Xt];if(ce.selector(gt)){ce.fn.call(tt,gt)||L.store.render(),L.ui.updateMapClasses();break}}};return I.start.call(tt),{render:I.render,stop:function(){I.stop&&I.stop()},trash:function(){I.trash&&(I.trash(),L.store.render())},combineFeatures:function(){I.combineFeatures&&I.combineFeatures()},uncombineFeatures:function(){I.uncombineFeatures&&I.uncombineFeatures()},drag:function(ut){lt("drag",ut)},click:function(ut){lt("click",ut)},mousemove:function(ut){lt("mousemove",ut)},mousedown:function(ut){lt("mousedown",ut)},mouseup:function(ut){lt("mouseup",ut)},mouseout:function(ut){lt("mouseout",ut)},keydown:function(ut){lt("keydown",ut)},keyup:function(ut){lt("keyup",ut)},touchstart:function(ut){lt("touchstart",ut)},touchmove:function(ut){lt("touchmove",ut)},touchend:function(ut){lt("touchend",ut)},tap:function(ut){lt("tap",ut)}}};function Qi(I){return I&&I.__esModule&&Object.prototype.hasOwnProperty.call(I,"default")?I.default:I}var Hl={},se={RADIUS:6378137,FLATTENING:1/298.257223563,POLAR_RADIUS:6356752.3142};function ft(I){var L=0;if(I&&I.length>0){L+=Math.abs(po(I[0]));for(var j=1;j<I.length;j++)L-=Math.abs(po(I[j]))}return L}function po(I){var L,j,tt,lt,ut,gt,Et=0,Xt=I.length;if(Xt>2){for(gt=0;gt<Xt;gt++)gt===Xt-2?(tt=Xt-2,lt=Xt-1,ut=0):gt===Xt-1?(tt=Xt-1,lt=0,ut=1):(tt=gt,lt=gt+1,ut=gt+2),L=I[tt],j=I[lt],Et+=(Po(I[ut][0])-Po(L[0]))*Math.sin(Po(j[1]));Et=Et*se.RADIUS*se.RADIUS/2}return Et}function Po(I){return I*Math.PI/180}Hl.geometry=function I(L){var j,tt=0;switch(L.type){case"Polygon":return ft(L.coordinates);case"MultiPolygon":for(j=0;j<L.coordinates.length;j++)tt+=ft(L.coordinates[j]);return tt;case"Point":case"MultiPoint":case"LineString":case"MultiLineString":return 0;case"GeometryCollection":for(j=0;j<L.geometries.length;j++)tt+=I(L.geometries[j]);return tt}},Hl.ring=po;var Te={CONTROL_BASE:"mapboxgl-ctrl",CONTROL_PREFIX:"mapboxgl-ctrl-",CONTROL_BUTTON:"mapbox-gl-draw_ctrl-draw-btn",CONTROL_BUTTON_LINE:"mapbox-gl-draw_line",CONTROL_BUTTON_POLYGON:"mapbox-gl-draw_polygon",CONTROL_BUTTON_POINT:"mapbox-gl-draw_point",CONTROL_BUTTON_TRASH:"mapbox-gl-draw_trash",CONTROL_BUTTON_COMBINE_FEATURES:"mapbox-gl-draw_combine",CONTROL_BUTTON_UNCOMBINE_FEATURES:"mapbox-gl-draw_uncombine",CONTROL_GROUP:"mapboxgl-ctrl-group",ATTRIBUTION:"mapboxgl-ctrl-attrib",ACTIVE_BUTTON:"active",BOX_SELECT:"mapbox-gl-draw_boxselect"},Pr={HOT:"mapbox-gl-draw-hot",COLD:"mapbox-gl-draw-cold"},Hn={ADD:"add",MOVE:"move",DRAG:"drag",POINTER:"pointer",NONE:"none"},Zr={POLYGON:"polygon",LINE:"line_string",POINT:"point"},Pe={FEATURE:"Feature",POLYGON:"Polygon",LINE_STRING:"LineString",POINT:"Point",FEATURE_COLLECTION:"FeatureCollection",MULTI_PREFIX:"Multi",MULTI_POINT:"MultiPoint",MULTI_LINE_STRING:"MultiLineString",MULTI_POLYGON:"MultiPolygon"},pn={DRAW_LINE_STRING:"draw_line_string",DRAW_POLYGON:"draw_polygon",DRAW_POINT:"draw_point",SIMPLE_SELECT:"simple_select",DIRECT_SELECT:"direct_select",STATIC:"static"},Bi={CREATE:"draw.create",DELETE:"draw.delete",UPDATE:"draw.update",SELECTION_CHANGE:"draw.selectionchange",MODE_CHANGE:"draw.modechange",ACTIONABLE:"draw.actionable",RENDER:"draw.render",COMBINE_FEATURES:"draw.combine",UNCOMBINE_FEATURES:"draw.uncombine"},il={MOVE:"move",CHANGE_COORDINATES:"change_coordinates"},rr={FEATURE:"feature",MIDPOINT:"midpoint",VERTEX:"vertex"},dr={ACTIVE:"true",INACTIVE:"false"},ss=["scrollZoom","boxZoom","dragRotate","dragPan","keyboard","doubleClickZoom","touchZoomRotate"],ql=-85,ya=Object.freeze({__proto__:null,classes:Te,sources:Pr,cursors:Hn,types:Zr,geojsonTypes:Pe,modes:pn,events:Bi,updateActions:il,meta:rr,activeStates:dr,interactions:ss,LAT_MIN:-90,LAT_RENDERED_MIN:ql,LAT_MAX:90,LAT_RENDERED_MAX:85,LNG_MIN:-270,LNG_MAX:270}),as={Point:0,LineString:1,MultiLineString:1,Polygon:2};function it(I,L){var j=as[I.geometry.type]-as[L.geometry.type];return 0===j&&I.geometry.type===Pe.POLYGON?I.area-L.area:j}function tn(I){return I.map(function(L){return L.geometry.type===Pe.POLYGON&&(L.area=Hl.geometry({type:Pe.FEATURE,property:{},geometry:L.geometry})),L}).sort(it).map(function(L){return delete L.area,L})}function va(I,L){return void 0===L&&(L=0),[[I.point.x-L,I.point.y-L],[I.point.x+L,I.point.y+L]]}function ti(I){if(this._items={},this._nums={},this._length=I?I.length:0,I)for(var L=0,j=I.length;L<j;L++)this.add(I[L]),void 0!==I[L]&&("string"==typeof I[L]?this._items[I[L]]=L:this._nums[I[L]]=L)}ti.prototype.add=function(I){return this.has(I)||(this._length++,"string"==typeof I?this._items[I]=this._length:this._nums[I]=this._length),this},ti.prototype.delete=function(I){return!1===this.has(I)||(this._length--,delete this._items[I],delete this._nums[I]),this},ti.prototype.has=function(I){return!("string"!=typeof I&&"number"!=typeof I||void 0===this._items[I]&&void 0===this._nums[I])},ti.prototype.values=function(){var I=this,L=[];return Object.keys(this._items).forEach(function(j){L.push({k:j,v:I._items[j]})}),Object.keys(this._nums).forEach(function(j){L.push({k:JSON.parse(j),v:I._nums[j]})}),L.sort(function(j,tt){return j.v-tt.v}).map(function(j){return j.k})},ti.prototype.clear=function(){return this._length=0,this._items={},this._nums={},this};var Oe=[rr.FEATURE,rr.MIDPOINT,rr.VERTEX],fr={click:function(I,L,j){return nh(I,L,j,j.options.clickBuffer)},touch:function(I,L,j){return nh(I,L,j,j.options.touchBuffer)}};function nh(I,L,j,tt){if(null===j.map)return[];var lt=I?va(I,tt):L,ut={};j.options.styles&&(ut.layers=j.options.styles.map(function(ce){return ce.id}).filter(function(ce){return null!=j.map.getLayer(ce)}));var gt=j.map.queryRenderedFeatures(lt,ut).filter(function(ce){return-1!==Oe.indexOf(ce.properties.meta)}),Et=new ti,Xt=[];return gt.forEach(function(ce){var de=ce.properties.id;Et.has(de)||(Et.add(de),Xt.push(ce))}),tn(Xt)}function ls(I,L){var j=fr.click(I,null,L),tt={mouse:Hn.NONE};return j[0]&&(tt.mouse=j[0].properties.active===dr.ACTIVE?Hn.MOVE:Hn.POINTER,tt.feature=j[0].properties.meta),-1!==L.events.currentModeName().indexOf("draw")&&(tt.mouse=Hn.ADD),L.ui.queueMapClasses(tt),L.ui.updateMapClasses(),j[0]}function ol(I,L){var j=I.x-L.x,tt=I.y-L.y;return Math.sqrt(j*j+tt*tt)}function xa(I,L,j){void 0===j&&(j={});var tt=null!=j.fineTolerance?j.fineTolerance:4,lt=null!=j.grossTolerance?j.grossTolerance:12,ut=null!=j.interval?j.interval:500;I.point=I.point||L.point,I.time=I.time||L.time;var gt=ol(I.point,L.point);return gt<tt||gt<lt&&L.time-I.time<ut}function Ds(I,L,j){void 0===j&&(j={});var tt=null!=j.tolerance?j.tolerance:25,lt=null!=j.interval?j.interval:250;return I.point=I.point||L.point,I.time=I.time||L.time,ol(I.point,L.point)<tt&&L.time-I.time<lt}var Tr={exports:{}},ne=Tr.exports=function(I,L){if(L||(L=16),void 0===I&&(I=128),I<=0)return"0";for(var j=Math.log(Math.pow(2,I))/Math.log(L),tt=2;j===1/0;tt*=2)j=Math.log(Math.pow(2,I/tt))/Math.log(L)*tt;var lt=j-Math.floor(j),ut="";for(tt=0;tt<Math.floor(j);tt++)ut=Math.floor(Math.random()*L).toString(L)+ut;if(lt){var gt=Math.pow(L,lt);ut=Math.floor(Math.random()*gt).toString(L)+ut}var Et=parseInt(ut,L);return Et!==1/0&&Et>=Math.pow(2,I)?ne(I,L):ut};ne.rack=function(I,L,j){var tt=function(ut){var gt=0;do{if(gt++>10){if(!j)throw new Error("too many ID collisions, use more bits");I+=j}var Et=ne(I,L)}while(Object.hasOwnProperty.call(lt,Et));return lt[Et]=ut,Et},lt=tt.hats={};return tt.get=function(ut){return tt.hats[ut]},tt.set=function(ut,gt){return tt.hats[ut]=gt,tt},tt.bits=I||128,tt.base=L||16,tt};var Ro=Qi(Tr.exports),Rr=function(I,L){this.ctx=I,this.properties=L.properties||{},this.coordinates=L.geometry.coordinates,this.id=L.id||Ro(),this.type=L.geometry.type};Rr.prototype.changed=function(){this.ctx.store.featureChanged(this.id)},Rr.prototype.incomingCoords=function(I){this.setCoordinates(I)},Rr.prototype.setCoordinates=function(I){this.coordinates=I,this.changed()},Rr.prototype.getCoordinates=function(){return JSON.parse(JSON.stringify(this.coordinates))},Rr.prototype.setProperty=function(I,L){this.properties[I]=L},Rr.prototype.toGeoJSON=function(){return JSON.parse(JSON.stringify({id:this.id,type:Pe.FEATURE,properties:this.properties,geometry:{coordinates:this.getCoordinates(),type:this.type}}))},Rr.prototype.internal=function(I){var L={id:this.id,meta:rr.FEATURE,"meta:type":this.type,active:dr.INACTIVE,mode:I};if(this.ctx.options.userProperties)for(var j in this.properties)L["user_"+j]=this.properties[j];return{type:Pe.FEATURE,properties:L,geometry:{coordinates:this.getCoordinates(),type:this.type}}};var mo=function(I,L){Rr.call(this,I,L)};(mo.prototype=Object.create(Rr.prototype)).isValid=function(){return"number"==typeof this.coordinates[0]&&"number"==typeof this.coordinates[1]},mo.prototype.updateCoordinate=function(I,L,j){this.coordinates=3===arguments.length?[L,j]:[I,L],this.changed()},mo.prototype.getCoordinate=function(){return this.getCoordinates()};var _i=function(I,L){Rr.call(this,I,L)};(_i.prototype=Object.create(Rr.prototype)).isValid=function(){return this.coordinates.length>1},_i.prototype.addCoordinate=function(I,L,j){this.changed();var tt=parseInt(I,10);this.coordinates.splice(tt,0,[L,j])},_i.prototype.getCoordinate=function(I){var L=parseInt(I,10);return JSON.parse(JSON.stringify(this.coordinates[L]))},_i.prototype.removeCoordinate=function(I){this.changed(),this.coordinates.splice(parseInt(I,10),1)},_i.prototype.updateCoordinate=function(I,L,j){var tt=parseInt(I,10);this.coordinates[tt]=[L,j],this.changed()};var Wt=function(I,L){Rr.call(this,I,L),this.coordinates=this.coordinates.map(function(j){return j.slice(0,-1)})};(Wt.prototype=Object.create(Rr.prototype)).isValid=function(){return 0!==this.coordinates.length&&this.coordinates.every(function(I){return I.length>2})},Wt.prototype.incomingCoords=function(I){this.coordinates=I.map(function(L){return L.slice(0,-1)}),this.changed()},Wt.prototype.setCoordinates=function(I){this.coordinates=I,this.changed()},Wt.prototype.addCoordinate=function(I,L,j){this.changed();var tt=I.split(".").map(function(lt){return parseInt(lt,10)});this.coordinates[tt[0]].splice(tt[1],0,[L,j])},Wt.prototype.removeCoordinate=function(I){this.changed();var L=I.split(".").map(function(tt){return parseInt(tt,10)}),j=this.coordinates[L[0]];j&&(j.splice(L[1],1),j.length<3&&this.coordinates.splice(L[0],1))},Wt.prototype.getCoordinate=function(I){var L=I.split(".").map(function(tt){return parseInt(tt,10)});return JSON.parse(JSON.stringify(this.coordinates[L[0]][L[1]]))},Wt.prototype.getCoordinates=function(){return this.coordinates.map(function(I){return I.concat([I[0]])})},Wt.prototype.updateCoordinate=function(I,L,j){this.changed();var tt=I.split("."),lt=parseInt(tt[0],10),ut=parseInt(tt[1],10);void 0===this.coordinates[lt]&&(this.coordinates[lt]=[]),this.coordinates[lt][ut]=[L,j]};var to={MultiPoint:mo,MultiLineString:_i,MultiPolygon:Wt},Lo=function(I,L,j,tt,lt){var ut=j.split("."),gt=parseInt(ut[0],10),Et=ut[1]?ut.slice(1).join("."):null;return I[gt][L](Et,tt,lt)},Dr=function(I,L){if(Rr.call(this,I,L),delete this.coordinates,this.model=to[L.geometry.type],void 0===this.model)throw new TypeError(L.geometry.type+" is not a valid type");this.features=this._coordinatesToFeatures(L.geometry.coordinates)};function _n(I){this.map=I.map,this.drawConfig=JSON.parse(JSON.stringify(I.options||{})),this._ctx=I}(Dr.prototype=Object.create(Rr.prototype))._coordinatesToFeatures=function(I){var L=this,j=this.model.bind(this);return I.map(function(tt){return new j(L.ctx,{id:Ro(),type:Pe.FEATURE,properties:{},geometry:{coordinates:tt,type:L.type.replace("Multi","")}})})},Dr.prototype.isValid=function(){return this.features.every(function(I){return I.isValid()})},Dr.prototype.setCoordinates=function(I){this.features=this._coordinatesToFeatures(I),this.changed()},Dr.prototype.getCoordinate=function(I){return Lo(this.features,"getCoordinate",I)},Dr.prototype.getCoordinates=function(){return JSON.parse(JSON.stringify(this.features.map(function(I){return I.type===Pe.POLYGON?I.getCoordinates():I.coordinates})))},Dr.prototype.updateCoordinate=function(I,L,j){Lo(this.features,"updateCoordinate",I,L,j),this.changed()},Dr.prototype.addCoordinate=function(I,L,j){Lo(this.features,"addCoordinate",I,L,j),this.changed()},Dr.prototype.removeCoordinate=function(I){Lo(this.features,"removeCoordinate",I),this.changed()},Dr.prototype.getFeatures=function(){return this.features},_n.prototype.setSelected=function(I){return this._ctx.store.setSelected(I)},_n.prototype.setSelectedCoordinates=function(I){var L=this;this._ctx.store.setSelectedCoordinates(I),I.reduce(function(j,tt){return void 0===j[tt.feature_id]&&(j[tt.feature_id]=!0,L._ctx.store.get(tt.feature_id).changed()),j},{})},_n.prototype.getSelected=function(){return this._ctx.store.getSelected()},_n.prototype.getSelectedIds=function(){return this._ctx.store.getSelectedIds()},_n.prototype.isSelected=function(I){return this._ctx.store.isSelected(I)},_n.prototype.getFeature=function(I){return this._ctx.store.get(I)},_n.prototype.select=function(I){return this._ctx.store.select(I)},_n.prototype.deselect=function(I){return this._ctx.store.deselect(I)},_n.prototype.deleteFeature=function(I,L){return void 0===L&&(L={}),this._ctx.store.delete(I,L)},_n.prototype.addFeature=function(I){return this._ctx.store.add(I)},_n.prototype.clearSelectedFeatures=function(){return this._ctx.store.clearSelected()},_n.prototype.clearSelectedCoordinates=function(){return this._ctx.store.clearSelectedCoordinates()},_n.prototype.setActionableState=function(I){return void 0===I&&(I={}),this._ctx.events.actionable({trash:I.trash||!1,combineFeatures:I.combineFeatures||!1,uncombineFeatures:I.uncombineFeatures||!1})},_n.prototype.changeMode=function(I,L,j){return void 0===L&&(L={}),void 0===j&&(j={}),this._ctx.events.changeMode(I,L,j)},_n.prototype.updateUIClasses=function(I){return this._ctx.ui.queueMapClasses(I)},_n.prototype.activateUIButton=function(I){return this._ctx.ui.setActiveButton(I)},_n.prototype.featuresAt=function(I,L,j){if(void 0===j&&(j="click"),"click"!==j&&"touch"!==j)throw new Error("invalid buffer type");return fr[j](I,L,this._ctx)},_n.prototype.newFeature=function(I){var L=I.geometry.type;return L===Pe.POINT?new mo(this._ctx,I):L===Pe.LINE_STRING?new _i(this._ctx,I):L===Pe.POLYGON?new Wt(this._ctx,I):new Dr(this._ctx,I)},_n.prototype.isInstanceOf=function(I,L){if(I===Pe.POINT)return L instanceof mo;if(I===Pe.LINE_STRING)return L instanceof _i;if(I===Pe.POLYGON)return L instanceof Wt;if("MultiFeature"===I)return L instanceof Dr;throw new Error("Unknown feature class: "+I)},_n.prototype.doRender=function(I){return this._ctx.store.featureChanged(I)},_n.prototype.onSetup=function(){},_n.prototype.onDrag=function(){},_n.prototype.onClick=function(){},_n.prototype.onMouseMove=function(){},_n.prototype.onMouseDown=function(){},_n.prototype.onMouseUp=function(){},_n.prototype.onMouseOut=function(){},_n.prototype.onKeyUp=function(){},_n.prototype.onKeyDown=function(){},_n.prototype.onTouchStart=function(){},_n.prototype.onTouchMove=function(){},_n.prototype.onTouchEnd=function(){},_n.prototype.onTap=function(){},_n.prototype.onStop=function(){},_n.prototype.onTrash=function(){},_n.prototype.onCombineFeature=function(){},_n.prototype.onUncombineFeature=function(){},_n.prototype.toDisplayFeatures=function(){throw new Error("You must overwrite toDisplayFeatures")};var Fc={drag:"onDrag",click:"onClick",mousemove:"onMouseMove",mousedown:"onMouseDown",mouseup:"onMouseUp",mouseout:"onMouseOut",keyup:"onKeyUp",keydown:"onKeyDown",touchstart:"onTouchStart",touchmove:"onTouchMove",touchend:"onTouchEnd",tap:"onTap"},Zl=Object.keys(Fc);function Oo(I){return[].concat(I).filter(function(L){return void 0!==L})}function Wl(){var I=this;if(!I.ctx.map||void 0===I.ctx.map.getSource(Pr.HOT))return Xt();var L=I.ctx.events.currentModeName();I.ctx.ui.queueMapClasses({mode:L});var j=[],tt=[];I.isDirty?tt=I.getAllIds():(j=I.getChangedIds().filter(function(ce){return void 0!==I.get(ce)}),tt=I.sources.hot.filter(function(ce){return ce.properties.id&&-1===j.indexOf(ce.properties.id)&&void 0!==I.get(ce.properties.id)}).map(function(ce){return ce.properties.id})),I.sources.hot=[];var lt=I.sources.cold.length;I.sources.cold=I.isDirty?[]:I.sources.cold.filter(function(ce){return-1===j.indexOf(ce.properties.id||ce.properties.parent)});var ut=lt!==I.sources.cold.length||tt.length>0;function gt(ce,de){var oe=I.get(ce).internal(L);I.ctx.events.currentModeRender(oe,function(Bt){I.sources[de].push(Bt)})}if(j.forEach(function(ce){return gt(ce,"hot")}),tt.forEach(function(ce){return gt(ce,"cold")}),ut&&I.ctx.map.getSource(Pr.COLD).setData({type:Pe.FEATURE_COLLECTION,features:I.sources.cold}),I.ctx.map.getSource(Pr.HOT).setData({type:Pe.FEATURE_COLLECTION,features:I.sources.hot}),I._emitSelectionChange&&(I.ctx.map.fire(Bi.SELECTION_CHANGE,{features:I.getSelected().map(function(ce){return ce.toGeoJSON()}),points:I.getSelectedCoordinates().map(function(ce){return{type:Pe.FEATURE,properties:{},geometry:{type:Pe.POINT,coordinates:ce.coordinates}}})}),I._emitSelectionChange=!1),I._deletedFeaturesToEmit.length){var Et=I._deletedFeaturesToEmit.map(function(ce){return ce.toGeoJSON()});I._deletedFeaturesToEmit=[],I.ctx.map.fire(Bi.DELETE,{features:Et})}function Xt(){I.isDirty=!1,I.clearChangedIds()}Xt(),I.ctx.map.fire(Bi.RENDER,{})}function St(I){var L,j=this;this._features={},this._featureIds=new ti,this._selectedFeatureIds=new ti,this._selectedCoordinates=[],this._changedFeatureIds=new ti,this._deletedFeaturesToEmit=[],this._emitSelectionChange=!1,this._mapInitialConfig={},this.ctx=I,this.sources={hot:[],cold:[]},this.render=function(){L||(L=requestAnimationFrame(function(){L=null,Wl.call(j)}))},this.isDirty=!1}function q(I,L){var j=I._selectedCoordinates.filter(function(tt){return I._selectedFeatureIds.has(tt.feature_id)});I._selectedCoordinates.length===j.length||L.silent||(I._emitSelectionChange=!0),I._selectedCoordinates=j}St.prototype.createRenderBatch=function(){var I=this,L=this.render,j=0;return this.render=function(){j++},function(){I.render=L,j>0&&I.render()}},St.prototype.setDirty=function(){return this.isDirty=!0,this},St.prototype.featureChanged=function(I){return this._changedFeatureIds.add(I),this},St.prototype.getChangedIds=function(){return this._changedFeatureIds.values()},St.prototype.clearChangedIds=function(){return this._changedFeatureIds.clear(),this},St.prototype.getAllIds=function(){return this._featureIds.values()},St.prototype.add=function(I){return this.featureChanged(I.id),this._features[I.id]=I,this._featureIds.add(I.id),this},St.prototype.delete=function(I,L){var j=this;return void 0===L&&(L={}),Oo(I).forEach(function(tt){j._featureIds.has(tt)&&(j._featureIds.delete(tt),j._selectedFeatureIds.delete(tt),L.silent||-1===j._deletedFeaturesToEmit.indexOf(j._features[tt])&&j._deletedFeaturesToEmit.push(j._features[tt]),delete j._features[tt],j.isDirty=!0)}),q(this,L),this},St.prototype.get=function(I){return this._features[I]},St.prototype.getAll=function(){var I=this;return Object.keys(this._features).map(function(L){return I._features[L]})},St.prototype.select=function(I,L){var j=this;return void 0===L&&(L={}),Oo(I).forEach(function(tt){j._selectedFeatureIds.has(tt)||(j._selectedFeatureIds.add(tt),j._changedFeatureIds.add(tt),L.silent||(j._emitSelectionChange=!0))}),this},St.prototype.deselect=function(I,L){var j=this;return void 0===L&&(L={}),Oo(I).forEach(function(tt){j._selectedFeatureIds.has(tt)&&(j._selectedFeatureIds.delete(tt),j._changedFeatureIds.add(tt),L.silent||(j._emitSelectionChange=!0))}),q(this,L),this},St.prototype.clearSelected=function(I){return void 0===I&&(I={}),this.deselect(this._selectedFeatureIds.values(),{silent:I.silent}),this},St.prototype.setSelected=function(I,L){var j=this;return void 0===L&&(L={}),I=Oo(I),this.deselect(this._selectedFeatureIds.values().filter(function(tt){return-1===I.indexOf(tt)}),{silent:L.silent}),this.select(I.filter(function(tt){return!j._selectedFeatureIds.has(tt)}),{silent:L.silent}),this},St.prototype.setSelectedCoordinates=function(I){return this._selectedCoordinates=I,this._emitSelectionChange=!0,this},St.prototype.clearSelectedCoordinates=function(){return this._selectedCoordinates=[],this._emitSelectionChange=!0,this},St.prototype.getSelectedIds=function(){return this._selectedFeatureIds.values()},St.prototype.getSelected=function(){var I=this;return this._selectedFeatureIds.values().map(function(L){return I.get(L)})},St.prototype.getSelectedCoordinates=function(){var I=this;return this._selectedCoordinates.map(function(L){return{coordinates:I.get(L.feature_id).getCoordinate(L.coord_path)}})},St.prototype.isSelected=function(I){return this._selectedFeatureIds.has(I)},St.prototype.setFeatureProperty=function(I,L,j){this.get(I).setProperty(L,j),this.featureChanged(I)},St.prototype.storeMapConfig=function(){var I=this;ss.forEach(function(L){I.ctx.map[L]&&(I._mapInitialConfig[L]=I.ctx.map[L].isEnabled())})},St.prototype.restoreMapConfig=function(){var I=this;Object.keys(this._mapInitialConfig).forEach(function(L){I._mapInitialConfig[L]?I.ctx.map[L].enable():I.ctx.map[L].disable()})},St.prototype.getInitialConfigValue=function(I){return void 0===this._mapInitialConfig[I]||this._mapInitialConfig[I]};var nt=Object.prototype.hasOwnProperty,At=Qi(function(){for(var I=arguments,L={},j=0;j<arguments.length;j++){var tt=I[j];for(var lt in tt)nt.call(tt,lt)&&(L[lt]=tt[lt])}return L}),Lt=["mode","feature","mouse"];function Jt(I){var L=null,j=null,tt={onRemove:function(){return I.map.off("load",tt.connect),clearInterval(j),tt.removeLayers(),I.store.restoreMapConfig(),I.ui.removeButtons(),I.events.removeEventListeners(),I.ui.clearMapClasses(),I.boxZoomInitial&&I.map.boxZoom.enable(),I.map=null,I.container=null,I.store=null,L&&L.parentNode&&L.parentNode.removeChild(L),L=null,this},connect:function(){I.map.off("load",tt.connect),clearInterval(j),tt.addLayers(),I.store.storeMapConfig(),I.events.addEventListeners()},onAdd:function(lt){var ut=lt.fire;return lt.fire=function(gt,Et){var Xt=arguments;return 1===ut.length&&1!==arguments.length&&(Xt=[At({},{type:gt},Et)]),ut.apply(lt,Xt)},I.map=lt,I.events=function(gt){var Et=Object.keys(gt.options.modes).reduce(function(H,wt){return H[wt]=function ei(I){var L=Object.keys(I);return function(j,tt){void 0===tt&&(tt={});var lt={},ut=L.reduce(function(gt,Et){return gt[Et]=I[Et],gt},new _n(j));return{start:function(){var gt=this;lt=ut.onSetup(tt),Zl.forEach(function(Et){var Xt,ce=Fc[Et],de=function(){return!1};I[ce]&&(de=function(){return!0}),gt.on(Et,de,(Xt=ce,function(oe){return ut[Xt](lt,oe)}))})},stop:function(){ut.onStop(lt)},trash:function(){ut.onTrash(lt)},combineFeatures:function(){ut.onCombineFeatures(lt)},uncombineFeatures:function(){ut.onUncombineFeatures(lt)},render:function(gt,Et){ut.toDisplayFeatures(lt,gt,Et)}}}}(gt.options.modes[wt]),H},{}),Xt={},ce={},de={},oe=null,Bt=null;de.drag=function(H,wt){wt({point:H.point,time:(new Date).getTime()})?(gt.ui.queueMapClasses({mouse:Hn.DRAG}),Bt.drag(H)):H.originalEvent.stopPropagation()},de.mousedrag=function(H){de.drag(H,function(wt){return!xa(Xt,wt)})},de.touchdrag=function(H){de.drag(H,function(wt){return!Ds(ce,wt)})},de.mousemove=function(H){if(1===(void 0!==H.originalEvent.buttons?H.originalEvent.buttons:H.originalEvent.which))return de.mousedrag(H);var wt=ls(H,gt);H.featureTarget=wt,Bt.mousemove(H)},de.mousedown=function(H){Xt={time:(new Date).getTime(),point:H.point};var wt=ls(H,gt);H.featureTarget=wt,Bt.mousedown(H)},de.mouseup=function(H){var wt=ls(H,gt);H.featureTarget=wt,xa(Xt,{point:H.point,time:(new Date).getTime()})?Bt.click(H):Bt.mouseup(H)},de.mouseout=function(H){Bt.mouseout(H)},de.touchstart=function(H){if(gt.options.touchEnabled){ce={time:(new Date).getTime(),point:H.point};var wt=fr.touch(H,null,gt)[0];H.featureTarget=wt,Bt.touchstart(H)}},de.touchmove=function(H){if(gt.options.touchEnabled)return Bt.touchmove(H),de.touchdrag(H)},de.touchend=function(H){if(H.originalEvent.preventDefault(),gt.options.touchEnabled){var wt=fr.touch(H,null,gt)[0];H.featureTarget=wt,Ds(ce,{time:(new Date).getTime(),point:H.point})?Bt.tap(H):Bt.touchend(H)}};var Mt=function(H){return!(8===H||46===H||H>=48&&H<=57)};function Tt(H,wt,Vn){void 0===Vn&&(Vn={}),Bt.stop();var lr=Et[H];if(void 0===lr)throw new Error(H+" is not valid");oe=H;var je=lr(gt,wt);Bt=qs(je,gt),Vn.silent||gt.map.fire(Bi.MODE_CHANGE,{mode:H}),gt.store.setDirty(),gt.store.render()}de.keydown=function(H){(H.srcElement||H.target).classList.contains("mapboxgl-canvas")&&(8!==H.keyCode&&46!==H.keyCode||!gt.options.controls.trash?Mt(H.keyCode)?Bt.keydown(H):49===H.keyCode&&gt.options.controls.point?Tt(pn.DRAW_POINT):50===H.keyCode&&gt.options.controls.line_string?Tt(pn.DRAW_LINE_STRING):51===H.keyCode&&gt.options.controls.polygon&&Tt(pn.DRAW_POLYGON):(H.preventDefault(),Bt.trash()))},de.keyup=function(H){Mt(H.keyCode)&&Bt.keyup(H)},de.zoomend=function(){gt.store.changeZoom()},de.data=function(H){if("style"===H.dataType){var wt=gt.setup,Vn=gt.map,je=gt.store;gt.options.styles.some(function(Cs){return Vn.getLayer(Cs.id)})||(wt.addLayers(),je.setDirty(),je.render())}};var ye={trash:!1,combineFeatures:!1,uncombineFeatures:!1};return{start:function(){Bt=qs(Et[oe=gt.options.defaultMode](gt),gt)},changeMode:Tt,actionable:function(H){var wt=!1;Object.keys(H).forEach(function(Vn){if(void 0===ye[Vn])throw new Error("Invalid action type");ye[Vn]!==H[Vn]&&(wt=!0),ye[Vn]=H[Vn]}),wt&&gt.map.fire(Bi.ACTIONABLE,{actions:ye})},currentModeName:function(){return oe},currentModeRender:function(H,wt){return Bt.render(H,wt)},fire:function(H,wt){de[H]&&de[H](wt)},addEventListeners:function(){gt.map.on("mousemove",de.mousemove),gt.map.on("mousedown",de.mousedown),gt.map.on("mouseup",de.mouseup),gt.map.on("data",de.data),gt.map.on("touchmove",de.touchmove),gt.map.on("touchstart",de.touchstart),gt.map.on("touchend",de.touchend),gt.container.addEventListener("mouseout",de.mouseout),gt.options.keybindings&&(gt.container.addEventListener("keydown",de.keydown),gt.container.addEventListener("keyup",de.keyup))},removeEventListeners:function(){gt.map.off("mousemove",de.mousemove),gt.map.off("mousedown",de.mousedown),gt.map.off("mouseup",de.mouseup),gt.map.off("data",de.data),gt.map.off("touchmove",de.touchmove),gt.map.off("touchstart",de.touchstart),gt.map.off("touchend",de.touchend),gt.container.removeEventListener("mouseout",de.mouseout),gt.options.keybindings&&(gt.container.removeEventListener("keydown",de.keydown),gt.container.removeEventListener("keyup",de.keyup))},trash:function(H){Bt.trash(H)},combineFeatures:function(){Bt.combineFeatures()},uncombineFeatures:function(){Bt.uncombineFeatures()},getMode:function(){return oe}}}(I),I.ui=function(gt){var Et={},Xt=null,ce={mode:null,feature:null,mouse:null},de={mode:null,feature:null,mouse:null};function oe(H){de=At(de,H)}function Bt(){var H,wt;if(gt.container){var Vn=[],lr=[];Lt.forEach(function(je){de[je]!==ce[je]&&(Vn.push(je+"-"+ce[je]),null!==de[je]&&lr.push(je+"-"+de[je]))}),Vn.length>0&&(H=gt.container.classList).remove.apply(H,Vn),lr.length>0&&(wt=gt.container.classList).add.apply(wt,lr),ce=At(ce,de)}}function Mt(H,wt){void 0===wt&&(wt={});var Vn=document.createElement("button");return Vn.className=Te.CONTROL_BUTTON+" "+wt.className,Vn.setAttribute("title",wt.title),wt.container.appendChild(Vn),Vn.addEventListener("click",function(lr){if(lr.preventDefault(),lr.stopPropagation(),lr.target===Xt)return Tt(),void wt.onDeactivate();ye(H),wt.onActivate()},!0),Vn}function Tt(){Xt&&(Xt.classList.remove(Te.ACTIVE_BUTTON),Xt=null)}function ye(H){Tt();var wt=Et[H];wt&&wt&&"trash"!==H&&(wt.classList.add(Te.ACTIVE_BUTTON),Xt=wt)}return{setActiveButton:ye,queueMapClasses:oe,updateMapClasses:Bt,clearMapClasses:function(){oe({mode:null,feature:null,mouse:null}),Bt()},addButtons:function(){var H=gt.options.controls,wt=document.createElement("div");return wt.className=Te.CONTROL_GROUP+" "+Te.CONTROL_BASE,H&&(H[Zr.LINE]&&(Et[Zr.LINE]=Mt(Zr.LINE,{container:wt,className:Te.CONTROL_BUTTON_LINE,title:"LineString tool "+(gt.options.keybindings?"(l)":""),onActivate:function(){return gt.events.changeMode(pn.DRAW_LINE_STRING)},onDeactivate:function(){return gt.events.trash()}})),H[Zr.POLYGON]&&(Et[Zr.POLYGON]=Mt(Zr.POLYGON,{container:wt,className:Te.CONTROL_BUTTON_POLYGON,title:"Polygon tool "+(gt.options.keybindings?"(p)":""),onActivate:function(){return gt.events.changeMode(pn.DRAW_POLYGON)},onDeactivate:function(){return gt.events.trash()}})),H[Zr.POINT]&&(Et[Zr.POINT]=Mt(Zr.POINT,{container:wt,className:Te.CONTROL_BUTTON_POINT,title:"Marker tool "+(gt.options.keybindings?"(m)":""),onActivate:function(){return gt.events.changeMode(pn.DRAW_POINT)},onDeactivate:function(){return gt.events.trash()}})),H.trash&&(Et.trash=Mt("trash",{container:wt,className:Te.CONTROL_BUTTON_TRASH,title:"Delete",onActivate:function(){gt.events.trash()}})),H.combine_features&&(Et.combine_features=Mt("combineFeatures",{container:wt,className:Te.CONTROL_BUTTON_COMBINE_FEATURES,title:"Combine",onActivate:function(){gt.events.combineFeatures()}})),H.uncombine_features&&(Et.uncombine_features=Mt("uncombineFeatures",{container:wt,className:Te.CONTROL_BUTTON_UNCOMBINE_FEATURES,title:"Uncombine",onActivate:function(){gt.events.uncombineFeatures()}}))),wt},removeButtons:function(){Object.keys(Et).forEach(function(H){var wt=Et[H];wt.parentNode&&wt.parentNode.removeChild(wt),delete Et[H]})}}}(I),I.container=lt.getContainer(),I.store=new St(I),L=I.ui.addButtons(),I.options.boxSelect&&(I.boxZoomInitial=lt.boxZoom.isEnabled(),lt.boxZoom.disable(),lt.dragPan.disable(),lt.dragPan.enable()),lt.loaded()?tt.connect():(lt.on("load",tt.connect),j=setInterval(function(){lt.loaded()&&tt.connect()},16)),I.events.start(),L},addLayers:function(){I.map.addSource(Pr.COLD,{data:{type:Pe.FEATURE_COLLECTION,features:[]},type:"geojson"}),I.map.addSource(Pr.HOT,{data:{type:Pe.FEATURE_COLLECTION,features:[]},type:"geojson"}),I.options.styles.forEach(function(lt){I.map.addLayer(lt)}),I.store.setDirty(!0),I.store.render()},removeLayers:function(){I.options.styles.forEach(function(lt){I.map.getLayer(lt.id)&&I.map.removeLayer(lt.id)}),I.map.getSource(Pr.COLD)&&I.map.removeSource(Pr.COLD),I.map.getSource(Pr.HOT)&&I.map.removeSource(Pr.HOT)}};return I.setup=tt,tt}var ae=[{id:"gl-draw-polygon-fill-inactive",type:"fill",filter:["all",["==","active","false"],["==","$type","Polygon"],["!=","mode","static"]],paint:{"fill-color":"#3bb2d0","fill-outline-color":"#3bb2d0","fill-opacity":.1}},{id:"gl-draw-polygon-fill-active",type:"fill",filter:["all",["==","active","true"],["==","$type","Polygon"]],paint:{"fill-color":"#fbb03b","fill-outline-color":"#fbb03b","fill-opacity":.1}},{id:"gl-draw-polygon-midpoint",type:"circle",filter:["all",["==","$type","Point"],["==","meta","midpoint"]],paint:{"circle-radius":3,"circle-color":"#fbb03b"}},{id:"gl-draw-polygon-stroke-inactive",type:"line",filter:["all",["==","active","false"],["==","$type","Polygon"],["!=","mode","static"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#3bb2d0","line-width":2}},{id:"gl-draw-polygon-stroke-active",type:"line",filter:["all",["==","active","true"],["==","$type","Polygon"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#fbb03b","line-dasharray":[.2,2],"line-width":2}},{id:"gl-draw-line-inactive",type:"line",filter:["all",["==","active","false"],["==","$type","LineString"],["!=","mode","static"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#3bb2d0","line-width":2}},{id:"gl-draw-line-active",type:"line",filter:["all",["==","$type","LineString"],["==","active","true"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#fbb03b","line-dasharray":[.2,2],"line-width":2}},{id:"gl-draw-polygon-and-line-vertex-stroke-inactive",type:"circle",filter:["all",["==","meta","vertex"],["==","$type","Point"],["!=","mode","static"]],paint:{"circle-radius":5,"circle-color":"#fff"}},{id:"gl-draw-polygon-and-line-vertex-inactive",type:"circle",filter:["all",["==","meta","vertex"],["==","$type","Point"],["!=","mode","static"]],paint:{"circle-radius":3,"circle-color":"#fbb03b"}},{id:"gl-draw-point-point-stroke-inactive",type:"circle",filter:["all",["==","active","false"],["==","$type","Point"],["==","meta","feature"],["!=","mode","static"]],paint:{"circle-radius":5,"circle-opacity":1,"circle-color":"#fff"}},{id:"gl-draw-point-inactive",type:"circle",filter:["all",["==","active","false"],["==","$type","Point"],["==","meta","feature"],["!=","mode","static"]],paint:{"circle-radius":3,"circle-color":"#3bb2d0"}},{id:"gl-draw-point-stroke-active",type:"circle",filter:["all",["==","$type","Point"],["==","active","true"],["!=","meta","midpoint"]],paint:{"circle-radius":7,"circle-color":"#fff"}},{id:"gl-draw-point-active",type:"circle",filter:["all",["==","$type","Point"],["!=","meta","midpoint"],["==","active","true"]],paint:{"circle-radius":5,"circle-color":"#fbb03b"}},{id:"gl-draw-polygon-fill-static",type:"fill",filter:["all",["==","mode","static"],["==","$type","Polygon"]],paint:{"fill-color":"#404040","fill-outline-color":"#404040","fill-opacity":.1}},{id:"gl-draw-polygon-stroke-static",type:"line",filter:["all",["==","mode","static"],["==","$type","Polygon"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#404040","line-width":2}},{id:"gl-draw-line-static",type:"line",filter:["all",["==","mode","static"],["==","$type","LineString"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#404040","line-width":2}},{id:"gl-draw-point-static",type:"circle",filter:["all",["==","mode","static"],["==","$type","Point"]],paint:{"circle-radius":5,"circle-color":"#404040"}}];function Pt(I){return function(L){var j=L.featureTarget;return!!j&&!!j.properties&&j.properties.meta===I}}function pe(I){return!!I.originalEvent&&!!I.originalEvent.shiftKey&&0===I.originalEvent.button}function _e(I){return!!I.featureTarget&&!!I.featureTarget.properties&&I.featureTarget.properties.active===dr.ACTIVE&&I.featureTarget.properties.meta===rr.FEATURE}function Ee(I){return!!I.featureTarget&&!!I.featureTarget.properties&&I.featureTarget.properties.active===dr.INACTIVE&&I.featureTarget.properties.meta===rr.FEATURE}function Cn(I){return void 0===I.featureTarget}function nr(I){return!!I.featureTarget&&!!I.featureTarget.properties&&I.featureTarget.properties.meta===rr.FEATURE}function Lr(I){var L=I.featureTarget;return!!L&&!!L.properties&&L.properties.meta===rr.VERTEX}function Jn(I){return!!I.originalEvent&&!0===I.originalEvent.shiftKey}function Fn(I){return 27===I.keyCode}function Nn(I){return 13===I.keyCode}var Ii=Object.freeze({__proto__:null,isOfMetaType:Pt,isShiftMousedown:pe,isActiveFeature:_e,isInactiveFeature:Ee,noTarget:Cn,isFeature:nr,isVertex:Lr,isShiftDown:Jn,isEscapeKey:Fn,isEnterKey:Nn,isTrue:function(){return!0}}),ji=oi;function oi(I,L){this.x=I,this.y=L}oi.prototype={clone:function(){return new oi(this.x,this.y)},add:function(I){return this.clone()._add(I)},sub:function(I){return this.clone()._sub(I)},multByPoint:function(I){return this.clone()._multByPoint(I)},divByPoint:function(I){return this.clone()._divByPoint(I)},mult:function(I){return this.clone()._mult(I)},div:function(I){return this.clone()._div(I)},rotate:function(I){return this.clone()._rotate(I)},rotateAround:function(I,L){return this.clone()._rotateAround(I,L)},matMult:function(I){return this.clone()._matMult(I)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(I){return this.x===I.x&&this.y===I.y},dist:function(I){return Math.sqrt(this.distSqr(I))},distSqr:function(I){var L=I.x-this.x,j=I.y-this.y;return L*L+j*j},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(I){return Math.atan2(this.y-I.y,this.x-I.x)},angleWith:function(I){return this.angleWithSep(I.x,I.y)},angleWithSep:function(I,L){return Math.atan2(this.x*L-this.y*I,this.x*I+this.y*L)},_matMult:function(I){var j=I[2]*this.x+I[3]*this.y;return this.x=I[0]*this.x+I[1]*this.y,this.y=j,this},_add:function(I){return this.x+=I.x,this.y+=I.y,this},_sub:function(I){return this.x-=I.x,this.y-=I.y,this},_mult:function(I){return this.x*=I,this.y*=I,this},_div:function(I){return this.x/=I,this.y/=I,this},_multByPoint:function(I){return this.x*=I.x,this.y*=I.y,this},_divByPoint:function(I){return this.x/=I.x,this.y/=I.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var I=this.y;return this.y=this.x,this.x=-I,this},_rotate:function(I){var L=Math.cos(I),j=Math.sin(I),lt=j*this.x+L*this.y;return this.x=L*this.x-j*this.y,this.y=lt,this},_rotateAround:function(I,L){var j=Math.cos(I),tt=Math.sin(I),ut=L.y+tt*(this.x-L.x)+j*(this.y-L.y);return this.x=L.x+j*(this.x-L.x)-tt*(this.y-L.y),this.y=ut,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},oi.convert=function(I){return I instanceof oi?I:Array.isArray(I)?new oi(I[0],I[1]):I};var cs=Qi(ji);function ba(I,L){var j=L.getBoundingClientRect();return new cs(I.clientX-j.left-(L.clientLeft||0),I.clientY-j.top-(L.clientTop||0))}function di(I,L,j,tt){return{type:Pe.FEATURE,properties:{meta:rr.VERTEX,parent:I,coord_path:j,active:tt?dr.ACTIVE:dr.INACTIVE},geometry:{type:Pe.POINT,coordinates:L}}}function Ss(I,L,j){var tt=L.geometry.coordinates,lt=j.geometry.coordinates;if(tt[1]>85||tt[1]<ql||lt[1]>85||lt[1]<ql)return null;var ut={lng:(tt[0]+lt[0])/2,lat:(tt[1]+lt[1])/2};return{type:Pe.FEATURE,properties:{meta:rr.MIDPOINT,parent:I,lng:ut.lng,lat:ut.lat,coord_path:j.properties.coord_path},geometry:{type:Pe.POINT,coordinates:[ut.lng,ut.lat]}}}function us(I,L,j){void 0===L&&(L={}),void 0===j&&(j=null);var tt,lt=I.geometry,ut=lt.type,gt=lt.coordinates,Et=I.properties&&I.properties.id,Xt=[];function ce(oe,Bt){var Mt="",Tt=null;oe.forEach(function(ye,H){var wt=null!=Bt?Bt+"."+H:String(H),Vn=di(Et,ye,wt,de(wt));if(L.midpoints&&Tt){var lr=Ss(Et,Tt,Vn);lr&&Xt.push(lr)}Tt=Vn;var je=JSON.stringify(ye);Mt!==je&&Xt.push(Vn),0===H&&(Mt=je)})}function de(oe){return!!L.selectedPaths&&-1!==L.selectedPaths.indexOf(oe)}return ut===Pe.POINT?Xt.push(di(Et,gt,j,de(j))):ut===Pe.POLYGON?gt.forEach(function(oe,Bt){ce(oe,null!==j?j+"."+Bt:String(Bt))}):ut===Pe.LINE_STRING?ce(gt,j):0===ut.indexOf(Pe.MULTI_PREFIX)&&(tt=ut.replace(Pe.MULTI_PREFIX,""),gt.forEach(function(oe,Bt){Xt=Xt.concat(us({type:Pe.FEATURE,properties:I.properties,geometry:{type:tt,coordinates:oe}},L,Bt))})),Xt}var Vi={enable:function(I){setTimeout(function(){I.map&&I.map.doubleClickZoom&&I._ctx&&I._ctx.store&&I._ctx.store.getInitialConfigValue&&I._ctx.store.getInitialConfigValue("doubleClickZoom")&&I.map.doubleClickZoom.enable()},0)},disable:function(I){setTimeout(function(){I.map&&I.map.doubleClickZoom&&I.map.doubleClickZoom.disable()},0)}},yt={exports:{}},It=function(I){if(!I||!I.type)return null;var L=kt[I.type];return L?"geometry"===L?{type:"FeatureCollection",features:[{type:"Feature",properties:{},geometry:I}]}:"feature"===L?{type:"FeatureCollection",features:[I]}:"featurecollection"===L?I:void 0:null},kt={Point:"geometry",MultiPoint:"geometry",LineString:"geometry",MultiLineString:"geometry",Polygon:"geometry",MultiPolygon:"geometry",GeometryCollection:"geometry",Feature:"feature",FeatureCollection:"featurecollection"},jt=Qi(It),zt=Object.freeze({__proto__:null,default:function I(L){switch(L&&L.type||null){case"FeatureCollection":return L.features=L.features.reduce(function(j,tt){return j.concat(I(tt))},[]),L;case"Feature":return L.geometry?I(L.geometry).map(function(j){var tt={type:"Feature",properties:JSON.parse(JSON.stringify(L.properties)),geometry:j};return void 0!==L.id&&(tt.id=L.id),tt}):[L];case"MultiPoint":return L.coordinates.map(function(j){return{type:"Point",coordinates:j}});case"MultiPolygon":return L.coordinates.map(function(j){return{type:"Polygon",coordinates:j}});case"MultiLineString":return L.coordinates.map(function(j){return{type:"LineString",coordinates:j}});case"GeometryCollection":return L.geometries.map(I).reduce(function(j,tt){return j.concat(tt)},[]);case"Point":case"Polygon":case"LineString":return[L]}}}),$t=It,Zt=function Ur(I){if(I.__esModule)return I;var L=I.default;if("function"==typeof L){var j=function tt(){if(this instanceof tt){var lt=[null];return lt.push.apply(lt,arguments),new(Function.bind.apply(L,lt))}return L.apply(this,arguments)};j.prototype=L.prototype}else j={};return Object.defineProperty(j,"__esModule",{value:!0}),Object.keys(I).forEach(function(tt){var lt=Object.getOwnPropertyDescriptor(I,tt);Object.defineProperty(j,tt,lt.get?lt:{enumerable:!0,get:function(){return I[tt]}})}),j}(zt);Zt instanceof Function||(Zt=Zt.default);var ee={exports:{}},Ht=ee.exports=function(I){return new xe(I)};function xe(I){this.value=I}function wn(I,L,j){var tt=[],lt=[],ut=!0;return function gt(Et){var Xt=j?ge(Et):Et,ce={},de=!0,oe={node:Xt,node_:Et,path:[].concat(tt),parent:lt[lt.length-1],parents:lt,key:tt.slice(-1)[0],isRoot:0===tt.length,level:tt.length,circular:null,update:function(Tt,ye){oe.isRoot||(oe.parent.node[oe.key]=Tt),oe.node=Tt,ye&&(de=!1)},delete:function(Tt){delete oe.parent.node[oe.key],Tt&&(de=!1)},remove:function(Tt){pr(oe.parent.node)?oe.parent.node.splice(oe.key,1):delete oe.parent.node[oe.key],Tt&&(de=!1)},keys:null,before:function(Tt){ce.before=Tt},after:function(Tt){ce.after=Tt},pre:function(Tt){ce.pre=Tt},post:function(Tt){ce.post=Tt},stop:function(){ut=!1},block:function(){de=!1}};if(!ut)return oe;function Bt(){if("object"==typeof oe.node&&null!==oe.node){oe.keys&&oe.node_===oe.node||(oe.keys=mn(oe.node)),oe.isLeaf=0==oe.keys.length;for(var Tt=0;Tt<lt.length;Tt++)if(lt[Tt].node_===Et){oe.circular=lt[Tt];break}}else oe.isLeaf=!0,oe.keys=null;oe.notLeaf=!oe.isLeaf,oe.notRoot=!oe.isRoot}Bt();var Mt=L.call(oe,oe.node);return void 0!==Mt&&oe.update&&oe.update(Mt),ce.before&&ce.before.call(oe,oe.node),de&&("object"!=typeof oe.node||null===oe.node||oe.circular||(lt.push(oe),Bt(),Mr(oe.keys,function(Tt,ye){tt.push(Tt),ce.pre&&ce.pre.call(oe,oe.node[Tt],Tt);var H=gt(oe.node[Tt]);j&&si.call(oe.node,Tt)&&(oe.node[Tt]=H.node),H.isLast=ye==oe.keys.length-1,H.isFirst=0==ye,ce.post&&ce.post.call(oe,H),tt.pop()}),lt.pop()),ce.after&&ce.after.call(oe,oe.node)),oe}(I).node}function ge(I){if("object"==typeof I&&null!==I){var L;if(pr(I))L=[];else if("[object Date]"===vn(I))L=new Date(I.getTime?I.getTime():I);else if("[object RegExp]"===vn(I))L=new RegExp(I);else if("[object Error]"===vn(I))L={message:I.message};else if(function(lt){return"[object Boolean]"===vn(lt)}(I))L=new Boolean(I);else if(function(lt){return"[object Number]"===vn(lt)}(I))L=new Number(I);else if(function(lt){return"[object String]"===vn(lt)}(I))L=new String(I);else if(Object.create&&Object.getPrototypeOf)L=Object.create(Object.getPrototypeOf(I));else if(I.constructor===Object)L={};else{var tt=function(){};tt.prototype=I.constructor&&I.constructor.prototype||I.__proto__||{},L=new tt}return Mr(mn(I),function(lt){L[lt]=I[lt]}),L}return I}xe.prototype.get=function(I){for(var L=this.value,j=0;j<I.length;j++){var tt=I[j];if(!L||!si.call(L,tt)){L=void 0;break}L=L[tt]}return L},xe.prototype.has=function(I){for(var L=this.value,j=0;j<I.length;j++){var tt=I[j];if(!L||!si.call(L,tt))return!1;L=L[tt]}return!0},xe.prototype.set=function(I,L){for(var j=this.value,tt=0;tt<I.length-1;tt++){var lt=I[tt];si.call(j,lt)||(j[lt]={}),j=j[lt]}return j[I[tt]]=L,L},xe.prototype.map=function(I){return wn(this.value,I,!0)},xe.prototype.forEach=function(I){return this.value=wn(this.value,I,!1),this.value},xe.prototype.reduce=function(I,L){var j=1===arguments.length,tt=j?this.value:L;return this.forEach(function(lt){this.isRoot&&j||(tt=I.call(this,tt,lt))}),tt},xe.prototype.paths=function(){var I=[];return this.forEach(function(L){I.push(this.path)}),I},xe.prototype.nodes=function(){var I=[];return this.forEach(function(L){I.push(this.node)}),I},xe.prototype.clone=function(){var I=[],L=[];return function j(tt){for(var lt=0;lt<I.length;lt++)if(I[lt]===tt)return L[lt];if("object"==typeof tt&&null!==tt){var ut=ge(tt);return I.push(tt),L.push(ut),Mr(mn(tt),function(gt){ut[gt]=j(tt[gt])}),I.pop(),L.pop(),ut}return tt}(this.value)};var mn=Object.keys||function(I){var L=[];for(var j in I)L.push(j);return L};function vn(I){return Object.prototype.toString.call(I)}var pr=Array.isArray||function(I){return"[object Array]"===Object.prototype.toString.call(I)},Mr=function(I,L){if(I.forEach)return I.forEach(L);for(var j=0;j<I.length;j++)L(I[j],j,I)};Mr(mn(xe.prototype),function(I){Ht[I]=function(L){var j=[].slice.call(arguments,1),tt=new xe(L);return tt[I].apply(tt,j)}});var si=Object.hasOwnProperty||function(I,L){return L in I},ko=ee.exports,Wr=ir;function ir(I){if(!(this instanceof ir))return new ir(I);this._bbox=I||[1/0,1/0,-1/0,-1/0],this._valid=!!I}ir.prototype.include=function(I){return this._valid=!0,this._bbox[0]=Math.min(this._bbox[0],I[0]),this._bbox[1]=Math.min(this._bbox[1],I[1]),this._bbox[2]=Math.max(this._bbox[2],I[0]),this._bbox[3]=Math.max(this._bbox[3],I[1]),this},ir.prototype.equals=function(I){var L;return L=I instanceof ir?I.bbox():I,this._bbox[0]==L[0]&&this._bbox[1]==L[1]&&this._bbox[2]==L[2]&&this._bbox[3]==L[3]},ir.prototype.center=function(I){return this._valid?[(this._bbox[0]+this._bbox[2])/2,(this._bbox[1]+this._bbox[3])/2]:null},ir.prototype.union=function(I){var L;return this._valid=!0,L=I instanceof ir?I.bbox():I,this._bbox[0]=Math.min(this._bbox[0],L[0]),this._bbox[1]=Math.min(this._bbox[1],L[1]),this._bbox[2]=Math.max(this._bbox[2],L[2]),this._bbox[3]=Math.max(this._bbox[3],L[3]),this},ir.prototype.bbox=function(){return this._valid?this._bbox:null},ir.prototype.contains=function(I){if(!I)return this._fastContains();if(!this._valid)return null;var L=I[0],j=I[1];return this._bbox[0]<=L&&this._bbox[1]<=j&&this._bbox[2]>=L&&this._bbox[3]>=j},ir.prototype.intersect=function(I){return this._valid?(L=I instanceof ir?I.bbox():I,!(this._bbox[0]>L[2]||this._bbox[2]<L[0]||this._bbox[3]<L[1]||this._bbox[1]>L[3])):null;var L},ir.prototype._fastContains=function(){return this._valid?new Function("ll","return "+this._bbox[0]+"<= ll[0] &&"+this._bbox[1]+"<= ll[1] &&"+this._bbox[2]+">= ll[0] &&"+this._bbox[3]+">= ll[1]"):new Function("return null;")},ir.prototype.polygon=function(){return this._valid?{type:"Polygon",coordinates:[[[this._bbox[0],this._bbox[1]],[this._bbox[2],this._bbox[1]],[this._bbox[2],this._bbox[3]],[this._bbox[0],this._bbox[3]],[this._bbox[0],this._bbox[1]]]]}:null};var Di=function(I){if(!I)return[];var L=Zt($t(I)),j=[];return L.features.forEach(function(tt){tt.geometry&&(j=j.concat(function(I){return function L(j){return Array.isArray(j)&&j.length&&"number"==typeof j[0]?[j]:j.reduce(function(tt,lt){return Array.isArray(lt)&&Array.isArray(lt[0])?tt.concat(L(lt)):(tt.push(lt),tt)},[])}(I)}(tt.geometry.coordinates)))}),j},go=ko,wa=Wr,Ea={features:["FeatureCollection"],coordinates:["Point","MultiPoint","LineString","MultiLineString","Polygon","MultiPolygon"],geometry:["Feature"],geometries:["GeometryCollection"]},Xd=Object.keys(Ea);function Nc(I){for(var L=wa(),j=Di(I),tt=0;tt<j.length;tt++)L.include(j[tt]);return L}yt.exports=function(I){return Nc(I).bbox()},yt.exports.polygon=function(I){return Nc(I).polygon()},yt.exports.bboxify=function(I){return go(I).map(function(L){L&&Xd.some(function(j){return!!L[j]&&-1!==Ea[j].indexOf(L.type)})&&(L.bbox=Nc(L).bbox(),this.update(L))})};var ex=Qi(yt.exports),zc=-90;function Yd(I,L){var j=zc,tt=90,lt=zc,ut=90,gt=270,Et=-270;I.forEach(function(ce){var de=ex(ce),oe=de[1],Bt=de[3],Mt=de[0],Tt=de[2];oe>j&&(j=oe),Bt<tt&&(tt=Bt),Bt>lt&&(lt=Bt),oe<ut&&(ut=oe),Mt<gt&&(gt=Mt),Tt>Et&&(Et=Tt)});var Xt=L;return j+Xt.lat>85&&(Xt.lat=85-j),lt+Xt.lat>90&&(Xt.lat=90-lt),tt+Xt.lat<-85&&(Xt.lat=-85-tt),ut+Xt.lat<zc&&(Xt.lat=zc-ut),gt+Xt.lng<=-270&&(Xt.lng+=360*Math.ceil(Math.abs(Xt.lng)/360)),Et+Xt.lng>=270&&(Xt.lng-=360*Math.ceil(Math.abs(Xt.lng)/360)),Xt}function Xl(I,L){var j=Yd(I.map(function(tt){return tt.toGeoJSON()}),L);I.forEach(function(tt){var lt,ut=tt.getCoordinates(),gt=function(Xt){var ce={lng:Xt[0]+j.lng,lat:Xt[1]+j.lat};return[ce.lng,ce.lat]},Et=function(Xt){return Xt.map(function(ce){return gt(ce)})};tt.type===Pe.POINT?lt=gt(ut):tt.type===Pe.LINE_STRING||tt.type===Pe.MULTI_POINT?lt=ut.map(gt):tt.type===Pe.POLYGON||tt.type===Pe.MULTI_LINE_STRING?lt=ut.map(Et):tt.type===Pe.MULTI_POLYGON&&(lt=ut.map(function(Xt){return Xt.map(function(ce){return Et(ce)})})),tt.incomingCoords(lt)})}var yi={onSetup:function(I){var L=this,j={dragMoveLocation:null,boxSelectStartLocation:null,boxSelectElement:void 0,boxSelecting:!1,canBoxSelect:!1,dragMoving:!1,canDragMove:!1,initiallySelectedFeatureIds:I.featureIds||[]};return this.setSelected(j.initiallySelectedFeatureIds.filter(function(tt){return void 0!==L.getFeature(tt)})),this.fireActionable(),this.setActionableState({combineFeatures:!0,uncombineFeatures:!0,trash:!0}),j},fireUpdate:function(){this.map.fire(Bi.UPDATE,{action:il.MOVE,features:this.getSelected().map(function(I){return I.toGeoJSON()})})},fireActionable:function(){var I=this,L=this.getSelected(),j=L.filter(function(Et){return I.isInstanceOf("MultiFeature",Et)}),tt=!1;if(L.length>1){tt=!0;var lt=L[0].type.replace("Multi","");L.forEach(function(Et){Et.type.replace("Multi","")!==lt&&(tt=!1)})}this.setActionableState({combineFeatures:tt,uncombineFeatures:j.length>0,trash:L.length>0})},getUniqueIds:function(I){return I.length?I.map(function(L){return L.properties.id}).filter(function(L){return void 0!==L}).reduce(function(L,j){return L.add(j),L},new ti).values():[]},stopExtendedInteractions:function(I){I.boxSelectElement&&(I.boxSelectElement.parentNode&&I.boxSelectElement.parentNode.removeChild(I.boxSelectElement),I.boxSelectElement=null),this.map.dragPan.enable(),I.boxSelecting=!1,I.canBoxSelect=!1,I.dragMoving=!1,I.canDragMove=!1},onStop:function(){Vi.enable(this)},onMouseMove:function(I,L){return nr(L)&&I.dragMoving&&this.fireUpdate(),this.stopExtendedInteractions(I),!0},onMouseOut:function(I){return!I.dragMoving||this.fireUpdate()}};yi.onTap=yi.onClick=function(I,L){return Cn(L)?this.clickAnywhere(I,L):Pt(rr.VERTEX)(L)?this.clickOnVertex(I,L):nr(L)?this.clickOnFeature(I,L):void 0},yi.clickAnywhere=function(I){var L=this,j=this.getSelectedIds();j.length&&(this.clearSelectedFeatures(),j.forEach(function(tt){return L.doRender(tt)})),Vi.enable(this),this.stopExtendedInteractions(I)},yi.clickOnVertex=function(I,L){this.changeMode(pn.DIRECT_SELECT,{featureId:L.featureTarget.properties.parent,coordPath:L.featureTarget.properties.coord_path,startPos:L.lngLat}),this.updateUIClasses({mouse:Hn.MOVE})},yi.startOnActiveFeature=function(I,L){this.stopExtendedInteractions(I),this.map.dragPan.disable(),this.doRender(L.featureTarget.properties.id),I.canDragMove=!0,I.dragMoveLocation=L.lngLat},yi.clickOnFeature=function(I,L){var j=this;Vi.disable(this),this.stopExtendedInteractions(I);var tt=Jn(L),lt=this.getSelectedIds(),ut=L.featureTarget.properties.id,gt=this.isSelected(ut);if(!tt&&gt&&this.getFeature(ut).type!==Pe.POINT)return this.changeMode(pn.DIRECT_SELECT,{featureId:ut});gt&&tt?(this.deselect(ut),this.updateUIClasses({mouse:Hn.POINTER}),1===lt.length&&Vi.enable(this)):!gt&&tt?(this.select(ut),this.updateUIClasses({mouse:Hn.MOVE})):gt||tt||(lt.forEach(function(Et){return j.doRender(Et)}),this.setSelected(ut),this.updateUIClasses({mouse:Hn.MOVE})),this.doRender(ut)},yi.onMouseDown=function(I,L){return _e(L)?this.startOnActiveFeature(I,L):this.drawConfig.boxSelect&&pe(L)?this.startBoxSelect(I,L):void 0},yi.startBoxSelect=function(I,L){this.stopExtendedInteractions(I),this.map.dragPan.disable(),I.boxSelectStartLocation=ba(L.originalEvent,this.map.getContainer()),I.canBoxSelect=!0},yi.onTouchStart=function(I,L){if(_e(L))return this.startOnActiveFeature(I,L)},yi.onDrag=function(I,L){return I.canDragMove?this.dragMove(I,L):this.drawConfig.boxSelect&&I.canBoxSelect?this.whileBoxSelect(I,L):void 0},yi.whileBoxSelect=function(I,L){I.boxSelecting=!0,this.updateUIClasses({mouse:Hn.ADD}),I.boxSelectElement||(I.boxSelectElement=document.createElement("div"),I.boxSelectElement.classList.add(Te.BOX_SELECT),this.map.getContainer().appendChild(I.boxSelectElement));var j=ba(L.originalEvent,this.map.getContainer()),tt=Math.min(I.boxSelectStartLocation.x,j.x),lt=Math.max(I.boxSelectStartLocation.x,j.x),ut=Math.min(I.boxSelectStartLocation.y,j.y),gt=Math.max(I.boxSelectStartLocation.y,j.y),Et="translate("+tt+"px, "+ut+"px)";I.boxSelectElement.style.transform=Et,I.boxSelectElement.style.WebkitTransform=Et,I.boxSelectElement.style.width=lt-tt+"px",I.boxSelectElement.style.height=gt-ut+"px"},yi.dragMove=function(I,L){I.dragMoving=!0,L.originalEvent.stopPropagation();var j={lng:L.lngLat.lng-I.dragMoveLocation.lng,lat:L.lngLat.lat-I.dragMoveLocation.lat};Xl(this.getSelected(),j),I.dragMoveLocation=L.lngLat},yi.onTouchEnd=yi.onMouseUp=function(I,L){var j=this;if(I.dragMoving)this.fireUpdate();else if(I.boxSelecting){var tt=[I.boxSelectStartLocation,ba(L.originalEvent,this.map.getContainer())],lt=this.featuresAt(null,tt,"click"),ut=this.getUniqueIds(lt).filter(function(gt){return!j.isSelected(gt)});ut.length&&(this.select(ut),ut.forEach(function(gt){return j.doRender(gt)}),this.updateUIClasses({mouse:Hn.MOVE}))}this.stopExtendedInteractions(I)},yi.toDisplayFeatures=function(I,L,j){L.properties.active=this.isSelected(L.properties.id)?dr.ACTIVE:dr.INACTIVE,j(L),this.fireActionable(),L.properties.active===dr.ACTIVE&&L.geometry.type!==Pe.POINT&&us(L).forEach(j)},yi.onTrash=function(){this.deleteFeature(this.getSelectedIds()),this.fireActionable()},yi.onCombineFeatures=function(){var I=this.getSelected();if(!(0===I.length||I.length<2)){for(var L=[],j=[],tt=I[0].type.replace("Multi",""),lt=0;lt<I.length;lt++){var ut=I[lt];if(ut.type.replace("Multi","")!==tt)return;ut.type.includes("Multi")?ut.getCoordinates().forEach(function(Et){L.push(Et)}):L.push(ut.getCoordinates()),j.push(ut.toGeoJSON())}if(j.length>1){var gt=this.newFeature({type:Pe.FEATURE,properties:j[0].properties,geometry:{type:"Multi"+tt,coordinates:L}});this.addFeature(gt),this.deleteFeature(this.getSelectedIds(),{silent:!0}),this.setSelected([gt.id]),this.map.fire(Bi.COMBINE_FEATURES,{createdFeatures:[gt.toGeoJSON()],deletedFeatures:j})}this.fireActionable()}},yi.onUncombineFeatures=function(){var I=this,L=this.getSelected();if(0!==L.length){for(var j=[],tt=[],lt=function(gt){var Et=L[gt];I.isInstanceOf("MultiFeature",Et)&&(Et.getFeatures().forEach(function(Xt){I.addFeature(Xt),Xt.properties=Et.properties,j.push(Xt.toGeoJSON()),I.select([Xt.id])}),I.deleteFeature(Et.id,{silent:!0}),tt.push(Et.toGeoJSON()))},ut=0;ut<L.length;ut++)lt(ut);j.length>1&&this.map.fire(Bi.UNCOMBINE_FEATURES,{createdFeatures:j,deletedFeatures:tt}),this.fireActionable()}};var Yl=Pt(rr.VERTEX),Kd=Pt(rr.MIDPOINT),Fo={fireUpdate:function(){this.map.fire(Bi.UPDATE,{action:il.CHANGE_COORDINATES,features:this.getSelected().map(function(I){return I.toGeoJSON()})})},fireActionable:function(I){this.setActionableState({combineFeatures:!1,uncombineFeatures:!1,trash:I.selectedCoordPaths.length>0})},startDragging:function(I,L){this.map.dragPan.disable(),I.canDragMove=!0,I.dragMoveLocation=L.lngLat},stopDragging:function(I){this.map.dragPan.enable(),I.dragMoving=!1,I.canDragMove=!1,I.dragMoveLocation=null},onVertex:function(I,L){this.startDragging(I,L);var j=L.featureTarget.properties,tt=I.selectedCoordPaths.indexOf(j.coord_path);Jn(L)||-1!==tt?Jn(L)&&-1===tt&&I.selectedCoordPaths.push(j.coord_path):I.selectedCoordPaths=[j.coord_path];var lt=this.pathsToCoordinates(I.featureId,I.selectedCoordPaths);this.setSelectedCoordinates(lt)},onMidpoint:function(I,L){this.startDragging(I,L);var j=L.featureTarget.properties;I.feature.addCoordinate(j.coord_path,j.lng,j.lat),this.fireUpdate(),I.selectedCoordPaths=[j.coord_path]},pathsToCoordinates:function(I,L){return L.map(function(j){return{feature_id:I,coord_path:j}})},onFeature:function(I,L){0===I.selectedCoordPaths.length?this.startDragging(I,L):this.stopDragging(I)},dragFeature:function(I,L,j){Xl(this.getSelected(),j),I.dragMoveLocation=L.lngLat},dragVertex:function(I,L,j){for(var tt=I.selectedCoordPaths.map(function(Et){return I.feature.getCoordinate(Et)}),lt=Yd(tt.map(function(Et){return{type:Pe.FEATURE,properties:{},geometry:{type:Pe.POINT,coordinates:Et}}}),j),ut=0;ut<tt.length;ut++){var gt=tt[ut];I.feature.updateCoordinate(I.selectedCoordPaths[ut],gt[0]+lt.lng,gt[1]+lt.lat)}},clickNoTarget:function(){this.changeMode(pn.SIMPLE_SELECT)},clickInactive:function(){this.changeMode(pn.SIMPLE_SELECT)},clickActiveFeature:function(I){I.selectedCoordPaths=[],this.clearSelectedCoordinates(),I.feature.changed()},onSetup:function(I){var L=I.featureId,j=this.getFeature(L);if(!j)throw new Error("You must provide a featureId to enter direct_select mode");if(j.type===Pe.POINT)throw new TypeError("direct_select mode doesn't handle point features");var tt={featureId:L,feature:j,dragMoveLocation:I.startPos||null,dragMoving:!1,canDragMove:!1,selectedCoordPaths:I.coordPath?[I.coordPath]:[]};return this.setSelectedCoordinates(this.pathsToCoordinates(L,tt.selectedCoordPaths)),this.setSelected(L),Vi.disable(this),this.setActionableState({trash:!0}),tt},onStop:function(){Vi.enable(this),this.clearSelectedCoordinates()},toDisplayFeatures:function(I,L,j){I.featureId===L.properties.id?(L.properties.active=dr.ACTIVE,j(L),us(L,{map:this.map,midpoints:!0,selectedPaths:I.selectedCoordPaths}).forEach(j)):(L.properties.active=dr.INACTIVE,j(L)),this.fireActionable(I)},onTrash:function(I){I.selectedCoordPaths.sort(function(L,j){return j.localeCompare(L,"en",{numeric:!0})}).forEach(function(L){return I.feature.removeCoordinate(L)}),this.fireUpdate(),I.selectedCoordPaths=[],this.clearSelectedCoordinates(),this.fireActionable(I),!1===I.feature.isValid()&&(this.deleteFeature([I.featureId]),this.changeMode(pn.SIMPLE_SELECT,{}))},onMouseMove:function(I,L){var j=_e(L),tt=Yl(L),lt=Kd(L),ut=0===I.selectedCoordPaths.length;return this.updateUIClasses(j&&ut||tt&&!ut?{mouse:Hn.MOVE}:{mouse:Hn.NONE}),(tt||j||lt)&&I.dragMoving&&this.fireUpdate(),this.stopDragging(I),!0},onMouseOut:function(I){return I.dragMoving&&this.fireUpdate(),!0}};Fo.onTouchStart=Fo.onMouseDown=function(I,L){return Yl(L)?this.onVertex(I,L):_e(L)?this.onFeature(I,L):Kd(L)?this.onMidpoint(I,L):void 0},Fo.onDrag=function(I,L){if(!0===I.canDragMove){I.dragMoving=!0,L.originalEvent.stopPropagation();var j={lng:L.lngLat.lng-I.dragMoveLocation.lng,lat:L.lngLat.lat-I.dragMoveLocation.lat};I.selectedCoordPaths.length>0?this.dragVertex(I,L,j):this.dragFeature(I,L,j),I.dragMoveLocation=L.lngLat}},Fo.onClick=function(I,L){return Cn(L)?this.clickNoTarget(I,L):_e(L)?this.clickActiveFeature(I,L):Ee(L)?this.clickInactive(I,L):void this.stopDragging(I)},Fo.onTap=function(I,L){return Cn(L)?this.clickNoTarget(I,L):_e(L)?this.clickActiveFeature(I,L):Ee(L)?this.clickInactive(I,L):void 0},Fo.onTouchEnd=Fo.onMouseUp=function(I){I.dragMoving&&this.fireUpdate(),this.stopDragging(I)};var No={};function rh(I,L){return!!I.lngLat&&I.lngLat.lng===L[0]&&I.lngLat.lat===L[1]}No.onSetup=function(){var I=this.newFeature({type:Pe.FEATURE,properties:{},geometry:{type:Pe.POINT,coordinates:[]}});return this.addFeature(I),this.clearSelectedFeatures(),this.updateUIClasses({mouse:Hn.ADD}),this.activateUIButton(Zr.POINT),this.setActionableState({trash:!0}),{point:I}},No.stopDrawingAndRemove=function(I){this.deleteFeature([I.point.id],{silent:!0}),this.changeMode(pn.SIMPLE_SELECT)},No.onTap=No.onClick=function(I,L){this.updateUIClasses({mouse:Hn.MOVE}),I.point.updateCoordinate("",L.lngLat.lng,L.lngLat.lat),this.map.fire(Bi.CREATE,{features:[I.point.toGeoJSON()]}),this.changeMode(pn.SIMPLE_SELECT,{featureIds:[I.point.id]})},No.onStop=function(I){this.activateUIButton(),I.point.getCoordinate().length||this.deleteFeature([I.point.id],{silent:!0})},No.toDisplayFeatures=function(I,L,j){var tt=L.properties.id===I.point.id;if(L.properties.active=tt?dr.ACTIVE:dr.INACTIVE,!tt)return j(L)},No.onTrash=No.stopDrawingAndRemove,No.onKeyUp=function(I,L){if(Fn(L)||Nn(L))return this.stopDrawingAndRemove(I,L)};var sl={onSetup:function(){var I=this.newFeature({type:Pe.FEATURE,properties:{},geometry:{type:Pe.POLYGON,coordinates:[[]]}});return this.addFeature(I),this.clearSelectedFeatures(),Vi.disable(this),this.updateUIClasses({mouse:Hn.ADD}),this.activateUIButton(Zr.POLYGON),this.setActionableState({trash:!0}),{polygon:I,currentVertexPosition:0}},clickAnywhere:function(I,L){if(I.currentVertexPosition>0&&rh(L,I.polygon.coordinates[0][I.currentVertexPosition-1]))return this.changeMode(pn.SIMPLE_SELECT,{featureIds:[I.polygon.id]});this.updateUIClasses({mouse:Hn.ADD}),I.polygon.updateCoordinate("0."+I.currentVertexPosition,L.lngLat.lng,L.lngLat.lat),I.currentVertexPosition++,I.polygon.updateCoordinate("0."+I.currentVertexPosition,L.lngLat.lng,L.lngLat.lat)},clickOnVertex:function(I){return this.changeMode(pn.SIMPLE_SELECT,{featureIds:[I.polygon.id]})},onMouseMove:function(I,L){I.polygon.updateCoordinate("0."+I.currentVertexPosition,L.lngLat.lng,L.lngLat.lat),Lr(L)&&this.updateUIClasses({mouse:Hn.POINTER})}};sl.onTap=sl.onClick=function(I,L){return Lr(L)?this.clickOnVertex(I,L):this.clickAnywhere(I,L)},sl.onKeyUp=function(I,L){Fn(L)?(this.deleteFeature([I.polygon.id],{silent:!0}),this.changeMode(pn.SIMPLE_SELECT)):Nn(L)&&this.changeMode(pn.SIMPLE_SELECT,{featureIds:[I.polygon.id]})},sl.onStop=function(I){this.updateUIClasses({mouse:Hn.NONE}),Vi.enable(this),this.activateUIButton(),void 0!==this.getFeature(I.polygon.id)&&(I.polygon.removeCoordinate("0."+I.currentVertexPosition),I.polygon.isValid()?this.map.fire(Bi.CREATE,{features:[I.polygon.toGeoJSON()]}):(this.deleteFeature([I.polygon.id],{silent:!0}),this.changeMode(pn.SIMPLE_SELECT,{},{silent:!0})))},sl.toDisplayFeatures=function(I,L,j){var tt=L.properties.id===I.polygon.id;if(L.properties.active=tt?dr.ACTIVE:dr.INACTIVE,!tt)return j(L);if(0!==L.geometry.coordinates.length){var lt=L.geometry.coordinates[0].length;if(!(lt<3)){if(L.properties.meta=rr.FEATURE,j(di(I.polygon.id,L.geometry.coordinates[0][0],"0.0",!1)),lt>3){var ut=L.geometry.coordinates[0].length-3;j(di(I.polygon.id,L.geometry.coordinates[0][ut],"0."+ut,!1))}if(lt<=4&&(j({type:Pe.FEATURE,properties:L.properties,geometry:{coordinates:[[L.geometry.coordinates[0][0][0],L.geometry.coordinates[0][0][1]],[L.geometry.coordinates[0][1][0],L.geometry.coordinates[0][1][1]]],type:Pe.LINE_STRING}}),3===lt))return;return j(L)}}},sl.onTrash=function(I){this.deleteFeature([I.polygon.id],{silent:!0}),this.changeMode(pn.SIMPLE_SELECT)};var Ta={onSetup:function(I){var L,j,tt=(I=I||{}).featureId,lt="forward";if(tt){if(!(L=this.getFeature(tt)))throw new Error("Could not find a feature with the provided featureId");var ut=I.from;if(ut&&"Feature"===ut.type&&ut.geometry&&"Point"===ut.geometry.type&&(ut=ut.geometry),ut&&"Point"===ut.type&&ut.coordinates&&2===ut.coordinates.length&&(ut=ut.coordinates),!ut||!Array.isArray(ut))throw new Error("Please use the `from` property to indicate which point to continue the line from");var gt=L.coordinates.length-1;if(L.coordinates[gt][0]===ut[0]&&L.coordinates[gt][1]===ut[1])L.addCoordinate.apply(L,[j=gt+1].concat(L.coordinates[gt]));else{if(L.coordinates[0][0]!==ut[0]||L.coordinates[0][1]!==ut[1])throw new Error("`from` should match the point at either the start or the end of the provided LineString");lt="backwards",L.addCoordinate.apply(L,[j=0].concat(L.coordinates[0]))}}else L=this.newFeature({type:Pe.FEATURE,properties:{},geometry:{type:Pe.LINE_STRING,coordinates:[]}}),j=0,this.addFeature(L);return this.clearSelectedFeatures(),Vi.disable(this),this.updateUIClasses({mouse:Hn.ADD}),this.activateUIButton(Zr.LINE),this.setActionableState({trash:!0}),{line:L,currentVertexPosition:j,direction:lt}},clickAnywhere:function(I,L){if(I.currentVertexPosition>0&&rh(L,I.line.coordinates[I.currentVertexPosition-1])||"backwards"===I.direction&&rh(L,I.line.coordinates[I.currentVertexPosition+1]))return this.changeMode(pn.SIMPLE_SELECT,{featureIds:[I.line.id]});this.updateUIClasses({mouse:Hn.ADD}),I.line.updateCoordinate(I.currentVertexPosition,L.lngLat.lng,L.lngLat.lat),"forward"===I.direction?(I.currentVertexPosition++,I.line.updateCoordinate(I.currentVertexPosition,L.lngLat.lng,L.lngLat.lat)):I.line.addCoordinate(0,L.lngLat.lng,L.lngLat.lat)},clickOnVertex:function(I){return this.changeMode(pn.SIMPLE_SELECT,{featureIds:[I.line.id]})},onMouseMove:function(I,L){I.line.updateCoordinate(I.currentVertexPosition,L.lngLat.lng,L.lngLat.lat),Lr(L)&&this.updateUIClasses({mouse:Hn.POINTER})}};Ta.onTap=Ta.onClick=function(I,L){if(Lr(L))return this.clickOnVertex(I,L);this.clickAnywhere(I,L)},Ta.onKeyUp=function(I,L){Nn(L)?this.changeMode(pn.SIMPLE_SELECT,{featureIds:[I.line.id]}):Fn(L)&&(this.deleteFeature([I.line.id],{silent:!0}),this.changeMode(pn.SIMPLE_SELECT))},Ta.onStop=function(I){Vi.enable(this),this.activateUIButton(),void 0!==this.getFeature(I.line.id)&&(I.line.removeCoordinate(""+I.currentVertexPosition),I.line.isValid()?this.map.fire(Bi.CREATE,{features:[I.line.toGeoJSON()]}):(this.deleteFeature([I.line.id],{silent:!0}),this.changeMode(pn.SIMPLE_SELECT,{},{silent:!0})))},Ta.onTrash=function(I){this.deleteFeature([I.line.id],{silent:!0}),this.changeMode(pn.SIMPLE_SELECT)},Ta.toDisplayFeatures=function(I,L,j){var tt=L.properties.id===I.line.id;if(L.properties.active=tt?dr.ACTIVE:dr.INACTIVE,!tt)return j(L);L.geometry.coordinates.length<2||(L.properties.meta=rr.FEATURE,j(di(I.line.id,L.geometry.coordinates["forward"===I.direction?L.geometry.coordinates.length-2:1],""+("forward"===I.direction?L.geometry.coordinates.length-2:1),!1)),j(L))};var Jd={simple_select:yi,direct_select:Fo,draw_point:No,draw_polygon:sl,draw_line_string:Ta},ih={defaultMode:pn.SIMPLE_SELECT,keybindings:!0,touchEnabled:!0,clickBuffer:2,touchBuffer:25,boxSelect:!0,displayControlsDefault:!0,styles:ae,modes:Jd,controls:{},userProperties:!1},Qd={point:!0,line_string:!0,polygon:!0,trash:!0,combine_features:!0,uncombine_features:!0},tf={point:!1,line_string:!1,polygon:!1,trash:!1,combine_features:!1,uncombine_features:!1};function Kl(I,L){return I.map(function(j){return j.source?j:At(j,{id:j.id+"."+L,source:"hot"===L?Pr.HOT:Pr.COLD})})}var Bc={exports:{}};!function(I,L){var j="__lodash_hash_undefined__",tt=9007199254740991,lt="[object Arguments]",ut="[object Array]",gt="[object Boolean]",Et="[object Date]",Xt="[object Error]",ce="[object Function]",de="[object Map]",oe="[object Number]",Bt="[object Object]",Mt="[object Promise]",Tt="[object RegExp]",ye="[object Set]",H="[object String]",Vn="[object WeakMap]",lr="[object ArrayBuffer]",je="[object DataView]",Cs=/^\[object .+?Constructor\]$/,o_=/^(?:0|[1-9]\d*)$/,qn={};qn["[object Float32Array]"]=qn["[object Float64Array]"]=qn["[object Int8Array]"]=qn["[object Int16Array]"]=qn["[object Int32Array]"]=qn["[object Uint8Array]"]=qn["[object Uint8ClampedArray]"]=qn["[object Uint16Array]"]=qn["[object Uint32Array]"]=!0,qn[lt]=qn[ut]=qn[lr]=qn[gt]=qn[je]=qn[Et]=qn[Xt]=qn[ce]=qn[de]=qn[oe]=qn[Bt]=qn[Tt]=qn[ye]=qn[H]=qn[Vn]=!1;var As="object"==typeof global&&global&&global.Object===Object&&global,nx="object"==typeof self&&self&&self.Object===Object&&self,_o=As||nx||Function("return this")(),Kt=L&&!L.nodeType&&L,an=Kt&&I&&!I.nodeType&&I,gn=an&&an.exports===Kt,yo=gn&&As.process,al=function(){try{return yo&&yo.binding&&yo.binding("util")}catch{}}(),cn=al&&al.isTypedArray;function Zi(pt,Dt){for(var et=-1,Fe=null==pt?0:pt.length;++et<Fe;)if(Dt(pt[et],et,pt))return!0;return!1}function He(pt){var Dt=-1,et=Array(pt.size);return pt.forEach(function(Fe,or){et[++Dt]=[or,Fe]}),et}function oh(pt){var Dt=-1,et=Array(pt.size);return pt.forEach(function(Fe){et[++Dt]=Fe}),et}var eo,Or,cr,sh=Array.prototype,hs=Object.prototype,ah=_o["__core-js_shared__"],lh=Function.prototype.toString,vo=hs.hasOwnProperty,ll=(eo=/[^.]+$/.exec(ah&&ah.keys&&ah.keys.IE_PROTO||""))?"Symbol(src)_1."+eo:"",Ia=hs.toString,Vc=RegExp("^"+lh.call(vo).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),Ui=gn?_o.Buffer:void 0,ke=_o.Symbol,An=_o.Uint8Array,Ql=hs.propertyIsEnumerable,Wi=sh.splice,Qn=ke?ke.toStringTag:void 0,ch=Object.getOwnPropertySymbols,Uc=Ui?Ui.isBuffer:void 0,on=(Or=Object.keys,cr=Object,function(pt){return Or(cr(pt))}),tc=Gi(_o,"DataView"),ec=Gi(_o,"Map"),qe=Gi(_o,"Promise"),kr=Gi(_o,"Set"),cl=Gi(_o,"WeakMap"),Da=Gi(Object,"create"),ds=Ca(tc),Gc=Ca(ec),ul=Ca(qe),Pn=Ca(kr),rx=Ca(cl),nf=ke?ke.prototype:void 0,Sa=nf?nf.valueOf:void 0;function nc(pt){var Dt=-1,et=null==pt?0:pt.length;for(this.clear();++Dt<et;){var Fe=pt[Dt];this.set(Fe[0],Fe[1])}}function no(pt){var Dt=-1,et=null==pt?0:pt.length;for(this.clear();++Dt<et;){var Fe=pt[Dt];this.set(Fe[0],Fe[1])}}function Xi(pt){var Dt=-1,et=null==pt?0:pt.length;for(this.clear();++Dt<et;){var Fe=pt[Dt];this.set(Fe[0],Fe[1])}}function hl(pt){var Dt=-1,et=null==pt?0:pt.length;for(this.__data__=new Xi;++Dt<et;)this.add(pt[Dt])}function Si(pt){var Dt=this.__data__=new no(pt);this.size=Dt.size}function $c(pt,Dt){for(var et=pt.length;et--;)if(jp(pt[et][0],Dt))return et;return-1}function rc(pt){return null==pt?void 0===pt?"[object Undefined]":"[object Null]":Qn&&Qn in Object(pt)?function(Dt){var et=vo.call(Dt,Qn),Fe=Dt[Qn];try{Dt[Qn]=void 0;var or=!0}catch{}var In=Ia.call(Dt);return or&&(et?Dt[Qn]=Fe:delete Dt[Qn]),In}(pt):Ia.call(pt)}function dl(pt){return Ws(pt)&&rc(pt)==lt}function ic(pt,Dt,et,Fe,or){return pt===Dt||(null==pt||null==Dt||!Ws(pt)&&!Ws(Dt)?pt!=pt&&Dt!=Dt:function(In,Fr,mr,ai,Xr,Sr){var io=Aa(In),oo=Aa(Fr),Ci=io?ut:jo(In),fi=oo?ut:jo(Fr),fl=(Ci=Ci==lt?Bt:Ci)==Bt,oc=(fi=fi==lt?Bt:fi)==Bt,Pa=Ci==fi;if(Pa&&ro(In)){if(!ro(Fr))return!1;io=!0,fl=!1}if(Pa&&!fl)return Sr||(Sr=new Si),io||Hc(In)?Mn(In,Fr,mr,ai,Xr,Sr):function(ur,sr,pl,Ps,fh,so,Uo){switch(pl){case je:if(ur.byteLength!=sr.byteLength||ur.byteOffset!=sr.byteOffset)return!1;ur=ur.buffer,sr=sr.buffer;case lr:return!(ur.byteLength!=sr.byteLength||!so(new An(ur),new An(sr)));case gt:case Et:case oe:return jp(+ur,+sr);case Xt:return ur.name==sr.name&&ur.message==sr.message;case Tt:case H:return ur==sr+"";case de:var Go=He;case ye:if(Go||(Go=oh),ur.size!=sr.size&&!(1&Ps))return!1;var ml=Uo.get(ur);if(ml)return ml==sr;Ps|=2,Uo.set(ur,sr);var Yr=Mn(Go(ur),Go(sr),Ps,fh,so,Uo);return Uo.delete(ur),Yr;case"[object Symbol]":if(Sa)return Sa.call(ur)==Sa.call(sr)}return!1}(In,Fr,Ci,mr,ai,Xr,Sr);if(!(1&mr)){var qc=fl&&vo.call(In,"__wrapped__"),Vp=oc&&vo.call(Fr,"__wrapped__");if(qc||Vp){var l_=qc?In.value():In,Up=Vp?Fr.value():Fr;return Sr||(Sr=new Si),Xr(l_,Up,mr,ai,Sr)}}return!!Pa&&(Sr||(Sr=new Si),function(ur,sr,pl,Ps,fh,so){var Uo=1&pl,Go=hh(ur),Xs=Go.length;if(Xs!=hh(sr).length&&!Uo)return!1;for(var Yr=Xs;Yr--;){var Nr=Go[Yr];if(!(Uo?Nr in sr:vo.call(sr,Nr)))return!1}var On=so.get(ur);if(On&&so.get(sr))return On==sr;var Cr=!0;so.set(ur,sr),so.set(sr,ur);for(var pi=Uo;++Yr<Xs;){var Ys=ur[Nr=Go[Yr]],vi=sr[Nr];if(Ps)var ph=Uo?Ps(vi,Ys,Nr,sr,ur,so):Ps(Ys,vi,Nr,ur,sr,so);if(!(void 0===ph?Ys===vi||fh(Ys,vi,pl,Ps,so):ph)){Cr=!1;break}pi||(pi="constructor"==Nr)}if(Cr&&!pi){var gl=ur.constructor,Rs=sr.constructor;gl==Rs||!("constructor"in ur)||!("constructor"in sr)||"function"==typeof gl&&gl instanceof gl&&"function"==typeof Rs&&Rs instanceof Rs||(Cr=!1)}return so.delete(ur),so.delete(sr),Cr}(In,Fr,mr,ai,Xr,Sr))}(pt,Dt,et,Fe,ic,or))}function Mn(pt,Dt,et,Fe,or,In){var Fr=1&et,mr=pt.length,ai=Dt.length;if(mr!=ai&&!(Fr&&ai>mr))return!1;var Xr=In.get(pt);if(Xr&&In.get(Dt))return Xr==Dt;var Sr=-1,io=!0,oo=2&et?new hl:void 0;for(In.set(pt,Dt),In.set(Dt,pt);++Sr<mr;){var Ci=pt[Sr],fi=Dt[Sr];if(Fe)var fl=Fr?Fe(fi,Ci,Sr,Dt,pt,In):Fe(Ci,fi,Sr,pt,Dt,In);if(void 0!==fl){if(fl)continue;io=!1;break}if(oo){if(!Zi(Dt,function(oc,Pa){if(!oo.has(Pa)&&(Ci===oc||or(Ci,oc,et,Fe,In)))return oo.push(Pa)})){io=!1;break}}else if(Ci!==fi&&!or(Ci,fi,et,Fe,In)){io=!1;break}}return In.delete(pt),In.delete(Dt),io}function hh(pt){return Fe=rf,or=function dh(pt){return null!=(Dt=pt)&&Gn(Dt.length)&&!Vo(Dt)?function uh(pt,Dt){var et=Aa(pt),Fe=!et&&fs(pt),or=!et&&!Fe&&ro(pt),In=!et&&!Fe&&!or&&Hc(pt),Fr=et||Fe||or||In,mr=Fr?function(Sr,io){for(var oo=-1,Ci=Array(Sr);++oo<Sr;)Ci[oo]=io(oo);return Ci}(pt.length,String):[],ai=mr.length;for(var Xr in pt)!Dt&&!vo.call(pt,Xr)||Fr&&("length"==Xr||or&&("offset"==Xr||"parent"==Xr)||In&&("buffer"==Xr||"byteLength"==Xr||"byteOffset"==Xr)||a_(Xr,ai))||mr.push(Xr);return mr}(pt):function s_(pt){if(et=(Dt=pt)&&Dt.constructor,Dt!==("function"==typeof et&&et.prototype||hs))return on(pt);var Dt,et,or=[];for(var In in Object(pt))vo.call(pt,In)&&"constructor"!=In&&or.push(In);return or}(pt);var Dt}(Dt=pt),Aa(Dt)?or:function(In,Fr){for(var mr=-1,ai=Fr.length,Xr=In.length;++mr<ai;)In[Xr+mr]=Fr[mr];return In}(or,Fe(Dt));var Dt,Fe,or}function Wn(pt,Dt){var et,Fe,or=pt.__data__;return("string"==(Fe=typeof(et=Dt))||"number"==Fe||"symbol"==Fe||"boolean"==Fe?"__proto__"!==et:null===et)?or["string"==typeof Dt?"string":"hash"]:or.map}function Gi(pt,Dt){var Fe,or,et=(Fe=pt,or=Dt,Fe?.[or]);return function Bo(pt){return!(!Zs(pt)||(Dt=pt,ll&&ll in Dt))&&(Vo(pt)?Vc:Cs).test(Ca(pt));var Dt}(et)?et:void 0}nc.prototype.clear=function(){this.__data__=Da?Da(null):{},this.size=0},nc.prototype.delete=function(pt){var Dt=this.has(pt)&&delete this.__data__[pt];return this.size-=Dt?1:0,Dt},nc.prototype.get=function(pt){var Dt=this.__data__;if(Da){var et=Dt[pt];return et===j?void 0:et}return vo.call(Dt,pt)?Dt[pt]:void 0},nc.prototype.has=function(pt){var Dt=this.__data__;return Da?void 0!==Dt[pt]:vo.call(Dt,pt)},nc.prototype.set=function(pt,Dt){var et=this.__data__;return this.size+=this.has(pt)?0:1,et[pt]=Da&&void 0===Dt?j:Dt,this},no.prototype.clear=function(){this.__data__=[],this.size=0},no.prototype.delete=function(pt){var Dt=this.__data__,et=$c(Dt,pt);return!(et<0||(et==Dt.length-1?Dt.pop():Wi.call(Dt,et,1),--this.size,0))},no.prototype.get=function(pt){var Dt=this.__data__,et=$c(Dt,pt);return et<0?void 0:Dt[et][1]},no.prototype.has=function(pt){return $c(this.__data__,pt)>-1},no.prototype.set=function(pt,Dt){var et=this.__data__,Fe=$c(et,pt);return Fe<0?(++this.size,et.push([pt,Dt])):et[Fe][1]=Dt,this},Xi.prototype.clear=function(){this.size=0,this.__data__={hash:new nc,map:new(ec||no),string:new nc}},Xi.prototype.delete=function(pt){var Dt=Wn(this,pt).delete(pt);return this.size-=Dt?1:0,Dt},Xi.prototype.get=function(pt){return Wn(this,pt).get(pt)},Xi.prototype.has=function(pt){return Wn(this,pt).has(pt)},Xi.prototype.set=function(pt,Dt){var et=Wn(this,pt),Fe=et.size;return et.set(pt,Dt),this.size+=et.size==Fe?0:1,this},hl.prototype.add=hl.prototype.push=function(pt){return this.__data__.set(pt,j),this},hl.prototype.has=function(pt){return this.__data__.has(pt)},Si.prototype.clear=function(){this.__data__=new no,this.size=0},Si.prototype.delete=function(pt){var Dt=this.__data__,et=Dt.delete(pt);return this.size=Dt.size,et},Si.prototype.get=function(pt){return this.__data__.get(pt)},Si.prototype.has=function(pt){return this.__data__.has(pt)},Si.prototype.set=function(pt,Dt){var et=this.__data__;if(et instanceof no){var Fe=et.__data__;if(!ec||Fe.length<199)return Fe.push([pt,Dt]),this.size=++et.size,this;et=this.__data__=new Xi(Fe)}return et.set(pt,Dt),this.size=et.size,this};var rf=ch?function(pt){return null==pt?[]:(pt=Object(pt),function(Dt,et){for(var Fe=-1,or=null==Dt?0:Dt.length,In=0,Fr=[];++Fe<or;){var mr=Dt[Fe];et(mr)&&(Fr[In++]=mr)}return Fr}(ch(pt),function(Dt){return Ql.call(pt,Dt)}))}:function(){return[]},jo=rc;function a_(pt,Dt){return!!(Dt=Dt??tt)&&("number"==typeof pt||o_.test(pt))&&pt>-1&&pt%1==0&&pt<Dt}function Ca(pt){if(null!=pt){try{return lh.call(pt)}catch{}try{return pt+""}catch{}}return""}function jp(pt,Dt){return pt===Dt||pt!=pt&&Dt!=Dt}(tc&&jo(new tc(new ArrayBuffer(1)))!=je||ec&&jo(new ec)!=de||qe&&jo(qe.resolve())!=Mt||kr&&jo(new kr)!=ye||cl&&jo(new cl)!=Vn)&&(jo=function(pt){var Dt=rc(pt),et=Dt==Bt?pt.constructor:void 0,Fe=et?Ca(et):"";if(Fe)switch(Fe){case ds:return je;case Gc:return de;case ul:return Mt;case Pn:return ye;case rx:return Vn}return Dt});var fs=dl(function(){return arguments}())?dl:function(pt){return Ws(pt)&&vo.call(pt,"callee")&&!Ql.call(pt,"callee")},Aa=Array.isArray,ro=Uc||function(){return!1};function Vo(pt){if(!Zs(pt))return!1;var Dt=rc(pt);return Dt==ce||"[object GeneratorFunction]"==Dt||"[object AsyncFunction]"==Dt||"[object Proxy]"==Dt}function Gn(pt){return"number"==typeof pt&&pt>-1&&pt%1==0&&pt<=tt}function Zs(pt){var Dt=typeof pt;return null!=pt&&("object"==Dt||"function"==Dt)}function Ws(pt){return null!=pt&&"object"==typeof pt}var pt,Hc=cn?(pt=cn,function(Dt){return pt(Dt)}):function(pt){return Ws(pt)&&Gn(pt.length)&&!!qn[rc(pt)]};I.exports=function(pt,Dt){return ic(pt,Dt)}}(Bc,Bc.exports);var jc=Qi(Bc.exports);function Ma(I,L){return I.length===L.length&&JSON.stringify(I.map(function(j){return j}).sort())===JSON.stringify(L.map(function(j){return j}).sort())}var ef={Polygon:Wt,LineString:_i,Point:mo,MultiPolygon:Dr,MultiLineString:Dr,MultiPoint:Dr},De=Object.freeze({__proto__:null,CommonSelectors:Ii,constrainFeatureMovement:Yd,createMidPoint:Ss,createSupplementaryPoints:us,createVertex:di,doubleClickZoom:Vi,euclideanDistance:ol,featuresAt:fr,getFeatureAtAndSetCursors:ls,isClick:xa,isEventAtCoordinates:rh,isTap:Ds,mapEventToBoundingBox:va,ModeHandler:qs,moveFeatures:Xl,sortFeatures:tn,stringSetsAreEqual:Ma,StringSet:ti,theme:ae,toDenseArray:Oo});function zo(I){!function(I,L){var lt,ut,j={options:I=function(lt){void 0===lt&&(lt={});var ut=At(lt);return lt.controls||(ut.controls={}),ut.controls=At(!1===lt.displayControlsDefault?tf:Qd,lt.controls),(ut=At(ih,ut)).styles=Kl(ut.styles,"cold").concat(Kl(ut.styles,"hot")),ut}(I)};lt=j,(ut=L).modes=pn,ut.getFeatureIdsAt=function(gt){return fr.click({point:gt},null,lt).map(function(Et){return Et.properties.id})},ut.getSelectedIds=function(){return lt.store.getSelectedIds()},ut.getSelected=function(){return{type:Pe.FEATURE_COLLECTION,features:lt.store.getSelectedIds().map(function(gt){return lt.store.get(gt)}).map(function(gt){return gt.toGeoJSON()})}},ut.getSelectedPoints=function(){return{type:Pe.FEATURE_COLLECTION,features:lt.store.getSelectedCoordinates().map(function(gt){return{type:Pe.FEATURE,properties:{},geometry:{type:Pe.POINT,coordinates:gt.coordinates}}})}},ut.set=function(gt){if(void 0===gt.type||gt.type!==Pe.FEATURE_COLLECTION||!Array.isArray(gt.features))throw new Error("Invalid FeatureCollection");var Et=lt.store.createRenderBatch(),Xt=lt.store.getAllIds().slice(),ce=ut.add(gt),de=new ti(ce);return(Xt=Xt.filter(function(oe){return!de.has(oe)})).length&&ut.delete(Xt),Et(),ce},ut.add=function(gt){var Et=JSON.parse(JSON.stringify(jt(gt))).features.map(function(Xt){if(Xt.id=Xt.id||Ro(),null===Xt.geometry)throw new Error("Invalid geometry: null");if(void 0===lt.store.get(Xt.id)||lt.store.get(Xt.id).type!==Xt.geometry.type){var ce=ef[Xt.geometry.type];if(void 0===ce)throw new Error("Invalid geometry type: "+Xt.geometry.type+".");var de=new ce(lt,Xt);lt.store.add(de)}else{var oe=lt.store.get(Xt.id);oe.properties=Xt.properties,jc(oe.properties,Xt.properties)||lt.store.featureChanged(oe.id),jc(oe.getCoordinates(),Xt.geometry.coordinates)||oe.incomingCoords(Xt.geometry.coordinates)}return Xt.id});return lt.store.render(),Et},ut.get=function(gt){var Et=lt.store.get(gt);if(Et)return Et.toGeoJSON()},ut.getAll=function(){return{type:Pe.FEATURE_COLLECTION,features:lt.store.getAll().map(function(gt){return gt.toGeoJSON()})}},ut.delete=function(gt){return lt.store.delete(gt,{silent:!0}),ut.getMode()!==pn.DIRECT_SELECT||lt.store.getSelectedIds().length?lt.store.render():lt.events.changeMode(pn.SIMPLE_SELECT,void 0,{silent:!0}),ut},ut.deleteAll=function(){return lt.store.delete(lt.store.getAllIds(),{silent:!0}),ut.getMode()===pn.DIRECT_SELECT?lt.events.changeMode(pn.SIMPLE_SELECT,void 0,{silent:!0}):lt.store.render(),ut},ut.changeMode=function(gt,Et){return void 0===Et&&(Et={}),gt===pn.SIMPLE_SELECT&&ut.getMode()===pn.SIMPLE_SELECT?(Ma(Et.featureIds||[],lt.store.getSelectedIds())||(lt.store.setSelected(Et.featureIds,{silent:!0}),lt.store.render()),ut):(gt===pn.DIRECT_SELECT&&ut.getMode()===pn.DIRECT_SELECT&&Et.featureId===lt.store.getSelectedIds()[0]||lt.events.changeMode(gt,Et,{silent:!0}),ut)},ut.getMode=function(){return lt.events.getMode()},ut.trash=function(){return lt.events.trash({silent:!0}),ut},ut.combineFeatures=function(){return lt.events.combineFeatures({silent:!0}),ut},ut.uncombineFeatures=function(){return lt.events.uncombineFeatures({silent:!0}),ut},ut.setFeatureProperty=function(gt,Et,Xt){return lt.store.setFeatureProperty(gt,Et,Xt),ut},j.api=L=ut;var tt=Jt(j);L.onAdd=tt.onAdd,L.onRemove=tt.onRemove,L.types=Zr,L.options=I}(I,this)}return zo.modes=Jd,zo.constants=ya,zo.lib=De,zo}()},816:(Zd,qs,Qi)=>{"use strict";function Ur(i){return"function"==typeof i}function Hl(i){const l=i(h=>{Error.call(h),h.stack=(new Error).stack});return l.prototype=Object.create(Error.prototype),l.prototype.constructor=l,l}const Wd=Hl(i=>function(l){i(this),this.message=l?`${l.length} errors occurred during unsubscription:\n${l.map((h,p)=>`${p+1}) ${h.toString()}`).join("\n  ")}`:"",this.name="UnsubscriptionError",this.errors=l});function se(i,a){if(i){const l=i.indexOf(a);0<=l&&i.splice(l,1)}}class ft{constructor(a){this.initialTeardown=a,this.closed=!1,this._parentage=null,this._finalizers=null}unsubscribe(){let a;if(!this.closed){this.closed=!0;const{_parentage:l}=this;if(l)if(this._parentage=null,Array.isArray(l))for(const _ of l)_.remove(this);else l.remove(this);const{initialTeardown:h}=this;if(Ur(h))try{h()}catch(_){a=_ instanceof Wd?_.errors:[_]}const{_finalizers:p}=this;if(p){this._finalizers=null;for(const _ of p)try{Te(_)}catch(b){a=a??[],b instanceof Wd?a=[...a,...b.errors]:a.push(b)}}if(a)throw new Wd(a)}}add(a){var l;if(a&&a!==this)if(this.closed)Te(a);else{if(a instanceof ft){if(a.closed||a._hasParent(this))return;a._addParent(this)}(this._finalizers=null!==(l=this._finalizers)&&void 0!==l?l:[]).push(a)}}_hasParent(a){const{_parentage:l}=this;return l===a||Array.isArray(l)&&l.includes(a)}_addParent(a){const{_parentage:l}=this;this._parentage=Array.isArray(l)?(l.push(a),l):l?[l,a]:a}_removeParent(a){const{_parentage:l}=this;l===a?this._parentage=null:Array.isArray(l)&&se(l,a)}remove(a){const{_finalizers:l}=this;l&&se(l,a),a instanceof ft&&a._removeParent(this)}}ft.EMPTY=(()=>{const i=new ft;return i.closed=!0,i})();const po=ft.EMPTY;function Po(i){return i instanceof ft||i&&"closed"in i&&Ur(i.remove)&&Ur(i.add)&&Ur(i.unsubscribe)}function Te(i){Ur(i)?i():i.unsubscribe()}const Pr={onUnhandledError:null,onStoppedNotification:null,Promise:void 0,useDeprecatedSynchronousErrorHandling:!1,useDeprecatedNextContext:!1},Hn={setTimeout(i,a,...l){const{delegate:h}=Hn;return h?.setTimeout?h.setTimeout(i,a,...l):setTimeout(i,a,...l)},clearTimeout(i){const{delegate:a}=Hn;return(a?.clearTimeout||clearTimeout)(i)},delegate:void 0};function Zr(i){Hn.setTimeout(()=>{const{onUnhandledError:a}=Pr;if(!a)throw i;a(i)})}function Pe(){}const pn=rr("C",void 0,void 0);function rr(i,a,l){return{kind:i,value:a,error:l}}let dr=null;function ss(i){if(Pr.useDeprecatedSynchronousErrorHandling){const a=!dr;if(a&&(dr={errorThrown:!1,error:null}),i(),a){const{errorThrown:l,error:h}=dr;if(dr=null,l)throw h}}else i()}class ya extends ft{constructor(a){super(),this.isStopped=!1,a?(this.destination=a,Po(a)&&a.add(this)):this.destination=nh}static create(a,l,h){return new va(a,l,h)}next(a){this.isStopped?fr(function il(i){return rr("N",i,void 0)}(a),this):this._next(a)}error(a){this.isStopped?fr(function Bi(i){return rr("E",void 0,i)}(a),this):(this.isStopped=!0,this._error(a))}complete(){this.isStopped?fr(pn,this):(this.isStopped=!0,this._complete())}unsubscribe(){this.closed||(this.isStopped=!0,super.unsubscribe(),this.destination=null)}_next(a){this.destination.next(a)}_error(a){try{this.destination.error(a)}finally{this.unsubscribe()}}_complete(){try{this.destination.complete()}finally{this.unsubscribe()}}}const as=Function.prototype.bind;function it(i,a){return as.call(i,a)}class tn{constructor(a){this.partialObserver=a}next(a){const{partialObserver:l}=this;if(l.next)try{l.next(a)}catch(h){ti(h)}}error(a){const{partialObserver:l}=this;if(l.error)try{l.error(a)}catch(h){ti(h)}else ti(a)}complete(){const{partialObserver:a}=this;if(a.complete)try{a.complete()}catch(l){ti(l)}}}class va extends ya{constructor(a,l,h){let p;if(super(),Ur(a)||!a)p={next:a??void 0,error:l??void 0,complete:h??void 0};else{let _;this&&Pr.useDeprecatedNextContext?(_=Object.create(a),_.unsubscribe=()=>this.unsubscribe(),p={next:a.next&&it(a.next,_),error:a.error&&it(a.error,_),complete:a.complete&&it(a.complete,_)}):p=a}this.destination=new tn(p)}}function ti(i){Pr.useDeprecatedSynchronousErrorHandling?function ql(i){Pr.useDeprecatedSynchronousErrorHandling&&dr&&(dr.errorThrown=!0,dr.error=i)}(i):Zr(i)}function fr(i,a){const{onStoppedNotification:l}=Pr;l&&Hn.setTimeout(()=>l(i,a))}const nh={closed:!0,next:Pe,error:function Oe(i){throw i},complete:Pe},ls="function"==typeof Symbol&&Symbol.observable||"@@observable";function ol(i){return i}let Tr=(()=>{class i{constructor(l){l&&(this._subscribe=l)}lift(l){const h=new i;return h.source=this,h.operator=l,h}subscribe(l,h,p){const _=function Rr(i){return i&&i instanceof ya||function Ro(i){return i&&Ur(i.next)&&Ur(i.error)&&Ur(i.complete)}(i)&&Po(i)}(l)?l:new va(l,h,p);return ss(()=>{const{operator:b,source:T}=this;_.add(b?b.call(_,T):T?this._subscribe(_):this._trySubscribe(_))}),_}_trySubscribe(l){try{return this._subscribe(l)}catch(h){l.error(h)}}forEach(l,h){return new(h=ne(h))((p,_)=>{const b=new va({next:T=>{try{l(T)}catch(S){_(S),b.unsubscribe()}},error:_,complete:p});this.subscribe(b)})}_subscribe(l){var h;return null===(h=this.source)||void 0===h?void 0:h.subscribe(l)}[ls](){return this}pipe(...l){return function Ds(i){return 0===i.length?ol:1===i.length?i[0]:function(l){return i.reduce((h,p)=>p(h),l)}}(l)(this)}toPromise(l){return new(l=ne(l))((h,p)=>{let _;this.subscribe(b=>_=b,b=>p(b),()=>h(_))})}}return i.create=a=>new i(a),i})();function ne(i){var a;return null!==(a=i??Pr.Promise)&&void 0!==a?a:Promise}const mo=Hl(i=>function(){i(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"});let _i=(()=>{class i extends Tr{constructor(){super(),this.closed=!1,this.currentObservers=null,this.observers=[],this.isStopped=!1,this.hasError=!1,this.thrownError=null}lift(l){const h=new Wt(this,this);return h.operator=l,h}_throwIfClosed(){if(this.closed)throw new mo}next(l){ss(()=>{if(this._throwIfClosed(),!this.isStopped){this.currentObservers||(this.currentObservers=Array.from(this.observers));for(const h of this.currentObservers)h.next(l)}})}error(l){ss(()=>{if(this._throwIfClosed(),!this.isStopped){this.hasError=this.isStopped=!0,this.thrownError=l;const{observers:h}=this;for(;h.length;)h.shift().error(l)}})}complete(){ss(()=>{if(this._throwIfClosed(),!this.isStopped){this.isStopped=!0;const{observers:l}=this;for(;l.length;)l.shift().complete()}})}unsubscribe(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null}get observed(){var l;return(null===(l=this.observers)||void 0===l?void 0:l.length)>0}_trySubscribe(l){return this._throwIfClosed(),super._trySubscribe(l)}_subscribe(l){return this._throwIfClosed(),this._checkFinalizedStatuses(l),this._innerSubscribe(l)}_innerSubscribe(l){const{hasError:h,isStopped:p,observers:_}=this;return h||p?po:(this.currentObservers=null,_.push(l),new ft(()=>{this.currentObservers=null,se(_,l)}))}_checkFinalizedStatuses(l){const{hasError:h,thrownError:p,isStopped:_}=this;h?l.error(p):_&&l.complete()}asObservable(){const l=new Tr;return l.source=this,l}}return i.create=(a,l)=>new Wt(a,l),i})();class Wt extends _i{constructor(a,l){super(),this.destination=a,this.source=l}next(a){var l,h;null===(h=null===(l=this.destination)||void 0===l?void 0:l.next)||void 0===h||h.call(l,a)}error(a){var l,h;null===(h=null===(l=this.destination)||void 0===l?void 0:l.error)||void 0===h||h.call(l,a)}complete(){var a,l;null===(l=null===(a=this.destination)||void 0===a?void 0:a.complete)||void 0===l||l.call(a)}_subscribe(a){var l,h;return null!==(h=null===(l=this.source)||void 0===l?void 0:l.subscribe(a))&&void 0!==h?h:po}}function Lo(i){return a=>{if(function to(i){return Ur(i?.lift)}(a))return a.lift(function(l){try{return i(l,this)}catch(h){this.error(h)}});throw new TypeError("Unable to lift unknown Observable type")}}function Dr(i,a,l,h,p){return new _n(i,a,l,h,p)}class _n extends ya{constructor(a,l,h,p,_,b){super(a),this.onFinalize=_,this.shouldUnsubscribe=b,this._next=l?function(T){try{l(T)}catch(S){a.error(S)}}:super._next,this._error=p?function(T){try{p(T)}catch(S){a.error(S)}finally{this.unsubscribe()}}:super._error,this._complete=h?function(){try{h()}catch(T){a.error(T)}finally{this.unsubscribe()}}:super._complete}unsubscribe(){var a;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){const{closed:l}=this;super.unsubscribe(),!l&&(null===(a=this.onFinalize)||void 0===a||a.call(this))}}}function Fn(i){return this instanceof Fn?(this.v=i,this):new Fn(i)}function ji(i){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var l,a=i[Symbol.asyncIterator];return a?a.call(i):(i=function Ee(i){var a="function"==typeof Symbol&&Symbol.iterator,l=a&&i[a],h=0;if(l)return l.call(i);if(i&&"number"==typeof i.length)return{next:function(){return i&&h>=i.length&&(i=void 0),{value:i&&i[h++],done:!i}}};throw new TypeError(a?"Object is not iterable.":"Symbol.iterator is not defined.")}(i),l={},h("next"),h("throw"),h("return"),l[Symbol.asyncIterator]=function(){return this},l);function h(_){l[_]=i[_]&&function(b){return new Promise(function(T,S){!function p(_,b,T,S){Promise.resolve(S).then(function(O){_({value:O,done:T})},b)}(T,S,(b=i[_](b)).done,b.value)})}}}"function"==typeof SuppressedError&&SuppressedError;const zt=i=>i&&"number"==typeof i.length&&"function"!=typeof i;function $t(i){return Ur(i?.then)}function Zt(i){return Ur(i[ls])}function Vt(i){return Symbol.asyncIterator&&Ur(i?.[Symbol.asyncIterator])}function ee(i){return new TypeError(`You provided ${null!==i&&"object"==typeof i?"an invalid object":`'${i}'`} where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.`)}const xe=function Ht(){return"function"==typeof Symbol&&Symbol.iterator?Symbol.iterator:"@@iterator"}();function wn(i){return Ur(i?.[xe])}function ge(i){return function Nn(i,a,l){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var p,h=l.apply(i,a||[]),_=[];return p={},b("next"),b("throw"),b("return"),p[Symbol.asyncIterator]=function(){return this},p;function b(rt){h[rt]&&(p[rt]=function(at){return new Promise(function(bt,Ft){_.push([rt,at,bt,Ft])>1||T(rt,at)})})}function T(rt,at){try{!function S(rt){rt.value instanceof Fn?Promise.resolve(rt.value.v).then(O,F):G(_[0][2],rt)}(h[rt](at))}catch(bt){G(_[0][3],bt)}}function O(rt){T("next",rt)}function F(rt){T("throw",rt)}function G(rt,at){rt(at),_.shift(),_.length&&T(_[0][0],_[0][1])}}(this,arguments,function*(){const l=i.getReader();try{for(;;){const{value:h,done:p}=yield Fn(l.read());if(p)return yield Fn(void 0);yield yield Fn(h)}}finally{l.releaseLock()}})}function mn(i){return Ur(i?.getReader)}function vn(i){if(i instanceof Tr)return i;if(null!=i){if(Zt(i))return function pr(i){return new Tr(a=>{const l=i[ls]();if(Ur(l.subscribe))return l.subscribe(a);throw new TypeError("Provided object does not correctly implement Symbol.observable")})}(i);if(zt(i))return function Mr(i){return new Tr(a=>{for(let l=0;l<i.length&&!a.closed;l++)a.next(i[l]);a.complete()})}(i);if($t(i))return function si(i){return new Tr(a=>{i.then(l=>{a.closed||(a.next(l),a.complete())},l=>a.error(l)).then(null,Zr)})}(i);if(Vt(i))return Wr(i);if(wn(i))return function ko(i){return new Tr(a=>{for(const l of i)if(a.next(l),a.closed)return;a.complete()})}(i);if(mn(i))return function ir(i){return Wr(ge(i))}(i)}throw ee(i)}function Wr(i){return new Tr(a=>{(function Di(i,a){var l,h,p,_;return function ae(i,a,l,h){return new(l||(l=Promise))(function(_,b){function T(F){try{O(h.next(F))}catch(G){b(G)}}function S(F){try{O(h.throw(F))}catch(G){b(G)}}function O(F){F.done?_(F.value):function p(_){return _ instanceof l?_:new l(function(b){b(_)})}(F.value).then(T,S)}O((h=h.apply(i,a||[])).next())})}(this,void 0,void 0,function*(){try{for(l=ji(i);!(h=yield l.next()).done;)if(a.next(h.value),a.closed)return}catch(b){p={error:b}}finally{try{h&&!h.done&&(_=l.return)&&(yield _.call(l))}finally{if(p)throw p.error}}a.complete()})})(i,a).catch(l=>a.error(l))})}function go(i,a,l,h=0,p=!1){const _=a.schedule(function(){l(),p?i.add(this.schedule(null,h)):this.unsubscribe()},h);if(i.add(_),!p)return _}function Ea(i,a,l=1/0){return Ur(a)?Ea((h,p)=>function Fc(i,a){return Lo((l,h)=>{let p=0;l.subscribe(Dr(h,_=>{h.next(i.call(a,_,p++))}))})}((_,b)=>a(h,_,p,b))(vn(i(h,p))),l):("number"==typeof a&&(l=a),Lo((h,p)=>function wa(i,a,l,h,p,_,b,T){const S=[];let O=0,F=0,G=!1;const rt=()=>{G&&!S.length&&!O&&a.complete()},at=Ft=>O<h?bt(Ft):S.push(Ft),bt=Ft=>{_&&a.next(Ft),O++;let Qt=!1;vn(l(Ft,F++)).subscribe(Dr(a,he=>{p?.(he),_?at(he):a.next(he)},()=>{Qt=!0},void 0,()=>{if(Qt)try{for(O--;S.length&&O<h;){const he=S.shift();b?go(a,b,()=>bt(he)):bt(he)}rt()}catch(he){a.error(he)}}))};return i.subscribe(Dr(a,at,()=>{G=!0,rt()})),()=>{T?.()}}(h,p,i,l)))}const Nc=new Tr(i=>i.complete());function Xl(i){return i[i.length-1]}function Yl(i){return function Yd(i){return i&&Ur(i.schedule)}(Xl(i))?i.pop():void 0}function Fo(i,a=0){return Lo((l,h)=>{l.subscribe(Dr(h,p=>go(h,i,()=>h.next(p),a),()=>go(h,i,()=>h.complete(),a),p=>go(h,i,()=>h.error(p),a)))})}function No(i,a=0){return Lo((l,h)=>{h.add(i.schedule(()=>l.subscribe(h),a))})}function ih(i,a){if(!i)throw new Error("Iterable cannot be null");return new Tr(l=>{go(l,a,()=>{const h=i[Symbol.asyncIterator]();go(l,a,()=>{h.next().then(p=>{p.done?l.complete():l.next(p.value)})},0,!0)})})}function Kl(i,a){return a?function tf(i,a){if(null!=i){if(Zt(i))return function rh(i,a){return vn(i).pipe(No(a),Fo(a))}(i,a);if(zt(i))return function Ta(i,a){return new Tr(l=>{let h=0;return a.schedule(function(){h===i.length?l.complete():(l.next(i[h++]),l.closed||this.schedule())})})}(i,a);if($t(i))return function sl(i,a){return vn(i).pipe(No(a),Fo(a))}(i,a);if(Vt(i))return ih(i,a);if(wn(i))return function Jd(i,a){return new Tr(l=>{let h;return go(l,a,()=>{h=i[xe](),go(l,a,()=>{let p,_;try{({value:p,done:_}=h.next())}catch(b){return void l.error(b)}_?l.complete():l.next(p)},0,!0)}),()=>Ur(h?.return)&&h.return()})}(i,a);if(mn(i))return function Qd(i,a){return ih(ge(i),a)}(i,a)}throw ee(i)}(i,a):vn(i)}function Bc(...i){const a=Yl(i),l=function Kd(i,a){return"number"==typeof Xl(i)?i.pop():a}(i,1/0),h=i;return h.length?1===h.length?vn(h[0]):function Xd(i=1/0){return Ea(ol,i)}(l)(Kl(h,a)):Nc}class jc extends _i{constructor(a){super(),this._value=a}get value(){return this.getValue()}_subscribe(a){const l=super._subscribe(a);return!l.closed&&a.next(this._value),l}getValue(){const{hasError:a,thrownError:l,_value:h}=this;if(a)throw l;return this._throwIfClosed(),h}next(a){super.next(this._value=a)}}function ef(i={}){const{connector:a=(()=>new _i),resetOnError:l=!0,resetOnComplete:h=!0,resetOnRefCountZero:p=!0}=i;return _=>{let b,T,S,O=0,F=!1,G=!1;const rt=()=>{T?.unsubscribe(),T=void 0},at=()=>{rt(),b=S=void 0,F=G=!1},bt=()=>{const Ft=b;at(),Ft?.unsubscribe()};return Lo((Ft,Qt)=>{O++,!G&&!F&&rt();const he=S=S??a();Qt.add(()=>{O--,0===O&&!G&&!F&&(T=De(bt,p))}),he.subscribe(Qt),!b&&O>0&&(b=new va({next:Nt=>he.next(Nt),error:Nt=>{G=!0,rt(),T=De(at,l,Nt),he.error(Nt)},complete:()=>{F=!0,rt(),T=De(at,h),he.complete()}}),vn(Ft).subscribe(b))})(_)}}function De(i,a,...l){if(!0===a)return void i();if(!1===a)return;const h=new va({next:()=>{h.unsubscribe(),i()}});return vn(a(...l)).subscribe(h)}function I(i,a){return i===a}function L(i){for(let a in i)if(i[a]===L)return a;throw Error("Could not find renamed property on target object.")}function tt(i){if("string"==typeof i)return i;if(Array.isArray(i))return"["+i.map(tt).join(", ")+"]";if(null==i)return""+i;if(i.overriddenName)return`${i.overriddenName}`;if(i.name)return`${i.name}`;const a=i.toString();if(null==a)return""+a;const l=a.indexOf("\n");return-1===l?a:a.substring(0,l)}function lt(i,a){return null==i||""===i?null===a?"":a:null==a||""===a?i:i+" "+a}const ut=L({__forward_ref__:L});function gt(i){return i.__forward_ref__=gt,i.toString=function(){return tt(this())},i}function Et(i){return function Xt(i){return"function"==typeof i&&i.hasOwnProperty(ut)&&i.__forward_ref__===gt}(i)?i():i}function ce(i){return i&&!!i.\u0275providers}class Bt extends Error{constructor(a,l){super(function Mt(i,a){return`NG0${Math.abs(i)}${a?": "+a:""}`}(a,l)),this.code=a}}function ye(i){return"function"==typeof i?i.name||i.toString():"object"==typeof i&&null!=i&&"function"==typeof i.type?i.type.name||i.type.toString():function Tt(i){return"string"==typeof i?i:null==i?"":String(i)}(i)}function lr(i,a){throw new Bt(-201,!1)}function Zi(i,a){null==i&&function He(i,a,l,h){throw new Error(`ASSERTION ERROR: ${i}`+(null==h?"":` [Expected=> ${l} ${h} ${a} <=Actual]`))}(a,i,null,"!=")}function cr(i){return{token:i.token,providedIn:i.providedIn||null,factory:i.factory,value:void 0}}function Jl(i){return{providers:i.providers||[],imports:i.imports||[]}}function hs(i){return lh(i,Ia)||lh(i,Ui)}function lh(i,a){return i.hasOwnProperty(a)?i[a]:null}function ll(i){return i&&(i.hasOwnProperty(Vc)||i.hasOwnProperty(ke))?i[Vc]:null}const Ia=L({\u0275prov:L}),Vc=L({\u0275inj:L}),Ui=L({ngInjectableDef:L}),ke=L({ngInjectorDef:L});var An=function(i){return i[i.Default=0]="Default",i[i.Host=1]="Host",i[i.Self=2]="Self",i[i.SkipSelf=4]="SkipSelf",i[i.Optional=8]="Optional",i}(An||{});let Ql;function Qn(i){const a=Ql;return Ql=i,a}function ch(i,a,l){const h=hs(i);return h&&"root"==h.providedIn?void 0===h.value?h.value=h.factory():h.value:l&An.Optional?null:void 0!==a?a:void lr(tt(i))}const on=globalThis;class qe{constructor(a,l){this._desc=a,this.ngMetadataName="InjectionToken",this.\u0275prov=void 0,"number"==typeof l?this.__NG_ELEMENT_ID__=l:void 0!==l&&(this.\u0275prov=cr({token:this,providedIn:l.providedIn||"root",factory:l.factory}))}get multi(){return this}toString(){return`InjectionToken ${this._desc}`}}const no={},Xi="__NG_DI_FLAG__",hl="ngTempTokenPath",uh=/\n/gm,rc="__source";let dl;function Bo(i){const a=dl;return dl=i,a}function s_(i,a=An.Default){if(void 0===dl)throw new Bt(-203,!1);return null===dl?ch(i,void 0,a):dl.get(i,a&An.Optional?null:void 0,a)}function Mn(i,a=An.Default){return(function Wi(){return Ql}()||s_)(Et(i),a)}function Wn(i,a=An.Default){return Mn(i,Gi(a))}function Gi(i){return typeof i>"u"||"number"==typeof i?i:0|(i.optional&&8)|(i.host&&1)|(i.self&&2)|(i.skipSelf&&4)}function rf(i){const a=[];for(let l=0;l<i.length;l++){const h=Et(i[l]);if(Array.isArray(h)){if(0===h.length)throw new Bt(900,!1);let p,_=An.Default;for(let b=0;b<h.length;b++){const T=h[b],S=a_(T);"number"==typeof S?-1===S?p=T.token:_|=S:p=T}a.push(Mn(p,_))}else a.push(Mn(h))}return a}function a_(i){return i[Xi]}function fs(i){return{toString:i}.toString()}var Aa=function(i){return i[i.OnPush=0]="OnPush",i[i.Default=1]="Default",i}(Aa||{}),ro=function(i){return i[i.Emulated=0]="Emulated",i[i.None=2]="None",i[i.ShadowDom=3]="ShadowDom",i}(ro||{});const Vo={},Gn=[],Zs=L({\u0275cmp:L}),Ws=L({\u0275dir:L}),Hc=L({\u0275pipe:L}),pt=L({\u0275fac:L}),Dt=L({__NG_ELEMENT_ID__:L}),et=L({__NG_ENV_ID__:L});function Fe(i,a,l){let h=i.length;for(;;){const p=i.indexOf(a,l);if(-1===p)return p;if(0===p||i.charCodeAt(p-1)<=32){const _=a.length;if(p+_===h||i.charCodeAt(p+_)<=32)return p}l=p+1}}function or(i,a,l){let h=0;for(;h<l.length;){const p=l[h];if("number"==typeof p){if(0!==p)break;h++;const _=l[h++],b=l[h++],T=l[h++];i.setAttribute(a,b,T,_)}else{const _=p,b=l[++h];Fr(_)?i.setProperty(a,_,b):i.setAttribute(a,_,b),h++}}return h}function In(i){return 3===i||4===i||6===i}function Fr(i){return 64===i.charCodeAt(0)}function mr(i,a){if(null!==a&&0!==a.length)if(null===i||0===i.length)i=a.slice();else{let l=-1;for(let h=0;h<a.length;h++){const p=a[h];"number"==typeof p?l=p:0===l||ai(i,l,p,null,-1===l||2===l?a[++h]:null)}}return i}function ai(i,a,l,h,p){let _=0,b=i.length;if(-1===a)b=-1;else for(;_<i.length;){const T=i[_++];if("number"==typeof T){if(T===a){b=-1;break}if(T>a){b=_-1;break}}}for(;_<i.length;){const T=i[_];if("number"==typeof T)break;if(T===l){if(null===h)return void(null!==p&&(i[_+1]=p));if(h===i[_+1])return void(i[_+2]=p)}_++,null!==h&&_++,null!==p&&_++}-1!==b&&(i.splice(b,0,a),_=b+1),i.splice(_++,0,l),null!==h&&i.splice(_++,0,h),null!==p&&i.splice(_++,0,p)}const Xr="ng-template";function Sr(i,a,l){let h=0,p=!0;for(;h<i.length;){let _=i[h++];if("string"==typeof _&&p){const b=i[h++];if(l&&"class"===_&&-1!==Fe(b.toLowerCase(),a,0))return!0}else{if(1===_){for(;h<i.length&&"string"==typeof(_=i[h++]);)if(_.toLowerCase()===a)return!0;return!1}"number"==typeof _&&(p=!1)}}return!1}function io(i){return 4===i.type&&i.value!==Xr}function oo(i,a,l){return a===(4!==i.type||l?i.value:Xr)}function Ci(i,a,l){let h=4;const p=i.attrs||[],_=function qc(i){for(let a=0;a<i.length;a++)if(In(i[a]))return a;return i.length}(p);let b=!1;for(let T=0;T<a.length;T++){const S=a[T];if("number"!=typeof S){if(!b)if(4&h){if(h=2|1&h,""!==S&&!oo(i,S,l)||""===S&&1===a.length){if(fi(h))return!1;b=!0}}else{const O=8&h?S:a[++T];if(8&h&&null!==i.attrs){if(!Sr(i.attrs,O,l)){if(fi(h))return!1;b=!0}continue}const G=fl(8&h?"class":S,p,io(i),l);if(-1===G){if(fi(h))return!1;b=!0;continue}if(""!==O){let rt;rt=G>_?"":p[G+1].toLowerCase();const at=8&h?rt:null;if(at&&-1!==Fe(at,O,0)||2&h&&O!==rt){if(fi(h))return!1;b=!0}}}}else{if(!b&&!fi(h)&&!fi(S))return!1;if(b&&fi(S))continue;b=!1,h=S|1&h}}return fi(h)||b}function fi(i){return 0==(1&i)}function fl(i,a,l,h){if(null===a)return-1;let p=0;if(h||!l){let _=!1;for(;p<a.length;){const b=a[p];if(b===i)return p;if(3===b||6===b)_=!0;else{if(1===b||2===b){let T=a[++p];for(;"string"==typeof T;)T=a[++p];continue}if(4===b)break;if(0===b){p+=4;continue}}p+=_?1:2}return-1}return function Vp(i,a){let l=i.indexOf(4);if(l>-1)for(l++;l<i.length;){const h=i[l];if("number"==typeof h)return-1;if(h===a)return l;l++}return-1}(a,i)}function oc(i,a,l=!1){for(let h=0;h<a.length;h++)if(Ci(i,a[h],l))return!0;return!1}function Up(i,a){return i?":not("+a.trim()+")":a}function ur(i){let a=i[0],l=1,h=2,p="",_=!1;for(;l<i.length;){let b=i[l];if("string"==typeof b)if(2&h){const T=i[++l];p+="["+b+(T.length>0?'="'+T+'"':"")+"]"}else 8&h?p+="."+b:4&h&&(p+=" "+b);else""!==p&&!fi(b)&&(a+=Up(_,p),p=""),h=b,_=_||!fi(h);l++}return""!==p&&(a+=Up(_,p)),a}function Ps(i){return fs(()=>{const a=function ph(i){const a={};return{type:i.type,providersResolver:null,factory:null,hostBindings:i.hostBindings||null,hostVars:i.hostVars||0,hostAttrs:i.hostAttrs||null,contentQueries:i.contentQueries||null,declaredInputs:a,inputTransforms:null,inputConfig:i.inputs||Vo,exportAs:i.exportAs||null,standalone:!0===i.standalone,signals:!0===i.signals,selectors:i.selectors||Gn,viewQuery:i.viewQuery||null,features:i.features||null,setInput:null,findHostDirectiveDefs:null,hostDirectives:null,inputs:ml(i.inputs,a),outputs:ml(i.outputs)}}(i),l={...a,decls:i.decls,vars:i.vars,template:i.template,consts:i.consts||null,ngContentSelectors:i.ngContentSelectors,onPush:i.changeDetection===Aa.OnPush,directiveDefs:null,pipeDefs:null,dependencies:a.standalone&&i.dependencies||null,getStandaloneInjector:null,signals:i.signals??!1,data:i.data||{},encapsulation:i.encapsulation||ro.Emulated,styles:i.styles||Gn,_:null,schemas:i.schemas||null,tView:null,id:""};!function gl(i){i.features?.forEach(a=>a(i))}(l);const h=i.dependencies;return l.directiveDefs=Rs(h,!1),l.pipeDefs=Rs(h,!0),l.id=function u_(i){let a=0;const l=[i.selectors,i.ngContentSelectors,i.hostVars,i.hostAttrs,i.consts,i.vars,i.decls,i.encapsulation,i.standalone,i.signals,i.exportAs,JSON.stringify(i.inputs),JSON.stringify(i.outputs),Object.getOwnPropertyNames(i.type.prototype),!!i.contentQueries,!!i.viewQuery].join("|");for(const p of l)a=Math.imul(31,a)+p.charCodeAt(0)<<0;return a+=2147483648,"c"+a}(l),l})}function so(i){return On(i)||Cr(i)}function Uo(i){return null!==i}function Go(i){return fs(()=>({type:i.type,bootstrap:i.bootstrap||Gn,declarations:i.declarations||Gn,imports:i.imports||Gn,exports:i.exports||Gn,transitiveCompileScopes:null,schemas:i.schemas||null,id:i.id||null}))}function ml(i,a){if(null==i)return Vo;const l={};for(const h in i)if(i.hasOwnProperty(h)){let p=i[h],_=p;Array.isArray(p)&&(_=p[1],p=p[0]),l[p]=h,a&&(a[p]=_)}return l}function On(i){return i[Zs]||null}function Cr(i){return i[Ws]||null}function pi(i){return i[Hc]||null}function Rs(i,a){if(!i)return null;const l=a?pi:so;return()=>("function"==typeof i?i():i).map(h=>l(h)).filter(Uo)}const le=0,ve=1,un=2,Gr=3,Ls=4,mh=5,mi=6,Zc=7,gi=8,sc=9,gh=10,ln=11,Wc=12,Gp=13,ac=14,li=15,_h=16,yh=17,$o=18,_l=19,h_=20,Ks=21,Js=22,Ho=23,Xc=24,zn=25,$p=1,Hp=2,Ra=7,xh=9,Yi=11;function qo(i){return Array.isArray(i)&&"object"==typeof i[$p]}function Ki(i){return Array.isArray(i)&&!0===i[$p]}function d_(i){return 0!=(4&i.flags)}function La(i){return i.componentOffset>-1}function Os(i){return!!i.template}function Zp(i){return 0!=(512&i[un])}function uc(i,a){return i.hasOwnProperty(pt)?i[pt]:null}let Ai=null,Yc=!1;function ks(i){const a=Ai;return Ai=i,a}const p_={version:0,dirty:!1,producerNode:void 0,producerLastReadVersion:void 0,producerIndexOfThis:void 0,nextProducerIndex:0,liveConsumerNode:void 0,liveConsumerIndexOfThis:void 0,consumerAllowSignalWrites:!1,consumerIsAlwaysLive:!1,producerMustRecompute:()=>!1,producerRecomputeValue:()=>{},consumerMarkedDirty:()=>{}};function hx(i){if(!hc(i)||i.dirty){if(!i.producerMustRecompute(i)&&!yl(i))return void(i.dirty=!1);i.producerRecomputeValue(i),i.dirty=!1}}function fx(i){i.dirty=!0,function dx(i){if(void 0===i.liveConsumerNode)return;const a=Yc;Yc=!0;try{for(const l of i.liveConsumerNode)l.dirty||fx(l)}finally{Yc=a}}(i),i.consumerMarkedDirty?.(i)}function of(i){return i&&(i.nextProducerIndex=0),ks(i)}function Th(i,a){if(ks(a),i&&void 0!==i.producerNode&&void 0!==i.producerIndexOfThis&&void 0!==i.producerLastReadVersion){if(hc(i))for(let l=i.nextProducerIndex;l<i.producerNode.length;l++)Mh(i.producerNode[l],i.producerIndexOfThis[l]);for(;i.producerNode.length>i.nextProducerIndex;)i.producerNode.pop(),i.producerLastReadVersion.pop(),i.producerIndexOfThis.pop()}}function yl(i){xl(i);for(let a=0;a<i.producerNode.length;a++){const l=i.producerNode[a],h=i.producerLastReadVersion[a];if(h!==l.version||(hx(l),h!==l.version))return!0}return!1}function Yp(i){if(xl(i),hc(i))for(let a=0;a<i.producerNode.length;a++)Mh(i.producerNode[a],i.producerIndexOfThis[a]);i.producerNode.length=i.producerLastReadVersion.length=i.producerIndexOfThis.length=0,i.liveConsumerNode&&(i.liveConsumerNode.length=i.liveConsumerIndexOfThis.length=0)}function Mh(i,a){if(function ps(i){i.liveConsumerNode??=[],i.liveConsumerIndexOfThis??=[]}(i),xl(i),1===i.liveConsumerNode.length)for(let h=0;h<i.producerNode.length;h++)Mh(i.producerNode[h],i.producerIndexOfThis[h]);const l=i.liveConsumerNode.length-1;if(i.liveConsumerNode[a]=i.liveConsumerNode[l],i.liveConsumerIndexOfThis[a]=i.liveConsumerIndexOfThis[l],i.liveConsumerNode.length--,i.liveConsumerIndexOfThis.length--,a<i.liveConsumerNode.length){const h=i.liveConsumerIndexOfThis[a],p=i.liveConsumerNode[a];xl(p),p.producerIndexOfThis[h]=a}}function hc(i){return i.consumerIsAlwaysLive||(i?.liveConsumerNode?.length??0)>0}function xl(i){i.producerNode??=[],i.producerIndexOfThis??=[],i.producerLastReadVersion??=[]}let Kp=null;const v_=()=>{},yx=(()=>({...p_,consumerIsAlwaysLive:!0,consumerAllowSignalWrites:!1,consumerMarkedDirty:i=>{i.schedule(i.ref)},hasRun:!1,cleanupFn:v_}))();class vx{constructor(a,l,h){this.previousValue=a,this.currentValue=l,this.firstChange=h}isFirstChange(){return this.firstChange}}function Jc(i){return i.type.prototype.ngOnChanges&&(i.setInput=bx),xx}function xx(){const i=x_(this),a=i?.current;if(a){const l=i.previous;if(l===Vo)i.previous=a;else for(let h in a)l[h]=a[h];i.current=null,this.ngOnChanges(a)}}function bx(i,a,l,h){const p=this.declaredInputs[l],_=x_(i)||function Ex(i,a){return i[wx]=a}(i,{previous:Vo,current:null}),b=_.current||(_.current={}),T=_.previous,S=T[p];b[p]=new vx(S&&S.currentValue,a,T===Vo),i[h]=a}const wx="__ngSimpleChanges__";function x_(i){return i[wx]||null}const Qs=function(i,a,l){};function zr(i){for(;Array.isArray(i);)i=i[le];return i}function Wo(i,a){return zr(a[i.index])}function ms(i,a){const l=a[i];return qo(l)?l:l[le]}function dc(i,a){return null==a?null:i[a]}function Ix(i){i[yh]=0}function ta(i){1024&i[un]||(i[un]|=1024,Dx(i,1))}function uf(i){1024&i[un]&&(i[un]&=-1025,Dx(i,-1))}function Dx(i,a){let l=i[Gr];if(null===l)return;l[mh]+=a;let h=l;for(l=l[Gr];null!==l&&(1===a&&1===h[mh]||-1===a&&0===h[mh]);)l[mh]+=a,h=l,l=l[Gr]}const We={lFrame:$i(null),bindingsEnabled:!0,skipHydrationRootTNode:null};function Qc(){return We.bindingsEnabled}function qt(){return We.lFrame.lView}function Xn(){return We.lFrame.tView}function Pi(){let i=em();for(;null!==i&&64===i.type;)i=i.parent;return i}function em(){return We.lFrame.currentTNode}function ni(i,a){const l=We.lFrame;l.currentTNode=i,l.isParent=a}function ka(){return We.lFrame.isParent}function Rx(i,a){const l=We.lFrame;l.bindingIndex=l.bindingRootIndex=i,fc(a)}function fc(i){We.lFrame.currentDirectiveIndex=i}function me(i){We.lFrame.currentQueryIndex=i}function ff(i){const a=i[ve];return 2===a.type?a.declTNode:1===a.type?i[mi]:null}function gr(i,a,l){if(l&An.SkipSelf){let p=a,_=i;for(;!(p=p.parent,null!==p||l&An.Host||(p=ff(_),null===p||(_=_[ac],10&p.type))););if(null===p)return!1;a=p,i=_}const h=We.lFrame=S_();return h.currentTNode=a,h.lView=i,!0}function Ch(i){const a=S_(),l=i[ve];We.lFrame=a,a.currentTNode=l.firstChild,a.lView=i,a.tView=l,a.contextLView=i,a.bindingIndex=l.bindingStartIndex,a.inI18n=!1}function S_(){const i=We.lFrame,a=null===i?null:i.child;return null===a?$i(i):a}function $i(i){const a={currentTNode:null,isParent:!0,lView:null,tView:null,selectedIndex:-1,contextLView:null,elementDepthCount:0,currentNamespace:null,currentDirectiveIndex:-1,bindingRootIndex:-1,bindingIndex:-1,currentQueryIndex:0,parent:i,child:null,inI18n:!1};return null!==i&&(i.child=a),a}function pf(){const i=We.lFrame;return We.lFrame=i.parent,i.currentTNode=null,i.lView=null,i}const C_=pf;function xo(){const i=pf();i.isParent=!0,i.tView=null,i.selectedIndex=-1,i.contextLView=null,i.elementDepthCount=0,i.currentDirectiveIndex=-1,i.currentNamespace=null,i.bindingRootIndex=-1,i.bindingIndex=-1,i.currentQueryIndex=0}function $n(i){We.lFrame.selectedIndex=i}let sm=!0;function Fs(){return sm}function bo(i){sm=i}function ru(i,a){for(let l=a.directiveStart,h=a.directiveEnd;l<h;l++){const _=i.data[l].type.prototype,{ngAfterContentInit:b,ngAfterContentChecked:T,ngAfterViewInit:S,ngAfterViewChecked:O,ngOnDestroy:F}=_;b&&(i.contentHooks??=[]).push(-l,b),T&&((i.contentHooks??=[]).push(l,T),(i.contentCheckHooks??=[]).push(l,T)),S&&(i.viewHooks??=[]).push(-l,S),O&&((i.viewHooks??=[]).push(l,O),(i.viewCheckHooks??=[]).push(l,O)),null!=F&&(i.destroyHooks??=[]).push(l,F)}}function Ah(i,a,l){Tl(i,a,3,l)}function Ph(i,a,l,h){(3&i[un])===l&&Tl(i,a,l,h)}function mf(i,a){let l=i[un];(3&l)===a&&(l&=8191,l+=1,i[un]=l)}function Tl(i,a,l,h){const _=h??-1,b=a.length-1;let T=0;for(let S=void 0!==h?65535&i[yh]:0;S<b;S++)if("number"==typeof a[S+1]){if(T=a[S],null!=h&&T>=h)break}else a[S]<0&&(i[yh]+=65536),(T<_||-1==_)&&(cm(i,l,a,S),i[yh]=(4294901760&i[yh])+S+2),S++}function lm(i,a){Qs(4,i,a);const l=ks(null);try{a.call(i)}finally{ks(l),Qs(5,i,a)}}function cm(i,a,l,h){const p=l[h]<0,_=l[h+1],T=i[p?-l[h]:l[h]];p?i[un]>>13<i[yh]>>16&&(3&i[un])===a&&(i[un]+=8192,lm(T,_)):lm(T,_)}const pc=-1;class iu{constructor(a,l,h){this.factory=a,this.resolving=!1,this.canSeeViewProviders=l,this.injectImpl=h}}function Il(i){return 32767&i}function mc(i,a){let l=function P_(i){return i>>16}(i),h=a;for(;l>0;)h=h[ac],l--;return h}let _f=!0;function yf(i){const a=_f;return _f=i,a}const R_=255,L_=5;let Nx=0;const na={};function vf(i,a){const l=O_(i,a);if(-1!==l)return l;const h=a[ve];h.firstCreatePass&&(i.injectorIndex=a.length,dm(h.data,i),dm(a,null),dm(h.blueprint,null));const p=xf(i,a),_=i.injectorIndex;if(function Ml(i){return i!==pc}(p)){const b=Il(p),T=mc(p,a),S=T[ve].data;for(let O=0;O<8;O++)a[_+O]=T[b+O]|S[b+O]}return a[_+8]=p,_}function dm(i,a){i.push(0,0,0,0,0,0,0,0,a)}function O_(i,a){return-1===i.injectorIndex||i.parent&&i.parent.injectorIndex===i.injectorIndex||null===a[i.injectorIndex+8]?-1:i.injectorIndex}function xf(i,a){if(i.parent&&-1!==i.parent.injectorIndex)return i.parent.injectorIndex;let l=0,h=null,p=a;for(;null!==p;){if(h=Rt(p),null===h)return pc;if(l++,p=p[ac],-1!==h.injectorIndex)return h.injectorIndex|l<<16}return pc}function k_(i,a,l){!function zx(i,a,l){let h;"string"==typeof l?h=l.charCodeAt(0)||0:l.hasOwnProperty(Dt)&&(h=l[Dt]),null==h&&(h=l[Dt]=Nx++);const p=h&R_;a.data[i+(p>>L_)]|=1<<p}(i,a,l)}function Rn(i,a,l){if(l&An.Optional||void 0!==i)return i;lr()}function F_(i,a,l,h){if(l&An.Optional&&void 0===h&&(h=null),!(l&(An.Self|An.Host))){const p=i[sc],_=Qn(void 0);try{return p?p.get(a,h,l&An.Optional):ch(a,h,l&An.Optional)}finally{Qn(_)}}return Rn(h,0,l)}function Bx(i,a,l,h=An.Default,p){if(null!==i){if(2048&a[un]&&!(h&An.Self)){const b=function Ze(i,a,l,h,p){let _=i,b=a;for(;null!==_&&null!==b&&2048&b[un]&&!(512&b[un]);){const T=jx(_,b,l,h|An.Self,na);if(T!==na)return T;let S=_.parent;if(!S){const O=b[h_];if(O){const F=O.get(l,na,h);if(F!==na)return F}S=Rt(b),b=b[ac]}_=S}return p}(i,a,l,h,na);if(b!==na)return b}const _=jx(i,a,l,h,na);if(_!==na)return _}return F_(a,l,h,p)}function jx(i,a,l,h,p){const _=function Vx(i){if("string"==typeof i)return i.charCodeAt(0)||0;const a=i.hasOwnProperty(Dt)?i[Dt]:void 0;return"number"==typeof a?a>=0?a&R_:z_:a}(l);if("function"==typeof _){if(!gr(a,i,h))return h&An.Host?Rn(p,0,h):F_(a,l,h,p);try{let b;if(b=_(h),null!=b||h&An.Optional)return b;lr()}finally{C_()}}else if("number"==typeof _){let b=null,T=O_(i,a),S=pc,O=h&An.Host?a[li][mi]:null;for((-1===T||h&An.SkipSelf)&&(S=-1===T?xf(i,a):a[T+8],S!==pc&&Ux(h,!1)?(b=a[ve],T=Il(S),a=mc(S,a)):T=-1);-1!==T;){const F=a[ve];if(N_(_,T,F.data)){const G=fm(T,a,l,b,h,O);if(G!==na)return G}S=a[T+8],S!==pc&&Ux(h,a[ve].data[T+8]===O)&&N_(_,T,a)?(b=F,T=Il(S),a=mc(S,a)):T=-1}}return p}function fm(i,a,l,h,p,_){const b=a[ve],T=b.data[i+8],F=function bf(i,a,l,h,p){const _=i.providerIndexes,b=a.data,T=1048575&_,S=i.directiveStart,F=_>>20,rt=p?T+F:i.directiveEnd;for(let at=h?T:T+F;at<rt;at++){const bt=b[at];if(at<S&&l===bt||at>=S&&bt.type===l)return at}if(p){const at=b[S];if(at&&Os(at)&&at.type===l)return S}return null}(T,b,l,null==h?La(T)&&_f:h!=b&&0!=(3&T.type),p&An.Host&&_===T);return null!==F?su(a,b,F,T):na}function su(i,a,l,h){let p=i[l];const _=a.data;if(function Kr(i){return i instanceof iu}(p)){const b=p;b.resolving&&function H(i,a){const l=a?`. Dependency path: ${a.join(" > ")} > ${i}`:"";throw new Bt(-200,`Circular dependency in DI detected for ${i}${l}`)}(ye(_[l]));const T=yf(b.canSeeViewProviders);b.resolving=!0;const O=b.injectImpl?Qn(b.injectImpl):null;gr(i,h,An.Default);try{p=i[l]=b.factory(void 0,_,i,h),a.firstCreatePass&&l>=h.directiveStart&&function am(i,a,l){const{ngOnChanges:h,ngOnInit:p,ngDoCheck:_}=a.type.prototype;if(h){const b=Jc(a);(l.preOrderHooks??=[]).push(i,b),(l.preOrderCheckHooks??=[]).push(i,b)}p&&(l.preOrderHooks??=[]).push(0-i,p),_&&((l.preOrderHooks??=[]).push(i,_),(l.preOrderCheckHooks??=[]).push(i,_))}(l,_[l],a)}finally{null!==O&&Qn(O),yf(T),b.resolving=!1,C_()}}return p}function N_(i,a,l){return!!(l[a+(i>>L_)]&1<<i)}function Ux(i,a){return!(i&An.Self||i&An.Host&&a)}class lo{constructor(a,l){this._tNode=a,this._lView=l}get(a,l,h){return Bx(this._tNode,this._lView,a,Gi(h),l)}}function z_(){return new lo(Pi(),qt())}function Rt(i){const a=i[ve],l=a.type;return 2===l?a.declTNode:1===l?i[mi]:null}function Oi(i,a){i.forEach(l=>Array.isArray(l)?Oi(l,a):a(l))}function Jr(i,a){return a>=i.length-1?i.pop():i.splice(a,1)[0]}var oa=function(i){return i[i.Important=1]="Important",i[i.DashCase=2]="DashCase",i}(oa||{});const xm=new Map;let bm=0;const wm="__ngContext__";function ho(i,a){qo(a)?(i[wm]=a[_l],function f1(i){xm.set(i[_l],i)}(a)):i[wm]=a}let Af;function Mm(i,a){return Af(i,a)}function Fh(i){const a=i[Gr];return Ki(a)?a[Gr]:a}function Pf(i){return Im(i[Wc])}function Ue(i){return Im(i[Ls])}function Im(i){for(;null!==i&&!Ki(i);)i=i[Ls];return i}function zs(i,a,l,h,p){if(null!=h){let _,b=!1;Ki(h)?_=h:qo(h)&&(b=!0,h=h[le]);const T=zr(h);0===i&&null!==l?null==p?st(a,l,T):du(a,l,T,p||null,!0):1===i&&null!==l?du(a,l,T,p||null,!0):2===i?function Pm(i,a,l){const h=function Cm(i,a){return i.parentNode(a)}(i,a);h&&function ki(i,a,l,h){i.removeChild(a,l,h)}(i,h,a,l)}(a,T,b):3===i&&a.destroyNode(T),null!=_&&function Rm(i,a,l,h,p){const _=l[Ra];_!==zr(l)&&zs(a,i,h,_,p);for(let T=Yi;T<l.length;T++){const S=l[T];nn(S[ve],S,i,a,h,_)}}(a,i,_,l,p)}}function Lf(i,a,l){return i.createElement(a,l)}function Sm(i,a){const l=i[xh],h=l.indexOf(a);uf(a),l.splice(h,1)}function Q_(i,a){if(!(256&a[un])){a[un]&=-129,a[un]|=256,function wM(i,a){let l;if(null!=i&&null!=(l=i.destroyHooks))for(let h=0;h<l.length;h+=2){const p=a[l[h]];if(!(p instanceof iu)){const _=l[h+1];if(Array.isArray(_))for(let b=0;b<_.length;b+=2){const T=p[_[b]],S=_[b+1];Qs(4,T,S);try{S.call(T)}finally{Qs(5,T,S)}}else{Qs(4,p,_);try{_.call(p)}finally{Qs(5,p,_)}}}}}(i,a),function Nh(i,a){const l=i.cleanup,h=a[Zc];if(null!==l)for(let _=0;_<l.length-1;_+=2)if("string"==typeof l[_]){const b=l[_+3];b>=0?h[b]():h[-b].unsubscribe(),_+=2}else l[_].call(h[l[_+1]]);null!==h&&(a[Zc]=null);const p=a[Ks];if(null!==p){a[Ks]=null;for(let _=0;_<p.length;_++)(0,p[_])()}}(i,a),1===a[ve].type&&a[ln].destroy();const l=a[_h];if(null!==l&&Ki(a[Gr])){l!==a[Gr]&&Sm(l,a);const h=a[$o];null!==h&&h.detachView(i)}!function p1(i){xm.delete(i[_l])}(a)}}function ty(i,a,l){return function fo(i,a,l){let h=a;for(;null!==h&&40&h.type;)h=(a=h).parent;if(null===h)return l[le];{const{componentOffset:p}=h;if(p>-1){const{encapsulation:_}=i.data[h.directiveStart+p];if(_===ro.None||_===ro.Emulated)return null}return Wo(h,l)}}(i,a.parent,l)}function du(i,a,l,h,p){i.insertBefore(a,l,h,p)}function st(i,a,l){i.appendChild(a,l)}function S1(i,a,l,h,p){null!==h?du(i,a,l,h,p):st(i,a,l)}let Bs,vc,ey=function C1(i,a,l){return 40&i.type?Wo(i,l):null};function fu(i,a,l,h){const p=ty(i,h,a),_=a[ln],T=function Z(i,a,l){return ey(i,a,l)}(h.parent||a[mi],h,a);if(null!=p)if(Array.isArray(l))for(let S=0;S<l.length;S++)S1(_,p,l[S],T,!1);else S1(_,p,l,T,!1);void 0!==Bs&&Bs(_,h,a,l,p)}function Cl(i,a){return null!==a?i[li][mi].projection[a.projection]:null}function Of(i,a,l,h,p,_,b){for(;null!=l;){const T=h[l.index],S=l.type;if(b&&0===a&&(T&&ho(zr(T),h),l.flags|=2),32!=(32&l.flags))if(8&S)Of(i,a,l.child,h,p,_,!1),zs(a,i,p,T,_);else if(32&S){const O=Mm(l,h);let F;for(;F=O();)zs(a,i,p,F,_);zs(a,i,p,T,_)}else 16&S?ny(i,a,h,l,p,_):zs(a,i,p,T,_);l=b?l.projectionNext:l.next}}function nn(i,a,l,h,p,_){Of(l,h,i.firstChild,a,p,_,!1)}function ny(i,a,l,h,p,_){const b=l[li],S=b[mi].projection[h.projection];if(Array.isArray(S))for(let O=0;O<S.length;O++)zs(a,i,p,S[O],_);else{let O=S;const F=b[Gr];(function co(i){return 128==(128&i.flags)})(h)&&(O.flags|=128),Of(i,a,O,F,p,_,!0)}}function iy(i,a,l){""===l?i.removeAttribute(a,"class"):i.setAttribute(a,"class",l)}function oy(i,a,l){const{mergedAttrs:h,classes:p,styles:_}=l;null!==h&&or(i,a,h),null!==p&&iy(i,a,p),null!==_&&function Ff(i,a,l){i.setAttribute(a,"style",l)}(i,a,_)}const Gf=new qe("ENVIRONMENT_INITIALIZER"),V1=new qe("INJECTOR",-1),ca=new qe("INJECTOR_DEF_TYPES");class Ua{get(a,l=no){if(l===no){const h=new Error(`NullInjectorError: No provider for ${tt(a)}!`);throw h.name="NullInjectorError",h}return l}}function Nm(...i){return{\u0275providers:zm(0,i),\u0275fromNgModule:!0}}function zm(i,...a){const l=[],h=new Set;let p;const _=b=>{l.push(b)};return Oi(a,b=>{const T=b;Bm(T,_,[],h)&&(p||=[],p.push(T))}),void 0!==p&&xy(p,_),l}function xy(i,a){for(let l=0;l<i.length;l++){const{ngModule:h,providers:p}=i[l];by(p,_=>{a(_,h)})}}function Bm(i,a,l,h){if(!(i=Et(i)))return!1;let p=null,_=ll(i);const b=!_&&On(i);if(_||b){if(b&&!b.standalone)return!1;p=i}else{const S=i.ngModule;if(_=ll(S),!_)return!1;p=S}const T=h.has(p);if(b){if(T)return!1;if(h.add(p),b.dependencies){const S="function"==typeof b.dependencies?b.dependencies():b.dependencies;for(const O of S)Bm(O,a,l,h)}}else{if(!_)return!1;{if(null!=_.imports&&!T){let O;h.add(p);try{Oi(_.imports,F=>{Bm(F,a,l,h)&&(O||=[],O.push(F))})}finally{}void 0!==O&&xy(O,a)}if(!T){const O=uc(p)||(()=>new p);a({provide:p,useFactory:O,deps:Gn},p),a({provide:ca,useValue:p,multi:!0},p),a({provide:Gf,useValue:()=>Mn(p),multi:!0},p)}const S=_.providers;if(null!=S&&!T){const O=i;by(S,F=>{a(F,O)})}}}return p!==i&&void 0!==i.providers}function by(i,a){for(let l of i)ce(l)&&(l=l.\u0275providers),Array.isArray(l)?by(l,a):a(l)}const wy=L({provide:String,useValue:L});function Ey(i){return null!==i&&"object"==typeof i&&wy in i}function bc(i){return"function"==typeof i}const Vm=new qe("Set Injector scope."),Um={},Vh={};let Hf;function Rl(){return void 0===Hf&&(Hf=new Ua),Hf}class js{}class _u extends js{get destroyed(){return this._destroyed}constructor(a,l,h,p){super(),this.parent=l,this.source=h,this.scopes=p,this.records=new Map,this._ngOnDestroyHooks=new Set,this._onDestroyHooks=[],this._destroyed=!1,$m(a,b=>this.processProvider(b)),this.records.set(V1,Uh(void 0,this)),p.has("environment")&&this.records.set(js,Uh(void 0,this));const _=this.records.get(Vm);null!=_&&"string"==typeof _.value&&this.scopes.add(_.value),this.injectorDefTypes=new Set(this.get(ca.multi,Gn,An.Self))}destroy(){this.assertNotDestroyed(),this._destroyed=!0;try{for(const l of this._ngOnDestroyHooks)l.ngOnDestroy();const a=this._onDestroyHooks;this._onDestroyHooks=[];for(const l of a)l()}finally{this.records.clear(),this._ngOnDestroyHooks.clear(),this.injectorDefTypes.clear()}}onDestroy(a){return this.assertNotDestroyed(),this._onDestroyHooks.push(a),()=>this.removeOnDestroy(a)}runInContext(a){this.assertNotDestroyed();const l=Bo(this),h=Qn(void 0);try{return a()}finally{Bo(l),Qn(h)}}get(a,l=no,h=An.Default){if(this.assertNotDestroyed(),a.hasOwnProperty(et))return a[et](this);h=Gi(h);const _=Bo(this),b=Qn(void 0);try{if(!(h&An.SkipSelf)){let S=this.records.get(a);if(void 0===S){const O=function LM(i){return"function"==typeof i||"object"==typeof i&&i instanceof qe}(a)&&hs(a);S=O&&this.injectableDefInScope(O)?Uh(Gm(a),Um):null,this.records.set(a,S)}if(null!=S)return this.hydrate(a,S)}return(h&An.Self?Rl():this.parent).get(a,l=h&An.Optional&&l===no?null:l)}catch(T){if("NullInjectorError"===T.name){if((T[hl]=T[hl]||[]).unshift(tt(a)),_)throw T;return function Ca(i,a,l,h){const p=i[hl];throw a[rc]&&p.unshift(a[rc]),i.message=function jp(i,a,l,h=null){i=i&&"\n"===i.charAt(0)&&"\u0275"==i.charAt(1)?i.slice(2):i;let p=tt(a);if(Array.isArray(a))p=a.map(tt).join(" -> ");else if("object"==typeof a){let _=[];for(let b in a)if(a.hasOwnProperty(b)){let T=a[b];_.push(b+":"+("string"==typeof T?JSON.stringify(T):tt(T)))}p=`{${_.join(", ")}}`}return`${l}${h?"("+h+")":""}[${p}]: ${i.replace(uh,"\n  ")}`}("\n"+i.message,p,l,h),i.ngTokenPath=p,i[hl]=null,i}(T,a,"R3InjectorError",this.source)}throw T}finally{Qn(b),Bo(_)}}resolveInjectorInitializers(){const a=Bo(this),l=Qn(void 0);try{const p=this.get(Gf.multi,Gn,An.Self);for(const _ of p)_()}finally{Bo(a),Qn(l)}}toString(){const a=[],l=this.records;for(const h of l.keys())a.push(tt(h));return`R3Injector[${a.join(", ")}]`}assertNotDestroyed(){if(this._destroyed)throw new Bt(205,!1)}processProvider(a){let l=bc(a=Et(a))?a:Et(a&&a.provide);const h=function RM(i){return Ey(i)?Uh(void 0,i.useValue):Uh(function U1(i,a,l){let h;if(bc(i)){const p=Et(i);return uc(p)||Gm(p)}if(Ey(i))h=()=>Et(i.useValue);else if(function Ty(i){return!(!i||!i.useFactory)}(i))h=()=>i.useFactory(...rf(i.deps||[]));else if(function jm(i){return!(!i||!i.useExisting)}(i))h=()=>Mn(Et(i.useExisting));else{const p=Et(i&&(i.useClass||i.provide));if(!function G1(i){return!!i.deps}(i))return uc(p)||Gm(p);h=()=>new p(...rf(i.deps))}return h}(i),Um)}(a);if(bc(a)||!0!==a.multi)this.records.get(l);else{let p=this.records.get(l);p||(p=Uh(void 0,Um,!0),p.factory=()=>rf(p.multi),this.records.set(l,p)),l=a,p.multi.push(a)}this.records.set(l,h)}hydrate(a,l){return l.value===Um&&(l.value=Vh,l.value=l.factory()),"object"==typeof l.value&&l.value&&function $1(i){return null!==i&&"object"==typeof i&&"function"==typeof i.ngOnDestroy}(l.value)&&this._ngOnDestroyHooks.add(l.value),l.value}injectableDefInScope(a){if(!a.providedIn)return!1;const l=Et(a.providedIn);return"string"==typeof l?"any"===l||this.scopes.has(l):this.injectorDefTypes.has(l)}removeOnDestroy(a){const l=this._onDestroyHooks.indexOf(a);-1!==l&&this._onDestroyHooks.splice(l,1)}}function Gm(i){const a=hs(i),l=null!==a?a.factory:uc(i);if(null!==l)return l;if(i instanceof qe)throw new Bt(204,!1);if(i instanceof Function)return function PM(i){const a=i.length;if(a>0)throw function Lh(i,a){const l=[];for(let h=0;h<i;h++)l.push(a);return l}(a,"?"),new Bt(204,!1);const l=function vo(i){return i&&(i[Ia]||i[Ui])||null}(i);return null!==l?()=>l.factory(i):()=>new i}(i);throw new Bt(204,!1)}function Uh(i,a,l=!1){return{factory:i,value:a,multi:l?[]:void 0}}function $m(i,a){for(const l of i)Array.isArray(l)?$m(l,a):l&&ce(l)?$m(l.\u0275providers,a):a(l)}const My=new qe("AppId",{providedIn:"root",factory:()=>OM}),OM="ng",Iy=new qe("Platform Initializer"),yu=new qe("Platform ID",{providedIn:"platform",factory:()=>"unknown"}),Ga=new qe("CSP nonce",{providedIn:"root",factory:()=>function Ji(){if(void 0!==vc)return vc;if(typeof document<"u")return document;throw new Bt(210,!1)}().body?.querySelector("[ngCspNonce]")?.getAttribute("ngCspNonce")||null});let q1=(i,a,l)=>null;function Tc(i,a,l=!1){return q1(i,a,l)}class Oy{}class Xf{}class Fy{resolveComponentFactory(a){throw function ky(i){const a=Error(`No component factory found for ${tt(i)}.`);return a.ngComponent=i,a}(a)}}let Eu=(()=>{class i{static#t=this.NULL=new Fy}return i})();function jM(){return Hh(Pi(),qt())}function Hh(i,a){return new qh(Wo(i,a))}let qh=(()=>{class i{constructor(l){this.nativeElement=l}static#t=this.__NG_ELEMENT_ID__=jM}return i})();class K1{}let GM=(()=>{class i{static#t=this.\u0275prov=cr({token:i,providedIn:"root",factory:()=>null})}return i})();class Zh{constructor(a){this.full=a,this.major=a.split(".")[0],this.minor=a.split(".")[1],this.patch=a.split(".").slice(2).join(".")}}const $M=new Zh("16.2.12"),Ym={};function Kf(i,a=null,l=null,h){const p=function Vy(i,a=null,l=null,h,p=new Set){const _=[l||Gn,Nm(i)];return h=h||("object"==typeof i?void 0:tt(i)),new _u(_,a||Rl(),h||null,p)}(i,a,l,h);return p.resolveInjectorInitializers(),p}let $a=(()=>{class i{static#t=this.THROW_IF_NOT_FOUND=no;static#e=this.NULL=new Ua;static create(l,h){if(Array.isArray(l))return Kf({name:""},h,l,"");{const p=l.name??"";return Kf({name:p},l.parent,l.providers,p)}}static#n=this.\u0275prov=cr({token:i,providedIn:"any",factory:()=>Mn(V1)});static#r=this.__NG_ELEMENT_ID__=-1}return i})();function tr(i){return i.ngOriginalError}class ua{constructor(){this._console=console}handleError(a){const l=this._findOriginalError(a);this._console.error("ERROR",a),l&&this._console.error("ORIGINAL ERROR",l)}_findOriginalError(a){let l=a&&tr(a);for(;l&&tr(l);)l=tr(l);return l||null}}function Jm(i){return a=>{setTimeout(i,void 0,a)}}const Ll=class Wh extends _i{constructor(a=!1){super(),this.__isAsync=a}emit(a){super.next(a)}subscribe(a,l,h){let p=a,_=l||(()=>null),b=h;if(a&&"object"==typeof a){const S=a;p=S.next?.bind(S),_=S.error?.bind(S),b=S.complete?.bind(S)}this.__isAsync&&(_=Jm(_),p&&(p=Jm(p)),b&&(b=Jm(b)));const T=super.subscribe({next:p,error:_,complete:b});return a instanceof ft&&a.add(T),T}};function rb(...i){}class hi{constructor({enableLongStackTrace:a=!1,shouldCoalesceEventChangeDetection:l=!1,shouldCoalesceRunChangeDetection:h=!1}){if(this.hasPendingMacrotasks=!1,this.hasPendingMicrotasks=!1,this.isStable=!0,this.onUnstable=new Ll(!1),this.onMicrotaskEmpty=new Ll(!1),this.onStable=new Ll(!1),this.onError=new Ll(!1),typeof Zone>"u")throw new Bt(908,!1);Zone.assertZonePatched();const p=this;p._nesting=0,p._outer=p._inner=Zone.current,Zone.TaskTrackingZoneSpec&&(p._inner=p._inner.fork(new Zone.TaskTrackingZoneSpec)),a&&Zone.longStackTraceZoneSpec&&(p._inner=p._inner.fork(Zone.longStackTraceZoneSpec)),p.shouldCoalesceEventChangeDetection=!h&&l,p.shouldCoalesceRunChangeDetection=h,p.lastRequestAnimationFrameId=-1,p.nativeRequestAnimationFrame=function WM(){const i="function"==typeof on.requestAnimationFrame;let a=on[i?"requestAnimationFrame":"setTimeout"],l=on[i?"cancelAnimationFrame":"clearTimeout"];if(typeof Zone<"u"&&a&&l){const h=a[Zone.__symbol__("OriginalDelegate")];h&&(a=h);const p=l[Zone.__symbol__("OriginalDelegate")];p&&(l=p)}return{nativeRequestAnimationFrame:a,nativeCancelAnimationFrame:l}}().nativeRequestAnimationFrame,function KM(i){const a=()=>{!function YM(i){i.isCheckStableRunning||-1!==i.lastRequestAnimationFrameId||(i.lastRequestAnimationFrameId=i.nativeRequestAnimationFrame.call(on,()=>{i.fakeTopEventTask||(i.fakeTopEventTask=Zone.root.scheduleEventTask("fakeTopEventTask",()=>{i.lastRequestAnimationFrameId=-1,Xh(i),i.isCheckStableRunning=!0,$y(i),i.isCheckStableRunning=!1},void 0,()=>{},()=>{})),i.fakeTopEventTask.invoke()}),Xh(i))}(i)};i._inner=i._inner.fork({name:"angular",properties:{isAngularZone:!0},onInvokeTask:(l,h,p,_,b,T)=>{if(function JM(i){return!(!Array.isArray(i)||1!==i.length)&&!0===i[0].data?.__ignore_ng_zone__}(T))return l.invokeTask(p,_,b,T);try{return Tu(i),l.invokeTask(p,_,b,T)}finally{(i.shouldCoalesceEventChangeDetection&&"eventTask"===_.type||i.shouldCoalesceRunChangeDetection)&&a(),Hy(i)}},onInvoke:(l,h,p,_,b,T,S)=>{try{return Tu(i),l.invoke(p,_,b,T,S)}finally{i.shouldCoalesceRunChangeDetection&&a(),Hy(i)}},onHasTask:(l,h,p,_)=>{l.hasTask(p,_),h===p&&("microTask"==_.change?(i._hasPendingMicrotasks=_.microTask,Xh(i),$y(i)):"macroTask"==_.change&&(i.hasPendingMacrotasks=_.macroTask))},onHandleError:(l,h,p,_)=>(l.handleError(p,_),i.runOutsideAngular(()=>i.onError.emit(_)),!1)})}(p)}static isInAngularZone(){return typeof Zone<"u"&&!0===Zone.current.get("isAngularZone")}static assertInAngularZone(){if(!hi.isInAngularZone())throw new Bt(909,!1)}static assertNotInAngularZone(){if(hi.isInAngularZone())throw new Bt(909,!1)}run(a,l,h){return this._inner.run(a,l,h)}runTask(a,l,h,p){const _=this._inner,b=_.scheduleEventTask("NgZoneEvent: "+p,a,XM,rb,rb);try{return _.runTask(b,l,h)}finally{_.cancelTask(b)}}runGuarded(a,l,h){return this._inner.runGuarded(a,l,h)}runOutsideAngular(a){return this._outer.run(a)}}const XM={};function $y(i){if(0==i._nesting&&!i.hasPendingMicrotasks&&!i.isStable)try{i._nesting++,i.onMicrotaskEmpty.emit(null)}finally{if(i._nesting--,!i.hasPendingMicrotasks)try{i.runOutsideAngular(()=>i.onStable.emit(null))}finally{i.isStable=!0}}}function Xh(i){i.hasPendingMicrotasks=!!(i._hasPendingMicrotasks||(i.shouldCoalesceEventChangeDetection||i.shouldCoalesceRunChangeDetection)&&-1!==i.lastRequestAnimationFrameId)}function Tu(i){i._nesting++,i.isStable&&(i.isStable=!1,i.onUnstable.emit(null))}function Hy(i){i._nesting--,$y(i)}const ib=new qe("",{providedIn:"root",factory:qy});function qy(){const i=Wn(hi);let a=!0;return Bc(new Tr(p=>{a=i.isStable&&!i.hasPendingMacrotasks&&!i.hasPendingMicrotasks,i.runOutsideAngular(()=>{p.next(a),p.complete()})}),new Tr(p=>{let _;i.runOutsideAngular(()=>{_=i.onStable.subscribe(()=>{hi.assertNotInAngularZone(),queueMicrotask(()=>{!a&&!i.hasPendingMacrotasks&&!i.hasPendingMicrotasks&&(a=!0,p.next(!0))})})});const b=i.onUnstable.subscribe(()=>{hi.assertInAngularZone(),a&&(a=!1,i.runOutsideAngular(()=>{p.next(!1)}))});return()=>{_.unsubscribe(),b.unsubscribe()}}).pipe(ef()))}let Wy=(()=>{class i{constructor(){this.renderDepth=0,this.handler=null}begin(){this.handler?.validateBegin(),this.renderDepth++}end(){this.renderDepth--,0===this.renderDepth&&this.handler?.execute()}ngOnDestroy(){this.handler?.destroy(),this.handler=null}static#t=this.\u0275prov=cr({token:i,providedIn:"root",factory:()=>new i})}return i})();function Dc(i){for(;i;){i[un]|=64;const a=Fh(i);if(Zp(i)&&!a)return i;i=a}return null}const eg=new qe("",{providedIn:"root",factory:()=>!1});let Qo=null;function ng(i,a){return i[a]??pb()}function Yh(i,a){const l=pb();l.producerNode?.length&&(i[a]=Qo,l.lView=i,Qo=fb())}const qa={...p_,consumerIsAlwaysLive:!0,consumerMarkedDirty:i=>{Dc(i.lView)},lView:null};function fb(){return Object.create(qa)}function pb(){return Qo??=fb(),Qo}const sn={};function Dn(i,a=An.Default){const l=qt();return null===l?Mn(i,a):Bx(Pi(),l,Et(i),a)}function rg(i,a,l,h,p,_,b,T,S,O,F){const G=a.blueprint.slice();return G[le]=p,G[un]=140|h,(null!==O||i&&2048&i[un])&&(G[un]|=2048),Ix(G),G[Gr]=G[ac]=i,G[gi]=l,G[gh]=b||i&&i[gh],G[ln]=T||i&&i[ln],G[sc]=S||i&&i[sc]||null,G[mi]=_,G[_l]=function d1(){return bm++}(),G[Js]=F,G[h_]=O,G[li]=2==a.type?i[li]:G,G}function Su(i,a,l,h,p){let _=i.data[a];if(null===_)_=function er(i,a,l,h,p){const _=em(),b=ka(),S=i.data[a]=function xb(i,a,l,h,p,_){let b=a?a.injectorIndex:-1,T=0;return function ie(){return null!==We.skipHydrationRootTNode}()&&(T|=128),{type:l,index:h,insertBeforeIndex:null,injectorIndex:b,directiveStart:-1,directiveEnd:-1,directiveStylingLast:-1,componentOffset:-1,propertyBindings:null,flags:T,providerIndexes:0,value:p,attrs:_,mergedAttrs:null,localNames:null,initialInputs:void 0,inputs:null,outputs:null,tView:null,next:null,prev:null,projectionNext:null,child:null,parent:a,projection:null,styles:null,stylesWithoutHost:null,residualStyles:void 0,classes:null,classesWithoutHost:null,residualClasses:void 0,classBindings:0,styleBindings:0}}(0,b?_:_&&_.parent,l,a,h,p);return null===i.firstChild&&(i.firstChild=S),null!==_&&(b?null==_.child&&null!==S.parent&&(_.child=S):null===_.next&&(_.next=S,S.prev=_)),S}(i,a,l,h,p),function df(){return We.lFrame.inI18n}()&&(_.flags|=32);else if(64&_.type){_.type=l,_.value=h,_.attrs=p;const b=function tu(){const i=We.lFrame,a=i.currentTNode;return i.isParent?a:a.parent}();_.injectorIndex=null===b?-1:b.injectorIndex}return ni(_,!0),_}function Kh(i,a,l,h){if(0===l)return-1;const p=a.length;for(let _=0;_<l;_++)a.push(h),i.blueprint.push(h),i.data.push(null);return p}function Jh(i,a,l,h,p){const _=ng(a,Ho),b=function Hi(){return We.lFrame.selectedIndex}(),T=2&h;try{$n(-1),T&&a.length>zn&&function mb(i,a,l,h){if(!h)if(3==(3&a[un])){const _=i.preOrderCheckHooks;null!==_&&Ah(a,_,l)}else{const _=i.preOrderHooks;null!==_&&Ph(a,_,0,l)}$n(l)}(i,a,zn,!1),Qs(T?2:0,p);const O=T?_:null,F=of(O);try{null!==O&&(O.dirty=!1),l(h,p)}finally{Th(O,F)}}finally{T&&null===a[Ho]&&Yh(a,Ho),$n(b),Qs(T?3:1,p)}}function Sc(i,a,l){if(d_(a)){const h=ks(null);try{const _=a.directiveEnd;for(let b=a.directiveStart;b<_;b++){const T=i.data[b];T.contentQueries&&T.contentQueries(1,l[b],b)}}finally{ks(h)}}}function gb(i){const a=i.tView;return null===a||a.incompleteFirstPass?i.tView=ig(1,null,i.template,i.decls,i.vars,i.directiveDefs,i.pipeDefs,i.viewQuery,i.schemas,i.consts,i.id):a}function ig(i,a,l,h,p,_,b,T,S,O,F){const G=zn+h,rt=G+p,at=function _b(i,a){const l=[];for(let h=0;h<a;h++)l.push(h<i?null:sn);return l}(G,rt),bt="function"==typeof O?O():O;return at[ve]={type:i,blueprint:at,template:l,queries:null,viewQuery:T,declTNode:a,data:at.slice().fill(null,G),bindingStartIndex:G,expandoStartIndex:rt,hostBindingOpCodes:null,firstCreatePass:!0,firstUpdatePass:!0,staticViewQueries:!1,staticContentQueries:!1,preOrderHooks:null,preOrderCheckHooks:null,contentHooks:null,contentCheckHooks:null,viewHooks:null,viewCheckHooks:null,destroyHooks:null,cleanup:null,contentQueries:null,components:null,directiveRegistry:"function"==typeof _?_():_,pipeRegistry:"function"==typeof b?b():b,firstChild:null,schemas:S,consts:bt,incompleteFirstPass:!1,ssrId:F}}let Yy=i=>null;function Za(i,a,l,h){for(let p in i)if(i.hasOwnProperty(p)){l=null===l?{}:l;const _=i[p];null===h?Ky(l,a,p,_):h.hasOwnProperty(p)&&Ky(l,a,h[p],_)}return l}function Ky(i,a,l,h){i.hasOwnProperty(l)?i[l].push(a,h):i[l]=[a,h]}function ag(i,a,l,h,p,_){for(let O=0;O<h.length;O++)k_(vf(l,a),i,h[O].type);!function Ib(i,a,l){i.flags|=1,i.directiveStart=a,i.directiveEnd=a+l,i.providerIndexes=a}(l,i.data.length,h.length);for(let O=0;O<h.length;O++){const F=h[O];F.providersResolver&&F.providersResolver(F)}let b=!1,T=!1,S=Kh(i,a,h.length,null);for(let O=0;O<h.length;O++){const F=h[O];l.mergedAttrs=mr(l.mergedAttrs,F.hostAttrs),lg(i,l,a,S,F),Cc(S,F,p),null!==F.contentQueries&&(l.flags|=4),(null!==F.hostBindings||null!==F.hostAttrs||0!==F.hostVars)&&(l.flags|=64);const G=F.type.prototype;!b&&(G.ngOnChanges||G.ngOnInit||G.ngDoCheck)&&((i.preOrderHooks??=[]).push(l.index),b=!0),!T&&(G.ngOnChanges||G.ngDoCheck)&&((i.preOrderCheckHooks??=[]).push(l.index),T=!0),S++}!function bb(i,a,l){const p=a.directiveEnd,_=i.data,b=a.attrs,T=[];let S=null,O=null;for(let F=a.directiveStart;F<p;F++){const G=_[F],rt=l?l.get(G):null,bt=rt?rt.outputs:null;S=Za(G.inputs,F,S,rt?rt.inputs:null),O=Za(G.outputs,F,O,bt);const Ft=null===S||null===b||io(a)?null:dI(S,F,b);T.push(Ft)}null!==S&&(S.hasOwnProperty("class")&&(a.flags|=8),S.hasOwnProperty("style")&&(a.flags|=16)),a.initialInputs=T,a.inputs=S,a.outputs=O}(i,l,_)}function td(i,a,l){const h=l.directiveStart,p=l.directiveEnd,_=l.index,b=function iM(){return We.lFrame.currentDirectiveIndex}();try{$n(_);for(let T=h;T<p;T++){const S=i.data[T],O=a[T];fc(T),(null!==S.hostBindings||0!==S.hostVars||null!==S.hostAttrs)&&Tb(S,O)}}finally{$n(-1),fc(b)}}function Tb(i,a){null!==i.hostBindings&&i.hostBindings(1,a)}function ws(i,a,l){a.componentOffset=l,(i.components??=[]).push(a.index)}function Cc(i,a,l){if(l){if(a.exportAs)for(let h=0;h<a.exportAs.length;h++)l[a.exportAs[h]]=i;Os(a)&&(l[""]=i)}}function lg(i,a,l,h,p){i.data[h]=p;const _=p.factory||(p.factory=uc(p.type)),b=new iu(_,Os(p),Dn);i.blueprint[h]=b,l[h]=b,function es(i,a,l,h,p){const _=p.hostBindings;if(_){let b=i.hostBindingOpCodes;null===b&&(b=i.hostBindingOpCodes=[]);const T=~a.index;(function Jy(i){let a=i.length;for(;a>0;){const l=i[--a];if("number"==typeof l&&l<0)return l}return 0})(b)!=T&&b.push(T),b.push(l,h,_)}}(i,a,h,Kh(i,l,p.hostVars,sn),p)}function hI(i,a,l,h,p,_){const b=_[a];if(null!==b)for(let T=0;T<b.length;)Sb(h,l,b[T++],b[T++],b[T++])}function Sb(i,a,l,h,p){const _=ks(null);try{const b=i.inputTransforms;null!==b&&b.hasOwnProperty(h)&&(p=b[h].call(a,p)),null!==i.setInput?i.setInput(a,p,l,h):a[h]=p}finally{ks(_)}}function dI(i,a,l){let h=null,p=0;for(;p<l.length;){const _=l[p];if(0!==_)if(5!==_){if("number"==typeof _)break;if(i.hasOwnProperty(_)){null===h&&(h=[]);const b=i[_];for(let T=0;T<b.length;T+=2)if(b[T]===a){h.push(_,b[T+1],l[p+1]);break}}p+=2}else p+=2;else p+=4}return h}function Au(i,a){const l=i.contentQueries;if(null!==l)for(let h=0;h<l.length;h+=2){const _=l[h+1];if(-1!==_){const b=i.data[_];me(l[h]),b.contentQueries(2,a[_],_)}}}function rd(i,a){return i[Wc]?i[Gp][Ls]=a:i[Wc]=a,i[Gp]=a,a}function Qy(i,a,l){me(0);const h=ks(null);try{a(i,l)}finally{ks(h)}}function Wa(i,a,l,h,p){for(let _=0;_<l.length;){const b=l[_++],T=l[_++];Sb(i.data[b],a[b],h,T,p)}}function Rb(i,a){const l=ms(a,i),h=l[ve];!function ug(i,a){for(let l=a.length;l<i.blueprint.length;l++)a.push(i.blueprint[l])}(h,l);const p=l[le];null!==p&&null===l[Js]&&(l[Js]=Tc(p,l[sc])),Qf(h,l,l[gi])}function Qf(i,a,l){Ch(a);try{const h=i.viewQuery;null!==h&&Qy(1,h,l);const p=i.template;null!==p&&Jh(i,a,p,1,l),i.firstCreatePass&&(i.firstCreatePass=!1),i.staticContentQueries&&Au(i,a),i.staticViewQueries&&Qy(2,i.viewQuery,l);const _=i.components;null!==_&&function fI(i,a){for(let l=0;l<a.length;l++)Rb(i,a[l])}(a,_)}catch(h){throw i.firstCreatePass&&(i.incompleteFirstPass=!0,i.firstCreatePass=!1),h}finally{a[un]&=-5,xo()}}let t0=(()=>{class i{constructor(){this.all=new Set,this.queue=new Map}create(l,h,p){const _=typeof Zone>"u"?null:Zone.current,b=function y_(i,a,l){const h=Object.create(yx);l&&(h.consumerAllowSignalWrites=!0),h.fn=i,h.schedule=a;const p=b=>{h.cleanupFn=b};return h.ref={notify:()=>fx(h),run:()=>{if(h.dirty=!1,h.hasRun&&!yl(h))return;h.hasRun=!0;const b=of(h);try{h.cleanupFn(),h.cleanupFn=v_,h.fn(p)}finally{Th(h,b)}},cleanup:()=>h.cleanupFn()},h.ref}(l,O=>{this.all.has(O)&&this.queue.set(O,_)},p);let T;this.all.add(b),b.notify();const S=()=>{b.cleanup(),T?.(),this.all.delete(b),this.queue.delete(b)};return T=h?.onDestroy(S),{destroy:S}}flush(){if(0!==this.queue.size)for(const[l,h]of this.queue)this.queue.delete(l),h?h.run(()=>l.run()):l.run()}get isQueueEmpty(){return 0===this.queue.size}static#t=this.\u0275prov=cr({token:i,providedIn:"root",factory:()=>new i})}return i})();function tp(i,a,l){let h=l?i.styles:null,p=l?i.classes:null,_=0;if(null!==a)for(let b=0;b<a.length;b++){const T=a[b];"number"==typeof T?_=T:1==_?p=lt(p,T):2==_&&(h=lt(h,T+": "+a[++b]+";"))}l?i.styles=h:i.stylesWithoutHost=h,l?i.classes=p:i.classesWithoutHost=p}function od(i,a,l,h,p=!1){for(;null!==l;){const _=a[l.index];null!==_&&h.push(zr(_)),Ki(_)&&e0(_,h);const b=l.type;if(8&b)od(i,a,l.child,h);else if(32&b){const T=Mm(l,a);let S;for(;S=T();)h.push(S)}else if(16&b){const T=Cl(a,l);if(Array.isArray(T))h.push(...T);else{const S=Fh(a[li]);od(S[ve],S,T,h,!0)}}l=p?l.projectionNext:l.next}return h}function e0(i,a){for(let l=Yi;l<i.length;l++){const h=i[l],p=h[ve].firstChild;null!==p&&od(h[ve],h,p,a)}i[Ra]!==i[le]&&a.push(i[Ra])}function hg(i,a,l,h=!0){const p=a[gh],_=p.rendererFactory,b=p.afterRenderEventManager;_.begin?.(),b?.begin();try{sd(i,a,i.template,l)}catch(S){throw h&&function id(i,a){const l=i[sc],h=l?l.get(ua,null):null;h&&h.handleError(a)}(a,S),S}finally{_.end?.(),p.effectManager?.flush(),b?.end()}}function sd(i,a,l,h){const p=a[un];if(256!=(256&p)){a[gh].effectManager?.flush(),Ch(a);try{Ix(a),function ar(i){return We.lFrame.bindingIndex=i}(i.bindingStartIndex),null!==l&&Jh(i,a,l,2,h);const b=3==(3&p);if(b){const O=i.preOrderCheckHooks;null!==O&&Ah(a,O,null)}else{const O=i.preOrderHooks;null!==O&&Ph(a,O,0,null),mf(a,0)}if(function ep(i){for(let a=Pf(i);null!==a;a=Ue(a)){if(!a[Hp])continue;const l=a[xh];for(let h=0;h<l.length;h++){ta(l[h])}}}(a),ad(a,2),null!==i.contentQueries&&Au(i,a),b){const O=i.contentCheckHooks;null!==O&&Ah(a,O)}else{const O=i.contentHooks;null!==O&&Ph(a,O,1),mf(a,1)}!function oI(i,a){const l=i.hostBindingOpCodes;if(null===l)return;const h=ng(a,Xc);try{for(let p=0;p<l.length;p++){const _=l[p];if(_<0)$n(~_);else{const b=_,T=l[++p],S=l[++p];Rx(T,b),h.dirty=!1;const O=of(h);try{S(2,a[b])}finally{Th(h,O)}}}}finally{null===a[Xc]&&Yh(a,Xc),$n(-1)}}(i,a);const T=i.components;null!==T&&Lb(a,T,0);const S=i.viewQuery;if(null!==S&&Qy(2,S,h),b){const O=i.viewCheckHooks;null!==O&&Ah(a,O)}else{const O=i.viewHooks;null!==O&&Ph(a,O,2),mf(a,2)}!0===i.firstUpdatePass&&(i.firstUpdatePass=!1),a[un]&=-73,uf(a)}finally{xo()}}}function ad(i,a){for(let l=Pf(i);null!==l;l=Ue(l))for(let h=Yi;h<l.length;h++)rp(l[h],a)}function np(i,a,l){rp(ms(a,i),l)}function rp(i,a){if(!function w_(i){return 128==(128&i[un])}(i))return;const l=i[ve],h=i[un];if(80&h&&0===a||1024&h||2===a)sd(l,i,l.template,i[gi]);else if(i[mh]>0){ad(i,1);const p=l.components;null!==p&&Lb(i,p,1)}}function Lb(i,a,l){for(let h=0;h<a.length;h++)np(i,a[h],l)}class ip{get rootNodes(){const a=this._lView,l=a[ve];return od(l,a,l.firstChild,[])}constructor(a,l){this._lView=a,this._cdRefInjectingView=l,this._appRef=null,this._attachedToViewContainer=!1}get context(){return this._lView[gi]}set context(a){this._lView[gi]=a}get destroyed(){return 256==(256&this._lView[un])}destroy(){if(this._appRef)this._appRef.detachView(this);else if(this._attachedToViewContainer){const a=this._lView[Gr];if(Ki(a)){const l=a[8],h=l?l.indexOf(this):-1;h>-1&&(function En(i,a){if(i.length<=Yi)return;const l=Yi+a,h=i[l];if(h){const p=h[_h];null!==p&&p!==i&&Sm(p,h),a>0&&(i[l-1][Ls]=h[Ls]);const _=Jr(i,Yi+a);!function E1(i,a){nn(i,a,a[ln],2,null,null),a[le]=null,a[mi]=null}(h[ve],h);const b=_[$o];null!==b&&b.detachView(_[ve]),h[Gr]=null,h[Ls]=null,h[un]&=-129}return h}(a,h),Jr(l,h))}this._attachedToViewContainer=!1}!function J_(i,a){if(!(256&a[un])){const l=a[ln];a[Ho]&&Yp(a[Ho]),a[Xc]&&Yp(a[Xc]),l.destroyNode&&nn(i,a,l,3,null,null),function I1(i){let a=i[Wc];if(!a)return Q_(i[ve],i);for(;a;){let l=null;if(qo(a))l=a[Wc];else{const h=a[Yi];h&&(l=h)}if(!l){for(;a&&!a[Ls]&&a!==i;)qo(a)&&Q_(a[ve],a),a=a[Gr];null===a&&(a=i),qo(a)&&Q_(a[ve],a),l=a&&a[Ls]}a=l}}(a)}}(this._lView[ve],this._lView)}onDestroy(a){!function wl(i,a){if(256==(256&i[un]))throw new Bt(911,!1);null===i[Ks]&&(i[Ks]=[]),i[Ks].push(a)}(this._lView,a)}markForCheck(){Dc(this._cdRefInjectingView||this._lView)}detach(){this._lView[un]&=-129}reattach(){this._lView[un]|=128}detectChanges(){hg(this._lView[ve],this._lView,this.context)}checkNoChanges(){}attachToViewContainerRef(){if(this._appRef)throw new Bt(902,!1);this._attachedToViewContainer=!0}detachFromAppRef(){this._appRef=null,function M1(i,a){nn(i,a,a[ln],2,null,null)}(this._lView[ve],this._lView)}attachToAppRef(a){if(this._attachedToViewContainer)throw new Bt(902,!1);this._appRef=a}}class ld extends ip{constructor(a){super(a),this._view=a}detectChanges(){const a=this._view;hg(a[ve],a,a[gi],!1)}checkNoChanges(){}get context(){return null}}class op extends Eu{constructor(a){super(),this.ngModule=a}resolveComponentFactory(a){const l=On(a);return new sp(l,this.ngModule)}}function Ob(i){const a=[];for(let l in i)i.hasOwnProperty(l)&&a.push({propName:i[l],templateName:l});return a}class Fb{constructor(a,l){this.injector=a,this.parentInjector=l}get(a,l,h){h=Gi(h);const p=this.injector.get(a,Ym,h);return p!==Ym||l===Ym?p:this.parentInjector.get(a,l,h)}}class sp extends Xf{get inputs(){const a=this.componentDef,l=a.inputTransforms,h=Ob(a.inputs);if(null!==l)for(const p of h)l.hasOwnProperty(p.propName)&&(p.transform=l[p.propName]);return h}get outputs(){return Ob(this.componentDef.outputs)}constructor(a,l){super(),this.componentDef=a,this.ngModule=l,this.componentType=a.type,this.selector=function sr(i){return i.map(ur).join(",")}(a.selectors),this.ngContentSelectors=a.ngContentSelectors?a.ngContentSelectors:[],this.isBoundToModule=!!l}create(a,l,h,p){let _=(p=p||this.ngModule)instanceof js?p:p?.injector;_&&null!==this.componentDef.getStandaloneInjector&&(_=this.componentDef.getStandaloneInjector(_)||_);const b=_?new Fb(a,_):a,T=b.get(K1,null);if(null===T)throw new Bt(407,!1);const G={rendererFactory:T,sanitizer:b.get(GM,null),effectManager:b.get(t0,null),afterRenderEventManager:b.get(Wy,null)},rt=T.createRenderer(null,this.componentDef),at=this.componentDef.selectors[0][0]||"div",bt=h?function sI(i,a,l,h){const _=h.get(eg,!1)||l===ro.ShadowDom,b=i.selectRootElement(a,_);return function yb(i){Yy(i)}(b),b}(rt,h,this.componentDef.encapsulation,b):Lf(rt,at,function kb(i){const a=i.toLowerCase();return"svg"===a?"svg":"math"===a?"math":null}(at)),he=this.componentDef.signals?4608:this.componentDef.onPush?576:528;let Nt=null;null!==bt&&(Nt=Tc(bt,b,!0));const Xe=ig(0,null,null,1,0,null,null,null,null,null,null),fn=rg(null,Xe,null,he,null,null,G,rt,b,null,Nt);let Kn,Hs;Ch(fn);try{const eh=this.componentDef;let i_,pC=null;eh.findHostDirectiveDefs?(i_=[],pC=new Map,eh.findHostDirectiveDefs(eh,i_,pC),i_.push(eh)):i_=[eh];const mR=function mI(i,a){const l=i[ve],h=zn;return i[h]=a,Su(l,h,2,"#host",null)}(fn,bt),gR=function zb(i,a,l,h,p,_,b){const T=p[ve];!function gI(i,a,l,h){for(const p of i)a.mergedAttrs=mr(a.mergedAttrs,p.hostAttrs);null!==a.mergedAttrs&&(tp(a,a.mergedAttrs,!0),null!==l&&oy(h,l,a))}(h,i,a,b);let S=null;null!==a&&(S=Tc(a,p[sc]));const O=_.rendererFactory.createRenderer(a,l);let F=16;l.signals?F=4096:l.onPush&&(F=64);const G=rg(p,gb(l),null,F,p[i.index],i,_,O,null,null,S);return T.firstCreatePass&&ws(T,i,h.length-1),rd(p,G),p[i.index]=G}(mR,bt,eh,i_,fn,G,rt);Hs=function Mx(i,a){return i.data[a]}(Xe,zn),bt&&function _I(i,a,l,h){if(h)or(i,l,["ng-version",$M.full]);else{const{attrs:p,classes:_}=function pl(i){const a=[],l=[];let h=1,p=2;for(;h<i.length;){let _=i[h];if("string"==typeof _)2===p?""!==_&&a.push(_,i[++h]):8===p&&l.push(_);else{if(!fi(p))break;p=_}h++}return{attrs:a,classes:l}}(a.selectors[0]);p&&or(i,l,p),_&&_.length>0&&iy(i,l,_.join(" "))}}(rt,eh,bt,h),void 0!==l&&function n0(i,a,l){const h=i.projection=[];for(let p=0;p<a.length;p++){const _=l[p];h.push(null!=_?Array.from(_):null)}}(Hs,this.ngContentSelectors,l),Kn=function dg(i,a,l,h,p,_){const b=Pi(),T=p[ve],S=Wo(b,p);ag(T,p,b,l,null,h);for(let F=0;F<l.length;F++)ho(su(p,T,b.directiveStart+F,b),p);td(T,p,b),S&&ho(S,p);const O=su(p,T,b.directiveStart+b.componentOffset,b);if(i[gi]=p[gi]=O,null!==_)for(const F of _)F(O,a);return Sc(T,b,i),O}(gR,eh,i_,pC,fn,[Bb]),Qf(Xe,fn,null)}finally{xo()}return new Nb(this.componentType,Kn,Hh(Hs,fn),fn,Hs)}}class Nb extends Oy{constructor(a,l,h,p,_){super(),this.location=h,this._rootLView=p,this._tNode=_,this.previousInputValues=null,this.instance=l,this.hostView=this.changeDetectorRef=new ld(p),this.componentType=a}setInput(a,l){const h=this._tNode.inputs;let p;if(null!==h&&(p=h[a])){if(this.previousInputValues??=new Map,this.previousInputValues.has(a)&&Object.is(this.previousInputValues.get(a),l))return;const _=this._rootLView;Wa(_[ve],_,p,a,l),this.previousInputValues.set(a,l),Dc(ms(this._tNode.index,_))}}get injector(){return new lo(this._tNode,this._rootLView)}destroy(){this.hostView.destroy()}onDestroy(a){this.hostView.onDestroy(a)}}function Bb(){const i=Pi();ru(qt()[ve],i)}function h0(i,a,l,h,p){const b=p?"class":"style";Wa(i,l,a.inputs[b],b,h)}function vd(i,a,l,h){const p=qt(),_=Xn(),b=zn+i,T=p[ln],S=_.firstCreatePass?function zI(i,a,l,h,p,_){const b=a.consts,S=Su(a,i,2,h,dc(b,p));return function sg(i,a,l,h){if(Qc()){const p=null===h?null:{"":-1},_=function Mb(i,a){const l=i.directiveRegistry;let h=null,p=null;if(l)for(let _=0;_<l.length;_++){const b=l[_];if(oc(a,b.selectors,!1))if(h||(h=[]),Os(b))if(null!==b.findHostDirectiveDefs){const T=[];p=p||new Map,b.findHostDirectiveDefs(b,T,p),h.unshift(...T,b),ws(i,a,T.length)}else h.unshift(b),ws(i,a,0);else p=p||new Map,b.findHostDirectiveDefs?.(b,h,p),h.push(b)}return null===h?null:[h,p]}(i,l);let b,T;null===_?b=T=null:[b,T]=_,null!==b&&ag(i,a,l,b,p,T),p&&function ed(i,a,l){if(a){const h=i.localNames=[];for(let p=0;p<a.length;p+=2){const _=l[a[p+1]];if(null==_)throw new Bt(-301,!1);h.push(a[p],_)}}}(l,h,p)}l.mergedAttrs=mr(l.mergedAttrs,l.attrs)}(a,l,S,dc(b,_)),null!==S.attrs&&tp(S,S.attrs,!1),null!==S.mergedAttrs&&tp(S,S.mergedAttrs,!0),null!==a.queries&&a.queries.elementStart(a,S),S}(b,_,p,a,l,h):_.data[b],O=d0(_,p,S,T,a,i);p[b]=O;const F=function qp(i){return 1==(1&i.flags)}(S);return ni(S,!0),oy(T,O,S),32!=(32&S.flags)&&Fs()&&fu(_,p,O,S),0===function Sx(){return We.lFrame.elementDepthCount}()&&ho(O,p),function Cx(){We.lFrame.elementDepthCount++}(),F&&(function Jf(i,a,l){Qc()&&(function Eb(i,a,l,h){const p=l.directiveStart,_=l.directiveEnd;La(l)&&function Db(i,a,l){const h=Wo(a,i),p=gb(l);let b=16;l.signals?b=4096:l.onPush&&(b=64);const T=rd(i,rg(i,p,null,b,h,a,null,i[gh].rendererFactory.createRenderer(h,l),null,null,null));i[a.index]=T}(a,l,i.data[p+l.componentOffset]),i.firstCreatePass||vf(l,a),ho(h,a);const b=l.initialInputs;for(let T=p;T<_;T++){const S=i.data[T],O=su(a,i,T,l);ho(O,a),null!==b&&hI(0,T-p,O,S,0,b),Os(S)&&(ms(l.index,a)[gi]=su(a,i,T,l))}}(i,a,l,Wo(l,a)),64==(64&l.flags)&&td(i,a,l))}(_,p,S),Sc(_,S,p)),null!==h&&function Qh(i,a,l=Wo){const h=a.localNames;if(null!==h){let p=a.index+1;for(let _=0;_<h.length;_+=2){const b=h[_+1],T=-1===b?l(a,i):i[b];i[p++]=T}}}(p,S),vd}function dp(){let i=Pi();ka()?function nm(){We.lFrame.isParent=!1}():(i=i.parent,ni(i,!1));const a=i;(function E_(i){return We.skipHydrationRootTNode===i})(a)&&function Ax(){We.skipHydrationRootTNode=null}(),function Sh(){We.lFrame.elementDepthCount--}();const l=Xn();return l.firstCreatePass&&(ru(l,i),d_(i)&&l.queries.elementEnd(i)),null!=a.classesWithoutHost&&function ou(i){return 0!=(8&i.flags)}(a)&&h0(l,a,qt(),a.classesWithoutHost,!0),null!=a.stylesWithoutHost&&function A_(i){return 0!=(16&i.flags)}(a)&&h0(l,a,qt(),a.stylesWithoutHost,!1),dp}function xd(i,a,l,h){return vd(i,a,l,h),dp(),xd}let d0=(i,a,l,h,p,_)=>(bo(!0),Lf(h,p,function om(){return We.lFrame.currentNamespace}()));function p0(i){return!!i&&"function"==typeof i.then}function fp(i){return!!i&&"function"==typeof i.subscribe}let R0=(i,a,l,h,p)=>(bo(!0),function Rf(i,a){return i.createText(a)}(a[ln],h));const Uu="en-US";let Gw=Uu;class zl{}class fv extends zl{constructor(a){super(),this.componentFactoryResolver=new op(this),this.instance=null;const l=new _u([...a.providers,{provide:zl,useValue:this},{provide:Eu,useValue:this.componentFactoryResolver}],a.parent||Rl(),a.debugName,new Set(["environment"]));this.injector=l,a.runEnvironmentInitializers&&l.resolveInjectorInitializers()}destroy(){this.injector.destroy()}onDestroy(a){this.injector.onDestroy(a)}}let hE=(()=>{class i{constructor(l){this._injector=l,this.cachedInjectors=new Map}getOrCreateStandaloneInjector(l){if(!l.standalone)return null;if(!this.cachedInjectors.has(l)){const h=zm(0,l.type),p=h.length>0?function uE(i,a,l=null){return new fv({providers:i,parent:a,debugName:l,runEnvironmentInitializers:!0}).injector}([h],this._injector,`Standalone[${l.type.name}]`):null;this.cachedInjectors.set(l,p)}return this.cachedInjectors.get(l)}ngOnDestroy(){try{for(const l of this.cachedInjectors.values())null!==l&&l.destroy()}finally{this.cachedInjectors.clear()}}static#t=this.\u0275prov=cr({token:i,providedIn:"environment",factory:()=>new i(Mn(js))})}return i})();function Bg(i){i.getStandaloneInjector=a=>a.get(hE).getOrCreateStandaloneInjector(i)}Symbol;const wS=new qe("Application Initializer");let Qg=(()=>{class i{constructor(){this.initialized=!1,this.done=!1,this.donePromise=new Promise((l,h)=>{this.resolve=l,this.reject=h}),this.appInits=Wn(wS,{optional:!0})??[]}runInitializers(){if(this.initialized)return;const l=[];for(const p of this.appInits){const _=p();if(p0(_))l.push(_);else if(fp(_)){const b=new Promise((T,S)=>{_.subscribe({complete:T,error:S})});l.push(b)}}const h=()=>{this.done=!0,this.resolve()};Promise.all(l).then(()=>{h()}).catch(p=>{this.reject(p)}),0===l.length&&h(),this.initialized=!0}static#t=this.\u0275fac=function(h){return new(h||i)};static#e=this.\u0275prov=cr({token:i,factory:i.\u0275fac,providedIn:"root"})}return i})();const Vl=new qe("LocaleId",{providedIn:"root",factory:()=>Wn(Vl,An.Optional|An.SkipSelf)||function Uv(){return typeof $localize<"u"&&$localize.locale||Uu}()});let MS=(()=>{class i{constructor(){this.taskId=0,this.pendingTasks=new Set,this.hasPendingTasks=new jc(!1)}add(){this.hasPendingTasks.next(!0);const l=this.taskId++;return this.pendingTasks.add(l),l}remove(l){this.pendingTasks.delete(l),0===this.pendingTasks.size&&this.hasPendingTasks.next(!1)}ngOnDestroy(){this.pendingTasks.clear(),this.hasPendingTasks.next(!1)}static#t=this.\u0275fac=function(h){return new(h||i)};static#e=this.\u0275prov=cr({token:i,factory:i.\u0275fac,providedIn:"root"})}return i})();const n=new qe("");let d=null;const m=new qe("PlatformDestroyListeners"),g=new qe("appBootstrapListener");function P(i){try{const{rootComponent:a,appProviders:l,platformProviders:h}=i,p=function D(i=[]){if(d)return d;const a=function k(i=[],a){return $a.create({name:a,providers:[{provide:Vm,useValue:"platform"},{provide:m,useValue:new Set([()=>d=null])},...i]})}(i);return d=a,function x(){!function mx(i){Kp=i}(()=>{throw new Bt(600,!1)})}(),function A(i){i.get(Iy,null)?.forEach(l=>l())}(a),a}(h),_=[_t(),...l||[]],T=new fv({providers:_,parent:p,debugName:"",runEnvironmentInitializers:!1}).injector,S=T.get(hi);return S.run(()=>{T.resolveInjectorInitializers();const O=T.get(ua,null);let F;S.runOutsideAngular(()=>{F=S.onError.subscribe({next:at=>{O.handleError(at)}})});const G=()=>T.destroy(),rt=p.get(m);return rt.add(G),T.onDestroy(()=>{F.unsubscribe(),rt.delete(G)}),function W(i,a,l){try{const h=l();return p0(h)?h.catch(p=>{throw a.runOutsideAngular(()=>i.handleError(p)),p}):h}catch(h){throw a.runOutsideAngular(()=>i.handleError(h)),h}}(O,S,()=>{const at=T.get(Qg);return at.runInitializers(),at.donePromise.then(()=>{!function Ag(i){Zi(i,"Expected localeId to be defined"),"string"==typeof i&&(Gw=i.toLowerCase().replace(/_/g,"-"))}(T.get(Vl,Uu)||Uu);const Ft=T.get(K);return void 0!==a&&Ft.bootstrap(a),Ft})})})}catch(a){return Promise.reject(a)}}let K=(()=>{class i{constructor(){this._bootstrapListeners=[],this._runningTick=!1,this._destroyed=!1,this._destroyListeners=[],this._views=[],this.internalErrorHandler=Wn(Y),this.zoneIsStable=Wn(ib),this.componentTypes=[],this.components=[],this.isStable=Wn(MS).hasPendingTasks.pipe(function jn(i,a){return Lo((l,h)=>{let p=null,_=0,b=!1;const T=()=>b&&!p&&h.complete();l.subscribe(Dr(h,S=>{p?.unsubscribe();let O=0;const F=_++;vn(i(S,F)).subscribe(p=Dr(h,G=>h.next(a?a(S,G,F,O++):G),()=>{p=null,T()}))},()=>{b=!0,T()}))})}(l=>l?function Ma(...i){return Kl(i,Yl(i))}(!1):this.zoneIsStable),function zo(i,a=ol){return i=i??I,Lo((l,h)=>{let p,_=!0;l.subscribe(Dr(h,b=>{const T=a(b);(_||!i(p,T))&&(_=!1,p=T,h.next(b))}))})}(),ef()),this._injector=Wn(js)}get destroyed(){return this._destroyed}get injector(){return this._injector}bootstrap(l,h){const p=l instanceof Xf;if(!this._injector.get(Qg).done)throw!p&&function Ys(i){const a=On(i)||Cr(i)||pi(i);return null!==a&&a.standalone}(l),new Bt(405,!1);let b;b=p?l:this._injector.get(Eu).resolveComponentFactory(l),this.componentTypes.push(b.componentType);const T=function w(i){return i.isBoundToModule}(b)?void 0:this._injector.get(zl),O=b.create($a.NULL,[],h||b.selector,T),F=O.location.nativeElement,G=O.injector.get(n,null);return G?.registerApplication(F),O.onDestroy(()=>{this.detachView(O.hostView),Q(this.components,O),G?.unregisterApplication(F)}),this._loadComponent(O),O}tick(){if(this._runningTick)throw new Bt(101,!1);try{this._runningTick=!0;for(let l of this._views)l.detectChanges()}catch(l){this.internalErrorHandler(l)}finally{this._runningTick=!1}}attachView(l){const h=l;this._views.push(h),h.attachToAppRef(this)}detachView(l){const h=l;Q(this._views,h),h.detachFromAppRef()}_loadComponent(l){this.attachView(l.hostView),this.tick(),this.components.push(l);const h=this._injector.get(g,[]);h.push(...this._bootstrapListeners),h.forEach(p=>p(l))}ngOnDestroy(){if(!this._destroyed)try{this._destroyListeners.forEach(l=>l()),this._views.slice().forEach(l=>l.destroy())}finally{this._destroyed=!0,this._views=[],this._bootstrapListeners=[],this._destroyListeners=[]}}onDestroy(l){return this._destroyListeners.push(l),()=>Q(this._destroyListeners,l)}destroy(){if(this._destroyed)throw new Bt(406,!1);const l=this._injector;l.destroy&&!l.destroyed&&l.destroy()}get viewCount(){return this._views.length}warnIfDestroyed(){}static#t=this.\u0275fac=function(h){return new(h||i)};static#e=this.\u0275prov=cr({token:i,factory:i.\u0275fac,providedIn:"root"})}return i})();function Q(i,a){const l=i.indexOf(a);l>-1&&i.splice(l,1)}const Y=new qe("",{providedIn:"root",factory:()=>Wn(ua).handleError.bind(void 0)});function J(){const i=Wn(hi),a=Wn(ua);return l=>i.runOutsideAngular(()=>a.handleError(l))}let ct=(()=>{class i{constructor(){this.zone=Wn(hi),this.applicationRef=Wn(K)}initialize(){this._onMicrotaskEmptySubscription||(this._onMicrotaskEmptySubscription=this.zone.onMicrotaskEmpty.subscribe({next:()=>{this.zone.run(()=>{this.applicationRef.tick()})}}))}ngOnDestroy(){this._onMicrotaskEmptySubscription?.unsubscribe()}static#t=this.\u0275fac=function(h){return new(h||i)};static#e=this.\u0275prov=cr({token:i,factory:i.\u0275fac,providedIn:"root"})}return i})();function ht(i){return[{provide:hi,useFactory:i},{provide:Gf,multi:!0,useFactory:()=>{const a=Wn(ct,{optional:!0});return()=>a.initialize()}},{provide:Y,useFactory:J},{provide:ib,useFactory:qy}]}function _t(i){return function $f(i){return{\u0275providers:i}}([[],ht(()=>new hi(function U(i){return{enableLongStackTrace:!1,shouldCoalesceEventChangeDetection:i?.eventCoalescing??!1,shouldCoalesceRunChangeDetection:i?.runCoalescing??!1}}(i)))])}let US=null;function GS(){return US}class q2{}const Bp=new qe("DocumentToken");let m2=(()=>{class i{static#t=this.\u0275fac=function(h){return new(h||i)};static#e=this.\u0275mod=Go({type:i});static#n=this.\u0275inj=Jl({})}return i})();function _2(i){return"server"===i}class FP extends q2{constructor(){super(...arguments),this.supportsDOMEvents=!0}}class sC extends FP{static makeCurrent(){!function H2(i){US||(US=i)}(new sC)}onAndCancel(a,l,h){return a.addEventListener(l,h),()=>{a.removeEventListener(l,h)}}dispatchEvent(a,l){a.dispatchEvent(l)}remove(a){a.parentNode&&a.parentNode.removeChild(a)}createElement(a,l){return(l=l||this.getDefaultDocument()).createElement(a)}createHtmlDocument(){return document.implementation.createHTMLDocument("fakeTitle")}getDefaultDocument(){return document}isElementNode(a){return a.nodeType===Node.ELEMENT_NODE}isShadowRoot(a){return a instanceof DocumentFragment}getGlobalEventTarget(a,l){return"window"===l?window:"document"===l?a:"body"===l?a.body:null}getBaseHref(a){const l=function NP(){return tx=tx||document.querySelector("base"),tx?tx.getAttribute("href"):null}();return null==l?null:function zP(i){kT=kT||document.createElement("a"),kT.setAttribute("href",i);const a=kT.pathname;return"/"===a.charAt(0)?a:`/${a}`}(l)}resetBaseElement(){tx=null}getUserAgent(){return window.navigator.userAgent}getCookie(a){return function RA(i,a){a=encodeURIComponent(a);for(const l of i.split(";")){const h=l.indexOf("="),[p,_]=-1==h?[l,""]:[l.slice(0,h),l.slice(h+1)];if(p.trim()===a)return decodeURIComponent(_)}return null}(document.cookie,a)}}let kT,tx=null,jP=(()=>{class i{build(){return new XMLHttpRequest}static#t=this.\u0275fac=function(h){return new(h||i)};static#e=this.\u0275prov=cr({token:i,factory:i.\u0275fac})}return i})();const aC=new qe("EventManagerPlugins");let w2=(()=>{class i{constructor(l,h){this._zone=h,this._eventNameToPlugin=new Map,l.forEach(p=>{p.manager=this}),this._plugins=l.slice().reverse()}addEventListener(l,h,p){return this._findPluginFor(h).addEventListener(l,h,p)}getZone(){return this._zone}_findPluginFor(l){let h=this._eventNameToPlugin.get(l);if(h)return h;if(h=this._plugins.find(_=>_.supports(l)),!h)throw new Bt(5101,!1);return this._eventNameToPlugin.set(l,h),h}static#t=this.\u0275fac=function(h){return new(h||i)(Mn(aC),Mn(hi))};static#e=this.\u0275prov=cr({token:i,factory:i.\u0275fac})}return i})();class E2{constructor(a){this._doc=a}}const lC="ng-app-id";let T2=(()=>{class i{constructor(l,h,p,_={}){this.doc=l,this.appId=h,this.nonce=p,this.platformId=_,this.styleRef=new Map,this.hostNodes=new Set,this.styleNodesInDOM=this.collectServerRenderedStyles(),this.platformIsServer=_2(_),this.resetHostNodes()}addStyles(l){for(const h of l)1===this.changeUsageCount(h,1)&&this.onStyleAdded(h)}removeStyles(l){for(const h of l)this.changeUsageCount(h,-1)<=0&&this.onStyleRemoved(h)}ngOnDestroy(){const l=this.styleNodesInDOM;l&&(l.forEach(h=>h.remove()),l.clear());for(const h of this.getAllStyles())this.onStyleRemoved(h);this.resetHostNodes()}addHost(l){this.hostNodes.add(l);for(const h of this.getAllStyles())this.addStyleToHost(l,h)}removeHost(l){this.hostNodes.delete(l)}getAllStyles(){return this.styleRef.keys()}onStyleAdded(l){for(const h of this.hostNodes)this.addStyleToHost(h,l)}onStyleRemoved(l){const h=this.styleRef;h.get(l)?.elements?.forEach(p=>p.remove()),h.delete(l)}collectServerRenderedStyles(){const l=this.doc.head?.querySelectorAll(`style[${lC}="${this.appId}"]`);if(l?.length){const h=new Map;return l.forEach(p=>{null!=p.textContent&&h.set(p.textContent,p)}),h}return null}changeUsageCount(l,h){const p=this.styleRef;if(p.has(l)){const _=p.get(l);return _.usage+=h,_.usage}return p.set(l,{usage:h,elements:[]}),h}getStyleElement(l,h){const p=this.styleNodesInDOM,_=p?.get(h);if(_?.parentNode===l)return p.delete(h),_.removeAttribute(lC),_;{const b=this.doc.createElement("style");return this.nonce&&b.setAttribute("nonce",this.nonce),b.textContent=h,this.platformIsServer&&b.setAttribute(lC,this.appId),b}}addStyleToHost(l,h){const p=this.getStyleElement(l,h);l.appendChild(p);const _=this.styleRef,b=_.get(h)?.elements;b?b.push(p):_.set(h,{elements:[p],usage:1})}resetHostNodes(){const l=this.hostNodes;l.clear(),l.add(this.doc.head)}static#t=this.\u0275fac=function(h){return new(h||i)(Mn(Bp),Mn(My),Mn(Ga,8),Mn(yu))};static#e=this.\u0275prov=cr({token:i,factory:i.\u0275fac})}return i})();const cC={svg:"http://www.w3.org/2000/svg",xhtml:"http://www.w3.org/1999/xhtml",xlink:"http://www.w3.org/1999/xlink",xml:"http://www.w3.org/XML/1998/namespace",xmlns:"http://www.w3.org/2000/xmlns/",math:"http://www.w3.org/1998/MathML/"},uC=/%COMP%/g,$P=new qe("RemoveStylesOnCompDestroy",{providedIn:"root",factory:()=>!1});function I2(i,a){return a.map(l=>l.replace(uC,i))}let D2=(()=>{class i{constructor(l,h,p,_,b,T,S,O=null){this.eventManager=l,this.sharedStylesHost=h,this.appId=p,this.removeStylesOnCompDestroy=_,this.doc=b,this.platformId=T,this.ngZone=S,this.nonce=O,this.rendererByCompId=new Map,this.platformIsServer=_2(T),this.defaultRenderer=new hC(l,b,S,this.platformIsServer)}createRenderer(l,h){if(!l||!h)return this.defaultRenderer;this.platformIsServer&&h.encapsulation===ro.ShadowDom&&(h={...h,encapsulation:ro.Emulated});const p=this.getOrCreateRenderer(l,h);return p instanceof C2?p.applyToHost(l):p instanceof dC&&p.applyStyles(),p}getOrCreateRenderer(l,h){const p=this.rendererByCompId;let _=p.get(h.id);if(!_){const b=this.doc,T=this.ngZone,S=this.eventManager,O=this.sharedStylesHost,F=this.removeStylesOnCompDestroy,G=this.platformIsServer;switch(h.encapsulation){case ro.Emulated:_=new C2(S,O,h,this.appId,F,b,T,G);break;case ro.ShadowDom:return new WP(S,O,l,h,b,T,this.nonce,G);default:_=new dC(S,O,h,F,b,T,G)}p.set(h.id,_)}return _}ngOnDestroy(){this.rendererByCompId.clear()}static#t=this.\u0275fac=function(h){return new(h||i)(Mn(w2),Mn(T2),Mn(My),Mn($P),Mn(Bp),Mn(yu),Mn(hi),Mn(Ga))};static#e=this.\u0275prov=cr({token:i,factory:i.\u0275fac})}return i})();class hC{constructor(a,l,h,p){this.eventManager=a,this.doc=l,this.ngZone=h,this.platformIsServer=p,this.data=Object.create(null),this.destroyNode=null}destroy(){}createElement(a,l){return l?this.doc.createElementNS(cC[l]||l,a):this.doc.createElement(a)}createComment(a){return this.doc.createComment(a)}createText(a){return this.doc.createTextNode(a)}appendChild(a,l){(S2(a)?a.content:a).appendChild(l)}insertBefore(a,l,h){a&&(S2(a)?a.content:a).insertBefore(l,h)}removeChild(a,l){a&&a.removeChild(l)}selectRootElement(a,l){let h="string"==typeof a?this.doc.querySelector(a):a;if(!h)throw new Bt(-5104,!1);return l||(h.textContent=""),h}parentNode(a){return a.parentNode}nextSibling(a){return a.nextSibling}setAttribute(a,l,h,p){if(p){l=p+":"+l;const _=cC[p];_?a.setAttributeNS(_,l,h):a.setAttribute(l,h)}else a.setAttribute(l,h)}removeAttribute(a,l,h){if(h){const p=cC[h];p?a.removeAttributeNS(p,l):a.removeAttribute(`${h}:${l}`)}else a.removeAttribute(l)}addClass(a,l){a.classList.add(l)}removeClass(a,l){a.classList.remove(l)}setStyle(a,l,h,p){p&(oa.DashCase|oa.Important)?a.style.setProperty(l,h,p&oa.Important?"important":""):a.style[l]=h}removeStyle(a,l,h){h&oa.DashCase?a.style.removeProperty(l):a.style[l]=""}setProperty(a,l,h){a[l]=h}setValue(a,l){a.nodeValue=l}listen(a,l,h){if("string"==typeof a&&!(a=GS().getGlobalEventTarget(this.doc,a)))throw new Error(`Unsupported event target ${a} for event ${l}`);return this.eventManager.addEventListener(a,l,this.decoratePreventDefault(h))}decoratePreventDefault(a){return l=>{if("__ngUnwrap__"===l)return a;!1===(this.platformIsServer?this.ngZone.runGuarded(()=>a(l)):a(l))&&l.preventDefault()}}}function S2(i){return"TEMPLATE"===i.tagName&&void 0!==i.content}class WP extends hC{constructor(a,l,h,p,_,b,T,S){super(a,_,b,S),this.sharedStylesHost=l,this.hostEl=h,this.shadowRoot=h.attachShadow({mode:"open"}),this.sharedStylesHost.addHost(this.shadowRoot);const O=I2(p.id,p.styles);for(const F of O){const G=document.createElement("style");T&&G.setAttribute("nonce",T),G.textContent=F,this.shadowRoot.appendChild(G)}}nodeOrShadowRoot(a){return a===this.hostEl?this.shadowRoot:a}appendChild(a,l){return super.appendChild(this.nodeOrShadowRoot(a),l)}insertBefore(a,l,h){return super.insertBefore(this.nodeOrShadowRoot(a),l,h)}removeChild(a,l){return super.removeChild(this.nodeOrShadowRoot(a),l)}parentNode(a){return this.nodeOrShadowRoot(super.parentNode(this.nodeOrShadowRoot(a)))}destroy(){this.sharedStylesHost.removeHost(this.shadowRoot)}}class dC extends hC{constructor(a,l,h,p,_,b,T,S){super(a,_,b,T),this.sharedStylesHost=l,this.removeStylesOnCompDestroy=p,this.styles=S?I2(S,h.styles):h.styles}applyStyles(){this.sharedStylesHost.addStyles(this.styles)}destroy(){this.removeStylesOnCompDestroy&&this.sharedStylesHost.removeStyles(this.styles)}}class C2 extends dC{constructor(a,l,h,p,_,b,T,S){const O=p+"-"+h.id;super(a,l,h,_,b,T,S,O),this.contentAttr=function HP(i){return"_ngcontent-%COMP%".replace(uC,i)}(O),this.hostAttr=function qP(i){return"_nghost-%COMP%".replace(uC,i)}(O)}applyToHost(a){this.applyStyles(),this.setAttribute(a,this.hostAttr,"")}createElement(a,l){const h=super.createElement(a,l);return super.setAttribute(h,this.contentAttr,""),h}}const A2=["alt","control","meta","shift"],YP={"\b":"Backspace","\t":"Tab","\x7f":"Delete","\x1b":"Escape",Del:"Delete",Esc:"Escape",Left:"ArrowLeft",Right:"ArrowRight",Up:"ArrowUp",Down:"ArrowDown",Menu:"ContextMenu",Scroll:"ScrollLock",Win:"OS"},KP={alt:i=>i.altKey,control:i=>i.ctrlKey,meta:i=>i.metaKey,shift:i=>i.shiftKey};function P2(i){return{appProviders:[...oR,...i?.providers??[]],platformProviders:rR}}const rR=[{provide:yu,useValue:"browser"},{provide:Iy,useValue:function tR(){sC.makeCurrent()},multi:!0},{provide:Bp,useFactory:function nR(){return function sy(i){vc=i}(document),document},deps:[]}],oR=[{provide:Vm,useValue:"root"},{provide:ua,useFactory:function eR(){return new ua},deps:[]},{provide:aC,useClass:(()=>{class i extends E2{constructor(l){super(l)}supports(l){return!0}addEventListener(l,h,p){return l.addEventListener(h,p,!1),()=>this.removeEventListener(l,h,p)}removeEventListener(l,h,p){return l.removeEventListener(h,p)}static#t=this.\u0275fac=function(h){return new(h||i)(Mn(Bp))};static#e=this.\u0275prov=cr({token:i,factory:i.\u0275fac})}return i})(),multi:!0,deps:[Bp,hi,yu]},{provide:aC,useClass:(()=>{class i extends E2{constructor(l){super(l)}supports(l){return null!=i.parseEventName(l)}addEventListener(l,h,p){const _=i.parseEventName(h),b=i.eventCallback(_.fullKey,p,this.manager.getZone());return this.manager.getZone().runOutsideAngular(()=>GS().onAndCancel(l,_.domEventName,b))}static parseEventName(l){const h=l.toLowerCase().split("."),p=h.shift();if(0===h.length||"keydown"!==p&&"keyup"!==p)return null;const _=i._normalizeKey(h.pop());let b="",T=h.indexOf("code");if(T>-1&&(h.splice(T,1),b="code."),A2.forEach(O=>{const F=h.indexOf(O);F>-1&&(h.splice(F,1),b+=O+".")}),b+=_,0!=h.length||0===_.length)return null;const S={};return S.domEventName=p,S.fullKey=b,S}static matchEventFullKeyCode(l,h){let p=YP[l.key]||l.key,_="";return h.indexOf("code.")>-1&&(p=l.code,_="code."),!(null==p||!p)&&(p=p.toLowerCase()," "===p?p="space":"."===p&&(p="dot"),A2.forEach(b=>{b!==p&&(0,KP[b])(l)&&(_+=b+".")}),_+=p,_===h)}static eventCallback(l,h,p){return _=>{i.matchEventFullKeyCode(_,l)&&p.runGuarded(()=>h(_))}}static _normalizeKey(l){return"esc"===l?"escape":l}static#t=this.\u0275fac=function(h){return new(h||i)(Mn(Bp))};static#e=this.\u0275prov=cr({token:i,factory:i.\u0275fac})}return i})(),multi:!0,deps:[Bp]},D2,T2,w2,{provide:K1,useExisting:D2},{provide:class fP{},useClass:jP,deps:[]},[]];typeof window<"u"&&window;var k2=Qi(574),fR=Qi(357);let pR=(()=>{class i{ngOnInit(){k2.accessToken="pk.eyJ1IjoibWFyb29uZWRpb25lIiwiYSI6ImNqdmp0MzB1azBpcDAzem1naHZwMjNndGIifQ.65nvvRg9QeFUV2c6b9W4Vw";const l=new k2.Map({container:"map",style:"mapbox://styles/mapbox/streets-v12",center:[30.31413,59.93863],zoom:10}),h=new fR({displayControlsDefault:!0,controls:{polygon:!0,trash:!0}});l.addControl(h,"top-left"),this.map=l}static#t=this.\u0275fac=function(h){return new(h||i)};static#e=this.\u0275cmp=Ps({type:i,selectors:[["app-map"]],standalone:!0,features:[Bg],decls:4,vars:0,consts:[["id","map"],[1,"tooltip-box"]],template:function(h,p){1&h&&(xd(0,"div",0),vd(1,"div",1)(2,"p"),function P0(i,a=""){const l=qt(),h=Xn(),p=i+zn,_=h.firstCreatePass?Su(h,p,1,a,null):h.data[p],b=R0(h,l,_,a,i);l[p]=b,Fs()&&fu(h,l,b,_),ni(_,!1)}(3,"\u041c\u0435\u043d\u044e \u0434\u043b\u044f \u0440\u0430\u0431\u043e\u0442\u044b \u0441 \u043f\u043e\u043b\u0438\u0433\u043e\u043d\u0430\u043c\u0438 \u0440\u0430\u0441\u043f\u043e\u043b\u043e\u0436\u0435\u043d\u043e \u0441\u043b\u0435\u0432\u0430-\u0441\u0432\u0435\u0440\u0445\u0443."),dp()())},dependencies:[m2],styles:['#map[_ngcontent-%COMP%]{width:100%;height:100vh}.tooltip-box[_ngcontent-%COMP%]{height:50px;width:200px;position:absolute;bottom:30px;left:10px;background-color:#ffffffbf;border-radius:1.25rem;text-align:center;font-family:Roboto,"sans-serif";font-size:.75rem}']})}return i})();(function QP(i,a){return P({rootComponent:i,...P2(a)})})((()=>{class i{static#t=this.\u0275fac=function(h){return new(h||i)};static#e=this.\u0275cmp=Ps({type:i,selectors:[["app-root"]],standalone:!0,features:[Bg],decls:1,vars:0,template:function(h,p){1&h&&xd(0,"app-map")},dependencies:[m2,pR],encapsulation:2})}return i})(),{providers:[]}).catch(i=>console.error(i))},574:function(Zd){Zd.exports=function(){"use strict";var qs,Qi,Ur;function Hl(se,ft){if(qs)if(Qi){var po="self.onerror = function() { console.error('An error occurred while parsing the WebWorker bundle. This is most likely due to improper transpilation by Babel; please see https://docs.mapbox.com/mapbox-gl-js/guides/install/#transpiling'); }; var sharedChunk = {}; ("+qs+")(sharedChunk); ("+Qi+")(sharedChunk); self.onerror = null;",Po={};qs(Po),Ur=ft(Po),typeof window<"u"&&window&&window.URL&&window.URL.createObjectURL&&(Ur.workerUrl=window.URL.createObjectURL(new Blob([po],{type:"text/javascript"})))}else Qi=ft;else qs=ft}return Hl(0,function(se){var ft=typeof self<"u"?self:{},po="3.1.2";let Po;const Te={API_URL:"https://api.mapbox.com",get API_URL_REGEX(){if(null==Po){const e=/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/|\?|$)/i;try{Po=null!=process.env.API_URL_REGEX?new RegExp(process.env.API_URL_REGEX):e}catch{Po=e}}return Po},get API_TILEJSON_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/v[0-9]*\/.*\.json.*$)/i},get API_SPRITE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*\/sprite.*\..*$)/i},get API_FONTS_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/fonts\/v[0-9]*\/)(.*\.pbf.*$)/i},get API_STYLE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*$)/i},get API_CDN_URL_REGEX(){return/^((https?:)?\/\/)?api\.mapbox\.c(n|om)(\/mapbox-gl-js\/)(.*$)/i},get EVENTS_URL(){if(!Te.API_URL)return null;try{const e=new URL(Te.API_URL);return"api.mapbox.cn"===e.hostname?"https://events.mapbox.cn/events/v2":"api.mapbox.com"===e.hostname?"https://events.mapbox.com/events/v2":null}catch{return null}},SESSION_PATH:"/map-sessions/v1",FEEDBACK_URL:"https://apps.mapbox.com/feedback",TILE_URL_VERSION:"v4",RASTER_URL_PREFIX:"raster/v1",REQUIRE_ACCESS_TOKEN:!0,ACCESS_TOKEN:null,DEFAULT_STYLE:"mapbox://styles/mapbox/standard",MAX_PARALLEL_IMAGE_REQUESTS:16,DRACO_URL:"https://api.mapbox.com/mapbox-gl-js/draco_decoder_gltf_v1.5.6.wasm",GLYPHS_URL:"mapbox://fonts/mapbox/{fontstack}/{range}.pbf"},Pr={supported:!1,testSupport:function(e){!Pe&&Zr&&(pn?Bi(e):Hn=e)}};let Hn,Zr,Pe=!1,pn=!1;function Bi(e){const t=e.createTexture();e.bindTexture(e.TEXTURE_2D,t);try{if(e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,Zr),e.isContextLost())return;Pr.supported=!0}catch{}e.deleteTexture(t),Pe=!0}ft.document&&(Zr=ft.document.createElement("img"),Zr.onload=function(){Hn&&Bi(Hn),Hn=null,pn=!0},Zr.onerror=function(){Pe=!0,Hn=null},Zr.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=");const il="01";function rr(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var dr=ss;function ss(e,t,n,r){this.cx=3*e,this.bx=3*(n-e)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*t,this.by=3*(r-t)-this.cy,this.ay=1-this.cy-this.by,this.p1x=e,this.p1y=t,this.p2x=n,this.p2y=r}ss.prototype={sampleCurveX:function(e){return((this.ax*e+this.bx)*e+this.cx)*e},sampleCurveY:function(e){return((this.ay*e+this.by)*e+this.cy)*e},sampleCurveDerivativeX:function(e){return(3*this.ax*e+2*this.bx)*e+this.cx},solveCurveX:function(e,t){if(void 0===t&&(t=1e-6),e<0)return 0;if(e>1)return 1;for(var n=e,r=0;r<8;r++){var o=this.sampleCurveX(n)-e;if(Math.abs(o)<t)return n;var s=this.sampleCurveDerivativeX(n);if(Math.abs(s)<1e-6)break;n-=o/s}var c=0,u=1;for(n=e,r=0;r<20&&(o=this.sampleCurveX(n),!(Math.abs(o-e)<t));r++)e>o?c=n:u=n,n=.5*(u-c)+c;return n},solve:function(e,t){return this.sampleCurveY(this.solveCurveX(e,t))}};var ql=rr(dr),ya=as;function as(e,t){this.x=e,this.y=t}as.prototype={clone:function(){return new as(this.x,this.y)},add:function(e){return this.clone()._add(e)},sub:function(e){return this.clone()._sub(e)},multByPoint:function(e){return this.clone()._multByPoint(e)},divByPoint:function(e){return this.clone()._divByPoint(e)},mult:function(e){return this.clone()._mult(e)},div:function(e){return this.clone()._div(e)},rotate:function(e){return this.clone()._rotate(e)},rotateAround:function(e,t){return this.clone()._rotateAround(e,t)},matMult:function(e){return this.clone()._matMult(e)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(e){return this.x===e.x&&this.y===e.y},dist:function(e){return Math.sqrt(this.distSqr(e))},distSqr:function(e){var t=e.x-this.x,n=e.y-this.y;return t*t+n*n},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(e){return Math.atan2(this.y-e.y,this.x-e.x)},angleWith:function(e){return this.angleWithSep(e.x,e.y)},angleWithSep:function(e,t){return Math.atan2(this.x*t-this.y*e,this.x*e+this.y*t)},_matMult:function(e){var t=e[2]*this.x+e[3]*this.y;return this.x=e[0]*this.x+e[1]*this.y,this.y=t,this},_add:function(e){return this.x+=e.x,this.y+=e.y,this},_sub:function(e){return this.x-=e.x,this.y-=e.y,this},_mult:function(e){return this.x*=e,this.y*=e,this},_div:function(e){return this.x/=e,this.y/=e,this},_multByPoint:function(e){return this.x*=e.x,this.y*=e.y,this},_divByPoint:function(e){return this.x/=e.x,this.y/=e.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var e=this.y;return this.y=this.x,this.x=-e,this},_rotate:function(e){var t=Math.cos(e),n=Math.sin(e),r=n*this.x+t*this.y;return this.x=t*this.x-n*this.y,this.y=r,this},_rotateAround:function(e,t){var n=Math.cos(e),r=Math.sin(e),o=t.y+r*(this.x-t.x)+n*(this.y-t.y);return this.x=t.x+n*(this.x-t.x)-r*(this.y-t.y),this.y=o,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},as.convert=function(e){return e instanceof as?e:Array.isArray(e)?new as(e[0],e[1]):e};var it=rr(ya);function tn(e,t){if(Array.isArray(e)){if(!Array.isArray(t)||e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(!tn(e[n],t[n]))return!1;return!0}if("object"==typeof e&&null!==e&&null!==t){if("object"!=typeof t||Object.keys(e).length!==Object.keys(t).length)return!1;for(const n in e)if(!tn(e[n],t[n]))return!1;return!0}return e===t}const va=Math.PI/180,ti=180/Math.PI;function Oe(e){return e*va}function fr(e){return e*ti}const nh=[[0,0],[1,0],[1,1],[0,1]];function ls(e){if(e<=0)return 0;if(e>=1)return 1;const t=e*e,n=t*e;return 4*(e<.5?n:3*(e-t)+n-.75)}function ol(e){let t=1/0,n=1/0,r=-1/0,o=-1/0;for(const s of e)t=Math.min(t,s.x),n=Math.min(n,s.y),r=Math.max(r,s.x),o=Math.max(o,s.y);return{min:new it(t,n),max:new it(r,o)}}function xa(e,t,n=0,r=!0){const o=new it(n,n),s=e.sub(o),c=t.add(o),u=[s,new it(c.x,s.y),c,new it(s.x,c.y)];return r&&u.push(s.clone()),u}function Ds(e,t,n,r){const o=new ql(e,t,n,r);return function(s){return o.solve(s)}}const Tr=Ds(.25,.1,.25,1);function ne(e,t,n){return Math.min(n,Math.max(t,e))}function Ro(e,t,n){return(n=ne((n-e)/(t-e),0,1))*n*(3-2*n)}function Rr(e,t,n){const r=n-t,o=((e-t)%r+r)%r+t;return o===t?n:o}function mo(e,t,n){if(!e.length)return n(null,[]);let r=e.length;const o=new Array(e.length);let s=null;e.forEach((c,u)=>{t(c,(d,f)=>{d&&(s=d),o[u]=f,0==--r&&n(s,o)})})}function _i(e){const t=[];for(const n in e)t.push(e[n]);return t}function Wt(e,...t){for(const n of t)for(const r in n)e[r]=n[r];return e}function to(e,t){const n={};for(let r=0;r<t.length;r++){const o=t[r];o in e&&(n[o]=e[o])}return n}let Lo=1;function Dr(){return Lo++}function _n(){return function e(t){return t?(t^Math.random()*(16>>t/4)).toString(16):([1e7]+-[1e3]+-4e3+-8e3+-1e11).replace(/[018]/g,e)}()}function Fc(e){return e<=1?1:Math.pow(2,Math.ceil(Math.log(e)/Math.LN2))}function Zl(e){return!!e&&/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e)}function ei(e,t){e.forEach(n=>{t[n]&&(t[n]=t[n].bind(t))})}function Oo(e,t){return-1!==e.indexOf(t,e.length-t.length)}function Wl(e,t,n){const r={};for(const o in e)r[o]=t.call(n||this,e[o],o,e);return r}function St(e,t,n){const r={};for(const o in e)t.call(n||this,e[o],o,e)&&(r[o]=e[o]);return r}function q(e){return Array.isArray(e)?e.map(q):"object"==typeof e&&e?Wl(e,q):e}const X={};function nt(e){X[e]||(typeof console<"u"&&console.warn(e),X[e]=!0)}function At(e,t,n){return(n.y-e.y)*(t.x-e.x)>(t.y-e.y)*(n.x-e.x)}function Lt(e){let t=0;for(let n,r,o=0,s=e.length,c=s-1;o<s;c=o++)n=e[o],r=e[c],t+=(r.x-n.x)*(n.y+r.y);return t}function Jt([e,t,n]){const r=Oe(t+90),o=Oe(n);return{x:e*Math.cos(r)*Math.sin(o),y:e*Math.sin(r)*Math.sin(o),z:e*Math.cos(o),azimuthal:t,polar:n}}function ae(e,t,n){const r=Math.sqrt(e*e+t*t+n*n),o=r>0?Math.acos(n/r)*ti:0;let s=0!==e||0!==t?Math.atan2(-t,-e)*ti+90:0;return s<0&&(s+=360),[r,s,o]}function Pt(){return typeof WorkerGlobalScope<"u"&&typeof self<"u"&&self instanceof WorkerGlobalScope}function pe(e){const t={};if(e.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(n,r,o,s)=>{const c=o||s;return t[r]=!c||c.toLowerCase(),""}),t["max-age"]){const n=parseInt(t["max-age"],10);isNaN(n)?delete t["max-age"]:t["max-age"]=n}return t}let _e=null;function Ee(){return!!ft.document.fullscreenElement||!!ft.document.webkitFullscreenElement}function Cn(e){try{const t=ft[e];return t.setItem("_mapbox_test_",1),t.removeItem("_mapbox_test_"),!0}catch{return!1}}function nr(e,t){return[e[4*t],e[4*t+1],e[4*t+2],e[4*t+3]]}function Lr(e,t,n){e[4*t+0]=n[0],e[4*t+1]=n[1],e[4*t+2]=n[2],e[4*t+3]=n[3]}function Jn(e,t){return[Math.pow(e[0],2.2)*t,Math.pow(e[1],2.2)*t,Math.pow(e[2],2.2)*t]}function Fn(e){return[Math.pow(e[0],1/2.2),Math.pow(e[1],1/2.2),Math.pow(e[2],1/2.2)]}const Nn="mapbox-tiles";let oi,cs,Ii=500,ji=50;function ba(){try{return ft.caches}catch{}}function di(){ba()&&!oi&&(oi=ft.caches.open(Nn))}function Ss(e){const t=e.indexOf("?");if(t<0)return e;const r=function(o){const s=o.indexOf("?");return s>0?o.slice(s+1).split("&"):[]}(e).filter(o=>{const s=o.split("=");return"language"===s[0]||"worldview"===s[0]});return r.length?`${e.slice(0,t)}?${r.join("&")}`:e.slice(0,t)}let us=1/0;function Vi(e){us++,us>ji&&(e.getActor().send("enforceCacheSizeLimit",Ii),us=0)}const yt={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Image:"Image",Model:"Model"};"function"==typeof Object.freeze&&Object.freeze(yt);class It extends Error{constructor(t,n,r){401===n&&vn(r)&&(t+=": you may have provided an invalid Mapbox access token. See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes"),super(t),this.status=n,this.url=r}toString(){return`${this.name}: ${this.message} (${this.status}): ${this.url}`}}const kt=Pt()?()=>self.worker&&self.worker.referrer:()=>("blob:"===ft.location.protocol?ft.parent:ft).location.href,jt=function(e,t){if(!(/^file:/.test(n=e.url)||/^file:/.test(kt())&&!/^\w+:/.test(n))){if(ft.fetch&&ft.Request&&ft.AbortController&&ft.Request.prototype.hasOwnProperty("signal"))return function(r,o){const s=new ft.AbortController,c=new ft.Request(r.url,{method:r.method||"GET",body:r.body,credentials:r.credentials,headers:r.headers,referrer:kt(),referrerPolicy:r.referrerPolicy,signal:s.signal});let u=!1,d=!1;const f=(m=c.url).indexOf("sku=")>0&&vn(m);var m;"json"===r.type&&c.headers.set("Accept","application/json");const g=(v,x,w)=>{if(d)return;if(v&&"SecurityError"!==v.message&&nt(v.toString()),x&&w)return y(x);const E=Date.now();ft.fetch(c).then(M=>{if(M.ok){const D=f?M.clone():null;return y(M,D,E)}return o(new It(M.statusText,M.status,r.url))}).catch(M=>{"AbortError"!==M.name&&o(new Error(`${M.message} ${r.url}`))})},y=(v,x,w)=>{("arrayBuffer"===r.type?v.arrayBuffer():"json"===r.type?v.json():v.text()).then(E=>{d||(x&&w&&function(M,D,A){if(di(),!oi)return;const P={status:D.status,statusText:D.statusText,headers:new ft.Headers};D.headers.forEach((k,N)=>P.headers.set(N,k));const C=pe(D.headers.get("Cache-Control")||"");if(C["no-store"])return;C["max-age"]&&P.headers.set("Expires",new Date(A+1e3*C["max-age"]).toUTCString());const R=P.headers.get("Expires");R&&(new Date(R).getTime()-A<42e4||function(k,N){if(void 0===cs)try{new Response(new ReadableStream),cs=!0}catch{cs=!1}cs?N(k.body):k.blob().then(N)}(D,k=>{const N=new ft.Response(k,P);di(),oi&&oi.then(z=>z.put(Ss(M.url),N)).catch(z=>nt(z.message))}))}(c,x,w),u=!0,o(null,E,v.headers.get("Cache-Control"),v.headers.get("Expires")))}).catch(E=>{d||o(new Error(E.message))})};return f?function(v,x){if(di(),!oi)return x(null);const w=Ss(v.url);oi.then(E=>{E.match(w).then(M=>{const D=function(A){if(!A)return!1;const P=new Date(A.headers.get("Expires")||0),C=pe(A.headers.get("Cache-Control")||"");return P>Date.now()&&!C["no-cache"]}(M);E.delete(w),D&&E.put(w,M.clone()),x(null,M,D)}).catch(x)}).catch(x)}(c,g):g(null,null),{cancel:()=>{d=!0,u||s.abort()}}}(e,t);if(Pt()&&self.worker&&self.worker.actor)return self.worker.actor.send("getResource",e,t,void 0,!0)}var n;return function(r,o){const s=new ft.XMLHttpRequest;s.open(r.method||"GET",r.url,!0),"arrayBuffer"===r.type&&(s.responseType="arraybuffer");for(const c in r.headers)s.setRequestHeader(c,r.headers[c]);return"json"===r.type&&(s.responseType="text",s.setRequestHeader("Accept","application/json")),s.withCredentials="include"===r.credentials,s.onerror=()=>{o(new Error(s.statusText))},s.onload=()=>{if((s.status>=200&&s.status<300||0===s.status)&&null!==s.response){let c=s.response;if("json"===r.type)try{c=JSON.parse(s.response)}catch(u){return o(u)}o(null,c,s.getResponseHeader("Cache-Control"),s.getResponseHeader("Expires"))}else o(new It(s.statusText,s.status,r.url))},s.send(r.body),{cancel:()=>s.abort()}}(e,t)},zt=function(e,t){return jt(Wt(e,{type:"json"}),t)},$t=function(e,t){return jt(Wt(e,{type:"arrayBuffer"}),t)};function Zt(e){const t=ft.document.createElement("a");return t.href=e,t.protocol===ft.document.location.protocol&&t.host===ft.document.location.host}const Vt="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";let ee,Ht;ee=[],Ht=0;const xe=function(e,t){if(Pr.supported&&(e.headers||(e.headers={}),e.headers.accept="image/webp,*/*"),Ht>=Te.MAX_PARALLEL_IMAGE_REQUESTS){const s={requestParameters:e,callback:t,cancelled:!1,cancel(){this.cancelled=!0}};return ee.push(s),s}Ht++;let n=!1;const r=()=>{if(!n)for(n=!0,Ht--;ee.length&&Ht<Te.MAX_PARALLEL_IMAGE_REQUESTS;){const s=ee.shift(),{requestParameters:c,callback:u,cancelled:d}=s;d||(s.cancel=xe(c,u).cancel)}},o=$t(e,(s,c,u,d)=>{r(),s?t(s):c&&(ft.createImageBitmap?function(f,m){const g=new ft.Blob([new Uint8Array(f)],{type:"image/png"});ft.createImageBitmap(g).then(y=>{m(null,y)}).catch(y=>{m(new Error(`Could not load image because of ${y.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`))})}(c,(f,m)=>t(f,m,u,d)):function(f,m){const g=new ft.Image,y=ft.URL;g.onload=()=>{m(null,g),y.revokeObjectURL(g.src),g.onload=null,ft.requestAnimationFrame(()=>{g.src=Vt})},g.onerror=()=>m(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const v=new ft.Blob([new Uint8Array(f)],{type:"image/png"});g.src=f.byteLength?y.createObjectURL(v):Vt}(c,(f,m)=>t(f,m,u,d)))});return{cancel:()=>{o.cancel(),r()}}},wn="NO_ACCESS_TOKEN";class ge{constructor(t,n,r){this._transformRequestFn=t,this._customAccessToken=n,this._silenceAuthErrors=!!r,this._createSkuToken()}_createSkuToken(){const t=function(){let n="";for(let r=0;r<10;r++)n+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return{token:["1",il,n].join(""),tokenExpiresAt:Date.now()+432e5}}();this._skuToken=t.token,this._skuTokenExpiresAt=t.tokenExpiresAt}_isSkuTokenExpired(){return Date.now()>this._skuTokenExpiresAt}transformRequest(t,n){return this._transformRequestFn&&this._transformRequestFn(t,n)||{url:t}}normalizeStyleURL(t,n){if(!mn(t))return t;const r=Wr(t);return r.params.push(`sdk=js-${po}`),r.path=`/styles/v1${r.path}`,this._makeAPIURL(r,this._customAccessToken||n)}normalizeGlyphsURL(t,n){if(!mn(t))return t;const r=Wr(t);return r.path=`/fonts/v1${r.path}`,this._makeAPIURL(r,this._customAccessToken||n)}normalizeModelURL(t,n){if(!mn(t))return t;const r=Wr(t);return r.path=`/models/v1${r.path}`,this._makeAPIURL(r,this._customAccessToken||n)}normalizeSourceURL(t,n,r,o){if(!mn(t))return t;const s=Wr(t);return s.path=`/v4/${s.authority}.json`,s.params.push("secure"),r&&s.params.push(`language=${r}`),o&&s.params.push(`worldview=${o}`),this._makeAPIURL(s,this._customAccessToken||n)}normalizeSpriteURL(t,n,r,o){const s=Wr(t);return mn(t)?(s.path=`/styles/v1${s.path}/sprite${n}${r}`,this._makeAPIURL(s,this._customAccessToken||o)):(s.path+=`${n}${r}`,ir(s))}normalizeTileURL(t,n,r){if(this._isSkuTokenExpired()&&this._createSkuToken(),t&&!mn(t))return t;const o=Wr(t);o.path=o.path.replace(/(\.(png|jpg)\d*)(?=$)/,`${n||r&&"raster"!==o.authority&&512===r?"@2x":""}${Pr.supported?".webp":"$1"}`),"raster"===o.authority?o.path=`/${Te.RASTER_URL_PREFIX}${o.path}`:(o.path=o.path.replace(/^.+\/v4\//,"/"),o.path=`/${Te.TILE_URL_VERSION}${o.path}`);const s=this._customAccessToken||function(c){for(const u of c){const d=u.match(/^access_token=(.*)$/);if(d)return d[1]}return null}(o.params)||Te.ACCESS_TOKEN;return Te.REQUIRE_ACCESS_TOKEN&&s&&this._skuToken&&o.params.push(`sku=${this._skuToken}`),this._makeAPIURL(o,s)}canonicalizeTileURL(t,n){const r=Wr(t);if(!r.path.match(/^(\/v4\/|\/raster\/v1\/)/)||!r.path.match(/\.[\w]+$/))return t;let o="mapbox://";r.path.match(/^\/raster\/v1\//)?o+=`raster/${r.path.replace(`/${Te.RASTER_URL_PREFIX}/`,"")}`:o+=`tiles/${r.path.replace(`/${Te.TILE_URL_VERSION}/`,"")}`;let s=r.params;return n&&(s=s.filter(c=>!c.match(/^access_token=/))),s.length&&(o+=`?${s.join("&")}`),o}canonicalizeTileset(t,n){const r=!!n&&mn(n),o=[];for(const s of t.tiles||[])vn(s)?o.push(this.canonicalizeTileURL(s,r)):o.push(s);return o}_makeAPIURL(t,n){const r="See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes",o=Wr(Te.API_URL);if(t.protocol=o.protocol,t.authority=o.authority,"http"===t.protocol){const s=t.params.indexOf("secure");s>=0&&t.params.splice(s,1)}if("/"!==o.path&&(t.path=`${o.path}${t.path}`),!Te.REQUIRE_ACCESS_TOKEN)return ir(t);if(n=n||Te.ACCESS_TOKEN,!this._silenceAuthErrors){if(!n)throw new Error(`An API access token is required to use Mapbox GL. ${r}`);if("s"===n[0])throw new Error(`Use a public access token (pk.*) with Mapbox GL, not a secret access token (sk.*). ${r}`)}return t.params=t.params.filter(s=>-1===s.indexOf("access_token")),t.params.push(`access_token=${n||""}`),ir(t)}}function mn(e){return 0===e.indexOf("mapbox:")}function vn(e){return Te.API_URL_REGEX.test(e)}function pr(e){return Te.API_CDN_URL_REGEX.test(e)}function Mr(e){return Te.API_STYLE_REGEX.test(e)&&!si(e)}function si(e){return Te.API_SPRITE_REGEX.test(e)}const ko=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function Wr(e){const t=e.match(ko);if(!t)throw new Error("Unable to parse URL object");return{protocol:t[1],authority:t[2],path:t[3]||"/",params:t[4]?t[4].split("&"):[]}}function ir(e){const t=e.params.length?`?${e.params.join("&")}`:"";return`${e.protocol}://${e.authority}${e.path}${t}`}const Di="mapbox.eventData";function go(e){if(!e)return null;const t=e.split(".");if(!t||3!==t.length)return null;try{return JSON.parse(decodeURIComponent(ft.atob(t[1]).split("").map(n=>"%"+("00"+n.charCodeAt(0).toString(16)).slice(-2)).join("")))}catch{return null}}class wa{constructor(t){this.type=t,this.anonId=null,this.eventData={},this.queue=[],this.pendingRequest=null}getStorageKey(t){const n=go(Te.ACCESS_TOKEN);let r="";return r=n&&n.u?ft.btoa(encodeURIComponent(n.u).replace(/%([0-9A-F]{2})/g,(o,s)=>String.fromCharCode(+("0x"+s)))):Te.ACCESS_TOKEN||"",t?`${Di}.${t}:${r}`:`${Di}:${r}`}fetchEventData(){const t=Cn("localStorage"),n=this.getStorageKey(),r=this.getStorageKey("uuid");if(t)try{const o=ft.localStorage.getItem(n);o&&(this.eventData=JSON.parse(o));const s=ft.localStorage.getItem(r);s&&(this.anonId=s)}catch{nt("Unable to read from LocalStorage")}}saveEventData(){const t=Cn("localStorage"),n=this.getStorageKey(),r=this.getStorageKey("uuid");if(t)try{ft.localStorage.setItem(r,this.anonId),Object.keys(this.eventData).length>=1&&ft.localStorage.setItem(n,JSON.stringify(this.eventData))}catch{nt("Unable to write to LocalStorage")}}processRequests(t){}postEvent(t,n,r,o){if(!Te.EVENTS_URL)return;const s=Wr(Te.EVENTS_URL);s.params.push(`access_token=${o||Te.ACCESS_TOKEN||""}`);const c={event:this.type,created:new Date(t).toISOString()},u=n?Wt(c,n):c,d={url:ir(s),headers:{"Content-Type":"text/plain"},body:JSON.stringify([u])};var m;this.pendingRequest=(m=f=>{this.pendingRequest=null,r(f),this.saveEventData(),this.processRequests(o)},jt(Wt(d,{method:"POST"}),m))}queueRequest(t,n){this.queue.push(t),this.processRequests(n)}}const Ea=new class extends wa{constructor(e){super("appUserTurnstile"),this._customAccessToken=e}postTurnstileEvent(e,t){Te.EVENTS_URL&&Te.ACCESS_TOKEN&&Array.isArray(e)&&e.some(n=>mn(n)||vn(n))&&this.queueRequest(Date.now(),t)}processRequests(e){if(this.pendingRequest||0===this.queue.length)return;this.anonId&&this.eventData.lastSuccess&&this.eventData.tokenU||this.fetchEventData();const t=go(Te.ACCESS_TOKEN),n=t?t.u:Te.ACCESS_TOKEN;let r=n!==this.eventData.tokenU;Zl(this.anonId)||(this.anonId=_n(),r=!0);const o=this.queue.shift();if(this.eventData.lastSuccess){const s=new Date(this.eventData.lastSuccess),c=new Date(o),u=(o-this.eventData.lastSuccess)/864e5;r=r||u>=1||u<-1||s.getDate()!==c.getDate()}else r=!0;r?this.postEvent(o,{sdkIdentifier:"mapbox-gl-js",sdkVersion:po,skuId:il,"enabled.telemetry":!1,userId:this.anonId},s=>{s||(this.eventData.lastSuccess=o,this.eventData.tokenU=n)},e):this.processRequests()}},Xd=Ea.postTurnstileEvent.bind(Ea),Nc=new class extends wa{constructor(){super("map.load"),this.success={},this.skuToken=""}postMapLoadEvent(e,t,n,r){this.skuToken=t,this.errorCb=r,Te.EVENTS_URL&&(n||Te.ACCESS_TOKEN?this.queueRequest({id:e,timestamp:Date.now()},n):this.errorCb(new Error(wn)))}processRequests(e){if(this.pendingRequest||0===this.queue.length)return;const{id:t,timestamp:n}=this.queue.shift();t&&this.success[t]||(this.anonId||this.fetchEventData(),Zl(this.anonId)||(this.anonId=_n()),this.postEvent(n,{sdkIdentifier:"mapbox-gl-js",sdkVersion:po,skuId:il,skuToken:this.skuToken,userId:this.anonId},r=>{r?this.errorCb(r):t&&(this.success[t]=!0)},e))}},ex=Nc.postMapLoadEvent.bind(Nc),zc=new class extends wa{constructor(){super("gljs.performance")}postPerformanceEvent(e,t){Te.EVENTS_URL&&(e||Te.ACCESS_TOKEN)&&this.queueRequest({timestamp:Date.now(),performanceData:t},e)}processRequests(e){if(this.pendingRequest||0===this.queue.length)return;const{timestamp:t,performanceData:n}=this.queue.shift(),r=function(o){const s=ft.performance.getEntriesByType("resource"),c=ft.performance.getEntriesByType("mark"),u=function(y){const v={};if(y)for(const x in y)if("other"!==x)for(const w of y[x]){const E=`${x}ResolveRangeMin`,M=`${x}ResolveRangeMax`,D=`${x}RequestCount`,A=`${x}RequestCachedCount`;v[E]=Math.min(v[E]||1/0,w.startTime),v[M]=Math.max(v[M]||-1/0,w.responseEnd);const P=C=>{void 0===v[C]&&(v[C]=0),++v[C]};void 0!==w.transferSize&&0===w.transferSize&&P(A),P(D)}return v}(function(y,v){const x={};if(y)for(const w of y){const E=v(w);void 0===x[E]&&(x[E]=[]),x[E].push(w)}return x}(s,rh)),d=ft.devicePixelRatio,f=ft.navigator.connection||ft.navigator.mozConnection||ft.navigator.webkitConnection,m={counters:[],metadata:[],attributes:[]},g=(y,v,x)=>{null!=x&&y.push({name:v,value:x.toString()})};for(const y in u)g(m.counters,y,u[y]);if(o.interactionRange[0]!==1/0&&o.interactionRange[1]!==-1/0&&(g(m.counters,"interactionRangeMin",o.interactionRange[0]),g(m.counters,"interactionRangeMax",o.interactionRange[1])),c)for(const y of Object.keys(Fo)){const v=Fo[y],x=c.find(w=>w.name===v);x&&g(m.counters,v,x.startTime)}return g(m.counters,"visibilityHidden",o.visibilityHidden),g(m.attributes,"style",function(y){if(y)for(const v of y){const x=v.name.split("?")[0];if(Mr(x)){const w=x.split("/").slice(-2);if(2===w.length)return`mapbox://styles/${w[0]}/${w[1]}`}}}(s)),g(m.attributes,"terrainEnabled",o.terrainEnabled?"true":"false"),g(m.attributes,"fogEnabled",o.fogEnabled?"true":"false"),g(m.attributes,"projection",o.projection),g(m.attributes,"zoom",o.zoom),g(m.metadata,"devicePixelRatio",d),g(m.metadata,"connectionEffectiveType",f?f.effectiveType:void 0),g(m.metadata,"navigatorUserAgent",ft.navigator.userAgent),g(m.metadata,"screenWidth",ft.screen.width),g(m.metadata,"screenHeight",ft.screen.height),g(m.metadata,"windowWidth",ft.innerWidth),g(m.metadata,"windowHeight",ft.innerHeight),g(m.metadata,"mapWidth",o.width/d),g(m.metadata,"mapHeight",o.height/d),g(m.metadata,"webglRenderer",o.renderer),g(m.metadata,"webglVendor",o.vendor),g(m.metadata,"sdkVersion",po),g(m.metadata,"sdkIdentifier","mapbox-gl-js"),m}(n);for(const o of r.metadata);for(const o of r.counters);for(const o of r.attributes);this.postEvent(t,r,()=>{},e)}},Yd=zc.postPerformanceEvent.bind(zc),Xl=new class extends wa{constructor(){super("map.auth"),this.success={},this.skuToken=""}getSession(e,t,n,r){if(!Te.API_URL||!Te.SESSION_PATH)return;const o=Wr(Te.API_URL+Te.SESSION_PATH);o.params.push(`sku=${t||""}`),o.params.push(`access_token=${r||Te.ACCESS_TOKEN||""}`);const s={url:ir(o),headers:{"Content-Type":"text/plain"}};var u;this.pendingRequest=(u=c=>{this.pendingRequest=null,n(c),this.saveEventData(),this.processRequests(r)},jt(Wt(s,{method:"GET"}),u))}getSessionAPI(e,t,n,r){this.skuToken=t,this.errorCb=r,Te.SESSION_PATH&&Te.API_URL&&(n||Te.ACCESS_TOKEN?this.queueRequest({id:e,timestamp:Date.now()},n):this.errorCb(new Error(wn)))}processRequests(e){if(this.pendingRequest||0===this.queue.length)return;const{id:t,timestamp:n}=this.queue.shift();t&&this.success[t]||this.getSession(n,this.skuToken,r=>{r?this.errorCb(r):t&&(this.success[t]=!0)},e)}},yi=Xl.getSessionAPI.bind(Xl),Yl=new Set;function Kd(e,t){t?Yl.add(e):Yl.delete(e)}const Fo={create:"create",load:"load",fullLoad:"fullLoad"},No={mark(e){ft.performance.mark(e)},measure(e,t,n){ft.performance.measure(e,t,n)}};function rh(e){const t=e.name.split("?")[0];return pr(t)&&t.includes("mapbox-gl.js")?"javascript":pr(t)&&t.includes("mapbox-gl.css")?"css":Te.API_FONTS_REGEX.test(t)?"fontRange":si(t)?"sprite":Mr(t)?"style":Te.API_TILEJSON_REGEX.test(t)?"tilejson":"other"}const sl=ft.performance;function Ta(e){const t=e?e.url.toString():void 0;return sl.getEntriesByName(t)}var Jd=ih;function ih(e){return t=e,!(typeof window>"u"||typeof document>"u"||!(Array.prototype&&Array.prototype.every&&Array.prototype.filter&&Array.prototype.forEach&&Array.prototype.indexOf&&Array.prototype.lastIndexOf&&Array.prototype.map&&Array.prototype.some&&Array.prototype.reduce&&Array.prototype.reduceRight&&Array.isArray)||!Function.prototype||!Function.prototype.bind||!(Object.keys&&Object.create&&Object.getPrototypeOf&&Object.getOwnPropertyNames&&Object.isSealed&&Object.isFrozen&&Object.isExtensible&&Object.getOwnPropertyDescriptor&&Object.defineProperty&&Object.defineProperties&&Object.seal&&Object.freeze&&Object.preventExtensions)||!("JSON"in window&&"parse"in JSON&&"stringify"in JSON)||!function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;var r,o,s=new Blob([""],{type:"text/javascript"}),c=URL.createObjectURL(s);try{o=new Worker(c),r=!0}catch{r=!1}return o&&o.terminate(),URL.revokeObjectURL(c),r}()||!("Uint8ClampedArray"in window)||!ArrayBuffer.isView||!function(){var r=document.createElement("canvas");r.width=r.height=1;var o=r.getContext("2d");if(!o)return!1;var s=o.getImageData(0,0,1,1);return s&&s.width===r.width}()||(void 0===Qd[n=t&&t.failIfMajorPerformanceCaveat]&&(Qd[n]=function(r){var o,c,u,d,s=(c=r,u=document.createElement("canvas"),(d=Object.create(ih.webGLContextAttributes)).failIfMajorPerformanceCaveat=c,u.getContext("webgl",d)||u.getContext("experimental-webgl",d));if(!s)return!1;try{o=s.createShader(s.VERTEX_SHADER)}catch{return!1}return!(!o||s.isContextLost())&&(s.shaderSource(o,"void main() {}"),s.compileShader(o),!0===s.getShaderParameter(o,s.COMPILE_STATUS))}(n)),!Qd[n]||document.documentMode));var t,n}var Qd={};let tf,Kl,Bc,jc,Ma;function ef(){return null==tf&&(tf=ft.OffscreenCanvas&&new ft.OffscreenCanvas(1,1).getContext("2d")&&"function"==typeof ft.createImageBitmap),tf}ih.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0};const De={now:()=>void 0!==jc?jc:ft.performance.now(),setNow(e){jc=e},restoreNow(){jc=void 0},frame(e){const t=ft.requestAnimationFrame(e);return{cancel:()=>ft.cancelAnimationFrame(t)}},getImageData(e,t=0){const{width:n,height:r}=e;Ma||(Ma=ft.document.createElement("canvas"));const o=Ma.getContext("2d",{willReadFrequently:!0});if(!o)throw new Error("failed to create canvas 2d context");return(n>Ma.width||r>Ma.height)&&(Ma.width=n,Ma.height=r),o.clearRect(-t,-t,n+2*t,r+2*t),o.drawImage(e,0,0,n,r),o.getImageData(-t,-t,n+2*t,r+2*t)},resolveURL:e=>(Kl||(Kl=ft.document.createElement("a")),Kl.href=e,Kl.href),get devicePixelRatio(){return ft.devicePixelRatio},get prefersReducedMotion(){return!!ft.matchMedia&&(null==Bc&&(Bc=ft.matchMedia("(prefers-reduced-motion: reduce)")),Bc.matches)},hasCanvasFingerprintNoise(){if(!ef())return!1;const e=new ft.OffscreenCanvas(85,1),t=e.getContext("2d",{willReadFrequently:!0});let n=0;for(let o=0;o<e.width;++o)t.fillStyle=`rgba(${n++},${n++},${n++}, 255)`,t.fillRect(o,0,1,1);const r=t.getImageData(0,0,e.width,e.height);n=0;for(let o=0;o<r.data.length;++o)if(o%4!=3&&n++!==r.data[o])return!0;return!1}};function jn(e,t,n){const r=ft.document.createElement(e);return void 0!==t&&(r.className=t),n&&n.appendChild(r),r}function zo(e,t,n){const r=ft.document.createElementNS("http://www.w3.org/2000/svg",e);for(const o of Object.keys(t))r.setAttributeNS(null,o,t[o]);return n&&n.appendChild(r),r}const I=ft.document&&ft.document.documentElement.style,L=I&&void 0!==I.userSelect?"userSelect":"WebkitUserSelect";let j;function tt(){I&&L&&(j=I[L],I[L]="none")}function lt(){I&&L&&(I[L]=j)}function ut(e){e.preventDefault(),e.stopPropagation(),ft.removeEventListener("click",ut,!0)}function gt(){ft.addEventListener("click",ut,!0),ft.setTimeout(()=>{ft.removeEventListener("click",ut,!0)},0)}function Et(e,t){const n=e.getBoundingClientRect();return de(e,n,t)}function Xt(e,t){const n=e.getBoundingClientRect(),r=[];for(let o=0;o<t.length;o++)r.push(de(e,n,t[o]));return r}function ce(e){return void 0!==ft.InstallTrigger&&2===e.button&&e.ctrlKey&&ft.navigator.platform.toUpperCase().indexOf("MAC")>=0?0:e.button}function de(e,t,n){const r=e.offsetWidth===t.width?1:e.offsetWidth/t.width;return new it((n.clientX-t.left)*r,(n.clientY-t.top)*r)}function oe(e,t,n){n[e]&&-1!==n[e].indexOf(t)||(n[e]=n[e]||[],n[e].push(t))}function Bt(e,t,n){if(n&&n[e]){const r=n[e].indexOf(t);-1!==r&&n[e].splice(r,1)}}class Mt{constructor(t,n={}){Wt(this,n),this.type=t}}class Tt extends Mt{constructor(t,n={}){super("error",Wt({error:t},n))}}class ye{on(t,n){return this._listeners=this._listeners||{},oe(t,n,this._listeners),this}off(t,n){return Bt(t,n,this._listeners),Bt(t,n,this._oneTimeListeners),this}once(t,n){return n?(this._oneTimeListeners=this._oneTimeListeners||{},oe(t,n,this._oneTimeListeners),this):new Promise(r=>this.once(t,r))}fire(t,n){"string"==typeof t&&(t=new Mt(t,n||{}));const r=t.type;if(this.listens(r)){t.target=this;const o=this._listeners&&this._listeners[r]?this._listeners[r].slice():[];for(const u of o)u.call(this,t);const s=this._oneTimeListeners&&this._oneTimeListeners[r]?this._oneTimeListeners[r].slice():[];for(const u of s)Bt(r,u,this._oneTimeListeners),u.call(this,t);const c=this._eventedParent;c&&(Wt(t,"function"==typeof this._eventedParentData?this._eventedParentData():this._eventedParentData),c.fire(t))}else t instanceof Tt&&console.error(t.error);return this}listens(t){return!!(this._listeners&&this._listeners[t]&&this._listeners[t].length>0||this._oneTimeListeners&&this._oneTimeListeners[t]&&this._oneTimeListeners[t].length>0||this._eventedParent&&this._eventedParent.listens(t))}setEventedParent(t,n){return this._eventedParent=t,this._eventedParentData=n,this}}var H=JSON.parse('{"$version":8,"$root":{"version":{"required":true,"type":"enum","values":[8]},"fragment":{"type":"boolean"},"name":{"type":"string"},"metadata":{"type":"*"},"center":{"type":"array","value":"number"},"zoom":{"type":"number"},"bearing":{"type":"number","default":0,"period":360},"pitch":{"type":"number","default":0},"light":{"type":"light"},"lights":{"required":false,"type":"array","value":"light-3d"},"terrain":{"type":"terrain","optional":true},"fog":{"type":"fog"},"camera":{"type":"camera"},"imports":{"type":"array","value":"import"},"schema":{"type":"schema"},"sources":{"required":true,"type":"sources"},"sprite":{"type":"string"},"glyphs":{"type":"string","default":"mapbox://fonts/mapbox/{fontstack}/{range}.pbf"},"transition":{"type":"transition"},"projection":{"type":"projection"},"layers":{"required":true,"type":"array","value":"layer"},"models":{"type":"models"}},"model":{"type":"string","required":true},"import":{"id":{"type":"string","required":true},"url":{"type":"string","required":true},"config":{"type":"config"},"data":{"type":"$root"}},"config":{"*":{"type":"*"}},"schema":{"*":{"type":"option"}},"option":{"default":{"type":"*","required":true},"type":{"type":"enum","values":{"string":1,"number":1,"boolean":1,"color":1}},"array":{"type":"boolean"},"minValue":{"type":"number"},"maxValue":{"type":"number"},"stepValue":{"type":"number"},"values":{"type":"array","value":"*"},"metadata":{"type":"*"}},"models":{"*":{"type":"model"}},"light-3d":{"id":{"type":"string","required":true},"properties":{"type":"properties"},"type":{"type":"enum","values":{"ambient":{},"directional":{},"flat":{}}}},"properties":["properties_light_directional","properties_light_ambient","properties_light_flat"],"properties_light_directional":{"direction":{"type":"array","default":[210,30],"minimum":[0,0],"maximum":[360,90],"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"cast-shadows":{"type":"boolean","default":false,"expression":{},"property-type":"data-constant"},"shadow-intensity":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_ambient":{"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_flat":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"property-type":"data-constant","expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"sources":{"*":{"type":"source"}},"source":["source_vector","source_raster","source_raster_dem","source_raster_array","source_geojson","source_video","source_image","source_model"],"source_vector":{"type":{"required":true,"type":"enum","values":{"vector":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"attribution":{"type":"string"},"promoteId":{"type":"promoteId"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster":{"type":{"required":true,"type":"enum","values":{"raster":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"attribution":{"type":"string"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_dem":{"type":{"required":true,"type":"enum","values":{"raster-dem":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"encoding":{"type":"enum","values":{"terrarium":1,"mapbox":1},"default":"mapbox"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_array":{"type":{"required":true,"type":"enum","values":{"raster-array":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"rasterLayers":{"type":"*"},"*":{"type":"*"}},"source_geojson":{"type":{"required":true,"type":"enum","values":{"geojson":1}},"data":{"type":"*"},"maxzoom":{"type":"number","default":18},"attribution":{"type":"string"},"buffer":{"type":"number","default":128,"maximum":512,"minimum":0},"filter":{"type":"*"},"tolerance":{"type":"number","default":0.375},"cluster":{"type":"boolean","default":false},"clusterRadius":{"type":"number","default":50,"minimum":0},"clusterMaxZoom":{"type":"number"},"clusterMinPoints":{"type":"number"},"clusterProperties":{"type":"*"},"lineMetrics":{"type":"boolean","default":false},"generateId":{"type":"boolean","default":false},"promoteId":{"type":"promoteId"}},"source_video":{"type":{"required":true,"type":"enum","values":{"video":1}},"urls":{"required":true,"type":"array","value":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_image":{"type":{"required":true,"type":"enum","values":{"image":1}},"url":{"required":false,"type":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_model":{"type":{"required":true,"type":"enum","values":{"model":1,"batched-model":1}},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"tiles":{"type":"array","value":"string"}},"layer":{"id":{"type":"string","required":true},"type":{"type":"enum","values":{"fill":{},"line":{},"symbol":{},"circle":{},"heatmap":{},"fill-extrusion":{},"raster":{},"hillshade":{},"model":{},"background":{},"sky":{},"slot":{}},"required":true},"metadata":{"type":"*"},"source":{"type":"string"},"source-layer":{"type":"string"},"slot":{"type":"string"},"minzoom":{"type":"number","minimum":0,"maximum":24},"maxzoom":{"type":"number","minimum":0,"maximum":24},"filter":{"type":"filter"},"layout":{"type":"layout"},"paint":{"type":"paint"}},"layout":["layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_symbol","layout_raster","layout_hillshade","layout_background","layout_sky","layout_model"],"layout_background":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_sky":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_model":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"model-id":{"type":"string","default":"","property-type":"data-driven","expression":{"parameters":["zoom","feature"]}}},"layout_fill":{"fill-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_circle":{"circle-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_heatmap":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_fill-extrusion":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"fill-extrusion-edge-radius":{"type":"number","private":true,"default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"constant"}},"layout_line":{"line-cap":{"type":"enum","values":{"butt":1,"round":1,"square":1},"default":"butt","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-join":{"type":"enum","values":{"bevel":1,"round":1,"miter":1},"default":"miter","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{"type":"number","default":2,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-round-limit":{"type":"number","default":1.05,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_symbol":{"symbol-placement":{"type":"enum","values":{"point":1,"line":1,"line-center":1},"default":"point","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-spacing":{"type":"number","default":250,"minimum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{"type":"enum","values":{"auto":1,"viewport-y":1,"source":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-z-elevate":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-size":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit":{"type":"enum","values":{"none":1,"width":1,"height":1,"both":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit-padding":{"type":"array","value":"number","length":4,"default":[0,0,0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-image":{"type":"resolvedImage","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-keep-upright":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-field":{"type":"formatted","default":"","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-font":{"type":"array","value":"string","default":["Open Sans Regular","Arial Unicode MS Regular"],"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size":{"type":"number","default":16,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-width":{"type":"number","default":10,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{"type":"number","default":1.2,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-letter-spacing":{"type":"number","default":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-justify":{"type":"enum","values":{"auto":1,"left":1,"center":1,"right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{"type":"number","default":0,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["zoom","feature"]}},"text-variable-anchor":{"type":"array","value":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{"type":"number","default":45,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-writing-mode":{"type":"array","value":"enum","values":{"horizontal":1,"vertical":1},"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-keep-upright":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-transform":{"type":"enum","values":{"none":1,"uppercase":1,"lowercase":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_raster":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_hillshade":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"filter":{"type":"array","value":"*"},"filter_symbol":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature","pitch","distance-from-center"]}},"filter_fill":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_line":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_circle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_fill-extrusion":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_heatmap":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_operator":{"type":"enum","values":{"==":1,"!=":1,">":1,">=":1,"<":1,"<=":1,"in":1,"!in":1,"all":1,"any":1,"none":1,"has":1,"!has":1}},"geometry_type":{"type":"enum","values":{"Point":1,"LineString":1,"Polygon":1}},"function":{"expression":{"type":"expression"},"stops":{"type":"array","value":"function_stop"},"base":{"type":"number","default":1,"minimum":0},"property":{"type":"string","default":"$zoom"},"type":{"type":"enum","values":{"identity":1,"exponential":1,"interval":1,"categorical":1},"default":"exponential"},"colorSpace":{"type":"enum","values":{"rgb":1,"lab":1,"hcl":1},"default":"rgb"},"default":{"type":"*","required":false}},"function_stop":{"type":"array","minimum":0,"maximum":24,"value":["number","color"],"length":2},"expression":{"type":"array","value":"*","minimum":1},"fog":{"range":{"type":"array","default":[0.5,10],"minimum":-20,"maximum":20,"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"high-color":{"type":"color","property-type":"data-constant","default":"#245cdf","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"space-color":{"type":"color","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],4,"#010b19",7,"#367ab9"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"horizon-blend":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],4,0.2,7,0.1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"star-intensity":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],5,0.35,6,0],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vertical-range":{"type":"array","default":[0,0],"minimum":0,"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}}},"camera":{"camera-projection":{"type":"enum","values":{"perspective":1,"orthographic":1},"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"default":"perspective","property-type":"data-constant"}},"light":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"property-type":"data-constant","expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"projection":{"name":{"type":"enum","values":{"albers":1,"equalEarth":1,"equirectangular":1,"lambertConformalConic":1,"mercator":1,"naturalEarth":1,"winkelTripel":1,"globe":1},"default":"mercator","required":true},"center":{"type":"array","length":2,"value":"number","property-type":"data-constant","minimum":[-180,-90],"maximum":[180,90]},"parallels":{"type":"array","length":2,"value":"number","property-type":"data-constant","minimum":[-90,-90],"maximum":[90,90]}},"terrain":{"source":{"type":"string","required":true},"exaggeration":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1000,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint":["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_symbol","paint_raster","paint_hillshade","paint_background","paint_sky","paint_model"],"paint_fill":{"fill-antialias":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-outline-color":{"type":"color","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-extrusion-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-vertical-gradient":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-ambient-occlusion-intensity":{"property-type":"data-constant","type":"number","private":true,"default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-radius":{"property-type":"data-constant","type":"number","private":true,"default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-wall-radius":{"property-type":"data-constant","type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-radius":{"property-type":"data-constant","type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-attenuation":{"property-type":"data-constant","type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-flood-light-color":{"property-type":"data-constant","type":"color","default":"#ffffff","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-intensity":{"property-type":"data-constant","type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-wall-radius":{"property-type":"data-driven","type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-radius":{"property-type":"data-driven","type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-attenuation":{"property-type":"data-constant","type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-vertical-scale":{"property-type":"data-constant","type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-rounded-roof":{"property-type":"data-constant","type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"fill-extrusion-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_line":{"line-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"line-width":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-gap-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-offset":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-dasharray":{"type":"array","value":"number","minimum":0,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-gradient":{"type":"color","expression":{"interpolated":true,"parameters":["line-progress"]},"property-type":"color-ramp"},"line-trim-offset":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"property-type":"constant"},"line-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"line-border-width":{"type":"number","private":true,"default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-border-color":{"type":"color","private":true,"default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"}},"paint_circle":{"circle-radius":{"type":"number","default":5,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-blur":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_heatmap":{"heatmap-radius":{"type":"number","default":30,"minimum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-weight":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-intensity":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"heatmap-color":{"type":"color","default":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",0.1,"royalblue",0.3,"cyan",0.5,"lime",0.7,"yellow",1,"red"],"expression":{"interpolated":true,"parameters":["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_symbol":{"icon-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-driven"},"text-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-driven"},"icon-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-image-cross-fade":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"transition":true},"text-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-color":{"type":"color","default":"#000000","transition":true,"overridable":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-color-saturation":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{},"property-type":"data-constant"}},"paint_raster":{"raster-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-color":{"type":"color","expression":{"interpolated":true,"parameters":["raster-value"]},"property-type":"color-ramp"},"raster-color-mix":{"type":"array","default":[0.2126,0.7152,0.0722,0],"length":4,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color-range":{"type":"array","default":[0,1],"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-hue-rotate":{"type":"number","default":0,"period":360,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-resampling":{"type":"enum","values":{"linear":1,"nearest":1},"default":"linear","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{"type":"number","default":300,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"raster-array-band":{"type":"string","required":false,"property-type":"data-constant"},"raster-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_hillshade":{"hillshade-illumination-direction":{"type":"number","default":335,"minimum":0,"maximum":359,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-illumination-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-exaggeration":{"type":"number","default":0.5,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-shadow-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-highlight-color":{"type":"color","default":"#FFFFFF","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-accent-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_background":{"background-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"background-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"background-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"background-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_sky":{"sky-type":{"type":"enum","values":{"gradient":1,"atmosphere":1},"default":"atmosphere","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun":{"type":"array","value":"number","length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun-intensity":{"type":"number","default":10,"minimum":0,"maximum":100,"property-type":"data-constant"},"sky-gradient-center":{"type":"array","value":"number","default":[0,0],"length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient-radius":{"type":"number","default":90,"minimum":0,"maximum":180,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient":{"type":"color","default":["interpolate",["linear"],["sky-radial-progress"],0.8,"#87ceeb",1,"white"],"expression":{"interpolated":true,"parameters":["sky-radial-progress"]},"property-type":"color-ramp"},"sky-atmosphere-halo-color":{"type":"color","default":"white","property-type":"data-constant"},"sky-atmosphere-color":{"type":"color","default":"white","property-type":"data-constant"},"sky-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_model":{"model-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"model-rotation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-scale":{"type":"array","value":"number","length":3,"default":[1,1,1],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-translation":{"type":"array","value":"number","length":3,"default":[0,0,0],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-color":{"type":"color","default":"#ffffff","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light","zoom"]},"transition":true},"model-color-mix-intensity":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-type":{"type":"enum","values":{"common-3d":1,"location-indicator":1},"default":"common-3d","property-type":"data-constant"},"model-cast-shadows":{"type":"boolean","default":true,"expression":{},"property-type":"data-constant"},"model-receive-shadows":{"type":"boolean","default":true,"expression":{},"property-type":"data-constant"},"model-ambient-occlusion-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant","transition":true},"model-emissive-strength":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-roughness":{"type":"number","default":1,"minimum":0,"maximum":1,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state"]},"transition":true},"model-height-based-emissive-strength-multiplier":{"type":"array","default":[1,1,1,1,0],"length":5,"value":"number","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"}},"transition":{"duration":{"type":"number","default":300,"minimum":0},"delay":{"type":"number","default":0,"minimum":0}},"property-type":{"data-driven":{"type":"property-type"},"color-ramp":{"type":"property-type"},"data-constant":{"type":"property-type"},"constant":{"type":"property-type"}},"promoteId":{"*":{"type":"string"}}}');class wt{constructor(t,n,r,o){this.message=(t?`${t}: `:"")+r,o&&(this.identifier=o),null!=n&&n.__line__&&(this.line=n.__line__)}}class Vn extends wt{}function lr(e,...t){for(const n of t)for(const r in n)e[r]=n[r];return e}function je(e){return e instanceof Number||e instanceof String||e instanceof Boolean?e.valueOf():e}function Cs(e){if(Array.isArray(e))return e.map(Cs);if(e instanceof Object&&!(e instanceof Number||e instanceof String||e instanceof Boolean)){const t={};for(const n in e)t[n]=Cs(e[n]);return t}return je(e)}class o_ extends Error{constructor(t,n){super(n),this.message=n,this.key=t}}var qn=o_;class As{constructor(t,n=[]){this.parent=t,this.bindings={};for(const[r,o]of n)this.bindings[r]=o}concat(t){return new As(this,t)}get(t){if(this.bindings[t])return this.bindings[t];if(this.parent)return this.parent.get(t);throw new Error(`${t} not found in scope.`)}has(t){return!!this.bindings[t]||!!this.parent&&this.parent.has(t)}}var nx=As;const _o={kind:"null"},Kt={kind:"number"},an={kind:"string"},gn={kind:"boolean"},yo={kind:"color"},al={kind:"object"},cn={kind:"value"},Zi={kind:"collator"},He={kind:"formatted"},oh={kind:"resolvedImage"};function eo(e,t){return{kind:"array",itemType:e,N:t}}function Or(e){if("array"===e.kind){const t=Or(e.itemType);return"number"==typeof e.N?`array<${t}, ${e.N}>`:"value"===e.itemType.kind?"array":`array<${t}>`}return e.kind}const cr=[_o,Kt,an,gn,yo,He,al,eo(cn),oh];function sh(e,t){if("error"===t.kind)return null;if("array"===e.kind){if("array"===t.kind&&(0===t.N&&"value"===t.itemType.kind||!sh(e.itemType,t.itemType))&&("number"!=typeof e.N||e.N===t.N))return null}else{if(e.kind===t.kind)return null;if("value"===e.kind)for(const n of cr)if(!sh(n,t))return null}return`Expected ${Or(e)} but found ${Or(t)} instead.`}function Jl(e,t){return t.some(n=>n.kind===e.kind)}function hs(e,t){return t.some(n=>"null"===n?null===e:"array"===n?Array.isArray(e):"object"===n?e&&!Array.isArray(e)&&"object"==typeof e:n===typeof e)}var ah,lh={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function vo(e){return(e=Math.round(e))<0?0:e>255?255:e}function ll(e){return vo("%"===e[e.length-1]?parseFloat(e)/100*255:parseInt(e))}function Ia(e){return(t="%"===e[e.length-1]?parseFloat(e)/100:parseFloat(e))<0?0:t>1?1:t;var t}function Vc(e,t,n){return n<0?n+=1:n>1&&(n-=1),6*n<1?e+(t-e)*n*6:2*n<1?t:3*n<2?e+(t-e)*(2/3-n)*6:e}try{ah={}.parseCSSColor=function(e){var t,n=e.replace(/ /g,"").toLowerCase();if(n in lh)return lh[n].slice();if("#"===n[0])return 4===n.length?(t=parseInt(n.substr(1),16))>=0&&t<=4095?[(3840&t)>>4|(3840&t)>>8,240&t|(240&t)>>4,15&t|(15&t)<<4,1]:null:7===n.length&&(t=parseInt(n.substr(1),16))>=0&&t<=16777215?[(16711680&t)>>16,(65280&t)>>8,255&t,1]:null;var r=n.indexOf("("),o=n.indexOf(")");if(-1!==r&&o+1===n.length){var s=n.substr(0,r),c=n.substr(r+1,o-(r+1)).split(","),u=1;switch(s){case"rgba":if(4!==c.length)return null;u=Ia(c.pop());case"rgb":return 3!==c.length?null:[ll(c[0]),ll(c[1]),ll(c[2]),u];case"hsla":if(4!==c.length)return null;u=Ia(c.pop());case"hsl":if(3!==c.length)return null;var d=(parseFloat(c[0])%360+360)%360/360,f=Ia(c[1]),m=Ia(c[2]),g=m<=.5?m*(f+1):m+f-m*f,y=2*m-g;return[vo(255*Vc(y,g,d+1/3)),vo(255*Vc(y,g,d)),vo(255*Vc(y,g,d-1/3)),u];default:return null}}return null}}catch{}class Ui{constructor(t,n,r,o=1){this.r=t,this.g=n,this.b=r,this.a=o}static parse(t){if(!t)return;if(t instanceof Ui)return t;if("string"!=typeof t)return;const n=ah(t);return n?new Ui(n[0]/255*n[3],n[1]/255*n[3],n[2]/255*n[3],n[3]):void 0}toString(){const[t,n,r,o]=this.toArray();return`rgba(${Math.round(t)},${Math.round(n)},${Math.round(r)},${o})`}toArray(){const{r:t,g:n,b:r,a:o}=this;return 0===o?[0,0,0,0]:[255*t/o,255*n/o,255*r/o,o]}toArray01(){const{r:t,g:n,b:r,a:o}=this;return 0===o?[0,0,0,0]:[t/o,n/o,r/o,o]}toArray01Scaled(t){const{r:n,g:r,b:o,a:s}=this;return 0===s?[0,0,0]:[n/s*t,r/s*t,o/s*t]}toArray01PremultipliedAlpha(){const{r:t,g:n,b:r,a:o}=this;return[t,n,r,o]}toArray01Linear(){const{r:t,g:n,b:r,a:o}=this;return 0===o?[0,0,0,0]:[Math.pow(t/o,2.2),Math.pow(n/o,2.2),Math.pow(r/o,2.2),o]}}Ui.black=new Ui(0,0,0,1),Ui.white=new Ui(1,1,1,1),Ui.transparent=new Ui(0,0,0,0),Ui.red=new Ui(1,0,0,1),Ui.blue=new Ui(0,0,1,1);var ke=Ui;class An{constructor(t,n,r){this.sensitivity=t?n?"variant":"case":n?"accent":"base",this.locale=r,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(t,n){return this.collator.compare(t,n)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class Ql{constructor(t,n,r,o,s){this.text=t.normalize?t.normalize():t,this.image=n,this.scale=r,this.fontStack=o,this.textColor=s}}class Wi{constructor(t){this.sections=t}static fromString(t){return new Wi([new Ql(t,null,null,null,null)])}isEmpty(){return 0===this.sections.length||!this.sections.some(t=>0!==t.text.length||t.image&&0!==t.image.namePrimary.length)}static factory(t){return t instanceof Wi?t:Wi.fromString(t)}toString(){return 0===this.sections.length?"":this.sections.map(t=>t.text).join("")}serialize(){const t=["format"];for(const n of this.sections){if(n.image){t.push(["image",n.image.namePrimary]);continue}t.push(n.text);const r={};n.fontStack&&(r["text-font"]=["literal",n.fontStack.split(",")]),n.scale&&(r["font-scale"]=n.scale),n.textColor&&(r["text-color"]=["rgba"].concat(n.textColor.toArray())),t.push(r)}return t}}class Qn{constructor(t){this.namePrimary=t.namePrimary,t.nameSecondary&&(this.nameSecondary=t.nameSecondary),this.available=t.available}toString(){return this.nameSecondary?`[${this.namePrimary},${this.nameSecondary}]`:this.namePrimary}static fromString(t,n){return t?new Qn({namePrimary:t,nameSecondary:n,available:!1}):null}serialize(){return this.nameSecondary?["image",this.namePrimary,this.nameSecondary]:["image",this.namePrimary]}}function ch(e,t,n,r){return"number"==typeof e&&e>=0&&e<=255&&"number"==typeof t&&t>=0&&t<=255&&"number"==typeof n&&n>=0&&n<=255?void 0===r||"number"==typeof r&&r>=0&&r<=1?null:`Invalid rgba value [${[e,t,n,r].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${("number"==typeof r?[e,t,n,r]:[e,t,n]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function Uc(e){if(null===e||"string"==typeof e||"boolean"==typeof e||"number"==typeof e||e instanceof ke||e instanceof An||e instanceof Wi||e instanceof Qn)return!0;if(Array.isArray(e)){for(const t of e)if(!Uc(t))return!1;return!0}if("object"==typeof e){for(const t in e)if(!Uc(e[t]))return!1;return!0}return!1}function on(e){if(null===e)return _o;if("string"==typeof e)return an;if("boolean"==typeof e)return gn;if("number"==typeof e)return Kt;if(e instanceof ke)return yo;if(e instanceof An)return Zi;if(e instanceof Wi)return He;if(e instanceof Qn)return oh;if(Array.isArray(e)){const t=e.length;let n;for(const r of e){const o=on(r);if(n){if(n===o)continue;n=cn;break}n=o}return eo(n||cn,t)}return al}function tc(e){const t=typeof e;return null===e?"":"string"===t||"number"===t||"boolean"===t?String(e):e instanceof ke||e instanceof Wi||e instanceof Qn?e.toString():JSON.stringify(e)}class ec{constructor(t,n){this.type=t,this.value=n}static parse(t,n){if(2!==t.length)return n.error(`'literal' expression requires exactly one argument, but found ${t.length-1} instead.`);if(!Uc(t[1]))return n.error("invalid value");const r=t[1];let o=on(r);const s=n.expectedType;return"array"!==o.kind||0!==o.N||!s||"array"!==s.kind||"number"==typeof s.N&&0!==s.N||(o=s),new ec(o,r)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return"array"===this.type.kind||"object"===this.type.kind?["literal",this.value]:this.value instanceof ke?["rgba"].concat(this.value.toArray()):this.value instanceof Wi?this.value.serialize():this.value}}var qe=ec,kr=class{constructor(e){this.name="ExpressionEvaluationError",this.message=e}toJSON(){return this.message}};const cl={string:an,number:Kt,boolean:gn,object:al};class Da{constructor(t,n){this.type=t,this.args=n}static parse(t,n){if(t.length<2)return n.error("Expected at least one argument.");let r,o=1;const s=t[0];if("array"===s){let u,d;if(t.length>2){const f=t[1];if("string"!=typeof f||!(f in cl)||"object"===f)return n.error('The item type argument of "array" must be one of string, number, boolean',1);u=cl[f],o++}else u=cn;if(t.length>3){if(null!==t[2]&&("number"!=typeof t[2]||t[2]<0||t[2]!==Math.floor(t[2])))return n.error('The length argument to "array" must be a positive integer literal',2);d=t[2],o++}r=eo(u,d)}else r=cl[s];const c=[];for(;o<t.length;o++){const u=n.parse(t[o],o,cn);if(!u)return null;c.push(u)}return new Da(r,c)}evaluate(t){for(let n=0;n<this.args.length;n++){const r=this.args[n].evaluate(t);if(!sh(this.type,on(r)))return r;if(n===this.args.length-1)throw new kr(`Expected value to be of type ${Or(this.type)}, but found ${Or(on(r))} instead.`)}return null}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every(t=>t.outputDefined())}serialize(){const t=this.type,n=[t.kind];if("array"===t.kind){const r=t.itemType;if("string"===r.kind||"number"===r.kind||"boolean"===r.kind){n.push(r.kind);const o=t.N;("number"==typeof o||this.args.length>1)&&n.push(o)}}return n.concat(this.args.map(r=>r.serialize()))}}var ds=Da;class Gc{constructor(t){this.type=He,this.sections=t}static parse(t,n){if(t.length<2)return n.error("Expected at least one argument.");const r=t[1];if(!Array.isArray(r)&&"object"==typeof r)return n.error("First argument must be an image or text section.");const o=[];let s=!1;for(let c=1;c<=t.length-1;++c){const u=t[c];if(s&&"object"==typeof u&&!Array.isArray(u)){s=!1;let d=null;if(u["font-scale"]&&(d=n.parse(u["font-scale"],1,Kt),!d))return null;let f=null;if(u["text-font"]&&(f=n.parse(u["text-font"],1,eo(an)),!f))return null;let m=null;if(u["text-color"]&&(m=n.parse(u["text-color"],1,yo),!m))return null;const g=o[o.length-1];g.scale=d,g.font=f,g.textColor=m}else{const d=n.parse(t[c],1,cn);if(!d)return null;const f=d.type.kind;if("string"!==f&&"value"!==f&&"null"!==f&&"resolvedImage"!==f)return n.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");s=!0,o.push({content:d,scale:null,font:null,textColor:null})}}return new Gc(o)}evaluate(t){return new Wi(this.sections.map(n=>{const r=n.content.evaluate(t);return on(r)===oh?new Ql("",r,null,null,null):new Ql(tc(r),null,n.scale?n.scale.evaluate(t):null,n.font?n.font.evaluate(t).join(","):null,n.textColor?n.textColor.evaluate(t):null)}))}eachChild(t){for(const n of this.sections)t(n.content),n.scale&&t(n.scale),n.font&&t(n.font),n.textColor&&t(n.textColor)}outputDefined(){return!1}serialize(){const t=["format"];for(const n of this.sections){t.push(n.content.serialize());const r={};n.scale&&(r["font-scale"]=n.scale.serialize()),n.font&&(r["text-font"]=n.font.serialize()),n.textColor&&(r["text-color"]=n.textColor.serialize()),t.push(r)}return t}}class ul{constructor(t,n){this.type=oh,this.inputPrimary=t,this.inputSecondary=n}static parse(t,n){if(t.length<2)return n.error("Expected two or more arguments.");const r=n.parse(t[1],1,an);if(!r)return n.error("No image name provided.");if(2===t.length)return new ul(r);const o=n.parse(t[2],1,an);return o?new ul(r,o):n.error("Secondary image variant is not a string.")}evaluate(t){const n=Qn.fromString(this.inputPrimary.evaluate(t),this.inputSecondary?this.inputSecondary.evaluate(t):void 0);return n&&t.availableImages&&(n.available=t.availableImages.indexOf(n.namePrimary)>-1,n.nameSecondary&&n.available&&t.availableImages&&(n.available=t.availableImages.indexOf(n.nameSecondary)>-1)),n}eachChild(t){t(this.inputPrimary),this.inputSecondary&&t(this.inputSecondary)}outputDefined(){return!1}serialize(){return this.inputSecondary?["image",this.inputPrimary.serialize(),this.inputSecondary.serialize()]:["image",this.inputPrimary.serialize()]}}function Pn(e){return e instanceof Number?"number":e instanceof String?"string":e instanceof Boolean?"boolean":Array.isArray(e)?"array":null===e?"null":typeof e}const rx={"to-boolean":gn,"to-color":yo,"to-number":Kt,"to-string":an};class nf{constructor(t,n){this.type=t,this.args=n}static parse(t,n){if(t.length<2)return n.error("Expected at least one argument.");const r=t[0],o=[];let s=_o;if("to-array"===r){if(!Array.isArray(t[1]))return null;const c=t[1].length;if(n.expectedType){if("array"!==n.expectedType.kind)return n.error(`Expected ${n.expectedType.kind} but found array.`);s=eo(n.expectedType.itemType,c)}else{if(!(c>0&&Uc(t[1][0])))return null;s=eo(on(t[1][0]),c)}for(let u=0;u<c;u++){const d=t[1][u];let f;if("array"===Pn(d))f=n.parse(d,void 0,s.itemType);else{const m=Pn(d);if(m!==s.itemType.kind)return n.error(`Expected ${s.itemType.kind} but found ${m}.`);f=n.registry.literal.parse(["literal",void 0===d?null:d],n)}if(!f)return null;o.push(f)}}else{if(("to-boolean"===r||"to-string"===r)&&2!==t.length)return n.error("Expected one argument.");s=rx[r];for(let c=1;c<t.length;c++){const u=n.parse(t[c],c,cn);if(!u)return null;o.push(u)}}return new nf(s,o)}evaluate(t){if("boolean"===this.type.kind)return!!this.args[0].evaluate(t);if("color"===this.type.kind){let n,r;for(const o of this.args){if(n=o.evaluate(t),r=null,n instanceof ke)return n;if("string"==typeof n){const s=t.parseColor(n);if(s)return s}else if(Array.isArray(n)&&(r=n.length<3||n.length>4?`Invalid rbga value ${JSON.stringify(n)}: expected an array containing either three or four numeric values.`:ch(n[0],n[1],n[2],n[3]),!r))return new ke(n[0]/255,n[1]/255,n[2]/255,n[3])}throw new kr(r||`Could not parse color from value '${"string"==typeof n?n:String(JSON.stringify(n))}'`)}if("number"===this.type.kind){let n=null;for(const r of this.args){if(n=r.evaluate(t),null===n)return 0;const o=Number(n);if(!isNaN(o))return o}throw new kr(`Could not convert ${JSON.stringify(n)} to number.`)}return"formatted"===this.type.kind?Wi.fromString(tc(this.args[0].evaluate(t))):"resolvedImage"===this.type.kind?Qn.fromString(tc(this.args[0].evaluate(t))):"array"===this.type.kind?this.args.map(n=>n.evaluate(t)):tc(this.args[0].evaluate(t))}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every(t=>t.outputDefined())}serialize(){if("formatted"===this.type.kind)return new Gc([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if("resolvedImage"===this.type.kind)return new ul(this.args[0]).serialize();const t="array"===this.type.kind?[]:[`to-${this.type.kind}`];return this.eachChild(n=>{t.push(n.serialize())}),t}}var Sa=nf;const nc=["Unknown","Point","LineString","Polygon"];var no=class{constructor(e){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null,this.options=e}id(){return this.feature&&void 0!==this.feature.id?this.feature.id:null}geometryType(){return this.feature?"number"==typeof this.feature.type?nc[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}measureLight(e){return this.globals.brightness||0}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){const e=this.featureDistanceData.center,t=this.featureDistanceData.scale,{x:n,y:r}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(n*t-e[0])+this.featureDistanceData.bearing[1]*(r*t-e[1])}return 0}parseColor(e){let t=this._parseColorCache[e];return t||(t=this._parseColorCache[e]=ke.parse(e)),t}getConfig(e){return this.options?this.options.get(e):null}};class Xi{constructor(t,n,r,o,s){this.name=t,this.type=n,this._evaluate=r,this.args=o,this._overloadIndex=s}evaluate(t){if(!this._evaluate){const n=Xi.definitions[this.name];this._evaluate=Array.isArray(n)?n[2]:n.overloads[this._overloadIndex][1]}return this._evaluate(t,this.args)}eachChild(t){this.args.forEach(t)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map(t=>t.serialize()))}static parse(t,n){const r=t[0],o=Xi.definitions[r];if(!o)return n.error(`Unknown expression "${r}". If you wanted a literal array, use ["literal", [...]].`,0);const s=Array.isArray(o)?o[0]:o.type,c=Array.isArray(o)?[[o[1],o[2]]]:o.overloads,u=[];let d=null,f=-1;for(const[m,g]of c){if(Array.isArray(m)&&m.length!==t.length-1)continue;u.push(m),f++,d=new ph(n.registry,n.path,null,n.scope,void 0,n.options);const y=[];let v=!1;for(let x=1;x<t.length;x++){const w=t[x],E=Array.isArray(m)?m[x-1]:m.type,M=d.parse(w,1+y.length,E);if(!M){v=!0;break}y.push(M)}if(!v)if(Array.isArray(m)&&m.length!==y.length)d.error(`Expected ${m.length} arguments, but found ${y.length} instead.`);else{for(let x=0;x<y.length;x++){const w=Array.isArray(m)?m[x]:m.type,E=y[x];d.concat(x+1).checkSubtype(w,E.type)}if(0===d.errors.length)return new Xi(r,s,g,y,f)}}if(1===u.length)n.errors.push(...d.errors);else{const m=(u.length?u:c.map(([y])=>y)).map(hl).join(" | "),g=[];for(let y=1;y<t.length;y++){const v=n.parse(t[y],1+g.length);if(!v)return null;g.push(Or(v.type))}n.error(`Expected arguments of type ${m}, but found (${g.join(", ")}) instead.`)}return null}static register(t,n){Xi.definitions=n;for(const r in n)t[r]=Xi}}function hl(e){return Array.isArray(e)?`(${e.map(Or).join(", ")})`:`(${Or(e.type)}...)`}var Si=Xi;class uh{constructor(t,n,r){this.type=Zi,this.locale=r,this.caseSensitive=t,this.diacriticSensitive=n}static parse(t,n){if(2!==t.length)return n.error("Expected one argument.");const r=t[1];if("object"!=typeof r||Array.isArray(r))return n.error("Collator options argument must be an object.");const o=n.parse(void 0!==r["case-sensitive"]&&r["case-sensitive"],1,gn);if(!o)return null;const s=n.parse(void 0!==r["diacritic-sensitive"]&&r["diacritic-sensitive"],1,gn);if(!s)return null;let c=null;return r.locale&&(c=n.parse(r.locale,1,an),!c)?null:new uh(o,s,c)}evaluate(t){return new An(this.caseSensitive.evaluate(t),this.diacriticSensitive.evaluate(t),this.locale?this.locale.evaluate(t):null)}eachChild(t){t(this.caseSensitive),t(this.diacriticSensitive),this.locale&&t(this.locale)}outputDefined(){return!1}serialize(){const t={};return t["case-sensitive"]=this.caseSensitive.serialize(),t["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(t.locale=this.locale.serialize()),["collator",t]}}var $c={exports:{}};$c.exports=function(){function e(r,o,s,c,u){for(;c>s;){if(c-s>600){var d=c-s+1,f=o-s+1,m=Math.log(d),g=.5*Math.exp(2*m/3),y=.5*Math.sqrt(m*g*(d-g)/d)*(f-d/2<0?-1:1);e(r,o,Math.max(s,Math.floor(o-f*g/d+y)),Math.min(c,Math.floor(o+(d-f)*g/d+y)),u)}var v=r[o],x=s,w=c;for(t(r,s,o),u(r[c],v)>0&&t(r,s,c);x<w;){for(t(r,x,w),x++,w--;u(r[x],v)<0;)x++;for(;u(r[w],v)>0;)w--}0===u(r[s],v)?t(r,s,w):t(r,++w,c),w<=o&&(s=w+1),o<=w&&(c=w-1)}}function t(r,o,s){var c=r[o];r[o]=r[s],r[s]=c}function n(r,o){return r<o?-1:r>o?1:0}return function(r,o,s,c,u){e(r,o,s||0,c||r.length-1,u||n)}}();var rc=rr($c.exports);function dl(e){let t=0;for(let n,r,o=0,s=e.length,c=s-1;o<s;c=o++)n=e[o],r=e[c],t+=(r.x-n.x)*(n.y+r.y);return t}function ic(e,t){e[0]=Math.min(e[0],t[0]),e[1]=Math.min(e[1],t[1]),e[2]=Math.max(e[2],t[0]),e[3]=Math.max(e[3],t[1])}function Bo(e,t){return!(e[0]<=t[0]||e[2]>=t[2]||e[1]<=t[1]||e[3]>=t[3])}function s_(e,t,n){const r=e[0]-t[0],o=e[1]-t[1],s=e[0]-n[0],c=e[1]-n[1];return r*c-s*o==0&&r*s<=0&&o*c<=0}function Mn(e,t,n=!1){let r=!1;for(let u=0,d=t.length;u<d;u++){const f=t[u];for(let m=0,g=f.length,y=g-1;m<g;y=m++){const v=f[y],x=f[m];if(s_(e,v,x))return n;(s=v)[1]>(o=e)[1]!=(c=x)[1]>o[1]&&o[0]<(c[0]-s[0])*(o[1]-s[1])/(c[1]-s[1])+s[0]&&(r=!r)}}var o,s,c;return r}function hh(e,t,n,r){const o=r[0]-n[0],s=r[1]-n[1],c=(e[0]-n[0])*s-o*(e[1]-n[1]),u=(t[0]-n[0])*s-o*(t[1]-n[1]);return c>0&&u<0||c<0&&u>0}function Wn(e,t,n,r){return(o=[r[0]-n[0],r[1]-n[1]])[0]*(s=[t[0]-e[0],t[1]-e[1]])[1]-o[1]*s[0]!=0&&!(!hh(e,t,n,r)||!hh(n,r,e,t));var o,s}const Gi=8192;function rf(e,t){const n=(180+e[0])/360,r=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+e[1]*Math.PI/360)))/360,o=Math.pow(2,t.z);return[Math.round(n*o*Gi),Math.round(r*o*Gi)]}function jo(e,t){for(let n=0;n<t.length;n++)if(Mn(e,t[n]))return!0;return!1}function a_(e,t,n){for(const r of n)for(let o=0,s=r.length,c=s-1;o<s;c=o++)if(Wn(e,t,r[c],r[o]))return!0;return!1}function Ca(e,t){for(let n=0;n<e.length;++n)if(!Mn(e[n],t))return!1;for(let n=0;n<e.length-1;++n)if(a_(e[n],e[n+1],t))return!1;return!0}function jp(e,t){for(let n=0;n<t.length;n++)if(Ca(e,t[n]))return!0;return!1}function fs(e,t,n){const r=[];for(let o=0;o<e.length;o++){const s=[];for(let c=0;c<e[o].length;c++){const u=rf(e[o][c],n);ic(t,u),s.push(u)}r.push(s)}return r}function Aa(e,t,n){const r=[];for(let o=0;o<e.length;o++){const s=fs(e[o],t,n);r.push(s)}return r}function ro(e,t,n,r){if(e[0]<n[0]||e[0]>n[2]){const o=.5*r;let s=e[0]-n[0]>o?-r:n[0]-e[0]>o?r:0;0===s&&(s=e[0]-n[2]>o?-r:n[2]-e[0]>o?r:0),e[0]+=s}ic(t,e)}function Vo(e,t,n,r){const o=Math.pow(2,r.z)*Gi,s=[r.x*Gi,r.y*Gi],c=[];if(!e)return c;for(const u of e)for(const d of u){const f=[d.x+s[0],d.y+s[1]];ro(f,t,n,o),c.push(f)}return c}function Gn(e,t,n,r){const o=Math.pow(2,r.z)*Gi,s=[r.x*Gi,r.y*Gi],c=[];if(!e)return c;for(const d of e){const f=[];for(const m of d){const g=[m.x+s[0],m.y+s[1]];ic(t,g),f.push(g)}c.push(f)}if(t[2]-t[0]<=o/2){(u=t)[0]=u[1]=1/0,u[2]=u[3]=-1/0;for(const d of c)for(const f of d)ro(f,t,n,o)}var u;return c}class Zs{constructor(t,n){this.type=gn,this.geojson=t,this.geometries=n}static parse(t,n){if(2!==t.length)return n.error(`'within' expression requires exactly one argument, but found ${t.length-1} instead.`);if(Uc(t[1])){const r=t[1];if("FeatureCollection"===r.type)for(let o=0;o<r.features.length;++o){const s=r.features[o].geometry.type;if("Polygon"===s||"MultiPolygon"===s)return new Zs(r,r.features[o].geometry)}else if("Feature"===r.type){const o=r.geometry.type;if("Polygon"===o||"MultiPolygon"===o)return new Zs(r,r.geometry)}else if("Polygon"===r.type||"MultiPolygon"===r.type)return new Zs(r,r)}return n.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(t){if(null!=t.geometry()&&null!=t.canonicalID()){if("Point"===t.geometryType())return function(n,r){const o=[1/0,1/0,-1/0,-1/0],s=[1/0,1/0,-1/0,-1/0],c=n.canonicalID();if(!c)return!1;if("Polygon"===r.type){const u=fs(r.coordinates,s,c),d=Vo(n.geometry(),o,s,c);if(!Bo(o,s))return!1;for(const f of d)if(!Mn(f,u))return!1}if("MultiPolygon"===r.type){const u=Aa(r.coordinates,s,c),d=Vo(n.geometry(),o,s,c);if(!Bo(o,s))return!1;for(const f of d)if(!jo(f,u))return!1}return!0}(t,this.geometries);if("LineString"===t.geometryType())return function(n,r){const o=[1/0,1/0,-1/0,-1/0],s=[1/0,1/0,-1/0,-1/0],c=n.canonicalID();if(!c)return!1;if("Polygon"===r.type){const u=fs(r.coordinates,s,c),d=Gn(n.geometry(),o,s,c);if(!Bo(o,s))return!1;for(const f of d)if(!Ca(f,u))return!1}if("MultiPolygon"===r.type){const u=Aa(r.coordinates,s,c),d=Gn(n.geometry(),o,s,c);if(!Bo(o,s))return!1;for(const f of d)if(!jp(f,u))return!1}return!0}(t,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}var Ws=Zs,Hc={exports:{}};Hc.exports=function(){var e={kilometers:1,miles:.621371192237334,nauticalmiles:.5399568034557235,meters:1e3,metres:1e3,yards:1093.6132983377079,feet:3280.839895013123,inches:39370.078740157485},t=1/298.257223563,n=t*(2-t),r=Math.PI/180,o=function(f,m){if(void 0===f)throw new Error("No latitude given.");if(m&&!e[m])throw new Error("Unknown unit "+m+". Use one of: "+Object.keys(e).join(", "));var g=6378.137*r*(m?e[m]:1),y=Math.cos(f*r),v=1/(1-n*(1-y*y)),x=Math.sqrt(v);this.kx=g*x*y,this.ky=g*x*v*(1-n)},s={units:{configurable:!0}};function c(f,m){return f[0]===m[0]&&f[1]===m[1]}function u(f,m,g){var y=d(m[0]-f[0]);return[f[0]+y*g,f[1]+(m[1]-f[1])*g]}function d(f){for(;f<-180;)f+=360;for(;f>180;)f-=360;return f}return o.fromTile=function(f,m,g){var y=Math.PI*(1-2*(f+.5)/Math.pow(2,m)),v=Math.atan(.5*(Math.exp(y)-Math.exp(-y)))/r;return new o(v,g)},s.units.get=function(){return e},o.prototype.distance=function(f,m){var g=d(f[0]-m[0])*this.kx,y=(f[1]-m[1])*this.ky;return Math.sqrt(g*g+y*y)},o.prototype.bearing=function(f,m){var g=d(m[0]-f[0])*this.kx;return Math.atan2(g,(m[1]-f[1])*this.ky)/r},o.prototype.destination=function(f,m,g){var y=g*r;return this.offset(f,Math.sin(y)*m,Math.cos(y)*m)},o.prototype.offset=function(f,m,g){return[f[0]+m/this.kx,f[1]+g/this.ky]},o.prototype.lineDistance=function(f){for(var m=0,g=0;g<f.length-1;g++)m+=this.distance(f[g],f[g+1]);return m},o.prototype.area=function(f){for(var m=0,g=0;g<f.length;g++)for(var y=f[g],v=0,x=y.length,w=x-1;v<x;w=v++)m+=d(y[v][0]-y[w][0])*(y[v][1]+y[w][1])*(g?-1:1);return Math.abs(m)/2*this.kx*this.ky},o.prototype.along=function(f,m){var g=0;if(m<=0)return f[0];for(var y=0;y<f.length-1;y++){var v=f[y],x=f[y+1],w=this.distance(v,x);if((g+=w)>m)return u(v,x,(m-(g-w))/w)}return f[f.length-1]},o.prototype.pointToSegmentDistance=function(f,m,g){var y=m[0],v=m[1],x=d(g[0]-y)*this.kx,w=(g[1]-v)*this.ky,E=0;return 0===x&&0===w||((E=(d(f[0]-y)*this.kx*x+(f[1]-v)*this.ky*w)/(x*x+w*w))>1?(y=g[0],v=g[1]):E>0&&(y+=x/this.kx*E,v+=w/this.ky*E)),x=d(f[0]-y)*this.kx,w=(f[1]-v)*this.ky,Math.sqrt(x*x+w*w)},o.prototype.pointOnLine=function(f,m){for(var g,y,v,x,w=1/0,E=0;E<f.length-1;E++){var M=f[E][0],D=f[E][1],A=d(f[E+1][0]-M)*this.kx,P=(f[E+1][1]-D)*this.ky,C=0;0===A&&0===P||((C=(d(m[0]-M)*this.kx*A+(m[1]-D)*this.ky*P)/(A*A+P*P))>1?(M=f[E+1][0],D=f[E+1][1]):C>0&&(M+=A/this.kx*C,D+=P/this.ky*C));var R=(A=d(m[0]-M)*this.kx)*A+(P=(m[1]-D)*this.ky)*P;R<w&&(w=R,g=M,y=D,v=E,x=C)}return{point:[g,y],index:v,t:Math.max(0,Math.min(1,x))}},o.prototype.lineSlice=function(f,m,g){var y=this.pointOnLine(g,f),v=this.pointOnLine(g,m);if(y.index>v.index||y.index===v.index&&y.t>v.t){var x=y;y=v,v=x}var w=[y.point],E=y.index+1,M=v.index;!c(g[E],w[0])&&E<=M&&w.push(g[E]);for(var D=E+1;D<=M;D++)w.push(g[D]);return c(g[M],v.point)||w.push(v.point),w},o.prototype.lineSliceAlong=function(f,m,g){for(var y=0,v=[],x=0;x<g.length-1;x++){var w=g[x],E=g[x+1],M=this.distance(w,E);if((y+=M)>f&&0===v.length&&v.push(u(w,E,(f-(y-M))/M)),y>=m)return v.push(u(w,E,(m-(y-M))/M)),v;y>f&&v.push(E)}return v},o.prototype.bufferPoint=function(f,m){var g=m/this.ky,y=m/this.kx;return[f[0]-y,f[1]-g,f[0]+y,f[1]+g]},o.prototype.bufferBBox=function(f,m){var g=m/this.ky,y=m/this.kx;return[f[0]-y,f[1]-g,f[2]+y,f[3]+g]},o.prototype.insideBBox=function(f,m){return d(f[0]-m[0])>=0&&d(f[0]-m[2])<=0&&f[1]>=m[1]&&f[1]<=m[3]},Object.defineProperties(o,s),o}();var dh=rr(Hc.exports),pt={exports:{}};pt.exports=function(){var e=function(n,r){if(void 0===n&&(n=[]),void 0===r&&(r=t),this.data=n,this.length=this.data.length,this.compare=r,this.length>0)for(var o=(this.length>>1)-1;o>=0;o--)this._down(o)};function t(n,r){return n<r?-1:n>r?1:0}return e.prototype.push=function(n){this.data.push(n),this.length++,this._up(this.length-1)},e.prototype.pop=function(){if(0!==this.length){var n=this.data[0],r=this.data.pop();return this.length--,this.length>0&&(this.data[0]=r,this._down(0)),n}},e.prototype.peek=function(){return this.data[0]},e.prototype._up=function(n){for(var r=this.data,o=this.compare,s=r[n];n>0;){var c=n-1>>1,u=r[c];if(o(s,u)>=0)break;r[n]=u,n=c}r[n]=s},e.prototype._down=function(n){for(var r=this.data,o=this.compare,s=this.length>>1,c=r[n];n<s;){var u=1+(n<<1),d=r[u],f=u+1;if(f<this.length&&o(r[f],d)<0&&(u=f,d=r[f]),o(d,c)>=0)break;r[n]=d,n=u}r[n]=c},e}();var Dt=rr(pt.exports),et=8192;function Fe(e,t){return t.dist-e.dist}const or=100,In=50;function Fr(e){const t=[1/0,1/0,-1/0,-1/0];if(t.length!==e.length)return!1;for(let n=0;n<t.length;n++)if(t[n]!==e[n])return!1;return!0}function mr(e){return e[1]-e[0]+1}function ai(e,t){const n=e[1]>=e[0]&&e[1]<t;return n||console.warn("Distance Expression: Index is out of range"),n}function Xr(e,t){if(e[0]>e[1])return[null,null];const n=mr(e);if(t){if(2===n)return[e,null];const r=Math.floor(n/2);return[[e[0],e[0]+r],[e[0]+r,e[1]]]}{if(1===n)return[e,null];const r=Math.floor(n/2)-1;return[[e[0],e[0]+r],[e[0]+r+1,e[1]]]}}function Sr(e,t){const n=[1/0,1/0,-1/0,-1/0];if(!ai(t,e.length))return n;for(let r=t[0];r<=t[1];++r)ic(n,e[r]);return n}function io(e){const t=[1/0,1/0,-1/0,-1/0];for(let n=0;n<e.length;++n)for(let r=0;r<e[n].length;++r)ic(t,e[n][r]);return t}function oo(e,t,n){if(Fr(e)||Fr(t))return NaN;let r=0,o=0;return e[2]<t[0]&&(r=t[0]-e[2]),e[0]>t[2]&&(r=e[0]-t[2]),e[1]>t[3]&&(o=e[1]-t[3]),e[3]<t[1]&&(o=t[1]-e[3]),n.distance([0,0],[r,o])}function Ci(e,t){const n=Math.pow(2,t.z);return[(o=(e.x/et+t.x)/n,360*o-180),(r=(e.y/et+t.y)/n,360/Math.PI*Math.atan(Math.exp((180-360*r)*Math.PI/180))-90)];var r,o}function fi(e,t){const n=[];for(let r=0;r<e.length;++r)n.push(Ci(e[r],t));return n}function fl(e,t,n){const r=n.pointOnLine(t,e).point;return n.distance(e,r)}function oc(e,t,n,r,o){const s=n.slice(r[0],r[1]+1);let c=1/0;for(let u=t[0];u<=t[1];++u)if(0===(c=Math.min(c,fl(e[u],s,o))))return 0;return c}function Pa(e,t,n,r,o){const s=Math.min(o.pointToSegmentDistance(e,n,r),o.pointToSegmentDistance(t,n,r)),c=Math.min(o.pointToSegmentDistance(n,e,t),o.pointToSegmentDistance(r,e,t));return Math.min(s,c)}function qc(e,t,n,r,o){if(!ai(t,e.length)||!ai(r,n.length))return NaN;let s=1/0;for(let c=t[0];c<t[1];++c)for(let u=r[0];u<r[1];++u){if(Wn(e[c],e[c+1],n[u],n[u+1]))return 0;s=Math.min(s,Pa(e[c],e[c+1],n[u],n[u+1],o))}return s}function Vp(e,t,n,r,o){if(!ai(t,e.length)||!ai(r,n.length))return NaN;let s=1/0;for(let c=t[0];c<=t[1];++c)for(let u=r[0];u<=r[1];++u)if(0===(s=Math.min(s,o.distance(e[c],n[u]))))return s;return s}function l_(e,t,n){if(Mn(e,t,!0))return 0;let r=1/0;for(const o of t){const s=o.length;if(s<2)return console.warn("Distance Expression: Invalid polygon!"),NaN;if(o[0]!==o[s-1]&&0===(r=Math.min(r,n.pointToSegmentDistance(e,o[s-1],o[0])))||0===(r=Math.min(r,fl(e,o,n))))return r}return r}function Up(e,t,n,r){if(!ai(t,e.length))return NaN;for(let s=t[0];s<=t[1];++s)if(Mn(e[s],n,!0))return 0;let o=1/0;for(let s=t[0];s<t[1];++s)for(const c of n)for(let u=0,d=c.length,f=d-1;u<d;f=u++){if(Wn(e[s],e[s+1],c[f],c[u]))return 0;o=Math.min(o,Pa(e[s],e[s+1],c[f],c[u],r))}return o}function ur(e,t){for(const n of e)for(let r=0;r<=n.length-1;++r)if(Mn(n[r],t,!0))return!0;return!1}function sr(e,t,n,r=1/0){const o=io(e),s=io(t);if(r!==1/0&&oo(o,s,n)>=r)return r;if(Bo(o,s)){if(ur(e,t))return 0}else if(ur(t,e))return 0;let c=r;for(const u of e)for(let d=0,f=u.length,m=f-1;d<f;m=d++)for(const g of t)for(let y=0,v=g.length,x=v-1;y<v;x=y++){if(Wn(u[m],u[d],g[x],g[y]))return 0;c=Math.min(c,Pa(u[m],u[d],g[x],g[y],n))}return c}function pl(e,t,n,r,o,s,c){if(null===s||null===c)return;const u=oo(Sr(r,s),Sr(o,c),n);u<t&&e.push({dist:u,range1:s,range2:c})}function Ps(e,t,n,r,o=1/0){let s=Math.min(r.distance(e[0],n[0][0]),o);if(0===s)return s;const c=new Dt([{dist:0,range1:[0,e.length-1],range2:[0,0]}],Fe),u=t?In:or,d=io(n);for(;c.length;){const f=c.pop();if(f.dist>=s)continue;const m=f.range1;if(mr(m)<=u){if(!ai(m,e.length))return NaN;if(t){const g=Up(e,m,n,r);if(0===(s=Math.min(s,g)))return s}else for(let g=m[0];g<=m[1];++g){const y=l_(e[g],n,r);if(0===(s=Math.min(s,y)))return s}}else{const g=Xr(m,t);if(null!==g[0]){const y=oo(Sr(e,g[0]),d,r);y<s&&c.push({dist:y,range1:g[0],range2:[0,0]})}if(null!==g[1]){const y=oo(Sr(e,g[1]),d,r);y<s&&c.push({dist:y,range1:g[1],range2:[0,0]})}}}return s}function fh(e,t,n,r,o,s=1/0){let c=Math.min(s,o.distance(e[0],n[0]));if(0===c)return c;const u=new Dt([{dist:0,range1:[0,e.length-1],range2:[0,n.length-1]}],Fe),d=t?In:or,f=r?In:or;for(;u.length;){const m=u.pop();if(m.dist>=c)continue;const g=m.range1,y=m.range2;if(mr(g)<=d&&mr(y)<=f){if(!ai(g,e.length)||!ai(y,n.length))return NaN;if(t&&r?c=Math.min(c,qc(e,g,n,y,o)):t||r?t&&!r?c=Math.min(c,oc(n,y,e,g,o)):!t&&r&&(c=Math.min(c,oc(e,g,n,y,o))):c=Math.min(c,Vp(e,g,n,y,o)),0===c)return c}else{const v=Xr(g,t),x=Xr(y,r);pl(u,c,o,e,n,v[0],x[0]),pl(u,c,o,e,n,v[0],x[1]),pl(u,c,o,e,n,v[1],x[0]),pl(u,c,o,e,n,v[1],x[1])}}return c}function so(e,t,n,r,o=1/0){let s=o;const c=Sr(e,[0,e.length-1]);for(const u of n)if(!(s!==1/0&&oo(c,Sr(u,[0,u.length-1]),r)>=s)&&(s=Math.min(s,fh(e,t,u,!0,r,s)),0===s))return s;return s}function Uo(e,t,n,r,o=1/0){let s=o;const c=Sr(e,[0,e.length-1]);for(const u of n){if(s!==1/0&&oo(c,io(u),r)>=s)continue;const d=Ps(e,t,u,r,s);if(isNaN(d))return d;if(0===(s=Math.min(s,d)))return s}return s}function Go(e){return"Point"===e||"MultiPoint"===e||"LineString"===e||"MultiLineString"===e||"Polygon"===e||"MultiPolygon"===e}class Xs{constructor(t,n){this.type=Kt,this.geojson=t,this.geometries=n}static parse(t,n){if(2!==t.length)return n.error(`'distance' expression requires either one argument, but found ' ${t.length-1} instead.`);if(Uc(t[1])){const r=t[1];if("FeatureCollection"===r.type){for(let o=0;o<r.features.length;++o)if(Go(r.features[o].geometry.type))return new Xs(r,r.features[o].geometry)}else if("Feature"===r.type){if(Go(r.geometry.type))return new Xs(r,r.geometry)}else if(Go(r.type))return new Xs(r,r)}return n.error("'distance' expression needs to be an array with format ['Distance', GeoJSONObj].")}evaluate(t){const n=t.geometry(),r=t.canonicalID();if(null!=n&&null!=r){if("Point"===t.geometryType())return function(o,s,c){const u=[];for(const f of o)for(const m of f)u.push(Ci(m,s));const d=new dh(u[0][1],"meters");return"Point"===c.type||"MultiPoint"===c.type||"LineString"===c.type?fh(u,!1,"Point"===c.type?[c.coordinates]:c.coordinates,"LineString"===c.type,d):"MultiLineString"===c.type?so(u,!1,c.coordinates,d):"Polygon"===c.type||"MultiPolygon"===c.type?Uo(u,!1,"Polygon"===c.type?[c.coordinates]:c.coordinates,d):null}(n,r,this.geometries);if("LineString"===t.geometryType())return function(o,s,c){const u=[];for(const f of o){const m=[];for(const g of f)m.push(Ci(g,s));u.push(m)}const d=new dh(u[0][0][1],"meters");if("Point"===c.type||"MultiPoint"===c.type||"LineString"===c.type)return so("Point"===c.type?[c.coordinates]:c.coordinates,"LineString"===c.type,u,d);if("MultiLineString"===c.type){let f=1/0;for(let m=0;m<c.coordinates.length;m++){const g=so(c.coordinates[m],!0,u,d,f);if(isNaN(g))return g;if(0===(f=Math.min(f,g)))return f}return f}if("Polygon"===c.type||"MultiPolygon"===c.type){let f=1/0;for(let m=0;m<u.length;m++){const g=Uo(u[m],!0,"Polygon"===c.type?[c.coordinates]:c.coordinates,d,f);if(isNaN(g))return g;if(0===(f=Math.min(f,g)))return f}return f}return null}(n,r,this.geometries);if("Polygon"===t.geometryType())return function(o,s,c){const u=[];for(const f of function(m,g){const y=m.length;if(y<=1)return[m];const v=[];let x,w;for(let E=0;E<y;E++){const M=dl(m[E]);0!==M&&(m[E].area=Math.abs(M),void 0===w&&(w=M<0),w===M<0?(x&&v.push(x),x=[m[E]]):x.push(m[E]))}return x&&v.push(x),v}(o)){const m=[];for(let g=0;g<f.length;++g)m.push(fi(f[g],s));u.push(m)}const d=new dh(u[0][0][0][1],"meters");if("Point"===c.type||"MultiPoint"===c.type||"LineString"===c.type)return Uo("Point"===c.type?[c.coordinates]:c.coordinates,"LineString"===c.type,u,d);if("MultiLineString"===c.type){let f=1/0;for(let m=0;m<c.coordinates.length;m++){const g=Uo(c.coordinates[m],!0,u,d,f);if(isNaN(g))return g;if(0===(f=Math.min(f,g)))return f}return f}return"Polygon"===c.type||"MultiPolygon"===c.type?function(f,m,g){let y=1/0;for(const v of f)for(const x of m){const w=sr(v,x,g,y);if(isNaN(w))return w;if(0===(y=Math.min(y,w)))return y}return y}("Polygon"===c.type?[c.coordinates]:c.coordinates,u,d):null}(n,r,this.geometries);console.warn("Distance Expression: currently only evaluates valid Point/LineString/Polygon geometries.")}else console.warn("Distance Expression: requirs valid feature and canonical information.");return null}eachChild(){}outputDefined(){return!0}serialize(){return["distance",this.geojson]}}var ml=Xs;function Yr(e){if(e instanceof Si&&("get"===e.name&&1===e.args.length||"feature-state"===e.name||"has"===e.name&&1===e.args.length||"properties"===e.name||"geometry-type"===e.name||"id"===e.name||/^filter-/.test(e.name))||e instanceof Ws||e instanceof ml)return!1;let t=!0;return e.eachChild(n=>{t&&!Yr(n)&&(t=!1)}),t}function Nr(e){if(e instanceof Si&&"feature-state"===e.name)return!1;let t=!0;return e.eachChild(n=>{t&&!Nr(n)&&(t=!1)}),t}function On(e){if(e instanceof Si&&"config"===e.name)return!1;let t=!0;return e.eachChild(n=>{t&&!On(n)&&(t=!1)}),t}function Cr(e,t){if(e instanceof Si&&t.indexOf(e.name)>=0)return!1;let n=!0;return e.eachChild(r=>{n&&!Cr(r,t)&&(n=!1)}),n}class pi{constructor(t,n){this.type=n.type,this.name=t,this.boundExpression=n}static parse(t,n){if(2!==t.length||"string"!=typeof t[1])return n.error("'var' expression requires exactly one string literal argument.");const r=t[1];return n.scope.has(r)?new pi(r,n.scope.get(r)):n.error(`Unknown variable "${r}". Make sure "${r}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(t){return this.boundExpression.evaluate(t)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}var Ys=pi;class vi{constructor(t,n=[],r,o=new nx,s=[],c){this.registry=t,this.path=n,this.key=n.map(u=>`[${u}]`).join(""),this.scope=o,this.errors=s,this.expectedType=r,this.options=c}parse(t,n,r,o,s={}){return n||r?this.concat(n,r,o)._parse(t,s):this._parse(t,s)}_parse(t,n){function r(o,s,c){return"assert"===c?new ds(s,[o]):"coerce"===c?new Sa(s,[o]):o}if(null!==t&&"string"!=typeof t&&"boolean"!=typeof t&&"number"!=typeof t||(t=["literal",t]),Array.isArray(t)){if(0===t.length)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const o="string"==typeof t[0]?this.registry[t[0]]:void 0;if(o){let s=o.parse(t,this);if(!s)return null;if(this.expectedType){const c=this.expectedType,u=s.type;if("string"!==c.kind&&"number"!==c.kind&&"boolean"!==c.kind&&"object"!==c.kind&&"array"!==c.kind||"value"!==u.kind)if("color"!==c.kind&&"formatted"!==c.kind&&"resolvedImage"!==c.kind||"value"!==u.kind&&"string"!==u.kind){if(this.checkSubtype(c,u))return null}else s=r(s,c,n.typeAnnotation||"coerce");else s=r(s,c,n.typeAnnotation||"assert")}if(!(s instanceof qe)&&"resolvedImage"!==s.type.kind&&gl(s)){const c=new no(this.options);try{s=new qe(s.type,s.evaluate(c))}catch(u){return this.error(u.message),null}}return s}return Sa.parse(["to-array",t],this)}return this.error(void 0===t?"'undefined' value invalid. Use null instead.":"object"==typeof t?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof t} instead.`)}concat(t,n,r){const o="number"==typeof t?this.path.concat(t):this.path,s=r?this.scope.concat(r):this.scope;return new vi(this.registry,o,n||null,s,this.errors,this.options)}error(t,...n){const r=`${this.key}${n.map(o=>`[${o}]`).join("")}`;this.errors.push(new qn(r,t))}checkSubtype(t,n){const r=sh(t,n);return r&&this.error(r),r}}var ph=vi;function gl(e){if(e instanceof Ys)return gl(e.boundExpression);if(e instanceof Si&&"error"===e.name||e instanceof Si&&"config"===e.name||e instanceof uh||e instanceof Ws||e instanceof ml)return!1;const t=e instanceof Sa||e instanceof ds;let n=!0;return e.eachChild(r=>{n=t?n&&gl(r):n&&r instanceof qe}),!!n&&Yr(e)&&Cr(e,["zoom","heatmap-density","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light"])}function Rs(e,t){const n=e.length-1;let r,o,s=0,c=n,u=0;for(;s<=c;)if(u=Math.floor((s+c)/2),r=e[u],o=e[u+1],r<=t){if(u===n||t<o)return u;s=u+1}else{if(!(r>t))throw new kr("Input is not a number.");c=u-1}return 0}class c_{constructor(t,n,r){this.type=t,this.input=n,this.labels=[],this.outputs=[];for(const[o,s]of r)this.labels.push(o),this.outputs.push(s)}static parse(t,n){if(t.length-1<4)return n.error(`Expected at least 4 arguments, but found only ${t.length-1}.`);if((t.length-1)%2!=0)return n.error("Expected an even number of arguments.");const r=n.parse(t[1],1,Kt);if(!r)return null;const o=[];let s=null;n.expectedType&&"value"!==n.expectedType.kind&&(s=n.expectedType);for(let c=1;c<t.length;c+=2){const u=1===c?-1/0:t[c],d=t[c+1],f=c,m=c+1;if("number"!=typeof u)return n.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',f);if(o.length&&o[o.length-1][0]>=u)return n.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',f);const g=n.parse(d,m,s);if(!g)return null;s=s||g.type,o.push([u,g])}return new c_(s,r,o)}evaluate(t){const n=this.labels,r=this.outputs;if(1===n.length)return r[0].evaluate(t);const o=this.input.evaluate(t);if(o<=n[0])return r[0].evaluate(t);const s=n.length;return o>=n[s-1]?r[s-1].evaluate(t):r[Rs(n,o)].evaluate(t)}eachChild(t){t(this.input);for(const n of this.outputs)t(n)}outputDefined(){return this.outputs.every(t=>t.outputDefined())}serialize(){const t=["step",this.input.serialize()];for(let n=0;n<this.labels.length;n++)n>0&&t.push(this.labels[n]),t.push(this.outputs[n].serialize());return t}}var u_=c_;function le(e,t,n){return e*(1-n)+t*n}function ve(e,t,n){return e.map((r,o)=>le(r,t[o],n))}var un=Object.freeze({__proto__:null,array:ve,color:function(e,t,n){return new ke(le(e.r,t.r,n),le(e.g,t.g,n),le(e.b,t.b,n),le(e.a,t.a,n))},number:le});const mh=4/29,mi=6/29,Zc=3*mi*mi,gi=mi*mi*mi,sc=Math.PI/180,gh=180/Math.PI;function ln(e){return e>gi?Math.pow(e,1/3):e/Zc+mh}function Wc(e){return e>mi?e*e*e:Zc*(e-mh)}function Gp(e){return 255*(e<=.0031308?12.92*e:1.055*Math.pow(e,1/2.4)-.055)}function ac(e){return(e/=255)<=.04045?e/12.92:Math.pow((e+.055)/1.055,2.4)}function li(e){const t=ac(e.r),n=ac(e.g),r=ac(e.b),o=ln((.4124564*t+.3575761*n+.1804375*r)/.95047),s=ln((.2126729*t+.7151522*n+.072175*r)/1);return{l:116*s-16,a:500*(o-s),b:200*(s-ln((.0193339*t+.119192*n+.9503041*r)/1.08883)),alpha:e.a}}function _h(e){let t=(e.l+16)/116,n=isNaN(e.a)?t:t+e.a/500,r=isNaN(e.b)?t:t-e.b/200;return t=1*Wc(t),n=.95047*Wc(n),r=1.08883*Wc(r),new ke(Gp(3.2404542*n-1.5371385*t-.4985314*r),Gp(-.969266*n+1.8760108*t+.041556*r),Gp(.0556434*n-.2040259*t+1.0572252*r),e.alpha)}function yh(e,t,n){const r=t-e;return e+n*(r>180||r<-180?r-360*Math.round(r/360):r)}const $o={forward:li,reverse:_h,interpolate:function(e,t,n){return{l:le(e.l,t.l,n),a:le(e.a,t.a,n),b:le(e.b,t.b,n),alpha:le(e.alpha,t.alpha,n)}}},_l={forward:function(e){const{l:t,a:n,b:r}=li(e),o=Math.atan2(r,n)*gh;return{h:o<0?o+360:o,c:Math.sqrt(n*n+r*r),l:t,alpha:e.a}},reverse:function(e){const t=e.h*sc,n=e.c;return _h({l:e.l,a:Math.cos(t)*n,b:Math.sin(t)*n,alpha:e.alpha})},interpolate:function(e,t,n){return{h:yh(e.h,t.h,n),c:le(e.c,t.c,n),l:le(e.l,t.l,n),alpha:le(e.alpha,t.alpha,n)}}};var h_=Object.freeze({__proto__:null,hcl:_l,lab:$o});class Ks{constructor(t,n,r,o,s){this.type=t,this.operator=n,this.interpolation=r,this.input=o,this.labels=[],this.outputs=[];for(const[c,u]of s)this.labels.push(c),this.outputs.push(u)}static interpolationFactor(t,n,r,o){let s=0;if("exponential"===t.name)s=Js(n,t.base,r,o);else if("linear"===t.name)s=Js(n,1,r,o);else if("cubic-bezier"===t.name){const c=t.controlPoints;s=new ql(c[0],c[1],c[2],c[3]).solve(Js(n,1,r,o))}return s}static parse(t,n){let[r,o,s,...c]=t;if(!Array.isArray(o)||0===o.length)return n.error("Expected an interpolation type expression.",1);if("linear"===o[0])o={name:"linear"};else if("exponential"===o[0]){const f=o[1];if("number"!=typeof f)return n.error("Exponential interpolation requires a numeric base.",1,1);o={name:"exponential",base:f}}else{if("cubic-bezier"!==o[0])return n.error(`Unknown interpolation type ${String(o[0])}`,1,0);{const f=o.slice(1);if(4!==f.length||f.some(m=>"number"!=typeof m||m<0||m>1))return n.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);o={name:"cubic-bezier",controlPoints:f}}}if(t.length-1<4)return n.error(`Expected at least 4 arguments, but found only ${t.length-1}.`);if((t.length-1)%2!=0)return n.error("Expected an even number of arguments.");if(s=n.parse(s,2,Kt),!s)return null;const u=[];let d=null;"interpolate-hcl"===r||"interpolate-lab"===r?d=yo:n.expectedType&&"value"!==n.expectedType.kind&&(d=n.expectedType);for(let f=0;f<c.length;f+=2){const m=c[f],g=c[f+1],y=f+3,v=f+4;if("number"!=typeof m)return n.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',y);if(u.length&&u[u.length-1][0]>=m)return n.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',y);const x=n.parse(g,v,d);if(!x)return null;d=d||x.type,u.push([m,x])}return"number"===d.kind||"color"===d.kind||"array"===d.kind&&"number"===d.itemType.kind&&"number"==typeof d.N?new Ks(d,r,o,s,u):n.error(`Type ${Or(d)} is not interpolatable.`)}evaluate(t){const n=this.labels,r=this.outputs;if(1===n.length)return r[0].evaluate(t);const o=this.input.evaluate(t);if(o<=n[0])return r[0].evaluate(t);const s=n.length;if(o>=n[s-1])return r[s-1].evaluate(t);const c=Rs(n,o),u=Ks.interpolationFactor(this.interpolation,o,n[c],n[c+1]),d=r[c].evaluate(t),f=r[c+1].evaluate(t);return"interpolate"===this.operator?un[this.type.kind.toLowerCase()](d,f,u):"interpolate-hcl"===this.operator?_l.reverse(_l.interpolate(_l.forward(d),_l.forward(f),u)):$o.reverse($o.interpolate($o.forward(d),$o.forward(f),u))}eachChild(t){t(this.input);for(const n of this.outputs)t(n)}outputDefined(){return this.outputs.every(t=>t.outputDefined())}serialize(){let t;t="linear"===this.interpolation.name?["linear"]:"exponential"===this.interpolation.name?1===this.interpolation.base?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier"].concat(this.interpolation.controlPoints);const n=[this.operator,t,this.input.serialize()];for(let r=0;r<this.labels.length;r++)n.push(this.labels[r],this.outputs[r].serialize());return n}}function Js(e,t,n,r){const o=r-n,s=e-n;return 0===o?0:1===t?s/o:(Math.pow(t,s)-1)/(Math.pow(t,o)-1)}var Ho=Ks;class Xc{constructor(t,n){this.type=t,this.args=n}static parse(t,n){if(t.length<2)return n.error("Expectected at least one argument.");let r=null;const o=n.expectedType;o&&"value"!==o.kind&&(r=o);const s=[];for(const u of t.slice(1)){const d=n.parse(u,1+s.length,r,void 0,{typeAnnotation:"omit"});if(!d)return null;r=r||d.type,s.push(d)}const c=o&&s.some(u=>sh(o,u.type));return new Xc(c?cn:r,s)}evaluate(t){let n,r=null,o=0;for(const s of this.args){if(o++,r=s.evaluate(t),r&&r instanceof Qn&&!r.available&&(n||(n=r),r=null,o===this.args.length))return n;if(null!==r)break}return r}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every(t=>t.outputDefined())}serialize(){const t=["coalesce"];return this.eachChild(n=>{t.push(n.serialize())}),t}}var zn=Xc;class ix{constructor(t,n){this.type=n.type,this.bindings=[].concat(t),this.result=n}evaluate(t){return this.result.evaluate(t)}eachChild(t){for(const n of this.bindings)t(n[1]);t(this.result)}static parse(t,n){if(t.length<4)return n.error(`Expected at least 3 arguments, but found ${t.length-1} instead.`);const r=[];for(let s=1;s<t.length-1;s+=2){const c=t[s];if("string"!=typeof c)return n.error(`Expected string, but found ${typeof c} instead.`,s);if(/[^a-zA-Z0-9_]/.test(c))return n.error("Variable names must contain only alphanumeric characters or '_'.",s);const u=n.parse(t[s+1],s+1);if(!u)return null;r.push([c,u])}const o=n.parse(t[t.length-1],t.length-1,n.expectedType,r);return o?new ix(r,o):null}outputDefined(){return this.result.outputDefined()}serialize(){const t=["let"];for(const[n,r]of this.bindings)t.push(n,r.serialize());return t.push(this.result.serialize()),t}}var $p=ix;class Hp{constructor(t,n,r){this.type=t,this.index=n,this.input=r}static parse(t,n){if(3!==t.length)return n.error(`Expected 2 arguments, but found ${t.length-1} instead.`);const r=n.parse(t[1],1,Kt),o=n.parse(t[2],2,eo(n.expectedType||cn));return r&&o?new Hp(o.type.itemType,r,o):null}evaluate(t){const n=this.index.evaluate(t),r=this.input.evaluate(t);if(n<0)throw new kr(`Array index out of bounds: ${n} < 0.`);if(n>=r.length)throw new kr(`Array index out of bounds: ${n} > ${r.length-1}.`);if(n!==Math.floor(n))throw new kr(`Array index must be an integer, but found ${n} instead.`);return r[n]}eachChild(t){t(this.index),t(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}var Ra=Hp;class vh{constructor(t,n){this.type=gn,this.needle=t,this.haystack=n}static parse(t,n){if(3!==t.length)return n.error(`Expected 2 arguments, but found ${t.length-1} instead.`);const r=n.parse(t[1],1,cn),o=n.parse(t[2],2,cn);return r&&o?Jl(r.type,[gn,an,Kt,_o,cn])?new vh(r,o):n.error(`Expected first argument to be of type boolean, string, number or null, but found ${Or(r.type)} instead`):null}evaluate(t){const n=this.needle.evaluate(t),r=this.haystack.evaluate(t);if(null==r)return!1;if(!hs(n,["boolean","string","number","null"]))throw new kr(`Expected first argument to be of type boolean, string, number or null, but found ${Or(on(n))} instead.`);if(!hs(r,["string","array"]))throw new kr(`Expected second argument to be of type array or string, but found ${Or(on(r))} instead.`);return r.indexOf(n)>=0}eachChild(t){t(this.needle),t(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}var xh=vh;class lc{constructor(t,n,r){this.type=Kt,this.needle=t,this.haystack=n,this.fromIndex=r}static parse(t,n){if(t.length<=2||t.length>=5)return n.error(`Expected 3 or 4 arguments, but found ${t.length-1} instead.`);const r=n.parse(t[1],1,cn),o=n.parse(t[2],2,cn);if(!r||!o)return null;if(!Jl(r.type,[gn,an,Kt,_o,cn]))return n.error(`Expected first argument to be of type boolean, string, number or null, but found ${Or(r.type)} instead`);if(4===t.length){const s=n.parse(t[3],3,Kt);return s?new lc(r,o,s):null}return new lc(r,o)}evaluate(t){const n=this.needle.evaluate(t),r=this.haystack.evaluate(t);if(!hs(n,["boolean","string","number","null"]))throw new kr(`Expected first argument to be of type boolean, string, number or null, but found ${Or(on(n))} instead.`);if(!hs(r,["string","array"]))throw new kr(`Expected second argument to be of type array or string, but found ${Or(on(r))} instead.`);if(this.fromIndex){const o=this.fromIndex.evaluate(t);return r.indexOf(n,o)}return r.indexOf(n)}eachChild(t){t(this.needle),t(this.haystack),this.fromIndex&&t(this.fromIndex)}outputDefined(){return!1}serialize(){if(null!=this.fromIndex&&void 0!==this.fromIndex){const t=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),t]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}var Yi=lc;class ox{constructor(t,n,r,o,s,c){this.inputType=t,this.type=n,this.input=r,this.cases=o,this.outputs=s,this.otherwise=c}static parse(t,n){if(t.length<5)return n.error(`Expected at least 4 arguments, but found only ${t.length-1}.`);if(t.length%2!=1)return n.error("Expected an even number of arguments.");let r,o;n.expectedType&&"value"!==n.expectedType.kind&&(o=n.expectedType);const s={},c=[];for(let f=2;f<t.length-1;f+=2){let m=t[f];const g=t[f+1];Array.isArray(m)||(m=[m]);const y=n.concat(f);if(0===m.length)return y.error("Expected at least one branch label.");for(const x of m){if("number"!=typeof x&&"string"!=typeof x)return y.error("Branch labels must be numbers or strings.");if("number"==typeof x&&Math.abs(x)>Number.MAX_SAFE_INTEGER)return y.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if("number"==typeof x&&Math.floor(x)!==x)return y.error("Numeric branch labels must be integer values.");if(r){if(y.checkSubtype(r,on(x)))return null}else r=on(x);if(void 0!==s[String(x)])return y.error("Branch labels must be unique.");s[String(x)]=c.length}const v=n.parse(g,f,o);if(!v)return null;o=o||v.type,c.push(v)}const u=n.parse(t[1],1,cn);if(!u)return null;const d=n.parse(t[t.length-1],t.length-1,o);return d?"value"!==u.type.kind&&n.concat(1).checkSubtype(r,u.type)?null:new ox(r,o,u,s,c,d):null}evaluate(t){const n=this.input.evaluate(t);return(on(n)===this.inputType&&this.outputs[this.cases[n]]||this.otherwise).evaluate(t)}eachChild(t){t(this.input),this.outputs.forEach(t),t(this.otherwise)}outputDefined(){return this.outputs.every(t=>t.outputDefined())&&this.otherwise.outputDefined()}serialize(){const t=["match",this.input.serialize()],n=Object.keys(this.cases).sort(),r=[],o={};for(const c of n){const u=o[this.cases[c]];void 0===u?(o[this.cases[c]]=r.length,r.push([this.cases[c],[c]])):r[u][1].push(c)}const s=c=>"number"===this.inputType.kind?Number(c):c;for(const[c,u]of r)t.push(1===u.length?s(u[0]):u.map(s)),t.push(this.outputs[c].serialize());return t.push(this.otherwise.serialize()),t}}var qo=ox;class Ki{constructor(t,n,r){this.type=t,this.branches=n,this.otherwise=r}static parse(t,n){if(t.length<4)return n.error(`Expected at least 3 arguments, but found only ${t.length-1}.`);if(t.length%2!=0)return n.error("Expected an odd number of arguments.");let r;n.expectedType&&"value"!==n.expectedType.kind&&(r=n.expectedType);const o=[];for(let c=1;c<t.length-1;c+=2){const u=n.parse(t[c],c,gn);if(!u)return null;const d=n.parse(t[c+1],c+1,r);if(!d)return null;o.push([u,d]),r=r||d.type}const s=n.parse(t[t.length-1],t.length-1,r);return s?new Ki(r,o,s):null}evaluate(t){for(const[n,r]of this.branches)if(n.evaluate(t))return r.evaluate(t);return this.otherwise.evaluate(t)}eachChild(t){for(const[n,r]of this.branches)t(n),t(r);t(this.otherwise)}outputDefined(){return this.branches.every(([t,n])=>n.outputDefined())&&this.otherwise.outputDefined()}serialize(){const t=["case"];return this.eachChild(n=>{t.push(n.serialize())}),t}}var d_=Ki;class La{constructor(t,n,r,o){this.type=t,this.input=n,this.beginIndex=r,this.endIndex=o}static parse(t,n){if(t.length<=2||t.length>=5)return n.error(`Expected 3 or 4 arguments, but found ${t.length-1} instead.`);const r=n.parse(t[1],1,cn),o=n.parse(t[2],2,Kt);if(!r||!o)return null;if(!Jl(r.type,[eo(cn),an,cn]))return n.error(`Expected first argument to be of type array or string, but found ${Or(r.type)} instead`);if(4===t.length){const s=n.parse(t[3],3,Kt);return s?new La(r.type,r,o,s):null}return new La(r.type,r,o)}evaluate(t){const n=this.input.evaluate(t),r=this.beginIndex.evaluate(t);if(!hs(n,["string","array"]))throw new kr(`Expected first argument to be of type array or string, but found ${Or(on(n))} instead.`);if(this.endIndex){const o=this.endIndex.evaluate(t);return n.slice(r,o)}return n.slice(r)}eachChild(t){t(this.input),t(this.beginIndex),this.endIndex&&t(this.endIndex)}outputDefined(){return!1}serialize(){if(null!=this.endIndex&&void 0!==this.endIndex){const t=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),t]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}var qp=La;function Os(e,t){return"=="===e||"!="===e?"boolean"===t.kind||"string"===t.kind||"number"===t.kind||"null"===t.kind||"value"===t.kind:"string"===t.kind||"number"===t.kind||"value"===t.kind}function Zp(e,t,n,r){return 0===r.compare(t,n)}function bh(e,t,n){const r="=="!==e&&"!="!==e;return class F2{constructor(s,c,u){this.type=gn,this.lhs=s,this.rhs=c,this.collator=u,this.hasUntypedArgument="value"===s.type.kind||"value"===c.type.kind}static parse(s,c){if(3!==s.length&&4!==s.length)return c.error("Expected two or three arguments.");const u=s[0];let d=c.parse(s[1],1,cn);if(!d)return null;if(!Os(u,d.type))return c.concat(1).error(`"${u}" comparisons are not supported for type '${Or(d.type)}'.`);let f=c.parse(s[2],2,cn);if(!f)return null;if(!Os(u,f.type))return c.concat(2).error(`"${u}" comparisons are not supported for type '${Or(f.type)}'.`);if(d.type.kind!==f.type.kind&&"value"!==d.type.kind&&"value"!==f.type.kind)return c.error(`Cannot compare types '${Or(d.type)}' and '${Or(f.type)}'.`);r&&("value"===d.type.kind&&"value"!==f.type.kind?d=new ds(f.type,[d]):"value"!==d.type.kind&&"value"===f.type.kind&&(f=new ds(d.type,[f])));let m=null;if(4===s.length){if("string"!==d.type.kind&&"string"!==f.type.kind&&"value"!==d.type.kind&&"value"!==f.type.kind)return c.error("Cannot use collator to compare non-string types.");if(m=c.parse(s[3],3,Zi),!m)return null}return new F2(d,f,m)}evaluate(s){const c=this.lhs.evaluate(s),u=this.rhs.evaluate(s);if(r&&this.hasUntypedArgument){const d=on(c),f=on(u);if(d.kind!==f.kind||"string"!==d.kind&&"number"!==d.kind)throw new kr(`Expected arguments for "${e}" to be (string, string) or (number, number), but found (${d.kind}, ${f.kind}) instead.`)}if(this.collator&&!r&&this.hasUntypedArgument){const d=on(c),f=on(u);if("string"!==d.kind||"string"!==f.kind)return t(s,c,u)}return this.collator?n(s,c,u,this.collator.evaluate(s)):t(s,c,u)}eachChild(s){s(this.lhs),s(this.rhs),this.collator&&s(this.collator)}outputDefined(){return!0}serialize(){const s=[e];return this.eachChild(c=>{s.push(c.serialize())}),s}}}const FT=bh("==",function(e,t,n){return t===n},Zp),mC=bh("!=",function(e,t,n){return t!==n},function(e,t,n,r){return!Zp(0,t,n,r)}),NT=bh("<",function(e,t,n){return t<n},function(e,t,n,r){return r.compare(t,n)<0}),zT=bh(">",function(e,t,n){return t>n},function(e,t,n,r){return r.compare(t,n)>0}),gC=bh("<=",function(e,t,n){return t<=n},function(e,t,n,r){return r.compare(t,n)<=0}),_C=bh(">=",function(e,t,n){return t>=n},function(e,t,n,r){return r.compare(t,n)>=0});class sx{constructor(t,n,r,o,s,c){this.type=an,this.number=t,this.locale=n,this.currency=r,this.unit=o,this.minFractionDigits=s,this.maxFractionDigits=c}static parse(t,n){if(3!==t.length)return n.error("Expected two arguments.");const r=n.parse(t[1],1,Kt);if(!r)return null;const o=t[2];if("object"!=typeof o||Array.isArray(o))return n.error("NumberFormat options argument must be an object.");let s=null;if(o.locale&&(s=n.parse(o.locale,1,an),!s))return null;let c=null;if(o.currency&&(c=n.parse(o.currency,1,an),!c))return null;let u=null;if(o.unit&&(u=n.parse(o.unit,1,an),!u))return null;let d=null;if(o["min-fraction-digits"]&&(d=n.parse(o["min-fraction-digits"],1,Kt),!d))return null;let f=null;return o["max-fraction-digits"]&&(f=n.parse(o["max-fraction-digits"],1,Kt),!f)?null:new sx(r,s,c,u,d,f)}evaluate(t){return new Intl.NumberFormat(this.locale?this.locale.evaluate(t):[],{style:(this.currency?"currency":this.unit&&"unit")||"decimal",currency:this.currency?this.currency.evaluate(t):void 0,unit:this.unit?this.unit.evaluate(t):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(t):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(t):void 0}).format(this.number.evaluate(t))}eachChild(t){t(this.number),this.locale&&t(this.locale),this.currency&&t(this.currency),this.unit&&t(this.unit),this.minFractionDigits&&t(this.minFractionDigits),this.maxFractionDigits&&t(this.maxFractionDigits)}outputDefined(){return!1}serialize(){const t={};return this.locale&&(t.locale=this.locale.serialize()),this.currency&&(t.currency=this.currency.serialize()),this.unit&&(t.unit=this.unit.serialize()),this.minFractionDigits&&(t["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(t["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),t]}}class ax{constructor(t){this.type=Kt,this.input=t}static parse(t,n){if(2!==t.length)return n.error(`Expected 1 argument, but found ${t.length-1} instead.`);const r=n.parse(t[1],1);return r?"array"!==r.type.kind&&"string"!==r.type.kind&&"value"!==r.type.kind?n.error(`Expected argument of type string or array, but found ${Or(r.type)} instead.`):new ax(r):null}evaluate(t){const n=this.input.evaluate(t);if("string"==typeof n||Array.isArray(n))return n.length;throw new kr(`Expected value to be of type string or array, but found ${Or(on(n))} instead.`)}eachChild(t){t(this.input)}outputDefined(){return!1}serialize(){const t=["length"];return this.eachChild(n=>{t.push(n.serialize())}),t}}function lx(e){return function(){e=1831565813+(e|=0)|0;let t=Math.imul(e^e>>>15,1|e);return t=t+Math.imul(t^t>>>7,61|t)^t,((t^t>>>14)>>>0)/4294967296}}const BT={"==":FT,"!=":mC,">":zT,"<":NT,">=":_C,"<=":gC,array:ds,at:Ra,boolean:ds,case:d_,coalesce:zn,collator:uh,format:Gc,image:ul,in:xh,"index-of":Yi,interpolate:Ho,"interpolate-hcl":Ho,"interpolate-lab":Ho,length:ax,let:$p,literal:qe,match:qo,number:ds,"number-format":sx,object:ds,slice:qp,step:u_,string:ds,"to-boolean":Sa,"to-color":Sa,"to-number":Sa,"to-string":Sa,var:Ys,within:Ws,distance:ml};function jT(e,[t,n,r,o]){t=t.evaluate(e),n=n.evaluate(e),r=r.evaluate(e);const s=o?o.evaluate(e):1,c=ch(t,n,r,s);if(c)throw new kr(c);return new ke(t/255*s,n/255*s,r/255*s,s)}function VT(e,[t,n,r,o]){t=t.evaluate(e),n=n.evaluate(e),r=r.evaluate(e);const s=o?o.evaluate(e):1,c=(m=n,g=r,y=s,"number"==typeof(f=t)&&f>=0&&f<=360?"number"==typeof m&&m>=0&&m<=100&&"number"==typeof g&&g>=0&&g<=100?void 0===y||"number"==typeof y&&y>=0&&y<=1?null:`Invalid hsla value [${[f,m,g,y].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid hsla value [${("number"==typeof y?[f,m,g,y]:[f,m,g]).join(", ")}]: 's', and 'l' must be between 0 and 100.`:`Invalid hsla value [${("number"==typeof y?[f,m,g,y]:[f,m,g]).join(", ")}]: 'h' must be between 0 and 360.`);var f,m,g,y;if(c)throw new kr(c);const u=`hsla(${t}, ${n}%, ${r}%, ${s})`,d=ke.parse(u);if(!d)throw new kr(`Failed to parse HSLA color: ${u}`);return d}function UT(e,t){return e in t}function cx(e,t){const n=t[e];return void 0===n?null:n}function GT(e,t){switch(e){case"string":return String(t);case"number":return+t;case"boolean":return!!t;case"color":return ke.parse(t)}return t}function $T(e,t,n,r){return void 0!==r&&(e=r*Math.round(e/r)),void 0!==t&&e<t&&(e=t),void 0!==n&&e>n&&(e=n),e}function f_(e,t,n){n.length&&(t+=`\x1f${n}`);const r=e.getConfig(t);if(!r)return null;const{type:o,value:s,values:c,minValue:u,maxValue:d,stepValue:f}=r,m=r.default.evaluate(e);let g=s?s.evaluate(e):m;return o&&(g=GT(o,g)),void 0!==s&&void 0!==g&&c&&!c.includes(g)&&(g=m,o&&(g=GT(o,g))),void 0===g||void 0===u&&void 0===d&&void 0===f||("number"==typeof g?g=$T(g,u,d,f):Array.isArray(g)&&(g=g.map(y=>"number"==typeof y?$T(y,u,d,f):y))),g}function cc(e){return{type:e}}Si.register(BT,{error:[{kind:"error"},[an],(e,[t])=>{throw new kr(t.evaluate(e))}],typeof:[an,[cn],(e,[t])=>Or(on(t.evaluate(e)))],"to-rgba":[eo(Kt,4),[yo],(e,[t])=>t.evaluate(e).toArray()],rgb:[yo,[Kt,Kt,Kt],jT],rgba:[yo,[Kt,Kt,Kt,Kt],jT],hsl:[yo,[Kt,Kt,Kt],VT],hsla:[yo,[Kt,Kt,Kt,Kt],VT],has:{type:gn,overloads:[[[an],(e,[t])=>UT(t.evaluate(e),e.properties())],[[an,al],(e,[t,n])=>UT(t.evaluate(e),n.evaluate(e))]]},get:{type:cn,overloads:[[[an],(e,[t])=>cx(t.evaluate(e),e.properties())],[[an,al],(e,[t,n])=>cx(t.evaluate(e),n.evaluate(e))]]},config:{type:cn,overloads:[[[an],(e,[t])=>f_(e,t.evaluate(e),"")],[[an,an],(e,[t,n])=>f_(e,t.evaluate(e),n.evaluate(e))]]},"feature-state":[cn,[an],(e,[t])=>cx(t.evaluate(e),e.featureState||{})],properties:[al,[],e=>e.properties()],"geometry-type":[an,[],e=>e.geometryType()],id:[cn,[],e=>e.id()],zoom:[Kt,[],e=>e.globals.zoom],pitch:[Kt,[],e=>e.globals.pitch||0],"distance-from-center":[Kt,[],e=>e.distanceFromCenter()],"measure-light":[Kt,[an],(e,[t])=>e.measureLight(t.evaluate(e))],"heatmap-density":[Kt,[],e=>e.globals.heatmapDensity||0],"line-progress":[Kt,[],e=>e.globals.lineProgress||0],"raster-value":[Kt,[],e=>e.globals.rasterValue||0],"sky-radial-progress":[Kt,[],e=>e.globals.skyRadialProgress||0],accumulated:[cn,[],e=>void 0===e.globals.accumulated?null:e.globals.accumulated],"+":[Kt,cc(Kt),(e,t)=>{let n=0;for(const r of t)n+=r.evaluate(e);return n}],"*":[Kt,cc(Kt),(e,t)=>{let n=1;for(const r of t)n*=r.evaluate(e);return n}],"-":{type:Kt,overloads:[[[Kt,Kt],(e,[t,n])=>t.evaluate(e)-n.evaluate(e)],[[Kt],(e,[t])=>-t.evaluate(e)]]},"/":[Kt,[Kt,Kt],(e,[t,n])=>t.evaluate(e)/n.evaluate(e)],"%":[Kt,[Kt,Kt],(e,[t,n])=>t.evaluate(e)%n.evaluate(e)],ln2:[Kt,[],()=>Math.LN2],pi:[Kt,[],()=>Math.PI],e:[Kt,[],()=>Math.E],"^":[Kt,[Kt,Kt],(e,[t,n])=>Math.pow(t.evaluate(e),n.evaluate(e))],sqrt:[Kt,[Kt],(e,[t])=>Math.sqrt(t.evaluate(e))],log10:[Kt,[Kt],(e,[t])=>Math.log(t.evaluate(e))/Math.LN10],ln:[Kt,[Kt],(e,[t])=>Math.log(t.evaluate(e))],log2:[Kt,[Kt],(e,[t])=>Math.log(t.evaluate(e))/Math.LN2],sin:[Kt,[Kt],(e,[t])=>Math.sin(t.evaluate(e))],cos:[Kt,[Kt],(e,[t])=>Math.cos(t.evaluate(e))],tan:[Kt,[Kt],(e,[t])=>Math.tan(t.evaluate(e))],asin:[Kt,[Kt],(e,[t])=>Math.asin(t.evaluate(e))],acos:[Kt,[Kt],(e,[t])=>Math.acos(t.evaluate(e))],atan:[Kt,[Kt],(e,[t])=>Math.atan(t.evaluate(e))],min:[Kt,cc(Kt),(e,t)=>Math.min(...t.map(n=>n.evaluate(e)))],max:[Kt,cc(Kt),(e,t)=>Math.max(...t.map(n=>n.evaluate(e)))],abs:[Kt,[Kt],(e,[t])=>Math.abs(t.evaluate(e))],round:[Kt,[Kt],(e,[t])=>{const n=t.evaluate(e);return n<0?-Math.round(-n):Math.round(n)}],floor:[Kt,[Kt],(e,[t])=>Math.floor(t.evaluate(e))],ceil:[Kt,[Kt],(e,[t])=>Math.ceil(t.evaluate(e))],"filter-==":[gn,[an,cn],(e,[t,n])=>e.properties()[t.value]===n.value],"filter-id-==":[gn,[cn],(e,[t])=>e.id()===t.value],"filter-type-==":[gn,[an],(e,[t])=>e.geometryType()===t.value],"filter-<":[gn,[an,cn],(e,[t,n])=>{const r=e.properties()[t.value],o=n.value;return typeof r==typeof o&&r<o}],"filter-id-<":[gn,[cn],(e,[t])=>{const n=e.id(),r=t.value;return typeof n==typeof r&&n<r}],"filter->":[gn,[an,cn],(e,[t,n])=>{const r=e.properties()[t.value],o=n.value;return typeof r==typeof o&&r>o}],"filter-id->":[gn,[cn],(e,[t])=>{const n=e.id(),r=t.value;return typeof n==typeof r&&n>r}],"filter-<=":[gn,[an,cn],(e,[t,n])=>{const r=e.properties()[t.value],o=n.value;return typeof r==typeof o&&r<=o}],"filter-id-<=":[gn,[cn],(e,[t])=>{const n=e.id(),r=t.value;return typeof n==typeof r&&n<=r}],"filter->=":[gn,[an,cn],(e,[t,n])=>{const r=e.properties()[t.value],o=n.value;return typeof r==typeof o&&r>=o}],"filter-id->=":[gn,[cn],(e,[t])=>{const n=e.id(),r=t.value;return typeof n==typeof r&&n>=r}],"filter-has":[gn,[cn],(e,[t])=>t.value in e.properties()],"filter-has-id":[gn,[],e=>null!==e.id()&&void 0!==e.id()],"filter-type-in":[gn,[eo(an)],(e,[t])=>t.value.indexOf(e.geometryType())>=0],"filter-id-in":[gn,[eo(cn)],(e,[t])=>t.value.indexOf(e.id())>=0],"filter-in-small":[gn,[an,eo(cn)],(e,[t,n])=>n.value.indexOf(e.properties()[t.value])>=0],"filter-in-large":[gn,[an,eo(cn)],(e,[t,n])=>function(r,o,s,c){for(;s<=c;){const u=s+c>>1;if(o[u]===r)return!0;o[u]>r?c=u-1:s=u+1}return!1}(e.properties()[t.value],n.value,0,n.value.length-1)],all:{type:gn,overloads:[[[gn,gn],(e,[t,n])=>t.evaluate(e)&&n.evaluate(e)],[cc(gn),(e,t)=>{for(const n of t)if(!n.evaluate(e))return!1;return!0}]]},any:{type:gn,overloads:[[[gn,gn],(e,[t,n])=>t.evaluate(e)||n.evaluate(e)],[cc(gn),(e,t)=>{for(const n of t)if(n.evaluate(e))return!0;return!1}]]},"!":[gn,[gn],(e,[t])=>!t.evaluate(e)],"is-supported-script":[gn,[an],(e,[t])=>{const n=e.globals&&e.globals.isSupportedScript;return!n||n(t.evaluate(e))}],upcase:[an,[an],(e,[t])=>t.evaluate(e).toUpperCase()],downcase:[an,[an],(e,[t])=>t.evaluate(e).toLowerCase()],concat:[an,cc(cn),(e,t)=>t.map(n=>tc(n.evaluate(e))).join("")],"resolved-locale":[an,[Zi],(e,[t])=>t.evaluate(e).resolvedLocale()],random:[Kt,[Kt,Kt,cn],(e,t)=>{const[n,r,o]=t.map(c=>c.evaluate(e));if(n>r||n===r)return n;let s;if("string"==typeof o)s=function(c){let u=0;if(0===c.length)return u;for(let d=0;d<c.length;d++)u=(u<<5)-u+c.charCodeAt(d),u&=u;return u}(o);else{if("number"!=typeof o)throw new kr(`Invalid seed input: ${o}`);s=o}return n+lx(s)()*(r-n)}]});var Wp=BT;function HT(e){return{result:"success",value:e}}function wh(e){return{result:"error",value:e}}function uc(e,t){return!!e&&!!e.parameters&&e.parameters.indexOf(t)>-1}function Zo(e){return"data-driven"===e["property-type"]}function qT(e){return uc(e.expression,"measure-light")}function ux(e){return uc(e.expression,"zoom")}function Ai(e){return!!e.expression&&e.expression.interpolated}function Yc(e){return"object"==typeof e&&null!==e&&!Array.isArray(e)}function ks(e){return e}function p_(e,t){const n="color"===t.type,r=e.stops&&"object"==typeof e.stops[0][0],o=r||!(r||void 0!==e.property),s=e.type||(Ai(t)?"exponential":"interval");if(n&&((e=lr({},e)).stops&&(e.stops=e.stops.map(f=>[f[0],ke.parse(f[1])])),e.default=ke.parse(e.default?e.default:t.default)),e.colorSpace&&"rgb"!==e.colorSpace&&!h_[e.colorSpace])throw new Error(`Unknown color space: ${e.colorSpace}`);let c,u,d;if("exponential"===s)c=Xp;else if("interval"===s)c=dx;else if("categorical"===s){c=hx,u=Object.create(null);for(const f of e.stops)u[f[0]]=f[1];d=typeof e.stops[0][0]}else{if("identity"!==s)throw new Error(`Unknown function type "${s}"`);c=fx}if(r){const f={},m=[];for(let v=0;v<e.stops.length;v++){const x=e.stops[v],w=x[0].zoom;void 0===f[w]&&(f[w]={zoom:w,type:e.type,property:e.property,default:e.default,stops:[]},m.push(w)),f[w].stops.push([x[0].value,x[1]])}const g=[];for(const v of m)g.push([f[v].zoom,p_(f[v],t)]);const y={name:"linear"};return{kind:"composite",interpolationType:y,interpolationFactor:Ho.interpolationFactor.bind(void 0,y),zoomStops:g.map(v=>v[0]),evaluate:({zoom:v},x)=>Xp({stops:g,base:e.base},t,v).evaluate(v,x)}}if(o){const f="exponential"===s?{name:"exponential",base:void 0!==e.base?e.base:1}:null;return{kind:"camera",interpolationType:f,interpolationFactor:Ho.interpolationFactor.bind(void 0,f),zoomStops:e.stops.map(m=>m[0]),evaluate:({zoom:m})=>c(e,t,m,u,d)}}return{kind:"source",evaluate(f,m){const g=m&&m.properties?m.properties[e.property]:void 0;return void 0===g?Eh(e.default,t.default):c(e,t,g,u,d)}}}function Eh(e,t,n){return void 0!==e?e:void 0!==t?t:void 0!==n?n:void 0}function hx(e,t,n,r,o){return Eh(typeof n===o?r[n]:void 0,e.default,t.default)}function dx(e,t,n){if("number"!==Pn(n))return Eh(e.default,t.default);const r=e.stops.length;if(1===r||n<=e.stops[0][0])return e.stops[0][1];if(n>=e.stops[r-1][0])return e.stops[r-1][1];const o=Rs(e.stops.map(s=>s[0]),n);return e.stops[o][1]}function Xp(e,t,n){const r=void 0!==e.base?e.base:1;if("number"!==Pn(n))return Eh(e.default,t.default);const o=e.stops.length;if(1===o||n<=e.stops[0][0])return e.stops[0][1];if(n>=e.stops[o-1][0])return e.stops[o-1][1];const s=Rs(e.stops.map(m=>m[0]),n),c=function(m,g,y,v){const x=v-y,w=m-y;return 0===x?0:1===g?w/x:(Math.pow(g,w)-1)/(Math.pow(g,x)-1)}(n,r,e.stops[s][0],e.stops[s+1][0]),u=e.stops[s][1],d=e.stops[s+1][1];let f=un[t.type]||ks;if(e.colorSpace&&"rgb"!==e.colorSpace){const m=h_[e.colorSpace];f=(g,y)=>m.reverse(m.interpolate(m.forward(g),m.forward(y),c))}return"function"==typeof u.evaluate?{evaluate(...m){const g=u.evaluate.apply(void 0,m),y=d.evaluate.apply(void 0,m);if(void 0!==g&&void 0!==y)return f(g,y,c)}}:f(u,d,c)}function fx(e,t,n){return"color"===t.type?n=ke.parse(n):"formatted"===t.type?n=Wi.fromString(n.toString()):"resolvedImage"===t.type?n=Qn.fromString(n.toString()):Pn(n)===t.type||"enum"===t.type&&t.values[n]||(n=void 0),Eh(n,e.default,t.default)}class of{constructor(t,n,r){var o;this.expression=t,this._warningHistory={},this._evaluator=new no(r),this._defaultValue=n?"color"===(o=n).type&&(Yc(o.default)||Array.isArray(o.default))?new ke(0,0,0,0):"color"===o.type?ke.parse(o.default)||null:void 0===o.default?null:o.default:null,this._enumValues=n&&"enum"===n.type?n.values:null}evaluateWithoutErrorHandling(t,n,r,o,s,c,u,d){return this._evaluator.globals=t,this._evaluator.feature=n,this._evaluator.featureState=r,this._evaluator.canonical=o||null,this._evaluator.availableImages=s||null,this._evaluator.formattedSection=c,this._evaluator.featureTileCoord=u||null,this._evaluator.featureDistanceData=d||null,this.expression.evaluate(this._evaluator)}evaluate(t,n,r,o,s,c,u,d){this._evaluator.globals=t,this._evaluator.feature=n||null,this._evaluator.featureState=r||null,this._evaluator.canonical=o||null,this._evaluator.availableImages=s||null,this._evaluator.formattedSection=c||null,this._evaluator.featureTileCoord=u||null,this._evaluator.featureDistanceData=d||null;try{const f=this.expression.evaluate(this._evaluator);if(null==f||"number"==typeof f&&f!=f)return this._defaultValue;if(this._enumValues&&!(f in this._enumValues))throw new kr(`Expected value to be one of ${Object.keys(this._enumValues).map(m=>JSON.stringify(m)).join(", ")}, but found ${JSON.stringify(f)} instead.`);return f}catch(f){return this._warningHistory[f.message]||(this._warningHistory[f.message]=!0,typeof console<"u"&&console.warn(f.message)),this._defaultValue}}}function Th(e){return Array.isArray(e)&&e.length>0&&"string"==typeof e[0]&&e[0]in Wp}function yl(e,t,n){const r=new ph(Wp,[],t?function(s){const c={color:yo,string:an,number:Kt,enum:an,boolean:gn,formatted:He,resolvedImage:oh};return"array"===s.type?eo(c[s.value]||cn,s.length):c[s.type]}(t):void 0,void 0,void 0,n),o=r.parse(e,void 0,void 0,void 0,t&&"string"===t.type?{typeAnnotation:"coerce"}:void 0);return o?HT(new of(o,t,n)):wh(r.errors)}class Yp{constructor(t,n,r){this.kind=t,this._styleExpression=n,this.isLightConstant=r,this.isStateDependent="constant"!==t&&!Nr(n.expression),this.isConfigDependent=!On(n.expression)}evaluateWithoutErrorHandling(t,n,r,o,s,c){return this._styleExpression.evaluateWithoutErrorHandling(t,n,r,o,s,c)}evaluate(t,n,r,o,s,c){return this._styleExpression.evaluate(t,n,r,o,s,c)}}class vl{constructor(t,n,r,o,s){this.kind=t,this.zoomStops=r,this._styleExpression=n,this.isStateDependent="camera"!==t&&!Nr(n.expression),this.isLightConstant=s,this.isConfigDependent=!On(n.expression),this.interpolationType=o}evaluateWithoutErrorHandling(t,n,r,o,s,c){return this._styleExpression.evaluateWithoutErrorHandling(t,n,r,o,s,c)}evaluate(t,n,r,o,s,c){return this._styleExpression.evaluate(t,n,r,o,s,c)}interpolationFactor(t,n,r){return this.interpolationType?Ho.interpolationFactor(this.interpolationType,t,n,r):0}}function Mh(e,t,n){if("error"===(e=yl(e,t,n)).result)return e;const r=e.value.expression,o=Yr(r);if(!o&&!Zo(t))return wh([new qn("","data expressions not supported")]);const s=Cr(r,["zoom","pitch","distance-from-center"]);if(!s&&!ux(t))return wh([new qn("","zoom expressions not supported")]);const c=Cr(r,["measure-light"]);if(!c&&!qT(t))return wh([new qn("","measure-light expression not supported")]);const u=t.expression&&t.expression.relaxZoomRestriction,d=xl(r);return d||s||u?d instanceof qn?wh([d]):d instanceof Ho&&!Ai(t)?wh([new qn("",'"interpolate" expressions cannot be used with this property')]):HT(d?new vl(o?"camera":"composite",e.value,d.labels,d instanceof Ho?d.interpolation:void 0,c):new Yp(o?"constant":"source",e.value,c)):wh([new qn("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression, or in the properties of atmosphere.')])}class hc{constructor(t,n){this._parameters=t,this._specification=n,lr(this,p_(this._parameters,this._specification))}static deserialize(t){return new hc(t._parameters,t._specification)}static serialize(t){return{_parameters:t._parameters,_specification:t._specification}}}function xl(e){let t=null;if(e instanceof $p)t=xl(e.result);else if(e instanceof zn){for(const n of e.args)if(t=xl(n),t)break}else(e instanceof u_||e instanceof Ho)&&e.input instanceof Si&&"zoom"===e.input.name&&(t=e);return t instanceof qn||e.eachChild(n=>{const r=xl(n);r instanceof qn?t=r:t&&r&&t!==r&&(t=new qn("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))}),t}function ps(e){const t=e.key,n=e.value,r=e.valueSpec||{},o=e.objectElementValidators||{},s=e.style,c=e.styleSpec;let u=[];const d=Pn(n);if("object"!==d)return[new wt(t,n,`object expected, ${d} found`)];for(const f in n){const m=f.split(".")[0];let g;o[m]?g=o[m]:r[m]?g=xi:o["*"]?g=o["*"]:r["*"]&&(g=xi),g?u=u.concat(g({key:(t&&`${t}.`)+f,value:n[f],valueSpec:r[m]||r["*"],style:s,styleSpec:c,object:n,objectKey:f},n)):u.push(new Vn(t,n[f],`unknown property "${f}"`))}for(const f in r)o[f]||r[f].required&&void 0===r[f].default&&void 0===n[f]&&u.push(new wt(t,n,`missing required property "${f}"`));return u}function ZT(e){const t=e.value,n=e.valueSpec,r=e.style,o=e.styleSpec,s=e.key,c=e.arrayElementValidator||xi;if("array"!==Pn(t))return[new wt(s,t,`array expected, ${Pn(t)} found`)];if(n.length&&t.length!==n.length)return[new wt(s,t,`array length ${n.length} expected, length ${t.length} found`)];if(n["min-length"]&&t.length<n["min-length"])return[new wt(s,t,`array length at least ${n["min-length"]} expected, length ${t.length} found`)];let u={type:n.value,values:n.values,minimum:n.minimum,maximum:n.maximum,function:void 0};o.$version<7&&(u.function=n.function),"object"===Pn(n.value)&&(u=n.value);let d=[];for(let f=0;f<t.length;f++)d=d.concat(c({array:t,arrayIndex:f,value:t[f],valueSpec:u,style:r,styleSpec:o,key:`${s}[${f}]`},!0));return d}function WT(e){const t=e.key,n=e.value,r=e.valueSpec;let o=Pn(n);if("number"===o&&n!=n&&(o="NaN"),"number"!==o)return[new wt(t,n,`number expected, ${o} found`)];if("minimum"in r){let s=r.minimum;if("array"===Pn(r.minimum)&&(s=r.minimum[e.arrayIndex]),n<s)return[new wt(t,n,`${n} is less than the minimum value ${s}`)]}if("maximum"in r){let s=r.maximum;if("array"===Pn(r.maximum)&&(s=r.maximum[e.arrayIndex]),n>s)return[new wt(t,n,`${n} is greater than the maximum value ${s}`)]}return[]}function XT(e){const t=e.valueSpec,n=je(e.value.type);let r,o,s,c={};const u="categorical"!==n&&void 0===e.value.property,d=!u,f="array"===Pn(e.value.stops)&&"array"===Pn(e.value.stops[0])&&"object"===Pn(e.value.stops[0][0]),m=ps({key:e.key,value:e.value,valueSpec:e.styleSpec.function,style:e.style,styleSpec:e.styleSpec,objectElementValidators:{stops:function(v){if("identity"===n)return[new wt(v.key,v.value,'identity function may not have a "stops" property')];let x=[];const w=v.value;return x=x.concat(ZT({key:v.key,value:w,valueSpec:v.valueSpec,style:v.style,styleSpec:v.styleSpec,arrayElementValidator:g})),"array"===Pn(w)&&0===w.length&&x.push(new wt(v.key,w,"array must have at least one stop")),x},default:function(v){return xi({key:v.key,value:v.value,valueSpec:t,style:v.style,styleSpec:v.styleSpec})}}});return"identity"===n&&u&&m.push(new wt(e.key,e.value,'missing required property "property"')),"identity"===n||e.value.stops||m.push(new wt(e.key,e.value,'missing required property "stops"')),"exponential"===n&&e.valueSpec.expression&&!Ai(e.valueSpec)&&m.push(new wt(e.key,e.value,"exponential functions not supported")),e.styleSpec.$version>=8&&(d&&!Zo(e.valueSpec)?m.push(new wt(e.key,e.value,"property functions not supported")):u&&!ux(e.valueSpec)&&m.push(new wt(e.key,e.value,"zoom functions not supported"))),"categorical"!==n&&!f||void 0!==e.value.property||m.push(new wt(e.key,e.value,'"property" property is required')),m;function g(v){let x=[];const w=v.value,E=v.key;if("array"!==Pn(w))return[new wt(E,w,`array expected, ${Pn(w)} found`)];if(2!==w.length)return[new wt(E,w,`array length 2 expected, length ${w.length} found`)];if(f){if("object"!==Pn(w[0]))return[new wt(E,w,`object expected, ${Pn(w[0])} found`)];if(void 0===w[0].zoom)return[new wt(E,w,"object stop key must have zoom")];if(void 0===w[0].value)return[new wt(E,w,"object stop key must have value")];const M=je(w[0].zoom);if("number"!=typeof M)return[new wt(E,w[0].zoom,"stop zoom values must be numbers")];if(s&&s>M)return[new wt(E,w[0].zoom,"stop zoom values must appear in ascending order")];M!==s&&(s=M,o=void 0,c={}),x=x.concat(ps({key:`${E}[0]`,value:w[0],valueSpec:{zoom:{}},style:v.style,styleSpec:v.styleSpec,objectElementValidators:{zoom:WT,value:y}}))}else x=x.concat(y({key:`${E}[0]`,value:w[0],valueSpec:{},style:v.style,styleSpec:v.styleSpec},w));return Th(Cs(w[1]))?x.concat([new wt(`${E}[1]`,w[1],"expressions are not allowed in function stops.")]):x.concat(xi({key:`${E}[1]`,value:w[1],valueSpec:t,style:v.style,styleSpec:v.styleSpec}))}function y(v,x){const w=Pn(v.value),E=je(v.value),M=null!==v.value?v.value:x;if(r){if(w!==r)return[new wt(v.key,M,`${w} stop domain type must match previous stop domain type ${r}`)]}else r=w;if("number"!==w&&"string"!==w&&"boolean"!==w&&"number"!=typeof E&&"string"!=typeof E&&"boolean"!=typeof E)return[new wt(v.key,M,"stop domain value must be a number, string, or boolean")];if("number"!==w&&"categorical"!==n){let D=`number expected, ${w} found`;return Zo(t)&&void 0===n&&(D+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new wt(v.key,M,D)]}return"categorical"!==n||"number"!==w||"number"==typeof E&&isFinite(E)&&Math.floor(E)===E?"categorical"!==n&&"number"===w&&"number"==typeof E&&"number"==typeof o&&void 0!==o&&E<o?[new wt(v.key,M,"stop domain values must appear in ascending order")]:(o=E,"categorical"===n&&E in c?[new wt(v.key,M,"stop domain values must be unique")]:(c[E]=!0,[])):[new wt(v.key,M,`integer expected, found ${String(E)}`)]}}function Kc(e){const t=("property"===e.expressionContext?Mh:yl)(Cs(e.value),e.valueSpec);if("error"===t.result)return t.value.map(r=>new wt(`${e.key}${r.key}`,e.value,r.message));const n=t.value.expression||t.value._styleExpression.expression;if("property"===e.expressionContext&&"text-font"===e.propertyKey&&!n.outputDefined())return[new wt(e.key,e.value,`Invalid data expression for "${e.propertyKey}". Output values must be contained as literals within the expression.`)];if("property"===e.expressionContext&&"layout"===e.propertyType&&!Nr(n))return[new wt(e.key,e.value,'"feature-state" data expressions are not supported with layout properties.')];if("filter"===e.expressionContext)return px(n,e);if(e.expressionContext&&0===e.expressionContext.indexOf("cluster")){if(!Cr(n,["zoom","feature-state"]))return[new wt(e.key,e.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if("cluster-initial"===e.expressionContext&&!Yr(n))return[new wt(e.key,e.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function px(e,t){const n=new Set(["zoom","feature-state","pitch","distance-from-center"]);if(t.valueSpec&&t.valueSpec.expression)for(const o of t.valueSpec.expression.parameters)n.delete(o);if(0===n.size)return[];const r=[];return e instanceof Si&&n.has(e.name)?[new wt(t.key,t.value,`["${e.name}"] expression is not supported in a filter for a ${t.object.type} layer with id: ${t.object.id}`)]:(e.eachChild(o=>{r.push(...px(o,t))}),r)}function m_(e){const t=e.key,n=e.value,r=e.valueSpec,o=[];return Array.isArray(r.values)?-1===r.values.indexOf(je(n))&&o.push(new wt(t,n,`expected one of [${r.values.join(", ")}], ${JSON.stringify(n)} found`)):-1===Object.keys(r.values).indexOf(je(n))&&o.push(new wt(t,n,`expected one of [${Object.keys(r.values).join(", ")}], ${JSON.stringify(n)} found`)),o}function Kp(e){if(!0===e||!1===e)return!0;if(!Array.isArray(e)||0===e.length)return!1;switch(e[0]){case"has":return e.length>=2&&"$id"!==e[1]&&"$type"!==e[1];case"in":return e.length>=3&&("string"!=typeof e[1]||Array.isArray(e[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return 3!==e.length||Array.isArray(e[1])||Array.isArray(e[2]);case"any":case"all":for(const t of e.slice(1))if(!Kp(t)&&"boolean"!=typeof t)return!1;return!0;default:return!0}}function Ih(e,t="fill"){if(null==e)return{filter:()=>!0,needGeometry:!1,needFeature:!1};Kp(e)||(e=af(e));const n=e;let r=!0;try{r=function(f){if(!sf(f))return f;let m=Cs(f);return Jp(m),m=mx(m),m}(n)}catch{console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.\nThis is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md\nand paste the contents of this message in the report.\nThank you!\nFilter Expression:\n${JSON.stringify(n,null,2)}\n        `)}const o=H[`filter_${t}`],s=yl(r,o);let c=null;if("error"===s.result)throw new Error(s.value.map(f=>`${f.key}: ${f.message}`).join(", "));c=(f,m,g)=>s.value.evaluate(f,m,{},g);let u=null,d=null;if(r!==n){const f=yl(n,o);if("error"===f.result)throw new Error(f.value.map(m=>`${m.key}: ${m.message}`).join(", "));u=(m,g,y,v,x)=>f.value.evaluate(m,g,{},y,void 0,void 0,v,x),d=!Yr(f.value.expression)}return{filter:c,dynamicFilter:u||void 0,needGeometry:g_(r),needFeature:!!d}}function mx(e){if(!Array.isArray(e))return e;const t=function(n){if(yC.has(n[0]))for(let r=1;r<n.length;r++)if(sf(n[r]))return!0;return n}(e);return!0===t?t:t.map(n=>mx(n))}function Jp(e){let t=!1;const n=[];if("case"===e[0]){for(let r=1;r<e.length-1;r+=2)t=t||sf(e[r]),n.push(e[r+1]);n.push(e[e.length-1])}else if("match"===e[0]){t=t||sf(e[1]);for(let r=2;r<e.length-1;r+=2)n.push(e[r+1]);n.push(e[e.length-1])}else if("step"===e[0]){t=t||sf(e[1]);for(let r=1;r<e.length-1;r+=2)n.push(e[r+1])}t&&(e.length=0,e.push("any",...n));for(let r=1;r<e.length;r++)Jp(e[r])}function sf(e){if(!Array.isArray(e))return!1;if("pitch"===(t=e[0])||"distance-from-center"===t)return!0;var t;for(let n=1;n<e.length;n++)if(sf(e[n]))return!0;return!1}const yC=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function YT(e,t){return e<t?-1:e>t?1:0}function g_(e){if(!Array.isArray(e))return!1;if("within"===e[0]||"distance"===e[0])return!0;for(let t=1;t<e.length;t++)if(g_(e[t]))return!0;return!1}function af(e){if(!e)return!0;const t=e[0];return e.length<=1?"any"!==t:"=="===t?__(e[1],e[2],"=="):"!="===t?lf(__(e[1],e[2],"==")):"<"===t||">"===t||"<="===t||">="===t?__(e[1],e[2],t):"any"===t?(n=e.slice(1),["any"].concat(n.map(af))):"all"===t?["all"].concat(e.slice(1).map(af)):"none"===t?["all"].concat(e.slice(1).map(af).map(lf)):"in"===t?gx(e[1],e.slice(2)):"!in"===t?lf(gx(e[1],e.slice(2))):"has"===t?_x(e[1]):"!has"!==t||lf(_x(e[1]));var n}function __(e,t,n){switch(e){case"$type":return[`filter-type-${n}`,t];case"$id":return[`filter-id-${n}`,t];default:return[`filter-${n}`,e,t]}}function gx(e,t){if(0===t.length)return!1;switch(e){case"$type":return["filter-type-in",["literal",t]];case"$id":return["filter-id-in",["literal",t]];default:return t.length>200&&!t.some(n=>typeof n!=typeof t[0])?["filter-in-large",e,["literal",t.sort(YT)]]:["filter-in-small",e,["literal",t]]}}function _x(e){switch(e){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",e]}}function lf(e){return["!",e]}function y_(e){return Kp(Cs(e.value))?Kc(lr({},e,{expressionContext:"filter",valueSpec:e.styleSpec[`filter_${e.layerType||"fill"}`]})):v_(e)}function v_(e){const t=e.value,n=e.key;if("array"!==Pn(t))return[new wt(n,t,`array expected, ${Pn(t)} found`)];const r=e.styleSpec;let o,s=[];if(t.length<1)return[new wt(n,t,"filter array must have at least 1 element")];switch(s=s.concat(m_({key:`${n}[0]`,value:t[0],valueSpec:r.filter_operator,style:e.style,styleSpec:e.styleSpec})),je(t[0])){case"<":case"<=":case">":case">=":t.length>=2&&"$type"===je(t[1])&&s.push(new wt(n,t,`"$type" cannot be use with operator "${t[0]}"`));case"==":case"!=":3!==t.length&&s.push(new wt(n,t,`filter array for operator "${t[0]}" must have 3 elements`));case"in":case"!in":t.length>=2&&(o=Pn(t[1]),"string"!==o&&s.push(new wt(`${n}[1]`,t[1],`string expected, ${o} found`)));for(let c=2;c<t.length;c++)o=Pn(t[c]),"$type"===je(t[1])?s=s.concat(m_({key:`${n}[${c}]`,value:t[c],valueSpec:r.geometry_type,style:e.style,styleSpec:e.styleSpec})):"string"!==o&&"number"!==o&&"boolean"!==o&&s.push(new wt(`${n}[${c}]`,t[c],`string, number, or boolean expected, ${o} found`));break;case"any":case"all":case"none":for(let c=1;c<t.length;c++)s=s.concat(v_({key:`${n}[${c}]`,value:t[c],style:e.style,styleSpec:e.styleSpec}));break;case"has":case"!has":o=Pn(t[1]),2!==t.length?s.push(new wt(n,t,`filter array for "${t[0]}" operator must have 2 elements`)):"string"!==o&&s.push(new wt(`${n}[1]`,t[1],`string expected, ${o} found`))}return s}function yx(e,t){const n=e.key,r=e.style,o=e.layer,s=e.styleSpec,c=e.value,u=e.objectKey,d=s[`${t}_${e.layerType}`];if(!d)return[];const f=u.match(/^(.*)-transition$/);if("paint"===t&&f&&d[f[1]]&&d[f[1]].transition)return xi({key:n,value:c,valueSpec:s.transition,style:r,styleSpec:s});const m=e.valueSpec||d[u];if(!m)return[new Vn(n,c,`unknown property "${u}"`)];let g;if("string"===Pn(c)&&Zo(m)&&!m.tokens&&(g=/^{([^}]+)}$/.exec(c))){const v=`\`{ "type": "identity", "property": ${g?JSON.stringify(g[1]):'"_"'} }\``;return[new wt(n,c,`"${u}" does not support interpolation syntax\nUse an identity property function instead: ${v}.`)]}const y=[];if("symbol"===e.layerType)"text-field"!==u||!r||r.glyphs||r.imports||y.push(new wt(n,c,'use of "text-field" requires a style "glyphs" property')),"text-font"===u&&Yc(Cs(c))&&"identity"===je(c.type)&&y.push(new wt(n,c,'"text-font" does not support identity functions'));else if("model"===e.layerType&&"paint"===t&&o&&o.layout&&o.layout.hasOwnProperty("model-id")&&Zo(m)&&(qT(m)||ux(m))){const v=Mh(Cs(c),m),x=v.value.expression||v.value._styleExpression.expression;x&&!Cr(x,["measure-light"])&&("model-emissive-strength"===u&&Yr(x)&&Nr(x)||y.push(new wt(n,c,`${u} does not support measure-light expressions when the model layer source is vector tile or GeoJSON.`)))}return y.concat(xi({key:e.key,value:c,valueSpec:m,style:r,styleSpec:s,expressionContext:"property",propertyType:t,propertyKey:u}))}function KT(e){return yx(e,"paint")}function vx(e){return yx(e,"layout")}function cf(e){let t=[];const n=e.value,r=e.key,o=e.style,s=e.styleSpec;n.type||n.ref||t.push(new wt(r,n,'either "type" or "ref" is required'));let c=je(n.type);const u=je(n.ref);if(n.id){const d=je(n.id);for(let f=0;f<e.arrayIndex;f++){const m=o.layers[f];je(m.id)===d&&t.push(new wt(r,n.id,`duplicate layer id "${n.id}", previously used at line ${m.id.__line__}`))}}if("ref"in n){let d;["type","source","source-layer","filter","layout"].forEach(f=>{f in n&&t.push(new wt(r,n[f],`"${f}" is prohibited for ref layers`))}),o.layers.forEach(f=>{je(f.id)===u&&(d=f)}),d?d.ref?t.push(new wt(r,n.ref,"ref cannot reference another ref layer")):c=je(d.type):"string"==typeof u&&t.push(new wt(r,n.ref,`ref layer "${u}" not found`))}else if("background"!==c&&"sky"!==c&&"slot"!==c)if(n.source){const d=o.sources&&o.sources[n.source],f=d&&je(d.type);d?"vector"===f&&"raster"===c?t.push(new wt(r,n.source,`layer "${n.id}" requires a raster source`)):"raster"===f&&"raster"!==c?t.push(new wt(r,n.source,`layer "${n.id}" requires a vector source`)):"vector"!==f||n["source-layer"]?"raster-dem"===f&&"hillshade"!==c?t.push(new wt(r,n.source,"raster-dem source can only be used with layer type 'hillshade'.")):"line"!==c||!n.paint||!n.paint["line-gradient"]&&!n.paint["line-trim-offset"]||"geojson"===f&&d.lineMetrics||t.push(new wt(r,n,`layer "${n.id}" specifies a line-gradient, which requires a GeoJSON source with \`lineMetrics\` enabled.`)):t.push(new wt(r,n,`layer "${n.id}" must specify a "source-layer"`)):t.push(new wt(r,n.source,`source "${n.source}" not found`))}else t.push(new wt(r,n,'missing required property "source"'));return t=t.concat(ps({key:r,value:n,valueSpec:s.layer,style:e.style,styleSpec:e.styleSpec,objectElementValidators:{"*":()=>[],type:()=>xi({key:`${r}.type`,value:n.type,valueSpec:s.layer.type,style:e.style,styleSpec:e.styleSpec,object:n,objectKey:"type"}),filter:d=>y_(lr({layerType:c},d)),layout:d=>ps({layer:n,key:d.key,value:d.value,valueSpec:{},style:d.style,styleSpec:d.styleSpec,objectElementValidators:{"*":f=>vx(lr({layerType:c},f))}}),paint:d=>ps({layer:n,key:d.key,value:d.value,valueSpec:{},style:d.style,styleSpec:d.styleSpec,objectElementValidators:{"*":f=>KT(lr({layerType:c,layer:n},f))}})}})),t}function Jc(e){const t=e.value,n=e.key,r=Pn(t);return"string"!==r?[new wt(n,t,`string expected, ${r} found`)]:[]}const xx={promoteId:function({key:e,value:t}){if("string"===Pn(t))return Jc({key:e,value:t});{const n=[];for(const r in t)n.push(...Jc({key:`${e}.${r}`,value:t[r]}));return n}}};function bx(e){const t=e.value,n=e.key,r=e.styleSpec,o=e.style;if(!t.type)return[new wt(n,t,'"type" is required')];const s=je(t.type);let c=[];switch(["vector","raster","raster-dem"].includes(s)&&(t.url||t.tiles||c.push(new wt(n,t,'Either "url" or "tiles" is required.'))),s){case"vector":case"raster":case"raster-dem":return c=c.concat(ps({key:n,value:t,valueSpec:r[`source_${s.replace("-","_")}`],style:e.style,styleSpec:r,objectElementValidators:xx})),c;case"geojson":if(c=ps({key:n,value:t,valueSpec:r.source_geojson,style:o,styleSpec:r,objectElementValidators:xx}),t.cluster)for(const u in t.clusterProperties){const[d,f]=t.clusterProperties[u],m="string"==typeof d?[d,["accumulated"],["get",u]]:d;c.push(...Kc({key:`${n}.${u}.map`,value:f,expressionContext:"cluster-map"})),c.push(...Kc({key:`${n}.${u}.reduce`,value:m,expressionContext:"cluster-reduce"}))}return c;case"video":return ps({key:n,value:t,valueSpec:r.source_video,style:o,styleSpec:r});case"image":return ps({key:n,value:t,valueSpec:r.source_image,style:o,styleSpec:r});case"canvas":return[new wt(n,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return m_({key:`${n}.type`,value:t.type,valueSpec:{values:wx(r)},style:o,styleSpec:r})}}function wx(e){return e.source.reduce((t,n)=>{const r=e[n];return"enum"===r.type.type&&(t=t.concat(Object.keys(r.type.values))),t},[])}function x_(e){const t=e.value;let n=[];if(!t)return n;const r=Pn(t);return"string"!==r?(n=n.concat([new wt(e.key,t,`string expected, "${r}" found`)]),n):(function(o){const s=-1===o.indexOf("://");try{return new URL(o,s?"http://example.com":void 0),!0}catch{return!1}}(t)||(n=n.concat([new wt(e.key,t,`invalid url "${t}"`)])),n)}function Ex(e){const t=e.value,n=e.styleSpec,r=n.light,o=e.style;let s=[];const c=Pn(t);if(void 0===t)return s;if("object"!==c)return s=s.concat([new wt("light",t,`object expected, ${c} found`)]),s;for(const u in t){const d=u.match(/^(.*)-transition$/);s=s.concat(d&&r[d[1]]&&r[d[1]].transition?xi({key:u,value:t[u],valueSpec:n.transition,style:o,styleSpec:n}):r[u]?xi({key:u,value:t[u],valueSpec:r[u],style:o,styleSpec:n}):[new wt(u,t[u],`unknown property "${u}"`)])}return s}function Qp(e){const t=e.value;let n=[];if(!t)return n;const r=Pn(t);if("object"!==r)return n=n.concat([new wt("light-3d",t,`object expected, ${r} found`)]),n;const o=e.styleSpec,s=o["light-3d"],c=e.key,u=e.style,d=e.style.lights;for(const g of["type","id"])if(!(g in t))return n=n.concat([new wt("light-3d",t,`missing property ${g} on light`)]),n;if(t.type&&d)for(let g=0;g<e.arrayIndex;g++){const y=je(t.type),v=d[g];je(v.type)===y&&n.push(new wt(c,t.id,`duplicate light type "${t.type}", previously defined at line ${v.id.__line__}`))}const f=`properties_light_${t.type}`;if(!(f in o))return n=n.concat([new wt("light-3d",t,`Invalid light type ${t.type}`)]),n;const m=o[f];for(const g in t)if("properties"===g){const y=t[g],v=Pn(y);if("object"!==v)return n=n.concat([new wt("properties",y,`object expected, ${v} found`)]),n;for(const x in y)n=n.concat(m[x]?xi({key:x,value:y[x],valueSpec:m[x],style:u,styleSpec:o}):[new Vn(e.key,y[x],`unknown property "${x}"`)])}else{const y=g.match(/^(.*)-transition$/);n=n.concat(y&&s[y[1]]&&s[y[1]].transition?xi({key:g,value:t[g],valueSpec:o.transition,style:u,styleSpec:o}):s[g]?xi({key:g,value:t[g],valueSpec:s[g],style:u,styleSpec:o}):[new Vn(g,t[g],`unknown property "${g}"`)])}return n}function Tx(e){const t=e.value,n=e.key,r=e.style,o=e.styleSpec,s=o.terrain;let c=[];const u=Pn(t);if(void 0===t||"null"===u)return c;if("object"!==u)return c=c.concat([new wt("terrain",t,`object expected, ${u} found`)]),c;for(const d in t){const f=d.match(/^(.*)-transition$/);c=c.concat(f&&s[f[1]]&&s[f[1]].transition?xi({key:d,value:t[d],valueSpec:o.transition,style:r,styleSpec:o}):s[d]?xi({key:d,value:t[d],valueSpec:s[d],style:r,styleSpec:o}):[new Vn(d,t[d],`unknown property "${d}"`)])}if(t.source){const d=r.sources&&r.sources[t.source],f=d&&je(d.type);d?"raster-dem"!==f&&c.push(new wt(n,t.source,`terrain cannot be used with a source of type ${String(f)}, it only be used with a "raster-dem" source type`)):c.push(new wt(n,t.source,`source "${t.source}" not found`))}else c.push(new wt(n,t,'terrain is missing required property "source"'));return c}function Qs(e){const t=e.value,n=e.style,r=e.styleSpec,o=r.fog;let s=[];const c=Pn(t);if(void 0===t)return s;if("object"!==c)return s=s.concat([new wt("fog",t,`object expected, ${c} found`)]),s;for(const u in t){const d=u.match(/^(.*)-transition$/);s=s.concat(d&&o[d[1]]&&o[d[1]].transition?xi({key:u,value:t[u],valueSpec:r.transition,style:n,styleSpec:r}):o[u]?xi({key:u,value:t[u],valueSpec:o[u],style:n,styleSpec:r}):[new Vn(u,t[u],`unknown property "${u}"`)])}return s}const b_={"*":()=>[],array:ZT,boolean:function(e){const t=e.value,n=e.key,r=Pn(t);return"boolean"!==r?[new wt(n,t,`boolean expected, ${r} found`)]:[]},number:WT,color:function(e){const t=e.key,n=e.value,r=Pn(n);return"string"!==r?[new wt(t,n,`color expected, ${r} found`)]:null===ah(n)?[new wt(t,n,`color expected, "${n}" found`)]:[]},enum:m_,filter:y_,function:XT,layer:cf,object:ps,source:bx,model:x_,light:Ex,"light-3d":Qp,terrain:Tx,fog:Qs,string:Jc,formatted:function(e){return 0===Jc(e).length?[]:Kc(e)},resolvedImage:function(e){return 0===Jc(e).length?[]:Kc(e)},projection:function(e){const t=e.value,n=e.styleSpec,r=n.projection,o=e.style;let s=[];const c=Pn(t);if("object"===c)for(const u in t)s=s.concat(xi({key:u,value:t[u],valueSpec:r[u],style:o,styleSpec:n}));else"string"!==c&&(s=s.concat([new wt("projection",t,`object or string expected, ${c} found`)]));return s},import:function(e){const{value:t,styleSpec:n}=e,{data:r,...o}=t;Object.defineProperty(o,"__line__",{value:t.__line__,enumerable:!1});let s=ps(lr({},e,{value:o,valueSpec:n.import}));return""===je(o.id)&&s.push(new wt(`${e.key}.id`,o,"import id can't be an empty string")),r&&(s=s.concat(tm(r,n,{key:`${e.key}.data`}))),s}};function xi(e,t=!1){const n=e.value,r=e.valueSpec,o=e.styleSpec;if(r.expression&&Yc(je(n)))return XT(e);if(r.expression&&Th(Cs(n)))return Kc(e);if(r.type&&b_[r.type]){const s=b_[r.type](e);return!0===t&&s.length>0&&"array"===Pn(e.value)?Kc(e):s}return ps(lr({},e,{valueSpec:r.type?o[r.type]:r}))}function zr(e){const t=e.value,n=e.key,r=Jc(e);return r.length||(-1===t.indexOf("{fontstack}")&&r.push(new wt(n,t,'"glyphs" url must include a "{fontstack}" token')),-1===t.indexOf("{range}")&&r.push(new wt(n,t,'"glyphs" url must include a "{range}" token'))),r}function tm(e,t=H,n={}){return xi({key:n.key||"",value:e,valueSpec:t.$root,styleSpec:t,style:e,objectElementValidators:{glyphs:zr,"*":()=>[]}})}function bl(e,t=H){return ta(tm(e,t))}const Wo=e=>ta(bx(e)),JT=e=>ta(Ex(e)),Mx=e=>ta(Qp(e)),Dh=e=>ta(Tx(e)),ms=e=>ta(Qs(e)),QT=e=>ta(cf(e)),w_=e=>ta(y_(e)),tM=e=>ta(KT(e)),dc=e=>ta(vx(e)),Ix=e=>ta(x_(e));function ta(e){return e.slice().sort((t,n)=>t.line&&n.line?t.line-n.line:0)}function uf(e,t){let n=!1;if(t&&t.length)for(const r of t)r instanceof Vn?nt(r.message):(e.fire(new Tt(new Error(r.message))),n=!0);return n}var Dx=Oa,wl=3;function Oa(e,t,n){var r=this.cells=[];if(e instanceof ArrayBuffer){this.arrayBuffer=e;var o=new Int32Array(this.arrayBuffer);e=o[0],this.d=(t=o[1])+2*(n=o[2]);for(var s=0;s<this.d*this.d;s++){var c=o[wl+s],u=o[wl+s+1];r.push(c===u?null:o.subarray(c,u))}var d=o[wl+r.length+1];this.keys=o.subarray(o[wl+r.length],d),this.bboxes=o.subarray(d),this.insert=this._insertReadonly}else{this.d=t+2*n;for(var f=0;f<this.d*this.d;f++)r.push([]);this.keys=[],this.bboxes=[]}this.n=t,this.extent=e,this.padding=n,this.scale=t/e,this.uid=0;var m=n/t*e;this.min=-m,this.max=e+m}Oa.prototype.insert=function(e,t,n,r,o){this._forEachCell(t,n,r,o,this._insertCell,this.uid++),this.keys.push(e),this.bboxes.push(t),this.bboxes.push(n),this.bboxes.push(r),this.bboxes.push(o)},Oa.prototype._insertReadonly=function(){throw"Cannot insert into a GridIndex created from an ArrayBuffer."},Oa.prototype._insertCell=function(e,t,n,r,o,s){this.cells[o].push(s)},Oa.prototype.query=function(e,t,n,r,o){var s=this.min,c=this.max;if(e<=s&&t<=s&&c<=n&&c<=r&&!o)return Array.prototype.slice.call(this.keys);var u=[];return this._forEachCell(e,t,n,r,this._queryCell,u,{},o),u},Oa.prototype._queryCell=function(e,t,n,r,o,s,c,u){var d=this.cells[o];if(null!==d)for(var f=this.keys,m=this.bboxes,g=0;g<d.length;g++){var y=d[g];if(void 0===c[y]){var v=4*y;(u?u(m[v+0],m[v+1],m[v+2],m[v+3]):e<=m[v+2]&&t<=m[v+3]&&n>=m[v+0]&&r>=m[v+1])?(c[y]=!0,s.push(f[y])):c[y]=!1}}},Oa.prototype._forEachCell=function(e,t,n,r,o,s,c,u){for(var d=this._convertToCellCoord(e),f=this._convertToCellCoord(t),m=this._convertToCellCoord(n),g=this._convertToCellCoord(r),y=d;y<=m;y++)for(var v=f;v<=g;v++){var x=this.d*v+y;if((!u||u(this._convertFromCellCoord(y),this._convertFromCellCoord(v),this._convertFromCellCoord(y+1),this._convertFromCellCoord(v+1)))&&o.call(this,e,t,n,r,x,s,c,u))return}},Oa.prototype._convertFromCellCoord=function(e){return(e-this.padding)/this.scale},Oa.prototype._convertToCellCoord=function(e){return Math.max(0,Math.min(this.d-1,Math.floor(e*this.scale)+this.padding))},Oa.prototype.toArrayBuffer=function(){if(this.arrayBuffer)return this.arrayBuffer;for(var e=this.cells,t=wl+this.cells.length+1+1,n=0,r=0;r<this.cells.length;r++)n+=this.cells[r].length;var o=new Int32Array(t+n+this.keys.length+this.bboxes.length);o[0]=this.extent,o[1]=this.n,o[2]=this.padding;for(var s=t,c=0;c<e.length;c++){var u=e[c];o[wl+c]=s,o.set(u,s),s+=u.length}return o[wl+e.length]=s,o.set(this.keys,s),o[wl+e.length+1]=s+=this.keys.length,o.set(this.bboxes,s),s+=this.bboxes.length,o.buffer};var We=rr(Dx);const hf={};function re(e,t,n={}){Object.defineProperty(e,"_classRegistryKey",{value:t,writeable:!1}),hf[t]={klass:e,omit:n.omit||[]}}re(Object,"Object"),We.serialize=function(e,t){const n=e.toArrayBuffer();return t&&t.add(n),{buffer:n}},We.deserialize=function(e){return new We(e.buffer)},Object.defineProperty(We,"name",{value:"Grid"}),re(We,"Grid"),re(ke,"Color"),re(Error,"Error"),re(It,"AJAXError"),re(Qn,"ResolvedImage"),re(hc,"StylePropertyFunction"),re(of,"StyleExpression",{omit:["_evaluator"]}),re(vl,"ZoomDependentExpression"),re(Yp,"ZoomConstantExpression"),re(Si,"CompoundExpression",{omit:["_evaluate"]});for(const e in Wp)hf[Wp[e]._classRegistryKey]||re(Wp[e],`Expression${e}`);function Sx(e){return e&&typeof ArrayBuffer<"u"&&(e instanceof ArrayBuffer||e.constructor&&"ArrayBuffer"===e.constructor.name)}function Cx(e){return ft.ImageBitmap&&e instanceof ft.ImageBitmap}function Sh(e,t){if(null==e||"boolean"==typeof e||"number"==typeof e||"string"==typeof e||e instanceof Boolean||e instanceof Number||e instanceof String||e instanceof Date||e instanceof RegExp)return e;if(Sx(e)||Cx(e))return t&&t.add(e),e;if(ArrayBuffer.isView(e)){const n=e;return t&&t.add(n.buffer),n}if(e instanceof ft.ImageData)return t&&t.add(e.data.buffer),e;if(Array.isArray(e)){const n=[];for(const r of e)n.push(Sh(r,t));return n}if(e instanceof Map){const n={$name:"Map"};for(const[r,o]of e.entries())n[r]=Sh(o);return n}if("object"==typeof e){const n=e.constructor,r=n._classRegistryKey;if(!r)throw new Error(`can't serialize object of unregistered class ${r}`);const o=n.serialize?n.serialize(e,t):{};if(!n.serialize){for(const s in e)e.hasOwnProperty(s)&&(hf[r].omit.indexOf(s)>=0||(o[s]=Sh(e[s],t)));e instanceof Error&&(o.message=e.message)}if(o.$name)throw new Error("$name property is reserved for worker serialization logic.");return"Object"!==r&&(o.$name=r),o}throw new Error("can't serialize object of type "+typeof e)}function Qc(e){if(null==e||"boolean"==typeof e||"number"==typeof e||"string"==typeof e||e instanceof Boolean||e instanceof Number||e instanceof String||e instanceof Date||e instanceof RegExp||Sx(e)||Cx(e)||ArrayBuffer.isView(e)||e instanceof ft.ImageData)return e;if(Array.isArray(e))return e.map(Qc);if("object"==typeof e){const t=e.$name||"Object";if("Map"===t){const o=new Map;for(const s of Object.keys(e))"$name"!==s&&o.set(s,Qc(e[s]));return o}const{klass:n}=hf[t];if(!n)throw new Error(`can't deserialize unregistered class ${t}`);if(n.deserialize)return n.deserialize(e);const r=Object.create(n.prototype);for(const o of Object.keys(e))"$name"!==o&&(r[o]=Qc(e[o]));return r}throw new Error("can't deserialize object of type "+typeof e)}const ie={"Latin-1 Supplement":e=>e>=128&&e<=255,Arabic:e=>e>=1536&&e<=1791,"Arabic Supplement":e=>e>=1872&&e<=1919,"Arabic Extended-A":e=>e>=2208&&e<=2303,"Hangul Jamo":e=>e>=4352&&e<=4607,"Unified Canadian Aboriginal Syllabics":e=>e>=5120&&e<=5759,Khmer:e=>e>=6016&&e<=6143,"Unified Canadian Aboriginal Syllabics Extended":e=>e>=6320&&e<=6399,"General Punctuation":e=>e>=8192&&e<=8303,"Letterlike Symbols":e=>e>=8448&&e<=8527,"Number Forms":e=>e>=8528&&e<=8591,"Miscellaneous Technical":e=>e>=8960&&e<=9215,"Control Pictures":e=>e>=9216&&e<=9279,"Optical Character Recognition":e=>e>=9280&&e<=9311,"Enclosed Alphanumerics":e=>e>=9312&&e<=9471,"Geometric Shapes":e=>e>=9632&&e<=9727,"Miscellaneous Symbols":e=>e>=9728&&e<=9983,"Miscellaneous Symbols and Arrows":e=>e>=11008&&e<=11263,"CJK Radicals Supplement":e=>e>=11904&&e<=12031,"Kangxi Radicals":e=>e>=12032&&e<=12255,"Ideographic Description Characters":e=>e>=12272&&e<=12287,"CJK Symbols and Punctuation":e=>e>=12288&&e<=12351,Hiragana:e=>e>=12352&&e<=12447,Katakana:e=>e>=12448&&e<=12543,Bopomofo:e=>e>=12544&&e<=12591,"Hangul Compatibility Jamo":e=>e>=12592&&e<=12687,Kanbun:e=>e>=12688&&e<=12703,"Bopomofo Extended":e=>e>=12704&&e<=12735,"CJK Strokes":e=>e>=12736&&e<=12783,"Katakana Phonetic Extensions":e=>e>=12784&&e<=12799,"Enclosed CJK Letters and Months":e=>e>=12800&&e<=13055,"CJK Compatibility":e=>e>=13056&&e<=13311,"CJK Unified Ideographs Extension A":e=>e>=13312&&e<=19903,"Yijing Hexagram Symbols":e=>e>=19904&&e<=19967,"CJK Unified Ideographs":e=>e>=19968&&e<=40959,"Yi Syllables":e=>e>=40960&&e<=42127,"Yi Radicals":e=>e>=42128&&e<=42191,"Hangul Jamo Extended-A":e=>e>=43360&&e<=43391,"Hangul Syllables":e=>e>=44032&&e<=55215,"Hangul Jamo Extended-B":e=>e>=55216&&e<=55295,"Private Use Area":e=>e>=57344&&e<=63743,"CJK Compatibility Ideographs":e=>e>=63744&&e<=64255,"Arabic Presentation Forms-A":e=>e>=64336&&e<=65023,"Vertical Forms":e=>e>=65040&&e<=65055,"CJK Compatibility Forms":e=>e>=65072&&e<=65103,"Small Form Variants":e=>e>=65104&&e<=65135,"Arabic Presentation Forms-B":e=>e>=65136&&e<=65279,"Halfwidth and Fullwidth Forms":e=>e>=65280&&e<=65519,"CJK Unified Ideographs Extension B":e=>e>=131072&&e<=173791};function E_(e){for(const t of e)if(T_(t.charCodeAt(0)))return!0;return!1}function eM(e){for(const t of e)if(!nM(t.charCodeAt(0)))return!1;return!0}function nM(e){return!(ie.Arabic(e)||ie["Arabic Supplement"](e)||ie["Arabic Extended-A"](e)||ie["Arabic Presentation Forms-A"](e)||ie["Arabic Presentation Forms-B"](e))}function T_(e){return!(746!==e&&747!==e&&(e<4352||!(ie["Bopomofo Extended"](e)||ie.Bopomofo(e)||ie["CJK Compatibility Forms"](e)&&!(e>=65097&&e<=65103)||ie["CJK Compatibility Ideographs"](e)||ie["CJK Compatibility"](e)||ie["CJK Radicals Supplement"](e)||ie["CJK Strokes"](e)||!(!ie["CJK Symbols and Punctuation"](e)||e>=12296&&e<=12305||e>=12308&&e<=12319||12336===e)||ie["CJK Unified Ideographs Extension A"](e)||ie["CJK Unified Ideographs"](e)||ie["Enclosed CJK Letters and Months"](e)||ie["Hangul Compatibility Jamo"](e)||ie["Hangul Jamo Extended-A"](e)||ie["Hangul Jamo Extended-B"](e)||ie["Hangul Jamo"](e)||ie["Hangul Syllables"](e)||ie.Hiragana(e)||ie["Ideographic Description Characters"](e)||ie.Kanbun(e)||ie["Kangxi Radicals"](e)||ie["Katakana Phonetic Extensions"](e)||ie.Katakana(e)&&12540!==e||!(!ie["Halfwidth and Fullwidth Forms"](e)||65288===e||65289===e||65293===e||e>=65306&&e<=65310||65339===e||65341===e||65343===e||e>=65371&&e<=65503||65507===e||e>=65512&&e<=65519)||!(!ie["Small Form Variants"](e)||e>=65112&&e<=65118||e>=65123&&e<=65126)||ie["Unified Canadian Aboriginal Syllabics"](e)||ie["Unified Canadian Aboriginal Syllabics Extended"](e)||ie["Vertical Forms"](e)||ie["Yijing Hexagram Symbols"](e)||ie["Yi Syllables"](e)||ie["Yi Radicals"](e))))}function Ax(e){return!(T_(e)||(t=e,ie["Latin-1 Supplement"](t)&&(167===t||169===t||174===t||177===t||188===t||189===t||190===t||215===t||247===t)||ie["General Punctuation"](t)&&(8214===t||8224===t||8225===t||8240===t||8241===t||8251===t||8252===t||8258===t||8263===t||8264===t||8265===t||8273===t)||ie["Letterlike Symbols"](t)||ie["Number Forms"](t)||ie["Miscellaneous Technical"](t)&&(t>=8960&&t<=8967||t>=8972&&t<=8991||t>=8996&&t<=9e3||9003===t||t>=9085&&t<=9114||t>=9150&&t<=9165||9167===t||t>=9169&&t<=9179||t>=9186&&t<=9215)||ie["Control Pictures"](t)&&9251!==t||ie["Optical Character Recognition"](t)||ie["Enclosed Alphanumerics"](t)||ie["Geometric Shapes"](t)||ie["Miscellaneous Symbols"](t)&&!(t>=9754&&t<=9759)||ie["Miscellaneous Symbols and Arrows"](t)&&(t>=11026&&t<=11055||t>=11088&&t<=11097||t>=11192&&t<=11243)||ie["CJK Symbols and Punctuation"](t)||ie.Katakana(t)||ie["Private Use Area"](t)||ie["CJK Compatibility Forms"](t)||ie["Small Form Variants"](t)||ie["Halfwidth and Fullwidth Forms"](t)||8734===t||8756===t||8757===t||t>=9984&&t<=10087||t>=10102&&t<=10131||65532===t||65533===t));var t}function qt(e){return e>=1424&&e<=2303||ie["Arabic Presentation Forms-A"](e)||ie["Arabic Presentation Forms-B"](e)}function Xn(e,t){return!(!t&&qt(e)||e>=2304&&e<=3583||e>=3840&&e<=4255||ie.Khmer(e))}function rM(e){for(const t of e)if(qt(t.charCodeAt(0)))return!0;return!1}const M_="deferred",Pi="loading",em="loaded";let tu=null,ni="unavailable",ka=null;const nm=function(e){e&&"string"==typeof e&&e.indexOf("NetworkError")>-1&&(ni="error"),tu&&tu(e)};function I_(){Px.fire(new Mt("pluginStateChange",{pluginStatus:ni,pluginURL:ka}))}const Px=new ye,rm=function(){return ni},ao=function(){if(ni!==M_||!ka)throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");ni=Pi,I_(),ka&&$t({url:ka},e=>{e?nm(e):(ni=em,I_())})},bi={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>ni===em||null!=bi.applyArabicShaping,isLoading:()=>ni===Pi,setState(e){ni=e.pluginStatus,ka=e.pluginURL},isParsed:()=>null!=bi.applyArabicShaping&&null!=bi.processBidirectionalText&&null!=bi.processStyledBidirectionalText,getPluginURL:()=>ka};class ar{constructor(t,n){this.zoom=t,n?(this.now=n.now,this.fadeDuration=n.fadeDuration,this.transition=n.transition,this.pitch=n.pitch,this.brightness=n.brightness):(this.now=0,this.fadeDuration=0,this.transition={},this.pitch=0,this.brightness=0)}isSupportedScript(t){return function(n,r){for(const o of n)if(!Xn(o.charCodeAt(0),r))return!1;return!0}(t,bi.isLoaded())}}class El{constructor(t,n,r){this.property=t,this.value=n,this.expression=function(o,s,c){if(Yc(o))return new hc(o,s);if(Th(o)||Array.isArray(o)&&o.length>0){const u=Mh(o,s,c);if("error"===u.result)throw new Error(u.value.map(d=>`${d.key}: ${d.message}`).join(", "));return u.value}{let u=o;return"string"==typeof o&&"color"===s.type&&(u=ke.parse(o)),{kind:"constant",isConfigDependent:!1,evaluate:()=>u}}}(void 0===n?t.specification.default:n,t.specification,r)}isDataDriven(){return"source"===this.expression.kind||"composite"===this.expression.kind}possiblyEvaluate(t,n,r){return this.property.possiblyEvaluate(this,t,n,r)}}class ea{constructor(t,n){this.property=t,this.value=new El(t,void 0,n)}transitioned(t,n){return new D_(this.property,this.value,n,Wt({},t.transition,this.transition),t.now)}untransitioned(){return new D_(this.property,this.value,null,{},0)}}class df{constructor(t,n){this._properties=t,this._values=Object.create(t.defaultTransitionablePropertyValues),this._options=n,this.isConfigDependent=!1}getValue(t){return q(this._values[t].value.value)}setValue(t,n){this._values.hasOwnProperty(t)||(this._values[t]=new ea(this._values[t].property,this._options)),this._values[t].value=new El(this._values[t].property,null===n?void 0:q(n),this._options),this.isConfigDependent=this.isConfigDependent||this._values[t].value.expression.isConfigDependent}setTransitionOrValue(t,n){n&&(this._options=n);const r=this._properties.properties;if(t)for(const o in t){const s=t[o];if(Oo(o,"-transition")){const c=o.slice(0,-11);r[c]&&this.setTransition(c,s)}else r[o]&&this.setValue(o,s)}}getTransition(t){return q(this._values[t].transition)}setTransition(t,n){this._values.hasOwnProperty(t)||(this._values[t]=new ea(this._values[t].property)),this._values[t].transition=q(n)||void 0}serialize(){const t={};for(const n of Object.keys(this._values)){const r=this.getValue(n);void 0!==r&&(t[n]=r);const o=this.getTransition(n);void 0!==o&&(t[`${n}-transition`]=o)}return t}transitioned(t,n){const r=new Rx(this._properties);for(const o of Object.keys(this._values))r._values[o]=this._values[o].transitioned(t,n._values[o]);return r}untransitioned(){const t=new Rx(this._properties);for(const n of Object.keys(this._values))t._values[n]=this._values[n].untransitioned();return t}}class D_{constructor(t,n,r,o,s){const c=o.delay||0,u=o.duration||0;s=s||0,this.property=t,this.value=n,this.begin=s+c,this.end=this.begin+u,t.specification.transition&&(o.delay||o.duration)&&(this.prior=r)}possiblyEvaluate(t,n,r){const o=t.now||0,s=this.value.possiblyEvaluate(t,n,r),c=this.prior;if(c){if(o>this.end)return this.prior=null,s;if(this.value.isDataDriven())return this.prior=null,s;if(o<this.begin)return c.possiblyEvaluate(t,n,r);{const u=(o-this.begin)/(this.end-this.begin);return this.property.interpolate(c.possiblyEvaluate(t,n,r),s,ls(u))}}return s}}class Rx{constructor(t){this._properties=t,this._values=Object.create(t.defaultTransitioningPropertyValues)}possiblyEvaluate(t,n,r){const o=new eu(this._properties);for(const s of Object.keys(this._values))o._values[s]=this._values[s].possiblyEvaluate(t,n,r);return o}hasTransition(){for(const t of Object.keys(this._values))if(this._values[t].prior)return!0;return!1}}class iM{constructor(t,n){this._properties=t,this._values=Object.create(t.defaultPropertyValues),this._options=n,this.isConfigDependent=!1}getValue(t){return q(this._values[t].value)}setValue(t,n){this._values[t]=new El(this._values[t].property,null===n?void 0:q(n),this._options),this.isConfigDependent=this.isConfigDependent||this._values[t].expression.isConfigDependent}serialize(){const t={};for(const n of Object.keys(this._values)){const r=this.getValue(n);void 0!==r&&(t[n]=r)}return t}possiblyEvaluate(t,n,r){const o=new eu(this._properties);for(const s of Object.keys(this._values))o._values[s]=this._values[s].possiblyEvaluate(t,n,r);return o}}class fc{constructor(t,n,r){this.property=t,this.value=n,this.parameters=r}isConstant(){return"constant"===this.value.kind}constantOr(t){return"constant"===this.value.kind?this.value.value:t}evaluate(t,n,r,o){return this.property.evaluate(this.value,this.parameters,t,n,r,o)}}class eu{constructor(t){this._properties=t,this._values=Object.create(t.defaultPossiblyEvaluatedValues)}get(t){return this._values[t]}}class Ot{constructor(t){this.specification=t}possiblyEvaluate(t,n){return t.expression.evaluate(n)}interpolate(t,n,r){const o=un[this.specification.type];return o?o(t,n,r):t}}class me{constructor(t,n){this.specification=t,this.overrides=n}possiblyEvaluate(t,n,r,o){return new fc(this,"constant"===t.expression.kind||"camera"===t.expression.kind?{kind:"constant",value:t.expression.evaluate(n,null,{},r,o)}:t.expression,n)}interpolate(t,n,r){if("constant"!==t.value.kind||"constant"!==n.value.kind)return t;if(void 0===t.value.value||void 0===n.value.value)return new fc(this,{kind:"constant",value:void 0},t.parameters);const o=un[this.specification.type];return o?new fc(this,{kind:"constant",value:o(t.value.value,n.value.value,r)},t.parameters):t}evaluate(t,n,r,o,s,c){return"constant"===t.kind?t.value:t.evaluate(n,r,o,s,c)}}class ff{constructor(t){this.specification=t}possiblyEvaluate(t,n,r,o){return!!t.expression.evaluate(n,null,{},r,o)}interpolate(){return!1}}class gr{constructor(t){this.properties=t,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];const n=new ar(0,{});for(const r in t){const o=t[r];o.specification.overridable&&this.overridableProperties.push(r);const s=this.defaultPropertyValues[r]=new El(o,void 0),c=this.defaultTransitionablePropertyValues[r]=new ea(o);this.defaultTransitioningPropertyValues[r]=c.untransitioned(),this.defaultPossiblyEvaluatedValues[r]=s.possiblyEvaluate(n)}}}re(me,"DataDrivenProperty"),re(Ot,"DataConstantProperty"),re(ff,"ColorRampProperty");function S_(e){return e.indexOf("\x1f")>=0}function $i(e,t){return t?`${e}\x1f${t}`:e}function pf(e){const t=e.indexOf("\x1f");return t>=0?e.slice(0,t):e}const C_="-transition";class xo extends ye{constructor(t,n,r){if(super(),this.id=t.id,this.type=t.type,this._featureFilter={filter:()=>!0,needGeometry:!1,needFeature:!1},this._filterCompiled=!1,this.isConfigDependent=!1,"custom"!==t.type&&(this.metadata=t.metadata,this.minzoom=t.minzoom,this.maxzoom=t.maxzoom,"background"!==t.type&&"sky"!==t.type&&"slot"!==t.type&&(this.source=t.source,this.sourceLayer=t["source-layer"],this.filter=t.filter),this.options=r,t.slot&&(this.slot=t.slot),n.layout&&(this._unevaluatedLayout=new iM(n.layout,r),this.isConfigDependent=this.isConfigDependent||this._unevaluatedLayout.isConfigDependent),n.paint)){this._transitionablePaint=new df(n.paint,r);for(const o in t.paint)this.setPaintProperty(o,t.paint[o],{validate:!1});for(const o in t.layout)this.setLayoutProperty(o,t.layout[o],{validate:!1});this.isConfigDependent=this.isConfigDependent||this._transitionablePaint.isConfigDependent,this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new eu(n.paint)}}setScope(t){this.scope=t,this.fqid=$i(this.id,t)}getLayoutProperty(t){return"visibility"===t?this.visibility:this._unevaluatedLayout.getValue(t)}setLayoutProperty(t,n,r={}){if(null!=n&&this._validate(dc,`layers.${this.id}.layout.${t}`,t,n,r))return;if("custom"===this.type&&"visibility"===t)return void(this.visibility=n);const o=this._unevaluatedLayout;o._properties.properties[t]&&(o.setValue(t,n),this.isConfigDependent=this.isConfigDependent||o.isConfigDependent,"visibility"===t&&this.possiblyEvaluateVisibility())}possiblyEvaluateVisibility(){this.visibility=this._unevaluatedLayout._values.visibility.possiblyEvaluate({zoom:0})}getPaintProperty(t){return Oo(t,C_)?this._transitionablePaint.getTransition(t.slice(0,-11)):this._transitionablePaint.getValue(t)}setPaintProperty(t,n,r={}){if(null!=n&&this._validate(tM,`layers.${this.id}.paint.${t}`,t,n,r))return!1;const o=this._transitionablePaint,s=o._properties.properties;if(Oo(t,C_)){const y=t.slice(0,-11);return s[y]&&o.setTransition(y,n||void 0),!1}if(!s[t])return!1;const c=o._values[t],u=c.value.isDataDriven(),d=c.value;o.setValue(t,n),this.isConfigDependent=this.isConfigDependent||o.isConfigDependent,this._handleSpecialPaintPropertyUpdate(t);const f=o._values[t].value,m=f.isDataDriven(),g=Oo(t,"pattern")||"line-dasharray"===t;return m||u||g||this._handleOverridablePaintPropertyUpdate(t,d,f)}_handleSpecialPaintPropertyUpdate(t){}getProgramIds(){return null}getDefaultProgramParams(t,n){return null}_handleOverridablePaintPropertyUpdate(t,n,r){return!1}isHidden(t){return!!(this.minzoom&&t<this.minzoom)||!!(this.maxzoom&&t>=this.maxzoom)||"none"===this.visibility}updateTransitions(t){this._transitioningPaint=this._transitionablePaint.transitioned(t,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(t,n){this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(t,void 0,n)),this.paint=this._transitioningPaint.possiblyEvaluate(t,void 0,n)}serialize(){return St({id:this.id,type:this.type,slot:this.slot,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()},(t,n)=>!(void 0===t||"layout"===n&&!Object.keys(t).length||"paint"===n&&!Object.keys(t).length))}_validate(t,n,r,o,s={}){return(!s||!1!==s.validate)&&uf(this,t.call(bl,{key:n,layerType:this.type,objectKey:r,value:o,styleSpec:H,style:{glyphs:!0,sprite:!0}}))}is3D(){return!1}isSky(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}hasShadowPass(){return!1}canCastShadows(){return!1}hasLightBeamPass(){return!1}cutoffRange(){return 0}resize(){}isStateDependent(){for(const t in this.paint._values){const n=this.paint.get(t);if(n instanceof fc&&Zo(n.property.specification)&&("source"===n.value.kind||"composite"===n.value.kind)&&n.value.isStateDependent)return!0}return!1}compileFilter(){this._filterCompiled||(this._featureFilter=Ih(this.filter),this._filterCompiled=!0)}invalidateCompiledFilter(){this._filterCompiled=!1}dynamicFilter(){return this._featureFilter.dynamicFilter}dynamicFilterNeedsFeature(){return this._featureFilter.needFeature}getLayerRenderingStats(){return this._stats}resetLayerRenderingStats(){this._stats&&(this._stats.numRenderedVerticesInShadowPass=0,this._stats.numRenderedVerticesInTransparentPass=0)}}class oM{constructor(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps=new Set,this._updatedImages=new Set}isDirty(){return this._changed}setDirty(){this._changed=!0}getUpdatedSourceCaches(){return this._updatedSourceCaches}updateSourceCache(t,n){this._updatedSourceCaches[t]=n,this.setDirty()}discardSourceCacheUpdate(t){delete this._updatedSourceCaches[t]}updateLayer(t){const n=t.scope;this._updatedLayers[n]=this._updatedLayers[n]||new Set,this._updatedLayers[n].add(t.id),this.setDirty()}removeLayer(t){const n=t.scope;this._removedLayers[n]=this._removedLayers[n]||{},this._updatedLayers[n]=this._updatedLayers[n]||new Set,this._removedLayers[n][t.id]=t,this._updatedLayers[n].delete(t.id),this._updatedPaintProps.delete(t.fqid),this.setDirty()}getRemovedLayer(t){return this._removedLayers[t.scope]?this._removedLayers[t.scope][t.id]:null}discardLayerRemoval(t){this._removedLayers[t.scope]&&delete this._removedLayers[t.scope][t.id]}getLayerUpdatesByScope(){const t={};for(const n in this._updatedLayers)t[n]=t[n]||{},t[n].updatedIds=Array.from(this._updatedLayers[n].values());for(const n in this._removedLayers)t[n]=t[n]||{},t[n].removedIds=Object.keys(this._removedLayers[n]);return t}getUpdatedPaintProperties(){return this._updatedPaintProps}updatePaintProperties(t){this._updatedPaintProps.add(t.fqid),this.setDirty()}getUpdatedImages(){return Array.from(this._updatedImages.values())}updateImage(t){this._updatedImages.add(t),this.setDirty()}resetUpdatedImages(){this._updatedImages.clear()}reset(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps.clear(),this._updatedImages.clear()}}const sM={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class Hi{constructor(t,n){this._structArray=t,this._pos1=n*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class $n{constructor(){this.isTransferred=!1,this.capacity=-1,this.resize(0)}static serialize(t,n){return t._trim(),n&&(t.isTransferred=!0,n.add(t.arrayBuffer)),{length:t.length,arrayBuffer:t.arrayBuffer}}static deserialize(t){const n=Object.create(this.prototype);return n.arrayBuffer=t.arrayBuffer,n.length=t.length,n.capacity=t.arrayBuffer.byteLength/n.bytesPerElement,n._refreshViews(),n}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(t){this.reserve(t),this.length=t}reserve(t){if(t>this.capacity){this.capacity=Math.max(t,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const n=this.uint8;this._refreshViews(),n&&this.uint8.set(n)}}_refreshViews(){throw new Error("_refreshViews() must be implemented by each concrete StructArray layout")}destroy(){this.int8=this.uint8=this.int16=this.uint16=this.int32=this.uint32=this.float32=null,this.arrayBuffer=null}}function Ce(e,t=1){let n=0,r=0;return{members:e.map(o=>{const s=sM[o.type].BYTES_PER_ELEMENT,c=n=Lx(n,Math.max(t,s)),u=o.components||1;return r=Math.max(r,s),n+=s*u,{name:o.name,type:o.type,components:u,offset:c}}),size:Lx(n,Math.max(r,t)),alignment:t}}function Lx(e,t){return Math.ceil(e/t)*t}class Xo extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,n){const r=this.length;return this.resize(r+1),this.emplace(r,t,n)}emplace(t,n,r){const o=2*t;return this.int16[o+0]=n,this.int16[o+1]=r,t}}Xo.prototype.bytesPerElement=4,re(Xo,"StructArrayLayout2i4");class im extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,n,r){const o=this.length;return this.resize(o+1),this.emplace(o,t,n,r)}emplace(t,n,r,o){const s=3*t;return this.int16[s+0]=n,this.int16[s+1]=r,this.int16[s+2]=o,t}}im.prototype.bytesPerElement=6,re(im,"StructArrayLayout3i6");class nu extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,n,r,o){const s=this.length;return this.resize(s+1),this.emplace(s,t,n,r,o)}emplace(t,n,r,o,s){const c=4*t;return this.int16[c+0]=n,this.int16[c+1]=r,this.int16[c+2]=o,this.int16[c+3]=s,t}}nu.prototype.bytesPerElement=8,re(nu,"StructArrayLayout4i8");class om extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,n,r,o,s){const c=this.length;return this.resize(c+1),this.emplace(c,t,n,r,o,s)}emplace(t,n,r,o,s,c){const u=5*t;return this.int16[u+0]=n,this.int16[u+1]=r,this.int16[u+2]=o,this.int16[u+3]=s,this.int16[u+4]=c,t}}om.prototype.bytesPerElement=10,re(om,"StructArrayLayout5i10");class sm extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,n,r,o,s,c,u){const d=this.length;return this.resize(d+1),this.emplace(d,t,n,r,o,s,c,u)}emplace(t,n,r,o,s,c,u,d){const f=6*t,m=12*t,g=3*t;return this.int16[f+0]=n,this.int16[f+1]=r,this.uint8[m+4]=o,this.uint8[m+5]=s,this.uint8[m+6]=c,this.uint8[m+7]=u,this.float32[g+2]=d,t}}sm.prototype.bytesPerElement=12,re(sm,"StructArrayLayout2i4ub1f12");class Fs extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,n,r,o){const s=this.length;return this.resize(s+1),this.emplace(s,t,n,r,o)}emplace(t,n,r,o,s){const c=4*t;return this.float32[c+0]=n,this.float32[c+1]=r,this.float32[c+2]=o,this.float32[c+3]=s,t}}Fs.prototype.bytesPerElement=16,re(Fs,"StructArrayLayout4f16");class bo extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,n,r,o,s){const c=this.length;return this.resize(c+1),this.emplace(c,t,n,r,o,s)}emplace(t,n,r,o,s,c){const u=6*t,d=3*t;return this.uint16[u+0]=n,this.uint16[u+1]=r,this.uint16[u+2]=o,this.uint16[u+3]=s,this.float32[d+2]=c,t}}bo.prototype.bytesPerElement=12,re(bo,"StructArrayLayout4ui1f12");class am extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,n,r,o){const s=this.length;return this.resize(s+1),this.emplace(s,t,n,r,o)}emplace(t,n,r,o,s){const c=4*t;return this.uint16[c+0]=n,this.uint16[c+1]=r,this.uint16[c+2]=o,this.uint16[c+3]=s,t}}am.prototype.bytesPerElement=8,re(am,"StructArrayLayout4ui8");class ru extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,n,r,o,s,c){const u=this.length;return this.resize(u+1),this.emplace(u,t,n,r,o,s,c)}emplace(t,n,r,o,s,c,u){const d=6*t;return this.int16[d+0]=n,this.int16[d+1]=r,this.int16[d+2]=o,this.int16[d+3]=s,this.int16[d+4]=c,this.int16[d+5]=u,t}}ru.prototype.bytesPerElement=12,re(ru,"StructArrayLayout6i12");class Ah extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,n,r,o,s,c,u,d,f,m,g,y){const v=this.length;return this.resize(v+1),this.emplace(v,t,n,r,o,s,c,u,d,f,m,g,y)}emplace(t,n,r,o,s,c,u,d,f,m,g,y,v){const x=12*t;return this.int16[x+0]=n,this.int16[x+1]=r,this.int16[x+2]=o,this.int16[x+3]=s,this.uint16[x+4]=c,this.uint16[x+5]=u,this.uint16[x+6]=d,this.uint16[x+7]=f,this.int16[x+8]=m,this.int16[x+9]=g,this.int16[x+10]=y,this.int16[x+11]=v,t}}Ah.prototype.bytesPerElement=24,re(Ah,"StructArrayLayout4i4ui4i24");class Ph extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,n,r,o,s,c){const u=this.length;return this.resize(u+1),this.emplace(u,t,n,r,o,s,c)}emplace(t,n,r,o,s,c,u){const d=10*t,f=5*t;return this.int16[d+0]=n,this.int16[d+1]=r,this.int16[d+2]=o,this.float32[f+2]=s,this.float32[f+3]=c,this.float32[f+4]=u,t}}Ph.prototype.bytesPerElement=20,re(Ph,"StructArrayLayout3i3f20");class mf extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(t){const n=this.length;return this.resize(n+1),this.emplace(n,t)}emplace(t,n){return this.uint32[1*t+0]=n,t}}mf.prototype.bytesPerElement=4,re(mf,"StructArrayLayout1ul4");class Tl extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,n){const r=this.length;return this.resize(r+1),this.emplace(r,t,n)}emplace(t,n,r){const o=2*t;return this.uint16[o+0]=n,this.uint16[o+1]=r,t}}Tl.prototype.bytesPerElement=4,re(Tl,"StructArrayLayout2ui4");class lm extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,n,r,o,s,c,u,d,f,m,g,y,v){const x=this.length;return this.resize(x+1),this.emplace(x,t,n,r,o,s,c,u,d,f,m,g,y,v)}emplace(t,n,r,o,s,c,u,d,f,m,g,y,v,x){const w=20*t,E=10*t;return this.int16[w+0]=n,this.int16[w+1]=r,this.int16[w+2]=o,this.int16[w+3]=s,this.int16[w+4]=c,this.float32[E+3]=u,this.float32[E+4]=d,this.float32[E+5]=f,this.float32[E+6]=m,this.int16[w+14]=g,this.uint32[E+8]=y,this.uint16[w+18]=v,this.uint16[w+19]=x,t}}lm.prototype.bytesPerElement=40,re(lm,"StructArrayLayout5i4f1i1ul2ui40");class cm extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,n,r,o,s,c,u){const d=this.length;return this.resize(d+1),this.emplace(d,t,n,r,o,s,c,u)}emplace(t,n,r,o,s,c,u,d){const f=8*t;return this.int16[f+0]=n,this.int16[f+1]=r,this.int16[f+2]=o,this.int16[f+4]=s,this.int16[f+5]=c,this.int16[f+6]=u,this.int16[f+7]=d,t}}cm.prototype.bytesPerElement=16,re(cm,"StructArrayLayout3i2i2i16");class pc extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,n,r,o,s){const c=this.length;return this.resize(c+1),this.emplace(c,t,n,r,o,s)}emplace(t,n,r,o,s,c){const u=4*t,d=8*t;return this.float32[u+0]=n,this.float32[u+1]=r,this.float32[u+2]=o,this.int16[d+6]=s,this.int16[d+7]=c,t}}pc.prototype.bytesPerElement=16,re(pc,"StructArrayLayout2f1f2i16");class iu extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,n,r,o){const s=this.length;return this.resize(s+1),this.emplace(s,t,n,r,o)}emplace(t,n,r,o,s){const c=12*t,u=3*t;return this.uint8[c+0]=n,this.uint8[c+1]=r,this.float32[u+1]=o,this.float32[u+2]=s,t}}iu.prototype.bytesPerElement=12,re(iu,"StructArrayLayout2ub2f12");class Kr extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,n,r){const o=this.length;return this.resize(o+1),this.emplace(o,t,n,r)}emplace(t,n,r,o){const s=3*t;return this.uint16[s+0]=n,this.uint16[s+1]=r,this.uint16[s+2]=o,t}}Kr.prototype.bytesPerElement=6,re(Kr,"StructArrayLayout3ui6");class Ox extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(t,n,r,o,s,c,u,d,f,m,g,y,v,x,w,E,M,D,A,P,C){const R=this.length;return this.resize(R+1),this.emplace(R,t,n,r,o,s,c,u,d,f,m,g,y,v,x,w,E,M,D,A,P,C)}emplace(t,n,r,o,s,c,u,d,f,m,g,y,v,x,w,E,M,D,A,P,C,R){const k=30*t,N=15*t,z=60*t;return this.int16[k+0]=n,this.int16[k+1]=r,this.int16[k+2]=o,this.float32[N+2]=s,this.float32[N+3]=c,this.uint16[k+8]=u,this.uint16[k+9]=d,this.uint32[N+5]=f,this.uint32[N+6]=m,this.uint32[N+7]=g,this.uint16[k+16]=y,this.uint16[k+17]=v,this.uint16[k+18]=x,this.float32[N+10]=w,this.float32[N+11]=E,this.uint8[z+48]=M,this.uint8[z+49]=D,this.uint8[z+50]=A,this.uint32[N+13]=P,this.int16[k+28]=C,this.uint8[z+58]=R,t}}Ox.prototype.bytesPerElement=60,re(Ox,"StructArrayLayout3i2f2ui3ul3ui2f3ub1ul1i1ub60");class gf extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(t,n,r,o,s,c,u,d,f,m,g,y,v,x,w,E,M,D,A,P,C,R,k,N,z,B,U,$,W,V,K,Q){const ot=this.length;return this.resize(ot+1),this.emplace(ot,t,n,r,o,s,c,u,d,f,m,g,y,v,x,w,E,M,D,A,P,C,R,k,N,z,B,U,$,W,V,K,Q)}emplace(t,n,r,o,s,c,u,d,f,m,g,y,v,x,w,E,M,D,A,P,C,R,k,N,z,B,U,$,W,V,K,Q,ot){const Y=20*t,J=40*t,ct=80*t;return this.float32[Y+0]=n,this.float32[Y+1]=r,this.int16[J+4]=o,this.int16[J+5]=s,this.int16[J+6]=c,this.int16[J+7]=u,this.int16[J+8]=d,this.int16[J+9]=f,this.int16[J+10]=m,this.int16[J+11]=g,this.int16[J+12]=y,this.uint16[J+13]=v,this.uint16[J+14]=x,this.uint16[J+15]=w,this.uint16[J+16]=E,this.uint16[J+17]=M,this.uint16[J+18]=D,this.uint16[J+19]=A,this.uint16[J+20]=P,this.uint16[J+21]=C,this.uint16[J+22]=R,this.uint16[J+23]=k,this.uint16[J+24]=N,this.uint16[J+25]=z,this.uint16[J+26]=B,this.uint16[J+27]=U,this.uint32[Y+14]=$,this.float32[Y+15]=W,this.float32[Y+16]=V,this.float32[Y+17]=K,this.float32[Y+18]=Q,this.uint8[ct+76]=ot,t}}gf.prototype.bytesPerElement=80,re(gf,"StructArrayLayout2f9i15ui1ul4f1ub80");class um extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t){const n=this.length;return this.resize(n+1),this.emplace(n,t)}emplace(t,n){return this.float32[1*t+0]=n,t}}um.prototype.bytesPerElement=4,re(um,"StructArrayLayout1f4");class ou extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,n,r,o,s){const c=this.length;return this.resize(c+1),this.emplace(c,t,n,r,o,s)}emplace(t,n,r,o,s,c){const u=5*t;return this.float32[u+0]=n,this.float32[u+1]=r,this.float32[u+2]=o,this.float32[u+3]=s,this.float32[u+4]=c,t}}ou.prototype.bytesPerElement=20,re(ou,"StructArrayLayout5f20");class A_ extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,n,r,o,s,c,u){const d=this.length;return this.resize(d+1),this.emplace(d,t,n,r,o,s,c,u)}emplace(t,n,r,o,s,c,u,d){const f=7*t;return this.float32[f+0]=n,this.float32[f+1]=r,this.float32[f+2]=o,this.float32[f+3]=s,this.float32[f+4]=c,this.float32[f+5]=u,this.float32[f+6]=d,t}}A_.prototype.bytesPerElement=28,re(A_,"StructArrayLayout7f28");class kx extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,n,r,o){const s=this.length;return this.resize(s+1),this.emplace(s,t,n,r,o)}emplace(t,n,r,o,s){const c=6*t;return this.uint32[3*t+0]=n,this.uint16[c+2]=r,this.uint16[c+3]=o,this.uint16[c+4]=s,t}}kx.prototype.bytesPerElement=12,re(kx,"StructArrayLayout1ul3ui12");class hm extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t){const n=this.length;return this.resize(n+1),this.emplace(n,t)}emplace(t,n){return this.uint16[1*t+0]=n,t}}hm.prototype.bytesPerElement=2,re(hm,"StructArrayLayout1ui2");class Ml extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,n,r){const o=this.length;return this.resize(o+1),this.emplace(o,t,n,r)}emplace(t,n,r,o){const s=3*t;return this.float32[s+0]=n,this.float32[s+1]=r,this.float32[s+2]=o,t}}Ml.prototype.bytesPerElement=12,re(Ml,"StructArrayLayout3f12");class Il extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,n){const r=this.length;return this.resize(r+1),this.emplace(r,t,n)}emplace(t,n,r){const o=2*t;return this.float32[o+0]=n,this.float32[o+1]=r,t}}Il.prototype.bytesPerElement=8,re(Il,"StructArrayLayout2f8");class P_ extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,n,r,o,s,c,u,d,f,m,g,y,v,x,w,E){const M=this.length;return this.resize(M+1),this.emplace(M,t,n,r,o,s,c,u,d,f,m,g,y,v,x,w,E)}emplace(t,n,r,o,s,c,u,d,f,m,g,y,v,x,w,E,M){const D=16*t;return this.float32[D+0]=n,this.float32[D+1]=r,this.float32[D+2]=o,this.float32[D+3]=s,this.float32[D+4]=c,this.float32[D+5]=u,this.float32[D+6]=d,this.float32[D+7]=f,this.float32[D+8]=m,this.float32[D+9]=g,this.float32[D+10]=y,this.float32[D+11]=v,this.float32[D+12]=x,this.float32[D+13]=w,this.float32[D+14]=E,this.float32[D+15]=M,t}}P_.prototype.bytesPerElement=64,re(P_,"StructArrayLayout16f64");class mc extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,n,r,o,s,c,u){const d=this.length;return this.resize(d+1),this.emplace(d,t,n,r,o,s,c,u)}emplace(t,n,r,o,s,c,u,d){const f=10*t,m=5*t;return this.uint16[f+0]=n,this.uint16[f+1]=r,this.uint16[f+2]=o,this.uint16[f+3]=s,this.float32[m+2]=c,this.float32[m+3]=u,this.float32[m+4]=d,t}}mc.prototype.bytesPerElement=20,re(mc,"StructArrayLayout4ui3f20");class _f extends $n{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer)}emplaceBack(t){const n=this.length;return this.resize(n+1),this.emplace(n,t)}emplace(t,n){return this.uint8[1*t+0]=n,t}}_f.prototype.bytesPerElement=1,re(_f,"StructArrayLayout1ub1");class yf extends Hi{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.int16[this._pos2+3]}get tileAnchorY(){return this._structArray.int16[this._pos2+4]}get x1(){return this._structArray.float32[this._pos4+3]}get y1(){return this._structArray.float32[this._pos4+4]}get x2(){return this._structArray.float32[this._pos4+5]}get y2(){return this._structArray.float32[this._pos4+6]}get padding(){return this._structArray.int16[this._pos2+14]}get featureIndex(){return this._structArray.uint32[this._pos4+8]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+18]}get bucketIndex(){return this._structArray.uint16[this._pos2+19]}}yf.prototype.size=40;class Fx extends lm{get(t){return new yf(this,t)}}re(Fx,"CollisionBoxArray");class R_ extends Hi{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+8]}get numGlyphs(){return this._structArray.uint16[this._pos2+9]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+5]}get lineStartIndex(){return this._structArray.uint32[this._pos4+6]}get lineLength(){return this._structArray.uint32[this._pos4+7]}get segment(){return this._structArray.uint16[this._pos2+16]}get lowerSize(){return this._structArray.uint16[this._pos2+17]}get upperSize(){return this._structArray.uint16[this._pos2+18]}get lineOffsetX(){return this._structArray.float32[this._pos4+10]}get lineOffsetY(){return this._structArray.float32[this._pos4+11]}get writingMode(){return this._structArray.uint8[this._pos1+48]}get placedOrientation(){return this._structArray.uint8[this._pos1+49]}set placedOrientation(t){this._structArray.uint8[this._pos1+49]=t}get hidden(){return this._structArray.uint8[this._pos1+50]}set hidden(t){this._structArray.uint8[this._pos1+50]=t}get crossTileID(){return this._structArray.uint32[this._pos4+13]}set crossTileID(t){this._structArray.uint32[this._pos4+13]=t}get associatedIconIndex(){return this._structArray.int16[this._pos2+28]}get flipState(){return this._structArray.uint8[this._pos1+58]}set flipState(t){this._structArray.uint8[this._pos1+58]=t}}R_.prototype.size=60;class L_ extends Ox{get(t){return new R_(this,t)}}re(L_,"PlacedSymbolArray");class Nx extends Hi{get tileAnchorX(){return this._structArray.float32[this._pos4+0]}get tileAnchorY(){return this._structArray.float32[this._pos4+1]}get projectedAnchorX(){return this._structArray.int16[this._pos2+4]}get projectedAnchorY(){return this._structArray.int16[this._pos2+5]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+6]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+7]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+8]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+9]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+10]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+11]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+12]}get key(){return this._structArray.uint16[this._pos2+13]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+14]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+15]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+16]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+17]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+18]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+19]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+20]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+21]}get featureIndex(){return this._structArray.uint16[this._pos2+22]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+23]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+24]}get numIconVertices(){return this._structArray.uint16[this._pos2+25]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+26]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+27]}get crossTileID(){return this._structArray.uint32[this._pos4+14]}set crossTileID(t){this._structArray.uint32[this._pos4+14]=t}get textOffset0(){return this._structArray.float32[this._pos4+15]}get textOffset1(){return this._structArray.float32[this._pos4+16]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+17]}get zOffset(){return this._structArray.float32[this._pos4+18]}set zOffset(t){this._structArray.float32[this._pos4+18]=t}get hasIconTextFit(){return this._structArray.uint8[this._pos1+76]}}Nx.prototype.size=80;class na extends gf{get(t){return new Nx(this,t)}}re(na,"SymbolInstanceArray");class zx extends um{getoffsetX(t){return this.float32[1*t+0]}}re(zx,"GlyphOffsetArray");class vf extends Xo{getx(t){return this.int16[2*t+0]}gety(t){return this.int16[2*t+1]}}re(vf,"SymbolLineVertexArray");class dm extends Hi{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}get layoutVertexArrayOffset(){return this._structArray.uint16[this._pos2+4]}}dm.prototype.size=12;class O_ extends kx{get(t){return new dm(this,t)}}re(O_,"FeatureIndexArray");class xf extends Tl{geta_centroid_pos0(t){return this.uint16[2*t+0]}geta_centroid_pos1(t){return this.uint16[2*t+1]}}re(xf,"FillExtrusionCentroidArray");const k_=Ce([{name:"a_pos",components:2,type:"Int16"}],4),aM=Ce([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]);class Rn{constructor(t=[]){this.segments=t}_prepareSegment(t,n,r,o){let s=this.segments[this.segments.length-1];return t>Rn.MAX_VERTEX_ARRAY_LENGTH&&nt(`Max vertices per segment is ${Rn.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${t}`),(!s||s.vertexLength+t>Rn.MAX_VERTEX_ARRAY_LENGTH||s.sortKey!==o)&&(s={vertexOffset:n,primitiveOffset:r,vertexLength:0,primitiveLength:0},void 0!==o&&(s.sortKey=o),this.segments.push(s)),s}prepareSegment(t,n,r,o){return this._prepareSegment(t,n.length,r.length,o)}get(){return this.segments}destroy(){for(const t of this.segments)for(const n in t.vaos)t.vaos[n].destroy()}static simpleSegment(t,n,r,o){return new Rn([{vertexOffset:t,primitiveOffset:n,vertexLength:r,primitiveLength:o,vaos:{},sortKey:0}])}}function F_(e,t){return 256*(e=ne(Math.floor(e),0,255))+ne(Math.floor(t),0,255)}Rn.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,re(Rn,"SegmentVector");const Bx=Ce([{name:"a_pattern",components:4,type:"Uint16"},{name:"a_pixel_ratio",components:1,type:"Float32"}]),jx=Ce([{name:"a_dash",components:4,type:"Uint16"}]);var fm={exports:{}},su={exports:function(t,n){var r,o,s,c,u,d,f,m;for(o=t.length-(r=3&t.length),s=n,u=3432918353,d=461845907,m=0;m<o;)f=255&t.charCodeAt(m)|(255&t.charCodeAt(++m))<<8|(255&t.charCodeAt(++m))<<16|(255&t.charCodeAt(++m))<<24,++m,s=27492+(65535&(c=5*(65535&(s=(s^=f=(65535&(f=(f=(65535&f)*u+(((f>>>16)*u&65535)<<16)&4294967295)<<15|f>>>17))*d+(((f>>>16)*d&65535)<<16)&4294967295)<<13|s>>>19))+((5*(s>>>16)&65535)<<16)&4294967295))+((58964+(c>>>16)&65535)<<16);switch(f=0,r){case 3:f^=(255&t.charCodeAt(m+2))<<16;case 2:f^=(255&t.charCodeAt(m+1))<<8;case 1:s^=f=(65535&(f=(f=(65535&(f^=255&t.charCodeAt(m)))*u+(((f>>>16)*u&65535)<<16)&4294967295)<<15|f>>>17))*d+(((f>>>16)*d&65535)<<16)&4294967295}return s^=t.length,s=2246822507*(65535&(s^=s>>>16))+((2246822507*(s>>>16)&65535)<<16)&4294967295,s=3266489909*(65535&(s^=s>>>13))+((3266489909*(s>>>16)&65535)<<16)&4294967295,(s^=s>>>16)>>>0}}.exports,Vx={exports:{}};Vx.exports=function(t,n){for(var r,o=t.length,s=n^o,c=0;o>=4;)r=1540483477*(65535&(r=255&t.charCodeAt(c)|(255&t.charCodeAt(++c))<<8|(255&t.charCodeAt(++c))<<16|(255&t.charCodeAt(++c))<<24))+((1540483477*(r>>>16)&65535)<<16),s=1540483477*(65535&s)+((1540483477*(s>>>16)&65535)<<16)^(r=1540483477*(65535&(r^=r>>>24))+((1540483477*(r>>>16)&65535)<<16)),o-=4,++c;switch(o){case 3:s^=(255&t.charCodeAt(c+2))<<16;case 2:s^=(255&t.charCodeAt(c+1))<<8;case 1:s=1540483477*(65535&(s^=255&t.charCodeAt(c)))+((1540483477*(s>>>16)&65535)<<16)}return s=1540483477*(65535&(s^=s>>>13))+((1540483477*(s>>>16)&65535)<<16),(s^=s>>>15)>>>0};var N_=su,Ux=Vx.exports;fm.exports=N_,fm.exports.murmur3=N_,fm.exports.murmur2=Ux;var au=rr(fm.exports);class wf{constructor(){this.ids=[],this.uniqueIds=[],this.positions=[],this.indexed=!1}add(t,n,r,o){this.ids.push(lo(t)),this.positions.push(n,r,o)}eachPosition(t,n){const r=lo(t);let o=0,s=this.ids.length-1;for(;o<s;){const c=o+s>>1;this.ids[c]>=r?s=c:o=c+1}for(;this.ids[o]===r;)n(this.positions[3*o],this.positions[3*o+1],this.positions[3*o+2]),o++}static serialize(t,n){const r=new Float64Array(t.ids),o=new Uint32Array(t.positions);return z_(r,o,0,r.length-1),n&&(n.add(r.buffer),n.add(o.buffer)),{ids:r,positions:o}}static deserialize(t){const n=new wf;let r;n.ids=t.ids,n.positions=t.positions;for(const o of n.ids)o!==r&&n.uniqueIds.push(o),r=o;return n.indexed=!0,n}}function lo(e){const t=+e;return!isNaN(t)&&Number.MIN_SAFE_INTEGER<=t&&t<=Number.MAX_SAFE_INTEGER?t:au(String(e))}function z_(e,t,n,r){for(;n<r;){const o=e[n+r>>1];let s=n-1,c=r+1;for(;;){do{s++}while(e[s]<o);do{c--}while(e[c]>o);if(s>=c)break;pm(e,s,c),pm(t,3*s,3*c),pm(t,3*s+1,3*c+1),pm(t,3*s+2,3*c+2)}c-n<r-c?(z_(e,t,n,c),n=c+1):(z_(e,t,c+1,r),r=c)}}function pm(e,t,n){const r=e[t];e[t]=e[n],e[n]=r}re(wf,"FeaturePositionMap");class ra{constructor(t){this.gl=t.gl,this.initialized=!1}fetchUniformLocation(t,n){return this.location||this.initialized||(this.location=this.gl.getUniformLocation(t,n),this.initialized=!0),!!this.location}}class Ze extends ra{constructor(t){super(t),this.current=0}set(t,n,r){this.fetchUniformLocation(t,n)&&this.current!==r&&(this.current=r,this.gl.uniform1i(this.location,r))}}class Rt extends ra{constructor(t){super(t),this.current=0}set(t,n,r){this.fetchUniformLocation(t,n)&&this.current!==r&&(this.current=r,this.gl.uniform1f(this.location,r))}}class Ve extends ra{constructor(t){super(t),this.current=[0,0]}set(t,n,r){this.fetchUniformLocation(t,n)&&(r[0]===this.current[0]&&r[1]===this.current[1]||(this.current=r,this.gl.uniform2f(this.location,r[0],r[1])))}}class Ae extends ra{constructor(t){super(t),this.current=[0,0,0]}set(t,n,r){this.fetchUniformLocation(t,n)&&(r[0]===this.current[0]&&r[1]===this.current[1]&&r[2]===this.current[2]||(this.current=r,this.gl.uniform3f(this.location,r[0],r[1],r[2])))}}class Ri extends ra{constructor(t){super(t),this.current=[0,0,0,0]}set(t,n,r){this.fetchUniformLocation(t,n)&&(r[0]===this.current[0]&&r[1]===this.current[1]&&r[2]===this.current[2]&&r[3]===this.current[3]||(this.current=r,this.gl.uniform4f(this.location,r[0],r[1],r[2],r[3])))}}class ia extends ra{constructor(t){super(t),this.current=ke.transparent}set(t,n,r){this.fetchUniformLocation(t,n)&&(r.r===this.current.r&&r.g===this.current.g&&r.b===this.current.b&&r.a===this.current.a||(this.current=r,this.gl.uniform4f(this.location,r.r,r.g,r.b,r.a)))}}const Gx=new Float32Array(16);class Re extends ra{constructor(t){super(t),this.current=Gx}set(t,n,r){if(this.fetchUniformLocation(t,n)){if(r[12]!==this.current[12]||r[0]!==this.current[0])return this.current=r,void this.gl.uniformMatrix4fv(this.location,!1,r);for(let o=1;o<16;o++)if(r[o]!==this.current[o]){this.current=r,this.gl.uniformMatrix4fv(this.location,!1,r);break}}}}const Rh=new Float32Array(9);class $x extends ra{constructor(t){super(t),this.current=Rh}set(t,n,r){if(this.fetchUniformLocation(t,n))for(let o=0;o<9;o++)if(r[o]!==this.current[o]){this.current=r,this.gl.uniformMatrix3fv(this.location,!1,r);break}}}const lM=new Float32Array(4);class Hx extends ra{constructor(t){super(t),this.current=lM}set(t,n,r){if(this.fetchUniformLocation(t,n))for(let o=0;o<4;o++)if(r[o]!==this.current[o]){this.current=r,this.gl.uniformMatrix2fv(this.location,!1,r);break}}}function qx(e){return[F_(255*e.r,255*e.g),F_(255*e.b,255*e.a)]}class mm{constructor(t,n,r){this.value=t,this.uniformNames=n.map(o=>`u_${o}`),this.type=r}setUniform(t,n,r,o,s){n.set(t,s,o.constantOr(this.value))}getBinding(t,n){return"color"===this.type?new ia(t):new Rt(t)}}class Ef{constructor(t,n){this.uniformNames=n.map(r=>`u_${r}`),this.pattern=null,this.pixelRatio=1}setConstantPatternPositions(t){this.pixelRatio=t.pixelRatio||1,this.pattern=t.tl.concat(t.br)}setUniform(t,n,r,o,s){const c="u_pattern"===s||"u_dash"===s?this.pattern:"u_pixel_ratio"===s?this.pixelRatio:null;c&&n.set(t,s,c)}getBinding(t,n){return"u_pattern"===n||"u_dash"===n?new Ri(t):new Rt(t)}}class gc{constructor(t,n,r,o){this.expression=t,this.type=r,this.maxValue=0,this.paintVertexAttributes=n.map(s=>({name:`a_${s}`,type:"Float32",components:"color"===r?2:1,offset:0})),this.paintVertexArray=new o}populatePaintArray(t,n,r,o,s,c,u){const d=this.paintVertexArray.length,f=this.expression.evaluate(new ar(0,{brightness:c}),n,{},s,o,u);this.paintVertexArray.resize(t),this._setPaintValue(d,t,f)}updatePaintArray(t,n,r,o,s,c,u){const d=this.expression.evaluate({zoom:0,brightness:u},r,o,void 0,s);this._setPaintValue(t,n,d)}_setPaintValue(t,n,r){if("color"===this.type){const o=qx(r);for(let s=t;s<n;s++)this.paintVertexArray.emplace(s,o[0],o[1])}else{for(let o=t;o<n;o++)this.paintVertexArray.emplace(o,r);this.maxValue=Math.max(this.maxValue,Math.abs(r))}}upload(t){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=t.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class Fa{constructor(t,n,r,o,s,c){this.expression=t,this.uniformNames=n.map(u=>`u_${u}_t`),this.type=r,this.useIntegerZoom=o,this.zoom=s,this.maxValue=0,this.paintVertexAttributes=n.map(u=>({name:`a_${u}`,type:"Float32",components:"color"===r?4:2,offset:0})),this.paintVertexArray=new c}populatePaintArray(t,n,r,o,s,c,u){const d=this.expression.evaluate(new ar(this.zoom,{brightness:c}),n,{},s,o,u),f=this.expression.evaluate(new ar(this.zoom+1,{brightness:c}),n,{},s,o,u),m=this.paintVertexArray.length;this.paintVertexArray.resize(t),this._setPaintValue(m,t,d,f)}updatePaintArray(t,n,r,o,s,c,u){const d=this.expression.evaluate({zoom:this.zoom,brightness:u},r,o,void 0,s),f=this.expression.evaluate({zoom:this.zoom+1,brightness:u},r,o,void 0,s);this._setPaintValue(t,n,d,f)}_setPaintValue(t,n,r,o){if("color"===this.type){const s=qx(r),c=qx(o);for(let u=t;u<n;u++)this.paintVertexArray.emplace(u,s[0],s[1],c[0],c[1])}else{for(let s=t;s<n;s++)this.paintVertexArray.emplace(s,r,o);this.maxValue=Math.max(this.maxValue,Math.abs(r),Math.abs(o))}}upload(t){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=t.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(t,n,r,o,s){const c=this.useIntegerZoom?Math.floor(r.zoom):r.zoom,u=ne(this.expression.interpolationFactor(c,this.zoom,this.zoom+1),0,1);n.set(t,s,u)}getBinding(t,n){return new Rt(t)}}class gs{constructor(t,n,r,o,s){this.expression=t,this.layerId=s,this.paintVertexAttributes=("array"===r?jx:Bx).members;for(let c=0;c<n.length;++c);this.paintVertexArray=new o}populatePaintArray(t,n,r){const o=this.paintVertexArray.length;this.paintVertexArray.resize(t),this._setPaintValues(o,t,n.patterns&&n.patterns[this.layerId],r)}updatePaintArray(t,n,r,o,s,c,u){this._setPaintValues(t,n,r.patterns&&r.patterns[this.layerId],c)}_setPaintValues(t,n,r,o){if(!o||!r)return;const s=o[r];if(!s)return;const{tl:c,br:u,pixelRatio:d}=s;for(let f=t;f<n;f++)this.paintVertexArray.emplace(f,c[0],c[1],u[0],u[1],d)}upload(t){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer=t.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class lu{constructor(t,n,r=(()=>!0)){this.binders={},this._buffers=[];const o=[];for(const s in t.paint._values){const c=t.paint.get(s);if(!r(s)||!(c instanceof fc&&Zo(c.property.specification)))continue;const u=cM(s,t.type),d=c.value,f=c.property.specification.type,m=!!c.property.useIntegerZoom,g="line-dasharray"===s||s.endsWith("pattern"),y="line-dasharray"===s&&"constant"!==t.layout.get("line-cap").value.kind;if("constant"!==d.kind||y)if("source"===d.kind||y||g){const v=_s(s,f,"source");this.binders[s]=g?new gs(d,u,f,v,t.id):new gc(d,u,f,v),o.push(`/a_${s}`)}else{const v=_s(s,f,"composite");this.binders[s]=new Fa(d,u,f,m,n,v),o.push(`/z_${s}`)}else this.binders[s]=g?new Ef(d.value,u):new mm(d.value,u,f),o.push(`/u_${s}`)}this.cacheKey=o.sort().join("")}getMaxValue(t){const n=this.binders[t];return n instanceof gc||n instanceof Fa?n.maxValue:0}populatePaintArrays(t,n,r,o,s,c,u){for(const d in this.binders){const f=this.binders[d];(f instanceof gc||f instanceof Fa||f instanceof gs)&&f.populatePaintArray(t,n,r,o,s,c,u)}}setConstantPatternPositions(t){for(const n in this.binders){const r=this.binders[n];r instanceof Ef&&r.setConstantPatternPositions(t)}}updatePaintArrays(t,n,r,o,s,c,u,d){let f=!1;const m=Object.keys(t),g=0!==m.length,y=g?m:n.uniqueIds;for(const v in this.binders){const x=this.binders[v];if((x instanceof gc||x instanceof Fa||x instanceof gs)&&(!0===x.expression.isStateDependent||!1===x.expression.isLightConstant)){const w=s.paint.get(v);x.expression=w.value;for(const E of y){const M=t[E.toString()];n.eachPosition(E,(D,A,P)=>{const C=o.feature(D);x.updatePaintArray(A,P,C,M,c,u,d)})}if(!g)for(const E of r.uniqueIds){const M=t[E.toString()];r.eachPosition(E,(D,A,P)=>{const C=o.feature(D);x.updatePaintArray(A,P,C,M,c,u,d)})}f=!0}}return f}defines(){const t=[];for(const n in this.binders){const r=this.binders[n];(r instanceof mm||r instanceof Ef)&&t.push(...r.uniformNames.map(o=>`#define HAS_UNIFORM_${o}`))}return t}getBinderAttributes(){const t=[];for(const n in this.binders){const r=this.binders[n];if(r instanceof gc||r instanceof Fa||r instanceof gs)for(let o=0;o<r.paintVertexAttributes.length;o++)t.push(r.paintVertexAttributes[o].name)}return t}getBinderUniforms(){const t=[];for(const n in this.binders){const r=this.binders[n];if(r instanceof mm||r instanceof Ef||r instanceof Fa)for(const o of r.uniformNames)t.push(o)}return t}getPaintVertexBuffers(){return this._buffers}getUniforms(t){const n=[];for(const r in this.binders){const o=this.binders[r];if(o instanceof mm||o instanceof Ef||o instanceof Fa)for(const s of o.uniformNames)n.push({name:s,property:r,binding:o.getBinding(t,s)})}return n}setUniforms(t,n,r,o,s){for(const{name:c,property:u,binding:d}of r)this.binders[u].setUniform(t,d,s,o.get(u),c)}updatePaintBuffers(){this._buffers=[];for(const t in this.binders){const n=this.binders[t];(n instanceof gc||n instanceof Fa||n instanceof gs)&&n.paintVertexBuffer&&this._buffers.push(n.paintVertexBuffer)}}upload(t){for(const n in this.binders){const r=this.binders[n];(r instanceof gc||r instanceof Fa||r instanceof gs)&&r.upload(t)}this.updatePaintBuffers()}destroy(){for(const t in this.binders){const n=this.binders[t];(n instanceof gc||n instanceof Fa||n instanceof gs)&&n.destroy()}}}class _c{constructor(t,n,r=(()=>!0)){this.programConfigurations={};for(const o of t)this.programConfigurations[o.id]=new lu(o,n,r);this.needsUpload=!1,this._featureMap=new wf,this._featureMapWithoutIds=new wf,this._bufferOffset=0,this._idlessCounter=0}populatePaintArrays(t,n,r,o,s,c,u,d){for(const f in this.programConfigurations)this.programConfigurations[f].populatePaintArrays(t,n,o,s,c,u,d);void 0!==n.id?this._featureMap.add(n.id,r,this._bufferOffset,t):(this._featureMapWithoutIds.add(this._idlessCounter,r,this._bufferOffset,t),this._idlessCounter+=1),this._bufferOffset=t,this.needsUpload=!0}updatePaintArrays(t,n,r,o,s,c){for(const u of r)this.needsUpload=this.programConfigurations[u.id].updatePaintArrays(t,this._featureMap,this._featureMapWithoutIds,n,u,o,s,c||0)||this.needsUpload}get(t){return this.programConfigurations[t]}upload(t){if(this.needsUpload){for(const n in this.programConfigurations)this.programConfigurations[n].upload(t);this.needsUpload=!1}}destroy(){for(const t in this.programConfigurations)this.programConfigurations[t].destroy()}}const Li={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-emissive-strength":["emissive_strength"],"icon-emissive-strength":["emissive_strength"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"line-gap-width":["gapwidth"],"line-pattern":["pattern","pixel_ratio"],"fill-pattern":["pattern","pixel_ratio"],"fill-extrusion-pattern":["pattern","pixel_ratio"],"line-dasharray":["dash"]};function cM(e,t){return Li[e]||[e.replace(`${t}-`,"").replace(/-/g,"_")]}const Tf={"line-pattern":{source:bo,composite:bo},"fill-pattern":{source:bo,composite:bo},"fill-extrusion-pattern":{source:bo,composite:bo},"line-dasharray":{source:am,composite:am}},uM={color:{source:Il,composite:Fs},number:{source:um,composite:Il}};function _s(e,t,n){const r=Tf[e];return r&&r[n]||uM[t][n]}re(mm,"ConstantBinder"),re(Ef,"PatternConstantBinder"),re(gc,"SourceExpressionBinder"),re(gs,"PatternCompositeBinder"),re(Fa,"CompositeExpressionBinder"),re(lu,"ProgramConfiguration",{omit:["_buffers"]}),re(_c,"ProgramConfigurationSet");class Oi{constructor(t,n){t&&(n?this.setSouthWest(t).setNorthEast(n):4===t.length?this.setSouthWest([t[0],t[1]]).setNorthEast([t[2],t[3]]):this.setSouthWest(t[0]).setNorthEast(t[1]))}setNorthEast(t){return this._ne=t instanceof Se?new Se(t.lng,t.lat):Se.convert(t),this}setSouthWest(t){return this._sw=t instanceof Se?new Se(t.lng,t.lat):Se.convert(t),this}extend(t){const n=this._sw,r=this._ne;let o,s;if(t instanceof Se)o=t,s=t;else{if(!(t instanceof Oi))return Array.isArray(t)?4===t.length||t.every(Array.isArray)?this.extend(Oi.convert(t)):this.extend(Se.convert(t)):"object"==typeof t&&null!==t&&t.hasOwnProperty("lat")&&(t.hasOwnProperty("lon")||t.hasOwnProperty("lng"))?this.extend(Se.convert(t)):this;if(o=t._sw,s=t._ne,!o||!s)return this}return n||r?(n.lng=Math.min(o.lng,n.lng),n.lat=Math.min(o.lat,n.lat),r.lng=Math.max(s.lng,r.lng),r.lat=Math.max(s.lat,r.lat)):(this._sw=new Se(o.lng,o.lat),this._ne=new Se(s.lng,s.lat)),this}getCenter(){return new Se((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new Se(this.getWest(),this.getNorth())}getSouthEast(){return new Se(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(t){const{lng:n,lat:r}=Se.convert(t);let o=this._sw.lng<=n&&n<=this._ne.lng;return this._sw.lng>this._ne.lng&&(o=this._sw.lng>=n&&n>=this._ne.lng),this._sw.lat<=r&&r<=this._ne.lat&&o}static convert(t){return!t||t instanceof Oi?t:new Oi(t)}}var ci={},Jr={};Object.defineProperty(Jr,"__esModule",{value:!0}),Jr.setMatrixArrayType=function(e){Jr.ARRAY_TYPE=Zx=e},Jr.toRadian=function(e){return e*hM},Jr.equals=function(e,t){return Math.abs(e-t)<=Lh*Math.max(1,Math.abs(e),Math.abs(t))},Jr.RANDOM=Jr.ARRAY_TYPE=Jr.EPSILON=void 0;var Lh=1e-6;Jr.EPSILON=Lh;var Zx=typeof Float32Array<"u"?Float32Array:Array;Jr.ARRAY_TYPE=Zx;var vC=Math.random;Jr.RANDOM=vC;var hM=Math.PI/180;Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)});var _r={};function wo(e){return(wo="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(e)}Object.defineProperty(_r,"__esModule",{value:!0}),_r.create=function(){var e=new Na.ARRAY_TYPE(4);return Na.ARRAY_TYPE!=Float32Array&&(e[1]=0,e[2]=0),e[0]=1,e[3]=1,e},_r.clone=function(e){var t=new Na.ARRAY_TYPE(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},_r.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},_r.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e},_r.fromValues=function(e,t,n,r){var o=new Na.ARRAY_TYPE(4);return o[0]=e,o[1]=t,o[2]=n,o[3]=r,o},_r.set=function(e,t,n,r,o){return e[0]=t,e[1]=n,e[2]=r,e[3]=o,e},_r.transpose=function(e,t){if(e===t){var n=t[1];e[1]=t[2],e[2]=n}else e[0]=t[0],e[1]=t[2],e[2]=t[1],e[3]=t[3];return e},_r.invert=function(e,t){var n=t[0],r=t[1],o=t[2],s=t[3],c=n*s-o*r;return c?(e[0]=s*(c=1/c),e[1]=-r*c,e[2]=-o*c,e[3]=n*c,e):null},_r.adjoint=function(e,t){var n=t[0];return e[0]=t[3],e[1]=-t[1],e[2]=-t[2],e[3]=n,e},_r.determinant=function(e){return e[0]*e[3]-e[2]*e[1]},_r.multiply=dM,_r.rotate=function(e,t,n){var r=t[0],o=t[1],s=t[2],c=t[3],u=Math.sin(n),d=Math.cos(n);return e[0]=r*d+s*u,e[1]=o*d+c*u,e[2]=r*-u+s*d,e[3]=o*-u+c*d,e},_r.scale=function(e,t,n){var r=t[1],o=t[2],s=t[3],c=n[0],u=n[1];return e[0]=t[0]*c,e[1]=r*c,e[2]=o*u,e[3]=s*u,e},_r.fromRotation=function(e,t){var n=Math.sin(t),r=Math.cos(t);return e[0]=r,e[1]=n,e[2]=-n,e[3]=r,e},_r.fromScaling=function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=t[1],e},_r.str=function(e){return"mat2("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},_r.frob=function(e){return Math.hypot(e[0],e[1],e[2],e[3])},_r.LDU=function(e,t,n,r){return e[2]=r[2]/r[0],n[0]=r[0],n[1]=r[1],n[3]=r[3]-e[2]*n[1],[e,t,n]},_r.add=function(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e[2]=t[2]+n[2],e[3]=t[3]+n[3],e},_r.subtract=B_,_r.exactEquals=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]},_r.equals=function(e,t){var n=e[0],r=e[1],o=e[2],s=e[3],c=t[0],u=t[1],d=t[2],f=t[3];return Math.abs(n-c)<=Na.EPSILON*Math.max(1,Math.abs(n),Math.abs(c))&&Math.abs(r-u)<=Na.EPSILON*Math.max(1,Math.abs(r),Math.abs(u))&&Math.abs(o-d)<=Na.EPSILON*Math.max(1,Math.abs(o),Math.abs(d))&&Math.abs(s-f)<=Na.EPSILON*Math.max(1,Math.abs(s),Math.abs(f))},_r.multiplyScalar=function(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e[3]=t[3]*n,e},_r.multiplyScalarAndAdd=function(e,t,n,r){return e[0]=t[0]+n[0]*r,e[1]=t[1]+n[1]*r,e[2]=t[2]+n[2]*r,e[3]=t[3]+n[3]*r,e},_r.sub=_r.mul=void 0;var Na=function(e,t){if(e&&e.__esModule)return e;if(null===e||"object"!==wo(e)&&"function"!=typeof e)return{default:e};var n=cu(void 0);if(n&&n.has(e))return n.get(e);var r={},o=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if("default"!==s&&Object.prototype.hasOwnProperty.call(e,s)){var c=o?Object.getOwnPropertyDescriptor(e,s):null;c&&(c.get||c.set)?Object.defineProperty(r,s,c):r[s]=e[s]}return r.default=e,n&&n.set(e,r),r}(Jr);function cu(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(cu=function(r){return r?n:t})(e)}function dM(e,t,n){var r=t[0],o=t[1],s=t[2],c=t[3],u=n[0],d=n[1],f=n[2],m=n[3];return e[0]=r*u+s*d,e[1]=o*u+c*d,e[2]=r*f+s*m,e[3]=o*f+c*m,e}function B_(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2],e[3]=t[3]-n[3],e}_r.mul=dM,_r.sub=B_;var yr={};function j_(e){return(j_="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(e)}Object.defineProperty(yr,"__esModule",{value:!0}),yr.create=function(){var e=new za.ARRAY_TYPE(6);return za.ARRAY_TYPE!=Float32Array&&(e[1]=0,e[2]=0,e[4]=0,e[5]=0),e[0]=1,e[3]=1,e},yr.clone=function(e){var t=new za.ARRAY_TYPE(6);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t},yr.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e},yr.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e[4]=0,e[5]=0,e},yr.fromValues=function(e,t,n,r,o,s){var c=new za.ARRAY_TYPE(6);return c[0]=e,c[1]=t,c[2]=n,c[3]=r,c[4]=o,c[5]=s,c},yr.set=function(e,t,n,r,o,s,c){return e[0]=t,e[1]=n,e[2]=r,e[3]=o,e[4]=s,e[5]=c,e},yr.invert=function(e,t){var n=t[0],r=t[1],o=t[2],s=t[3],c=t[4],u=t[5],d=n*s-r*o;return d?(e[0]=s*(d=1/d),e[1]=-r*d,e[2]=-o*d,e[3]=n*d,e[4]=(o*u-s*c)*d,e[5]=(r*c-n*u)*d,e):null},yr.determinant=function(e){return e[0]*e[3]-e[1]*e[2]},yr.multiply=Xx,yr.rotate=function(e,t,n){var r=t[0],o=t[1],s=t[2],c=t[3],u=t[4],d=t[5],f=Math.sin(n),m=Math.cos(n);return e[0]=r*m+s*f,e[1]=o*m+c*f,e[2]=r*-f+s*m,e[3]=o*-f+c*m,e[4]=u,e[5]=d,e},yr.scale=function(e,t,n){var r=t[1],o=t[2],s=t[3],c=t[4],u=t[5],d=n[0],f=n[1];return e[0]=t[0]*d,e[1]=r*d,e[2]=o*f,e[3]=s*f,e[4]=c,e[5]=u,e},yr.translate=function(e,t,n){var r=t[0],o=t[1],s=t[2],c=t[3],u=t[4],d=t[5],f=n[0],m=n[1];return e[0]=r,e[1]=o,e[2]=s,e[3]=c,e[4]=r*f+s*m+u,e[5]=o*f+c*m+d,e},yr.fromRotation=function(e,t){var n=Math.sin(t),r=Math.cos(t);return e[0]=r,e[1]=n,e[2]=-n,e[3]=r,e[4]=0,e[5]=0,e},yr.fromScaling=function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=t[1],e[4]=0,e[5]=0,e},yr.fromTranslation=function(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e[4]=t[0],e[5]=t[1],e},yr.str=function(e){return"mat2d("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+")"},yr.frob=function(e){return Math.hypot(e[0],e[1],e[2],e[3],e[4],e[5],1)},yr.add=function(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e[2]=t[2]+n[2],e[3]=t[3]+n[3],e[4]=t[4]+n[4],e[5]=t[5]+n[5],e},yr.subtract=Yx,yr.multiplyScalar=function(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e[3]=t[3]*n,e[4]=t[4]*n,e[5]=t[5]*n,e},yr.multiplyScalarAndAdd=function(e,t,n,r){return e[0]=t[0]+n[0]*r,e[1]=t[1]+n[1]*r,e[2]=t[2]+n[2]*r,e[3]=t[3]+n[3]*r,e[4]=t[4]+n[4]*r,e[5]=t[5]+n[5]*r,e},yr.exactEquals=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]},yr.equals=function(e,t){var n=e[0],r=e[1],o=e[2],s=e[3],c=e[4],u=e[5],d=t[0],f=t[1],m=t[2],g=t[3],y=t[4],v=t[5];return Math.abs(n-d)<=za.EPSILON*Math.max(1,Math.abs(n),Math.abs(d))&&Math.abs(r-f)<=za.EPSILON*Math.max(1,Math.abs(r),Math.abs(f))&&Math.abs(o-m)<=za.EPSILON*Math.max(1,Math.abs(o),Math.abs(m))&&Math.abs(s-g)<=za.EPSILON*Math.max(1,Math.abs(s),Math.abs(g))&&Math.abs(c-y)<=za.EPSILON*Math.max(1,Math.abs(c),Math.abs(y))&&Math.abs(u-v)<=za.EPSILON*Math.max(1,Math.abs(u),Math.abs(v))},yr.sub=yr.mul=void 0;var za=function(e,t){if(e&&e.__esModule)return e;if(null===e||"object"!==j_(e)&&"function"!=typeof e)return{default:e};var n=Wx(void 0);if(n&&n.has(e))return n.get(e);var r={},o=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if("default"!==s&&Object.prototype.hasOwnProperty.call(e,s)){var c=o?Object.getOwnPropertyDescriptor(e,s):null;c&&(c.get||c.set)?Object.defineProperty(r,s,c):r[s]=e[s]}return r.default=e,n&&n.set(e,r),r}(Jr);function Wx(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(Wx=function(r){return r?n:t})(e)}function Xx(e,t,n){var r=t[0],o=t[1],s=t[2],c=t[3],u=t[4],d=t[5],f=n[0],m=n[1],g=n[2],y=n[3],v=n[4],x=n[5];return e[0]=r*f+s*m,e[1]=o*f+c*m,e[2]=r*g+s*y,e[3]=o*g+c*y,e[4]=r*v+s*x+u,e[5]=o*v+c*x+d,e}function Yx(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2],e[3]=t[3]-n[3],e[4]=t[4]-n[4],e[5]=t[5]-n[5],e}yr.mul=Xx,yr.sub=Yx;var kn={};function Oh(e){return(Oh="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(e)}Object.defineProperty(kn,"__esModule",{value:!0}),kn.create=function(){var e=new ys.ARRAY_TYPE(9);return ys.ARRAY_TYPE!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[5]=0,e[6]=0,e[7]=0),e[0]=1,e[4]=1,e[8]=1,e},kn.fromMat4=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10],e},kn.clone=function(e){var t=new ys.ARRAY_TYPE(9);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},kn.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},kn.fromValues=function(e,t,n,r,o,s,c,u,d){var f=new ys.ARRAY_TYPE(9);return f[0]=e,f[1]=t,f[2]=n,f[3]=r,f[4]=o,f[5]=s,f[6]=c,f[7]=u,f[8]=d,f},kn.set=function(e,t,n,r,o,s,c,u,d,f){return e[0]=t,e[1]=n,e[2]=r,e[3]=o,e[4]=s,e[5]=c,e[6]=u,e[7]=d,e[8]=f,e},kn.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},kn.transpose=function(e,t){if(e===t){var n=t[1],r=t[2],o=t[5];e[1]=t[3],e[2]=t[6],e[3]=n,e[5]=t[7],e[6]=r,e[7]=o}else e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8];return e},kn.invert=function(e,t){var n=t[0],r=t[1],o=t[2],s=t[3],c=t[4],u=t[5],d=t[6],f=t[7],m=t[8],g=m*c-u*f,y=-m*s+u*d,v=f*s-c*d,x=n*g+r*y+o*v;return x?(e[0]=g*(x=1/x),e[1]=(-m*r+o*f)*x,e[2]=(u*r-o*c)*x,e[3]=y*x,e[4]=(m*n-o*d)*x,e[5]=(-u*n+o*s)*x,e[6]=v*x,e[7]=(-f*n+r*d)*x,e[8]=(c*n-r*s)*x,e):null},kn.adjoint=function(e,t){var n=t[0],r=t[1],o=t[2],s=t[3],c=t[4],u=t[5],d=t[6],f=t[7],m=t[8];return e[0]=c*m-u*f,e[1]=o*f-r*m,e[2]=r*u-o*c,e[3]=u*d-s*m,e[4]=n*m-o*d,e[5]=o*s-n*u,e[6]=s*f-c*d,e[7]=r*d-n*f,e[8]=n*c-r*s,e},kn.determinant=function(e){var t=e[3],n=e[4],r=e[5],o=e[6],s=e[7],c=e[8];return e[0]*(c*n-r*s)+e[1]*(-c*t+r*o)+e[2]*(s*t-n*o)},kn.multiply=Kx,kn.translate=function(e,t,n){var r=t[0],o=t[1],s=t[2],c=t[3],u=t[4],d=t[5],f=t[6],m=t[7],g=t[8],y=n[0],v=n[1];return e[0]=r,e[1]=o,e[2]=s,e[3]=c,e[4]=u,e[5]=d,e[6]=y*r+v*c+f,e[7]=y*o+v*u+m,e[8]=y*s+v*d+g,e},kn.rotate=function(e,t,n){var r=t[0],o=t[1],s=t[2],c=t[3],u=t[4],d=t[5],f=t[6],m=t[7],g=t[8],y=Math.sin(n),v=Math.cos(n);return e[0]=v*r+y*c,e[1]=v*o+y*u,e[2]=v*s+y*d,e[3]=v*c-y*r,e[4]=v*u-y*o,e[5]=v*d-y*s,e[6]=f,e[7]=m,e[8]=g,e},kn.scale=function(e,t,n){var r=n[0],o=n[1];return e[0]=r*t[0],e[1]=r*t[1],e[2]=r*t[2],e[3]=o*t[3],e[4]=o*t[4],e[5]=o*t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},kn.fromTranslation=function(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=t[0],e[7]=t[1],e[8]=1,e},kn.fromRotation=function(e,t){var n=Math.sin(t),r=Math.cos(t);return e[0]=r,e[1]=n,e[2]=0,e[3]=-n,e[4]=r,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},kn.fromScaling=function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=t[1],e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},kn.fromMat2d=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=0,e[3]=t[2],e[4]=t[3],e[5]=0,e[6]=t[4],e[7]=t[5],e[8]=1,e},kn.fromQuat=function(e,t){var n=t[0],r=t[1],o=t[2],s=t[3],c=n+n,u=r+r,d=o+o,f=n*c,m=r*c,g=r*u,y=o*c,v=o*u,x=o*d,w=s*c,E=s*u,M=s*d;return e[0]=1-g-x,e[3]=m-M,e[6]=y+E,e[1]=m+M,e[4]=1-f-x,e[7]=v-w,e[2]=y-E,e[5]=v+w,e[8]=1-f-g,e},kn.normalFromMat4=function(e,t){var n=t[0],r=t[1],o=t[2],s=t[3],c=t[4],u=t[5],d=t[6],f=t[7],m=t[8],g=t[9],y=t[10],v=t[11],x=t[12],w=t[13],E=t[14],M=t[15],D=n*u-r*c,A=n*d-o*c,P=n*f-s*c,C=r*d-o*u,R=r*f-s*u,k=o*f-s*d,N=m*w-g*x,z=m*E-y*x,B=m*M-v*x,U=g*E-y*w,$=g*M-v*w,W=y*M-v*E,V=D*W-A*$+P*U+C*B-R*z+k*N;return V?(e[0]=(u*W-d*$+f*U)*(V=1/V),e[1]=(d*B-c*W-f*z)*V,e[2]=(c*$-u*B+f*N)*V,e[3]=(o*$-r*W-s*U)*V,e[4]=(n*W-o*B+s*z)*V,e[5]=(r*B-n*$-s*N)*V,e[6]=(w*k-E*R+M*C)*V,e[7]=(E*P-x*k-M*A)*V,e[8]=(x*R-w*P+M*D)*V,e):null},kn.projection=function(e,t,n){return e[0]=2/t,e[1]=0,e[2]=0,e[3]=0,e[4]=-2/n,e[5]=0,e[6]=-1,e[7]=1,e[8]=1,e},kn.str=function(e){return"mat3("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+")"},kn.frob=function(e){return Math.hypot(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8])},kn.add=function(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e[2]=t[2]+n[2],e[3]=t[3]+n[3],e[4]=t[4]+n[4],e[5]=t[5]+n[5],e[6]=t[6]+n[6],e[7]=t[7]+n[7],e[8]=t[8]+n[8],e},kn.subtract=_m,kn.multiplyScalar=function(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e[3]=t[3]*n,e[4]=t[4]*n,e[5]=t[5]*n,e[6]=t[6]*n,e[7]=t[7]*n,e[8]=t[8]*n,e},kn.multiplyScalarAndAdd=function(e,t,n,r){return e[0]=t[0]+n[0]*r,e[1]=t[1]+n[1]*r,e[2]=t[2]+n[2]*r,e[3]=t[3]+n[3]*r,e[4]=t[4]+n[4]*r,e[5]=t[5]+n[5]*r,e[6]=t[6]+n[6]*r,e[7]=t[7]+n[7]*r,e[8]=t[8]+n[8]*r,e},kn.exactEquals=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]&&e[8]===t[8]},kn.equals=function(e,t){var n=e[0],r=e[1],o=e[2],s=e[3],c=e[4],u=e[5],d=e[6],f=e[7],m=e[8],g=t[0],y=t[1],v=t[2],x=t[3],w=t[4],E=t[5],M=t[6],D=t[7],A=t[8];return Math.abs(n-g)<=ys.EPSILON*Math.max(1,Math.abs(n),Math.abs(g))&&Math.abs(r-y)<=ys.EPSILON*Math.max(1,Math.abs(r),Math.abs(y))&&Math.abs(o-v)<=ys.EPSILON*Math.max(1,Math.abs(o),Math.abs(v))&&Math.abs(s-x)<=ys.EPSILON*Math.max(1,Math.abs(s),Math.abs(x))&&Math.abs(c-w)<=ys.EPSILON*Math.max(1,Math.abs(c),Math.abs(w))&&Math.abs(u-E)<=ys.EPSILON*Math.max(1,Math.abs(u),Math.abs(E))&&Math.abs(d-M)<=ys.EPSILON*Math.max(1,Math.abs(d),Math.abs(M))&&Math.abs(f-D)<=ys.EPSILON*Math.max(1,Math.abs(f),Math.abs(D))&&Math.abs(m-A)<=ys.EPSILON*Math.max(1,Math.abs(m),Math.abs(A))},kn.sub=kn.mul=void 0;var ys=function(e,t){if(e&&e.__esModule)return e;if(null===e||"object"!==Oh(e)&&"function"!=typeof e)return{default:e};var n=gm(void 0);if(n&&n.has(e))return n.get(e);var r={},o=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if("default"!==s&&Object.prototype.hasOwnProperty.call(e,s)){var c=o?Object.getOwnPropertyDescriptor(e,s):null;c&&(c.get||c.set)?Object.defineProperty(r,s,c):r[s]=e[s]}return r.default=e,n&&n.set(e,r),r}(Jr);function gm(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(gm=function(r){return r?n:t})(e)}function Kx(e,t,n){var r=t[0],o=t[1],s=t[2],c=t[3],u=t[4],d=t[5],f=t[6],m=t[7],g=t[8],y=n[0],v=n[1],x=n[2],w=n[3],E=n[4],M=n[5],D=n[6],A=n[7],P=n[8];return e[0]=y*r+v*c+x*f,e[1]=y*o+v*u+x*m,e[2]=y*s+v*d+x*g,e[3]=w*r+E*c+M*f,e[4]=w*o+E*u+M*m,e[5]=w*s+E*d+M*g,e[6]=D*r+A*c+P*f,e[7]=D*o+A*u+P*m,e[8]=D*s+A*d+P*g,e}function _m(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2],e[3]=t[3]-n[3],e[4]=t[4]-n[4],e[5]=t[5]-n[5],e[6]=t[6]-n[6],e[7]=t[7]-n[7],e[8]=t[8]-n[8],e}kn.mul=Kx,kn.sub=_m;var ze={};function ym(e){return(ym="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(e)}Object.defineProperty(ze,"__esModule",{value:!0}),ze.create=function(){var e=new vr.ARRAY_TYPE(16);return vr.ARRAY_TYPE!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e},ze.clone=function(e){var t=new vr.ARRAY_TYPE(16);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},ze.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},ze.fromValues=function(e,t,n,r,o,s,c,u,d,f,m,g,y,v,x,w){var E=new vr.ARRAY_TYPE(16);return E[0]=e,E[1]=t,E[2]=n,E[3]=r,E[4]=o,E[5]=s,E[6]=c,E[7]=u,E[8]=d,E[9]=f,E[10]=m,E[11]=g,E[12]=y,E[13]=v,E[14]=x,E[15]=w,E},ze.set=function(e,t,n,r,o,s,c,u,d,f,m,g,y,v,x,w,E){return e[0]=t,e[1]=n,e[2]=r,e[3]=o,e[4]=s,e[5]=c,e[6]=u,e[7]=d,e[8]=f,e[9]=m,e[10]=g,e[11]=y,e[12]=v,e[13]=x,e[14]=w,e[15]=E,e},ze.identity=V_,ze.transpose=function(e,t){if(e===t){var n=t[1],r=t[2],o=t[3],s=t[6],c=t[7],u=t[11];e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=n,e[6]=t[9],e[7]=t[13],e[8]=r,e[9]=s,e[11]=t[14],e[12]=o,e[13]=c,e[14]=u}else e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15];return e},ze.invert=function(e,t){var n=t[0],r=t[1],o=t[2],s=t[3],c=t[4],u=t[5],d=t[6],f=t[7],m=t[8],g=t[9],y=t[10],v=t[11],x=t[12],w=t[13],E=t[14],M=t[15],D=n*u-r*c,A=n*d-o*c,P=n*f-s*c,C=r*d-o*u,R=r*f-s*u,k=o*f-s*d,N=m*w-g*x,z=m*E-y*x,B=m*M-v*x,U=g*E-y*w,$=g*M-v*w,W=y*M-v*E,V=D*W-A*$+P*U+C*B-R*z+k*N;return V?(e[0]=(u*W-d*$+f*U)*(V=1/V),e[1]=(o*$-r*W-s*U)*V,e[2]=(w*k-E*R+M*C)*V,e[3]=(y*R-g*k-v*C)*V,e[4]=(d*B-c*W-f*z)*V,e[5]=(n*W-o*B+s*z)*V,e[6]=(E*P-x*k-M*A)*V,e[7]=(m*k-y*P+v*A)*V,e[8]=(c*$-u*B+f*N)*V,e[9]=(r*B-n*$-s*N)*V,e[10]=(x*R-w*P+M*D)*V,e[11]=(g*P-m*R-v*D)*V,e[12]=(u*z-c*U-d*N)*V,e[13]=(n*U-r*z+o*N)*V,e[14]=(w*A-x*C-E*D)*V,e[15]=(m*C-g*A+y*D)*V,e):null},ze.adjoint=function(e,t){var n=t[0],r=t[1],o=t[2],s=t[3],c=t[4],u=t[5],d=t[6],f=t[7],m=t[8],g=t[9],y=t[10],v=t[11],x=t[12],w=t[13],E=t[14],M=t[15];return e[0]=u*(y*M-v*E)-g*(d*M-f*E)+w*(d*v-f*y),e[1]=-(r*(y*M-v*E)-g*(o*M-s*E)+w*(o*v-s*y)),e[2]=r*(d*M-f*E)-u*(o*M-s*E)+w*(o*f-s*d),e[3]=-(r*(d*v-f*y)-u*(o*v-s*y)+g*(o*f-s*d)),e[4]=-(c*(y*M-v*E)-m*(d*M-f*E)+x*(d*v-f*y)),e[5]=n*(y*M-v*E)-m*(o*M-s*E)+x*(o*v-s*y),e[6]=-(n*(d*M-f*E)-c*(o*M-s*E)+x*(o*f-s*d)),e[7]=n*(d*v-f*y)-c*(o*v-s*y)+m*(o*f-s*d),e[8]=c*(g*M-v*w)-m*(u*M-f*w)+x*(u*v-f*g),e[9]=-(n*(g*M-v*w)-m*(r*M-s*w)+x*(r*v-s*g)),e[10]=n*(u*M-f*w)-c*(r*M-s*w)+x*(r*f-s*u),e[11]=-(n*(u*v-f*g)-c*(r*v-s*g)+m*(r*f-s*u)),e[12]=-(c*(g*E-y*w)-m*(u*E-d*w)+x*(u*y-d*g)),e[13]=n*(g*E-y*w)-m*(r*E-o*w)+x*(r*y-o*g),e[14]=-(n*(u*E-d*w)-c*(r*E-o*w)+x*(r*d-o*u)),e[15]=n*(u*y-d*g)-c*(r*y-o*g)+m*(r*d-o*u),e},ze.determinant=function(e){var t=e[0],n=e[1],r=e[2],o=e[3],s=e[4],c=e[5],u=e[6],d=e[7],f=e[8],m=e[9],g=e[10],y=e[11],v=e[12],x=e[13],w=e[14],E=e[15];return(t*c-n*s)*(g*E-y*w)-(t*u-r*s)*(m*E-y*x)+(t*d-o*s)*(m*w-g*x)+(n*u-r*c)*(f*E-y*v)-(n*d-o*c)*(f*w-g*v)+(r*d-o*u)*(f*x-m*v)},ze.multiply=Jx,ze.translate=function(e,t,n){var r,o,s,c,u,d,f,m,g,y,v,x,w=n[0],E=n[1],M=n[2];return t===e?(e[12]=t[0]*w+t[4]*E+t[8]*M+t[12],e[13]=t[1]*w+t[5]*E+t[9]*M+t[13],e[14]=t[2]*w+t[6]*E+t[10]*M+t[14],e[15]=t[3]*w+t[7]*E+t[11]*M+t[15]):(o=t[1],s=t[2],c=t[3],u=t[4],d=t[5],f=t[6],m=t[7],g=t[8],y=t[9],v=t[10],x=t[11],e[0]=r=t[0],e[1]=o,e[2]=s,e[3]=c,e[4]=u,e[5]=d,e[6]=f,e[7]=m,e[8]=g,e[9]=y,e[10]=v,e[11]=x,e[12]=r*w+u*E+g*M+t[12],e[13]=o*w+d*E+y*M+t[13],e[14]=s*w+f*E+v*M+t[14],e[15]=c*w+m*E+x*M+t[15]),e},ze.scale=function(e,t,n){var r=n[0],o=n[1],s=n[2];return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e[4]=t[4]*o,e[5]=t[5]*o,e[6]=t[6]*o,e[7]=t[7]*o,e[8]=t[8]*s,e[9]=t[9]*s,e[10]=t[10]*s,e[11]=t[11]*s,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},ze.rotate=function(e,t,n,r){var o,s,c,u,d,f,m,g,y,v,x,w,E,M,D,A,P,C,R,k,N,z,B,U,$=r[0],W=r[1],V=r[2],K=Math.hypot($,W,V);return K<vr.EPSILON?null:($*=K=1/K,W*=K,V*=K,o=Math.sin(n),s=Math.cos(n),d=t[1],f=t[2],m=t[3],y=t[5],v=t[6],x=t[7],E=t[9],M=t[10],D=t[11],R=$*W*(c=1-s)-V*o,k=W*W*c+s,N=V*W*c+$*o,z=$*V*c+W*o,B=W*V*c-$*o,U=V*V*c+s,e[0]=(u=t[0])*(A=$*$*c+s)+(g=t[4])*(P=W*$*c+V*o)+(w=t[8])*(C=V*$*c-W*o),e[1]=d*A+y*P+E*C,e[2]=f*A+v*P+M*C,e[3]=m*A+x*P+D*C,e[4]=u*R+g*k+w*N,e[5]=d*R+y*k+E*N,e[6]=f*R+v*k+M*N,e[7]=m*R+x*k+D*N,e[8]=u*z+g*B+w*U,e[9]=d*z+y*B+E*U,e[10]=f*z+v*B+M*U,e[11]=m*z+x*B+D*U,t!==e&&(e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e)},ze.rotateX=function(e,t,n){var r=Math.sin(n),o=Math.cos(n),s=t[4],c=t[5],u=t[6],d=t[7],f=t[8],m=t[9],g=t[10],y=t[11];return t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=s*o+f*r,e[5]=c*o+m*r,e[6]=u*o+g*r,e[7]=d*o+y*r,e[8]=f*o-s*r,e[9]=m*o-c*r,e[10]=g*o-u*r,e[11]=y*o-d*r,e},ze.rotateY=function(e,t,n){var r=Math.sin(n),o=Math.cos(n),s=t[0],c=t[1],u=t[2],d=t[3],f=t[8],m=t[9],g=t[10],y=t[11];return t!==e&&(e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=s*o-f*r,e[1]=c*o-m*r,e[2]=u*o-g*r,e[3]=d*o-y*r,e[8]=s*r+f*o,e[9]=c*r+m*o,e[10]=u*r+g*o,e[11]=d*r+y*o,e},ze.rotateZ=function(e,t,n){var r=Math.sin(n),o=Math.cos(n),s=t[0],c=t[1],u=t[2],d=t[3],f=t[4],m=t[5],g=t[6],y=t[7];return t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=s*o+f*r,e[1]=c*o+m*r,e[2]=u*o+g*r,e[3]=d*o+y*r,e[4]=f*o-s*r,e[5]=m*o-c*r,e[6]=g*o-u*r,e[7]=y*o-d*r,e},ze.fromTranslation=function(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1,e},ze.fromScaling=function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t[1],e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t[2],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},ze.fromRotation=function(e,t,n){var r,o,s,c=n[0],u=n[1],d=n[2],f=Math.hypot(c,u,d);return f<vr.EPSILON?null:(c*=f=1/f,u*=f,d*=f,r=Math.sin(t),o=Math.cos(t),e[0]=c*c*(s=1-o)+o,e[1]=u*c*s+d*r,e[2]=d*c*s-u*r,e[3]=0,e[4]=c*u*s-d*r,e[5]=u*u*s+o,e[6]=d*u*s+c*r,e[7]=0,e[8]=c*d*s+u*r,e[9]=u*d*s-c*r,e[10]=d*d*s+o,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e)},ze.fromXRotation=function(e,t){var n=Math.sin(t),r=Math.cos(t);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=r,e[6]=n,e[7]=0,e[8]=0,e[9]=-n,e[10]=r,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},ze.fromYRotation=function(e,t){var n=Math.sin(t),r=Math.cos(t);return e[0]=r,e[1]=0,e[2]=-n,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=n,e[9]=0,e[10]=r,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},ze.fromZRotation=function(e,t){var n=Math.sin(t),r=Math.cos(t);return e[0]=r,e[1]=n,e[2]=0,e[3]=0,e[4]=-n,e[5]=r,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},ze.fromRotationTranslation=Qx,ze.fromQuat2=function(e,t){var n=new vr.ARRAY_TYPE(3),r=-t[0],o=-t[1],s=-t[2],c=t[3],u=t[4],d=t[5],f=t[6],m=t[7],g=r*r+o*o+s*s+c*c;return g>0?(n[0]=2*(u*c+m*r+d*s-f*o)/g,n[1]=2*(d*c+m*o+f*r-u*s)/g,n[2]=2*(f*c+m*s+u*o-d*r)/g):(n[0]=2*(u*c+m*r+d*s-f*o),n[1]=2*(d*c+m*o+f*r-u*s),n[2]=2*(f*c+m*s+u*o-d*r)),Qx(e,t,n),e},ze.getTranslation=function(e,t){return e[0]=t[12],e[1]=t[13],e[2]=t[14],e},ze.getScaling=uu,ze.getRotation=function(e,t){var n=new vr.ARRAY_TYPE(3);uu(n,t);var r=1/n[0],o=1/n[1],s=1/n[2],c=t[0]*r,u=t[1]*o,d=t[2]*s,f=t[4]*r,m=t[5]*o,g=t[6]*s,y=t[8]*r,v=t[9]*o,x=t[10]*s,w=c+m+x,E=0;return w>0?(E=2*Math.sqrt(w+1),e[3]=.25*E,e[0]=(g-v)/E,e[1]=(y-d)/E,e[2]=(u-f)/E):c>m&&c>x?(E=2*Math.sqrt(1+c-m-x),e[3]=(g-v)/E,e[0]=.25*E,e[1]=(u+f)/E,e[2]=(y+d)/E):m>x?(E=2*Math.sqrt(1+m-c-x),e[3]=(y-d)/E,e[0]=(u+f)/E,e[1]=.25*E,e[2]=(g+v)/E):(E=2*Math.sqrt(1+x-c-m),e[3]=(u-f)/E,e[0]=(y+d)/E,e[1]=(g+v)/E,e[2]=.25*E),e},ze.fromRotationTranslationScale=function(e,t,n,r){var o=t[0],s=t[1],c=t[2],u=t[3],d=o+o,f=s+s,m=c+c,g=o*d,y=o*f,v=o*m,x=s*f,w=s*m,E=c*m,M=u*d,D=u*f,A=u*m,P=r[0],C=r[1],R=r[2];return e[0]=(1-(x+E))*P,e[1]=(y+A)*P,e[2]=(v-D)*P,e[3]=0,e[4]=(y-A)*C,e[5]=(1-(g+E))*C,e[6]=(w+M)*C,e[7]=0,e[8]=(v+D)*R,e[9]=(w-M)*R,e[10]=(1-(g+x))*R,e[11]=0,e[12]=n[0],e[13]=n[1],e[14]=n[2],e[15]=1,e},ze.fromRotationTranslationScaleOrigin=function(e,t,n,r,o){var s=t[0],c=t[1],u=t[2],d=t[3],f=s+s,m=c+c,g=u+u,y=s*f,v=s*m,x=s*g,w=c*m,E=c*g,M=u*g,D=d*f,A=d*m,P=d*g,C=r[0],R=r[1],k=r[2],N=o[0],z=o[1],B=o[2],U=(1-(w+M))*C,$=(v+P)*C,W=(x-A)*C,V=(v-P)*R,K=(1-(y+M))*R,Q=(E+D)*R,ot=(x+A)*k,Y=(E-D)*k,J=(1-(y+w))*k;return e[0]=U,e[1]=$,e[2]=W,e[3]=0,e[4]=V,e[5]=K,e[6]=Q,e[7]=0,e[8]=ot,e[9]=Y,e[10]=J,e[11]=0,e[12]=n[0]+N-(U*N+V*z+ot*B),e[13]=n[1]+z-($*N+K*z+Y*B),e[14]=n[2]+B-(W*N+Q*z+J*B),e[15]=1,e},ze.fromQuat=function(e,t){var n=t[0],r=t[1],o=t[2],s=t[3],c=n+n,u=r+r,d=o+o,f=n*c,m=r*c,g=r*u,y=o*c,v=o*u,x=o*d,w=s*c,E=s*u,M=s*d;return e[0]=1-g-x,e[1]=m+M,e[2]=y-E,e[3]=0,e[4]=m-M,e[5]=1-f-x,e[6]=v+w,e[7]=0,e[8]=y+E,e[9]=v-w,e[10]=1-f-g,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},ze.frustum=function(e,t,n,r,o,s,c){var u=1/(n-t),d=1/(o-r),f=1/(s-c);return e[0]=2*s*u,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=2*s*d,e[6]=0,e[7]=0,e[8]=(n+t)*u,e[9]=(o+r)*d,e[10]=(c+s)*f,e[11]=-1,e[12]=0,e[13]=0,e[14]=c*s*2*f,e[15]=0,e},ze.perspectiveNO=kh,ze.perspectiveZO=function(e,t,n,r,o){var s,c=1/Math.tan(t/2);return e[0]=c/n,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=c,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=o&&o!==1/0?(e[10]=o*(s=1/(r-o)),e[14]=o*r*s):(e[10]=-1,e[14]=-r),e},ze.perspectiveFromFieldOfView=function(e,t,n,r){var o=Math.tan(t.upDegrees*Math.PI/180),s=Math.tan(t.downDegrees*Math.PI/180),c=Math.tan(t.leftDegrees*Math.PI/180),u=Math.tan(t.rightDegrees*Math.PI/180),d=2/(c+u),f=2/(o+s);return e[0]=d,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=f,e[6]=0,e[7]=0,e[8]=-(c-u)*d*.5,e[9]=(o-s)*f*.5,e[10]=r/(n-r),e[11]=-1,e[12]=0,e[13]=0,e[14]=r*n/(n-r),e[15]=0,e},ze.orthoNO=t1,ze.orthoZO=function(e,t,n,r,o,s,c){var u=1/(t-n),d=1/(r-o),f=1/(s-c);return e[0]=-2*u,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*d,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=f,e[11]=0,e[12]=(t+n)*u,e[13]=(o+r)*d,e[14]=s*f,e[15]=1,e},ze.lookAt=function(e,t,n,r){var o,s,c,u,d,f,m,g,y,v,x=t[0],w=t[1],E=t[2],M=r[0],D=r[1],A=r[2],P=n[0],C=n[1],R=n[2];return Math.abs(x-P)<vr.EPSILON&&Math.abs(w-C)<vr.EPSILON&&Math.abs(E-R)<vr.EPSILON?V_(e):(m=x-P,g=w-C,y=E-R,o=D*(y*=v=1/Math.hypot(m,g,y))-A*(g*=v),s=A*(m*=v)-M*y,c=M*g-D*m,(v=Math.hypot(o,s,c))?(o*=v=1/v,s*=v,c*=v):(o=0,s=0,c=0),u=g*c-y*s,d=y*o-m*c,f=m*s-g*o,(v=Math.hypot(u,d,f))?(u*=v=1/v,d*=v,f*=v):(u=0,d=0,f=0),e[0]=o,e[1]=u,e[2]=m,e[3]=0,e[4]=s,e[5]=d,e[6]=g,e[7]=0,e[8]=c,e[9]=f,e[10]=y,e[11]=0,e[12]=-(o*x+s*w+c*E),e[13]=-(u*x+d*w+f*E),e[14]=-(m*x+g*w+y*E),e[15]=1,e)},ze.targetTo=function(e,t,n,r){var o=t[0],s=t[1],c=t[2],u=r[0],d=r[1],f=r[2],m=o-n[0],g=s-n[1],y=c-n[2],v=m*m+g*g+y*y;v>0&&(m*=v=1/Math.sqrt(v),g*=v,y*=v);var x=d*y-f*g,w=f*m-u*y,E=u*g-d*m;return(v=x*x+w*w+E*E)>0&&(x*=v=1/Math.sqrt(v),w*=v,E*=v),e[0]=x,e[1]=w,e[2]=E,e[3]=0,e[4]=g*E-y*w,e[5]=y*x-m*E,e[6]=m*w-g*x,e[7]=0,e[8]=m,e[9]=g,e[10]=y,e[11]=0,e[12]=o,e[13]=s,e[14]=c,e[15]=1,e},ze.str=function(e){return"mat4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+", "+e[9]+", "+e[10]+", "+e[11]+", "+e[12]+", "+e[13]+", "+e[14]+", "+e[15]+")"},ze.frob=function(e){return Math.hypot(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15])},ze.add=function(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e[2]=t[2]+n[2],e[3]=t[3]+n[3],e[4]=t[4]+n[4],e[5]=t[5]+n[5],e[6]=t[6]+n[6],e[7]=t[7]+n[7],e[8]=t[8]+n[8],e[9]=t[9]+n[9],e[10]=t[10]+n[10],e[11]=t[11]+n[11],e[12]=t[12]+n[12],e[13]=t[13]+n[13],e[14]=t[14]+n[14],e[15]=t[15]+n[15],e},ze.subtract=fM,ze.multiplyScalar=function(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e[3]=t[3]*n,e[4]=t[4]*n,e[5]=t[5]*n,e[6]=t[6]*n,e[7]=t[7]*n,e[8]=t[8]*n,e[9]=t[9]*n,e[10]=t[10]*n,e[11]=t[11]*n,e[12]=t[12]*n,e[13]=t[13]*n,e[14]=t[14]*n,e[15]=t[15]*n,e},ze.multiplyScalarAndAdd=function(e,t,n,r){return e[0]=t[0]+n[0]*r,e[1]=t[1]+n[1]*r,e[2]=t[2]+n[2]*r,e[3]=t[3]+n[3]*r,e[4]=t[4]+n[4]*r,e[5]=t[5]+n[5]*r,e[6]=t[6]+n[6]*r,e[7]=t[7]+n[7]*r,e[8]=t[8]+n[8]*r,e[9]=t[9]+n[9]*r,e[10]=t[10]+n[10]*r,e[11]=t[11]+n[11]*r,e[12]=t[12]+n[12]*r,e[13]=t[13]+n[13]*r,e[14]=t[14]+n[14]*r,e[15]=t[15]+n[15]*r,e},ze.exactEquals=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]&&e[8]===t[8]&&e[9]===t[9]&&e[10]===t[10]&&e[11]===t[11]&&e[12]===t[12]&&e[13]===t[13]&&e[14]===t[14]&&e[15]===t[15]},ze.equals=function(e,t){var n=e[0],r=e[1],o=e[2],s=e[3],c=e[4],u=e[5],d=e[6],f=e[7],m=e[8],g=e[9],y=e[10],v=e[11],x=e[12],w=e[13],E=e[14],M=e[15],D=t[0],A=t[1],P=t[2],C=t[3],R=t[4],k=t[5],N=t[6],z=t[7],B=t[8],U=t[9],$=t[10],W=t[11],V=t[12],K=t[13],Q=t[14],ot=t[15];return Math.abs(n-D)<=vr.EPSILON*Math.max(1,Math.abs(n),Math.abs(D))&&Math.abs(r-A)<=vr.EPSILON*Math.max(1,Math.abs(r),Math.abs(A))&&Math.abs(o-P)<=vr.EPSILON*Math.max(1,Math.abs(o),Math.abs(P))&&Math.abs(s-C)<=vr.EPSILON*Math.max(1,Math.abs(s),Math.abs(C))&&Math.abs(c-R)<=vr.EPSILON*Math.max(1,Math.abs(c),Math.abs(R))&&Math.abs(u-k)<=vr.EPSILON*Math.max(1,Math.abs(u),Math.abs(k))&&Math.abs(d-N)<=vr.EPSILON*Math.max(1,Math.abs(d),Math.abs(N))&&Math.abs(f-z)<=vr.EPSILON*Math.max(1,Math.abs(f),Math.abs(z))&&Math.abs(m-B)<=vr.EPSILON*Math.max(1,Math.abs(m),Math.abs(B))&&Math.abs(g-U)<=vr.EPSILON*Math.max(1,Math.abs(g),Math.abs(U))&&Math.abs(y-$)<=vr.EPSILON*Math.max(1,Math.abs(y),Math.abs($))&&Math.abs(v-W)<=vr.EPSILON*Math.max(1,Math.abs(v),Math.abs(W))&&Math.abs(x-V)<=vr.EPSILON*Math.max(1,Math.abs(x),Math.abs(V))&&Math.abs(w-K)<=vr.EPSILON*Math.max(1,Math.abs(w),Math.abs(K))&&Math.abs(E-Q)<=vr.EPSILON*Math.max(1,Math.abs(E),Math.abs(Q))&&Math.abs(M-ot)<=vr.EPSILON*Math.max(1,Math.abs(M),Math.abs(ot))},ze.sub=ze.mul=ze.ortho=ze.perspective=void 0;var vr=function(e,t){if(e&&e.__esModule)return e;if(null===e||"object"!==ym(e)&&"function"!=typeof e)return{default:e};var n=Mf(void 0);if(n&&n.has(e))return n.get(e);var r={},o=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if("default"!==s&&Object.prototype.hasOwnProperty.call(e,s)){var c=o?Object.getOwnPropertyDescriptor(e,s):null;c&&(c.get||c.set)?Object.defineProperty(r,s,c):r[s]=e[s]}return r.default=e,n&&n.set(e,r),r}(Jr);function Mf(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(Mf=function(r){return r?n:t})(e)}function V_(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function Jx(e,t,n){var r=t[0],o=t[1],s=t[2],c=t[3],u=t[4],d=t[5],f=t[6],m=t[7],g=t[8],y=t[9],v=t[10],x=t[11],w=t[12],E=t[13],M=t[14],D=t[15],A=n[0],P=n[1],C=n[2],R=n[3];return e[0]=A*r+P*u+C*g+R*w,e[1]=A*o+P*d+C*y+R*E,e[2]=A*s+P*f+C*v+R*M,e[3]=A*c+P*m+C*x+R*D,e[4]=(A=n[4])*r+(P=n[5])*u+(C=n[6])*g+(R=n[7])*w,e[5]=A*o+P*d+C*y+R*E,e[6]=A*s+P*f+C*v+R*M,e[7]=A*c+P*m+C*x+R*D,e[8]=(A=n[8])*r+(P=n[9])*u+(C=n[10])*g+(R=n[11])*w,e[9]=A*o+P*d+C*y+R*E,e[10]=A*s+P*f+C*v+R*M,e[11]=A*c+P*m+C*x+R*D,e[12]=(A=n[12])*r+(P=n[13])*u+(C=n[14])*g+(R=n[15])*w,e[13]=A*o+P*d+C*y+R*E,e[14]=A*s+P*f+C*v+R*M,e[15]=A*c+P*m+C*x+R*D,e}function Qx(e,t,n){var r=t[0],o=t[1],s=t[2],c=t[3],u=r+r,d=o+o,f=s+s,m=r*u,g=r*d,y=r*f,v=o*d,x=o*f,w=s*f,E=c*u,M=c*d,D=c*f;return e[0]=1-(v+w),e[1]=g+D,e[2]=y-M,e[3]=0,e[4]=g-D,e[5]=1-(m+w),e[6]=x+E,e[7]=0,e[8]=y+M,e[9]=x-E,e[10]=1-(m+v),e[11]=0,e[12]=n[0],e[13]=n[1],e[14]=n[2],e[15]=1,e}function uu(e,t){var n=t[4],r=t[5],o=t[6],s=t[8],c=t[9],u=t[10];return e[0]=Math.hypot(t[0],t[1],t[2]),e[1]=Math.hypot(n,r,o),e[2]=Math.hypot(s,c,u),e}function kh(e,t,n,r,o){var s,c=1/Math.tan(t/2);return e[0]=c/n,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=c,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=o&&o!==1/0?(e[10]=(o+r)*(s=1/(r-o)),e[14]=2*o*r*s):(e[10]=-1,e[14]=-2*r),e}function t1(e,t,n,r,o,s,c){var u=1/(t-n),d=1/(r-o),f=1/(s-c);return e[0]=-2*u,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*d,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=2*f,e[11]=0,e[12]=(t+n)*u,e[13]=(o+r)*d,e[14]=(c+s)*f,e[15]=1,e}function fM(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2],e[3]=t[3]-n[3],e[4]=t[4]-n[4],e[5]=t[5]-n[5],e[6]=t[6]-n[6],e[7]=t[7]-n[7],e[8]=t[8]-n[8],e[9]=t[9]-n[9],e[10]=t[10]-n[10],e[11]=t[11]-n[11],e[12]=t[12]-n[12],e[13]=t[13]-n[13],e[14]=t[14]-n[14],e[15]=t[15]-n[15],e}ze.perspective=kh,ze.ortho=t1,ze.mul=Jx,ze.sub=fM;var Le={},Ne={};function e1(e){return(e1="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(e)}Object.defineProperty(Ne,"__esModule",{value:!0}),Ne.create=r1,Ne.clone=function(e){var t=new Dl.ARRAY_TYPE(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},Ne.length=If,Ne.fromValues=function(e,t,n){var r=new Dl.ARRAY_TYPE(3);return r[0]=e,r[1]=t,r[2]=n,r},Ne.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e},Ne.set=function(e,t,n,r){return e[0]=t,e[1]=n,e[2]=r,e},Ne.add=function(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e[2]=t[2]+n[2],e},Ne.subtract=U_,Ne.multiply=i1,Ne.divide=G_,Ne.ceil=function(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e},Ne.floor=function(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2]),e},Ne.min=function(e,t,n){return e[0]=Math.min(t[0],n[0]),e[1]=Math.min(t[1],n[1]),e[2]=Math.min(t[2],n[2]),e},Ne.max=function(e,t,n){return e[0]=Math.max(t[0],n[0]),e[1]=Math.max(t[1],n[1]),e[2]=Math.max(t[2],n[2]),e},Ne.round=function(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e[2]=Math.round(t[2]),e},Ne.scale=function(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e},Ne.scaleAndAdd=function(e,t,n,r){return e[0]=t[0]+n[0]*r,e[1]=t[1]+n[1]*r,e[2]=t[2]+n[2]*r,e},Ne.distance=pM,Ne.squaredDistance=$_,Ne.squaredLength=mM,Ne.negate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e},Ne.inverse=function(e,t){return e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e},Ne.normalize=function(e,t){var n=t[0],r=t[1],o=t[2],s=n*n+r*r+o*o;return s>0&&(s=1/Math.sqrt(s)),e[0]=t[0]*s,e[1]=t[1]*s,e[2]=t[2]*s,e},Ne.dot=o1,Ne.cross=function(e,t,n){var r=t[0],o=t[1],s=t[2],c=n[0],u=n[1],d=n[2];return e[0]=o*d-s*u,e[1]=s*c-r*d,e[2]=r*u-o*c,e},Ne.lerp=function(e,t,n,r){var o=t[0],s=t[1],c=t[2];return e[0]=o+r*(n[0]-o),e[1]=s+r*(n[1]-s),e[2]=c+r*(n[2]-c),e},Ne.hermite=function(e,t,n,r,o,s){var c=s*s,u=c*(2*s-3)+1,d=c*(s-2)+s,f=c*(s-1),m=c*(3-2*s);return e[0]=t[0]*u+n[0]*d+r[0]*f+o[0]*m,e[1]=t[1]*u+n[1]*d+r[1]*f+o[1]*m,e[2]=t[2]*u+n[2]*d+r[2]*f+o[2]*m,e},Ne.bezier=function(e,t,n,r,o,s){var c=1-s,u=c*c,d=s*s,f=u*c,m=3*s*u,g=3*d*c,y=d*s;return e[0]=t[0]*f+n[0]*m+r[0]*g+o[0]*y,e[1]=t[1]*f+n[1]*m+r[1]*g+o[1]*y,e[2]=t[2]*f+n[2]*m+r[2]*g+o[2]*y,e},Ne.random=function(e,t){t=t||1;var n=2*Dl.RANDOM()*Math.PI,r=2*Dl.RANDOM()-1,o=Math.sqrt(1-r*r)*t;return e[0]=Math.cos(n)*o,e[1]=Math.sin(n)*o,e[2]=r*t,e},Ne.transformMat4=function(e,t,n){var r=t[0],o=t[1],s=t[2],c=n[3]*r+n[7]*o+n[11]*s+n[15];return e[0]=(n[0]*r+n[4]*o+n[8]*s+n[12])/(c=c||1),e[1]=(n[1]*r+n[5]*o+n[9]*s+n[13])/c,e[2]=(n[2]*r+n[6]*o+n[10]*s+n[14])/c,e},Ne.transformMat3=function(e,t,n){var r=t[0],o=t[1],s=t[2];return e[0]=r*n[0]+o*n[3]+s*n[6],e[1]=r*n[1]+o*n[4]+s*n[7],e[2]=r*n[2]+o*n[5]+s*n[8],e},Ne.transformQuat=function(e,t,n){var r=n[0],o=n[1],s=n[2],c=t[0],u=t[1],d=t[2],f=o*d-s*u,m=s*c-r*d,g=r*u-o*c,y=o*g-s*m,v=s*f-r*g,x=r*m-o*f,w=2*n[3];return m*=w,g*=w,v*=2,x*=2,e[0]=c+(f*=w)+(y*=2),e[1]=u+m+v,e[2]=d+g+x,e},Ne.rotateX=function(e,t,n,r){var o=[],s=[];return o[0]=t[0]-n[0],o[1]=t[1]-n[1],o[2]=t[2]-n[2],s[0]=o[0],s[1]=o[1]*Math.cos(r)-o[2]*Math.sin(r),s[2]=o[1]*Math.sin(r)+o[2]*Math.cos(r),e[0]=s[0]+n[0],e[1]=s[1]+n[1],e[2]=s[2]+n[2],e},Ne.rotateY=function(e,t,n,r){var o=[],s=[];return o[0]=t[0]-n[0],o[1]=t[1]-n[1],o[2]=t[2]-n[2],s[0]=o[2]*Math.sin(r)+o[0]*Math.cos(r),s[1]=o[1],s[2]=o[2]*Math.cos(r)-o[0]*Math.sin(r),e[0]=s[0]+n[0],e[1]=s[1]+n[1],e[2]=s[2]+n[2],e},Ne.rotateZ=function(e,t,n,r){var o=[],s=[];return o[0]=t[0]-n[0],o[1]=t[1]-n[1],o[2]=t[2]-n[2],s[0]=o[0]*Math.cos(r)-o[1]*Math.sin(r),s[1]=o[0]*Math.sin(r)+o[1]*Math.cos(r),s[2]=o[2],e[0]=s[0]+n[0],e[1]=s[1]+n[1],e[2]=s[2]+n[2],e},Ne.angle=function(e,t){var n=e[0],r=e[1],o=e[2],s=t[0],c=t[1],u=t[2],d=Math.sqrt(n*n+r*r+o*o)*Math.sqrt(s*s+c*c+u*u),f=d&&o1(e,t)/d;return Math.acos(Math.min(Math.max(f,-1),1))},Ne.zero=function(e){return e[0]=0,e[1]=0,e[2]=0,e},Ne.str=function(e){return"vec3("+e[0]+", "+e[1]+", "+e[2]+")"},Ne.exactEquals=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]},Ne.equals=function(e,t){var n=e[0],r=e[1],o=e[2],s=t[0],c=t[1],u=t[2];return Math.abs(n-s)<=Dl.EPSILON*Math.max(1,Math.abs(n),Math.abs(s))&&Math.abs(r-c)<=Dl.EPSILON*Math.max(1,Math.abs(r),Math.abs(c))&&Math.abs(o-u)<=Dl.EPSILON*Math.max(1,Math.abs(o),Math.abs(u))},Ne.forEach=Ne.sqrLen=Ne.len=Ne.sqrDist=Ne.dist=Ne.div=Ne.mul=Ne.sub=void 0;var Dl=function(e,t){if(e&&e.__esModule)return e;if(null===e||"object"!==e1(e)&&"function"!=typeof e)return{default:e};var n=n1(void 0);if(n&&n.has(e))return n.get(e);var r={},o=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if("default"!==s&&Object.prototype.hasOwnProperty.call(e,s)){var c=o?Object.getOwnPropertyDescriptor(e,s):null;c&&(c.get||c.set)?Object.defineProperty(r,s,c):r[s]=e[s]}return r.default=e,n&&n.set(e,r),r}(Jr);function n1(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(n1=function(r){return r?n:t})(e)}function r1(){var e=new Dl.ARRAY_TYPE(3);return Dl.ARRAY_TYPE!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function If(e){return Math.hypot(e[0],e[1],e[2])}function U_(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2],e}function i1(e,t,n){return e[0]=t[0]*n[0],e[1]=t[1]*n[1],e[2]=t[2]*n[2],e}function G_(e,t,n){return e[0]=t[0]/n[0],e[1]=t[1]/n[1],e[2]=t[2]/n[2],e}function pM(e,t){return Math.hypot(t[0]-e[0],t[1]-e[1],t[2]-e[2])}function $_(e,t){var n=t[0]-e[0],r=t[1]-e[1],o=t[2]-e[2];return n*n+r*r+o*o}function mM(e){var t=e[0],n=e[1],r=e[2];return t*t+n*n+r*r}function o1(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}Ne.sub=U_,Ne.mul=i1,Ne.div=G_,Ne.dist=pM,Ne.sqrDist=$_,Ne.len=If,Ne.sqrLen=mM;var Sl,H_=(Sl=r1(),function(e,t,n,r,o,s){var c,u;for(t||(t=3),n||(n=0),u=r?Math.min(r*t+n,e.length):e.length,c=n;c<u;c+=t)Sl[0]=e[c],Sl[1]=e[c+1],Sl[2]=e[c+2],o(Sl,Sl,s),e[c]=Sl[0],e[c+1]=Sl[1],e[c+2]=Sl[2];return e});Ne.forEach=H_;var Je={};function s1(e){return(s1="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(e)}Object.defineProperty(Je,"__esModule",{value:!0}),Je.create=_M,Je.clone=function(e){var t=new Yo.ARRAY_TYPE(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},Je.fromValues=function(e,t,n,r){var o=new Yo.ARRAY_TYPE(4);return o[0]=e,o[1]=t,o[2]=n,o[3]=r,o},Je.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},Je.set=function(e,t,n,r,o){return e[0]=t,e[1]=n,e[2]=r,e[3]=o,e},Je.add=function(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e[2]=t[2]+n[2],e[3]=t[3]+n[3],e},Je.subtract=yM,Je.multiply=vM,Je.divide=xM,Je.ceil=function(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e[3]=Math.ceil(t[3]),e},Je.floor=function(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2]),e[3]=Math.floor(t[3]),e},Je.min=function(e,t,n){return e[0]=Math.min(t[0],n[0]),e[1]=Math.min(t[1],n[1]),e[2]=Math.min(t[2],n[2]),e[3]=Math.min(t[3],n[3]),e},Je.max=function(e,t,n){return e[0]=Math.max(t[0],n[0]),e[1]=Math.max(t[1],n[1]),e[2]=Math.max(t[2],n[2]),e[3]=Math.max(t[3],n[3]),e},Je.round=function(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e[2]=Math.round(t[2]),e[3]=Math.round(t[3]),e},Je.scale=function(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e[3]=t[3]*n,e},Je.scaleAndAdd=function(e,t,n,r){return e[0]=t[0]+n[0]*r,e[1]=t[1]+n[1]*r,e[2]=t[2]+n[2]*r,e[3]=t[3]+n[3]*r,e},Je.distance=a1,Je.squaredDistance=Df,Je.length=Sf,Je.squaredLength=q_,Je.negate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e},Je.inverse=function(e,t){return e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e[3]=1/t[3],e},Je.normalize=function(e,t){var n=t[0],r=t[1],o=t[2],s=t[3],c=n*n+r*r+o*o+s*s;return c>0&&(c=1/Math.sqrt(c)),e[0]=n*c,e[1]=r*c,e[2]=o*c,e[3]=s*c,e},Je.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]},Je.cross=function(e,t,n,r){var o=n[0]*r[1]-n[1]*r[0],s=n[0]*r[2]-n[2]*r[0],c=n[0]*r[3]-n[3]*r[0],u=n[1]*r[2]-n[2]*r[1],d=n[1]*r[3]-n[3]*r[1],f=n[2]*r[3]-n[3]*r[2],m=t[0],g=t[1],y=t[2],v=t[3];return e[0]=g*f-y*d+v*u,e[1]=-m*f+y*c-v*s,e[2]=m*d-g*c+v*o,e[3]=-m*u+g*s-y*o,e},Je.lerp=function(e,t,n,r){var o=t[0],s=t[1],c=t[2],u=t[3];return e[0]=o+r*(n[0]-o),e[1]=s+r*(n[1]-s),e[2]=c+r*(n[2]-c),e[3]=u+r*(n[3]-u),e},Je.random=function(e,t){var n,r,o,s,c,u;t=t||1;do{c=(n=2*Yo.RANDOM()-1)*n+(r=2*Yo.RANDOM()-1)*r}while(c>=1);do{u=(o=2*Yo.RANDOM()-1)*o+(s=2*Yo.RANDOM()-1)*s}while(u>=1);var d=Math.sqrt((1-c)/u);return e[0]=t*n,e[1]=t*r,e[2]=t*o*d,e[3]=t*s*d,e},Je.transformMat4=function(e,t,n){var r=t[0],o=t[1],s=t[2],c=t[3];return e[0]=n[0]*r+n[4]*o+n[8]*s+n[12]*c,e[1]=n[1]*r+n[5]*o+n[9]*s+n[13]*c,e[2]=n[2]*r+n[6]*o+n[10]*s+n[14]*c,e[3]=n[3]*r+n[7]*o+n[11]*s+n[15]*c,e},Je.transformQuat=function(e,t,n){var r=t[0],o=t[1],s=t[2],c=n[0],u=n[1],d=n[2],f=n[3],m=f*r+u*s-d*o,g=f*o+d*r-c*s,y=f*s+c*o-u*r,v=-c*r-u*o-d*s;return e[0]=m*f+v*-c+g*-d-y*-u,e[1]=g*f+v*-u+y*-c-m*-d,e[2]=y*f+v*-d+m*-u-g*-c,e[3]=t[3],e},Je.zero=function(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=0,e},Je.str=function(e){return"vec4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},Je.exactEquals=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]},Je.equals=function(e,t){var n=e[0],r=e[1],o=e[2],s=e[3],c=t[0],u=t[1],d=t[2],f=t[3];return Math.abs(n-c)<=Yo.EPSILON*Math.max(1,Math.abs(n),Math.abs(c))&&Math.abs(r-u)<=Yo.EPSILON*Math.max(1,Math.abs(r),Math.abs(u))&&Math.abs(o-d)<=Yo.EPSILON*Math.max(1,Math.abs(o),Math.abs(d))&&Math.abs(s-f)<=Yo.EPSILON*Math.max(1,Math.abs(s),Math.abs(f))},Je.forEach=Je.sqrLen=Je.len=Je.sqrDist=Je.dist=Je.div=Je.mul=Je.sub=void 0;var Yo=function(e,t){if(e&&e.__esModule)return e;if(null===e||"object"!==s1(e)&&"function"!=typeof e)return{default:e};var n=gM(void 0);if(n&&n.has(e))return n.get(e);var r={},o=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if("default"!==s&&Object.prototype.hasOwnProperty.call(e,s)){var c=o?Object.getOwnPropertyDescriptor(e,s):null;c&&(c.get||c.set)?Object.defineProperty(r,s,c):r[s]=e[s]}return r.default=e,n&&n.set(e,r),r}(Jr);function gM(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(gM=function(r){return r?n:t})(e)}function _M(){var e=new Yo.ARRAY_TYPE(4);return Yo.ARRAY_TYPE!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}function yM(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2],e[3]=t[3]-n[3],e}function vM(e,t,n){return e[0]=t[0]*n[0],e[1]=t[1]*n[1],e[2]=t[2]*n[2],e[3]=t[3]*n[3],e}function xM(e,t,n){return e[0]=t[0]/n[0],e[1]=t[1]/n[1],e[2]=t[2]/n[2],e[3]=t[3]/n[3],e}function a1(e,t){return Math.hypot(t[0]-e[0],t[1]-e[1],t[2]-e[2],t[3]-e[3])}function Df(e,t){var n=t[0]-e[0],r=t[1]-e[1],o=t[2]-e[2],s=t[3]-e[3];return n*n+r*r+o*o+s*s}function Sf(e){return Math.hypot(e[0],e[1],e[2],e[3])}function q_(e){var t=e[0],n=e[1],r=e[2],o=e[3];return t*t+n*n+r*r+o*o}Je.sub=yM,Je.mul=vM,Je.div=xM,Je.dist=a1,Je.sqrDist=Df,Je.len=Sf,Je.sqrLen=q_;var l1=function(){var e=_M();return function(t,n,r,o,s,c){var u,d;for(n||(n=4),r||(r=0),d=o?Math.min(o*n+r,t.length):t.length,u=r;u<d;u+=n)e[0]=t[u],e[1]=t[u+1],e[2]=t[u+2],e[3]=t[u+3],s(e,e,c),t[u]=e[0],t[u+1]=e[1],t[u+2]=e[2],t[u+3]=e[3];return t}}();function vm(e){return(vm="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(e)}Je.forEach=l1,Object.defineProperty(Le,"__esModule",{value:!0}),Le.create=Z_,Le.identity=function(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e},Le.setAxisAngle=u1,Le.getAxisAngle=function(e,t){var n=2*Math.acos(t[3]),r=Math.sin(n/2);return r>Ns.EPSILON?(e[0]=t[0]/r,e[1]=t[1]/r,e[2]=t[2]/r):(e[0]=1,e[1]=0,e[2]=0),n},Le.getAngle=function(e,t){var n=X_(e,t);return Math.acos(2*n*n-1)},Le.multiply=h1,Le.rotateX=function(e,t,n){n*=.5;var r=t[0],o=t[1],s=t[2],c=t[3],u=Math.sin(n),d=Math.cos(n);return e[0]=r*d+c*u,e[1]=o*d+s*u,e[2]=s*d-o*u,e[3]=c*d-r*u,e},Le.rotateY=function(e,t,n){n*=.5;var r=t[0],o=t[1],s=t[2],c=t[3],u=Math.sin(n),d=Math.cos(n);return e[0]=r*d-s*u,e[1]=o*d+c*u,e[2]=s*d+r*u,e[3]=c*d-o*u,e},Le.rotateZ=function(e,t,n){n*=.5;var r=t[0],o=t[1],s=t[2],c=t[3],u=Math.sin(n),d=Math.cos(n);return e[0]=r*d+o*u,e[1]=o*d-r*u,e[2]=s*d+c*u,e[3]=c*d-s*u,e},Le.calculateW=function(e,t){var n=t[0],r=t[1],o=t[2];return e[0]=n,e[1]=r,e[2]=o,e[3]=Math.sqrt(Math.abs(1-n*n-r*r-o*o)),e},Le.exp=W_,Le.ln=xm,Le.pow=function(e,t,n){return xm(e,t),f1(e,e,n),W_(e,e),e},Le.slerp=bm,Le.random=function(e){var t=Ns.RANDOM(),n=Ns.RANDOM(),r=Ns.RANDOM(),o=Math.sqrt(1-t),s=Math.sqrt(t);return e[0]=o*Math.sin(2*Math.PI*n),e[1]=o*Math.cos(2*Math.PI*n),e[2]=s*Math.sin(2*Math.PI*r),e[3]=s*Math.cos(2*Math.PI*r),e},Le.invert=function(e,t){var n=t[0],r=t[1],o=t[2],s=t[3],c=n*n+r*r+o*o+s*s,u=c?1/c:0;return e[0]=-n*u,e[1]=-r*u,e[2]=-o*u,e[3]=s*u,e},Le.conjugate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=t[3],e},Le.fromMat3=d1,Le.fromEuler=function(e,t,n,r){var o=.5*Math.PI/180;t*=o,n*=o,r*=o;var s=Math.sin(t),c=Math.cos(t),u=Math.sin(n),d=Math.cos(n),f=Math.sin(r),m=Math.cos(r);return e[0]=s*d*m-c*u*f,e[1]=c*u*m+s*d*f,e[2]=c*d*f-s*u*m,e[3]=c*d*m+s*u*f,e},Le.str=function(e){return"quat("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},Le.setAxes=Le.sqlerp=Le.rotationTo=Le.equals=Le.exactEquals=Le.normalize=Le.sqrLen=Le.squaredLength=Le.len=Le.length=Le.lerp=Le.dot=Le.scale=Le.mul=Le.add=Le.set=Le.copy=Le.fromValues=Le.clone=void 0;var Ns=oa(Jr),c1=oa(kn),Ba=oa(Ne),co=oa(Je);function Cf(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(Cf=function(r){return r?n:t})(e)}function oa(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!==vm(e)&&"function"!=typeof e)return{default:e};var n=Cf(t);if(n&&n.has(e))return n.get(e);var r={},o=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if("default"!==s&&Object.prototype.hasOwnProperty.call(e,s)){var c=o?Object.getOwnPropertyDescriptor(e,s):null;c&&(c.get||c.set)?Object.defineProperty(r,s,c):r[s]=e[s]}return r.default=e,n&&n.set(e,r),r}function Z_(){var e=new Ns.ARRAY_TYPE(4);return Ns.ARRAY_TYPE!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}function u1(e,t,n){n*=.5;var r=Math.sin(n);return e[0]=r*t[0],e[1]=r*t[1],e[2]=r*t[2],e[3]=Math.cos(n),e}function h1(e,t,n){var r=t[0],o=t[1],s=t[2],c=t[3],u=n[0],d=n[1],f=n[2],m=n[3];return e[0]=r*m+c*u+o*f-s*d,e[1]=o*m+c*d+s*u-r*f,e[2]=s*m+c*f+r*d-o*u,e[3]=c*m-r*u-o*d-s*f,e}function W_(e,t){var n=t[0],r=t[1],o=t[2],s=t[3],c=Math.sqrt(n*n+r*r+o*o),u=Math.exp(s),d=c>0?u*Math.sin(c)/c:0;return e[0]=n*d,e[1]=r*d,e[2]=o*d,e[3]=u*Math.cos(c),e}function xm(e,t){var n=t[0],r=t[1],o=t[2],s=t[3],c=Math.sqrt(n*n+r*r+o*o),u=c>0?Math.atan2(c,s)/c:0;return e[0]=n*u,e[1]=r*u,e[2]=o*u,e[3]=.5*Math.log(n*n+r*r+o*o+s*s),e}function bm(e,t,n,r){var o,s,c,u,d,f=t[0],m=t[1],g=t[2],y=t[3],v=n[0],x=n[1],w=n[2],E=n[3];return(s=f*v+m*x+g*w+y*E)<0&&(s=-s,v=-v,x=-x,w=-w,E=-E),1-s>Ns.EPSILON?(o=Math.acos(s),c=Math.sin(o),u=Math.sin((1-r)*o)/c,d=Math.sin(r*o)/c):(u=1-r,d=r),e[0]=u*f+d*v,e[1]=u*m+d*x,e[2]=u*g+d*w,e[3]=u*y+d*E,e}function d1(e,t){var n,r=t[0]+t[4]+t[8];if(r>0)n=Math.sqrt(r+1),e[3]=.5*n,e[0]=(t[5]-t[7])*(n=.5/n),e[1]=(t[6]-t[2])*n,e[2]=(t[1]-t[3])*n;else{var o=0;t[4]>t[0]&&(o=1),t[8]>t[3*o+o]&&(o=2);var s=(o+1)%3,c=(o+2)%3;n=Math.sqrt(t[3*o+o]-t[3*s+s]-t[3*c+c]+1),e[o]=.5*n,e[3]=(t[3*s+c]-t[3*c+s])*(n=.5/n),e[s]=(t[3*s+o]+t[3*o+s])*n,e[c]=(t[3*c+o]+t[3*o+c])*n}return e}Le.clone=co.clone,Le.fromValues=co.fromValues,Le.copy=co.copy,Le.set=co.set,Le.add=co.add,Le.mul=h1;var f1=co.scale;Le.scale=f1;var X_=co.dot;Le.dot=X_,Le.lerp=co.lerp;var p1=co.length;Le.length=p1,Le.len=p1;var m1=co.squaredLength;Le.squaredLength=m1,Le.sqrLen=m1;var uo=co.normalize;Le.normalize=uo,Le.exactEquals=co.exactEquals,Le.equals=co.equals;var vs,Y_,wm,ho=(vs=Ba.create(),Y_=Ba.fromValues(1,0,0),wm=Ba.fromValues(0,1,0),function(e,t,n){var r=Ba.dot(t,n);return r<-.999999?(Ba.cross(vs,Y_,t),Ba.len(vs)<1e-6&&Ba.cross(vs,wm,t),Ba.normalize(vs,vs),u1(e,vs,Math.PI),e):r>.999999?(e[0]=0,e[1]=0,e[2]=0,e[3]=1,e):(Ba.cross(vs,t,n),e[0]=vs[0],e[1]=vs[1],e[2]=vs[2],e[3]=1+r,uo(e,e))});Le.rotationTo=ho;var hu,Em,g1=(hu=Z_(),Em=Z_(),function(e,t,n,r,o,s){return bm(hu,t,o,s),bm(Em,n,r,s),bm(e,hu,Em,2*s*(1-s)),e});Le.sqlerp=g1;var sa,_1=(sa=c1.create(),function(e,t,n,r){return sa[0]=n[0],sa[3]=n[1],sa[6]=n[2],sa[1]=r[0],sa[4]=r[1],sa[7]=r[2],sa[2]=-t[0],sa[5]=-t[1],sa[8]=-t[2],uo(e,d1(e,sa))});Le.setAxes=_1;var en={};function Tm(e){return(Tm="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(e)}Object.defineProperty(en,"__esModule",{value:!0}),en.create=function(){var e=new Eo.ARRAY_TYPE(8);return Eo.ARRAY_TYPE!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[4]=0,e[5]=0,e[6]=0,e[7]=0),e[3]=1,e},en.clone=function(e){var t=new Eo.ARRAY_TYPE(8);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t},en.fromValues=function(e,t,n,r,o,s,c,u){var d=new Eo.ARRAY_TYPE(8);return d[0]=e,d[1]=t,d[2]=n,d[3]=r,d[4]=o,d[5]=s,d[6]=c,d[7]=u,d},en.fromRotationTranslationValues=function(e,t,n,r,o,s,c){var u=new Eo.ARRAY_TYPE(8);u[0]=e,u[1]=t,u[2]=n,u[3]=r;var d=.5*o,f=.5*s,m=.5*c;return u[4]=d*r+f*n-m*t,u[5]=f*r+m*e-d*n,u[6]=m*r+d*t-f*e,u[7]=-d*e-f*t-m*n,u},en.fromRotationTranslation=Mm,en.fromTranslation=function(e,t){return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e[4]=.5*t[0],e[5]=.5*t[1],e[6]=.5*t[2],e[7]=0,e},en.fromRotation=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=0,e[5]=0,e[6]=0,e[7]=0,e},en.fromMat4=function(e,t){var n=ja.create();y1.getRotation(n,t);var r=new Eo.ARRAY_TYPE(3);return y1.getTranslation(r,t),Mm(e,n,r),e},en.copy=x1,en.identity=function(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e[4]=0,e[5]=0,e[6]=0,e[7]=0,e},en.set=function(e,t,n,r,o,s,c,u,d){return e[0]=t,e[1]=n,e[2]=r,e[3]=o,e[4]=s,e[5]=c,e[6]=u,e[7]=d,e},en.getDual=function(e,t){return e[0]=t[4],e[1]=t[5],e[2]=t[6],e[3]=t[7],e},en.setDual=function(e,t){return e[4]=t[0],e[5]=t[1],e[6]=t[2],e[7]=t[3],e},en.getTranslation=function(e,t){var n=t[4],r=t[5],o=t[6],s=t[7],c=-t[0],u=-t[1],d=-t[2],f=t[3];return e[0]=2*(n*f+s*c+r*d-o*u),e[1]=2*(r*f+s*u+o*c-n*d),e[2]=2*(o*f+s*d+n*u-r*c),e},en.translate=function(e,t,n){var r=t[0],o=t[1],s=t[2],c=t[3],u=.5*n[0],d=.5*n[1],f=.5*n[2],m=t[4],g=t[5],y=t[6],v=t[7];return e[0]=r,e[1]=o,e[2]=s,e[3]=c,e[4]=c*u+o*f-s*d+m,e[5]=c*d+s*u-r*f+g,e[6]=c*f+r*d-o*u+y,e[7]=-r*u-o*d-s*f+v,e},en.rotateX=function(e,t,n){var r=-t[0],o=-t[1],s=-t[2],c=t[3],u=t[4],d=t[5],f=t[6],m=t[7],g=u*c+m*r+d*s-f*o,y=d*c+m*o+f*r-u*s,v=f*c+m*s+u*o-d*r,x=m*c-u*r-d*o-f*s;return ja.rotateX(e,t,n),e[4]=g*(c=e[3])+x*(r=e[0])+y*(s=e[2])-v*(o=e[1]),e[5]=y*c+x*o+v*r-g*s,e[6]=v*c+x*s+g*o-y*r,e[7]=x*c-g*r-y*o-v*s,e},en.rotateY=function(e,t,n){var r=-t[0],o=-t[1],s=-t[2],c=t[3],u=t[4],d=t[5],f=t[6],m=t[7],g=u*c+m*r+d*s-f*o,y=d*c+m*o+f*r-u*s,v=f*c+m*s+u*o-d*r,x=m*c-u*r-d*o-f*s;return ja.rotateY(e,t,n),e[4]=g*(c=e[3])+x*(r=e[0])+y*(s=e[2])-v*(o=e[1]),e[5]=y*c+x*o+v*r-g*s,e[6]=v*c+x*s+g*o-y*r,e[7]=x*c-g*r-y*o-v*s,e},en.rotateZ=function(e,t,n){var r=-t[0],o=-t[1],s=-t[2],c=t[3],u=t[4],d=t[5],f=t[6],m=t[7],g=u*c+m*r+d*s-f*o,y=d*c+m*o+f*r-u*s,v=f*c+m*s+u*o-d*r,x=m*c-u*r-d*o-f*s;return ja.rotateZ(e,t,n),e[4]=g*(c=e[3])+x*(r=e[0])+y*(s=e[2])-v*(o=e[1]),e[5]=y*c+x*o+v*r-g*s,e[6]=v*c+x*s+g*o-y*r,e[7]=x*c-g*r-y*o-v*s,e},en.rotateByQuatAppend=function(e,t,n){var r=n[0],o=n[1],s=n[2],c=n[3],u=t[0],d=t[1],f=t[2],m=t[3];return e[0]=u*c+m*r+d*s-f*o,e[1]=d*c+m*o+f*r-u*s,e[2]=f*c+m*s+u*o-d*r,e[3]=m*c-u*r-d*o-f*s,e[4]=(u=t[4])*c+(m=t[7])*r+(d=t[5])*s-(f=t[6])*o,e[5]=d*c+m*o+f*r-u*s,e[6]=f*c+m*s+u*o-d*r,e[7]=m*c-u*r-d*o-f*s,e},en.rotateByQuatPrepend=function(e,t,n){var r=t[0],o=t[1],s=t[2],c=t[3],u=n[0],d=n[1],f=n[2],m=n[3];return e[0]=r*m+c*u+o*f-s*d,e[1]=o*m+c*d+s*u-r*f,e[2]=s*m+c*f+r*d-o*u,e[3]=c*m-r*u-o*d-s*f,e[4]=r*(m=n[7])+c*(u=n[4])+o*(f=n[6])-s*(d=n[5]),e[5]=o*m+c*d+s*u-r*f,e[6]=s*m+c*f+r*d-o*u,e[7]=c*m-r*u-o*d-s*f,e},en.rotateAroundAxis=function(e,t,n,r){if(Math.abs(r)<Eo.EPSILON)return x1(e,t);var o=Math.hypot(n[0],n[1],n[2]);r*=.5;var s=Math.sin(r),c=s*n[0]/o,u=s*n[1]/o,d=s*n[2]/o,f=Math.cos(r),m=t[0],g=t[1],y=t[2],v=t[3];e[0]=m*f+v*c+g*d-y*u,e[1]=g*f+v*u+y*c-m*d,e[2]=y*f+v*d+m*u-g*c,e[3]=v*f-m*c-g*u-y*d;var x=t[4],w=t[5],E=t[6],M=t[7];return e[4]=x*f+M*c+w*d-E*u,e[5]=w*f+M*u+E*c-x*d,e[6]=E*f+M*d+x*u-w*c,e[7]=M*f-x*c-w*u-E*d,e},en.add=function(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e[2]=t[2]+n[2],e[3]=t[3]+n[3],e[4]=t[4]+n[4],e[5]=t[5]+n[5],e[6]=t[6]+n[6],e[7]=t[7]+n[7],e},en.multiply=Fh,en.scale=function(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e[3]=t[3]*n,e[4]=t[4]*n,e[5]=t[5]*n,e[6]=t[6]*n,e[7]=t[7]*n,e},en.lerp=function(e,t,n,r){var o=1-r;return b1(t,n)<0&&(r=-r),e[0]=t[0]*o+n[0]*r,e[1]=t[1]*o+n[1]*r,e[2]=t[2]*o+n[2]*r,e[3]=t[3]*o+n[3]*r,e[4]=t[4]*o+n[4]*r,e[5]=t[5]*o+n[5]*r,e[6]=t[6]*o+n[6]*r,e[7]=t[7]*o+n[7]*r,e},en.invert=function(e,t){var n=Pf(t);return e[0]=-t[0]/n,e[1]=-t[1]/n,e[2]=-t[2]/n,e[3]=t[3]/n,e[4]=-t[4]/n,e[5]=-t[5]/n,e[6]=-t[6]/n,e[7]=t[7]/n,e},en.conjugate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=t[3],e[4]=-t[4],e[5]=-t[5],e[6]=-t[6],e[7]=t[7],e},en.normalize=function(e,t){var n=Pf(t);if(n>0){n=Math.sqrt(n);var r=t[0]/n,o=t[1]/n,s=t[2]/n,c=t[3]/n,u=t[4],d=t[5],f=t[6],m=t[7],g=r*u+o*d+s*f+c*m;e[0]=r,e[1]=o,e[2]=s,e[3]=c,e[4]=(u-r*g)/n,e[5]=(d-o*g)/n,e[6]=(f-s*g)/n,e[7]=(m-c*g)/n}return e},en.str=function(e){return"quat2("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+")"},en.exactEquals=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]},en.equals=function(e,t){var n=e[0],r=e[1],o=e[2],s=e[3],c=e[4],u=e[5],d=e[6],f=e[7],m=t[0],g=t[1],y=t[2],v=t[3],x=t[4],w=t[5],E=t[6],M=t[7];return Math.abs(n-m)<=Eo.EPSILON*Math.max(1,Math.abs(n),Math.abs(m))&&Math.abs(r-g)<=Eo.EPSILON*Math.max(1,Math.abs(r),Math.abs(g))&&Math.abs(o-y)<=Eo.EPSILON*Math.max(1,Math.abs(o),Math.abs(y))&&Math.abs(s-v)<=Eo.EPSILON*Math.max(1,Math.abs(s),Math.abs(v))&&Math.abs(c-x)<=Eo.EPSILON*Math.max(1,Math.abs(c),Math.abs(x))&&Math.abs(u-w)<=Eo.EPSILON*Math.max(1,Math.abs(u),Math.abs(w))&&Math.abs(d-E)<=Eo.EPSILON*Math.max(1,Math.abs(d),Math.abs(E))&&Math.abs(f-M)<=Eo.EPSILON*Math.max(1,Math.abs(f),Math.abs(M))},en.sqrLen=en.squaredLength=en.len=en.length=en.dot=en.mul=en.setReal=en.getReal=void 0;var Eo=Af(Jr),ja=Af(Le),y1=Af(ze);function v1(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(v1=function(r){return r?n:t})(e)}function Af(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!==Tm(e)&&"function"!=typeof e)return{default:e};var n=v1(t);if(n&&n.has(e))return n.get(e);var r={},o=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if("default"!==s&&Object.prototype.hasOwnProperty.call(e,s)){var c=o?Object.getOwnPropertyDescriptor(e,s):null;c&&(c.get||c.set)?Object.defineProperty(r,s,c):r[s]=e[s]}return r.default=e,n&&n.set(e,r),r}function Mm(e,t,n){var r=.5*n[0],o=.5*n[1],s=.5*n[2],c=t[0],u=t[1],d=t[2],f=t[3];return e[0]=c,e[1]=u,e[2]=d,e[3]=f,e[4]=r*f+o*d-s*u,e[5]=o*f+s*c-r*d,e[6]=s*f+r*u-o*c,e[7]=-r*c-o*u-s*d,e}function x1(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e}function Fh(e,t,n){var r=t[0],o=t[1],s=t[2],c=t[3],u=n[4],d=n[5],f=n[6],m=n[7],g=t[4],y=t[5],v=t[6],x=t[7],w=n[0],E=n[1],M=n[2],D=n[3];return e[0]=r*D+c*w+o*M-s*E,e[1]=o*D+c*E+s*w-r*M,e[2]=s*D+c*M+r*E-o*w,e[3]=c*D-r*w-o*E-s*M,e[4]=r*m+c*u+o*f-s*d+g*D+x*w+y*M-v*E,e[5]=o*m+c*d+s*u-r*f+y*D+x*E+v*w-g*M,e[6]=s*m+c*f+r*d-o*u+v*D+x*M+g*E-y*w,e[7]=c*m-r*u-o*d-s*f+x*D-g*w-y*E-v*M,e}en.getReal=ja.copy,en.setReal=ja.copy,en.mul=Fh;var b1=ja.dot;en.dot=b1;var w1=ja.length;en.length=w1,en.len=w1;var Pf=ja.squaredLength;en.squaredLength=Pf,en.sqrLen=Pf;var Ue={};function Im(e){return(Im="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(e)}Object.defineProperty(Ue,"__esModule",{value:!0}),Ue.create=K_,Ue.clone=function(e){var t=new zs.ARRAY_TYPE(2);return t[0]=e[0],t[1]=e[1],t},Ue.fromValues=function(e,t){var n=new zs.ARRAY_TYPE(2);return n[0]=e,n[1]=t,n},Ue.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e},Ue.set=function(e,t,n){return e[0]=t,e[1]=n,e},Ue.add=function(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e},Ue.subtract=Dm,Ue.multiply=Lf,Ue.divide=E1,Ue.ceil=function(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e},Ue.floor=function(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e},Ue.min=function(e,t,n){return e[0]=Math.min(t[0],n[0]),e[1]=Math.min(t[1],n[1]),e},Ue.max=function(e,t,n){return e[0]=Math.max(t[0],n[0]),e[1]=Math.max(t[1],n[1]),e},Ue.round=function(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e},Ue.scale=function(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e},Ue.scaleAndAdd=function(e,t,n,r){return e[0]=t[0]+n[0]*r,e[1]=t[1]+n[1]*r,e},Ue.distance=T1,Ue.squaredDistance=M1,Ue.length=I1,Ue.squaredLength=D1,Ue.negate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e},Ue.inverse=function(e,t){return e[0]=1/t[0],e[1]=1/t[1],e},Ue.normalize=function(e,t){var n=t[0],r=t[1],o=n*n+r*r;return o>0&&(o=1/Math.sqrt(o)),e[0]=t[0]*o,e[1]=t[1]*o,e},Ue.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]},Ue.cross=function(e,t,n){var r=t[0]*n[1]-t[1]*n[0];return e[0]=e[1]=0,e[2]=r,e},Ue.lerp=function(e,t,n,r){var o=t[0],s=t[1];return e[0]=o+r*(n[0]-o),e[1]=s+r*(n[1]-s),e},Ue.random=function(e,t){t=t||1;var n=2*zs.RANDOM()*Math.PI;return e[0]=Math.cos(n)*t,e[1]=Math.sin(n)*t,e},Ue.transformMat2=function(e,t,n){var r=t[0],o=t[1];return e[0]=n[0]*r+n[2]*o,e[1]=n[1]*r+n[3]*o,e},Ue.transformMat2d=function(e,t,n){var r=t[0],o=t[1];return e[0]=n[0]*r+n[2]*o+n[4],e[1]=n[1]*r+n[3]*o+n[5],e},Ue.transformMat3=function(e,t,n){var r=t[0],o=t[1];return e[0]=n[0]*r+n[3]*o+n[6],e[1]=n[1]*r+n[4]*o+n[7],e},Ue.transformMat4=function(e,t,n){var r=t[0],o=t[1];return e[0]=n[0]*r+n[4]*o+n[12],e[1]=n[1]*r+n[5]*o+n[13],e},Ue.rotate=function(e,t,n,r){var o=t[0]-n[0],s=t[1]-n[1],c=Math.sin(r),u=Math.cos(r);return e[0]=o*u-s*c+n[0],e[1]=o*c+s*u+n[1],e},Ue.angle=function(e,t){var n=e[0],r=e[1],o=t[0],s=t[1],c=Math.sqrt(n*n+r*r)*Math.sqrt(o*o+s*s);return Math.acos(Math.min(Math.max(c&&(n*o+r*s)/c,-1),1))},Ue.zero=function(e){return e[0]=0,e[1]=0,e},Ue.str=function(e){return"vec2("+e[0]+", "+e[1]+")"},Ue.exactEquals=function(e,t){return e[0]===t[0]&&e[1]===t[1]},Ue.equals=function(e,t){var n=e[0],r=e[1],o=t[0],s=t[1];return Math.abs(n-o)<=zs.EPSILON*Math.max(1,Math.abs(n),Math.abs(o))&&Math.abs(r-s)<=zs.EPSILON*Math.max(1,Math.abs(r),Math.abs(s))},Ue.forEach=Ue.sqrLen=Ue.sqrDist=Ue.dist=Ue.div=Ue.mul=Ue.sub=Ue.len=void 0;var zs=function(e,t){if(e&&e.__esModule)return e;if(null===e||"object"!==Im(e)&&"function"!=typeof e)return{default:e};var n=Rf(void 0);if(n&&n.has(e))return n.get(e);var r={},o=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if("default"!==s&&Object.prototype.hasOwnProperty.call(e,s)){var c=o?Object.getOwnPropertyDescriptor(e,s):null;c&&(c.get||c.set)?Object.defineProperty(r,s,c):r[s]=e[s]}return r.default=e,n&&n.set(e,r),r}(Jr);function Rf(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(Rf=function(r){return r?n:t})(e)}function K_(){var e=new zs.ARRAY_TYPE(2);return zs.ARRAY_TYPE!=Float32Array&&(e[0]=0,e[1]=0),e}function Dm(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e}function Lf(e,t,n){return e[0]=t[0]*n[0],e[1]=t[1]*n[1],e}function E1(e,t,n){return e[0]=t[0]/n[0],e[1]=t[1]/n[1],e}function T1(e,t){return Math.hypot(t[0]-e[0],t[1]-e[1])}function M1(e,t){var n=t[0]-e[0],r=t[1]-e[1];return n*n+r*r}function I1(e){return Math.hypot(e[0],e[1])}function D1(e){var t=e[0],n=e[1];return t*t+n*n}Ue.len=I1,Ue.sub=Dm,Ue.mul=Lf,Ue.div=E1,Ue.dist=T1,Ue.sqrDist=M1,Ue.sqrLen=D1;var bM=function(){var e=K_();return function(t,n,r,o,s,c){var u,d;for(n||(n=2),r||(r=0),d=o?Math.min(o*n+r,t.length):t.length,u=r;u<d;u+=n)e[0]=t[u],e[1]=t[u+1],s(e,e,c),t[u]=e[0],t[u+1]=e[1];return t}}();function Sm(e){return(Sm="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(e)}Ue.forEach=bM,Object.defineProperty(ci,"__esModule",{value:!0});var En=ci.vec4=Z=ci.vec3=ci.vec2=ci.quat2=ki=ci.quat=st=ci.mat4=fo=ci.mat3=ci.mat2d=Nh=ci.mat2=ci.glMatrix=void 0,J_=Bs(Jr);ci.glMatrix=J_;var Q_=Bs(_r),Nh=ci.mat2=Q_,wM=Bs(yr);ci.mat2d=wM;var ty=Bs(kn),fo=ci.mat3=ty,du=Bs(ze),st=ci.mat4=du,S1=Bs(Le),ki=ci.quat=S1,xC=Bs(en);ci.quat2=xC;var Cm=Bs(Ue);ci.vec2=Cm;var EM=Bs(Ne),Z=ci.vec3=EM,C1=Bs(Je);function ey(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(ey=function(r){return r?n:t})(e)}function Bs(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!==Sm(e)&&"function"!=typeof e)return{default:e};var n=ey(t);if(n&&n.has(e))return n.get(e);var r={},o=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if("default"!==s&&Object.prototype.hasOwnProperty.call(e,s)){var c=o?Object.getOwnPropertyDescriptor(e,s):null;c&&(c.get||c.set)?Object.defineProperty(r,s,c):r[s]=e[s]}return r.default=e,n&&n.set(e,r),r}En=ci.vec4=C1;const A1=Ce([{type:"Float32",name:"a_globe_pos",components:3},{type:"Float32",name:"a_uv",components:2}]),{members:fu}=A1,zh=Ce([{name:"a_pos_3",components:3,type:"Int16"}]);var Cl=Ce([{name:"a_pos",type:"Int16",components:2}]),Am={};!function(n){function r(s,c,u){var d=o(256*s,256*(c=Math.pow(2,u)-c-1),u),f=o(256*(s+1),256*(c+1),u);return d[0]+","+d[1]+","+f[0]+","+f[1]}function o(s,c,u){var d=2*Math.PI*6378137/256/Math.pow(2,u);return[s*d-2*Math.PI*6378137/2,c*d-2*Math.PI*6378137/2]}n.getURL=function(s,c,u,d,f,m){return m=m||{},s+"?"+["bbox="+r(u,d,f),"format="+(m.format||"image/png"),"service="+(m.service||"WMS"),"version="+(m.version||"1.1.1"),"request="+(m.request||"GetMap"),"srs="+(m.srs||"EPSG:3857"),"width="+(m.width||256),"height="+(m.height||256),"layers="+c].join("&")},n.getTileBBox=r,n.getMercCoords=o,Object.defineProperty(n,"__esModule",{value:!0})}(Am);var Pm=Am;class xs{constructor(t,n,r){this.z=t,this.x=n,this.y=r,this.key=kf(0,t,t,n,r)}equals(t){return this.z===t.z&&this.x===t.x&&this.y===t.y}url(t,n){const r=Pm.getTileBBox(this.x,this.y,this.z),o=function(s,c,u){let d,f="";for(let m=s;m>0;m--)d=1<<m-1,f+=(c&d?1:0)+(u&d?2:0);return f}(this.z,this.x,this.y);return t[(this.x+this.y)%t.length].replace("{prefix}",(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String("tms"===n?Math.pow(2,this.z)-this.y-1:this.y)).replace("{quadkey}",o).replace("{bbox-epsg-3857}",r)}toString(){return`${this.z}/${this.x}/${this.y}`}}class Of{constructor(t,n){this.wrap=t,this.canonical=n,this.key=kf(t,n.z,n.z,n.x,n.y)}}class nn{constructor(t,n,r,o,s){this.overscaledZ=t,this.wrap=n,this.canonical=new xs(r,+o,+s),this.key=0===n&&t===r?this.canonical.key:kf(n,t,r,o,s)}equals(t){return this.overscaledZ===t.overscaledZ&&this.wrap===t.wrap&&this.canonical.equals(t.canonical)}scaledTo(t){const n=this.canonical.z-t;return t>this.canonical.z?new nn(t,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new nn(t,this.wrap,t,this.canonical.x>>n,this.canonical.y>>n)}calculateScaledKey(t,n=!0){if(this.overscaledZ===t&&n)return this.key;if(t>this.canonical.z)return kf(this.wrap*+n,t,this.canonical.z,this.canonical.x,this.canonical.y);{const r=this.canonical.z-t;return kf(this.wrap*+n,t,t,this.canonical.x>>r,this.canonical.y>>r)}}isChildOf(t){if(t.wrap!==this.wrap)return!1;const n=this.canonical.z-t.canonical.z;return 0===t.overscaledZ||t.overscaledZ<this.overscaledZ&&t.canonical.z<this.canonical.z&&t.canonical.x===this.canonical.x>>n&&t.canonical.y===this.canonical.y>>n}children(t){if(this.overscaledZ>=t)return[new nn(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const n=this.canonical.z+1,r=2*this.canonical.x,o=2*this.canonical.y;return[new nn(n,this.wrap,n,r,o),new nn(n,this.wrap,n,r+1,o),new nn(n,this.wrap,n,r,o+1),new nn(n,this.wrap,n,r+1,o+1)]}isLessThan(t){return this.wrap<t.wrap||!(this.wrap>t.wrap)&&(this.overscaledZ<t.overscaledZ||!(this.overscaledZ>t.overscaledZ)&&(this.canonical.x<t.canonical.x||!(this.canonical.x>t.canonical.x)&&this.canonical.y<t.canonical.y))}wrapped(){return new nn(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(t){return new nn(this.overscaledZ,t,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new Of(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}}function kf(e,t,n,r,o){const s=1<<Math.min(n,22);let c=s*(o%s)+r%s;return e&&n<22&&(c+=s*s*((e<0?-2*e-1:2*e)%(1<<2*(22-n)))),16*(32*c+n)+(t-n)}const ny=[e=>{let t=e.canonical.x-1,n=e.wrap;return t<0&&(t=(1<<e.canonical.z)-1,n--),new nn(e.overscaledZ,n,e.canonical.z,t,e.canonical.y)},e=>{let t=e.canonical.x+1,n=e.wrap;return t===1<<e.canonical.z&&(t=0,n++),new nn(e.overscaledZ,n,e.canonical.z,t,e.canonical.y)},e=>new nn(e.overscaledZ,e.wrap,e.canonical.z,e.canonical.x,(0===e.canonical.y?1<<e.canonical.z:e.canonical.y)-1),e=>new nn(e.overscaledZ,e.wrap,e.canonical.z,e.canonical.x,e.canonical.y===(1<<e.canonical.z)-1?0:e.canonical.y+1)];re(xs,"CanonicalTileID"),re(nn,"OverscaledTileID",{omit:["projMatrix","expandedProjMatrix"]});class Rm{constructor(t,n){this.pos=t,this.dir=n}intersectsPlane(t,n,r){const o=Z.dot(n,this.dir);if(Math.abs(o)<1e-6)return!1;const s=((t[0]-this.pos[0])*n[0]+(t[1]-this.pos[1])*n[1]+(t[2]-this.pos[2])*n[2])/o;return r[0]=this.pos[0]+this.dir[0]*s,r[1]=this.pos[1]+this.dir[1]*s,r[2]=this.pos[2]+this.dir[2]*s,!0}closestPointOnSphere(t,n,r){if(Z.equals(this.pos,t)||0===n)return r[0]=r[1]=r[2]=0,!1;const[o,s,c]=this.dir,u=this.pos[0]-t[0],d=this.pos[1]-t[1],f=this.pos[2]-t[2],m=o*o+s*s+c*c,g=2*(u*o+d*s+f*c),y=g*g-4*m*(u*u+d*d+f*f-n*n);if(y<0){const v=Math.max(-g/2,0),x=u+o*v,w=d+s*v,E=f+c*v,M=Math.hypot(x,w,E);return r[0]=x*n/M,r[1]=w*n/M,r[2]=E*n/M,!1}{const v=(-g-Math.sqrt(y))/(2*m);if(v<0){const x=Math.hypot(u,d,f);return r[0]=u*n/x,r[1]=d*n/x,r[2]=f*n/x,!1}return r[0]=u+o*v,r[1]=d+s*v,r[2]=f+c*v,!0}}}class ry{constructor(t,n,r,o,s){this.TL=t,this.TR=n,this.BR=r,this.BL=o,this.horizon=s}static fromInvProjectionMatrix(t,n,r){const o=[-1,1,1],s=[1,1,1],c=[1,-1,1],u=[-1,-1,1],d=Z.transformMat4(o,o,t),f=Z.transformMat4(s,s,t),m=Z.transformMat4(c,c,t),g=Z.transformMat4(u,u,t);return new ry(d,f,m,g,n/r)}}function Ff(e,t,n){let r=1/0,o=-1/0;const s=[];for(const c of e){Z.sub(s,c,t);const u=Z.dot(s,n);r=Math.min(r,u),o=Math.max(o,u)}return[r,o]}function iy(e,t){let n=!0;for(let r=0;r<e.planes.length;r++){const o=e.planes[r];let s=0;for(let c=0;c<t.length;c++)s+=Z.dot(o,t[c])+o[3]>=0;if(0===s)return 0;s!==t.length&&(n=!1)}return n?2:1}function oy(e,t){for(const n of e.projections){const r=Ff(t,e.points[0],n.axis);if(n.projection[1]<r[0]||n.projection[0]>r[1])return 0}return 1}function Nf(e,t){let n=0;const r=[0,0,0,0];for(let o=0;o<e.length;o++)r[0]=e[o][0],r[1]=e[o][1],r[2]=e[o][2],r[3]=1,En.dot(r,t)>=0&&n++;return n}class aa{constructor(t,n){this.points=t||new Array(8).fill([0,0,0]),this.planes=n||new Array(6).fill([0,0,0,0]),this.bounds=Bn.fromPoints(this.points),this.projections=[],this.frustumEdges=[Z.sub([],this.points[2],this.points[3]),Z.sub([],this.points[0],this.points[3]),Z.sub([],this.points[4],this.points[0]),Z.sub([],this.points[5],this.points[1]),Z.sub([],this.points[6],this.points[2]),Z.sub([],this.points[7],this.points[3])];for(const r of this.frustumEdges){const o=[0,-r[2],r[1]],s=[r[2],0,-r[0]];this.projections.push({axis:o,projection:Ff(this.points,this.points[0],o)}),this.projections.push({axis:s,projection:Ff(this.points,this.points[0],s)})}}static fromInvProjectionMatrix(t,n,r,o){const s=Math.pow(2,r),c=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map(f=>{const m=En.transformMat4([],f,t),g=1/m[3]/n*s;return En.mul(m,m,[g,g,o?1/m[3]:g,g])}),u=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map(f=>{const m=Z.sub([],c[f[0]],c[f[1]]),g=Z.sub([],c[f[2]],c[f[1]]),y=Z.normalize([],Z.cross([],m,g)),v=-Z.dot(y,c[f[1]]);return y.concat(v)}),d=[];for(let f=0;f<c.length;f++)d.push([c[f][0],c[f][1],c[f][2]]);return new aa(d,u)}intersectsPrecise(t,n,r){for(let o=0;o<n.length;o++)if(!Nf(t,n[o]))return 0;for(let o=0;o<this.planes.length;o++)if(!Nf(t,this.planes[o]))return 0;for(const o of r)for(const s of this.frustumEdges){const c=Z.cross([],o,s),u=Z.length(c);if(0===u)continue;Z.scale(c,c,1/u);const d=Ff(this.points,this.points[0],c),f=Ff(t,this.points[0],c);if(d[0]>f[1]||f[0]>d[1])return 0}return 1}}class Bn{static fromPoints(t){const n=[1/0,1/0,1/0],r=[-1/0,-1/0,-1/0];for(const o of t)Z.min(n,n,o),Z.max(r,r,o);return new Bn(n,r)}static fromTileIdAndHeight(t,n,r){const o=1<<t.canonical.z,s=t.canonical.x,c=t.canonical.y;return new Bn([s/o,c/o,n],[(s+1)/o,(c+1)/o,r])}static applyTransform(t,n){const r=t.getCorners();for(let o=0;o<r.length;++o)Z.transformMat4(r[o],r[o],n);return Bn.fromPoints(r)}static projectAabbCorners(t,n){const r=t.getCorners();for(let o=0;o<r.length;++o)Z.transformMat4(r[o],r[o],n);return r}constructor(t,n){this.min=t,this.max=n,this.center=Z.scale([],Z.add([],this.min,this.max),.5)}quadrant(t){const n=[t%2==0,t<2],r=Z.clone(this.min),o=Z.clone(this.max);for(let s=0;s<n.length;s++)r[s]=n[s]?this.min[s]:this.center[s],o[s]=n[s]?this.center[s]:this.max[s];return o[2]=this.max[2],new Bn(r,o)}distanceX(t){return Math.max(Math.min(this.max[0],t[0]),this.min[0])-t[0]}distanceY(t){return Math.max(Math.min(this.max[1],t[1]),this.min[1])-t[1]}distanceZ(t){return Math.max(Math.min(this.max[2],t[2]),this.min[2])-t[2]}getCorners(){const t=this.min,n=this.max;return[[t[0],t[1],t[2]],[n[0],t[1],t[2]],[n[0],n[1],t[2]],[t[0],n[1],t[2]],[t[0],t[1],n[2]],[n[0],t[1],n[2]],[n[0],n[1],n[2]],[t[0],n[1],n[2]]]}intersects(t){return this.intersectsAabb(t.bounds)?iy(t,this.getCorners()):0}intersectsFlat(t){return this.intersectsAabb(t.bounds)?iy(t,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsPrecise(t,n){return n||this.intersects(t)?oy(t,this.getCorners()):0}intersectsPreciseFlat(t,n){return n||this.intersectsFlat(t)?oy(t,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsAabb(t){for(let n=0;n<3;++n)if(this.min[n]>t.max[n]||t.min[n]>this.max[n])return!1;return!0}intersectsAabbXY(t){return!(this.min[0]>t.max[0]||t.min[0]>this.max[0]||this.min[1]>t.max[1]||t.min[1]>this.max[1])}encapsulate(t){for(let n=0;n<3;n++)this.min[n]=Math.min(this.min[n],t.min[n]),this.max[n]=Math.max(this.max[n],t.max[n])}encapsulatePoint(t){for(let n=0;n<3;n++)this.min[n]=Math.min(this.min[n],t[n]),this.max[n]=Math.max(this.max[n],t[n])}closestPoint(t){return[Math.max(Math.min(this.max[0],t[0]),this.min[0]),Math.max(Math.min(this.max[1],t[1]),this.min[1]),Math.max(Math.min(this.max[2],t[2]),this.min[2])]}}re(Bn,"Aabb");const zf=5,yc=6,To=et/Math.PI/2,TM=16383,sy=[64,32,16],Ji=-To,Mo=To,ay=[new Bn([Ji,Ji,Ji],[Mo,Mo,Mo]),new Bn([Ji,Ji,Ji],[0,0,Mo]),new Bn([0,Ji,Ji],[Mo,0,Mo]),new Bn([Ji,0,Ji],[0,Mo,Mo]),new Bn([0,0,Ji],[Mo,Mo,Mo])];function Bf(e){return e*To/jf}function ly(e,t,n,r=!0){const o=Z.scale([],e._camera.position,e.worldSize),s=[t,n,1,1];En.transformMat4(s,s,e.pixelMatrixInverse),En.scale(s,s,1/s[3]);const c=Z.sub([],s,o),u=Z.normalize([],c),d=e.globeMatrix,f=[d[12],d[13],d[14]],m=Z.sub([],f,o),g=Z.length(m),y=Z.normalize([],m),v=e.worldSize/(2*Math.PI),x=Z.dot(y,u),w=Math.asin(v/g);if(w<Math.acos(x)){if(!r)return null;const U=[],$=[];Z.scale(U,u,g/x),Z.normalize($,Z.sub($,U,m)),Z.normalize(u,Z.add(u,m,Z.scale(u,$,Math.tan(w)*g)))}const E=[];new Rm(o,u).closestPointOnSphere(f,v,E);const M=Z.normalize([],nr(d,0)),D=Z.normalize([],nr(d,1)),A=Z.normalize([],nr(d,2)),P=Z.dot(M,E),C=Z.dot(D,E),R=Z.dot(A,E),k=fr(Math.asin(-C/v));let N=fr(Math.atan2(P,R));N=e.center.lng+function(U,$){const W=($-U+180)%360-180;return W<-180?W+360:W}(e.center.lng,N);const z=Br(N),B=ne(ui(k),0,1);return new Qe(z,B)}class P1{constructor(t,n,r){this.a=Z.sub([],t,r),this.b=Z.sub([],n,r),this.center=r;const o=Z.normalize([],this.a),s=Z.normalize([],this.b);this.angle=Math.acos(Z.dot(o,s))}}function Lm(e,t){if(0===e.angle)return null;let n;return n=0===e.a[t]?1/e.angle*.5*Math.PI:1/e.angle*Math.atan(e.b[t]/e.a[t]/Math.sin(e.angle)-1/Math.tan(e.angle)),n<0||n>1?null:function(r,o,s,c){const u=Math.sin(s);return r*(Math.sin((1-c)*s)/u)+o*(Math.sin(c*s)/u)}(e.a[t],e.b[t],e.angle,ne(n,0,1))+e.center[t]}function bs(e){if(e.z<=1)return ay[e.z+2*e.y+e.x];const t=pu(la(e));return Bn.fromPoints(t)}function Al(e,t,n){return Z.scale(e,e,1-n),Z.scaleAndAdd(e,e,t,n)}function R1(e,t){const n=ri(t.zoom);if(0===n)return bs(e);const r=la(e),o=pu(r),s=Br(r.getWest())*t.worldSize,c=Br(r.getEast())*t.worldSize,u=ui(r.getNorth())*t.worldSize,d=ui(r.getSouth())*t.worldSize,f=[s,u,0],m=[c,u,0],g=[s,d,0],y=[c,d,0],v=st.invert([],t.globeMatrix);return Z.transformMat4(f,f,v),Z.transformMat4(m,m,v),Z.transformMat4(g,g,v),Z.transformMat4(y,y,v),o[0]=Al(o[0],g,n),o[1]=Al(o[1],y,n),o[2]=Al(o[2],m,n),o[3]=Al(o[3],f,n),Bn.fromPoints(o)}function L1(e,t,n){for(const r of e)Z.transformMat4(r,r,t),Z.scale(r,r,n)}function cy(e,t,n,r){const o=t/e.worldSize,s=e.globeMatrix;if(n.z<=1){const z=bs(n).getCorners();return L1(z,s,o),Bn.fromPoints(z)}const c=la(n,r),u=pu(c);L1(u,s,o);const d=Number.MAX_VALUE,f=[-d,-d,-d],m=[d,d,d];if(c.contains(e.center)){for(const U of u)Z.min(m,m,U),Z.max(f,f,U);f[2]=0;const z=e.point,B=[z.x*o,z.y*o,0];return Z.min(m,m,B),Z.max(f,f,B),new Bn(m,f)}const g=[s[12]*o,s[13]*o,s[14]*o],y=c.getCenter(),v=ne(e.center.lat,-Ar,Ar),x=ne(y.lat,-Ar,Ar),w=Br(e.center.lng),E=ui(v);let M=w-Br(y.lng);const D=E-ui(x);M>.5?M-=1:M<-.5&&(M+=1);let A=0;if(Math.abs(M)>Math.abs(D))A=M>=0?1:3;else{A=D>=0?0:2;const z=[s[4]*o,s[5]*o,s[6]*o],B=-Math.sin(Oe(D>=0?c.getSouth():c.getNorth()))*To;Z.scaleAndAdd(g,g,z,B)}const P=u[A],C=u[(A+1)%4],R=new P1(P,C,g),k=[Lm(R,0)||P[0],Lm(R,1)||P[1],Lm(R,2)||P[2]],N=ri(e.zoom);if(N>0){const z=function({x:U,y:$,z:W},V,K,Q,ot){const Y=1/(1<<W);let J=U*Y,ct=J+Y,dt=$*Y,ht=dt+Y,_t=0;const vt=(J+ct)/2-Q;return vt>.5?_t=-1:vt<-.5&&(_t=1),J=((J+_t)*V-(Q*=V))*K+Q,ct=((ct+_t)*V-Q)*K+Q,dt=(dt*V-(ot*=V))*K+ot,ht=(ht*V-ot)*K+ot,[[J,ht,0],[ct,ht,0],[ct,dt,0],[J,dt,0]]}(n,t,e._pixelsPerMercatorPixel,w,E);for(let U=0;U<u.length;U++)Al(u[U],z[U],N);const B=Z.add([],z[A],z[(A+1)%4]);Z.scale(B,B,.5),Al(k,B,N)}for(const z of u)Z.min(m,m,z),Z.max(f,f,z);return m[2]=Math.min(P[2],C[2]),Z.min(m,m,k),Z.max(f,f,k),new Bn(m,f)}function la({x:e,y:t,z:n},r=!1){const o=1/(1<<n),s=new Se(Jo(e*o),t===(1<<n)-1&&r?-90:xr((t+1)*o)),c=new Se(Jo((e+1)*o),0===t&&r?90:xr(t*o));return new Oi(s,c)}function pu(e){const t=Oe(e.getNorth()),n=Oe(e.getSouth()),r=Math.cos(t),o=Math.cos(n),s=Math.sin(t),c=Math.sin(n),u=e.getWest(),d=e.getEast();return[Bh(o,c,u),Bh(o,c,d),Bh(r,s,d),Bh(r,s,u)]}function Bh(e,t,n,r=To){return n=Oe(n),[e*Math.sin(n)*r,-t*r,e*Math.cos(n)*r]}function Ko(e,t,n){return Bh(Math.cos(Oe(e)),Math.sin(Oe(e)),t,n)}function Om(e,t,n,r){const o=1<<n.z,s=(e/et+n.x)/o;return Ko(xr((t/et+n.y)/o),Jo(s),r)}function uy({min:e,max:t}){return TM/Math.max(t[0]-e[0],t[1]-e[1],t[2]-e[2])}const MM=new Float64Array(16);function mu(e){const t=uy(e),n=st.fromScaling(MM,[t,t,t]);return st.translate(n,n,Z.negate([],e.min))}function km(e){const t=st.fromTranslation(MM,e.min),n=1/uy(e);return st.scale(t,t,[n,n,n])}function hy(e){const t=et/(2*Math.PI);return e/(2*Math.PI)/t}function O1(e,t){return et/(512*Math.pow(2,e))*uy(bs(t))}function k1(e,t,n,r,o){const s=hy(n),c=[e,t,-n/(2*Math.PI)],u=st.identity(new Float64Array(16));return st.translate(u,u,c),st.scale(u,u,[s,s,s]),st.rotateX(u,u,Oe(-o)),st.rotateY(u,u,Oe(-r)),u}function F1(e){const t=e.pixelsPerMeter,n=t/Ln(1,e.center.lat),r=st.identity(new Float64Array(16));return st.translate(r,r,[e.point.x,e.point.y,0]),st.scale(r,r,[n,n,t]),Float32Array.from(r)}function ri(e){return Ro(zf,yc,e)}function Va(e,t,n){const r=st.identity(new Float64Array(16)),o=(t/(1<<e)-.5)*Math.PI*2;return st.rotateY(r,n.globeMatrix,o),Float32Array.from(r)}function jh(e,t,n){const r=ri(n.zoom),o=e.style.map._antialias,s=t.options.extStandardDerivativesForceOff||e.terrain&&e.terrain.exaggeration()>0;return 0===r&&!o&&!s}function dy(e,t,n,r){const o=t.getNorth(),s=t.getSouth(),c=t.getWest(),u=t.getEast(),d=1<<e.z,f=u-c,m=o-s,g=f/64,y=-m/sy[n],v=[0,g,0,y,0,0,o,c,0];if(e.z>0){const x=180/r;fo.multiply(v,v,[x/f+1,0,0,0,x/m+1,0,-.5*x/g,.5*x/y,1])}return v[2]=d,v[5]=e.x,v[8]=e.y,v}function N1(e){const t=Ar-5;e=ne(e,-t,t)/t*90;const n=Math.pow(Math.abs(Math.sin(Oe(e))),3);return Math.round(n*(sy.length-1))}function fy(e){const t=[0,0,0],n=st.identity(new Float64Array(16));return st.multiply(n,e.pixelMatrix,e.globeMatrix),Z.transformMat4(t,t,n),new it(t[0],t[1])}function IM(e,t){const n=Ko(t.lat,t.lng),r=function(s){const c=Ko(s._center.lat,s._center.lng),u=Z.fromValues(0,1,0);let d=Z.cross([],u,c);const f=st.fromRotation([],-s.angle,c);d=Z.transformMat4(d,d,f),st.fromRotation(f,-s._pitch,d);const m=Z.normalize([],c);return Z.scale(m,m,Bf(s.cameraToCenterDistance/s.pixelsPerMeter)),Z.transformMat4(m,m,f),Z.add([],c,m)}(e),o=Z.subtract([],r,n);return Z.angle(o,n)}function py(e,t){return IM(e,t)>Math.PI/2*1.01}const DM=Oe(85),my=Math.cos(DM),gy=Math.sin(DM);class bC{constructor(t){this._createGrid(t),this._createPoles(t)}destroy(){this._poleIndexBuffer.destroy(),this._gridBuffer.destroy(),this._gridIndexBuffer.destroy(),this._poleNorthVertexBuffer.destroy(),this._poleSouthVertexBuffer.destroy();for(const t of this._poleSegments)t.destroy();for(const t of this._gridSegments)t.withSkirts.destroy(),t.withoutSkirts.destroy()}_fillGridMeshWithLods(t,n){const r=new Xo,o=new Kr,s=[],c=t+1+2,u=n[0]+1,d=n[0]+1+(1+n.length),f=(m,g,y)=>{let v=m===c-1?m-2:0===m?m:m-1;return v+=y?24575:0,[v,g]};for(let m=0;m<c;++m)r.emplaceBack(...f(m,0,!0));for(let m=0;m<u;++m)for(let g=0;g<c;++g)r.emplaceBack(...f(g,m,(0===g||g===c-1)&&!0));for(let m=0;m<n.length;++m){const g=n[m];for(let y=0;y<c;++y)r.emplaceBack(...f(y,g,!0))}for(let m=0;m<n.length;++m){const g=o.length,y=n[m]+1+2,v=new Kr;for(let E=0;E<y-1;E++){const M=E===y-2,D=M?c*(d-n.length+m-E):c;for(let A=0;A<c-1;A++){const P=E*c+A;0===E||M||0===A||A===c-2?(v.emplaceBack(P+1,P,P+D),v.emplaceBack(P+D,P+D+1,P+1)):(o.emplaceBack(P+1,P,P+D),o.emplaceBack(P+D,P+D+1,P+1))}}const x=Rn.simpleSegment(0,g,r.length,o.length-g);for(let E=0;E<v.uint16.length;E+=3)o.emplaceBack(v.uint16[E],v.uint16[E+1],v.uint16[E+2]);const w=Rn.simpleSegment(0,g,r.length,o.length-g);s.push({withoutSkirts:x,withSkirts:w})}return{vertices:r,indices:o,segments:s}}_createGrid(t){const n=this._fillGridMeshWithLods(64,sy);this._gridSegments=n.segments,this._gridBuffer=t.createVertexBuffer(n.vertices,Cl.members),this._gridIndexBuffer=t.createIndexBuffer(n.indices,!0)}_createPoles(t){const n=new Kr;for(let u=0;u<=64;u++)n.emplaceBack(0,u+1,u+2);this._poleIndexBuffer=t.createIndexBuffer(n,!0);const r=new ou,o=new ou,s=new ou,c=new ou;this._poleSegments=[];for(let u=0,d=0;u<zf;u++){const f=360/(1<<u);r.emplaceBack(0,-To,0,.5,0),o.emplaceBack(0,-To,0,.5,1),s.emplaceBack(0,-To,0,.5,.5),c.emplaceBack(0,-To,0,.5,.5);for(let m=0;m<=64;m++){let g=m/64,y=0;const v=le(0,f,g),[x,w,E]=Bh(my,gy,v,To);r.emplaceBack(x,w,E,g,y),o.emplaceBack(x,w,E,g,1-y);const M=Oe(v);g=.5+.5*Math.sin(M),y=.5+.5*Math.cos(M),s.emplaceBack(x,w,E,g,y),c.emplaceBack(x,w,E,g,1-y)}this._poleSegments.push(Rn.simpleSegment(d,0,66,64)),d+=66}this._poleNorthVertexBuffer=t.createVertexBuffer(r,fu,!1),this._poleSouthVertexBuffer=t.createVertexBuffer(o,fu,!1),this._texturedPoleNorthVertexBuffer=t.createVertexBuffer(s,fu,!1),this._texturedPoleSouthVertexBuffer=t.createVertexBuffer(c,fu,!1)}getGridBuffers(t,n){return[this._gridBuffer,this._gridIndexBuffer,n?this._gridSegments[t].withSkirts:this._gridSegments[t].withoutSkirts]}getPoleBuffers(t,n){return[n?this._texturedPoleNorthVertexBuffer:this._poleNorthVertexBuffer,n?this._texturedPoleSouthVertexBuffer:this._poleSouthVertexBuffer,this._poleIndexBuffer,this._poleSegments[t]]}}const jf=6371008.8,Fm=2*Math.PI*jf;class xc{constructor(t,n){if(isNaN(t)||isNaN(n))throw new Error(`Invalid LngLat object: (${t}, ${n})`);if(this.lng=+t,this.lat=+n,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new xc(Rr(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(t){const n=Math.PI/180,r=this.lat*n,o=t.lat*n,s=Math.sin(r)*Math.sin(o)+Math.cos(r)*Math.cos(o)*Math.cos((t.lng-this.lng)*n);return jf*Math.acos(Math.min(s,1))}toBounds(t=0){const n=360*t/40075017,r=n/Math.cos(Math.PI/180*this.lat);return new Oi(new xc(this.lng-r,this.lat-n),new xc(this.lng+r,this.lat+n))}toEcef(t){const n=Bf(t);return Ko(this.lat,this.lng,To+n)}static convert(t){if(t instanceof xc)return t;if(Array.isArray(t)&&(2===t.length||3===t.length))return new xc(Number(t[0]),Number(t[1]));if(!Array.isArray(t)&&"object"==typeof t&&null!==t)return new xc(Number("lng"in t?t.lng:t.lon),Number(t.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}var Se=xc;const SM=0,CM=25.5;function Vf(e){return Fm*Math.cos(e*Math.PI/180)}function Br(e){return(180+e)/360}function ui(e){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+e*Math.PI/360)))/360}function Ln(e,t){return e/Vf(t)}function Jo(e){return 360*e-180}function xr(e){return 360/Math.PI*Math.atan(Math.exp((180-360*e)*Math.PI/180))-90}function z1(e,t){return e*Vf(xr(t))}const Ar=85.051129;function _y(e){return Math.cos(Oe(ne(e,-Ar,Ar)))}function Pl(e,t){const n=ne(t,SM,CM),r=Math.pow(2,n);return _y(e)*Fm/(512*r)}function yy(e){return 1/Math.cos(e*Math.PI/180)}function Uf(e,t=0){const n=Math.exp(Math.PI*(1-(e.y+t/et)/(1<<e.z)*2));return 80150034*n/(n*n+1)/et/(1<<e.z)}class Qe{constructor(t,n,r=0){this.x=+t,this.y=+n,this.z=+r}static fromLngLat(t,n=0){const r=Se.convert(t);return new Qe(Br(r.lng),ui(r.lat),Ln(n,r.lat))}toLngLat(){return new Se(Jo(this.x),xr(this.y))}toAltitude(){return z1(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/Fm*yy(xr(this.y))}}function vy(e,t,n,r,o,s,c,u,d){const f=(t+r)/2,m=(n+o)/2,g=new it(f,m);u(g),function(y,v,x,w,E,M){const D=x-E,A=w-M;return Math.abs((w-v)*D-(x-y)*A)/Math.hypot(D,A)}(g.x,g.y,s.x,s.y,c.x,c.y)>=d?(vy(e,t,n,f,m,s,g,u,d),vy(e,f,m,r,o,g,c,u,d)):e.push(c)}function B1(e,t,n){let r=e[0],o=r.x,s=r.y;t(r);const c=[r];for(let u=1;u<e.length;u++){const d=e[u],{x:f,y:m}=d;t(d),vy(c,o,s,f,m,r,d,t,n),o=f,s=m,r=d}return c}function j1(e,t,n,r){if(r(t,n)){const o=t.add(n)._mult(.5);j1(e,t,o,r),j1(e,o,n,r)}else e.push(n)}function wC(e,t){let n=e[0];const r=[n];for(let o=1;o<e.length;o++){const s=e[o];j1(r,n,s,t),n=s}return r}const gu=Math.pow(2,14)-1,Gf=-gu-1;function V1(e,t){const n=Math.round(e.x*t),r=Math.round(e.y*t);return e.x=ne(n,Gf,gu),e.y=ne(r,Gf,gu),(n<e.x||n>e.x+1||r<e.y||r>e.y+1)&&nt("Geometry exceeds allowed extent, reduce your vector tile buffer size"),e}function ca(e,t,n){const r=e.loadGeometry(),o=e.extent,s=et/o;if(t&&n&&n.projection.isReprojectedInTileSpace){const c=1<<t.z,{scale:u,x:d,y:f,projection:m}=n,g=y=>{const v=Jo((t.x+y.x/o)/c),x=xr((t.y+y.y/o)/c),w=m.project(v,x);y.x=(w.x*u-d)*o,y.y=(w.y*u-f)*o};for(let y=0;y<r.length;y++)if(1!==e.type)r[y]=B1(r[y],g,1);else{const v=[];for(const x of r[y])x.x<0||x.x>=o||x.y<0||x.y>=o||(g(x),v.push(x));r[y]=v}}for(const c of r)for(const u of c)V1(u,s);return r}function Ua(e,t){return{type:e.type,id:e.id,properties:e.properties,geometry:t?ca(e):[]}}function $f(e,t,n,r,o){e.emplaceBack(2*t+(r+1)/2,2*n+(o+1)/2)}function Nm(e,t,n){e.emplaceBack(t.x,t.y,t.z,16384*n[0],16384*n[1],16384*n[2])}class zm{constructor(t){this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(n=>n.fqid),this.index=t.index,this.hasPattern=!1,this.projection=t.projection,this.layoutVertexArray=new Xo,this.indexArray=new Kr,this.segments=new Rn,this.programConfigurations=new _c(t.layers,t.zoom),this.stateDependentLayerIds=this.layers.filter(n=>n.isStateDependent()).map(n=>n.id)}populate(t,n,r,o){const s=this.layers[0],c=[];let u=null;"circle"===s.type&&(u=s.layout.get("circle-sort-key"));for(const{feature:f,id:m,index:g,sourceLayerIndex:y}of t){const v=this.layers[0]._featureFilter.needGeometry,x=Ua(f,v);if(!this.layers[0]._featureFilter.filter(new ar(this.zoom),x,r))continue;const w=u?u.evaluate(x,{},r):void 0,E={id:m,properties:f.properties,type:f.type,sourceLayerIndex:y,index:g,geometry:v?x.geometry:ca(f,r,o),patterns:{},sortKey:w};c.push(E)}u&&c.sort((f,m)=>f.sortKey-m.sortKey);let d=null;"globe"===o.projection.name&&(this.globeExtVertexArray=new ru,d=o.projection);for(const f of c){const{geometry:m,index:g,sourceLayerIndex:y}=f,v=t[g].feature;this.addFeature(f,m,g,n.availableImages,r,d,n.brightness),n.featureIndex.insert(v,m,g,y,this.index)}}update(t,n,r,o,s){const c=0!==Object.keys(t).length;c&&!this.stateDependentLayers.length||this.programConfigurations.updatePaintArrays(t,n,c?this.stateDependentLayers:this.layers,r,o,s)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(t){this.uploaded||(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,k_.members),this.indexBuffer=t.createIndexBuffer(this.indexArray),this.globeExtVertexArray&&(this.globeExtVertexBuffer=t.createVertexBuffer(this.globeExtVertexArray,aM.members))),this.programConfigurations.upload(t),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy())}addFeature(t,n,r,o,s,c,u){for(const d of n)for(const f of d){const m=f.x,g=f.y;if(m<0||m>=et||g<0||g>=et)continue;if(c){const x=c.projectTilePoint(m,g,s),w=c.upVector(s,m,g),E=this.globeExtVertexArray;Nm(E,x,w),Nm(E,x,w),Nm(E,x,w),Nm(E,x,w)}const y=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,t.sortKey),v=y.vertexLength;$f(this.layoutVertexArray,m,g,-1,-1),$f(this.layoutVertexArray,m,g,1,-1),$f(this.layoutVertexArray,m,g,1,1),$f(this.layoutVertexArray,m,g,-1,1),this.indexArray.emplaceBack(v,v+1,v+2),this.indexArray.emplaceBack(v,v+2,v+3),y.vertexLength+=4,y.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,r,{},o,s,u)}}function xy(e,t){for(let n=0;n<e.length;n++)if(wc(t,e[n]))return!0;for(let n=0;n<t.length;n++)if(wc(e,t[n]))return!0;return!!wy(e,t)}function Bm(e,t,n){return!!wc(e,t)||!!jm(t,e,n)}function AM(e,t){if(1===e.length)return bc(t,e[0]);for(let n=0;n<t.length;n++){const r=t[n];for(let o=0;o<r.length;o++)if(wc(e,r[o]))return!0}for(let n=0;n<e.length;n++)if(bc(t,e[n]))return!0;for(let n=0;n<t.length;n++)if(wy(e,t[n]))return!0;return!1}function by(e,t,n){if(e.length>1){if(wy(e,t))return!0;for(let r=0;r<t.length;r++)if(jm(t[r],e,n))return!0}for(let r=0;r<e.length;r++)if(jm(e[r],t,n))return!0;return!1}function wy(e,t){if(0===e.length||0===t.length)return!1;for(let n=0;n<e.length-1;n++){const r=e[n],o=e[n+1];for(let s=0;s<t.length-1;s++)if(Ey(r,o,t[s],t[s+1]))return!0}return!1}function Ey(e,t,n,r){return At(e,n,r)!==At(t,n,r)&&At(e,t,n)!==At(e,t,r)}function jm(e,t,n){const r=n*n;if(1===t.length)return e.distSqr(t[0])<r;for(let o=1;o<t.length;o++)if(Ty(e,t[o-1],t[o])<r)return!0;return!1}function Ty(e,t,n){const r=t.distSqr(n);if(0===r)return e.distSqr(t);const o=((e.x-t.x)*(n.x-t.x)+(e.y-t.y)*(n.y-t.y))/r;return e.distSqr(o<0?t:o>1?n:n.sub(t)._mult(o)._add(t))}function bc(e,t){let n,r,o,s=!1;for(let c=0;c<e.length;c++){n=e[c];for(let u=0,d=n.length-1;u<n.length;d=u++)r=n[u],o=n[d],r.y>t.y!=o.y>t.y&&t.x<(o.x-r.x)*(t.y-r.y)/(o.y-r.y)+r.x&&(s=!s)}return s}function wc(e,t){let n=!1;for(let r=0,o=e.length-1;r<e.length;o=r++){const s=e[r],c=e[o];s.y>t.y!=c.y>t.y&&t.x<(c.x-s.x)*(t.y-s.y)/(c.y-s.y)+s.x&&(n=!n)}return n}function Vm(e,t,n,r,o){for(const c of e)if(t<=c.x&&n<=c.y&&r>=c.x&&o>=c.y)return!0;const s=[new it(t,n),new it(t,o),new it(r,o),new it(r,n)];if(e.length>2)for(const c of s)if(wc(e,c))return!0;for(let c=0;c<e.length-1;c++)if(Um(e[c],e[c+1],s))return!0;return!1}function Um(e,t,n){const r=n[0],o=n[2];if(e.x<r.x&&t.x<r.x||e.x>o.x&&t.x>o.x||e.y<r.y&&t.y<r.y||e.y>o.y&&t.y>o.y)return!1;const s=At(e,t,n[0]);return s!==At(e,t,n[1])||s!==At(e,t,n[2])||s!==At(e,t,n[3])}function Vh(e,t,n,r,o,s){let c=t.y-e.y,u=e.x-t.x;if(s=s||0){const d=c*c+u*u;if(0===d)return!0;const f=Math.sqrt(d);c/=f,u/=f}return!((n.x-e.x)*c+(n.y-e.y)*u-s<0||(r.x-e.x)*c+(r.y-e.y)*u-s<0||(o.x-e.x)*c+(o.y-e.y)*u-s<0)}function Hf(e,t,n,r,o,s,c){return!(Vh(e,t,r,o,s,c)||Vh(t,n,r,o,s,c)||Vh(n,e,r,o,s,c)||Vh(r,o,e,t,n,c)||Vh(o,s,e,t,n,c)||Vh(s,r,e,t,n,c))}function Rl(e,t,n){const r=t.paint.get(e).value;return"constant"===r.kind?r.value:n.programConfigurations.get(t.id).getMaxValue(e)}function js(e){return Math.sqrt(e[0]*e[0]+e[1]*e[1])}function _u(e,t,n,r,o){if(!t[0]&&!t[1])return e;const s=it.convert(t)._mult(o);"viewport"===n&&s._rotate(-r);const c=[];for(let u=0;u<e.length;u++)c.push(e[u].sub(s));return c}function Gm(e,t,n,r){const o=it.convert(e)._mult(r);return"viewport"===t&&o._rotate(-n),o}re(zm,"CircleBucket",{omit:["layers"]});const PM=new gr({"circle-sort-key":new me(H.layout_circle["circle-sort-key"]),visibility:new Ot(H.layout_circle.visibility)});var RM={paint:new gr({"circle-radius":new me(H.paint_circle["circle-radius"]),"circle-color":new me(H.paint_circle["circle-color"]),"circle-blur":new me(H.paint_circle["circle-blur"]),"circle-opacity":new me(H.paint_circle["circle-opacity"]),"circle-translate":new Ot(H.paint_circle["circle-translate"]),"circle-translate-anchor":new Ot(H.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new Ot(H.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new Ot(H.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new me(H.paint_circle["circle-stroke-width"]),"circle-stroke-color":new me(H.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new me(H.paint_circle["circle-stroke-opacity"]),"circle-emissive-strength":new Ot(H.paint_circle["circle-emissive-strength"])}),layout:PM};const U1=st.create(),Uh=(e,t,n,r,o,s)=>{const c=e.transform,u="globe"===c.projection.name;let d;if("map"===s.paint.get("circle-pitch-alignment"))if(u){const m=O1(c.zoom,t.canonical)*c._pixelsPerMercatorPixel;d=Float32Array.from([m,0,0,m])}else d=c.calculatePixelsToTileUnitsMatrix(n);else d=new Float32Array([c.pixelsToGLUnits[0],0,0,c.pixelsToGLUnits[1]]);const f={u_camera_to_center_distance:e.transform.getCameraToCenterDistance(c.projection),u_matrix:e.translatePosMatrix(t.projMatrix,n,s.paint.get("circle-translate"),s.paint.get("circle-translate-anchor")),u_device_pixel_ratio:De.devicePixelRatio,u_extrude_scale:d,u_inv_rot_matrix:U1,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0],u_emissive_strength:s.paint.get("circle-emissive-strength")};if(u){f.u_inv_rot_matrix=r,f.u_merc_center=o,f.u_tile_id=[t.canonical.x,t.canonical.y,1<<t.canonical.z],f.u_zoom_transition=ri(c.zoom);const m=o[0]*et,g=o[1]*et;f.u_up_dir=c.projection.upVector(new xs(0,0,0),m,g)}return f},G1=e=>{const t=[];return"map"===e.paint.get("circle-pitch-alignment")&&t.push("PITCH_WITH_MAP"),"map"===e.paint.get("circle-pitch-scale")&&t.push("SCALE_WITH_MAP"),t};function $1(e,t,n,r,o,s,c,u,d){if(s&&e.queryGeometry.isAboveHorizon)return!1;s&&(d*=e.pixelToTileUnitsFactor);const f=e.tileID.canonical,m=n.projection.upVectorScale(f,n.center.lat,n.worldSize).metersToTile;for(const g of t)for(const y of g){const v=y.add(u),x=o&&n.elevation?n.elevation.exaggeration()*o.getElevationAt(v.x,v.y,!0):0,w=n.projection.projectTilePoint(v.x,v.y,f);if(x>0){const A=n.projection.upVector(f,v.x,v.y);w.x+=A[0]*m*x,w.y+=A[1]*m*x,w.z+=A[2]*m*x}const E=s?v:LM(w.x,w.y,w.z,r),M=s?e.tilespaceRays.map(A=>OM(A,x)):e.queryGeometry.screenGeometry,D=En.transformMat4([],[w.x,w.y,w.z,1],r);if(!c&&s?d*=D[3]/n.cameraToCenterDistance:c&&!s&&(d*=n.cameraToCenterDistance/D[3]),s){const A=xr((y.y/et+f.y)/(1<<f.z));d/=n.projection.pixelsPerMeter(A,1)/Ln(1,A)}if(Bm(M,E,d))return!0}return!1}function LM(e,t,n,r){const o=En.transformMat4([],[e,t,n,1],r);return new it(o[0]/o[3],o[1]/o[3])}const $m=Z.fromValues(0,0,0),My=Z.fromValues(0,0,1);function OM(e,t){const n=Z.create();return $m[2]=t,e.intersectsPlane($m,My,n),new it(n[0],n[1])}class Iy extends zm{}function yu(e,{width:t,height:n},r,o){if(o){if(o instanceof Uint8ClampedArray)o=new Uint8Array(o.buffer);else if(o.length!==t*n*r)throw new RangeError("mismatched image size")}else o=new Uint8Array(t*n*r);return e.width=t,e.height=n,e.data=o,e}function kM(e,t,n){const{width:r,height:o}=t;r===e.width&&o===e.height||(H1(e,t,{x:0,y:0},{x:0,y:0},{width:Math.min(e.width,r),height:Math.min(e.height,o)},n),e.width=r,e.height=o,e.data=t.data)}function H1(e,t,n,r,o,s){if(0===o.width||0===o.height)return t;if(o.width>e.width||o.height>e.height||n.x>e.width-o.width||n.y>e.height-o.height)throw new RangeError("out of range source coordinates for image copy");if(o.width>t.width||o.height>t.height||r.x>t.width-o.width||r.y>t.height-o.height)throw new RangeError("out of range destination coordinates for image copy");const c=e.data,u=t.data;for(let d=0;d<o.height;d++){const f=((n.y+d)*e.width+n.x)*s,m=((r.y+d)*t.width+r.x)*s;for(let g=0;g<o.width*s;g++)u[m+g]=c[f+g]}return t}re(Iy,"HeatmapBucket",{omit:["layers"]});class Ga{constructor(t,n){yu(this,t,1,n)}resize(t){kM(this,new Ga(t),1)}clone(){return new Ga({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(t,n,r,o,s){H1(t,n,r,o,s,1)}}class $r{constructor(t,n){yu(this,t,4,n)}resize(t){kM(this,new $r(t),4)}replace(t,n){n?this.data.set(t):this.data=t instanceof Uint8ClampedArray?new Uint8Array(t.buffer):t}clone(){return new $r({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(t,n,r,o,s){H1(t,n,r,o,s,4)}}class FM{constructor(t,n){this.width=t.width,this.height=t.height,this.data=n instanceof Uint8Array?new Float32Array(n.buffer):n}}re(Ga,"AlphaImage"),re($r,"RGBAImage");const EC=new gr({visibility:new Ot(H.layout_heatmap.visibility)});var Hm={paint:new gr({"heatmap-radius":new me(H.paint_heatmap["heatmap-radius"]),"heatmap-weight":new me(H.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new Ot(H.paint_heatmap["heatmap-intensity"]),"heatmap-color":new ff(H.paint_heatmap["heatmap-color"]),"heatmap-opacity":new Ot(H.paint_heatmap["heatmap-opacity"])}),layout:EC};function qm(e){const t={},n=e.resolution||256,r=e.clips?e.clips.length:1,o=e.image||new $r({width:n,height:r}),s=(c,u,d)=>{t[e.evaluationKey]=d;const f=e.expression.evaluate(t);f&&(o.data[c+u+0]=Math.floor(255*f.r/f.a),o.data[c+u+1]=Math.floor(255*f.g/f.a),o.data[c+u+2]=Math.floor(255*f.b/f.a),o.data[c+u+3]=Math.floor(255*f.a))};if(e.clips)for(let c=0,u=0;c<r;++c,u+=4*n)for(let d=0,f=0;d<n;d++,f+=4){const m=d/(n-1),{start:g,end:y}=e.clips[c];s(u,f,g*(1-m)+y*m)}else for(let c=0,u=0;c<n;c++,u+=4)s(0,u,c/(n-1));return o}const Dy=new gr({visibility:new Ot(H.layout_hillshade.visibility)});var Sy={paint:new gr({"hillshade-illumination-direction":new Ot(H.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new Ot(H.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new Ot(H.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new Ot(H.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new Ot(H.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new Ot(H.paint_hillshade["hillshade-accent-color"]),"hillshade-emissive-strength":new Ot(H.paint_hillshade["hillshade-emissive-strength"])}),layout:Dy};const Gh=Ce([{name:"a_pos",components:2,type:"Int16"}],4),{members:Cy}=Gh;var qf={exports:{}};function Ec(e,t,n){n=n||2;var r,o,s,c,u,d,f,m=t&&t.length,g=m?t[0]*n:e.length,y=Zf(e,0,g,n,!0),v=[];if(!y||y.next===y.prev)return v;if(m&&(y=function(w,E,M,D){var A,P,C,R=[];for(A=0,P=E.length;A<P;A++)(C=Zf(w,E[A]*D,A<P-1?E[A+1]*D:w.length,D,!1))===C.next&&(C.steiner=!0),R.push(zM(C));for(R.sort(Wf),A=0;A<R.length;A++)M=NM(R[A],M);return M}(e,t,y,n)),e.length>80*n){r=s=e[0],o=c=e[1];for(var x=n;x<g;x+=n)(u=e[x])<r&&(r=u),(d=e[x+1])<o&&(o=d),u>s&&(s=u),d>c&&(c=d);f=0!==(f=Math.max(s-r,c-o))?32767/f:0}return vu(y,v,n,r,o,f,0),v}function Zf(e,t,n,r,o){var s,c;if(o===Oy(e,t,n,r)>0)for(s=t;s<n;s+=r)c=Ly(s,e[s],e[s+1],c);else for(s=n-r;s>=t;s-=r)c=Ly(s,e[s],e[s+1],c);return c&&Wm(c,c.next)&&(wu(c),c=c.next),c}function Vs(e,t){if(!e)return e;t||(t=e);var n,r=e;do{if(n=!1,r.steiner||!Wm(r,r.next)&&0!==ii(r.prev,r,r.next))r=r.next;else{if(wu(r),(r=t=r.prev)===r.next)break;n=!0}}while(n||r!==t);return t}function vu(e,t,n,r,o,s,c){if(e){!c&&s&&function(m,g,y,v){var x=m;do{0===x.z&&(x.z=Ry(x.x,x.y,g,y,v)),x.prevZ=x.prev,x.nextZ=x.next,x=x.next}while(x!==m);x.prevZ.nextZ=null,x.prevZ=null,function(w){var E,M,D,A,P,C,R,k,N=1;do{for(M=w,w=null,P=null,C=0;M;){for(C++,D=M,R=0,E=0;E<N&&(R++,D=D.nextZ);E++);for(k=N;R>0||k>0&&D;)0!==R&&(0===k||!D||M.z<=D.z)?(A=M,M=M.nextZ,R--):(A=D,D=D.nextZ,k--),P?P.nextZ=A:w=A,A.prevZ=P,P=A;M=D}P.nextZ=null,N*=2}while(C>1)}(x)}(e,r,o,s);for(var u,d,f=e;e.prev!==e.next;)if(u=e.prev,d=e.next,s?Zm(e,r,o,s):Ay(e))t.push(u.i/n|0),t.push(e.i/n|0),t.push(d.i/n|0),wu(e),e=d.next,f=d.next;else if((e=d)===f){c?1===c?vu(e=TC(Vs(e),t,n),t,n,r,o,s,2):2===c&&Py(e,t,n,r,o,s):vu(Vs(e),t,n,r,o,s,1);break}}}function Ay(e){var t=e.prev,n=e,r=e.next;if(ii(t,n,r)>=0)return!1;for(var o=t.x,s=n.x,c=r.x,u=t.y,d=n.y,f=r.y,m=o<s?o<c?o:c:s<c?s:c,g=u<d?u<f?u:f:d<f?d:f,y=o>s?o>c?o:c:s>c?s:c,v=u>d?u>f?u:f:d>f?d:f,x=r.next;x!==t;){if(x.x>=m&&x.x<=y&&x.y>=g&&x.y<=v&&Tc(o,u,s,d,c,f,x.x,x.y)&&ii(x.prev,x,x.next)>=0)return!1;x=x.next}return!0}function Zm(e,t,n,r){var o=e.prev,s=e,c=e.next;if(ii(o,s,c)>=0)return!1;for(var u=o.x,d=s.x,f=c.x,m=o.y,g=s.y,y=c.y,v=u<d?u<f?u:f:d<f?d:f,x=m<g?m<y?m:y:g<y?g:y,w=u>d?u>f?u:f:d>f?d:f,E=m>g?m>y?m:y:g>y?g:y,M=Ry(v,x,t,n,r),D=Ry(w,E,t,n,r),A=e.prevZ,P=e.nextZ;A&&A.z>=M&&P&&P.z<=D;){if(A.x>=v&&A.x<=w&&A.y>=x&&A.y<=E&&A!==o&&A!==c&&Tc(u,m,d,g,f,y,A.x,A.y)&&ii(A.prev,A,A.next)>=0||(A=A.prevZ,P.x>=v&&P.x<=w&&P.y>=x&&P.y<=E&&P!==o&&P!==c&&Tc(u,m,d,g,f,y,P.x,P.y)&&ii(P.prev,P,P.next)>=0))return!1;P=P.nextZ}for(;A&&A.z>=M;){if(A.x>=v&&A.x<=w&&A.y>=x&&A.y<=E&&A!==o&&A!==c&&Tc(u,m,d,g,f,y,A.x,A.y)&&ii(A.prev,A,A.next)>=0)return!1;A=A.prevZ}for(;P&&P.z<=D;){if(P.x>=v&&P.x<=w&&P.y>=x&&P.y<=E&&P!==o&&P!==c&&Tc(u,m,d,g,f,y,P.x,P.y)&&ii(P.prev,P,P.next)>=0)return!1;P=P.nextZ}return!0}function TC(e,t,n){var r=e;do{var o=r.prev,s=r.next.next;!Wm(o,s)&&BM(o,r,r.next,s)&&bu(o,s)&&bu(s,o)&&(t.push(o.i/n|0),t.push(r.i/n|0),t.push(s.i/n|0),wu(r),wu(r.next),r=e=s),r=r.next}while(r!==e);return Vs(r)}function Py(e,t,n,r,o,s){var c=e;do{for(var u=c.next.next;u!==c.prev;){if(c.i!==u.i&&Z1(c,u)){var d=W1(c,u);return c=Vs(c,c.next),d=Vs(d,d.next),vu(c,t,n,r,o,s,0),void vu(d,t,n,r,o,s,0)}u=u.next}c=c.next}while(c!==e)}function Wf(e,t){return e.x-t.x}function NM(e,t){var n=function(o,s){var c,u=s,d=o.x,f=o.y,m=-1/0;do{if(f<=u.y&&f>=u.next.y&&u.next.y!==u.y){var g=u.x+(f-u.y)*(u.next.x-u.x)/(u.next.y-u.y);if(g<=d&&g>m&&(m=g,c=u.x<u.next.x?u:u.next,g===d))return c}u=u.next}while(u!==s);if(!c)return null;var y,v=c,x=c.x,w=c.y,E=1/0;u=c;do{d>=u.x&&u.x>=x&&d!==u.x&&Tc(f<w?d:m,f,x,w,f<w?m:d,f,u.x,u.y)&&(y=Math.abs(f-u.y)/(d-u.x),bu(u,o)&&(y<E||y===E&&(u.x>c.x||u.x===c.x&&q1(c,u)))&&(c=u,E=y)),u=u.next}while(u!==v);return c}(e,t);if(!n)return t;var r=W1(n,e);return Vs(r,r.next),Vs(n,n.next)}function q1(e,t){return ii(e.prev,e,t.prev)<0&&ii(t.next,e,e.next)<0}function Ry(e,t,n,r,o){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-n)*o|0)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-r)*o|0)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function zM(e){var t=e,n=e;do{(t.x<n.x||t.x===n.x&&t.y<n.y)&&(n=t),t=t.next}while(t!==e);return n}function Tc(e,t,n,r,o,s,c,u){return(o-c)*(t-u)>=(e-c)*(s-u)&&(e-c)*(r-u)>=(n-c)*(t-u)&&(n-c)*(s-u)>=(o-c)*(r-u)}function Z1(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(n,r){var o=n;do{if(o.i!==n.i&&o.next.i!==n.i&&o.i!==r.i&&o.next.i!==r.i&&BM(o,o.next,n,r))return!0;o=o.next}while(o!==n);return!1}(e,t)&&(bu(e,t)&&bu(t,e)&&function(n,r){var o=n,s=!1,c=(n.x+r.x)/2,u=(n.y+r.y)/2;do{o.y>u!=o.next.y>u&&o.next.y!==o.y&&c<(o.next.x-o.x)*(u-o.y)/(o.next.y-o.y)+o.x&&(s=!s),o=o.next}while(o!==n);return s}(e,t)&&(ii(e.prev,e,t.prev)||ii(e,t.prev,t))||Wm(e,t)&&ii(e.prev,e,e.next)>0&&ii(t.prev,t,t.next)>0)}function ii(e,t,n){return(t.y-e.y)*(n.x-t.x)-(t.x-e.x)*(n.y-t.y)}function Wm(e,t){return e.x===t.x&&e.y===t.y}function BM(e,t,n,r){var o=xu(ii(e,t,n)),s=xu(ii(e,t,r)),c=xu(ii(n,r,e)),u=xu(ii(n,r,t));return o!==s&&c!==u||!(0!==o||!Xm(e,n,t))||!(0!==s||!Xm(e,r,t))||!(0!==c||!Xm(n,e,r))||!(0!==u||!Xm(n,t,r))}function Xm(e,t,n){return t.x<=Math.max(e.x,n.x)&&t.x>=Math.min(e.x,n.x)&&t.y<=Math.max(e.y,n.y)&&t.y>=Math.min(e.y,n.y)}function xu(e){return e>0?1:e<0?-1:0}function bu(e,t){return ii(e.prev,e,e.next)<0?ii(e,t,e.next)>=0&&ii(e,e.prev,t)>=0:ii(e,t,e.prev)<0||ii(e,e.next,t)<0}function W1(e,t){var n=new $h(e.i,e.x,e.y),r=new $h(t.i,t.x,t.y),o=e.next,s=t.prev;return e.next=t,t.prev=e,n.next=o,o.prev=n,r.next=n,n.prev=r,s.next=r,r.prev=s,r}function Ly(e,t,n,r){var o=new $h(e,t,n);return r?(o.next=r.next,o.prev=r,r.next.prev=o,r.next=o):(o.prev=o,o.next=o),o}function wu(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function $h(e,t,n){this.i=e,this.x=t,this.y=n,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}function Oy(e,t,n,r){for(var o=0,s=t,c=n-r;s<n;s+=r)o+=(e[c]-e[s])*(e[s+1]+e[c+1]),c=s;return o}qf.exports=Ec,qf.exports.default=Ec,Ec.deviation=function(e,t,n,r){var o=t&&t.length,s=Math.abs(Oy(e,0,o?t[0]*n:e.length,n));if(o)for(var c=0,u=t.length;c<u;c++)s-=Math.abs(Oy(e,t[c]*n,c<u-1?t[c+1]*n:e.length,n));var d=0;for(c=0;c<r.length;c+=3){var f=r[c]*n,m=r[c+1]*n,g=r[c+2]*n;d+=Math.abs((e[f]-e[g])*(e[m+1]-e[f+1])-(e[f]-e[m])*(e[g+1]-e[f+1]))}return 0===s&&0===d?0:Math.abs((d-s)/s)},Ec.flatten=function(e){for(var t=e[0][0].length,n={vertices:[],holes:[],dimensions:t},r=0,o=0;o<e.length;o++){for(var s=0;s<e[o].length;s++)for(var c=0;c<t;c++)n.vertices.push(e[o][s][c]);o>0&&n.holes.push(r+=e[o-1].length)}return n};var Xf=rr(qf.exports);function ky(e,t){const n=e.length;if(n<=1)return[e];const r=[];let o,s;for(let c=0;c<n;c++){const u=Lt(e[c]);0!==u&&(e[c].area=Math.abs(u),void 0===s&&(s=u<0),s===u<0?(o&&r.push(o),o=[e[c]]):o.push(e[c]))}if(o&&r.push(o),t>1)for(let c=0;c<r.length;c++)r[c].length<=t||(rc(r[c],t,1,r[c].length-1,X1),r[c]=r[c].slice(0,t));return r}function X1(e,t){return t.area-e.area}function Y1(e,t,n){const r=n.patternDependencies;let o=!1;for(const s of t){const c=s.paint.get(`${e}-pattern`);c.isConstant()||(o=!0);const u=c.constantOr(null);u&&(o=!0,r[u]=!0)}return o}function Fy(e,t,n,r,o){const s=o.patternDependencies;for(const c of t){const u=c.paint.get(`${e}-pattern`).value;if("constant"!==u.kind){let d=u.evaluate({zoom:r},n,{},o.availableImages);d=d&&d.name?d.name:d,s[d]=!0,n.patterns[c.id]=d}}return n}class Eu{constructor(t){this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(n=>n.fqid),this.index=t.index,this.hasPattern=!1,this.patternFeatures=[],this.layoutVertexArray=new Xo,this.indexArray=new Kr,this.indexArray2=new Tl,this.programConfigurations=new _c(t.layers,t.zoom),this.segments=new Rn,this.segments2=new Rn,this.stateDependentLayerIds=this.layers.filter(n=>n.isStateDependent()).map(n=>n.id),this.projection=t.projection}populate(t,n,r,o){this.hasPattern=Y1("fill",this.layers,n);const s=this.layers[0].layout.get("fill-sort-key"),c=[];for(const{feature:u,id:d,index:f,sourceLayerIndex:m}of t){const g=this.layers[0]._featureFilter.needGeometry,y=Ua(u,g);if(!this.layers[0]._featureFilter.filter(new ar(this.zoom),y,r))continue;const v=s?s.evaluate(y,{},r,n.availableImages):void 0,x={id:d,properties:u.properties,type:u.type,sourceLayerIndex:m,index:f,geometry:g?y.geometry:ca(u,r,o),patterns:{},sortKey:v};c.push(x)}s&&c.sort((u,d)=>u.sortKey-d.sortKey);for(const u of c){const{geometry:d,index:f,sourceLayerIndex:m}=u;if(this.hasPattern){const g=Fy("fill",this.layers,u,this.zoom,n);this.patternFeatures.push(g)}else this.addFeature(u,d,f,r,{},n.availableImages,n.brightness);n.featureIndex.insert(t[f].feature,d,f,m,this.index)}}update(t,n,r,o,s){const c=0!==Object.keys(t).length;c&&!this.stateDependentLayers.length||this.programConfigurations.updatePaintArrays(t,n,c?this.stateDependentLayers:this.layers,r,o,s)}addFeatures(t,n,r,o,s,c){for(const u of this.patternFeatures)this.addFeature(u,u.geometry,u.index,n,r,o,c)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(t){this.uploaded||(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,Cy),this.indexBuffer=t.createIndexBuffer(this.indexArray),this.indexBuffer2=t.createIndexBuffer(this.indexArray2)),this.programConfigurations.upload(t),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.indexBuffer2.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.segments2.destroy())}addFeature(t,n,r,o,s,c=[],u){for(const d of ky(n,500)){let f=0;for(const w of d)f+=w.length;const m=this.segments.prepareSegment(f,this.layoutVertexArray,this.indexArray),g=m.vertexLength,y=[],v=[];for(const w of d){if(0===w.length)continue;w!==d[0]&&v.push(y.length/2);const E=this.segments2.prepareSegment(w.length,this.layoutVertexArray,this.indexArray2),M=E.vertexLength;this.layoutVertexArray.emplaceBack(w[0].x,w[0].y),this.indexArray2.emplaceBack(M+w.length-1,M),y.push(w[0].x),y.push(w[0].y);for(let D=1;D<w.length;D++)this.layoutVertexArray.emplaceBack(w[D].x,w[D].y),this.indexArray2.emplaceBack(M+D-1,M+D),y.push(w[D].x),y.push(w[D].y);E.vertexLength+=w.length,E.primitiveLength+=w.length}const x=Xf(y,v);for(let w=0;w<x.length;w+=3)this.indexArray.emplaceBack(g+x[w],g+x[w+1],g+x[w+2]);m.vertexLength+=f,m.primitiveLength+=x.length/3}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,r,s,c,o,u)}}re(Eu,"FillBucket",{omit:["layers","patternFeatures"]});const jM=new gr({"fill-sort-key":new me(H.layout_fill["fill-sort-key"]),visibility:new Ot(H.layout_fill.visibility)});var Hh={paint:new gr({"fill-antialias":new Ot(H.paint_fill["fill-antialias"]),"fill-opacity":new me(H.paint_fill["fill-opacity"]),"fill-color":new me(H.paint_fill["fill-color"]),"fill-outline-color":new me(H.paint_fill["fill-outline-color"]),"fill-translate":new Ot(H.paint_fill["fill-translate"]),"fill-translate-anchor":new Ot(H.paint_fill["fill-translate-anchor"]),"fill-pattern":new me(H.paint_fill["fill-pattern"]),"fill-emissive-strength":new Ot(H.paint_fill["fill-emissive-strength"])}),layout:jM};const qh=Ce([{name:"a_pos_normal_ed",components:4,type:"Int16"}]),VM=Ce([{name:"a_pos_end",components:4,type:"Int16"},{name:"a_angular_offset_factor",components:1,type:"Int16"}]),K1=Ce([{name:"a_centroid_pos",components:2,type:"Uint16"}]),J1=Ce([{name:"a_hidden_by_landmark",components:1,type:"Uint8"}]),UM=Ce([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]),{members:GM}=qh;var Zh={},$M=ya,Ym=Yf;function Yf(e,t,n,r,o){this.properties={},this.extent=n,this.type=0,this._pbf=e,this._geometry=-1,this._keys=r,this._values=o,e.readFields(Ny,this,t)}function Ny(e,t,n){1==e?t.id=n.readVarint():2==e?function(r,o){for(var s=r.readVarint()+r.pos;r.pos<s;){var c=o._keys[r.readVarint()],u=o._values[r.readVarint()];o.properties[c]=u}}(n,t):3==e?t.type=n.readVarint():4==e&&(t._geometry=n.pos)}function Q1(e){for(var t,n,r=0,o=0,s=e.length,c=s-1;o<s;c=o++)r+=((n=e[c]).x-(t=e[o]).x)*(t.y+n.y);return r}Yf.types=["Unknown","Point","LineString","Polygon"],Yf.prototype.loadGeometry=function(){var e=this._pbf;e.pos=this._geometry;for(var t,n=e.readVarint()+e.pos,r=1,o=0,s=0,c=0,u=[];e.pos<n;){if(o<=0){var d=e.readVarint();r=7&d,o=d>>3}if(o--,1===r||2===r)s+=e.readSVarint(),c+=e.readSVarint(),1===r&&(t&&u.push(t),t=[]),t.push(new $M(s,c));else{if(7!==r)throw new Error("unknown command "+r);t&&t.push(t[0].clone())}}return t&&u.push(t),u},Yf.prototype.bbox=function(){var e=this._pbf;e.pos=this._geometry;for(var t=e.readVarint()+e.pos,n=1,r=0,o=0,s=0,c=1/0,u=-1/0,d=1/0,f=-1/0;e.pos<t;){if(r<=0){var m=e.readVarint();n=7&m,r=m>>3}if(r--,1===n||2===n)(o+=e.readSVarint())<c&&(c=o),o>u&&(u=o),(s+=e.readSVarint())<d&&(d=s),s>f&&(f=s);else if(7!==n)throw new Error("unknown command "+n)}return[c,d,u,f]},Yf.prototype.toGeoJSON=function(e,t,n){var r,o,s=this.extent*Math.pow(2,n),c=this.extent*e,u=this.extent*t,d=this.loadGeometry(),f=Yf.types[this.type];function m(v){for(var x=0;x<v.length;x++){var w=v[x];v[x]=[360*(w.x+c)/s-180,360/Math.PI*Math.atan(Math.exp((180-360*(w.y+u)/s)*Math.PI/180))-90]}}switch(this.type){case 1:var g=[];for(r=0;r<d.length;r++)g[r]=d[r][0];m(d=g);break;case 2:for(r=0;r<d.length;r++)m(d[r]);break;case 3:for(d=function(v){var x=v.length;if(x<=1)return[v];for(var w,E,M=[],D=0;D<x;D++){var A=Q1(v[D]);0!==A&&(void 0===E&&(E=A<0),E===A<0?(w&&M.push(w),w=[v[D]]):w.push(v[D]))}return w&&M.push(w),M}(d),r=0;r<d.length;r++)for(o=0;o<d[r].length;o++)m(d[r][o])}1===d.length?d=d[0]:f="Multi"+f;var y={type:"Feature",geometry:{type:f,coordinates:d},properties:this.properties};return"id"in this&&(y.id=this.id),y};var HM=Ym,tb=zy;function zy(e,t){this.version=1,this.name=null,this.extent=4096,this.length=0,this._pbf=e,this._keys=[],this._values=[],this._features=[],e.readFields(qM,this,t),this.length=this._features.length}function qM(e,t,n){15===e?t.version=n.readVarint():1===e?t.name=n.readString():5===e?t.extent=n.readVarint():2===e?t._features.push(n.pos):3===e?t._keys.push(n.readString()):4===e&&t._values.push(function(r){for(var o=null,s=r.readVarint()+r.pos;r.pos<s;){var c=r.readVarint()>>3;o=1===c?r.readString():2===c?r.readFloat():3===c?r.readDouble():4===c?r.readVarint64():5===c?r.readVarint():6===c?r.readSVarint():7===c?r.readBoolean():null}return o}(n))}zy.prototype.feature=function(e){if(e<0||e>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[e];var t=this._pbf.readVarint()+this._pbf.pos;return new HM(this._pbf,t,this.extent,this._keys,this._values)};var eb=tb;function ZM(e,t,n){if(3===e){var r=new eb(n,n.readVarint()+n.pos);r.length&&(t[r.name]=r)}}var By=Zh.VectorTile=function(e,t){this.layers=e.readFields(ZM,{},t)},jy=Zh.VectorTileFeature=Ym;function Kf(e,t,n,r){const o=[],s=0===r?(c,u,d,f,m,g)=>{c.push(new it(g,d+(g-u)/(f-u)*(m-d)))}:(c,u,d,f,m,g)=>{c.push(new it(u+(g-d)/(m-d)*(f-u),g))};for(const c of e){const u=[];for(const d of c){if(d.length<=2)continue;const f=[];for(let y=0;y<d.length-1;y++){const v=d[y].x,x=d[y].y,w=d[y+1].x,E=d[y+1].y,M=0===r?v:x,D=0===r?w:E;M<t?D>t&&s(f,v,x,w,E,t):M>n?D<n&&s(f,v,x,w,E,n):f.push(d[y]),D<t&&M>=t&&s(f,v,x,w,E,t),D>n&&M<=n&&s(f,v,x,w,E,n)}let m=d[d.length-1];const g=0===r?m.x:m.y;g>=t&&g<=n&&f.push(m),f.length&&(m=f[f.length-1],f[0].x===m.x&&f[0].y===m.y||f.push(f[0]),u.push(f))}u.length&&o.push(u)}return o}Zh.VectorTileLayer=tb;class Vy{constructor(t){this._stringToNumber={},this._numberToString=[];for(let n=0;n<t.length;n++){const r=t[n];this._stringToNumber[r]=n,this._numberToString[n]=r}}encode(t){return this._stringToNumber[t]}decode(t){return this._numberToString[t]}}var $a={
/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */
read:function(e,t,n,r,o){var s,c,u=8*o-r-1,d=(1<<u)-1,f=d>>1,m=-7,g=n?o-1:0,y=n?-1:1,v=e[t+g];for(g+=y,s=v&(1<<-m)-1,v>>=-m,m+=u;m>0;s=256*s+e[t+g],g+=y,m-=8);for(c=s&(1<<-m)-1,s>>=-m,m+=r;m>0;c=256*c+e[t+g],g+=y,m-=8);if(0===s)s=1-f;else{if(s===d)return c?NaN:1/0*(v?-1:1);c+=Math.pow(2,r),s-=f}return(v?-1:1)*c*Math.pow(2,s-r)},write:function(e,t,n,r,o,s){var c,u,d,f=8*s-o-1,m=(1<<f)-1,g=m>>1,y=23===o?Math.pow(2,-24)-Math.pow(2,-77):0,v=r?0:s-1,x=r?1:-1,w=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(u=isNaN(t)?1:0,c=m):(c=Math.floor(Math.log(t)/Math.LN2),t*(d=Math.pow(2,-c))<1&&(c--,d*=2),(t+=c+g>=1?y/d:y*Math.pow(2,1-g))*d>=2&&(c++,d/=2),c+g>=m?(u=0,c=m):c+g>=1?(u=(t*d-1)*Math.pow(2,o),c+=g):(u=t*Math.pow(2,g-1)*Math.pow(2,o),c=0));o>=8;e[n+v]=255&u,v+=x,u/=256,o-=8);for(c=c<<o|u,f+=o;f>0;e[n+v]=255&c,v+=x,c/=256,f-=8);e[n+v-x]|=128*w}},Uy=tr,Gy=$a;function tr(e){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(e)?e:new Uint8Array(e||0),this.pos=0,this.type=0,this.length=this.buf.length}tr.Varint=0,tr.Fixed64=1,tr.Bytes=2,tr.Fixed32=5;var ua=4294967296,Km=1/ua,nb=typeof TextDecoder>"u"?null:new TextDecoder("utf8");function Mc(e){return e.type===tr.Bytes?e.readVarint()+e.pos:e.pos+1}function Jm(e,t,n){var r=t<=16383?1:t<=2097151?2:t<=268435455?3:Math.floor(Math.log(t)/(7*Math.LN2));n.realloc(r);for(var o=n.pos-1;o>=e;o--)n.buf[o+r]=n.buf[o]}function Ll(e,t){for(var n=0;n<e.length;n++)t.writeVarint(e[n])}function rb(e,t){for(var n=0;n<e.length;n++)t.writeSVarint(e[n])}function WM(e,t){for(var n=0;n<e.length;n++)t.writeFloat(e[n])}function MC(e,t){for(var n=0;n<e.length;n++)t.writeDouble(e[n])}function hi(e,t){for(var n=0;n<e.length;n++)t.writeBoolean(e[n])}function XM(e,t){for(var n=0;n<e.length;n++)t.writeFixed32(e[n])}function $y(e,t){for(var n=0;n<e.length;n++)t.writeSFixed32(e[n])}function YM(e,t){for(var n=0;n<e.length;n++)t.writeFixed64(e[n])}function KM(e,t){for(var n=0;n<e.length;n++)t.writeSFixed64(e[n])}function Xh(e,t){return(e[t]|e[t+1]<<8|e[t+2]<<16)+16777216*e[t+3]}function Tu(e,t,n){e[n]=t,e[n+1]=t>>>8,e[n+2]=t>>>16,e[n+3]=t>>>24}function Hy(e,t){return(e[t]|e[t+1]<<8|e[t+2]<<16)+(e[t+3]<<24)}tr.prototype={destroy:function(){this.buf=null},readFields:function(e,t,n){for(n=n||this.length;this.pos<n;){var r=this.readVarint(),o=r>>3,s=this.pos;this.type=7&r,e(o,t,this),this.pos===s&&this.skip(r)}return t},readMessage:function(e,t){return this.readFields(e,t,this.readVarint()+this.pos)},readFixed32:function(){var e=Xh(this.buf,this.pos);return this.pos+=4,e},readSFixed32:function(){var e=Hy(this.buf,this.pos);return this.pos+=4,e},readFixed64:function(){var e=Xh(this.buf,this.pos)+Xh(this.buf,this.pos+4)*ua;return this.pos+=8,e},readSFixed64:function(){var e=Xh(this.buf,this.pos)+Hy(this.buf,this.pos+4)*ua;return this.pos+=8,e},readFloat:function(){var e=Gy.read(this.buf,this.pos,!0,23,4);return this.pos+=4,e},readDouble:function(){var e=Gy.read(this.buf,this.pos,!0,52,8);return this.pos+=8,e},readVarint:function(e){var t,n,r=this.buf;return t=127&(n=r[this.pos++]),n<128?t:(t|=(127&(n=r[this.pos++]))<<7,n<128?t:(t|=(127&(n=r[this.pos++]))<<14,n<128?t:(t|=(127&(n=r[this.pos++]))<<21,n<128?t:function(o,s,c){var u,d,f=c.buf;if(u=(112&(d=f[c.pos++]))>>4,d<128||(u|=(127&(d=f[c.pos++]))<<3,d<128)||(u|=(127&(d=f[c.pos++]))<<10,d<128)||(u|=(127&(d=f[c.pos++]))<<17,d<128)||(u|=(127&(d=f[c.pos++]))<<24,d<128)||(u|=(1&(d=f[c.pos++]))<<31,d<128))return function Wh(e,t,n){return n?4294967296*t+(e>>>0):4294967296*(t>>>0)+(e>>>0)}(o,u,s);throw new Error("Expected varint not more than 10 bytes")}(t|=(15&(n=r[this.pos]))<<28,e,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var e=this.readVarint();return e%2==1?(e+1)/-2:e/2},readBoolean:function(){return!!this.readVarint()},readString:function(){var e=this.readVarint()+this.pos,t=this.pos;return this.pos=e,e-t>=12&&nb?nb.decode(this.buf.subarray(t,e)):function(n,r,o){for(var s="",c=r;c<o;){var u,d,f,m=n[c],g=null,y=m>239?4:m>223?3:m>191?2:1;if(c+y>o)break;1===y?m<128&&(g=m):2===y?128==(192&(u=n[c+1]))&&(g=(31&m)<<6|63&u)<=127&&(g=null):3===y?(d=n[c+2],128==(192&(u=n[c+1]))&&128==(192&d)&&((g=(15&m)<<12|(63&u)<<6|63&d)<=2047||g>=55296&&g<=57343)&&(g=null)):4===y&&(d=n[c+2],f=n[c+3],128==(192&(u=n[c+1]))&&128==(192&d)&&128==(192&f)&&((g=(15&m)<<18|(63&u)<<12|(63&d)<<6|63&f)<=65535||g>=1114112)&&(g=null)),null===g?(g=65533,y=1):g>65535&&(g-=65536,s+=String.fromCharCode(g>>>10&1023|55296),g=56320|1023&g),s+=String.fromCharCode(g),c+=y}return s}(this.buf,t,e)},readBytes:function(){var e=this.readVarint()+this.pos,t=this.buf.subarray(this.pos,e);return this.pos=e,t},readPackedVarint:function(e,t){if(this.type!==tr.Bytes)return e.push(this.readVarint(t));var n=Mc(this);for(e=e||[];this.pos<n;)e.push(this.readVarint(t));return e},readPackedSVarint:function(e){if(this.type!==tr.Bytes)return e.push(this.readSVarint());var t=Mc(this);for(e=e||[];this.pos<t;)e.push(this.readSVarint());return e},readPackedBoolean:function(e){if(this.type!==tr.Bytes)return e.push(this.readBoolean());var t=Mc(this);for(e=e||[];this.pos<t;)e.push(this.readBoolean());return e},readPackedFloat:function(e){if(this.type!==tr.Bytes)return e.push(this.readFloat());var t=Mc(this);for(e=e||[];this.pos<t;)e.push(this.readFloat());return e},readPackedDouble:function(e){if(this.type!==tr.Bytes)return e.push(this.readDouble());var t=Mc(this);for(e=e||[];this.pos<t;)e.push(this.readDouble());return e},readPackedFixed32:function(e){if(this.type!==tr.Bytes)return e.push(this.readFixed32());var t=Mc(this);for(e=e||[];this.pos<t;)e.push(this.readFixed32());return e},readPackedSFixed32:function(e){if(this.type!==tr.Bytes)return e.push(this.readSFixed32());var t=Mc(this);for(e=e||[];this.pos<t;)e.push(this.readSFixed32());return e},readPackedFixed64:function(e){if(this.type!==tr.Bytes)return e.push(this.readFixed64());var t=Mc(this);for(e=e||[];this.pos<t;)e.push(this.readFixed64());return e},readPackedSFixed64:function(e){if(this.type!==tr.Bytes)return e.push(this.readSFixed64());var t=Mc(this);for(e=e||[];this.pos<t;)e.push(this.readSFixed64());return e},skip:function(e){var t=7&e;if(t===tr.Varint)for(;this.buf[this.pos++]>127;);else if(t===tr.Bytes)this.pos=this.readVarint()+this.pos;else if(t===tr.Fixed32)this.pos+=4;else{if(t!==tr.Fixed64)throw new Error("Unimplemented type: "+t);this.pos+=8}},writeTag:function(e,t){this.writeVarint(e<<3|t)},realloc:function(e){for(var t=this.length||16;t<this.pos+e;)t*=2;if(t!==this.length){var n=new Uint8Array(t);n.set(this.buf),this.buf=n,this.length=t}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(e){this.realloc(4),Tu(this.buf,e,this.pos),this.pos+=4},writeSFixed32:function(e){this.realloc(4),Tu(this.buf,e,this.pos),this.pos+=4},writeFixed64:function(e){this.realloc(8),Tu(this.buf,-1&e,this.pos),Tu(this.buf,Math.floor(e*Km),this.pos+4),this.pos+=8},writeSFixed64:function(e){this.realloc(8),Tu(this.buf,-1&e,this.pos),Tu(this.buf,Math.floor(e*Km),this.pos+4),this.pos+=8},writeVarint:function(e){(e=+e||0)>268435455||e<0?function(t,n){var r,o,s,u;if(t>=0?(r=t%4294967296|0,o=t/4294967296|0):(o=~(-t/4294967296),4294967295^(r=~(-t%4294967296))?r=r+1|0:(r=0,o=o+1|0)),t>=0x10000000000000000||t<-0x10000000000000000)throw new Error("Given varint doesn't fit into 10 bytes");n.realloc(10),s=r,(u=n).buf[u.pos++]=127&s|128,s>>>=7,u.buf[u.pos++]=127&s|128,s>>>=7,u.buf[u.pos++]=127&s|128,s>>>=7,u.buf[u.pos++]=127&s|128,u.buf[u.pos]=127&(s>>>=7),function(s,c){var u=(7&s)<<4;c.buf[c.pos++]|=u|((s>>>=3)?128:0),s&&(c.buf[c.pos++]=127&s|((s>>>=7)?128:0),s&&(c.buf[c.pos++]=127&s|((s>>>=7)?128:0),s&&(c.buf[c.pos++]=127&s|((s>>>=7)?128:0),s&&(c.buf[c.pos++]=127&s|((s>>>=7)?128:0),s&&(c.buf[c.pos++]=127&s)))))}(o,n)}(e,this):(this.realloc(4),this.buf[this.pos++]=127&e|(e>127?128:0),e<=127||(this.buf[this.pos++]=127&(e>>>=7)|(e>127?128:0),e<=127||(this.buf[this.pos++]=127&(e>>>=7)|(e>127?128:0),e<=127||(this.buf[this.pos++]=e>>>7&127))))},writeSVarint:function(e){this.writeVarint(e<0?2*-e-1:2*e)},writeBoolean:function(e){this.writeVarint(!!e)},writeString:function(e){e=String(e),this.realloc(4*e.length),this.pos++;var t=this.pos;this.pos=function(r,o,s){for(var c,u,d=0;d<o.length;d++){if((c=o.charCodeAt(d))>55295&&c<57344){if(!u){c>56319||d+1===o.length?(r[s++]=239,r[s++]=191,r[s++]=189):u=c;continue}if(c<56320){r[s++]=239,r[s++]=191,r[s++]=189,u=c;continue}c=u-55296<<10|c-56320|65536,u=null}else u&&(r[s++]=239,r[s++]=191,r[s++]=189,u=null);c<128?r[s++]=c:(c<2048?r[s++]=c>>6|192:(c<65536?r[s++]=c>>12|224:(r[s++]=c>>18|240,r[s++]=c>>12&63|128),r[s++]=c>>6&63|128),r[s++]=63&c|128)}return s}(this.buf,e,this.pos);var n=this.pos-t;n>=128&&Jm(t,n,this),this.pos=t-1,this.writeVarint(n),this.pos+=n},writeFloat:function(e){this.realloc(4),Gy.write(this.buf,e,this.pos,!0,23,4),this.pos+=4},writeDouble:function(e){this.realloc(8),Gy.write(this.buf,e,this.pos,!0,52,8),this.pos+=8},writeBytes:function(e){var t=e.length;this.writeVarint(t),this.realloc(t);for(var n=0;n<t;n++)this.buf[this.pos++]=e[n]},writeRawMessage:function(e,t){this.pos++;var n=this.pos;e(t,this);var r=this.pos-n;r>=128&&Jm(n,r,this),this.pos=n-1,this.writeVarint(r),this.pos+=r},writeMessage:function(e,t,n){this.writeTag(e,tr.Bytes),this.writeRawMessage(t,n)},writePackedVarint:function(e,t){t.length&&this.writeMessage(e,Ll,t)},writePackedSVarint:function(e,t){t.length&&this.writeMessage(e,rb,t)},writePackedBoolean:function(e,t){t.length&&this.writeMessage(e,hi,t)},writePackedFloat:function(e,t){t.length&&this.writeMessage(e,WM,t)},writePackedDouble:function(e,t){t.length&&this.writeMessage(e,MC,t)},writePackedFixed32:function(e,t){t.length&&this.writeMessage(e,XM,t)},writePackedSFixed32:function(e,t){t.length&&this.writeMessage(e,$y,t)},writePackedFixed64:function(e,t){t.length&&this.writeMessage(e,YM,t)},writePackedSFixed64:function(e,t){t.length&&this.writeMessage(e,KM,t)},writeBytesField:function(e,t){this.writeTag(e,tr.Bytes),this.writeBytes(t)},writeFixed32Field:function(e,t){this.writeTag(e,tr.Fixed32),this.writeFixed32(t)},writeSFixed32Field:function(e,t){this.writeTag(e,tr.Fixed32),this.writeSFixed32(t)},writeFixed64Field:function(e,t){this.writeTag(e,tr.Fixed64),this.writeFixed64(t)},writeSFixed64Field:function(e,t){this.writeTag(e,tr.Fixed64),this.writeSFixed64(t)},writeVarintField:function(e,t){this.writeTag(e,tr.Varint),this.writeVarint(t)},writeSVarintField:function(e,t){this.writeTag(e,tr.Varint),this.writeSVarint(t)},writeStringField:function(e,t){this.writeTag(e,tr.Bytes),this.writeString(t)},writeFloatField:function(e,t){this.writeTag(e,tr.Fixed32),this.writeFloat(t)},writeDoubleField:function(e,t){this.writeTag(e,tr.Fixed64),this.writeDouble(t)},writeBooleanField:function(e,t){this.writeVarintField(e,!!t)}};var Qm=rr(Uy);const ib=["tile","layer","source","sourceLayer","state"];class qy{constructor(t,n,r,o,s){this.type="Feature",this._vectorTileFeature=t,this._z=n,this._x=r,this._y=o,this.properties=t.properties,this.id=s}get geometry(){return void 0===this._geometry&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._x,this._y,this._z).geometry),this._geometry}set geometry(t){this._geometry=t}toJSON(){const t={type:"Feature",state:void 0,geometry:this.geometry,properties:this.properties};void 0!==this.id&&(t.id=this.id);for(const n of ib)void 0!==this[n]&&(t[n]=this[n]);return t}}class JM{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(t,n,r){const o=String(n);if(this.stateChanges[t]=this.stateChanges[t]||{},this.stateChanges[t][o]=this.stateChanges[t][o]||{},Wt(this.stateChanges[t][o],r),null===this.deletedStates[t]){this.deletedStates[t]={};for(const s in this.state[t])s!==o&&(this.deletedStates[t][s]=null)}else if(this.deletedStates[t]&&null===this.deletedStates[t][o]){this.deletedStates[t][o]={};for(const s in this.state[t][o])r[s]||(this.deletedStates[t][o][s]=null)}else for(const s in r)this.deletedStates[t]&&this.deletedStates[t][o]&&null===this.deletedStates[t][o][s]&&delete this.deletedStates[t][o][s]}removeFeatureState(t,n,r){if(null===this.deletedStates[t])return;const o=String(n);if(this.deletedStates[t]=this.deletedStates[t]||{},r&&void 0!==n)null!==this.deletedStates[t][o]&&(this.deletedStates[t][o]=this.deletedStates[t][o]||{},this.deletedStates[t][o][r]=null);else if(void 0!==n)if(this.stateChanges[t]&&this.stateChanges[t][o])for(r in this.deletedStates[t][o]={},this.stateChanges[t][o])this.deletedStates[t][o][r]=null;else this.deletedStates[t][o]=null;else this.deletedStates[t]=null}getState(t,n){const r=String(n),o=Wt({},(this.state[t]||{})[r],(this.stateChanges[t]||{})[r]);if(null===this.deletedStates[t])return{};if(this.deletedStates[t]){const s=this.deletedStates[t][n];if(null===s)return{};for(const c in s)delete o[c]}return o}initializeTileState(t,n){t.setFeatureState(this.state,n)}coalesceChanges(t,n){const r={};for(const o in this.stateChanges){this.state[o]=this.state[o]||{};const s={};for(const c in this.stateChanges[o])this.state[o][c]||(this.state[o][c]={}),Wt(this.state[o][c],this.stateChanges[o][c]),s[c]=this.state[o][c];r[o]=s}for(const o in this.deletedStates){this.state[o]=this.state[o]||{};const s={};if(null===this.deletedStates[o])for(const c in this.state[o])s[c]={},this.state[o][c]={};else for(const c in this.deletedStates[o]){if(null===this.deletedStates[o][c])this.state[o][c]={};else if(this.state[o][c])for(const u of Object.keys(this.deletedStates[o][c]))delete this.state[o][c][u];s[c]=this.state[o][c]}r[o]=r[o]||{},Wt(r[o],s)}if(this.stateChanges={},this.deletedStates={},0!==Object.keys(r).length)for(const o in t)t[o].setFeatureState(r,n)}}class ob{constructor(t){this.size=t,this.minimums=[],this.maximums=[],this.leaves=[]}getElevation(t,n){const r=this.toIdx(t,n);return{min:this.minimums[r],max:this.maximums[r]}}isLeaf(t,n){return this.leaves[this.toIdx(t,n)]}toIdx(t,n){return n*this.size+t}}function sb(e,t,n,r){let o=0,s=Number.MAX_VALUE;for(let c=0;c<3;c++)if(Math.abs(r[c])<1e-15){if(n[c]<e[c]||n[c]>t[c])return null}else{const u=1/r[c];let d=(e[c]-n[c])*u,f=(t[c]-n[c])*u;if(d>f){const m=d;d=f,f=m}if(d>o&&(o=d),f<s&&(s=f),o>s)return null}return o}function Zy(e,t,n,r,o,s,c,u,d,f,m){const g=r-e,y=o-t,v=s-n,x=c-e,w=u-t,E=d-n,M=m[1]*E-m[2]*w,D=m[2]*x-m[0]*E,A=m[0]*w-m[1]*x,P=g*M+y*D+v*A;if(Math.abs(P)<1e-15)return null;const C=1/P,R=f[0]-e,k=f[1]-t,N=f[2]-n,z=(R*M+k*D+N*A)*C;if(z<0||z>1)return null;const B=k*v-N*y,U=N*g-R*v,$=R*y-k*g,W=(m[0]*B+m[1]*U+m[2]*$)*C;return W<0||z+W>1?null:(x*B+w*U+E*$)*C}function Mu(e,t,n){return(e-t)/(n-t)}function Ha(e,t,n,r,o,s,c,u,d){const f=1<<n,m=s-r,g=c-o,y=(e+1)/f*m+r,v=(t+0)/f*g+o,x=(t+1)/f*g+o;u[0]=(e+0)/f*m+r,u[1]=v,d[0]=y,d[1]=x}class Iu{constructor(t){if(this.maximums=[],this.minimums=[],this.leaves=[],this.childOffsets=[],this.nodeCount=0,this.dem=t,this._siblingOffset=[[0,0],[1,0],[0,1],[1,1]],!this.dem)return;const n=function(s){const c=Math.ceil(Math.log2(s.dim/8)),u=[];let d=Math.ceil(Math.pow(2,c));const f=1/d,m=(v,x,w,E,M)=>{const D=E?1:0,A=(v+1)*w-D,P=x*w,C=(x+1)*w-D;M[0]=v*w,M[1]=P,M[2]=A,M[3]=C};let g=new ob(d);const y=[];for(let v=0;v<d*d;v++){m(v%d,Math.floor(v/d),f,!1,y);const x=Ic(y[0],y[1],s),w=Ic(y[2],y[1],s),E=Ic(y[2],y[3],s),M=Ic(y[0],y[3],s);g.minimums.push(Math.min(x,w,E,M)),g.maximums.push(Math.max(x,w,E,M)),g.leaves.push(1)}for(u.push(g),d/=2;d>=1;d/=2){const v=u[u.length-1];g=new ob(d);for(let x=0;x<d*d;x++){m(x%d,Math.floor(x/d),2,!0,y);const w=v.getElevation(y[0],y[1]),E=v.getElevation(y[2],y[1]),M=v.getElevation(y[2],y[3]),D=v.getElevation(y[0],y[3]),A=v.isLeaf(y[0],y[1]),P=v.isLeaf(y[2],y[1]),C=v.isLeaf(y[2],y[3]),R=v.isLeaf(y[0],y[3]),k=Math.min(w.min,E.min,M.min,D.min),N=Math.max(w.max,E.max,M.max,D.max),z=A&&P&&C&&R;g.maximums.push(N),g.minimums.push(k),g.leaves.push(N-k<=5&&z?1:0)}u.push(g)}return u}(this.dem),r=n.length-1,o=n[r];this._addNode(o.minimums[0],o.maximums[0],o.leaves[0]),this._construct(n,0,0,r,0)}raycastRoot(t,n,r,o,s,c,u=1){return sb([t,n,-100],[r,o,this.maximums[0]*u],s,c)}raycast(t,n,r,o,s,c,u=1){if(!this.nodeCount)return null;const d=this.raycastRoot(t,n,r,o,s,c,u);if(null==d)return null;const f=[],m=[],g=[],y=[],v=[{idx:0,t:d,nodex:0,nodey:0,depth:0}];for(;v.length>0;){const{idx:x,t:w,nodex:E,nodey:M,depth:D}=v.pop();if(this.leaves[x]){Ha(E,M,D,t,n,r,o,g,y);const P=1<<D,C=(E+0)/P,R=(E+1)/P,k=(M+0)/P,N=(M+1)/P,z=Ic(C,k,this.dem)*u,B=Ic(R,k,this.dem)*u,U=Ic(R,N,this.dem)*u,$=Ic(C,N,this.dem)*u,W=Zy(g[0],g[1],z,y[0],g[1],B,y[0],y[1],U,s,c),V=Zy(y[0],y[1],U,g[0],y[1],$,g[0],g[1],z,s,c),K=Math.min(null!==W?W:Number.MAX_VALUE,null!==V?V:Number.MAX_VALUE);if(K!==Number.MAX_VALUE)return K;{const Q=Z.scaleAndAdd([],s,c,w);if(ab(z,B,$,U,Mu(Q[0],g[0],y[0]),Mu(Q[1],g[1],y[1]))>=Q[2])return w}continue}let A=0;for(let P=0;P<this._siblingOffset.length;P++){Ha((E<<1)+this._siblingOffset[P][0],(M<<1)+this._siblingOffset[P][1],D+1,t,n,r,o,g,y),g[2]=-100,y[2]=this.maximums[this.childOffsets[x]+P]*u;const C=sb(g,y,s,c);if(null!=C){const R=C;f[P]=R;let k=!1;for(let N=0;N<A&&!k;N++)R>=f[m[N]]&&(m.splice(N,0,P),k=!0);k||(m[A]=P),A++}}for(let P=0;P<A;P++){const C=m[P];v.push({idx:this.childOffsets[x]+C,t:f[C],nodex:(E<<1)+this._siblingOffset[C][0],nodey:(M<<1)+this._siblingOffset[C][1],depth:D+1})}}return null}_addNode(t,n,r){return this.minimums.push(t),this.maximums.push(n),this.leaves.push(r),this.childOffsets.push(0),this.nodeCount++}_construct(t,n,r,o,s){if(1===t[o].isLeaf(n,r))return;this.childOffsets[s]||(this.childOffsets[s]=this.nodeCount);const c=o-1,u=t[c];let d=0,f=0;for(let m=0;m<this._siblingOffset.length;m++){const g=2*n+this._siblingOffset[m][0],y=2*r+this._siblingOffset[m][1],v=u.getElevation(g,y),x=u.isLeaf(g,y),w=this._addNode(v.min,v.max,x);x&&(d|=1<<m),f||(f=w)}for(let m=0;m<this._siblingOffset.length;m++)d&1<<m||this._construct(t,2*n+this._siblingOffset[m][0],2*r+this._siblingOffset[m][1],c,f+m)}}function ab(e,t,n,r,o,s){return le(le(e,n,s),le(t,r,s),o)}function Ic(e,t,n){const r=n.dim,o=ne(e*r-.5,0,r-1),s=ne(t*r-.5,0,r-1),c=Math.floor(o),u=Math.floor(s),d=Math.min(c+1,r-1),f=Math.min(u+1,r-1);return ab(n.get(c,u),n.get(d,u),n.get(c,f),n.get(d,f),o-c,s-u)}const lb={mapbox:[6553.6,25.6,.1,1e4],terrarium:[256,1,1/256,32768]};function cb(e,t,n){return(256*e*256+256*t+n)/10-1e4}function Wy(e,t,n){return 256*e+t+n/256-32768}class Dc{get tree(){return this._tree||this._buildQuadTree(),this._tree}constructor(t,n,r,o=!1){if(this.uid=t,n.height!==n.width)throw new RangeError("DEM tiles must be square");if(r&&"mapbox"!==r&&"terrarium"!==r)return nt(`"${r}" is not a valid encoding type. Valid types include "mapbox" and "terrarium".`);this.stride=n.height;const s=this.dim=n.height-2,c=new Uint32Array(n.data.buffer);if(this.pixels=new Uint8Array(n.data.buffer),this.floatView=new Float32Array(n.data.buffer),this.borderReady=o,this._modifiedForSources={},!o){for(let d=0;d<s;d++)c[this._idx(-1,d)]=c[this._idx(0,d)],c[this._idx(s,d)]=c[this._idx(s-1,d)],c[this._idx(d,-1)]=c[this._idx(d,0)],c[this._idx(d,s)]=c[this._idx(d,s-1)];c[this._idx(-1,-1)]=c[this._idx(0,0)],c[this._idx(s,-1)]=c[this._idx(s-1,0)],c[this._idx(-1,s)]=c[this._idx(0,s-1)],c[this._idx(s,s)]=c[this._idx(s-1,s-1)]}const u="terrarium"===r?Wy:cb;for(let d=0;d<c.length;++d){const f=4*d;this.floatView[d]=u(this.pixels[f],this.pixels[f+1],this.pixels[f+2])}this._timestamp=De.now()}_buildQuadTree(){this._tree=new Iu(this)}get(t,n,r=!1){r&&(t=ne(t,-1,this.dim),n=ne(n,-1,this.dim));const o=this._idx(t,n);return this.floatView[o]}set(t,n,r){const o=this._idx(t,n),s=this.floatView[o];return this.floatView[o]=r,r-s}static getUnpackVector(t){return lb[t]}_idx(t,n){if(t<-1||t>=this.dim+1||n<-1||n>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(n+1)*this.stride+(t+1)}static pack(t,n){const r=[0,0,0,0],o=Dc.getUnpackVector(n);let s=Math.floor((t+o[3])/o[2]);return r[2]=s%256,s=Math.floor(s/256),r[1]=s%256,s=Math.floor(s/256),r[0]=s,r}getPixels(){return new FM({width:this.stride,height:this.stride},this.pixels)}backfillBorder(t,n,r){if(this.dim!==t.dim)throw new Error("dem dimension mismatch");let o=n*this.dim,s=n*this.dim+this.dim,c=r*this.dim,u=r*this.dim+this.dim;switch(n){case-1:o=s-1;break;case 1:s=o+1}switch(r){case-1:c=u-1;break;case 1:u=c+1}const d=-n*this.dim,f=-r*this.dim;for(let m=c;m<u;m++)for(let g=o;g<s;g++){const y=4*this._idx(g,m),v=4*this._idx(g+d,m+f);this.pixels[y+0]=t.pixels[v+0],this.pixels[y+1]=t.pixels[v+1],this.pixels[y+2]=t.pixels[v+2],this.pixels[y+3]=t.pixels[v+3]}}onDeserialize(){this._tree&&(this._tree.dem=this)}}re(Dc,"DEMData"),re(Iu,"DemMinMaxQuadTree",{omit:["dem"]});class tg{isDataAvailableAtPoint(t){const n=this._source();if(this.isUsingMockSource()||!n||t.y<0||t.y>1)return!1;const r=n.getSource().maxzoom,o=1<<r,s=Math.floor(t.x),c=Math.floor((t.x-s)*o),u=Math.floor(t.y*o),d=this.findDEMTileFor(new nn(r,s,r,c,u));return!(!d||!d.dem)}getAtPointOrZero(t,n=0){return this.getAtPoint(t,n)||0}getAtPoint(t,n,r=!0){if(this.isUsingMockSource())return null;null==n&&(n=null);const o=this._source();if(!o||t.y<0||t.y>1)return n;const s=o.getSource().maxzoom,c=1<<s,u=Math.floor(t.x),d=t.x-u,f=new nn(s,u,s,Math.floor(d*c),Math.floor(t.y*c)),m=this.findDEMTileFor(f);if(!m||!m.dem)return n;const g=m.dem,y=1<<m.tileID.canonical.z,v=(d*y-m.tileID.canonical.x)*g.dim,x=(t.y*y-m.tileID.canonical.y)*g.dim,w=Math.floor(v),E=Math.floor(x);return(r?this.exaggeration():1)*le(le(g.get(w,E),g.get(w,E+1),x-E),le(g.get(w+1,E),g.get(w+1,E+1),x-E),v-w)}getAtTileOffset(t,n,r){const o=1<<t.canonical.z;return this.getAtPointOrZero(new Qe(t.wrap+(t.canonical.x+n/et)/o,(t.canonical.y+r/et)/o))}getAtTileOffsetFunc(t,n,r,o){return s=>{const c=this.getAtTileOffset(t,s.x,s.y),u=o.upVector(t.canonical,s.x,s.y),d=o.upVectorScale(t.canonical,n,r).metersToTile;return Z.scale(u,u,c*d),u}}getForTilePoints(t,n,r,o){if(this.isUsingMockSource())return!1;const s=Du.create(this,t,o);return!!s&&(n.forEach(c=>{c[2]=this.exaggeration()*s.getElevationAt(c[0],c[1],r)}),!0)}getMinMaxForTile(t){if(this.isUsingMockSource())return null;const n=this.findDEMTileFor(t);if(!n||!n.dem)return null;const r=n.dem.tree,o=n.tileID,s=1<<t.canonical.z-o.canonical.z;let c=t.canonical.x/s-o.canonical.x,u=t.canonical.y/s-o.canonical.y,d=0;for(let f=0;f<t.canonical.z-o.canonical.z&&!r.leaves[d];f++){c*=2,u*=2;const m=2*Math.floor(u)+Math.floor(c);d=r.childOffsets[d]+m,c%=1,u%=1}return{min:this.exaggeration()*r.minimums[d],max:this.exaggeration()*r.maximums[d]}}getMinElevationBelowMSL(){throw new Error("Pure virtual method called.")}raycast(t,n,r){throw new Error("Pure virtual method called.")}pointCoordinate(t){throw new Error("Pure virtual method called.")}_source(){throw new Error("Pure virtual method called.")}isUsingMockSource(){throw new Error("Pure virtual method called.")}exaggeration(){throw new Error("Pure virtual method called.")}findDEMTileFor(t){throw new Error("Pure virtual method called.")}get visibleDemTiles(){throw new Error("Getter must be implemented in subclass.")}getMinMaxForVisibleTiles(){const t=this.visibleDemTiles;if(0===t.length)return null;let n=!1,r=Number.MAX_VALUE,o=Number.MIN_VALUE;for(const s of t){const c=this.getMinMaxForTile(s.tileID);c&&(r=Math.min(r,c.min),o=Math.max(o,c.max),n=!0)}return n?{min:r,max:o}:null}}class Du{constructor(t,n,r){this._demTile=t,this._dem=this._demTile.dem,this._scale=n,this._offset=r}static create(t,n,r){const o=r||t.findDEMTileFor(n);if(!o||!o.dem)return;const s=o.dem,c=o.tileID,u=1<<n.canonical.z-c.canonical.z;return new Du(o,s.dim/et/u,[(n.canonical.x/u-c.canonical.x)*s.dim,(n.canonical.y/u-c.canonical.y)*s.dim])}tileCoordToPixel(t,n){const r=n*this._scale+this._offset[1],o=Math.floor(t*this._scale+this._offset[0]),s=Math.floor(r);return new it(o,s)}getElevationAt(t,n,r,o){const s=t*this._scale+this._offset[0],c=n*this._scale+this._offset[1],u=Math.floor(s),d=Math.floor(c),f=this._dem;return o=!!o,r?le(le(f.get(u,d,o),f.get(u,d+1,o),c-d),le(f.get(u+1,d,o),f.get(u+1,d+1,o),c-d),s-u):f.get(u,d,o)}getElevationAtPixel(t,n,r){return this._dem.get(t,n,!!r)}getMeterToDEM(t){return(1<<this._demTile.tileID.canonical.z)*Ln(1,t)*this._dem.stride}}class eg{constructor(t,n){this.tileID=t,this.x=t.canonical.x,this.y=t.canonical.y,this.z=t.canonical.z,this.grid=new We(et,16,0),this.featureIndexArray=new O_,this.promoteId=n}insert(t,n,r,o,s,c=0){const u=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(r,o,s,c);const d=this.grid;for(let f=0;f<n.length;f++){const m=n[f],g=[1/0,1/0,-1/0,-1/0];for(let y=0;y<m.length;y++){const v=m[y];g[0]=Math.min(g[0],v.x),g[1]=Math.min(g[1],v.y),g[2]=Math.max(g[2],v.x),g[3]=Math.max(g[3],v.y)}g[0]<et&&g[1]<et&&g[2]>=0&&g[3]>=0&&d.insert(u,g[0],g[1],g[2],g[3])}}loadVTLayers(){if(!this.vtLayers){this.vtLayers=new By(new Qm(this.rawTileData)).layers,this.sourceLayerCoder=new Vy(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"]),this.vtFeatures={};for(const t in this.vtLayers)this.vtFeatures[t]=[]}return this.vtLayers}query(t,n,r,o){this.loadVTLayers();const s=t.params||{},c=Ih(s.filter),u=t.tileResult,d=t.transform,f=u.bufferedTilespaceBounds,m=this.grid.query(f.min.x,f.min.y,f.max.x,f.max.y,(x,w,E,M)=>Vm(u.bufferedTilespaceGeometry,x,w,E,M));m.sort(QM);let g=null;d.elevation&&m.length>0&&(g=Du.create(d.elevation,this.tileID));const y={};let v;for(let x=0;x<m.length;x++){const w=m[x];if(w===v)continue;v=w;const E=this.featureIndexArray.get(w);let M=null;this.loadMatchingFeature(y,E,c,s.layers,s.availableImages,n,r,o,(D,A,P,C=0)=>(M||(M=ca(D,this.tileID.canonical,t.tileTransform)),A.queryIntersectsFeature(u,D,P,M,this.z,t.transform,t.pixelPosMatrix,g,C)))}return y}loadMatchingFeature(t,n,r,o,s,c,u,d,f){const{featureIndex:m,bucketIndex:g,sourceLayerIndex:y,layoutVertexArrayOffset:v}=n,x=this.bucketLayerIDs[g];if(o&&!function(D,A){for(let P=0;P<D.length;P++)if(A.indexOf(D[P])>=0)return!0;return!1}(o,x))return;const w=this.sourceLayerCoder.decode(y),E=this.vtLayers[w].feature(m);if(r.needGeometry){const D=Ua(E,!0);if(!r.filter(new ar(this.tileID.overscaledZ),D,this.tileID.canonical))return}else if(!r.filter(new ar(this.tileID.overscaledZ),E))return;const M=this.getId(E,w);for(let D=0;D<x.length;D++){const A=x[D];if(o&&o.indexOf(A)<0)continue;const P=c[A];if(!P)continue;let C={};void 0!==M&&d&&(C=d.getState(P.sourceLayer||"_geojsonTileLayer",M));const R=Wt({},u[A]);R.paint=ub(R.paint,P.paint,E,C,s),R.layout=ub(R.layout,P.layout,E,C,s);const k=!f||f(E,P,C,v);if(!k)continue;const N=new qy(E,this.z,this.x,this.y,M);N.layer=R;let z=t[A];void 0===z&&(z=t[A]=[]),z.push({featureIndex:m,feature:N,intersectionZ:k})}}lookupSymbolFeatures(t,n,r,o,s,c,u,d){const f={};this.loadVTLayers();const m=Ih(s);for(const g of t)this.loadMatchingFeature(f,{bucketIndex:r,sourceLayerIndex:o,featureIndex:g,layoutVertexArrayOffset:0},m,c,u,d,n);return f}loadFeature(t){const{featureIndex:n,sourceLayerIndex:r}=t;this.loadVTLayers();const o=this.sourceLayerCoder.decode(r),s=this.vtFeatures[o];if(s[n])return s[n];const c=this.vtLayers[o].feature(n);return s[n]=c,c}hasLayer(t){for(const n of this.bucketLayerIDs)for(const r of n)if(t===r)return!0;return!1}getId(t,n){let r=t.id;if(this.promoteId){const o="string"==typeof this.promoteId?this.promoteId:this.promoteId[n];null!=o&&(r=t.properties[o]),"boolean"==typeof r&&(r=Number(r))}return r}}function ub(e,t,n,r,o){return Wl(e,(s,c)=>{const u=t instanceof eu?t.get(c):null;return u&&u.evaluate?u.evaluate(n,r,o):u})}function QM(e,t){return t-e}re(eg,"FeatureIndex",{omit:["rawTileData","sourceLayerCoder"]});const tI=Ce([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_tex_size",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),eI=Ce([{name:"a_globe_anchor",components:3,type:"Int16"},{name:"a_globe_normal",components:3,type:"Float32"}],4),hb=Ce([{name:"a_projected_pos",components:4,type:"Float32"}],4);Ce([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const IC=Ce([{name:"a_z_offset",components:1,type:"Float32"}],4),nI=Ce([{name:"a_texb",components:2,type:"Uint16"}]),DC=Ce([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"}]),SC=Ce([{name:"a_size_scale",components:1,type:"Float32"},{name:"a_padding",components:2,type:"Float32"},{name:"a_z_offset",components:1,type:"Float32"}]);Ce([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"tileAnchorX"},{type:"Int16",name:"tileAnchorY"},{type:"Float32",name:"x1"},{type:"Float32",name:"y1"},{type:"Float32",name:"x2"},{type:"Float32",name:"y2"},{type:"Int16",name:"padding"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const Xy=Ce([{name:"a_pos",components:3,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),db=Ce([{name:"a_pos_2f",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);Ce([{name:"triangle",components:3,type:"Uint16"}]),Ce([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"},{type:"Uint8",name:"flipState"}]),Ce([{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Float32",name:"zOffset"},{type:"Uint8",name:"hasIconTextFit"}]),Ce([{type:"Float32",name:"offsetX"}]),Ce([{type:"Int16",name:"x"},{type:"Int16",name:"y"}]);var wi=24;const Qo=128;function ng(e,t){const{expression:n}=t;if("constant"===n.kind)return{kind:"constant",layoutSize:n.evaluate(new ar(e+1))};if("source"===n.kind)return{kind:"source"};{const{zoomStops:r,interpolationType:o}=n;let s=0;for(;s<r.length&&r[s]<=e;)s++;s=Math.max(0,s-1);let c=s;for(;c<r.length&&r[c]<e+1;)c++;c=Math.min(r.length-1,c);const u=r[s],d=r[c];return"composite"===n.kind?{kind:"composite",minZoom:u,maxZoom:d,interpolationType:o}:{kind:"camera",minZoom:u,maxZoom:d,minSize:n.evaluate(new ar(u)),maxSize:n.evaluate(new ar(d)),interpolationType:o}}}function Yh(e,{uSize:t,uSizeT:n},{lowerSize:r,upperSize:o}){return"source"===e.kind?r/Qo:"composite"===e.kind?le(r/Qo,o/Qo,n):t}function qa(e,t){let n=0,r=0;if("constant"===e.kind)r=e.layoutSize;else if("source"!==e.kind){const{interpolationType:o,minZoom:s,maxZoom:c}=e,u=o?ne(Ho.interpolationFactor(o,t,s,c),0,1):0;"camera"===e.kind?r=le(e.minSize,e.maxSize,u):n=u}return{uSizeT:n,uSize:r}}var fb=Object.freeze({__proto__:null,SIZE_PACK_FACTOR:Qo,evaluateSizeForFeature:Yh,evaluateSizeForZoom:qa,getSizeData:ng});function pb(e,t,n){return e.sections.forEach(r=>{r.text=function(o,s,c){const u=s.layout.get("text-transform").evaluate(c,{});return"uppercase"===u?o=o.toLocaleUpperCase():"lowercase"===u&&(o=o.toLocaleLowerCase()),bi.applyArabicShaping&&(o=bi.applyArabicShaping(o)),o}(r.text,t,n)}),e}const sn={"!":"\ufe15","#":"\uff03",$:"\uff04","%":"\uff05","&":"\uff06","(":"\ufe35",")":"\ufe36","*":"\uff0a","+":"\uff0b",",":"\ufe10","-":"\ufe32",".":"\u30fb","/":"\uff0f",":":"\ufe13",";":"\ufe14","<":"\ufe3f","=":"\uff1d",">":"\ufe40","?":"\ufe16","@":"\uff20","[":"\ufe47","\\":"\uff3c","]":"\ufe48","^":"\uff3e",_:"\ufe33","`":"\uff40","{":"\ufe37","|":"\u2015","}":"\ufe38","~":"\uff5e","\xa2":"\uffe0","\xa3":"\uffe1","\xa5":"\uffe5","\xa6":"\uffe4","\xac":"\uffe2","\xaf":"\uffe3","\u2013":"\ufe32","\u2014":"\ufe31","\u2018":"\ufe43","\u2019":"\ufe44","\u201c":"\ufe41","\u201d":"\ufe42","\u2026":"\ufe19","\u2027":"\u30fb","\u20a9":"\uffe6","\u3001":"\ufe11","\u3002":"\ufe12","\u3008":"\ufe3f","\u3009":"\ufe40","\u300a":"\ufe3d","\u300b":"\ufe3e","\u300c":"\ufe41","\u300d":"\ufe42","\u300e":"\ufe43","\u300f":"\ufe44","\u3010":"\ufe3b","\u3011":"\ufe3c","\u3014":"\ufe39","\u3015":"\ufe3a","\u3016":"\ufe17","\u3017":"\ufe18","\uff01":"\ufe15","\uff08":"\ufe35","\uff09":"\ufe36","\uff0c":"\ufe10","\uff0d":"\ufe32","\uff0e":"\u30fb","\uff1a":"\ufe13","\uff1b":"\ufe14","\uff1c":"\ufe3f","\uff1e":"\ufe40","\uff1f":"\ufe16","\uff3b":"\ufe47","\uff3d":"\ufe48","\uff3f":"\ufe33","\uff5b":"\ufe37","\uff5c":"\u2015","\uff5d":"\ufe38","\uff5f":"\ufe35","\uff60":"\ufe36","\uff61":"\ufe12","\uff62":"\ufe41","\uff63":"\ufe42","\u2190":"\u2191","\u2192":"\u2193"};function rI(e){return"\ufe36"===e||"\ufe48"===e||"\ufe38"===e||"\ufe44"===e||"\ufe42"===e||"\ufe3e"===e||"\ufe3c"===e||"\ufe3a"===e||"\ufe18"===e||"\ufe40"===e||"\ufe10"===e||"\ufe13"===e||"\ufe14"===e||"\uff40"===e||"\uffe3"===e||"\ufe11"===e||"\ufe12"===e}function mb(e){return"\ufe35"===e||"\ufe47"===e||"\ufe37"===e||"\ufe43"===e||"\ufe41"===e||"\ufe3d"===e||"\ufe3b"===e||"\ufe39"===e||"\ufe17"===e||"\ufe3f"===e}const Dn=3;function iI(e,t,n){t.glyphs=[],1===e&&n.readMessage(oI,t)}function oI(e,t,n){if(3===e){const{id:r,bitmap:o,width:s,height:c,left:u,top:d,advance:f}=n.readMessage(rg,{});t.glyphs.push({id:r,bitmap:new Ga({width:s+2*Dn,height:c+2*Dn},o),metrics:{width:s,height:c,left:u,top:d,advance:f}})}else 4===e?t.ascender=n.readSVarint():5===e&&(t.descender=n.readSVarint())}function rg(e,t,n){1===e?t.id=n.readVarint():2===e?t.bitmap=n.readBytes():3===e?t.width=n.readVarint():4===e?t.height=n.readVarint():5===e?t.left=n.readSVarint():6===e?t.top=n.readSVarint():7===e&&(t.advance=n.readVarint())}const Su=Dn,er={horizontal:1,vertical:2,horizontalOnly:3},Kh=-17;class Jh{constructor(){this.scale=1,this.fontStack="",this.imageName=null}static forText(t,n){const r=new Jh;return r.scale=t||1,r.fontStack=n,r}static forImage(t){const n=new Jh;return n.imageName=t,n}}class Sc{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(t,n){const r=new Sc;for(let o=0;o<t.sections.length;o++){const s=t.sections[o];s.image?r.addImageSection(s):r.addTextSection(s,n)}return r}length(){return this.text.length}getSection(t){return this.sections[this.sectionIndex[t]]}getSections(){return this.sections}getSectionIndex(t){return this.sectionIndex[t]}getCodePoint(t){return this.text.codePointAt(t)}verticalizePunctuation(t){this.text=function(n,r){let o="";for(let s=0;s<n.length;s++){const c=n.charCodeAt(s+1)||null,u=n.charCodeAt(s-1)||null;o+=!r&&(c&&Ax(c)&&!sn[n[s+1]]||u&&Ax(u)&&!sn[n[s-1]])||!sn[n[s]]?n[s]:sn[n[s]]}return o}(this.text,t)}trim(){let t=0;for(let r=0;r<this.text.length&&Qh[this.text.charCodeAt(r)];r++)t++;let n=this.text.length;for(let r=this.text.length-1;r>=0&&r>=t&&Qh[this.text.charCodeAt(r)];r--)n--;this.text=this.text.substring(t,n),this.sectionIndex=this.sectionIndex.slice(t,n)}substring(t,n){const r=new Sc;return r.text=this.text.substring(t,n),r.sectionIndex=this.sectionIndex.slice(t,n),r.sections=this.sections,r}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce((t,n)=>Math.max(t,this.sections[n].scale),0)}addTextSection(t,n){this.text+=t.text,this.sections.push(Jh.forText(t.scale,t.fontStack||n));const r=this.sections.length-1;for(let o=0;o<t.text.length;++o)this.sectionIndex.push(r)}addImageSection(t){const n=t.image?t.image.namePrimary:"";if(0===n.length)return void nt("Can't add FormattedSection with an empty image.");const r=this.getNextImageSectionCharCode();r?(this.text+=String.fromCodePoint(r),this.sections.push(Jh.forImage(n)),this.sectionIndex.push(this.sections.length-1)):nt("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function Jf(e,t,n,r,o,s,c,u,d,f,m,g,y,v,x){const w=Sc.fromFeature(e,o);g===er.vertical&&w.verticalizePunctuation(y);let E=[];const M=function(R,k,N,z,B,U){if(!R)return[];const $=[],W=function(ot,Y,J,ct,dt,ht){let _t=0;for(let vt=0;vt<ot.length();vt++){const xt=ot.getSection(vt);_t+=ig(ot.getCodePoint(vt),xt,ct,dt,Y,ht)}return _t/Math.max(1,Math.ceil(_t/J))}(R,k,N,z,B,U),V=R.text.indexOf("\u200b")>=0;let K=0;for(let ot=0;ot<R.length();ot++){const Y=R.getSection(ot),J=R.getCodePoint(ot);if(Qh[J]||(K+=ig(J,Y,z,B,k,U)),ot<R.length()-1){const ct=!((Q=J)<11904||!(ie["Bopomofo Extended"](Q)||ie.Bopomofo(Q)||ie["CJK Compatibility Forms"](Q)||ie["CJK Compatibility Ideographs"](Q)||ie["CJK Compatibility"](Q)||ie["CJK Radicals Supplement"](Q)||ie["CJK Strokes"](Q)||ie["CJK Symbols and Punctuation"](Q)||ie["CJK Unified Ideographs Extension A"](Q)||ie["CJK Unified Ideographs"](Q)||ie["Enclosed CJK Letters and Months"](Q)||ie["Halfwidth and Fullwidth Forms"](Q)||ie.Hiragana(Q)||ie["Ideographic Description Characters"](Q)||ie["Kangxi Radicals"](Q)||ie["Katakana Phonetic Extensions"](Q)||ie.Katakana(Q)||ie["Vertical Forms"](Q)||ie["Yi Radicals"](Q)||ie["Yi Syllables"](Q)));(gb[J]||ct||Y.imageName)&&$.push(yb(ot+1,K,W,$,sI(J,R.getCodePoint(ot+1),ct&&V),!1))}}var Q;return Yy(yb(R.length(),K,W,$,0,!0))}(w,f,s,t,r,v),{processBidirectionalText:D,processStyledBidirectionalText:A}=bi;if(D&&1===w.sections.length){const R=D(w.toString(),M);for(const k of R){const N=new Sc;N.text=k,N.sections=w.sections;for(let z=0;z<k.length;z++)N.sectionIndex.push(0);E.push(N)}}else if(A){const R=A(w.text,w.sectionIndex,M);for(const k of R){const N=new Sc;N.text=k[0],N.sectionIndex=k[1],N.sections=w.sections,E.push(N)}}else E=function(R,k){const N=[],z=R.text;let B=0;for(const U of k)N.push(R.substring(B,U)),B=U;return B<z.length&&N.push(R.substring(B,z.length)),N}(w,M);const P=[],C={positionedLines:P,text:w.toString(),top:m[1],bottom:m[1],left:m[0],right:m[0],writingMode:g,iconsInText:!1,verticalizable:!1,hasBaseline:!1};return function(R,k,N,z,B,U,$,W,V,K,Q,ot){let Y=0,J=0,ct=0;const dt="right"===W?1:"left"===W?0:.5;let ht=!1;for(const Ut of B){const Gt=Ut.getSections();for(const Yt of Gt){if(Yt.imageName)continue;const te=k[Yt.fontStack];if(te&&(ht=void 0!==te.ascender&&void 0!==te.descender,!ht))break}if(!ht)break}let _t=0;for(const Ut of B){Ut.trim();const Gt=Ut.getMaxScale(),Yt=(Gt-1)*wi,te={positionedGlyphs:[],lineOffset:0};R.positionedLines[_t]=te;const Me=te.positionedGlyphs;let ue=0;if(!Ut.length()){J+=U,++_t;continue}let dn=0,Ye=0;for(let we=0;we<Ut.length();we++){const fe=Ut.getSection(we),Ke=Ut.getSectionIndex(we),rn=Ut.getCodePoint(we);let Be=fe.scale,yn=null,Ir=null,Sn=null,Zn=wi,Vr=0;const br=!(V===er.horizontal||!Q&&!T_(rn)||Q&&(Qh[rn]||(vt=rn,ie.Arabic(vt)||ie["Arabic Supplement"](vt)||ie["Arabic Extended-A"](vt)||ie["Arabic Presentation Forms-A"](vt)||ie["Arabic Presentation Forms-B"](vt))));if(fe.imageName){const Yn=z[fe.imageName];if(!Yn)continue;Sn=fe.imageName,R.iconsInText=R.iconsInText||!0,Ir=Yn.paddedRect;const bn=Yn.displaySize;Be=Be*wi/ot,yn={width:bn[0],height:bn[1],left:0,top:-Su,advance:br?bn[1]:bn[0],localGlyph:!1},Vr=ht?-yn.height*Be:Kh+Gt*wi-bn[1]*Be,Zn=yn.advance;const Ni=(br?bn[0]:bn[1])*Be-wi*Gt;Ni>0&&Ni>ue&&(ue=Ni)}else{const Yn=N[fe.fontStack];if(!Yn)continue;Yn[rn]&&(Ir=Yn[rn]);const bn=k[fe.fontStack];if(!bn)continue;const Ni=bn.glyphs[rn];if(!Ni)continue;if(yn=Ni.metrics,Zn=8203!==rn?wi:0,ht){const Ul=void 0!==bn.ascender?Math.abs(bn.ascender):0,Oc=void 0!==bn.descender?Math.abs(bn.descender):0,el=(Ul+Oc)*Be;dn<el&&(dn=el,Ye=(Ul-Oc)/2*Be),Vr=-Ul*Be}else Vr=Kh+(Gt-Be)*wi}br?(R.verticalizable=!0,Me.push({glyph:rn,imageName:Sn,x:Y,y:J+Vr,vertical:br,scale:Be,localGlyph:yn.localGlyph,fontStack:fe.fontStack,sectionIndex:Ke,metrics:yn,rect:Ir}),Y+=Zn*Be+K):(Me.push({glyph:rn,imageName:Sn,x:Y,y:J+Vr,vertical:br,scale:Be,localGlyph:yn.localGlyph,fontStack:fe.fontStack,sectionIndex:Ke,metrics:yn,rect:Ir}),Y+=yn.advance*Be+K)}0!==Me.length&&(ct=Math.max(Y-K,ct),ht?vb(Me,dt,ue,Ye,U*Gt/2):vb(Me,dt,ue,0,U/2)),Y=0;const Ie=U*Gt+ue;te.lineOffset=Math.max(ue,Yt),J+=Ie,++_t}var vt;const xt=J,{horizontalAlign:mt,verticalAlign:Ct}=og($);(function(Ut,Gt,Yt,te,Me,ue){const dn=(Gt-Yt)*Me,Ye=-ue*te;for(const Ie of Ut)for(const we of Ie.positionedGlyphs)we.x+=dn,we.y+=Ye})(R.positionedLines,dt,mt,Ct,ct,xt),R.top+=-Ct*xt,R.bottom=R.top+xt,R.left+=-mt*ct,R.right=R.left+ct,R.hasBaseline=ht}(C,t,n,r,E,c,u,d,g,f,y,x),!function(R){for(const k of R)if(0!==k.positionedGlyphs.length)return!1;return!0}(P)&&C}const Qh={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},gb={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function ig(e,t,n,r,o,s){if(t.imageName){const c=r[t.imageName];return c?c.displaySize[0]*t.scale*wi/s+o:0}{const c=n[t.fontStack],u=c&&c.glyphs[e];return u?u.metrics.advance*t.scale+o:0}}function _b(e,t,n,r){const o=Math.pow(e-t,2);return r?e<t?o/2:2*o:o+Math.abs(n)*n}function sI(e,t,n){let r=0;return 10===e&&(r-=1e4),n&&(r+=150),40!==e&&65288!==e||(r+=50),41!==t&&65289!==t||(r+=50),r}function yb(e,t,n,r,o,s){let c=null,u=_b(t,n,o,s);for(const d of r){const f=_b(t-d.x,n,o,s)+d.badness;f<=u&&(c=d,u=f)}return{index:e,x:t,priorBreak:c,badness:u}}function Yy(e){return e?Yy(e.priorBreak).concat(e.index):[]}function og(e){let t=.5,n=.5;switch(e){case"right":case"top-right":case"bottom-right":t=1;break;case"left":case"top-left":case"bottom-left":t=0}switch(e){case"bottom":case"bottom-right":case"bottom-left":n=1;break;case"top":case"top-right":case"top-left":n=0}return{horizontalAlign:t,verticalAlign:n}}function vb(e,t,n,r,o){if(!(t||n||r||o))return;const s=e.length-1,c=e[s],u=(c.x+c.metrics.advance*c.scale)*t;for(let d=0;d<=s;d++)e[d].x-=u,e[d].y+=n+r+o}function aI(e,t,n,r){const{horizontalAlign:o,verticalAlign:s}=og(r),c=n[0]-e.displaySize[0]*o,u=n[1]-e.displaySize[1]*s;return{imagePrimary:e,imageSecondary:t,top:u,bottom:u+e.displaySize[1],left:c,right:c+e.displaySize[0]}}function xb(e,t,n,r,o,s){const c=e.imagePrimary;let u;if(c.content){const E=c.content,M=c.pixelRatio||1;u=[E[0]/M,E[1]/M,c.displaySize[0]-E[2]/M,c.displaySize[1]-E[3]/M]}const d=t.left*s,f=t.right*s;let m,g,y,v;"width"===n||"both"===n?(v=o[0]+d-r[3],g=o[0]+f+r[1]):(v=o[0]+(d+f-c.displaySize[0])/2,g=v+c.displaySize[0]);const x=t.top*s,w=t.bottom*s;return"height"===n||"both"===n?(m=o[1]+x-r[0],y=o[1]+w+r[2]):(m=o[1]+(x+w-c.displaySize[1])/2,y=m+c.displaySize[1]),{imagePrimary:c,imageSecondary:void 0,top:m,right:g,bottom:y,left:v,collisionPadding:u}}class Za extends it{constructor(t,n,r,o,s){super(t,n),this.angle=o,this.z=r,void 0!==s&&(this.segment=s)}clone(){return new Za(this.x,this.y,this.z,this.angle,this.segment)}}function Ky(e,t,n,r,o){if(void 0===t.segment)return!0;let s=t,c=t.segment+1,u=0;for(;u>-n/2;){if(c--,c<0)return!1;u-=e[c].dist(s),s=e[c]}u+=e[c].dist(e[c+1]),c++;const d=[];let f=0;for(;u<n/2;){const m=e[c],g=e[c+1];if(!g)return!1;let y=e[c-1].angleTo(m)-m.angleTo(g);for(y=Math.abs((y+3*Math.PI)%(2*Math.PI)-Math.PI),d.push({distance:u,angleDelta:y}),f+=y;u-d[0].distance>r;)f-=d.shift().angleDelta;if(f>o)return!1;c++,u+=m.dist(g)}return!0}function bb(e){let t=0;for(let n=0;n<e.length-1;n++)t+=e[n].dist(e[n+1]);return t}function wb(e,t,n){return e?.6*t*n:0}function ts(e,t){return Math.max(e?e.right-e.left:0,t?t.right-t.left:0)}function lI(e,t,n,r,o,s){const c=wb(n,o,s),u=ts(n,r)*s;let d=0;const f=bb(e)/2;for(let m=0;m<e.length-1;m++){const g=e[m],y=e[m+1],v=g.dist(y);if(d+v>f){const x=(f-d)/v,w=le(g.x,y.x,x),E=le(g.y,y.y,x),M=new Za(w,E,0,y.angleTo(g),m);return!c||Ky(e,M,u,c,t)?M:void 0}d+=v}}function cI(e,t,n,r,o,s,c,u,d){const f=wb(r,s,c),m=ts(r,o),g=m*c,y=0===e[0].x||e[0].x===d||0===e[0].y||e[0].y===d;return t-g<t/4&&(t=g+t/4),uI(e,y?t/2*u%t:(m/2+2*s)*c*u%t,t,f,n,g,y,!1,d)}function uI(e,t,n,r,o,s,c,u,d){const f=s/2,m=bb(e);let g=0,y=t-n,v=[];for(let x=0;x<e.length-1;x++){const w=e[x],E=e[x+1],M=w.dist(E),D=E.angleTo(w);for(;y+n<g+M;){y+=n;const A=(y-g)/M,P=le(w.x,E.x,A),C=le(w.y,E.y,A);if(P>=0&&P<d&&C>=0&&C<d&&y-f>=0&&y+f<=m){const R=new Za(P,C,0,D,x);r&&!Ky(e,R,s,r,o)||v.push(R)}}g+=M}return u||v.length||c||(v=uI(e,g/2,n,r,o,s,c,!0,d)),v}function sg(e,t,n,r,o){const s=[];for(let c=0;c<e.length;c++){const u=e[c];let d;for(let f=0;f<u.length-1;f++){let m=u[f],g=u[f+1];m.x<t&&g.x<t||(m.x<t?m=new it(t,m.y+(t-m.x)/(g.x-m.x)*(g.y-m.y))._round():g.x<t&&(g=new it(t,m.y+(t-m.x)/(g.x-m.x)*(g.y-m.y))._round()),m.y<n&&g.y<n||(m.y<n?m=new it(m.x+(n-m.y)/(g.y-m.y)*(g.x-m.x),n)._round():g.y<n&&(g=new it(m.x+(n-m.y)/(g.y-m.y)*(g.x-m.x),n)._round()),m.x>=r&&g.x>=r||(m.x>=r?m=new it(r,m.y+(r-m.x)/(g.x-m.x)*(g.y-m.y))._round():g.x>=r&&(g=new it(r,m.y+(r-m.x)/(g.x-m.x)*(g.y-m.y))._round()),m.y>=o&&g.y>=o||(m.y>=o?m=new it(m.x+(o-m.y)/(g.y-m.y)*(g.x-m.x),o)._round():g.y>=o&&(g=new it(m.x+(o-m.y)/(g.y-m.y)*(g.x-m.x),o)._round()),d&&m.equals(d[d.length-1])||(d=[m],s.push(d)),d.push(g)))))}}return s}function ag(e){let t=0,n=0;for(const c of e)t+=c.w*c.h,n=Math.max(n,c.w);e.sort((c,u)=>u.h-c.h);const r=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(t/.95)),n),h:1/0}];let o=0,s=0;for(const c of e)for(let u=r.length-1;u>=0;u--){const d=r[u];if(!(c.w>d.w||c.h>d.h)){if(c.x=d.x,c.y=d.y,s=Math.max(s,c.y+c.h),o=Math.max(o,c.x+c.w),c.w===d.w&&c.h===d.h){const f=r.pop();u<r.length&&(r[u]=f)}else c.h===d.h?(d.x+=c.w,d.w-=c.w):c.w===d.w?(d.y+=c.h,d.h-=c.h):(r.push({x:d.x+c.w,y:d.y,w:d.w-c.w,h:c.h}),d.y+=c.h,d.h-=c.h);break}}return{w:o,h:s,fill:t/(o*s)||0}}re(Za,"Anchor");const es=1;class Jy{constructor(t,{pixelRatio:n,version:r,stretchX:o,stretchY:s,content:c}){this.paddedRect=t,this.pixelRatio=n,this.stretchX=o,this.stretchY=s,this.content=c,this.version=r}get tl(){return[this.paddedRect.x+es,this.paddedRect.y+es]}get br(){return[this.paddedRect.x+this.paddedRect.w-es,this.paddedRect.y+this.paddedRect.h-es]}get displaySize(){return[(this.paddedRect.w-2*es)/this.pixelRatio,(this.paddedRect.h-2*es)/this.pixelRatio]}}class Eb{constructor(t,n){const r={},o={};this.haveRenderCallbacks=[];const s=[];this.addImages(t,r,s),this.addImages(n,o,s);const{w:c,h:u}=ag(s),d=new $r({width:c||1,height:u||1});for(const f in t){const m=t[f],g=r[f].paddedRect;$r.copy(m.data,d,{x:0,y:0},{x:g.x+es,y:g.y+es},m.data)}for(const f in n){const m=n[f],g=o[f].paddedRect,y=g.x+es,v=g.y+es,x=m.data.width,w=m.data.height;$r.copy(m.data,d,{x:0,y:0},{x:y,y:v},m.data),$r.copy(m.data,d,{x:0,y:w-1},{x:y,y:v-1},{width:x,height:1}),$r.copy(m.data,d,{x:0,y:0},{x:y,y:v+w},{width:x,height:1}),$r.copy(m.data,d,{x:x-1,y:0},{x:y-1,y:v},{width:1,height:w}),$r.copy(m.data,d,{x:0,y:0},{x:y+x,y:v},{width:1,height:w})}this.image=d,this.iconPositions=r,this.patternPositions=o}addImages(t,n,r){for(const o in t){const s=t[o],c={x:0,y:0,w:s.data.width+2*es,h:s.data.height+2*es};r.push(c),n[o]=new Jy(c,s),s.hasRenderCallback&&this.haveRenderCallbacks.push(o)}}patchUpdatedImages(t,n,r){this.haveRenderCallbacks=this.haveRenderCallbacks.filter(o=>t.hasImage(o,r)),t.dispatchRenderCallbacks(this.haveRenderCallbacks,r);for(const o in t.getUpdatedImages(r))this.patchUpdatedImage(this.iconPositions[o],t.getImage(o,r),n),this.patchUpdatedImage(this.patternPositions[o],t.getImage(o,r),n)}patchUpdatedImage(t,n,r){if(!t||!n||t.version===n.version)return;t.version=n.version;const[o,s]=t.tl;r.update(n.data,void 0,{x:o,y:s})}}re(Jy,"ImagePosition"),re(Eb,"ImageAtlas");const td=1e20;function Tb(e,t,n,r,o,s,c,u,d){for(let f=t;f<t+r;f++)Mb(e,n*s+f,s,o,c,u,d);for(let f=n;f<n+o;f++)Mb(e,f*s+t,1,r,c,u,d)}function Mb(e,t,n,r,o,s,c){s[0]=0,c[0]=-td,c[1]=td,o[0]=e[t];for(let u=1,d=0,f=0;u<r;u++){o[u]=e[t+u*n];const m=u*u;do{const g=s[d];f=(o[u]-o[g]+m-g*g)/(u-g)/2}while(f<=c[d]&&--d>-1);d++,s[d]=u,c[d]=f,c[d+1]=td}for(let u=0,d=0;u<r;u++){for(;c[d+1]<u;)d++;const f=s[d],m=u-f;e[t+u*n]=o[f]+m*m}}const ws=2;class ed{constructor(t,n,r){this.requestManager=t,this.localGlyphMode=n,this.localFontFamily=r,this.urls={},this.entries={},this.localGlyphs={200:{},400:{},500:{},900:{}}}setURL(t,n){this.urls[n]=t}getGlyphs(t,n,r){const o=[],s=this.urls[n]||Te.GLYPHS_URL;for(const c in t)for(const u of t[c])o.push({stack:c,id:u});mo(o,({stack:c,id:u},d)=>{let f=this.entries[c];f||(f=this.entries[c]={glyphs:{},requests:{},ranges:{},ascender:void 0,descender:void 0});let m=f.glyphs[u];if(void 0!==m)return void d(null,{stack:c,id:u,glyph:m});if(m=this._tinySDF(f,c,u),m)return f.glyphs[u]=m,void d(null,{stack:c,id:u,glyph:m});const g=Math.floor(u/256);if(256*g>65535)return void d(new Error("glyphs > 65535 not supported"));if(f.ranges[g])return void d(null,{stack:c,id:u,glyph:m});let y=f.requests[g];y||(y=f.requests[g]=[],ed.loadGlyphRange(c,g,s,this.requestManager,(v,x)=>{if(x){f.ascender=x.ascender,f.descender=x.descender;for(const w in x.glyphs)this._doesCharSupportLocalGlyph(+w)||(f.glyphs[+w]=x.glyphs[+w]);f.ranges[g]=!0}for(const w of y)w(v,x);delete f.requests[g]})),y.push((v,x)=>{v?d(v):x&&d(null,{stack:c,id:u,glyph:x.glyphs[u]||null})})},(c,u)=>{if(c)r(c);else if(u){const d={};for(const{stack:f,id:m,glyph:g}of u)void 0===d[f]&&(d[f]={}),void 0===d[f].glyphs&&(d[f].glyphs={}),d[f].glyphs[m]=g&&{id:g.id,bitmap:g.bitmap.clone(),metrics:g.metrics},d[f].ascender=this.entries[f].ascender,d[f].descender=this.entries[f].descender;r(null,d)}})}_doesCharSupportLocalGlyph(t){return 0!==this.localGlyphMode&&(2===this.localGlyphMode?!!this.localFontFamily:!!this.localFontFamily&&(ie["CJK Unified Ideographs"](t)||ie["Hangul Syllables"](t)||ie.Hiragana(t)||ie.Katakana(t)||ie["CJK Symbols and Punctuation"](t)||ie["CJK Unified Ideographs Extension A"](t)||ie["CJK Unified Ideographs Extension B"](t)))}_tinySDF(t,n,r){const o=this.localFontFamily;if(!o||!this._doesCharSupportLocalGlyph(r))return;let s=t.tinySDF;if(!s){let w="400";/bold/i.test(n)?w="900":/medium/i.test(n)?w="500":/light/i.test(n)&&(w="200"),s=t.tinySDF=new ed.TinySDF({fontFamily:o,fontWeight:w,fontSize:24*ws,buffer:3*ws,radius:8*ws}),s.fontWeight=w}if(this.localGlyphs[s.fontWeight][r])return this.localGlyphs[s.fontWeight][r];const c=String.fromCodePoint(r),{data:u,width:d,height:f,glyphWidth:m,glyphHeight:g,glyphLeft:y,glyphTop:v,glyphAdvance:x}=s.draw(c);return this.localGlyphs[s.fontWeight][r]={id:r,bitmap:new Ga({width:d,height:f},u),metrics:{width:m/ws,height:g/ws,left:y/ws,top:v/ws-27,advance:x/ws,localGlyph:!0}}}}ed.loadGlyphRange=function(e,t,n,r,o){const s=256*t,c=s+255,u=r.transformRequest(r.normalizeGlyphsURL(n).replace("{fontstack}",e).replace("{range}",`${s}-${c}`),yt.Glyphs);$t(u,(d,f)=>{if(d)o(d);else if(f){const m={},g=new Qm(f).readFields(iI,{});for(const y of g.glyphs)m[y.id]=y;o(null,{glyphs:m,ascender:g.ascender,descender:g.descender})}})},ed.TinySDF=class{constructor({fontSize:e=24,buffer:t=3,radius:n=8,cutoff:r=.25,fontFamily:o="sans-serif",fontWeight:s="normal",fontStyle:c="normal"}={}){this.buffer=t,this.cutoff=r,this.radius=n;const u=this.size=e+4*t,d=this._createCanvas(u),f=this.ctx=d.getContext("2d",{willReadFrequently:!0});f.font=`${c} ${s} ${e}px ${o}`,f.textBaseline="alphabetic",f.textAlign="left",f.fillStyle="black",this.gridOuter=new Float64Array(u*u),this.gridInner=new Float64Array(u*u),this.f=new Float64Array(u),this.z=new Float64Array(u+1),this.v=new Uint16Array(u)}_createCanvas(e){const t=document.createElement("canvas");return t.width=t.height=e,t}draw(e){const{width:t,actualBoundingBoxAscent:n,actualBoundingBoxDescent:r,actualBoundingBoxLeft:o,actualBoundingBoxRight:s}=this.ctx.measureText(e),c=Math.ceil(n),u=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(s-o))),d=Math.min(this.size-this.buffer,c+Math.ceil(r)),f=u+2*this.buffer,m=d+2*this.buffer,g=Math.max(f*m,0),y=new Uint8ClampedArray(g),v={data:y,width:f,height:m,glyphWidth:u,glyphHeight:d,glyphTop:c,glyphLeft:0,glyphAdvance:t};if(0===u||0===d)return v;const{ctx:x,buffer:w,gridInner:E,gridOuter:M}=this;x.clearRect(w,w,u,d),x.fillText(e,w,w+c);const D=x.getImageData(w,w,u,d);M.fill(td,0,g),E.fill(0,0,g);for(let A=0;A<d;A++)for(let P=0;P<u;P++){const C=D.data[4*(A*u+P)+3]/255;if(0===C)continue;const R=(A+w)*f+P+w;if(1===C)M[R]=0,E[R]=td;else{const k=.5-C;M[R]=k>0?k*k:0,E[R]=k<0?k*k:0}}Tb(M,0,0,f,m,f,this.f,this.v,this.z),Tb(E,w,w,u,d,f,this.f,this.v,this.z);for(let A=0;A<g;A++){const P=Math.sqrt(M[A])-Math.sqrt(E[A]);y[A]=Math.round(255-255*(P/this.radius+this.cutoff))}return v}};const Cc=es;function Ib(e,t,n,r){const o=[],s=e.imagePrimary,c=s.pixelRatio,u=s.paddedRect.w-2*Cc,d=s.paddedRect.h-2*Cc,f=e.right-e.left,m=e.bottom-e.top,g=s.stretchX||[[0,u]],y=s.stretchY||[[0,d]],v=(U,$)=>U+$[1]-$[0],x=g.reduce(v,0),w=y.reduce(v,0),E=u-x,M=d-w;let D=0,A=x,P=0,C=w,R=0,k=E,N=0,z=M;if(s.content&&r){const U=s.content;D=lg(g,0,U[0]),P=lg(y,0,U[1]),A=lg(g,U[0],U[2]),C=lg(y,U[1],U[3]),R=U[0]-D,N=U[1]-P,k=U[2]-U[0]-A,z=U[3]-U[1]-C}const B=(U,$,W,V)=>{const K=Es(U.stretch-D,A,f,e.left),Q=nd(U.fixed-R,k,U.stretch,x),ot=Es($.stretch-P,C,m,e.top),Y=nd($.fixed-N,z,$.stretch,w),J=Es(W.stretch-D,A,f,e.left),ct=nd(W.fixed-R,k,W.stretch,x),dt=Es(V.stretch-P,C,m,e.top),ht=nd(V.fixed-N,z,V.stretch,w),_t=new it(K,ot),vt=new it(J,ot),xt=new it(J,dt),mt=new it(K,dt),Ct=new it(Q/c,Y/c),Ut=new it(ct/c,ht/c),Gt=t*Math.PI/180;if(Gt){const Ye=Math.sin(Gt),Ie=Math.cos(Gt),we=[Ie,-Ye,Ye,Ie];_t._matMult(we),vt._matMult(we),mt._matMult(we),xt._matMult(we)}const Yt=U.stretch+U.fixed,te=W.stretch+W.fixed,Me=$.stretch+$.fixed,ue=V.stretch+V.fixed,dn=e.imageSecondary;return{tl:_t,tr:vt,bl:mt,br:xt,texPrimary:{x:s.paddedRect.x+Cc+Yt,y:s.paddedRect.y+Cc+Me,w:te-Yt,h:ue-Me},texSecondary:dn?{x:dn.paddedRect.x+Cc+Yt,y:dn.paddedRect.y+Cc+Me,w:te-Yt,h:ue-Me}:void 0,writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:Ct,pixelOffsetBR:Ut,minFontScaleX:k/c/f,minFontScaleY:z/c/m,isSDF:n}};if(r&&(s.stretchX||s.stretchY)){const U=Db(g,E,x),$=Db(y,M,w);for(let W=0;W<U.length-1;W++){const V=U[W],K=U[W+1];for(let Q=0;Q<$.length-1;Q++)o.push(B(V,$[Q],K,$[Q+1]))}}else o.push(B({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:u+1},{fixed:0,stretch:d+1}));return o}function lg(e,t,n){let r=0;for(const o of e)r+=Math.max(t,Math.min(n,o[1]))-Math.max(t,Math.min(n,o[0]));return r}function Db(e,t,n){const r=[{fixed:-Cc,stretch:0}];for(const[o,s]of e){const c=r[r.length-1];r.push({fixed:o-c.stretch,stretch:c.stretch}),r.push({fixed:o-c.stretch,stretch:c.stretch+(s-o)})}return r.push({fixed:t+Cc,stretch:n}),r}function Es(e,t,n,r){return e/t*n+r}function nd(e,t,n,r){return e-t*n/r}function hI(e,t,n,r){const o=t+e.positionedLines[r].lineOffset;return 0===r?n+o/2:n+(o+(t+e.positionedLines[r-1].lineOffset))/2}function Sb(e,t=1,n=!1){let r=1/0,o=1/0,s=-1/0,c=-1/0;const u=e[0];for(let v=0;v<u.length;v++){const x=u[v];(!v||x.x<r)&&(r=x.x),(!v||x.y<o)&&(o=x.y),(!v||x.x>s)&&(s=x.x),(!v||x.y>c)&&(c=x.y)}const d=Math.min(s-r,c-o);let f=d/2;const m=new Dt([],dI);if(0===d)return new it(r,o);for(let v=r;v<s;v+=d)for(let x=o;x<c;x+=d)m.push(new Cu(v+f,x+f,f,e));let g=function(v){let x=0,w=0,E=0;const M=v[0];for(let D=0,A=M.length,P=A-1;D<A;P=D++){const C=M[D],R=M[P],k=C.x*R.y-R.x*C.y;w+=(C.x+R.x)*k,E+=(C.y+R.y)*k,x+=3*k}return new Cu(w/x,E/x,0,v)}(e),y=m.length;for(;m.length;){const v=m.pop();(v.d>g.d||!g.d)&&(g=v,n&&console.log("found best %d after %d probes",Math.round(1e4*v.d)/1e4,y)),v.max-g.d<=t||(f=v.h/2,m.push(new Cu(v.p.x-f,v.p.y-f,f,e)),m.push(new Cu(v.p.x+f,v.p.y-f,f,e)),m.push(new Cu(v.p.x-f,v.p.y+f,f,e)),m.push(new Cu(v.p.x+f,v.p.y+f,f,e)),y+=4)}return n&&(console.log(`num probes: ${y}`),console.log(`best distance: ${g.d}`)),g.p}function dI(e,t){return t.max-e.max}class Cu{constructor(t,n,r,o){this.p=new it(t,n),this.h=r,this.d=function(s,c){let u=!1,d=1/0;for(let f=0;f<c.length;f++){const m=c[f];for(let g=0,y=m.length,v=y-1;g<y;v=g++){const x=m[g],w=m[v];x.y>s.y!=w.y>s.y&&s.x<(w.x-x.x)*(s.y-x.y)/(w.y-x.y)+x.x&&(u=!u),d=Math.min(d,Ty(s,x,w))}}return(u?1:-1)*Math.sqrt(d)}(this.p,o),this.max=this.d+this.h*Math.SQRT2}}const Au=7,rd=Number.POSITIVE_INFINITY,Qy=Math.sqrt(2);function Cb(e,[t,n]){let r=0,o=0;if(n===rd){t<0&&(t=0);const s=t/Qy;switch(e){case"top-right":case"top-left":o=s-Au;break;case"bottom-right":case"bottom-left":o=-s+Au;break;case"bottom":o=-t+Au;break;case"top":o=t-Au}switch(e){case"top-right":case"bottom-right":r=-s;break;case"top-left":case"bottom-left":r=s;break;case"left":r=t;break;case"right":r=-t}}else{switch(t=Math.abs(t),n=Math.abs(n),e){case"top-right":case"top-left":case"top":o=n-Au;break;case"bottom-right":case"bottom-left":case"bottom":o=-n+Au}switch(e){case"top-right":case"bottom-right":case"right":r=-t;break;case"top-left":case"bottom-left":case"left":r=t}}return[r,o]}function Ab(e,t,n,r,o,s,c,u,d,f,m){e.createArrays(),e.tilePixelRatio=et/(512*e.overscaling),e.compareText={},e.iconsNeedLinear=!1;const g=e.layers[0].layout,y=e.layers[0]._unevaluatedLayout._values,v={};if("composite"===e.textSizeData.kind){const{minZoom:M,maxZoom:D}=e.textSizeData;v.compositeTextSizes=[y["text-size"].possiblyEvaluate(new ar(M),u),y["text-size"].possiblyEvaluate(new ar(D),u)]}if("composite"===e.iconSizeData.kind){const{minZoom:M,maxZoom:D}=e.iconSizeData;v.compositeIconSizes=[y["icon-size"].possiblyEvaluate(new ar(M),u),y["icon-size"].possiblyEvaluate(new ar(D),u)]}v.layoutTextSize=y["text-size"].possiblyEvaluate(new ar(d+1),u),v.layoutIconSize=y["icon-size"].possiblyEvaluate(new ar(d+1),u),v.textMaxSize=y["text-size"].possiblyEvaluate(new ar(18),u);const x="map"===g.get("text-rotation-alignment")&&"point"!==g.get("symbol-placement"),w=g.get("text-size");let E=!1;for(const M of e.features)if(M.icon&&M.icon.nameSecondary){E=!0;break}for(const M of e.features){const D=g.get("text-font").evaluate(M,{},u).join(","),A=w.evaluate(M,{},u),P=v.layoutTextSize.evaluate(M,{},u),C=(v.layoutIconSize.evaluate(M,{},u),{horizontal:{},vertical:void 0}),R=M.text;let k,N=[0,0];if(R){const U=R.toString(),$=g.get("text-letter-spacing").evaluate(M,{},u)*wi,W=g.get("text-line-height").evaluate(M,{},u)*wi,V=eM(U)?$:0,K=g.get("text-anchor").evaluate(M,{},u),Q=g.get("text-variable-anchor");if(!Q){const dt=g.get("text-radial-offset").evaluate(M,{},u);N=dt?Cb(K,[dt*wi,rd]):g.get("text-offset").evaluate(M,{},u).map(ht=>ht*wi)}let ot=x?"center":g.get("text-justify").evaluate(M,{},u);const Y="point"===g.get("symbol-placement"),J=Y?g.get("text-max-width").evaluate(M,{},u)*wi:1/0,ct=dt=>{e.allowVerticalPlacement&&E_(U)&&(C.vertical=Jf(R,t,n,o,D,J,W,K,dt,V,N,er.vertical,!0,P,A))};if(!x&&Q){const dt="auto"===ot?Q.map(_t=>cg(_t)):[ot];let ht=!1;for(let _t=0;_t<dt.length;_t++){const vt=dt[_t];if(!C.horizontal[vt])if(ht)C.horizontal[vt]=C.horizontal[0];else{const xt=Jf(R,t,n,o,D,J,W,"center",vt,V,N,er.horizontal,!1,P,A);xt&&(C.horizontal[vt]=xt,ht=1===xt.positionedLines.length)}}ct("left")}else{if("auto"===ot&&(ot=cg(K)),Y||g.get("text-writing-mode").indexOf("horizontal")>=0||!E_(U)){const dt=Jf(R,t,n,o,D,J,W,K,ot,V,N,er.horizontal,!1,P,A);dt&&(C.horizontal[ot]=dt)}ct(Y?"left":ot)}}let z=!1;if(M.icon&&M.icon.namePrimary){const U=r[M.icon.namePrimary];U&&(k=aI(o[M.icon.namePrimary],M.icon.nameSecondary?o[M.icon.nameSecondary]:void 0,g.get("icon-offset").evaluate(M,{},u),g.get("icon-anchor").evaluate(M,{},u)),z=U.sdf,void 0===e.sdfIcons?e.sdfIcons=U.sdf:e.sdfIcons!==U.sdf&&nt("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(U.pixelRatio!==e.pixelRatio||0!==g.get("icon-rotate").constantOr(1))&&(e.iconsNeedLinear=!0))}const B=Rb(C.horizontal)||C.vertical;e.iconsInText||(e.iconsInText=!!B&&B.iconsInText),(B||k)&&Pb(e,M,C,k,r,v,P,0,N,z,c,u,f,m,E)}s&&e.generateCollisionDebugBuffers(d,e.collisionBoxArray)}function cg(e){switch(e){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function Pb(e,t,n,r,o,s,c,u,d,f,m,g,y,v,x){let w=s.textMaxSize.evaluate(t,{},g);void 0===w&&(w=c);const E=e.layers[0].layout,M=E.get("icon-offset").evaluate(t,{},g),D=Rb(n.horizontal)||n.vertical,A="globe"===y.name,P=wi,C=c/P,R=e.tilePixelRatio*w/P,k=(K=e.overscaling,e.zoom>18&&K>2&&(K>>=1),Math.max(et/(512*K),1)*E.get("symbol-spacing")),N=E.get("text-padding")*e.tilePixelRatio,z=E.get("icon-padding")*e.tilePixelRatio,B=Oe(E.get("text-max-angle")),U="map"===E.get("text-rotation-alignment")&&"point"!==E.get("symbol-placement"),$="map"===E.get("icon-rotation-alignment")&&"point"!==E.get("symbol-placement"),W=E.get("symbol-placement"),V=k/2;var K;const Q=E.get("icon-text-fit").evaluate(t,{},g),ot=E.get("icon-text-fit-padding").evaluate(t,{},g),Y="none"!==Q;let J;!1===e.hasAnyIconTextFit&&Y&&(e.hasAnyIconTextFit=!0),r&&Y&&(e.allowVerticalPlacement&&n.vertical&&(J=xb(r,n.vertical,Q,ot,M,C)),D&&(r=xb(r,D,Q,ot,M,C)));const ct=(dt,ht,_t)=>{if(ht.x<0||ht.x>=et||ht.y<0||ht.y>=et)return;let vt=null;if(A){const{x:xt,y:mt,z:Ct}=y.projectTilePoint(ht.x,ht.y,_t);vt={anchor:new Za(xt,mt,Ct,0,void 0),up:y.upVector(_t,ht.x,ht.y)}}!function(xt,mt,Ct,Ut,Gt,Yt,te,Me,ue,dn,Ye,Ie,we,fe,Ke,rn,Be,yn,Ir,Sn,Zn,Vr,br,Yn,bn,Ni,Ul){const Oc=xt.addToLineVertexArray(mt,Ut);let el,Np,zp,n_,pT,qv,Zv,Wv=0,mT=0,gT=0,Xv=0,$d=-1,_T=-1;const ga={};let Hd=au("");const Yu=Ct?Ct.anchor:mt,Yv="none"!==ue.layout.get("icon-text-fit").evaluate(Zn,{},bn);let yT=0,vT=0;if(void 0===ue._unevaluatedLayout.getValue("text-radial-offset")?[yT,vT]=ue.layout.get("text-offset").evaluate(Zn,{},bn).map(os=>os*wi):(yT=ue.layout.get("text-radial-offset").evaluate(Zn,{},bn)*wi,vT=rd),xt.allowVerticalPlacement&&Gt.vertical){const os=Gt.vertical;if(Ke)qv=Qf(os),Me&&(Zv=Qf(Me));else{const Ao=ue.layout.get("text-rotate").evaluate(Zn,{},bn)+90;zp=ug(dn,Yu,mt,Ye,Ie,we,os,fe,Ao,rn),Me&&(n_=ug(dn,Yu,mt,Ye,Ie,we,Me,yn,Ao))}}if(Yt){const os=ue.layout.get("icon-rotate").evaluate(Zn,{},bn),Ao=Ib(Yt,os,br,Yv),Ju=Me?Ib(Me,os,br,Yv):void 0;Np=ug(dn,Yu,mt,Ye,Ie,we,Yt,yn,os),Wv=4*Ao.length;const bT=xt.iconSizeData;let kc=null;"source"===bT.kind?(kc=[Qo*ue.layout.get("icon-size").evaluate(Zn,{},bn)],kc[0]>Wa&&nt(`${xt.layerIds[0]}: Value for "icon-size" is >= ${id}. Reduce your "icon-size".`)):"composite"===bT.kind&&(kc=[Qo*Vr.compositeIconSizes[0].evaluate(Zn,{},bn),Qo*Vr.compositeIconSizes[1].evaluate(Zn,{},bn)],(kc[0]>Wa||kc[1]>Wa)&&nt(`${xt.layerIds[0]}: Value for "icon-size" is >= ${id}. Reduce your "icon-size".`)),xt.addSymbols(xt.icon,Ao,kc,Sn,Ir,Zn,!1,Ct,mt,Oc.lineStartIndex,Oc.lineLength,-1,Yn,bn,Ni,Ul),$d=xt.icon.placedSymbolArray.length-1,Ju&&(mT=4*Ju.length,xt.addSymbols(xt.icon,Ju,kc,Sn,Ir,Zn,er.vertical,Ct,mt,Oc.lineStartIndex,Oc.lineLength,-1,Yn,bn,Ni,Ul),_T=xt.icon.placedSymbolArray.length-1)}for(const os in Gt.horizontal){const Ao=Gt.horizontal[os];el||(Hd=au(Ao.text),Ke?pT=Qf(Ao):el=ug(dn,Yu,mt,Ye,Ie,we,Ao,fe,ue.layout.get("text-rotate").evaluate(Zn,{},bn),rn));const Ju=1===Ao.positionedLines.length;if(gT+=Xa(xt,Ct,mt,Ao,te,ue,Ke,Zn,rn,Oc,Gt.vertical?er.horizontal:er.horizontalOnly,Ju?Object.keys(Gt.horizontal):[os],ga,$d,Vr,Yn,bn,Ni),Ju)break}Gt.vertical&&(Xv+=Xa(xt,Ct,mt,Gt.vertical,te,ue,Ke,Zn,rn,Oc,er.vertical,["vertical"],ga,_T,Vr,Yn,bn,Ni));let Ku=-1;const xT=(os,Ao)=>os?Math.max(os,Ao):Ao;Ku=xT(pT,Ku),Ku=xT(qv,Ku),Ku=xT(Zv,Ku);const jS=Ku>-1?1:0;xt.glyphOffsetArray.length>=ud.MAX_GLYPHS&&nt("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),void 0!==Zn.sortKey&&xt.addToSortKeyRanges(xt.symbolInstances.length,Zn.sortKey),xt.symbolInstances.emplaceBack(mt.x,mt.y,Yu.x,Yu.y,Yu.z,ga.right>=0?ga.right:-1,ga.center>=0?ga.center:-1,ga.left>=0?ga.left:-1,ga.vertical>=0?ga.vertical:-1,$d,_T,Hd,void 0!==el?el:xt.collisionBoxArray.length,void 0!==el?el+1:xt.collisionBoxArray.length,void 0!==zp?zp:xt.collisionBoxArray.length,void 0!==zp?zp+1:xt.collisionBoxArray.length,void 0!==Np?Np:xt.collisionBoxArray.length,void 0!==Np?Np+1:xt.collisionBoxArray.length,n_||xt.collisionBoxArray.length,n_?n_+1:xt.collisionBoxArray.length,Ye,gT,Xv,Wv,mT,jS,0,yT,vT,Ku,0,Yv?1:0)}(e,ht,vt,dt,n,r,o,J,e.layers[0],e.collisionBoxArray,t.index,t.sourceLayerIndex,e.index,N,U,d,0,z,$,M,t,s,f,m,g,v,x)};if("line"===W)for(const dt of sg(t.geometry,0,0,et,et)){const ht=cI(dt,k,B,n.vertical||D,r,P,R,e.overscaling,et);for(const _t of ht)D&&fI(e,D.text,V,_t)||ct(dt,_t,g)}else if("line-center"===W){for(const dt of t.geometry)if(dt.length>1){const ht=lI(dt,B,n.vertical||D,r,P,R);ht&&ct(dt,ht,g)}}else if("Polygon"===t.type)for(const dt of ky(t.geometry,0)){const ht=Sb(dt,16);ct(dt[0],new Za(ht.x,ht.y,0,0,void 0),g)}else if("LineString"===t.type)for(const dt of t.geometry)ct(dt,new Za(dt[0].x,dt[0].y,0,0,void 0),g);else if("Point"===t.type)for(const dt of t.geometry)for(const ht of dt)ct([ht],new Za(ht.x,ht.y,0,0,void 0),g)}const id=255,Wa=id*Qo;function Xa(e,t,n,r,o,s,c,u,d,f,m,g,y,v,x,w,E,M){const D=function(C,R,k,N,z,B,U,$){const W=[];if(0===R.positionedLines.length)return W;const V=N.layout.get("text-rotate").evaluate(B,{})*Math.PI/180,K=function(ct){const dt=ct[0],ht=ct[1],_t=dt*ht;return _t>0?[dt,-ht]:_t<0?[-dt,ht]:0===dt?[ht,dt]:[ht,-dt]}(k);let Q=Math.abs(R.top-R.bottom);for(const ct of R.positionedLines)Q-=ct.lineOffset;const ot=R.positionedLines.length,Y=Q/ot;let J=R.top-k[1];for(let ct=0;ct<ot;++ct){const dt=R.positionedLines[ct];J=hI(R,Y,J,ct);for(const ht of dt.positionedGlyphs){if(!ht.rect)continue;const _t=ht.rect||{};let vt=Su+1,xt=!0,mt=1,Ct=0;if(ht.imageName){const Sn=U[ht.imageName];if(!Sn)continue;if(Sn.sdf){nt("SDF images are not supported in formatted text and will be ignored.");continue}xt=!1,mt=Sn.pixelRatio,vt=es/mt}const Ut=(z||$)&&ht.vertical,Gt=ht.metrics.advance*ht.scale/2,Yt=ht.metrics,te=ht.rect;if(null===te)continue;$&&R.verticalizable&&(Ct=ht.imageName?Gt-ht.metrics.width*ht.scale/2:0);const Me=z?[ht.x+Gt,ht.y]:[0,0];let ue=[0,0],dn=[0,0],Ye=!1;z||(Ut?(dn=[ht.x+Gt+K[0],ht.y+K[1]-Ct],Ye=!0):ue=[ht.x+Gt+k[0],ht.y+k[1]-Ct]);const Ie=te.w*ht.scale/(mt*(ht.localGlyph?ws:1)),we=te.h*ht.scale/(mt*(ht.localGlyph?ws:1));let fe,Ke,rn,Be;if(Ut){const Sn=ht.y-J,Zn=new it(-Gt,Gt-Sn),Vr=-Math.PI/2,br=new it(...dn);fe=new it(-Gt+ue[0],ue[1]),fe._rotateAround(Vr,Zn)._add(br),fe.x+=-Sn+Gt,fe.y-=(Yt.left-vt)*ht.scale;const Yn=ht.imageName?Yt.advance*ht.scale:wi*ht.scale,bn=String.fromCodePoint(ht.glyph);rI(bn)?fe.x+=(1-vt)*ht.scale:mb(bn)?fe.x+=Yn-Yt.height*ht.scale+(-vt-1)*ht.scale:fe.x+=ht.imageName||Yt.width+2*vt===te.w&&Yt.height+2*vt===te.h?(Yn-we)/2:(Yn-(Yt.height+2*vt)*ht.scale)/2,Ke=new it(fe.x,fe.y-Ie),rn=new it(fe.x+we,fe.y),Be=new it(fe.x+we,fe.y-Ie)}else{const Sn=(Yt.left-vt)*ht.scale-Gt+ue[0],Zn=(-Yt.top-vt)*ht.scale+ue[1],Vr=Sn+Ie,br=Zn+we;fe=new it(Sn,Zn),Ke=new it(Vr,Zn),rn=new it(Sn,br),Be=new it(Vr,br)}if(V){let Sn;Sn=z?new it(0,0):Ye?new it(K[0],K[1]):new it(k[0],k[1]),fe._rotateAround(V,Sn),Ke._rotateAround(V,Sn),rn._rotateAround(V,Sn),Be._rotateAround(V,Sn)}const yn=new it(0,0),Ir=new it(0,0);W.push({tl:fe,tr:Ke,bl:rn,br:Be,texPrimary:_t,texSecondary:void 0,writingMode:R.writingMode,glyphOffset:Me,sectionIndex:ht.sectionIndex,isSDF:xt,pixelOffsetTL:yn,pixelOffsetBR:Ir,minFontScaleX:0,minFontScaleY:0})}}return W}(0,r,d,s,c,u,o,e.allowVerticalPlacement),A=e.textSizeData;let P=null;"source"===A.kind?(P=[Qo*s.layout.get("text-size").evaluate(u,{},E)],P[0]>Wa&&nt(`${e.layerIds[0]}: Value for "text-size" is >= ${id}. Reduce your "text-size".`)):"composite"===A.kind&&(P=[Qo*x.compositeTextSizes[0].evaluate(u,{},E),Qo*x.compositeTextSizes[1].evaluate(u,{},E)],(P[0]>Wa||P[1]>Wa)&&nt(`${e.layerIds[0]}: Value for "text-size" is >= ${id}. Reduce your "text-size".`)),e.addSymbols(e.text,D,P,d,c,u,m,t,n,f.lineStartIndex,f.lineLength,v,w,E,M,!1);for(const C of g)y[C]=e.text.placedSymbolArray.length-1;return 4*D.length}function Rb(e){for(const t in e)return e[t];return null}function ug(e,t,n,r,o,s,c,u,d,f){let m=c.top,g=c.bottom,y=c.left,v=c.right;const x=c.collisionPadding;if(x&&(y-=x[0],m-=x[1],v+=x[2],g+=x[3]),d){const w=new it(y,m),E=new it(v,m),M=new it(y,g),D=new it(v,g),A=Oe(d);let P=new it(0,0);f&&(P=new it(f[0],f[1])),w._rotateAround(A,P),E._rotateAround(A,P),M._rotateAround(A,P),D._rotateAround(A,P),y=Math.min(w.x,E.x,M.x,D.x),v=Math.max(w.x,E.x,M.x,D.x),m=Math.min(w.y,E.y,M.y,D.y),g=Math.max(w.y,E.y,M.y,D.y)}return e.emplaceBack(t.x,t.y,t.z,n.x,n.y,y,m,v,g,u,r,o,s),e.length-1}function Qf(e){e.collisionPadding&&(e.top-=e.collisionPadding[1],e.bottom+=e.collisionPadding[3]);const t=e.bottom-e.top;return t>0?Math.max(10,t):null}function fI(e,t,n,r){const o=e.compareText;if(t in o){const s=o[t];for(let c=s.length-1;c>=0;c--)if(r.dist(s[c])<n)return!0}else o[t]=[];return o[t].push(r),!1}function t0(e,t){const n=e.fovAboveCenter,r=e.elevation?e.elevation.getMinElevationBelowMSL()*t:0,o=(e._camera.position[2]*e.worldSize-r)/Math.cos(e._pitch),s=Math.sin(n)*o/Math.sin(Math.max(Math.PI/2-e._pitch-n,.01)),c=Math.sin(e._pitch)*s+o;return Math.min(1.01*c,o*(1/e._horizonShift))}function Pu(e,t){if(!t.isReprojectedInTileSpace)return{scale:1<<e.z,x:e.x,y:e.y,x2:e.x+1,y2:e.y+1,projection:t};const n=Math.pow(2,-e.z),r=e.x*n,o=(e.x+1)*n,s=e.y*n,c=(e.y+1)*n,u=Jo(r),d=Jo(o),f=xr(s),m=xr(c),g=t.project(u,f),y=t.project(d,f),v=t.project(d,m),x=t.project(u,m);let w=Math.min(g.x,y.x,v.x,x.x),E=Math.min(g.y,y.y,v.y,x.y),M=Math.max(g.x,y.x,v.x,x.x),D=Math.max(g.y,y.y,v.y,x.y);const A=n/16;function P(R,k,N,z,B,U){const $=(N+B)/2,W=(z+U)/2,V=t.project(Jo($),xr(W)),K=Math.max(0,w-V.x,E-V.y,V.x-M,V.y-D);w=Math.min(w,V.x),M=Math.max(M,V.x),E=Math.min(E,V.y),D=Math.max(D,V.y),K>A&&(P(R,V,N,z,$,W),P(V,k,$,W,B,U))}P(g,y,r,s,o,s),P(y,v,o,s,o,c),P(v,x,o,c,r,c),P(x,g,r,c,r,s),w-=A,E-=A,M+=A,D+=A;const C=1/Math.max(M-w,D-E);return{scale:C,x:w*C,y:E*C,x2:M*C,y2:D*C,projection:t}}function tp(e,t,n,r,o,s,c,u,d){if("globe"===d.name)return cy(e,t,new xs(n,r,o),!1);const f=Pu({z:n,x:r,y:o},d);return new Bn([(s+f.x/f.scale)*t,t*(f.y/f.scale),c],[(s+f.x2/f.scale)*t,t*(f.y2/f.scale),u])}function od(e,{x:t,y:n},r=0){return new it(((t-r)*e.scale-e.x)*et,(n*e.scale-e.y)*et)}function e0(e,t,n=0){return Z.fromValues(((t.x-n)*e.scale-e.x)*et,(t.y*e.scale-e.y)*et,z1(t.z,t.y))}const hg=st.identity(new Float32Array(16));class Ru{constructor(t){this.spec=t,this.name=t.name,this.wrap=!1,this.requiresDraping=!1,this.supportsWorldCopies=!1,this.supportsTerrain=!1,this.supportsFog=!1,this.supportsFreeCamera=!1,this.zAxisUnit="meters",this.isReprojectedInTileSpace=!0,this.unsupportedLayers=["custom"],this.center=[0,0],this.range=[3.5,7]}project(t,n){return{x:0,y:0,z:0}}unproject(t,n){return new Se(0,0)}projectTilePoint(t,n,r){return{x:t,y:n,z:0}}locationPoint(t,n,r=!0){return t._coordinatePoint(t.locationCoordinate(n),r)}pixelsPerMeter(t,n){return Ln(1,t)*n}pixelSpaceConversion(t,n,r){return 1}farthestPixelDistance(t){return t0(t,t.pixelsPerMeter)}pointCoordinate(t,n,r,o){const s=t.horizonLineFromTop(!1),c=new it(n,Math.max(s,r));return t.rayIntersectionCoordinate(t.pointRayIntersection(c,o))}pointCoordinate3D(t,n,r){const o=new it(n,r);if(t.elevation)return t.elevation.pointCoordinate(o);{const s=this.pointCoordinate(t,o.x,o.y,0);return[s.x,s.y,s.z]}}isPointAboveHorizon(t,n){if(t.elevation)return!this.pointCoordinate3D(t,n.x,n.y);const r=t.horizonLineFromTop();return n.y<r}createInversionMatrix(t,n){return hg}createTileMatrix(t,n,r){let o,s,c;const u=r.canonical,d=st.identity(new Float64Array(16));if(this.isReprojectedInTileSpace){const f=Pu(u,this);o=1,s=f.x+r.wrap*f.scale,c=f.y,st.scale(d,d,[o/f.scale,o/f.scale,t.pixelsPerMeter/n])}else o=n/t.zoomScale(u.z),s=(u.x+Math.pow(2,u.z)*r.wrap)*o,c=u.y*o;return st.translate(d,d,[s,c,0]),st.scale(d,d,[o/et,o/et,1]),d}upVector(t,n,r){return[0,0,1]}upVectorScale(t,n,r){return{metersToTile:1}}}class pI extends Ru{constructor(t){super(t),this.range=[4,7],this.center=t.center||[-96,37.5];const[n,r]=this.parallels=t.parallels||[29.5,45.5],o=Math.sin(Oe(n));this.n=(o+Math.sin(Oe(r)))/2,this.c=1+o*(2*this.n-o),this.r0=Math.sqrt(this.c)/this.n}project(t,n){const{n:r,c:o,r0:s}=this,c=Oe(t-this.center[0]),u=Oe(n),d=Math.sqrt(o-2*r*Math.sin(u))/r;return{x:d*Math.sin(c*r),y:d*Math.cos(c*r)-s,z:0}}unproject(t,n){const{n:r,c:o,r0:s}=this,c=s+n;let u=Math.atan2(t,Math.abs(c))*Math.sign(c);c*r<0&&(u-=Math.PI*Math.sign(t)*Math.sign(c));const d=Oe(this.center[0])*r;u=Rr(u,-Math.PI-d,Math.PI-d);const f=ne(fr(u/r)+this.center[0],-180,180),m=Math.asin(ne((o-(t*t+c*c)*r*r)/(2*r),-1,1)),g=ne(fr(m),-Ar,Ar);return new Se(f,g)}}const sd=1.340264,ad=-.081106,ep=893e-6,np=.003796,rp=Math.sqrt(3)/2;class Lb extends Ru{project(t,n){n=n/180*Math.PI,t=t/180*Math.PI;const r=Math.asin(rp*Math.sin(n)),o=r*r,s=o*o*o;return{x:.5*(t*Math.cos(r)/(rp*(sd+3*ad*o+s*(7*ep+9*np*o)))/Math.PI+.5),y:1-.5*(r*(sd+ad*o+s*(ep+np*o))/Math.PI+1),z:0}}unproject(t,n){t=(2*t-.5)*Math.PI;let r=n=(2*(1-n)-1)*Math.PI,o=r*r,s=o*o*o;for(let m,g,y,v=0;v<12&&(g=r*(sd+ad*o+s*(ep+np*o))-n,y=sd+3*ad*o+s*(7*ep+9*np*o),m=g/y,r=ne(r-m,-Math.PI/3,Math.PI/3),o=r*r,s=o*o*o,!(Math.abs(m)<1e-12));++v);const c=rp*t*(sd+3*ad*o+s*(7*ep+9*np*o))/Math.cos(r),u=Math.asin(Math.sin(r)/rp),d=ne(180*c/Math.PI,-180,180),f=ne(180*u/Math.PI,-Ar,Ar);return new Se(d,f)}}class ip extends Ru{constructor(t){super(t),this.wrap=!0,this.supportsWorldCopies=!0}project(t,n){return{x:.5+t/360,y:.5-n/360,z:0}}unproject(t,n){const r=360*(t-.5),o=ne(360*(.5-n),-Ar,Ar);return new Se(r,o)}}const ld=Math.PI/2;function op(e){return Math.tan((ld+e)/2)}class Ob extends Ru{constructor(t){super(t),this.center=t.center||[0,30];const[n,r]=this.parallels=t.parallels||[30,30];let o=Oe(n),s=Oe(r);this.southernCenter=o+s<0,this.southernCenter&&(o=-o,s=-s);const c=Math.cos(o),u=op(o);this.n=o===s?Math.sin(o):Math.log(c/Math.cos(s))/Math.log(op(s)/u),this.f=c*Math.pow(op(o),this.n)/this.n}project(t,n){n=Oe(n),this.southernCenter&&(n=-n),t=Oe(t-this.center[0]);const r=1e-6,{n:o,f:s}=this;s>0?n<-ld+r&&(n=-ld+r):n>ld-r&&(n=ld-r);const c=s/Math.pow(op(n),o);let u=c*Math.sin(o*t),d=s-c*Math.cos(o*t);return u=.5*(u/Math.PI+.5),d=.5*(d/Math.PI+.5),{x:u,y:this.southernCenter?d:1-d,z:0}}unproject(t,n){t=(2*t-.5)*Math.PI,this.southernCenter&&(n=1-n),n=(2*(1-n)-.5)*Math.PI;const{n:r,f:o}=this,s=o-n,c=Math.sign(s),u=Math.sign(r)*Math.sqrt(t*t+s*s);let d=Math.atan2(t,Math.abs(s))*c;s*r<0&&(d-=Math.PI*Math.sign(t)*c);const f=ne(fr(d/r)+this.center[0],-180,180),m=ne(fr(2*Math.atan(Math.pow(o/u,1/r))-ld),-Ar,Ar);return new Se(f,this.southernCenter?-m:m)}}class kb extends Ru{constructor(t){super(t),this.wrap=!0,this.supportsWorldCopies=!0,this.supportsTerrain=!0,this.supportsFog=!0,this.supportsFreeCamera=!0,this.isReprojectedInTileSpace=!1,this.unsupportedLayers=[],this.range=null}project(t,n){return{x:Br(t),y:ui(n),z:0}}unproject(t,n){const r=Jo(t),o=xr(n);return new Se(r,o)}}const Fb=Oe(Ar);class sp extends Ru{project(t,n){const r=(n=Oe(n))*n,o=r*r;return{x:.5*((t=Oe(t))*(.8707-.131979*r+o*(o*(.003971*r-.001529*o)-.013791))/Math.PI+.5),y:1-.5*(n*(1.007226+r*(.015085+o*(.028874*r-.044475-.005916*o)))/Math.PI+1),z:0}}unproject(t,n){t=(2*t-.5)*Math.PI;let r=n=(2*(1-n)-1)*Math.PI,o=25,s=0,c=r*r;do{c=r*r;const f=c*c;s=(r*(1.007226+c*(.015085+f*(.028874*c-.044475-.005916*f)))-n)/(1.007226+c*(.045255+f*(.259866*c-.311325-.005916*11*f))),r=ne(r-s,-Fb,Fb)}while(Math.abs(s)>1e-6&&--o>0);c=r*r;const u=ne(fr(t/(.8707+c*(c*(c*c*c*(.003971-.001529*c)-.013791)-.131979))),-180,180),d=fr(r);return new Se(u,d)}}const Nb=Oe(Ar);class mI extends Ru{project(t,n){n=Oe(n),t=Oe(t);const r=Math.cos(n),o=2/Math.PI,s=Math.acos(r*Math.cos(t/2)),c=Math.sin(s)/s,u=.5*(t*o+2*r*Math.sin(t/2)/c)||0,d=.5*(n+Math.sin(n)/c)||0;return{x:.5*(u/Math.PI+.5),y:1-.5*(d/Math.PI+1),z:0}}unproject(t,n){let r=t=(2*t-.5)*Math.PI,o=n=(2*(1-n)-1)*Math.PI,s=25;const c=1e-6;let u=0,d=0;do{const f=Math.cos(o),m=Math.sin(o),g=2*m*f,y=m*m,v=f*f,x=Math.cos(r/2),w=Math.sin(r/2),E=2*x*w,M=w*w,D=1-v*x*x,A=D?1/D:0,P=D?Math.acos(f*x)*Math.sqrt(1/D):0,C=.5*(2*P*f*w+2*r/Math.PI)-t,R=.5*(P*m+o)-n,k=.5*A*(v*M+P*f*x*y)+1/Math.PI,N=A*(E*g/4-P*m*w),z=.125*A*(g*w-P*m*v*E),B=.5*A*(y*x+P*M*f)+.5,U=N*z-B*k;u=(R*N-C*B)/U,d=(C*z-R*k)/U,r=ne(r-u,-Math.PI,Math.PI),o=ne(o-d,-Nb,Nb)}while((Math.abs(u)>c||Math.abs(d)>c)&&--s>0);return new Se(fr(r),fr(o))}}class zb extends Ru{constructor(t){super(t),this.center=t.center||[0,0],this.parallels=t.parallels||[0,0],this.cosPhi=Math.max(.01,Math.cos(Oe(this.parallels[0]))),this.scale=1/(2*Math.max(Math.PI*this.cosPhi,1/this.cosPhi)),this.wrap=!0,this.supportsWorldCopies=!0}project(t,n){const{scale:r,cosPhi:o}=this;return{x:Oe(t)*o*r+.5,y:-Math.sin(Oe(n))/o*r+.5,z:0}}unproject(t,n){const{scale:r,cosPhi:o}=this,s=-(n-.5)/r,c=ne(fr((t-.5)/r)/o,-180,180),u=Math.asin(ne(s*o,-1,1)),d=ne(fr(u),-Ar,Ar);return new Se(c,d)}}class gI extends kb{constructor(t){super(t),this.requiresDraping=!0,this.supportsWorldCopies=!1,this.supportsFog=!0,this.zAxisUnit="pixels",this.unsupportedLayers=["debug"],this.range=[3,5]}projectTilePoint(t,n,r){const o=Om(t,n,r),s=mu(bs(r));return Z.transformMat4(o,o,s),{x:o[0],y:o[1],z:o[2]}}locationPoint(t,n){const r=Ko(n.lat,n.lng),o=Z.normalize([],r),s=t.elevation?t.elevation.getAtPointOrZero(t.locationCoordinate(n),t._centerAltitude):t._centerAltitude,c=Ln(1,0)*et*s;Z.scaleAndAdd(r,r,o,c);const u=st.identity(new Float64Array(16));return st.multiply(u,t.pixelMatrix,t.globeMatrix),Z.transformMat4(r,r,u),new it(r[0],r[1])}pixelsPerMeter(t,n){return Ln(1,0)*n}pixelSpaceConversion(t,n,r){const o=Ln(1,t)*n,s=le(Ln(1,45)*n,o,r);return this.pixelsPerMeter(t,n)/s}createTileMatrix(t,n,r){const o=km(bs(r.canonical));return st.multiply(new Float64Array(16),t.globeMatrix,o)}createInversionMatrix(t,n){const{center:r}=t,o=mu(bs(n));return st.rotateY(o,o,Oe(r.lng)),st.rotateX(o,o,Oe(r.lat)),st.scale(o,o,[t._pixelsPerMercatorPixel,t._pixelsPerMercatorPixel,1]),Float32Array.from(o)}pointCoordinate(t,n,r,o){return ly(t,n,r,!0)||new Qe(0,0)}pointCoordinate3D(t,n,r){const o=this.pointCoordinate(t,n,r,0);return[o.x,o.y,o.z]}isPointAboveHorizon(t,n){return!ly(t,n.x,n.y,!1)}farthestPixelDistance(t){const n=function(o,s){const c=o.cameraToCenterDistance,u=o._centerAltitude*s,d=o._camera,f=o._camera.forward(),m=Z.add([],Z.scale([],f,-c),[0,0,u]),g=o.worldSize/(2*Math.PI),y=[0,0,-g],v=o.width/o.height,x=Math.tan(o.fovAboveCenter),w=Z.scale([],d.up(),x),E=Z.scale([],d.right(),x*v),M=Z.normalize([],Z.add([],Z.add([],f,w),E)),D=[];let A;if(new Rm(m,M).closestPointOnSphere(y,g,D)){const P=Z.add([],D,y),C=Z.sub([],P,m);A=Math.cos(o.fovAboveCenter)*Z.length(C)}else{const P=Z.sub([],m,y),C=Z.sub([],y,m);Z.normalize(C,C);const R=Z.length(P)-g;A=Math.sqrt(R*(R+2*g));const k=Math.acos(A/(g+R))-Math.acos(Z.dot(f,C));A*=Math.cos(k)}return 1.01*A}(t,this.pixelsPerMeter(t.center.lat,t.worldSize)),r=ri(t.zoom);if(r>0){const o=t0(t,Ln(1,t.center.lat)*t.worldSize),s=t.worldSize/(2*Math.PI),c=Math.max(t.width,t.height)/t.worldSize*Math.PI;return le(n,o+s*(1-Math.cos(c)),Math.pow(r,10))}return n}upVector(t,n,r){return Om(n,r,t,1)}upVectorScale(t){return{metersToTile:Bf(uy(bs(t)))}}}function dg(e){const t=e.parallels,n=!!t&&Math.abs(t[0]+t[1])<.01;switch(e.name){case"mercator":return new kb(e);case"equirectangular":return new ip(e);case"naturalEarth":return new sp(e);case"equalEarth":return new Lb(e);case"winkelTripel":return new mI(e);case"albers":return n?new zb(e):new pI(e);case"lambertConformalConic":return n?new zb(e):new Ob(e);case"globe":return new gI(e)}throw new Error(`Invalid projection name: ${e.name}`)}const _I=new gr({"symbol-placement":new Ot(H.layout_symbol["symbol-placement"]),"symbol-spacing":new Ot(H.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new Ot(H.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new me(H.layout_symbol["symbol-sort-key"]),"symbol-z-order":new Ot(H.layout_symbol["symbol-z-order"]),"symbol-z-elevate":new Ot(H.layout_symbol["symbol-z-elevate"]),"icon-allow-overlap":new Ot(H.layout_symbol["icon-allow-overlap"]),"icon-ignore-placement":new Ot(H.layout_symbol["icon-ignore-placement"]),"icon-optional":new Ot(H.layout_symbol["icon-optional"]),"icon-rotation-alignment":new Ot(H.layout_symbol["icon-rotation-alignment"]),"icon-size":new me(H.layout_symbol["icon-size"]),"icon-text-fit":new me(H.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new me(H.layout_symbol["icon-text-fit-padding"]),"icon-image":new me(H.layout_symbol["icon-image"]),"icon-rotate":new me(H.layout_symbol["icon-rotate"]),"icon-padding":new Ot(H.layout_symbol["icon-padding"]),"icon-keep-upright":new Ot(H.layout_symbol["icon-keep-upright"]),"icon-offset":new me(H.layout_symbol["icon-offset"]),"icon-anchor":new me(H.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new Ot(H.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new Ot(H.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new Ot(H.layout_symbol["text-rotation-alignment"]),"text-field":new me(H.layout_symbol["text-field"]),"text-font":new me(H.layout_symbol["text-font"]),"text-size":new me(H.layout_symbol["text-size"]),"text-max-width":new me(H.layout_symbol["text-max-width"]),"text-line-height":new me(H.layout_symbol["text-line-height"]),"text-letter-spacing":new me(H.layout_symbol["text-letter-spacing"]),"text-justify":new me(H.layout_symbol["text-justify"]),"text-radial-offset":new me(H.layout_symbol["text-radial-offset"]),"text-variable-anchor":new Ot(H.layout_symbol["text-variable-anchor"]),"text-anchor":new me(H.layout_symbol["text-anchor"]),"text-max-angle":new Ot(H.layout_symbol["text-max-angle"]),"text-writing-mode":new Ot(H.layout_symbol["text-writing-mode"]),"text-rotate":new me(H.layout_symbol["text-rotate"]),"text-padding":new Ot(H.layout_symbol["text-padding"]),"text-keep-upright":new Ot(H.layout_symbol["text-keep-upright"]),"text-transform":new me(H.layout_symbol["text-transform"]),"text-offset":new me(H.layout_symbol["text-offset"]),"text-allow-overlap":new Ot(H.layout_symbol["text-allow-overlap"]),"text-ignore-placement":new Ot(H.layout_symbol["text-ignore-placement"]),"text-optional":new Ot(H.layout_symbol["text-optional"]),visibility:new Ot(H.layout_symbol.visibility)});var n0={paint:new gr({"icon-opacity":new me(H.paint_symbol["icon-opacity"]),"icon-emissive-strength":new me(H.paint_symbol["icon-emissive-strength"]),"text-emissive-strength":new me(H.paint_symbol["text-emissive-strength"]),"icon-color":new me(H.paint_symbol["icon-color"]),"icon-halo-color":new me(H.paint_symbol["icon-halo-color"]),"icon-halo-width":new me(H.paint_symbol["icon-halo-width"]),"icon-halo-blur":new me(H.paint_symbol["icon-halo-blur"]),"icon-translate":new Ot(H.paint_symbol["icon-translate"]),"icon-translate-anchor":new Ot(H.paint_symbol["icon-translate-anchor"]),"icon-image-cross-fade":new me(H.paint_symbol["icon-image-cross-fade"]),"text-opacity":new me(H.paint_symbol["text-opacity"]),"text-color":new me(H.paint_symbol["text-color"],{runtimeType:yo,getOverride:e=>e.textColor,hasOverride:e=>!!e.textColor}),"text-halo-color":new me(H.paint_symbol["text-halo-color"]),"text-halo-width":new me(H.paint_symbol["text-halo-width"]),"text-halo-blur":new me(H.paint_symbol["text-halo-blur"]),"text-translate":new Ot(H.paint_symbol["text-translate"]),"text-translate-anchor":new Ot(H.paint_symbol["text-translate-anchor"]),"icon-color-saturation":new Ot(H.paint_symbol["icon-color-saturation"])}),layout:_I};class Bb{constructor(t){this.type=t.property.overrides?t.property.overrides.runtimeType:_o,this.defaultValue=t}evaluate(t){if(t.formattedSection){const n=this.defaultValue.property.overrides;if(n&&n.hasOverride(t.formattedSection))return n.getOverride(t.formattedSection)}return t.feature&&t.featureState?this.defaultValue.evaluate(t.feature,t.featureState):this.defaultValue.property.specification.default}eachChild(t){this.defaultValue.isConstant()||t(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}re(Bb,"FormatSectionOverride",{omit:["defaultValue"]});class ap extends xo{constructor(t,n){super(t,n0,n)}recalculate(t,n){super.recalculate(t,n),"auto"===this.layout.get("icon-rotation-alignment")&&(this.layout._values["icon-rotation-alignment"]="point"!==this.layout.get("symbol-placement")?"map":"viewport"),"auto"===this.layout.get("text-rotation-alignment")&&(this.layout._values["text-rotation-alignment"]="point"!==this.layout.get("symbol-placement")?"map":"viewport"),"auto"===this.layout.get("text-pitch-alignment")&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),"auto"===this.layout.get("icon-pitch-alignment")&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));const r=this.layout.get("text-writing-mode");if(r){const o=[];for(const s of r)o.indexOf(s)<0&&o.push(s);this.layout._values["text-writing-mode"]=o}else this.layout._values["text-writing-mode"]="point"===this.layout.get("symbol-placement")?["horizontal"]:["horizontal","vertical"];this._setPaintOverrides()}getValueAndResolveTokens(t,n,r,o){const s=this.layout.get(t).evaluate(n,{},r,o),c=this._unevaluatedLayout._values[t];return c.isDataDriven()||Th(c.value)||!s?s:(u=n.properties,s.replace(/{([^{}]+)}/g,(f,m)=>m in u?String(u[m]):""));var u}createBucket(t){return new ud(t)}queryRadius(){return 0}queryIntersectsFeature(){return!1}_setPaintOverrides(){for(const t of n0.paint.overridableProperties){if(!ap.hasPaintOverride(this.layout,t))continue;const n=this.paint.get(t),r=new Bb(n),o=new of(r,n.property.specification);let s=null;s="constant"===n.value.kind||"source"===n.value.kind?new Yp("source",o):new vl("composite",o,n.value.zoomStops,n.value._interpolationType),this.paint._values[t]=new fc(n.property,s,n.parameters)}}_handleOverridablePaintPropertyUpdate(t,n,r){return!(!this.layout||n.isDataDriven()||r.isDataDriven())&&ap.hasPaintOverride(this.layout,t)}static hasPaintOverride(t,n){const r=t.get("text-field"),o=n0.paint.properties[n];let s=!1;const c=u=>{for(const d of u)if(o.overrides&&o.overrides.hasOverride(d))return void(s=!0)};if("constant"===r.value.kind&&r.value.value instanceof Wi)c(r.value.value.sections);else if("source"===r.value.kind){const u=f=>{s||(f instanceof qe&&on(f.value)===He?c(f.value.sections):f instanceof Gc?c(f.sections):f.eachChild(u))},d=r.value;d._styleExpression&&u(d._styleExpression.expression)}return s}getProgramIds(){const t=0!==this.paint.get("icon-opacity").constantOr(1),n=0!==this.paint.get("text-opacity").constantOr(1),r=[];return t&&r.push("symbolIcon"),n&&r.push("symbolSDF"),r}getDefaultProgramParams(t,n){return{config:new lu(this,n),overrideFog:!1}}}const jb=jy.types,yI=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function Lu(e,t,n,r,o,s,c,u,d,f,m,g,y){const v=u?Math.min(Wa,Math.round(u[0])):0,x=u?Math.min(Wa,Math.round(u[1])):0;e.emplaceBack(t,n,Math.round(32*r),Math.round(32*o),s,c,(v<<1)+(d?1:0),x,16*f,16*m,256*g,256*y)}function fg(e,t,n){e.emplaceBack(t,n)}function pg(e,t,n,r,o,s,c){e.emplaceBack(t,n,r,o,s,c)}function mg(e,t,n,r,o){const s=5*t+2;e.float32[s+0]=n,e.float32[s+1]=r,e.float32[s+2]=o}function cd(e,t,n,r,o){e.emplaceBack(t,n,r,o),e.emplaceBack(t,n,r,o),e.emplaceBack(t,n,r,o),e.emplaceBack(t,n,r,o)}function vI(e){for(const t of e.sections)if(rM(t.text))return!0;return!1}class r0{constructor(t){this.layoutVertexArray=new Ah,this.indexArray=new Kr,this.programConfigurations=t,this.segments=new Rn,this.dynamicLayoutVertexArray=new Fs,this.opacityVertexArray=new mf,this.placedSymbolArray=new L_,this.iconTransitioningVertexArray=new Tl,this.globeExtVertexArray=new Ph,this.zOffsetVertexArray=new um}isEmpty(){return 0===this.layoutVertexArray.length&&0===this.indexArray.length&&0===this.dynamicLayoutVertexArray.length&&0===this.opacityVertexArray.length&&0===this.iconTransitioningVertexArray.length}upload(t,n,r,o,s){this.isEmpty()||(r&&(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,tI.members),this.indexBuffer=t.createIndexBuffer(this.indexArray,n),this.dynamicLayoutVertexBuffer=t.createVertexBuffer(this.dynamicLayoutVertexArray,hb.members,!0),this.opacityVertexBuffer=t.createVertexBuffer(this.opacityVertexArray,yI,!0),this.iconTransitioningVertexArray.length>0&&(this.iconTransitioningVertexBuffer=t.createVertexBuffer(this.iconTransitioningVertexArray,nI.members,!0)),this.globeExtVertexArray.length>0&&(this.globeExtVertexBuffer=t.createVertexBuffer(this.globeExtVertexArray,eI.members,!0)),!this.zOffsetVertexBuffer&&(this.zOffsetVertexArray.length>0||s)&&(this.zOffsetVertexBuffer=t.createVertexBuffer(this.zOffsetVertexArray,IC.members,!0)),this.opacityVertexBuffer.itemSize=1),(r||o)&&this.programConfigurations.upload(t))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy(),this.iconTransitioningVertexBuffer&&this.iconTransitioningVertexBuffer.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy())}}re(r0,"SymbolBuffers");class o0{constructor(t,n,r){this.layoutVertexArray=new t,this.layoutAttributes=n,this.indexArray=new r,this.segments=new Rn,this.collisionVertexArray=new iu,this.collisionVertexArrayExt=new Fs}upload(t){this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=t.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=t.createVertexBuffer(this.collisionVertexArray,DC.members,!0),this.collisionVertexBufferExt=t.createVertexBuffer(this.collisionVertexArrayExt,SC.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy(),this.collisionVertexBufferExt.destroy())}}re(o0,"CollisionBuffers");class lp{constructor(t){this.collisionBoxArray=t.collisionBoxArray,this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(c=>c.fqid),this.index=t.index,this.pixelRatio=t.pixelRatio,this.sourceLayerIndex=t.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.fullyClipped=!1,this.hasAnyIconTextFit=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=st.identity([]),this.placementViewportMatrix=st.identity([]);const n=this.layers[0]._unevaluatedLayout._values;this.textSizeData=ng(this.zoom,n["text-size"]),this.iconSizeData=ng(this.zoom,n["icon-size"]);const r=this.layers[0].layout,o=r.get("symbol-sort-key"),s=r.get("symbol-z-order");this.canOverlap=r.get("text-allow-overlap")||r.get("icon-allow-overlap")||r.get("text-ignore-placement")||r.get("icon-ignore-placement"),this.sortFeaturesByKey="viewport-y"!==s&&void 0!==o.constantOr(1),this.sortFeaturesByY=("viewport-y"===s||"auto"===s&&!this.sortFeaturesByKey)&&this.canOverlap,this.writingModes=r.get("text-writing-mode").map(c=>er[c]),this.stateDependentLayerIds=this.layers.filter(c=>c.isStateDependent()).map(c=>c.id),this.sourceID=t.sourceID,this.projection=t.projection,this.hasAnyZOffset=!1,this.zOffsetSortDirty=!1,this.zOffsetBuffersNeedUpload=r.get("symbol-z-elevate")}createArrays(){this.text=new r0(new _c(this.layers,this.zoom,t=>/^text/.test(t))),this.icon=new r0(new _c(this.layers,this.zoom,t=>/^icon/.test(t))),this.glyphOffsetArray=new zx,this.lineVertexArray=new vf,this.symbolInstances=new na}calculateGlyphDependencies(t,n,r,o,s){for(let c=0;c<t.length;c++){const u=t.codePointAt(c);if(void 0===u)break;if(n[u]=!0,o&&s&&u<=65535){const d=sn[t.charAt(c)];d&&(n[d.charCodeAt(0)]=!0)}}}populate(t,n,r,o){const s=this.layers[0],c=s.layout,u="globe"===this.projection.name,d=c.get("text-font"),f=c.get("text-field"),m=c.get("icon-image"),g=("constant"!==f.value.kind||f.value.value instanceof Wi&&!f.value.value.isEmpty()||f.value.value.toString().length>0)&&("constant"!==d.value.kind||d.value.value.length>0),y="constant"!==m.value.kind||!!m.value.value||Object.keys(m.parameters).length>0,v=c.get("symbol-sort-key");if(this.features=[],!g&&!y)return;const x=n.iconDependencies,w=n.glyphDependencies,E=n.availableImages,M=new ar(this.zoom);for(const{feature:D,id:A,index:P,sourceLayerIndex:C}of t){const R=s._featureFilter.needGeometry,k=Ua(D,R);if(!s._featureFilter.filter(M,k,r))continue;if(R||(k.geometry=ca(D,r,o)),u&&1!==D.type&&r.z<=5){const U=k.geometry,$=.98078528056,W=(V,K)=>{const Q=Om(V.x,V.y,r,1),ot=Om(K.x,K.y,r,1);return Z.dot(Q,ot)<$};for(let V=0;V<U.length;V++)U[V]=wC(U[V],W)}let N,z;if(g){const U=s.getValueAndResolveTokens("text-field",k,r,E),$=Wi.factory(U);vI($)&&(this.hasRTLText=!0),(!this.hasRTLText||"unavailable"===rm()||this.hasRTLText&&bi.isParsed())&&(N=pb($,s,k))}if(y){const U=s.getValueAndResolveTokens("icon-image",k,r,E);z=U instanceof Qn?U:Qn.fromString(U)}if(!N&&!z)continue;const B=this.sortFeaturesByKey?v.evaluate(k,{},r):void 0;if(this.features.push({id:A,text:N,icon:z,index:P,sourceLayerIndex:C,geometry:k.geometry,properties:D.properties,type:jb[D.type],sortKey:B}),z&&(x[z.namePrimary]=!0,z.nameSecondary&&(x[z.nameSecondary]=!0)),N){const U=d.evaluate(k,{},r).join(","),$="map"===c.get("text-rotation-alignment")&&"point"!==c.get("symbol-placement");this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(er.vertical)>=0;for(const W of N.sections)if(W.image)x[W.image.namePrimary]=!0;else{const V=E_(N.toString()),K=W.fontStack||U,Q=w[K]=w[K]||{};this.calculateGlyphDependencies(W.text,Q,$,this.allowVerticalPlacement,V)}}}"line"===c.get("symbol-placement")&&(this.features=function(D){const A={},P={},C=[];let R=0;function k(U){C.push(D[U]),R++}function N(U,$,W){const V=P[U];return delete P[U],P[$]=V,C[V].geometry[0].pop(),C[V].geometry[0]=C[V].geometry[0].concat(W[0]),V}function z(U,$,W){const V=A[$];return delete A[$],A[U]=V,C[V].geometry[0].shift(),C[V].geometry[0]=W[0].concat(C[V].geometry[0]),V}function B(U,$,W){const V=W?$[0][$[0].length-1]:$[0][0];return`${U}:${V.x}:${V.y}`}for(let U=0;U<D.length;U++){const $=D[U],W=$.geometry,V=$.text?$.text.toString():null;if(!V){k(U);continue}const K=B(V,W),Q=B(V,W,!0);if(K in P&&Q in A&&P[K]!==A[Q]){const ot=z(K,Q,W),Y=N(K,Q,C[ot].geometry);delete A[K],delete P[Q],P[B(V,C[Y].geometry,!0)]=Y,C[ot].geometry=null}else K in P?N(K,Q,W):Q in A?z(K,Q,W):(k(U),A[K]=R-1,P[Q]=R-1)}return C.filter(U=>U.geometry)}(this.features)),this.sortFeaturesByKey&&this.features.sort((D,A)=>D.sortKey-A.sortKey)}update(t,n,r,o,s){const c=0!==Object.keys(t).length;if(c&&!this.stateDependentLayers.length)return;const u=c?this.stateDependentLayers:this.layers;this.text.programConfigurations.updatePaintArrays(t,n,u,r,o,s),this.icon.programConfigurations.updatePaintArrays(t,n,u,r,o,s)}updateZOffset(){const t=(s,c,u)=>{r+=c,r>s.length&&s.resize(r);for(let d=-c;d<0;d++)s.emplace(d+r,u)},n=(s,c,u)=>{o+=c,o>s.length&&s.resize(o);for(let d=-c;d<0;d++)s.emplace(d+o,u)};if(!this.zOffsetBuffersNeedUpload)return;this.zOffsetBuffersNeedUpload=!1;let r=0,o=0;for(let s=0;s<this.symbolInstances.length;s++){const c=this.symbolInstances.get(s),{numHorizontalGlyphVertices:u,numVerticalGlyphVertices:d,numIconVertices:f}=c,m=c.zOffset,g=f>0;if((u>0||d>0)&&(t(this.text.zOffsetVertexArray,u,m),t(this.text.zOffsetVertexArray,d,m)),g){const{placedIconSymbolIndex:y,verticalPlacedIconSymbolIndex:v}=c;y>=0&&n(this.icon.zOffsetVertexArray,f,m),v>=0&&n(this.icon.zOffsetVertexArray,c.numVerticalIconVertices,m)}}this.text.zOffsetVertexBuffer&&this.text.zOffsetVertexBuffer.updateData(this.text.zOffsetVertexArray),this.icon.zOffsetVertexBuffer&&this.icon.zOffsetVertexBuffer.updateData(this.icon.zOffsetVertexArray)}isEmpty(){return 0===this.symbolInstances.length&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(t){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(t),this.iconCollisionBox.upload(t)),this.text.upload(t,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.icon.upload(t,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}getProjection(){return this.projectionInstance||(this.projectionInstance=dg(this.projection)),this.projectionInstance}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(t,n){const r=this.lineVertexArray.length;if(void 0!==t.segment)for(const{x:o,y:s}of n)this.lineVertexArray.emplaceBack(o,s);return{lineStartIndex:r,lineLength:this.lineVertexArray.length-r}}addSymbols(t,n,r,o,s,c,u,d,f,m,g,y,v,x,w,E){const M=t.indexArray,D=t.layoutVertexArray,A=t.globeExtVertexArray,P=t.segments.prepareSegment(4*n.length,D,M,this.canOverlap?c.sortKey:void 0),C=this.glyphOffsetArray.length,R=P.vertexLength,k=this.allowVerticalPlacement&&u===er.vertical?Math.PI/2:0,N=c.text&&c.text.sections;for(let B=0;B<n.length;B++){const{tl:U,tr:$,bl:W,br:V,texPrimary:K,texSecondary:Q,pixelOffsetTL:ot,pixelOffsetBR:Y,minFontScaleX:J,minFontScaleY:ct,glyphOffset:dt,isSDF:ht,sectionIndex:_t}=n[B],vt=P.vertexLength,xt=dt[1];if(Lu(D,f.x,f.y,U.x,xt+U.y,K.x,K.y,r,ht,ot.x,ot.y,J,ct),Lu(D,f.x,f.y,$.x,xt+$.y,K.x+K.w,K.y,r,ht,Y.x,ot.y,J,ct),Lu(D,f.x,f.y,W.x,xt+W.y,K.x,K.y+K.h,r,ht,ot.x,Y.y,J,ct),Lu(D,f.x,f.y,V.x,xt+V.y,K.x+K.w,K.y+K.h,r,ht,Y.x,Y.y,J,ct),d){const{x:mt,y:Ct,z:Ut}=d.anchor,[Gt,Yt,te]=d.up;pg(A,mt,Ct,Ut,Gt,Yt,te),pg(A,mt,Ct,Ut,Gt,Yt,te),pg(A,mt,Ct,Ut,Gt,Yt,te),pg(A,mt,Ct,Ut,Gt,Yt,te),cd(t.dynamicLayoutVertexArray,mt,Ct,Ut,k)}else cd(t.dynamicLayoutVertexArray,f.x,f.y,f.z,k);if(E){const mt=Q||K;fg(t.iconTransitioningVertexArray,mt.x,mt.y),fg(t.iconTransitioningVertexArray,mt.x+mt.w,mt.y),fg(t.iconTransitioningVertexArray,mt.x,mt.y+mt.h),fg(t.iconTransitioningVertexArray,mt.x+mt.w,mt.y+mt.h)}M.emplaceBack(vt,vt+1,vt+2),M.emplaceBack(vt+1,vt+2,vt+3),P.vertexLength+=4,P.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(dt[0]),B!==n.length-1&&_t===n[B+1].sectionIndex||t.programConfigurations.populatePaintArrays(D.length,c,c.index,{},v,x,w,N&&N[_t])}const z=d?d.anchor:f;t.placedSymbolArray.emplaceBack(z.x,z.y,z.z,f.x,f.y,C,this.glyphOffsetArray.length-C,R,m,g,f.segment,r?r[0]:0,r?r[1]:0,o[0],o[1],u,0,!1,0,y,0)}_commitLayoutVertex(t,n,r,o,s,c,u){t.emplaceBack(n,r,o,s,c,Math.round(u.x),Math.round(u.y))}_addCollisionDebugVertices(t,n,r,o,s,c,u){const d=r.segments.prepareSegment(4,r.layoutVertexArray,r.indexArray),f=d.vertexLength,m=u.tileAnchorX,g=u.tileAnchorY;for(let v=0;v<4;v++)r.collisionVertexArray.emplaceBack(0,0,0,0);this._commitDebugCollisionVertexUpdate(r.collisionVertexArrayExt,n,t.padding,u.zOffset),this._commitLayoutVertex(r.layoutVertexArray,o,s,c,m,g,new it(t.x1,t.y1)),this._commitLayoutVertex(r.layoutVertexArray,o,s,c,m,g,new it(t.x2,t.y1)),this._commitLayoutVertex(r.layoutVertexArray,o,s,c,m,g,new it(t.x2,t.y2)),this._commitLayoutVertex(r.layoutVertexArray,o,s,c,m,g,new it(t.x1,t.y2)),d.vertexLength+=4;const y=r.indexArray;y.emplaceBack(f,f+1),y.emplaceBack(f+1,f+2),y.emplaceBack(f+2,f+3),y.emplaceBack(f+3,f),d.primitiveLength+=4}_addTextDebugCollisionBoxes(t,n,r,o,s,c){for(let u=o;u<s;u++){const d=r.get(u),f=this.getSymbolInstanceTextSize(t,c,n,u);this._addCollisionDebugVertices(d,f,this.textCollisionBox,d.projectedAnchorX,d.projectedAnchorY,d.projectedAnchorZ,c)}}_addIconDebugCollisionBoxes(t,n,r,o,s,c){for(let u=o;u<s;u++){const d=r.get(u),f=this.getSymbolInstanceIconSize(t,n,c.placedIconSymbolIndex);this._addCollisionDebugVertices(d,f,this.iconCollisionBox,d.projectedAnchorX,d.projectedAnchorY,d.projectedAnchorZ,c)}}generateCollisionDebugBuffers(t,n){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new o0(cm,Xy.members,Tl),this.iconCollisionBox=new o0(cm,Xy.members,Tl);const r=qa(this.iconSizeData,t),o=qa(this.textSizeData,t);for(let s=0;s<this.symbolInstances.length;s++){const c=this.symbolInstances.get(s);this._addTextDebugCollisionBoxes(o,t,n,c.textBoxStartIndex,c.textBoxEndIndex,c),this._addTextDebugCollisionBoxes(o,t,n,c.verticalTextBoxStartIndex,c.verticalTextBoxEndIndex,c),this._addIconDebugCollisionBoxes(r,t,n,c.iconBoxStartIndex,c.iconBoxEndIndex,c),this._addIconDebugCollisionBoxes(r,t,n,c.verticalIconBoxStartIndex,c.verticalIconBoxEndIndex,c)}}getSymbolInstanceTextSize(t,n,r,o){const s=this.text.placedSymbolArray.get(n.rightJustifiedTextSymbolIndex>=0?n.rightJustifiedTextSymbolIndex:n.centerJustifiedTextSymbolIndex>=0?n.centerJustifiedTextSymbolIndex:n.leftJustifiedTextSymbolIndex>=0?n.leftJustifiedTextSymbolIndex:n.verticalPlacedTextSymbolIndex>=0?n.verticalPlacedTextSymbolIndex:o),c=Yh(this.textSizeData,t,s)/wi;return this.tilePixelRatio*c}getSymbolInstanceIconSize(t,n,r){const o=this.icon.placedSymbolArray.get(r),s=Yh(this.iconSizeData,t,o);return this.tilePixelRatio*s}_commitDebugCollisionVertexUpdate(t,n,r,o){t.emplaceBack(n,-r,-r,o),t.emplaceBack(n,r,-r,o),t.emplaceBack(n,r,r,o),t.emplaceBack(n,-r,r,o)}_updateTextDebugCollisionBoxes(t,n,r,o,s,c){for(let u=o;u<s;u++){const d=r.get(u),f=this.getSymbolInstanceTextSize(t,c,n,u);this._commitDebugCollisionVertexUpdate(this.textCollisionBox.collisionVertexArrayExt,f,d.padding,c.zOffset)}}_updateIconDebugCollisionBoxes(t,n,r,o,s,c){for(let u=o;u<s;u++){const d=r.get(u),f=this.getSymbolInstanceIconSize(t,n,c.placedIconSymbolIndex);this._commitDebugCollisionVertexUpdate(this.iconCollisionBox.collisionVertexArrayExt,f,d.padding,c.zOffset)}}updateCollisionDebugBuffers(t,n){if(!this.hasDebugData())return;this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexArrayExt.clear(),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexArrayExt.clear();const r=qa(this.iconSizeData,t),o=qa(this.textSizeData,t);for(let s=0;s<this.symbolInstances.length;s++){const c=this.symbolInstances.get(s);this._updateTextDebugCollisionBoxes(o,t,n,c.textBoxStartIndex,c.textBoxEndIndex,c),this._updateTextDebugCollisionBoxes(o,t,n,c.verticalTextBoxStartIndex,c.verticalTextBoxEndIndex,c),this._updateIconDebugCollisionBoxes(r,t,n,c.iconBoxStartIndex,c.iconBoxEndIndex,c),this._updateIconDebugCollisionBoxes(r,t,n,c.verticalIconBoxStartIndex,c.verticalIconBoxEndIndex,c)}this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexBufferExt&&this.textCollisionBox.collisionVertexBufferExt.updateData(this.textCollisionBox.collisionVertexArrayExt),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexBufferExt&&this.iconCollisionBox.collisionVertexBufferExt.updateData(this.iconCollisionBox.collisionVertexArrayExt)}_deserializeCollisionBoxesForSymbol(t,n,r,o,s,c,u,d,f){const m={};if(n<r){const{x1:g,y1:y,x2:v,y2:x,padding:w,projectedAnchorX:E,projectedAnchorY:M,projectedAnchorZ:D,tileAnchorX:A,tileAnchorY:P,featureIndex:C}=t.get(n);m.textBox={x1:g,y1:y,x2:v,y2:x,padding:w,projectedAnchorX:E,projectedAnchorY:M,projectedAnchorZ:D,tileAnchorX:A,tileAnchorY:P},m.textFeatureIndex=C}if(o<s){const{x1:g,y1:y,x2:v,y2:x,padding:w,projectedAnchorX:E,projectedAnchorY:M,projectedAnchorZ:D,tileAnchorX:A,tileAnchorY:P,featureIndex:C}=t.get(o);m.verticalTextBox={x1:g,y1:y,x2:v,y2:x,padding:w,projectedAnchorX:E,projectedAnchorY:M,projectedAnchorZ:D,tileAnchorX:A,tileAnchorY:P},m.verticalTextFeatureIndex=C}if(c<u){const{x1:g,y1:y,x2:v,y2:x,padding:w,projectedAnchorX:E,projectedAnchorY:M,projectedAnchorZ:D,tileAnchorX:A,tileAnchorY:P,featureIndex:C}=t.get(c);m.iconBox={x1:g,y1:y,x2:v,y2:x,padding:w,projectedAnchorX:E,projectedAnchorY:M,projectedAnchorZ:D,tileAnchorX:A,tileAnchorY:P},m.iconFeatureIndex=C}if(d<f){const{x1:g,y1:y,x2:v,y2:x,padding:w,projectedAnchorX:E,projectedAnchorY:M,projectedAnchorZ:D,tileAnchorX:A,tileAnchorY:P,featureIndex:C}=t.get(d);m.verticalIconBox={x1:g,y1:y,x2:v,y2:x,padding:w,projectedAnchorX:E,projectedAnchorY:M,projectedAnchorZ:D,tileAnchorX:A,tileAnchorY:P},m.verticalIconFeatureIndex=C}return m}deserializeCollisionBoxes(t){this.collisionArrays=[];for(let n=0;n<this.symbolInstances.length;n++){const r=this.symbolInstances.get(n);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(t,r.textBoxStartIndex,r.textBoxEndIndex,r.verticalTextBoxStartIndex,r.verticalTextBoxEndIndex,r.iconBoxStartIndex,r.iconBoxEndIndex,r.verticalIconBoxStartIndex,r.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}hasIconTextFit(){return this.hasAnyIconTextFit}addIndicesForPlacedSymbol(t,n){const r=t.placedSymbolArray.get(n),o=r.vertexStartIndex+4*r.numGlyphs;for(let s=r.vertexStartIndex;s<o;s+=4)t.indexArray.emplaceBack(s,s+1,s+2),t.indexArray.emplaceBack(s+1,s+2,s+3)}getSortedSymbolIndexes(t){if(this.sortedAngle===t&&void 0!==this.symbolInstanceIndexes)return this.symbolInstanceIndexes;const n=Math.sin(t),r=Math.cos(t),o=[],s=[],c=[];for(let u=0;u<this.symbolInstances.length;++u){c.push(u);const d=this.symbolInstances.get(u);o.push(0|Math.round(n*d.tileAnchorX+r*d.tileAnchorY)),s.push(d.featureIndex)}return c.sort((u,d)=>o[u]-o[d]||s[d]-s[u]),c}getSortedIndexesByZOffset(){if(!this.zOffsetSortDirty)return this.symbolInstanceIndexesSortedZOffset;if(!this.symbolInstanceIndexesSortedZOffset){this.symbolInstanceIndexesSortedZOffset=[];for(let t=0;t<this.symbolInstances.length;++t)this.symbolInstanceIndexesSortedZOffset.push(t)}return this.zOffsetSortDirty=!1,this.symbolInstanceIndexesSortedZOffset.sort((t,n)=>this.symbolInstances.get(n).zOffset-this.symbolInstances.get(t).zOffset)}addToSortKeyRanges(t,n){const r=this.sortKeyRanges[this.sortKeyRanges.length-1];r&&r.sortKey===n?r.symbolInstanceEnd=t+1:this.sortKeyRanges.push({sortKey:n,symbolInstanceStart:t,symbolInstanceEnd:t+1})}sortFeatures(t){if(this.sortFeaturesByY&&this.sortedAngle!==t&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(t),this.sortedAngle=t,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const n of this.symbolInstanceIndexes){const r=this.symbolInstances.get(n);this.featureSortOrder.push(r.featureIndex);const{rightJustifiedTextSymbolIndex:o,centerJustifiedTextSymbolIndex:s,leftJustifiedTextSymbolIndex:c,verticalPlacedTextSymbolIndex:u,placedIconSymbolIndex:d,verticalPlacedIconSymbolIndex:f}=r;o>=0&&this.addIndicesForPlacedSymbol(this.text,o),s>=0&&s!==o&&this.addIndicesForPlacedSymbol(this.text,s),c>=0&&c!==s&&c!==o&&this.addIndicesForPlacedSymbol(this.text,c),u>=0&&this.addIndicesForPlacedSymbol(this.text,u),d>=0&&this.addIndicesForPlacedSymbol(this.icon,d),f>=0&&this.addIndicesForPlacedSymbol(this.icon,f)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}re(lp,"SymbolBucket",{omit:["layers","collisionBoxArray","features","compareText"]}),lp.MAX_GLYPHS=65535,lp.addDynamicAttributes=cd;var ud=lp;const xI=Ce([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"},{name:"a_linesofar",components:1,type:"Float32"}],4),{members:CC}=xI,Vb=Ce([{name:"a_packed",components:4,type:"Float32"}]),{members:bI}=Vb,AC=jy.types,gg=Math.cos(Math.PI/180*37.5);class _g{constructor(t){this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(n=>n.fqid),this.index=t.index,this.projection=t.projection,this.hasPattern=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach(n=>{this.gradients[n.id]={}}),this.layoutVertexArray=new sm,this.layoutVertexArray2=new Fs,this.indexArray=new Kr,this.programConfigurations=new _c(t.layers,t.zoom),this.segments=new Rn,this.maxLineLength=0,this.stateDependentLayerIds=this.layers.filter(n=>n.isStateDependent()).map(n=>n.id)}populate(t,n,r,o){this.hasPattern=Y1("line",this.layers,n);const s=this.layers[0].layout.get("line-sort-key"),c=[];for(const{feature:m,id:g,index:y,sourceLayerIndex:v}of t){const x=this.layers[0]._featureFilter.needGeometry,w=Ua(m,x);if(!this.layers[0]._featureFilter.filter(new ar(this.zoom),w,r))continue;const E=s?s.evaluate(w,{},r):void 0,M={id:g,properties:m.properties,type:m.type,sourceLayerIndex:v,index:y,geometry:x?w.geometry:ca(m,r,o),patterns:{},sortKey:E};c.push(M)}s&&c.sort((m,g)=>m.sortKey-g.sortKey);const{lineAtlas:u,featureIndex:d}=n,f=this.addConstantDashes(u);for(const m of c){const{geometry:g,index:y,sourceLayerIndex:v}=m;if(f&&this.addFeatureDashes(m,u),this.hasPattern){const x=Fy("line",this.layers,m,this.zoom,n);this.patternFeatures.push(x)}else this.addFeature(m,g,y,r,u.positions,n.availableImages,n.brightness);d.insert(t[y].feature,g,y,v,this.index)}}addConstantDashes(t){let n=!1;for(const r of this.layers){const o=r.paint.get("line-dasharray").value,s=r.layout.get("line-cap").value;if("constant"!==o.kind||"constant"!==s.kind)n=!0;else{const c=s.value,u=o.value;if(!u)continue;t.addDash(u,c)}}return n}addFeatureDashes(t,n){const r=this.zoom;for(const o of this.layers){const s=o.paint.get("line-dasharray").value,c=o.layout.get("line-cap").value;if("constant"===s.kind&&"constant"===c.kind)continue;let u,d;if("constant"===s.kind){if(u=s.value,!u)continue}else u=s.evaluate({zoom:r},t);d="constant"===c.kind?c.value:c.evaluate({zoom:r},t),n.addDash(u,d),t.patterns[o.id]=n.getKey(u,d)}}update(t,n,r,o,s){const c=0!==Object.keys(t).length;c&&!this.stateDependentLayers.length||this.programConfigurations.updatePaintArrays(t,n,c?this.stateDependentLayers:this.layers,r,o,s)}addFeatures(t,n,r,o,s,c){for(const u of this.patternFeatures)this.addFeature(u,u.geometry,u.index,n,r,o,c)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(t){this.uploaded||(0!==this.layoutVertexArray2.length&&(this.layoutVertexBuffer2=t.createVertexBuffer(this.layoutVertexArray2,bI)),this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,CC),this.indexBuffer=t.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(t),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(t){if(t.properties&&t.properties.hasOwnProperty("mapbox_clip_start")&&t.properties.hasOwnProperty("mapbox_clip_end"))return{start:+t.properties.mapbox_clip_start,end:+t.properties.mapbox_clip_end}}addFeature(t,n,r,o,s,c,u){const d=this.layers[0].layout,f=d.get("line-join").evaluate(t,{}),m=d.get("line-cap").evaluate(t,{}),g=d.get("line-miter-limit"),y=d.get("line-round-limit");this.lineClips=this.lineFeatureClips(t);for(const v of n)this.addLine(v,t,f,m,g,y);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,r,s,c,o,u)}addLine(t,n,r,o,s,c){if(this.distance=0,this.scaledDistance=0,this.totalDistance=0,this.lineSoFar=0,this.lineClips){this.lineClipsArray.push(this.lineClips);for(let M=0;M<t.length-1;M++)this.totalDistance+=t[M].dist(t[M+1]);this.updateScaledDistance(),this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}const u="Polygon"===AC[n.type];let d=t.length;for(;d>=2&&t[d-1].equals(t[d-2]);)d--;let f=0;for(;f<d-1&&t[f].equals(t[f+1]);)f++;if(d<(u?3:2))return;"bevel"===r&&(s=1.05);const m=this.overscaling<=16?15*et/(512*this.overscaling):0,g=this.segments.prepareSegment(10*d,this.layoutVertexArray,this.indexArray);let y,v,x,w,E;this.e1=this.e2=-1,u&&(y=t[d-2],E=t[f].sub(y)._unit()._perp());for(let M=f;M<d;M++){if(x=M===d-1?u?t[f+1]:void 0:t[M+1],x&&t[M].equals(x))continue;E&&(w=E),y&&(v=y),y=t[M],E=x?x.sub(y)._unit()._perp():w,w=w||E;let D=w.add(E);0===D.x&&0===D.y||D._unit();const A=w.x*E.x+w.y*E.y,P=D.x*E.x+D.y*E.y,C=0!==P?1/P:1/0,R=2*Math.sqrt(2-2*P),k=P<gg&&v&&x,N=w.x*E.y-w.y*E.x>0;if(k&&M>f){const U=y.dist(v);if(U>2*m){const $=y.sub(y.sub(v)._mult(m/U)._round());this.updateDistance(v,$),this.addCurrentVertex($,w,0,0,g),v=$}}const z=v&&x;let B=z?r:u?"butt":o;if(z&&"round"===B&&(C<c?B="miter":C<=2&&(B="fakeround")),"miter"===B&&C>s&&(B="bevel"),"bevel"===B&&(C>2&&(B="flipbevel"),C<s&&(B="miter")),v&&this.updateDistance(v,y),"miter"===B)D._mult(C),this.addCurrentVertex(y,D,0,0,g);else if("flipbevel"===B){if(C>100)D=E.mult(-1);else{const U=C*w.add(E).mag()/w.sub(E).mag();D._perp()._mult(U*(N?-1:1))}this.addCurrentVertex(y,D,0,0,g),this.addCurrentVertex(y,D.mult(-1),0,0,g)}else if("bevel"===B||"fakeround"===B){const U=-Math.sqrt(C*C-1),$=N?U:0,W=N?0:U;if(v&&this.addCurrentVertex(y,w,$,W,g),"fakeround"===B){const V=Math.round(180*R/Math.PI/20);for(let K=1;K<V;K++){let Q=K/V;if(.5!==Q){const Y=Q-.5;Q+=Q*Y*(Q-1)*((1.0904+A*(A*(3.55645-1.43519*A)-3.2452))*Y*Y+(.848013+A*(.215638*A-1.06021)))}const ot=E.sub(w)._mult(Q)._add(w)._unit()._mult(N?-1:1);this.addHalfVertex(y,ot.x,ot.y,!1,N,0,g)}}x&&this.addCurrentVertex(y,E,-$,-W,g)}else if("butt"===B)this.addCurrentVertex(y,D,0,0,g);else if("square"===B){const U=v?1:-1;v||this.addCurrentVertex(y,D,U,U,g),this.addCurrentVertex(y,D,0,0,g),v&&this.addCurrentVertex(y,D,U,U,g)}else"round"===B&&(v&&(this.addCurrentVertex(y,w,0,0,g),this.addCurrentVertex(y,w,1,1,g,!0)),x&&(this.addCurrentVertex(y,E,-1,-1,g,!0),this.addCurrentVertex(y,E,0,0,g)));if(k&&M<d-1){const U=y.dist(x);if(U>2*m){const $=y.add(x.sub(y)._mult(m/U)._round());this.updateDistance(y,$),this.addCurrentVertex($,E,0,0,g),y=$}}}}addCurrentVertex(t,n,r,o,s,c=!1){const u=n.y*o-n.x,d=-n.y-n.x*o;this.addHalfVertex(t,n.x+n.y*r,n.y-n.x*r,c,!1,r,s),this.addHalfVertex(t,u,d,c,!0,-o,s)}addHalfVertex({x:t,y:n},r,o,s,c,u,d){this.layoutVertexArray.emplaceBack((t<<1)+(s?1:0),(n<<1)+(c?1:0),Math.round(63*r)+128,Math.round(63*o)+128,1+(0===u?0:u<0?-1:1),0,this.lineSoFar),this.lineClips&&this.layoutVertexArray2.emplaceBack(this.scaledDistance,this.lineClipsArray.length,this.lineClips.start,this.lineClips.end);const f=d.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,f),d.primitiveLength++),c?this.e2=f:this.e1=f}updateScaledDistance(){if(this.lineClips){const t=this.totalDistance/(this.lineClips.end-this.lineClips.start);this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=t*this.lineClips.start+this.distance}else this.lineSoFar=this.distance}updateDistance(t,n){this.distance+=t.dist(n),this.updateScaledDistance()}}re(_g,"LineBucket",{omit:["layers","patternFeatures"]});class hr{constructor(t,n,r,o){this.context=t,this.format=r,this.texture=t.gl.createTexture(),this.update(n,o)}update(t,n,r){const{width:o,height:s}=t,{context:c}=this,{gl:u}=c,{HTMLImageElement:d,HTMLCanvasElement:f,HTMLVideoElement:m,ImageData:g,ImageBitmap:y}=ft;if(u.bindTexture(u.TEXTURE_2D,this.texture),c.pixelStoreUnpackFlipY.set(!1),c.pixelStoreUnpack.set(1),c.pixelStoreUnpackPremultiplyAlpha.set(this.format===u.RGBA&&(!n||!1!==n.premultiply)),r||this.size&&this.size[0]===o&&this.size[1]===s){const{x:v,y:x}=r||{x:0,y:0};if(t instanceof d||t instanceof f||t instanceof m||t instanceof g||y&&t instanceof y)u.texSubImage2D(u.TEXTURE_2D,0,v,x,u.RGBA,u.UNSIGNED_BYTE,t);else{let w=this.format,E=u.UNSIGNED_BYTE;this.format===u.R32F&&(w=u.RED,E=u.FLOAT),u.texSubImage2D(u.TEXTURE_2D,0,v,x,o,s,w,E,t.data)}}else if(this.size=[o,s],t instanceof d||t instanceof f||t instanceof m||t instanceof g||y&&t instanceof y){let v=this.format;this.format===u.R8&&(v=u.RED),u.texImage2D(u.TEXTURE_2D,0,this.format,v,u.UNSIGNED_BYTE,t)}else{let v=this.format,x=this.format,w=u.UNSIGNED_BYTE;this.format===u.DEPTH_COMPONENT&&(v=u.DEPTH_COMPONENT16,w=u.UNSIGNED_SHORT),this.format===u.R32F&&(w=u.FLOAT,x=u.RED),u.texImage2D(u.TEXTURE_2D,0,v,o,s,0,x,w,t.data)}this.useMipmap=!(!n||!n.useMipmap),this.useMipmap&&u.generateMipmap(u.TEXTURE_2D)}bind(t,n){const{context:r}=this,{gl:o}=r;o.bindTexture(o.TEXTURE_2D,this.texture),t!==this.minFilter&&(o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,t),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,this.useMipmap?t===o.NEAREST?o.NEAREST_MIPMAP_NEAREST:o.LINEAR_MIPMAP_NEAREST:t),this.minFilter=t),n!==this.wrapS&&(o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,n),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,n),this.wrapS=n)}bindExtraParam(t,n,r,o){const{context:s}=this,{gl:c}=s;c.bindTexture(c.TEXTURE_2D,this.texture),n!==this.magFilter&&(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,n),this.magFilter=n),t!==this.minFilter&&(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,this.useMipmap?t===c.NEAREST?c.NEAREST_MIPMAP_NEAREST:c.LINEAR_MIPMAP_NEAREST:t),this.minFilter=t),r!==this.wrapS&&(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,r),this.wrapS=r),o!==this.wrapT&&(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,o),this.wrapT=o)}destroy(){const{gl:t}=this.context;t.deleteTexture(this.texture),this.texture=null}}class hd{constructor(t,n){this.context=t,this.texture=n}bind(t,n){const{context:r}=this,{gl:o}=r;o.bindTexture(o.TEXTURE_2D,this.texture),t!==this.minFilter&&(o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,t),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,t),this.minFilter=t),n!==this.wrapS&&(o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,n),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,n),this.wrapS=n)}}const Gs=new Uint16Array(8184);for(let e=0;e<2046;e++){let t=e+2,n=0,r=0,o=0,s=0,c=0,u=0;for(1&t?o=s=c=32:n=r=u=32;(t>>=1)>1;){const f=n+o>>1,m=r+s>>1;1&t?(o=n,s=r,n=c,r=u):(n=o,r=s,o=c,s=u),c=f,u=m}const d=4*e;Gs[d+0]=n,Gs[d+1]=r,Gs[d+2]=o,Gs[d+3]=s}const Hr=new Uint16Array(2178),ns=new Uint8Array(1089),Ou=new Uint16Array(1089);function Ts(e){return 0===e?-.03125:32===e?.03125:0}var yg=Ce([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);const ku={type:2,extent:et,loadGeometry:()=>[[new it(0,0),new it(et+1,0),new it(et+1,et+1),new it(0,et+1),new it(0,0)]]};class Ya{constructor(t,n,r,o,s){this.tileID=t,this.uid=Dr(),this.uses=0,this.tileSize=n,this.tileZoom=r,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.isRaster=s,o&&o.style&&(this._lastUpdatedBrightness=o.style.getBrightness()),this.expiredRequestCount=0,this.state="loading",o&&o.transform&&(this.projection=o.transform.projection)}registerFadeDuration(t){const n=t+this.timeAdded;n<De.now()||this.fadeEndTime&&n<this.fadeEndTime||(this.fadeEndTime=n)}wasRequested(){return"errored"===this.state||"loaded"===this.state||"reloading"===this.state}get tileTransform(){return this._tileTransform||(this._tileTransform=Pu(this.tileID.canonical,this.projection)),this._tileTransform}loadVectorData(t,n,r){if(this.unloadVectorData(),this.state="loaded",t){t.featureIndex&&(this.latestFeatureIndex=t.featureIndex,t.rawTileData?(this.latestRawTileData=t.rawTileData,this.latestFeatureIndex.rawTileData=t.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=t.collisionBoxArray,this.buckets=function(o,s){const c={};if(!s)return c;for(const u of o){const d=u.layerIds.map(f=>s.getLayer(f)).filter(Boolean);if(0!==d.length){u.layers=d,u.stateDependentLayerIds&&(u.stateDependentLayers=u.stateDependentLayerIds.map(f=>d.filter(m=>m.id===f)[0]));for(const f of d)c[f.fqid]=u}}return c}(t.buckets,n.style),this.hasSymbolBuckets=!1;for(const o in this.buckets){const s=this.buckets[o];if(s instanceof ud){if(this.hasSymbolBuckets=!0,!r)break;s.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const o in this.buckets){const s=this.buckets[o];if(s instanceof ud&&s.hasRTLText){this.hasRTLText=!0,bi.isLoading()||bi.isLoaded()||"deferred"!==rm()||ao();break}}this.queryPadding=0;for(const o in this.buckets){const s=this.buckets[o],c=n.style.getOwnLayer(o);if(!c)continue;const u=c.queryRadius(s);this.queryPadding=Math.max(this.queryPadding,u)}t.imageAtlas&&(this.imageAtlas=t.imageAtlas),t.glyphAtlasImage&&(this.glyphAtlasImage=t.glyphAtlasImage),t.lineAtlas&&(this.lineAtlas=t.lineAtlas),this._lastUpdatedBrightness=t.brightness}else this.collisionBoxArray=new Fx}unloadVectorData(){if(this.hasData()){for(const t in this.buckets)this.buckets[t].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.lineAtlasTexture&&this.lineAtlasTexture.destroy(),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),this.latestFeatureIndex=null,this.state="unloaded"}}getBucket(t){return this.buckets[t.fqid]}upload(t){for(const r in this.buckets){const o=this.buckets[r];o.uploadPending()&&o.upload(t)}const n=t.gl;this.imageAtlas&&!this.imageAtlas.uploaded&&(this.imageAtlasTexture=new hr(t,this.imageAtlas.image,n.RGBA),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new hr(t,this.glyphAtlasImage,n.ALPHA),this.glyphAtlasImage=null),this.lineAtlas&&!this.lineAtlas.uploaded&&(this.lineAtlasTexture=new hr(t,this.lineAtlas.image,n.ALPHA),this.lineAtlas.uploaded=!0)}prepare(t,n,r){if(this.imageAtlas&&this.imageAtlasTexture&&this.imageAtlas.patchUpdatedImages(t,this.imageAtlasTexture,r),!n||!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData)return;const o=n.style.getBrightness();(this._lastUpdatedBrightness||o)&&(this._lastUpdatedBrightness&&o&&Math.abs(this._lastUpdatedBrightness-o)<.001||(this._lastUpdatedBrightness=o,this.updateBuckets(void 0,n)))}queryRenderedFeatures(t,n,r,o,s,c,u,d){return this.latestFeatureIndex&&this.latestFeatureIndex.rawTileData?this.latestFeatureIndex.query({tileResult:o,pixelPosMatrix:u,transform:c,params:s,tileTransform:this.tileTransform},t,n,r):{}}querySourceFeatures(t,n){const r=this.latestFeatureIndex;if(!r||!r.rawTileData)return;const o=r.loadVTLayers(),s=n?n.sourceLayer:"",c=o._geojsonTileLayer||o[s];if(!c)return;const u=Ih(n&&n.filter),{z:d,x:f,y:m}=this.tileID.canonical,g={z:d,x:f,y:m};for(let y=0;y<c.length;y++){const v=c.feature(y);if(u.needGeometry){const E=Ua(v,!0);if(!u.filter(new ar(this.tileID.overscaledZ),E,this.tileID.canonical))continue}else if(!u.filter(new ar(this.tileID.overscaledZ),v))continue;const x=r.getId(v,s),w=new qy(v,d,f,m,x);w.tile=g,t.push(w)}}hasData(){return"loaded"===this.state||"reloading"===this.state||"expired"===this.state}bucketsLoaded(){for(const t in this.buckets)if(this.buckets[t].uploadPending())return!1;return!0}patternsLoaded(){return!!this.imageAtlas&&!!Object.keys(this.imageAtlas.patternPositions).length}setExpiryData(t){const n=this.expirationTime;if(t.cacheControl){const r=pe(t.cacheControl);r["max-age"]&&(this.expirationTime=Date.now()+1e3*r["max-age"])}else t.expires&&(this.expirationTime=new Date(t.expires).getTime());if(this.expirationTime){const r=Date.now();let o=!1;if(this.expirationTime>r)o=!1;else if(n)if(this.expirationTime<n)o=!0;else{const s=this.expirationTime-n;s?this.expirationTime=r+Math.max(s,3e4):o=!0}else o=!0;o?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-(new Date).getTime(),Math.pow(2,31)-1)}setFeatureState(t,n){this.latestFeatureIndex&&this.latestFeatureIndex.rawTileData&&0!==Object.keys(t).length&&n&&this.updateBuckets(t,n)}updateBuckets(t,n){if(!this.latestFeatureIndex)return;const r=this.latestFeatureIndex.loadVTLayers(),o=n.style.listImages(),s=n.style.getBrightness();for(const c in this.buckets){if(!n.style.hasLayer(c))continue;const u=this.buckets[c],d=u.layers[0].sourceLayer||"_geojsonTileLayer",f=r[d];let m={};if(t&&(m=t[d],!f||!m||0===Object.keys(m).length))continue;if(u.update(m,f,o,this.imageAtlas&&this.imageAtlas.patternPositions||{},s),u instanceof _g||u instanceof Eu){const y=n.style.getOwnSourceCache(u.layers[0].source);n._terrain&&n._terrain.enabled&&y&&u.programConfigurations.needsUpload&&n._terrain._clearRenderCacheForTile(y.id,this.tileID)}const g=n&&n.style&&n.style.getOwnLayer(c);g&&(this.queryPadding=Math.max(this.queryPadding,g.queryRadius(u)))}}holdingForFade(){return void 0!==this.symbolFadeHoldUntil}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<De.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(t){this.symbolFadeHoldUntil=De.now()+t}setTexture(t,n){const r=n.context,o=r.gl;this.texture=this.texture||n.getTileTexture(t.width),this.texture&&this.texture instanceof hr?this.texture.update(t,{useMipmap:!0}):(this.texture=new hr(r,t,o.RGBA,{useMipmap:!0}),this.texture.bind(o.LINEAR,o.CLAMP_TO_EDGE))}setDependencies(t,n){const r={};for(const o of n)r[o]=!0;this.dependencies[t]=r}hasDependency(t,n){for(const r of t){const o=this.dependencies[r];if(o)for(const s of n)if(o[s])return!0}return!1}clearQueryDebugViz(){}_makeDebugTileBoundsBuffers(t,n){if(!n||"mercator"===n.name||this._tileDebugBuffer)return;const r=ca(ku,this.tileID.canonical,this.tileTransform)[0],o=new Xo,s=new hm;for(let c=0;c<r.length;c++){const{x:u,y:d}=r[c];o.emplaceBack(u,d),s.emplaceBack(c)}s.emplaceBack(0),this._tileDebugIndexBuffer=t.createIndexBuffer(s),this._tileDebugBuffer=t.createVertexBuffer(o,Cl.members),this._tileDebugSegments=Rn.simpleSegment(0,0,o.length,s.length)}_makeTileBoundsBuffers(t,n){if(this._tileBoundsBuffer||!n||"mercator"===n.name)return;const r=ca(ku,this.tileID.canonical,this.tileTransform)[0];let o,s;if(this.isRaster){const c=function(u,d){const f=Pu(u,d),m=Math.pow(2,u.z);for(let E=0;E<33;E++)for(let M=0;M<33;M++){const D=Jo((u.x+(M+Ts(M))/32)/m),A=xr((u.y+(E+Ts(E))/32)/m),P=d.project(D,A),C=33*E+M;Hr[2*C+0]=Math.round((P.x*f.scale-f.x)*et),Hr[2*C+1]=Math.round((P.y*f.scale-f.y)*et)}ns.fill(0),Ou.fill(0);for(let E=2045;E>=0;E--){const M=4*E,D=Gs[M+0],A=Gs[M+1],P=Gs[M+2],C=Gs[M+3],R=D+P>>1,k=A+C>>1,N=R+k-A,z=k+D-R,B=33*A+D,U=33*C+P,$=33*k+R,W=Math.hypot((Hr[2*B+0]+Hr[2*U+0])/2-Hr[2*$+0],(Hr[2*B+1]+Hr[2*U+1])/2-Hr[2*$+1])>=16;ns[$]=ns[$]||(W?1:0),E<1022&&(ns[$]=ns[$]||ns[33*(A+z>>1)+(D+N>>1)]||ns[33*(C+z>>1)+(P+N>>1)])}const g=new nu,y=new Kr;let v=0;function x(E,M){const D=33*M+E;return 0===Ou[D]&&(g.emplaceBack(Hr[2*D+0],Hr[2*D+1],E*et/32,M*et/32),Ou[D]=++v),Ou[D]-1}function w(E,M,D,A,P,C){const R=E+D>>1,k=M+A>>1;if(Math.abs(E-P)+Math.abs(M-C)>1&&ns[33*k+R])w(P,C,E,M,R,k),w(D,A,P,C,R,k);else{const N=x(E,M),z=x(D,A),B=x(P,C);y.emplaceBack(N,z,B)}}return w(0,0,32,32,32,0),w(32,32,0,0,0,32),{vertices:g,indices:y}}(this.tileID.canonical,n);o=c.vertices,s=c.indices}else{o=new nu,s=new Kr;for(const{x:u,y:d}of r)o.emplaceBack(u,d,0,0);const c=Xf(o.int16,void 0,4);for(let u=0;u<c.length;u+=3)s.emplaceBack(c[u],c[u+1],c[u+2])}this._tileBoundsBuffer=t.createVertexBuffer(o,yg.members),this._tileBoundsIndexBuffer=t.createIndexBuffer(s),this._tileBoundsSegments=Rn.simpleSegment(0,0,o.length,s.length)}_makeGlobeTileDebugBuffers(t,n){const r=n.projection;if(!r||"globe"!==r.name||n.freezeTileCoverage)return;const o=this.tileID.canonical,s=mu(R1(o,n)),c=ri(n.zoom);let u;c>0&&(u=st.invert(new Float64Array(16),n.globeMatrix)),this._makeGlobeTileDebugBorderBuffer(t,o,n,s,u,c),this._makeGlobeTileDebugTextBuffer(t,o,n,s,u,c)}_globePoint(t,n,r,o,s,c,u){let d=Om(t,n,r);if(c){const f=1<<r.z,m=Br(o.center.lng),g=ui(o.center.lat),y=(r.x+.5)/f-m;let v=0;y>.5?v=-1:y<-.5&&(v=1);let x=(t/et+r.x)/f+v,w=(n/et+r.y)/f;x=(x-m)*o._pixelsPerMercatorPixel+m,w=(w-g)*o._pixelsPerMercatorPixel+g;const E=[x*o.worldSize,w*o.worldSize,0];Z.transformMat4(E,E,c),d=Al(d,E,u)}return Z.transformMat4(d,d,s)}_makeGlobeTileDebugBorderBuffer(t,n,r,o,s,c){const u=new Xo,d=new hm,f=new im,m=(y,v,x,w,E)=>{const M=(x-y)/(E-1),D=(w-v)/(E-1),A=u.length;for(let P=0;P<E;P++){const C=y+P*M,R=v+P*D;u.emplaceBack(C,R);const k=this._globePoint(C,R,n,r,o,s,c);f.emplaceBack(k[0],k[1],k[2]),d.emplaceBack(A+P)}},g=et;m(0,0,g,0,16),m(g,0,g,g,16),m(g,g,0,g,16),m(0,g,0,0,16),this._tileDebugIndexBuffer=t.createIndexBuffer(d),this._tileDebugBuffer=t.createVertexBuffer(u,Cl.members),this._globeTileDebugBorderBuffer=t.createVertexBuffer(f,zh.members),this._tileDebugSegments=Rn.simpleSegment(0,0,u.length,d.length)}_makeGlobeTileDebugTextBuffer(t,n,r,o,s,c){const u=et/4,d=new Xo,f=new Kr,m=new im,g=25;f.reserve(32),d.reserve(g),m.reserve(g);const y=(v,x)=>g*v+x;for(let v=0;v<g;v++){const x=v*u;for(let w=0;w<g;w++){const E=w*u;d.emplaceBack(E,x);const M=this._globePoint(E,x,n,r,o,s,c);m.emplaceBack(M[0],M[1],M[2])}}for(let v=0;v<4;v++)for(let x=0;x<4;x++){const w=y(v,x),E=y(v,x+1),M=y(v+1,x),D=y(v+1,x+1);f.emplaceBack(w,E,M),f.emplaceBack(M,E,D)}this._tileDebugTextIndexBuffer=t.createIndexBuffer(f),this._tileDebugTextBuffer=t.createVertexBuffer(d,Cl.members),this._globeTileDebugTextBuffer=t.createVertexBuffer(m,zh.members),this._tileDebugTextSegments=Rn.simpleSegment(0,0,g,32)}destroy(t=!1){for(const n in this.buckets)this.buckets[n].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&(this.imageAtlasTexture.destroy(),delete this.imageAtlasTexture),this.glyphAtlasTexture&&(this.glyphAtlasTexture.destroy(),delete this.glyphAtlasTexture),this.lineAtlasTexture&&(this.lineAtlasTexture.destroy(),delete this.lineAtlasTexture),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),!t&&this.texture&&this.texture instanceof hr&&(this.texture.destroy(),delete this.texture),this.hillshadeFBO&&(this.hillshadeFBO.destroy(),delete this.hillshadeFBO),this.dem&&delete this.dem,this.neighboringTiles&&delete this.neighboringTiles,this.demTexture&&(this.demTexture.destroy(),delete this.demTexture),this.latestFeatureIndex=null,this.state="unloaded"}}class dd{constructor(t,n){this.max=t,this.onRemove=n,this.reset()}reset(){for(const t in this.data)for(const n of this.data[t])n.timeout&&clearTimeout(n.timeout),this.onRemove(n.value);return this.data={},this.order=[],this}add(t,n,r){const o=t.wrapped().key;void 0===this.data[o]&&(this.data[o]=[]);const s={value:n,timeout:void 0};if(void 0!==r&&(s.timeout=setTimeout(()=>{this.remove(t,s)},r)),this.data[o].push(s),this.order.push(o),this.order.length>this.max){const c=this._getAndRemoveByKey(this.order[0]);c&&this.onRemove(c)}return this}has(t){return t.wrapped().key in this.data}getAndRemove(t){return this.has(t)?this._getAndRemoveByKey(t.wrapped().key):null}_getAndRemoveByKey(t){const n=this.data[t].shift();return n.timeout&&clearTimeout(n.timeout),0===this.data[t].length&&delete this.data[t],this.order.splice(this.order.indexOf(t),1),n.value}getByKey(t){const n=this.data[t];return n?n[0].value:null}get(t){return this.has(t)?this.data[t.wrapped().key][0].value:null}remove(t,n){if(!this.has(t))return this;const r=t.wrapped().key,o=void 0===n?0:this.data[r].indexOf(n),s=this.data[r][o];return this.data[r].splice(o,1),s.timeout&&clearTimeout(s.timeout),0===this.data[r].length&&delete this.data[r],this.onRemove(s.value),this.order.splice(this.order.indexOf(r),1),this}setMaxSize(t){for(this.max=t;this.order.length>this.max;){const n=this._getAndRemoveByKey(this.order[0]);n&&this.onRemove(n)}return this}filter(t){const n=[];for(const r in this.data)for(const o of this.data[r])t(o.value)||n.push(o);for(const r of n)this.remove(r.value.tileID,r)}}let Fu=(()=>{class e{constructor(n,r,o,s){this.id=e.uniqueIdxCounter,e.uniqueIdxCounter++,this.context=n;const c=n.gl;this.buffer=c.createBuffer(),this.dynamicDraw=!!o,this.context.unbindVAO(),n.bindElementBuffer.set(this.buffer),c.bufferData(c.ELEMENT_ARRAY_BUFFER,r.arrayBuffer,this.dynamicDraw?c.DYNAMIC_DRAW:c.STATIC_DRAW),this.dynamicDraw||s||r.destroy()}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(n){this.id=e.uniqueIdxCounter,e.uniqueIdxCounter++;const r=this.context.gl;this.context.unbindVAO(),this.bind(),r.bufferSubData(r.ELEMENT_ARRAY_BUFFER,0,n.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}return e.uniqueIdxCounter=0,e})();const fd={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class pd{constructor(t,n,r,o,s,c){this.length=n.length,this.attributes=r,this.itemSize=n.bytesPerElement,this.dynamicDraw=o,this.instanceCount=c,this.context=t;const u=t.gl;this.buffer=u.createBuffer(),t.bindVertexBuffer.set(this.buffer),u.bufferData(u.ARRAY_BUFFER,n.arrayBuffer,this.dynamicDraw?u.DYNAMIC_DRAW:u.STATIC_DRAW),this.dynamicDraw||s||n.destroy()}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(t){const n=this.context.gl;this.bind(),n.bufferSubData(n.ARRAY_BUFFER,0,t.arrayBuffer)}enableAttributes(t,n){for(let r=0;r<this.attributes.length;r++){const o=n.attributes[this.attributes[r].name];void 0!==o&&t.enableVertexAttribArray(o)}}setVertexAttribPointers(t,n,r){for(let o=0;o<this.attributes.length;o++){const s=this.attributes[o],c=n.attributes[s.name];void 0!==c&&t.vertexAttribPointer(c,s.components,t[fd[s.type]],!1,this.itemSize,s.offset+this.itemSize*(r||0))}}setVertexAttribDivisor(t,n,r){for(let o=0;o<this.attributes.length;o++){const s=n.attributes[this.attributes[o].name];void 0!==s&&this.instanceCount&&this.instanceCount>0&&t.vertexAttribDivisor(s,r)}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class Un{constructor(t){this.gl=t.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(t){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class md extends Un{getDefault(){return ke.transparent}set(t){const n=this.current;(t.r!==n.r||t.g!==n.g||t.b!==n.b||t.a!==n.a||this.dirty)&&(this.gl.clearColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1)}}class gd extends Un{getDefault(){return 1}set(t){(t!==this.current||this.dirty)&&(this.gl.clearDepth(t),this.current=t,this.dirty=!1)}}class Ub extends Un{getDefault(){return 0}set(t){(t!==this.current||this.dirty)&&(this.gl.clearStencil(t),this.current=t,this.dirty=!1)}}class Gb extends Un{getDefault(){return[!0,!0,!0,!0]}set(t){const n=this.current;(t[0]!==n[0]||t[1]!==n[1]||t[2]!==n[2]||t[3]!==n[3]||this.dirty)&&(this.gl.colorMask(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class $b extends Un{getDefault(){return!0}set(t){(t!==this.current||this.dirty)&&(this.gl.depthMask(t),this.current=t,this.dirty=!1)}}class Hb extends Un{getDefault(){return 255}set(t){(t!==this.current||this.dirty)&&(this.gl.stencilMask(t),this.current=t,this.dirty=!1)}}class qb extends Un{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(t){const n=this.current;(t.func!==n.func||t.ref!==n.ref||t.mask!==n.mask||this.dirty)&&(this.gl.stencilFunc(t.func,t.ref,t.mask),this.current=t,this.dirty=!1)}}class Zb extends Un{getDefault(){const t=this.gl;return[t.KEEP,t.KEEP,t.KEEP]}set(t){const n=this.current;(t[0]!==n[0]||t[1]!==n[1]||t[2]!==n[2]||this.dirty)&&(this.gl.stencilOp(t[0],t[1],t[2]),this.current=t,this.dirty=!1)}}class Wb extends Un{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;t?n.enable(n.STENCIL_TEST):n.disable(n.STENCIL_TEST),this.current=t,this.dirty=!1}}class Xb extends Un{getDefault(){return[0,1]}set(t){const n=this.current;(t[0]!==n[0]||t[1]!==n[1]||this.dirty)&&(this.gl.depthRange(t[0],t[1]),this.current=t,this.dirty=!1)}}class Yb extends Un{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;t?n.enable(n.DEPTH_TEST):n.disable(n.DEPTH_TEST),this.current=t,this.dirty=!1}}class s0 extends Un{getDefault(){return this.gl.LESS}set(t){(t!==this.current||this.dirty)&&(this.gl.depthFunc(t),this.current=t,this.dirty=!1)}}class wI extends Un{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;t?n.enable(n.BLEND):n.disable(n.BLEND),this.current=t,this.dirty=!1}}class PC extends Un{getDefault(){const t=this.gl;return[t.ONE,t.ZERO,t.ONE,t.ZERO]}set(t){const n=this.current;(t[0]!==n[0]||t[1]!==n[1]||t[2]!==n[2]||t[3]!==n[3]||this.dirty)&&(this.gl.blendFuncSeparate(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class RC extends Un{getDefault(){return ke.transparent}set(t){const n=this.current;(t.r!==n.r||t.g!==n.g||t.b!==n.b||t.a!==n.a||this.dirty)&&(this.gl.blendColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1)}}class EI extends Un{getDefault(){return this.gl.FUNC_ADD}set(t){(t!==this.current||this.dirty)&&(this.gl.blendEquationSeparate(t,t),this.current=t,this.dirty=!1)}}class TI extends Un{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;t?n.enable(n.CULL_FACE):n.disable(n.CULL_FACE),this.current=t,this.dirty=!1}}class LC extends Un{getDefault(){return this.gl.BACK}set(t){(t!==this.current||this.dirty)&&(this.gl.cullFace(t),this.current=t,this.dirty=!1)}}class MI extends Un{getDefault(){return this.gl.CCW}set(t){(t!==this.current||this.dirty)&&(this.gl.frontFace(t),this.current=t,this.dirty=!1)}}let OC=class extends Un{getDefault(){return null}set(e){(e!==this.current||this.dirty)&&(this.gl.useProgram(e),this.current=e,this.dirty=!1)}};class II extends Un{getDefault(){return this.gl.TEXTURE0}set(t){(t!==this.current||this.dirty)&&(this.gl.activeTexture(t),this.current=t,this.dirty=!1)}}class DI extends Un{getDefault(){const t=this.gl;return[0,0,t.drawingBufferWidth,t.drawingBufferHeight]}set(t){const n=this.current;(t[0]!==n[0]||t[1]!==n[1]||t[2]!==n[2]||t[3]!==n[3]||this.dirty)&&(this.gl.viewport(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class SI extends Un{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.bindFramebuffer(n.FRAMEBUFFER,t),this.current=t,this.dirty=!1}}class a0 extends Un{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.bindRenderbuffer(n.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class cp extends Un{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.bindTexture(n.TEXTURE_2D,t),this.current=t,this.dirty=!1}}class l0 extends Un{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.bindBuffer(n.ARRAY_BUFFER,t),this.current=t,this.dirty=!1}}class vg extends Un{getDefault(){return null}set(t){const n=this.gl;n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t),this.current=t,this.dirty=!1}}class Kb extends Un{getDefault(){return null}set(t){this.gl&&(t!==this.current||this.dirty)&&(this.gl.bindVertexArray(t),this.current=t,this.dirty=!1)}}class up extends Un{getDefault(){return 4}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.pixelStorei(n.UNPACK_ALIGNMENT,t),this.current=t,this.dirty=!1}}class Jb extends Un{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t),this.current=t,this.dirty=!1}}class CI extends Un{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,t),this.current=t,this.dirty=!1}}class Nu extends Un{constructor(t,n){super(t),this.context=t,this.parent=n}getDefault(){return null}}class AI extends Nu{setDirty(){this.dirty=!0}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const n=this.gl;n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,t,0),this.current=t,this.dirty=!1}}class Qb extends Nu{attachment(){return this.gl.DEPTH_ATTACHMENT}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const n=this.gl;n.framebufferRenderbuffer(n.FRAMEBUFFER,this.attachment(),n.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class PI extends Nu{attachment(){return this.gl.DEPTH_ATTACHMENT}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const n=this.gl;n.framebufferTexture2D(n.FRAMEBUFFER,this.attachment(),n.TEXTURE_2D,t,0),this.current=t,this.dirty=!1}}class RI extends Qb{attachment(){return this.gl.DEPTH_STENCIL_ATTACHMENT}}class c0{constructor(t,n,r,o,s){this.context=t,this.width=n,this.height=r;const c=this.framebuffer=t.gl.createFramebuffer();o&&(this.colorAttachment=new AI(t,c)),s&&(this.depthAttachmentType=s,this.depthAttachment="renderbuffer"===s?new Qb(t,c):new PI(t,c))}destroy(){const t=this.context.gl;if(this.colorAttachment){const n=this.colorAttachment.get();n&&t.deleteTexture(n)}if(this.depthAttachment&&this.depthAttachmentType)if("renderbuffer"===this.depthAttachmentType){const n=this.depthAttachment.get();n&&t.deleteRenderbuffer(n)}else{const n=this.depthAttachment.get();n&&t.deleteTexture(n)}t.deleteFramebuffer(this.framebuffer)}}class be{constructor(t,n,r){this.func=t,this.mask=n,this.range=r}}be.ReadOnly=!1,be.ReadWrite=!0,be.disabled=new be(519,be.ReadOnly,[0,1]);class $e{constructor(t,n,r,o,s,c){this.test=t,this.ref=n,this.mask=r,this.fail=o,this.depthFail=s,this.pass=c}}$e.disabled=new $e({func:519,mask:0},0,0,7680,7680,7680);class hn{constructor(t,n,r,o){this.blendFunction=t,this.blendColor=n,this.mask=r,this.blendEquation=o}}hn.Replace=[1,0,1,0],hn.disabled=new hn(hn.Replace,ke.transparent,[!1,!1,!1,!1]),hn.unblended=new hn(hn.Replace,ke.transparent,[!0,!0,!0,!0]),hn.alphaBlended=new hn([1,771,1,771],ke.transparent,[!0,!0,!0,!0]),hn.multiply=new hn([774,0,774,0],ke.transparent,[!0,!0,!0,!0]);class Ge{constructor(t,n,r){this.enable=t,this.mode=n,this.frontFace=r}}Ge.disabled=new Ge(!1,1029,2305),Ge.backCCW=new Ge(!0,1029,2305),Ge.backCW=new Ge(!0,1029,2304),Ge.frontCW=new Ge(!0,1028,2304),Ge.frontCCW=new Ge(!0,1028,2305);class LI{constructor(t,n){this.gl=t,this.clearColor=new md(this),this.clearDepth=new gd(this),this.clearStencil=new Ub(this),this.colorMask=new Gb(this),this.depthMask=new $b(this),this.stencilMask=new Hb(this),this.stencilFunc=new qb(this),this.stencilOp=new Zb(this),this.stencilTest=new Wb(this),this.depthRange=new Xb(this),this.depthTest=new Yb(this),this.depthFunc=new s0(this),this.blend=new wI(this),this.blendFunc=new PC(this),this.blendColor=new RC(this),this.blendEquation=new EI(this),this.cullFace=new TI(this),this.cullFaceSide=new LC(this),this.frontFace=new MI(this),this.program=new OC(this),this.activeTexture=new II(this),this.viewport=new DI(this),this.bindFramebuffer=new SI(this),this.bindRenderbuffer=new a0(this),this.bindTexture=new cp(this),this.bindVertexBuffer=new l0(this),this.bindElementBuffer=new vg(this),this.bindVertexArrayOES=new Kb(this),this.pixelStoreUnpack=new up(this),this.pixelStoreUnpackPremultiplyAlpha=new Jb(this),this.pixelStoreUnpackFlipY=new CI(this),this.options=n?{...n}:{},this.options.extTextureFilterAnisotropicForceOff||(this.extTextureFilterAnisotropic=t.getExtension("EXT_texture_filter_anisotropic")||t.getExtension("MOZ_EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=t.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT))),this.extDebugRendererInfo=t.getExtension("WEBGL_debug_renderer_info"),this.extDebugRendererInfo&&(this.renderer=t.getParameter(this.extDebugRendererInfo.UNMASKED_RENDERER_WEBGL),this.vendor=t.getParameter(this.extDebugRendererInfo.UNMASKED_VENDOR_WEBGL)),this.options.extTextureFloatLinearForceOff||(this.extTextureFloatLinear=t.getExtension("OES_texture_float_linear")),this.extRenderToTextureHalfFloat=t.getExtension("EXT_color_buffer_half_float"),this.extTimerQuery=t.getExtension("EXT_disjoint_timer_query_webgl2"),this.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE)}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArrayOES.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(t,n,r){return new Fu(this,t,n,r)}createVertexBuffer(t,n,r,o,s){return new pd(this,t,n,r,o,s)}createRenderbuffer(t,n,r){const o=this.gl,s=o.createRenderbuffer();return this.bindRenderbuffer.set(s),o.renderbufferStorage(o.RENDERBUFFER,t,n,r),this.bindRenderbuffer.set(null),s}createFramebuffer(t,n,r,o){return new c0(this,t,n,r,o)}clear({color:t,depth:n,stencil:r,colorMask:o}){const s=this.gl;let c=0;t&&(c|=s.COLOR_BUFFER_BIT,this.clearColor.set(t),this.colorMask.set(o||[!0,!0,!0,!0])),void 0!==n&&(c|=s.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(n),this.depthMask.set(!0)),void 0!==r&&(c|=s.STENCIL_BUFFER_BIT,this.clearStencil.set(r),this.stencilMask.set(255)),s.clear(c)}setCullFace(t){!1===t.enable?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(t.mode),this.frontFace.set(t.frontFace))}setDepthMode(t){t.func!==this.gl.ALWAYS||t.mask?(this.depthTest.set(!0),this.depthFunc.set(t.func),this.depthMask.set(t.mask),this.depthRange.set(t.range)):this.depthTest.set(!1)}setStencilMode(t){t.test.func!==this.gl.ALWAYS||t.mask?(this.stencilTest.set(!0),this.stencilMask.set(t.mask),this.stencilOp.set([t.fail,t.depthFail,t.pass]),this.stencilFunc.set({func:t.test.func,ref:t.ref,mask:t.test.mask})):this.stencilTest.set(!1)}setColorMode(t){tn(t.blendFunction,hn.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(t.blendFunction),this.blendColor.set(t.blendColor),t.blendEquation?this.blendEquation.set(t.blendEquation):this.blendEquation.setDefault()),this.colorMask.set(t.mask)}unbindVAO(){this.bindVertexArrayOES.set(null)}}class ha extends ye{constructor(t,n,r){super(),this.id=t,this._onlySymbols=r,n.on("data",o=>{"source"===o.dataType&&"metadata"===o.sourceDataType&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&"source"===o.dataType&&"content"===o.sourceDataType&&(this.reload(),this.transform&&this.update(this.transform))}),n.on("error",()=>{this._sourceErrored=!0}),this._source=n,this._tiles={},this._cache=new dd(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._minTileCacheSize=n.minTileCacheSize,this._maxTileCacheSize=n.maxTileCacheSize,this._loadedParentTiles={},this.castsShadows=!1,this._coveredTiles={},this._shadowCasterTiles={},this._state=new JM,this._isRaster="raster"===this._source.type||"raster-dem"===this._source.type||"custom"===this._source.type&&"raster"===this._source._dataType}onAdd(t){this.map=t,this._minTileCacheSize=void 0===this._minTileCacheSize&&t?t._minTileCacheSize:this._minTileCacheSize,this._maxTileCacheSize=void 0===this._maxTileCacheSize&&t?t._maxTileCacheSize:this._maxTileCacheSize}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;for(const t in this._tiles){const n=this._tiles[t];if("errored"!==n.state&&("loaded"!==n.state||!n.bucketsLoaded()))return!1}return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const t=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,t&&this.reload(),this.transform&&this.update(this.transform)}_loadTile(t,n){return t.isSymbolTile=this._onlySymbols,t.isExtraShadowCaster=this._shadowCasterTiles[t.tileID.key],this._source.loadTile(t,n)}_unloadTile(t){if(this._source.unloadTile)return this._source.unloadTile(t,()=>{})}_abortTile(t){if(this._source.abortTile)return this._source.abortTile(t,()=>{})}serialize(){return this._source.serialize()}prepare(t){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const n in this._tiles){const r=this._tiles[n];r.upload(t),r.prepare(this.map.style.imageManager,this.map?this.map.painter:null,this._source.scope)}}getIds(){return _i(this._tiles).map(t=>t.tileID).sort(tw).map(t=>t.key)}getRenderableIds(t,n){const r=[];for(const o in this._tiles)this._isIdRenderable(+o,t,n)&&r.push(this._tiles[o]);return t?r.sort((o,s)=>{const c=o.tileID,u=s.tileID,d=new it(c.canonical.x,c.canonical.y)._rotate(this.transform.angle),f=new it(u.canonical.x,u.canonical.y)._rotate(this.transform.angle);return c.overscaledZ-u.overscaledZ||f.y-d.y||f.x-d.x}).map(o=>o.tileID.key):r.map(o=>o.tileID).sort(tw).map(o=>o.key)}hasRenderableParent(t){const n=this.findLoadedParent(t,0);return!!n&&this._isIdRenderable(n.tileID.key)}_isIdRenderable(t,n,r){return this._tiles[t]&&this._tiles[t].hasData()&&!this._coveredTiles[t]&&(n||!this._tiles[t].holdingForFade())&&(r||!this._shadowCasterTiles[t])}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const t in this._tiles)"errored"!==this._tiles[t].state&&this._reloadTile(+t,"reloading")}}_reloadTile(t,n){const r=this._tiles[t];r&&("loading"!==r.state&&(r.state=n),this._loadTile(r,this._tileLoaded.bind(this,r,t,n)))}_tileLoaded(t,n,r,o){if(o)if(t.state="errored",404!==o.status)this._source.fire(new Tt(o,{tile:t}));else{if(!(t.tileID.key in this._loadedParentTiles))return void this._source.fire(new Mt("data",{dataType:"source",sourceDataType:"error",sourceId:this._source.id}));if("raster-dem"===this._source.type&&this.usedForTerrain&&this.map.painter.terrain){const s=this.map.painter.terrain;this.update(this.transform,s.getScaledDemTileSize(),!0),s.resetTileLookupCache(this.id)}else this.update(this.transform)}else t.timeAdded=De.now(),"expired"===r&&(t.refreshedUponExpiration=!0),this._setTileReloadTimer(n,t),"raster-dem"===this._source.type&&t.dem&&this._backfillDEM(t),this._state.initializeTileState(t,this.map?this.map.painter:null),this._source.fire(new Mt("data",{dataType:"source",tile:t,coord:t.tileID,sourceCacheId:this.id}))}_backfillDEM(t){const n=this.getRenderableIds();for(let o=0;o<n.length;o++){const s=n[o];if(t.neighboringTiles&&t.neighboringTiles[s]){const c=this.getTileByID(s);r(t,c),r(c,t)}}function r(o,s){if(!o.dem||o.dem.borderReady)return;o.needsHillshadePrepare=!0,o.needsDEMTextureUpload=!0;let c=s.tileID.canonical.x-o.tileID.canonical.x;const u=s.tileID.canonical.y-o.tileID.canonical.y,d=Math.pow(2,o.tileID.canonical.z),f=s.tileID.key;0===c&&0===u||Math.abs(u)>1||(Math.abs(c)>1&&(1===Math.abs(c+d)?c+=d:1===Math.abs(c-d)&&(c-=d)),s.dem&&o.dem&&(o.dem.backfillBorder(s.dem,c,u),o.neighboringTiles&&o.neighboringTiles[f]&&(o.neighboringTiles[f].backfilled=!0)))}}getTile(t){return this.getTileByID(t.key)}getTileByID(t){return this._tiles[t]}_retainLoadedChildren(t,n,r,o){for(const s in this._tiles){let c=this._tiles[s];if(o[s]||!c.hasData()||c.tileID.overscaledZ<=n||c.tileID.overscaledZ>r)continue;let u=c.tileID;for(;c&&c.tileID.overscaledZ>n+1;){const f=c.tileID.scaledTo(c.tileID.overscaledZ-1);c=this._tiles[f.key],c&&c.hasData()&&(u=f)}let d=u;for(;d.overscaledZ>n;)if(d=d.scaledTo(d.overscaledZ-1),t[d.key]){o[u.key]=u;break}}}findLoadedParent(t,n){if(t.key in this._loadedParentTiles){const r=this._loadedParentTiles[t.key];return r&&r.tileID.overscaledZ>=n?r:null}for(let r=t.overscaledZ-1;r>=n;r--){const o=t.scaledTo(r),s=this._getLoadedTile(o);if(s)return s}}_getLoadedTile(t){const n=this._tiles[t.key];return n&&n.hasData()?n:this._cache.getByKey(this._source.reparseOverscaled?t.wrapped().key:t.canonical.key)}updateCacheSize(t,n){n=n||this._source.tileSize;const r=Math.ceil(t.width/n)+1,o=Math.ceil(t.height/n)+1,s=Math.floor(r*o*5),c="number"==typeof this._minTileCacheSize?Math.max(this._minTileCacheSize,s):s,u="number"==typeof this._maxTileCacheSize?Math.min(this._maxTileCacheSize,c):c;this._cache.setMaxSize(u)}handleWrapJump(t){const n=Math.round((t-(void 0===this._prevLng?t:this._prevLng))/360);if(this._prevLng=t,n){const r={};for(const o in this._tiles){const s=this._tiles[o];s.tileID=s.tileID.unwrapTo(s.tileID.wrap+n),r[s.tileID.key]=s}this._tiles=r;for(const o in this._timers)clearTimeout(this._timers[o]),delete this._timers[o];for(const o in this._tiles)this._setTileReloadTimer(+o,this._tiles[o])}}update(t,n,r,o){if(this.transform=t,!this._sourceLoaded||this._paused||this.transform.freezeTileCoverage||this.usedForTerrain&&!r)return;let s;if(this.updateCacheSize(t,n),"globe"!==this.transform.projection.name&&this.handleWrapJump(this.transform.center.lng),this._shadowCasterTiles={},this._coveredTiles={},this.used||this.usedForTerrain?this._source.tileID?s=t.getVisibleUnwrappedCoordinates(this._source.tileID).map(d=>new nn(d.canonical.z,d.wrap,d.canonical.z,d.canonical.x,d.canonical.y)):(s=t.coveringTiles({tileSize:n||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!r,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain}),this._source.hasTile&&(s=s.filter(d=>this._source.hasTile(d)))):s=[],s.length>0&&this.castsShadows&&o&&"globe"!==this.transform.projection.name&&!this.usedForTerrain&&!bg(this._source.type)){const d=t.coveringZoomLevel({tileSize:n||this._source.tileSize,roundZoom:this._source.roundZoom&&!r}),f=Math.min(d,this._source.maxzoom),m=t.extendTileCoverForShadows(s,o,f);for(const g of m)this._shadowCasterTiles[g.key]=!0,s.push(g)}const c=this._updateRetainedTiles(s);if(bg(this._source.type)&&0!==s.length){const d={},f={},m=Object.keys(c);for(const y of m){const v=c[y],x=this._tiles[y];if(!x||x.fadeEndTime&&x.fadeEndTime<=De.now())continue;const w=this.findLoadedParent(v,Math.max(v.overscaledZ-ha.maxOverzooming,this._source.minzoom));w&&(this._addTile(w.tileID),d[w.tileID.key]=w.tileID),f[y]=v}const g=s[s.length-1].overscaledZ;for(const y in this._tiles){const v=this._tiles[y];if(c[y]||!v.hasData())continue;let x=v.tileID;for(;x.overscaledZ>g;){x=x.scaledTo(x.overscaledZ-1);const w=this._tiles[x.key];if(w&&w.hasData()&&f[x.key]){c[y]=v.tileID;break}}}for(const y in d)c[y]||(this._coveredTiles[y]=!0,c[y]=d[y])}for(const d in c)this._tiles[d].clearFadeHold();const u=function(d,f){const m=[];for(const g in d)g in f||m.push(g);return m}(this._tiles,c);for(const d of u){const f=this._tiles[d];f.hasSymbolBuckets&&!f.holdingForFade()?f.setHoldDuration(this.map._fadeDuration):f.hasSymbolBuckets&&!f.symbolFadeFinished()||this._removeTile(+d)}this._updateLoadedParentTileCache(),this._onlySymbols&&this._source.afterUpdate&&this._source.afterUpdate()}releaseSymbolFadeTiles(){for(const t in this._tiles)this._tiles[t].holdingForFade()&&this._removeTile(+t)}_updateRetainedTiles(t){const n={};if(0===t.length)return n;const r={},o=t.reduce((f,m)=>Math.min(f,m.overscaledZ),1/0),s=t[0].overscaledZ,c=Math.max(s-ha.maxOverzooming,this._source.minzoom),u=Math.max(s+ha.maxUnderzooming,this._source.minzoom),d={};for(const f of t){const m=this._addTile(f);n[f.key]=f,m.hasData()||o<this._source.maxzoom&&(d[f.key]=f)}this._retainLoadedChildren(d,o,u,n);for(const f of t){let m=this._tiles[f.key];if(m.hasData())continue;if(f.canonical.z>=this._source.maxzoom){const y=f.children(this._source.maxzoom)[0],v=this.getTile(y);if(v&&v.hasData()){n[y.key]=y;continue}}else{const y=f.children(this._source.maxzoom);if(n[y[0].key]&&n[y[1].key]&&n[y[2].key]&&n[y[3].key])continue}let g=m.wasRequested();for(let y=f.overscaledZ-1;y>=c;--y){const v=f.scaledTo(y);if(r[v.key]||(r[v.key]=!0,m=this.getTile(v),!m&&g&&(m=this._addTile(v)),m&&(n[v.key]=v,g=m.wasRequested(),m.hasData())))break}}return n}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const t in this._tiles){const n=[];let r,o=this._tiles[t].tileID;for(;o.overscaledZ>0;){if(o.key in this._loadedParentTiles){r=this._loadedParentTiles[o.key];break}n.push(o.key);const s=o.scaledTo(o.overscaledZ-1);if(r=this._getLoadedTile(s),r)break;o=s}for(const s of n)this._loadedParentTiles[s]=r}}_addTile(t){let n=this._tiles[t.key];if(n)return!0!==n.isExtraShadowCaster||this._shadowCasterTiles[t.key]||this._reloadTile(t.key,"reloading"),n;n=this._cache.getAndRemove(t),n&&(this._setTileReloadTimer(t.key,n),n.tileID=t,this._state.initializeTileState(n,this.map?this.map.painter:null),this._cacheTimers[t.key]&&(clearTimeout(this._cacheTimers[t.key]),delete this._cacheTimers[t.key],this._setTileReloadTimer(t.key,n)));const r=!!n;if(!r){const o=this.map?this.map.painter:null;n=new Ya(t,this._source.tileSize*t.overscaleFactor(),this.transform.tileZoom,o,this._isRaster),this._loadTile(n,this._tileLoaded.bind(this,n,t.key,n.state))}return n?(n.uses++,this._tiles[t.key]=n,r||this._source.fire(new Mt("dataloading",{tile:n,coord:n.tileID,dataType:"source"})),n):null}_setTileReloadTimer(t,n){t in this._timers&&(clearTimeout(this._timers[t]),delete this._timers[t]);const r=n.getExpiryTimeout();r&&(this._timers[t]=setTimeout(()=>{this._reloadTile(t,"expired"),delete this._timers[t]},r))}_removeTile(t){const n=this._tiles[t];n&&(n.uses--,delete this._tiles[t],this._timers[t]&&(clearTimeout(this._timers[t]),delete this._timers[t]),n.uses>0||(n.hasData()&&"reloading"!==n.state?this._cache.add(n.tileID,n,n.getExpiryTimeout()):(n.aborted=!0,this._abortTile(n),this._unloadTile(n))))}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const t in this._tiles)this._removeTile(+t);this._source._clear&&this._source._clear(),this._cache.reset(),this.map&&this.usedForTerrain&&this.map.painter.terrain&&this.map.painter.terrain.resetTileLookupCache(this.id)}tilesIn(t,n,r){const o=[],s=this.transform;if(!s)return o;const c="globe"===s.projection.name,u=Br(s.center.lng);for(const d in this._tiles){const f=this._tiles[d];if(r&&f.clearQueryDebugViz(),f.holdingForFade())continue;let m;if(c){const g=f.tileID.canonical;if(0===g.z){const y=[Math.abs(ne(u,...yd(g,-1))-u),Math.abs(ne(u,...yd(g,1))-u)];m=[0,2*y.indexOf(Math.min(...y))-1]}else{const y=[Math.abs(ne(u,...yd(g,-1))-u),Math.abs(ne(u,...yd(g,0))-u),Math.abs(ne(u,...yd(g,1))-u)];m=[y.indexOf(Math.min(...y))-1]}}else m=[0];for(const g of m){const y=t.containsTile(f,s,n,g);y&&o.push(y)}}return o}getShadowCasterCoordinates(){return this._getRenderableCoordinates(!1,!0)}getVisibleCoordinates(t){return this._getRenderableCoordinates(t)}_getRenderableCoordinates(t,n){const r=this.getRenderableIds(t,n).map(s=>this._tiles[s].tileID),o="globe"===this.transform.projection.name;for(const s of r)s.projMatrix=this.transform.calculateProjMatrix(s.toUnwrapped()),s.expandedProjMatrix=o?this.transform.calculateProjMatrix(s.toUnwrapped(),!1,!0):s.projMatrix;return r}sortCoordinatesByDistance(t){const n=t.slice(),r=this.transform._camera.position,o=this.transform._camera.forward(),s={};for(const c of n){const u=1/(1<<c.canonical.z);s[c.key]=((c.canonical.x+.5)*u+c.wrap-r[0])*o[0]+((c.canonical.y+.5)*u-r[1])*o[1]-r[2]*o[2]}return n.sort((c,u)=>s[c.key]-s[u.key]),n}hasTransition(){if(this._source.hasTransition())return!0;if(bg(this._source.type))for(const t in this._tiles){const n=this._tiles[t];if(void 0!==n.fadeEndTime&&n.fadeEndTime>=De.now())return!0}return!1}setFeatureState(t,n,r){this._state.updateState(t=t||"_geojsonTileLayer",n,r)}removeFeatureState(t,n,r){this._state.removeFeatureState(t=t||"_geojsonTileLayer",n,r)}getFeatureState(t,n){return this._state.getState(t=t||"_geojsonTileLayer",n)}setDependencies(t,n,r){const o=this._tiles[t];o&&o.setDependencies(n,r)}reloadTilesForDependencies(t,n){for(const r in this._tiles)this._tiles[r].hasDependency(t,n)&&this._reloadTile(+r,"reloading");this._cache.filter(r=>!r.hasDependency(t,n))}_preloadTiles(t,n){if(!this._sourceLoaded){const u=()=>{this._sourceLoaded&&(this._source.off("data",u),this._preloadTiles(t,n))};return void this._source.on("data",u)}const r=new Map,o=Array.isArray(t)?t:[t],s=this.map.painter.terrain,c=this.usedForTerrain&&s?s.getScaledDemTileSize():this._source.tileSize;for(const u of o){const d=u.coveringTiles({tileSize:c,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!this.usedForTerrain,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain});for(const f of d)r.set(f.key,f);this.usedForTerrain&&u.updateElevation(!1)}mo(Array.from(r.values()),(u,d)=>{const f=new Ya(u,this._source.tileSize*u.overscaleFactor(),this.transform.tileZoom,this.map.painter,this._isRaster);this._loadTile(f,m=>{"raster-dem"===this._source.type&&f.dem&&this._backfillDEM(f),d(m,f)})},n)}}function tw(e,t){const n=Math.abs(2*e.wrap)-+(e.wrap<0),r=Math.abs(2*t.wrap)-+(t.wrap<0);return e.overscaledZ-t.overscaledZ||r-n||t.canonical.y-e.canonical.y||t.canonical.x-e.canonical.x}function bg(e){return"raster"===e||"image"===e||"video"===e||"custom"===e}function yd(e,t){const n=1<<e.z;return[e.x/n+t,(e.x+1)/n+t]}ha.maxOverzooming=10,ha.maxUnderzooming=3;const OI=Ce([{name:"a_pos_3f",components:3,type:"Float32"}]),kI=Ce([{name:"a_color_3f",components:3,type:"Float32"}]),FI=Ce([{name:"a_color_4f",components:4,type:"Float32"}]),NI=Ce([{name:"a_uv_2f",components:2,type:"Float32"}]),ew=Ce([{name:"a_normal_3f",components:3,type:"Float32"}]),h0=Ce([{name:"a_normal_matrix0",components:4,type:"Float32"},{name:"a_normal_matrix1",components:4,type:"Float32"},{name:"a_normal_matrix2",components:4,type:"Float32"},{name:"a_normal_matrix3",components:4,type:"Float32"}]),zI=Ce([{name:"a_pbr",components:4,type:"Uint16"},{name:"a_heightBasedEmissiveStrength",components:3,type:"Float32"}]);class vd{constructor(t=0,n=0,r=0,o=0){if(isNaN(t)||t<0||isNaN(n)||n<0||isNaN(r)||r<0||isNaN(o)||o<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=t,this.bottom=n,this.left=r,this.right=o}interpolate(t,n,r){return null!=n.top&&null!=t.top&&(this.top=le(t.top,n.top,r)),null!=n.bottom&&null!=t.bottom&&(this.bottom=le(t.bottom,n.bottom,r)),null!=n.left&&null!=t.left&&(this.left=le(t.left,n.left,r)),null!=n.right&&null!=t.right&&(this.right=le(t.right,n.right,r)),this}getCenter(t,n){const r=ne((this.left+t-this.right)/2,0,t),o=ne((this.top+n-this.bottom)/2,0,n);return new it(r,o)}equals(t){return this.top===t.top&&this.bottom===t.bottom&&this.left===t.left&&this.right===t.right}clone(){return new vd(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}function dp(e,t){const n=nr(e,3);st.fromQuat(e,t),Lr(e,3,n)}function xd(e,t){const n=ki.identity([]);return ki.rotateZ(n,n,-t),ki.rotateX(n,n,-e),n}function d0(e,t){const n=[e[0],e[1],0],r=[t[0],t[1],0];if(Z.length(n)>=1e-15){const c=Z.normalize([],n);Z.scale(r,c,Z.dot(r,c)),t[0]=r[0],t[1]=r[1]}const o=Z.cross([],t,e);if(Z.len(o)<1e-15)return null;const s=Math.atan2(-o[1],o[0]);return xd(Math.atan2(Math.sqrt(e[0]*e[0]+e[1]*e[1]),-e[2]),s)}class nw{constructor(t,n){this.position=t,this.orientation=n}get position(){return this._position}set position(t){if(t){const n=t instanceof Qe?t:new Qe(t[0],t[1],t[2]);this._renderWorldCopies&&(n.x=Rr(n.x,0,1)),this._position=n}else this._position=null}lookAtPoint(t,n){if(this.orientation=null,!this.position)return;const r=this.position,o=this._elevation?this._elevation.getAtPointOrZero(Qe.fromLngLat(t)):0,s=Qe.fromLngLat(t,o),c=[s.x-r.x,s.y-r.y,s.z-r.z];n||(n=[0,0,1]),n[2]=Math.abs(n[2]),this.orientation=d0(c,n)}setPitchBearing(t,n){this.orientation=xd(Oe(t),Oe(-n))}}class wg{constructor(t,n){this._transform=st.identity([]),this.orientation=n,this.position=t}get mercatorPosition(){const t=this.position;return new Qe(t[0],t[1],t[2])}get position(){const t=nr(this._transform,3);return[t[0],t[1],t[2]]}set position(t){var n;t&&Lr(this._transform,3,[(n=t)[0],n[1],n[2],1])}get orientation(){return this._orientation}set orientation(t){this._orientation=t||ki.identity([]),t&&dp(this._transform,this._orientation)}getPitchBearing(){const t=this.forward(),n=this.right();return{bearing:Math.atan2(-n[1],n[0]),pitch:Math.atan2(Math.sqrt(t[0]*t[0]+t[1]*t[1]),-t[2])}}setPitchBearing(t,n){this._orientation=xd(t,n),dp(this._transform,this._orientation)}forward(){const t=nr(this._transform,2);return[-t[0],-t[1],-t[2]]}up(){const t=nr(this._transform,1);return[-t[0],-t[1],-t[2]]}right(){const t=nr(this._transform,0);return[t[0],t[1],t[2]]}getCameraToWorld(t,n){const r=new Float64Array(16);return st.invert(r,this.getWorldToCamera(t,n)),r}getCameraToWorldMercator(){return this._transform}getWorldToCameraPosition(t,n,r){const o=this.position;Z.scale(o,o,-t);const s=new Float64Array(16);return st.fromScaling(s,[r,r,r]),st.translate(s,s,o),s[10]*=n,s}getWorldToCamera(t,n){const r=new Float64Array(16),o=new Float64Array(4),s=this.position;return ki.conjugate(o,this._orientation),Z.scale(s,s,-t),st.fromQuat(r,o),st.translate(r,r,s),r[1]*=-1,r[5]*=-1,r[9]*=-1,r[13]*=-1,r[8]*=n,r[9]*=n,r[10]*=n,r[11]*=n,r}getCameraToClipPerspective(t,n,r,o){const s=new Float64Array(16);return st.perspective(s,t,n,r,o),s}getCameraToClipOrthographic(t,n,r,o,s,c){const u=new Float64Array(16);return st.ortho(u,t,n,r,o,s,c),u}getDistanceToElevation(t,n=!1){const r=0===t?0:Ln(t,n?xr(this.position[1]):this.position[1]),o=this.forward();return(r-this.position[2])/o[2]}clone(){return new wg([...this.position],[...this.orientation])}}function rw(e,t){const n=zu(e.projection,e.zoom,e.width,e.height),r=function(s,c,u,d,f){const m=new Se(u.lng-180*Ol,u.lat),g=new Se(u.lng+180*Ol,u.lat),y=s.project(m.lng,m.lat),v=s.project(g.lng,g.lat),x=-Math.atan2(v.y-y.y,v.x-y.x),w=Qe.fromLngLat(u);w.y=ne(w.y,-1+Ol,1-Ol);const E=w.toLngLat(),M=s.project(E.lng,E.lat),D=Qe.fromLngLat(E);D.x+=Ol;const A=D.toLngLat(),P=s.project(A.lng,A.lat),C=iw(P.x-M.x,P.y-M.y,x),R=Qe.fromLngLat(E);R.y+=Ol;const k=R.toLngLat(),N=s.project(k.lng,k.lat),z=iw(N.x-M.x,N.y-M.y,x),B=Math.abs(C.x)/Math.abs(z.y),U=st.identity([]);st.rotateZ(U,U,-x*(1-(f?0:d)));const $=st.identity([]);return st.scale($,$,[1,1-(1-B)*d,1]),$[4]=-z.x/z.y*d,st.rotateZ($,$,x),st.multiply($,U,$),$}(e.projection,0,e.center,n,t),o=Eg(e);return st.scale(r,r,[o,o,1]),r}function Eg(e){const t=e.projection,n=zu(e.projection,e.zoom,e.width,e.height),r=f0(t,e.center),o=f0(t,Se.convert(t.center));return Math.pow(2,r*n+(1-n)*o)}function zu(e,t,n,r,o=1/0){const s=e.range;if(!s)return 0;const c=Math.min(o,Math.max(n,r)),u=Math.log(c/1024)/Math.LN2;return Ro(s[0]+u,s[1]+u,t)}const Ol=1/4e4;function f0(e,t){const n=ne(t.lat,-Ar,Ar),r=new Se(t.lng-180*Ol,n),o=new Se(t.lng+180*Ol,n),s=e.project(r.lng,n),c=e.project(o.lng,n),u=Qe.fromLngLat(r),d=Qe.fromLngLat(o),f=c.x-s.x,m=c.y-s.y,g=d.x-u.x,y=d.y-u.y,v=Math.sqrt((g*g+y*y)/(f*f+m*m));return Math.log(v)/Math.LN2}function iw(e,t,n){const r=Math.cos(n),o=Math.sin(n);return{x:e*r-t*o,y:e*o+t*r}}function Bu(e,t,n){return t*(et/(e.tileSize*Math.pow(2,n-e.tileID.overscaledZ)))}const bd={unknown:0,flipRequired:1,flipNotRequired:2},p0=Math.tan(85*Math.PI/180);function fp(e,t,n,r,o,s,c){const u=st.create();if(n)if("globe"===s.name){const d=function(f,m){const{x:g,y}=f.point,v=k1(g,y,f.worldSize/f._pixelsPerMercatorPixel,0,0);return st.multiply(v,v,km(bs(m)))}(o,t);st.multiply(u,u,d)}else{const d=Nh.invert([],c);u[0]=d[0],u[1]=d[1],u[4]=d[2],u[5]=d[3],r||st.rotateZ(u,u,o.angle)}else st.multiply(u,o.labelPlaneMatrix,e);return u}function m0(e,t,n,r,o,s,c){const u=fp(e,t,n,r,o,s,c);return"globe"===s.name&&n||(u[2]=u[6]=u[10]=u[14]=0),u}function g0(e,t,n,r,o,s,c){if(n){if("globe"===s.name){const u=fp(e,t,n,r,o,s,c);return st.invert(u,u),st.multiply(u,e,u),u}{const u=st.clone(e),d=st.identity([]);return d[0]=c[0],d[1]=c[1],d[4]=c[2],d[5]=c[3],st.multiply(u,u,d),r||st.rotateZ(u,u,-o.angle),u}}return o.glCoordMatrix}function da(e,t,n,r){const o=[e,t,n,1];n?En.transformMat4(o,o,r):v0(o,o,r);const s=o[3];return o[0]/=s,o[1]/=s,o[2]/=s,o}function _0(e,t){return Math.min(.5+e/t*.5,1.5)}function ow(e,t){const n=e[0]/e[3],r=e[1]/e[3];return n>=-t[0]&&n<=t[0]&&r>=-t[1]&&r<=t[1]}function sw(e,t,n,r,o,s,c,u,d,f){const m=n.transform,g=r?e.textSizeData:e.iconSizeData,y=qa(g,n.transform.zoom),v="globe"===m.projection.name,x=[256/n.width*2+1,256/n.height*2+1],w=r?e.text.dynamicLayoutVertexArray:e.icon.dynamicLayoutVertexArray;w.clear();let E=null;v&&(E=r?e.text.globeExtVertexArray:e.icon.globeExtVertexArray);const M=e.lineVertexArray,D=r?e.text.placedSymbolArray:e.icon.placedSymbolArray,A=n.transform.width/n.transform.height;let P,C=!1;for(let R=0;R<D.length;R++){const k=D.get(R),{numGlyphs:N,writingMode:z}=k;if(z!==er.vertical||C||P===er.horizontal||(C=!0),P=z,(k.hidden||z===er.vertical)&&!C){ju(N,w);continue}C=!1;const B=new it(k.tileAnchorX,k.tileAnchorY);let{x:U,y:$,z:W}=m.projection.projectTilePoint(B.x,B.y,f.canonical);if(d){const[_t,vt,xt]=d(B);U+=_t,$+=vt,W+=xt}const V=[U,$,W,1];if(En.transformMat4(V,V,t),!ow(V,x)){ju(N,w);continue}const K=V[3],Q=_0(n.transform.getCameraToCenterDistance(m.projection),K),ot=Yh(g,y,k),Y=c?ot/Q:ot*Q,J=da(U,$,W,o);if(J[3]<=0){ju(N,w);continue}let ct={};const dt=c?null:d,ht=cw(k,Y,!1,u,t,o,s,e.glyphOffsetArray,M,w,E,J,B,ct,A,dt,m.projection,f,c);C=ht.useVertical,dt&&ht.needsFlipping&&(ct={}),(ht.notEnoughRoom||C||ht.needsFlipping&&cw(k,Y,!0,u,t,o,s,e.glyphOffsetArray,M,w,E,J,B,ct,A,dt,m.projection,f,c).notEnoughRoom)&&ju(N,w)}r?(e.text.dynamicLayoutVertexBuffer.updateData(w),E&&e.text.globeExtVertexBuffer&&e.text.globeExtVertexBuffer.updateData(E)):(e.icon.dynamicLayoutVertexBuffer.updateData(w),E&&e.icon.globeExtVertexBuffer&&e.icon.globeExtVertexBuffer.updateData(E))}function aw(e,t,n,r,o,s,c,u,d,f,m,g,y,v,x,w){const{lineStartIndex:E,glyphStartIndex:M,segment:D}=u,A=M+u.numGlyphs,P=E+u.lineLength,C=t.getoffsetX(M),R=t.getoffsetX(A-1),k=wd(e*C,n,r,o,s,c,D,E,P,d,f,m,g,y,!0,v,x,w);if(!k)return null;const N=wd(e*R,n,r,o,s,c,D,E,P,d,f,m,g,y,!0,v,x,w);return N?{first:k,last:N}:null}function lw(e,t,n,r){return e===er.horizontal&&Math.abs(r)>Math.abs(n)?{useVertical:!0}:e===er.vertical?r>0?{needsFlipping:!0}:null:t!==bd.unknown&&(0===(o=n)||Math.abs(r/o)>p0)?t===bd.flipRequired?{needsFlipping:!0}:null:n<0?{needsFlipping:!0}:null;var o}function cw(e,t,n,r,o,s,c,u,d,f,m,g,y,v,x,w,E,M,D){const A=t/24,P=e.lineOffsetX*A,C=e.lineOffsetY*A,{lineStartIndex:R,glyphStartIndex:k,numGlyphs:N,segment:z,writingMode:B,flipState:U}=e,$=R+e.lineLength,W=V=>{if(m){const[Y,J,ct]=V.up,dt=f.length;mg(m,dt+0,Y,J,ct),mg(m,dt+1,Y,J,ct),mg(m,dt+2,Y,J,ct),mg(m,dt+3,Y,J,ct)}const[K,Q,ot]=V.point;cd(f,K,Q,ot,V.angle)};if(N>1){const V=aw(A,u,P,C,n,g,y,e,d,s,v,w,!1,E,M,D);if(!V)return{notEnoughRoom:!0};if(r&&!n){let[K,Q,ot]=V.first.point,[Y,J,ct]=V.last.point;[K,Q]=da(K,Q,ot,c),[Y,J]=da(Y,J,ct,c);const dt=lw(B,U,(Y-K)*x,J-Q);if(e.flipState=dt&&dt.needsFlipping?bd.flipRequired:bd.flipNotRequired,dt)return dt}W(V.first);for(let K=k+1;K<k+N-1;K++){const Q=wd(A*u.getoffsetX(K),P,C,n,g,y,z,R,$,d,s,v,w,!1,!1,E,M,D);if(!Q)return f.length-=4*(K-k),{notEnoughRoom:!0};W(Q)}W(V.last)}else{if(r&&!n){const K=da(y.x,y.y,0,o),Q=R+z+1,ot=new it(d.getx(Q),d.gety(Q)),Y=da(ot.x,ot.y,0,o),J=Y[3]>0?Y:y0(y,ot,K,1,o,void 0,E,M.canonical),ct=lw(B,U,(J[0]-K[0])*x,J[1]-K[1]);if(e.flipState=ct&&ct.needsFlipping?bd.flipRequired:bd.flipNotRequired,ct)return ct}const V=wd(A*u.getoffsetX(k),P,C,n,g,y,z,R,$,d,s,v,w,!1,!1,E,M,D);if(!V)return{notEnoughRoom:!0};W(V)}return{}}function uw(e,t,n,r,o){const{x:s,y:c,z:u}=r.projectTilePoint(e.x,e.y,t);if(!o)return da(s,c,u,n);const[d,f,m]=o(e);return da(s+d,c+f,u+m,n)}function y0(e,t,n,r,o,s,c,u){const d=uw(e.sub(t)._unit()._add(e),u,o,c,s);return Z.sub(d,n,d),Z.normalize(d,d),Z.scaleAndAdd(d,n,d,r)}function wd(e,t,n,r,o,s,c,u,d,f,m,g,y,v,x,w,E,M){const D=r?e-t:e+t;let A=D>0?1:-1,P=0;r&&(A*=-1,P=Math.PI),A<0&&(P+=Math.PI);let C=u+c+(A>0?0:1)|0,R=o,k=o,N=0,z=0;const B=Math.abs(D),U=[],$=[];let W=s,V=W;const K=()=>y0(V,W,k,B-N+1,m,y,w,E.canonical);for(;N+z<=B;){if(C+=A,C<u||C>=d)return null;if(k=R,V=W,U.push(k),v&&$.push(V),W=new it(f.getx(C),f.gety(C)),R=g[C],!R){const vt=uw(W,E.canonical,m,w,y);R=vt[3]>0?g[C]=vt:K()}N+=z,z=Z.distance(k,R)}x&&y&&(g[C]&&(R=K(),z=Z.distance(k,R)),g[C]=R);const Q=(B-N)/z,ot=W.sub(V)._mult(Q)._add(V),Y=Z.sub([],R,k),J=Z.scaleAndAdd([],k,Y,Q);let ct=[0,0,1],dt=Y[0],ht=Y[1];if(M&&(ct=w.upVector(E.canonical,ot.x,ot.y),0!==ct[0]||0!==ct[1]||1!==ct[2])){const vt=[ct[2],0,-ct[0]],xt=Z.cross([],ct,vt);Z.normalize(vt,vt),Z.normalize(xt,xt),dt=Z.dot(Y,vt),ht=Z.dot(Y,xt)}if(n){const vt=Z.cross([],ct,Y);Z.normalize(vt,vt),Z.scaleAndAdd(J,J,vt,n*A)}const _t=P+Math.atan2(ht,dt);return U.push(J),v&&$.push(ot),{point:J,angle:_t,path:U,tilePath:$,up:ct}}function ju(e,t){const n=t.length,r=n+4*e;t.resize(r),t.float32.fill(-1/0,4*n,4*r)}function v0(e,t,n){const r=t[0],o=t[1];return e[0]=n[0]*r+n[4]*o+n[12],e[1]=n[1]*r+n[5]*o+n[13],e[3]=n[3]*r+n[7]*o+n[15],e}const x0=(e,t,n)=>(1-n)*e+n*t,b0=e=>e*e*e*e*e;class Tg{constructor(t,n,r,o,s,c,u){this.tileSize=512,this._renderWorldCopies=void 0===s||s,this._minZoom=t||0,this._maxZoom=n||22,this._minPitch=r??0,this._maxPitch=o??60,this.setProjection(c),this.setMaxBounds(u),this.width=0,this.height=0,this._center=new Se(0,0),this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._nearZ=0,this._farZ=0,this._unmodified=!0,this._edgeInsets=new vd,this._projMatrixCache={},this._alignedProjMatrixCache={},this._fogTileMatrixCache={},this._expandedProjMatrixCache={},this._distanceTileDataCache={},this._camera=new wg,this._centerAltitude=0,this._averageElevation=0,this.cameraElevationReference="ground",this._pixelsPerMercatorPixel=1,this.globeRadius=0,this.globeCenterInViewSpace=[0,0,0],this._horizonShift=.1,this._orthographicProjectionAtLowPitch=!1}clone(){const t=new Tg(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies,this.getProjection());return t._elevation=this._elevation,t._centerAltitude=this._centerAltitude,t._centerAltitudeValidForExaggeration=this._centerAltitudeValidForExaggeration,t.tileSize=this.tileSize,t.mercatorFromTransition=this.mercatorFromTransition,t.width=this.width,t.height=this.height,t.cameraElevationReference=this.cameraElevationReference,t._center=this._center,t._setZoom(this.zoom),t._seaLevelZoom=this._seaLevelZoom,t.angle=this.angle,t._fov=this._fov,t._pitch=this._pitch,t._nearZ=this._nearZ,t._farZ=this._farZ,t._averageElevation=this._averageElevation,t._orthographicProjectionAtLowPitch=this._orthographicProjectionAtLowPitch,t._unmodified=this._unmodified,t._edgeInsets=this._edgeInsets.clone(),t._camera=this._camera.clone(),t._calcMatrices(),t.freezeTileCoverage=this.freezeTileCoverage,t.frustumCorners=this.frustumCorners,t}get isOrthographic(){return"globe"!==this.projection.name&&this._orthographicProjectionAtLowPitch&&this.pitch<15}get elevation(){return this._elevation}set elevation(t){this._elevation!==t&&(this._elevation=t,this._updateCameraOnTerrain(),this._calcMatrices())}get depthOcclusionForSymbolsAndCircles(){return"globe"!==this.projection.name&&!this.isOrthographic}updateElevation(t,n=!1){const r=this._elevation&&this._elevation.exaggeration()!==this._centerAltitudeValidForExaggeration;(null==this._seaLevelZoom||r)&&this._updateCameraOnTerrain(),(t||r)&&this._constrainCamera(n),this._calcMatrices()}getProjection(){return to(this.projection,["name","center","parallels"])}setProjection(t){this.projectionOptions=t||{name:"mercator"};const n=this.projection?this.getProjection():void 0;this.projection=dg(this.projectionOptions);const r=!tn(n,this.getProjection());return r&&this._calcMatrices(),this.mercatorFromTransition=!1,r}setOrthographicProjectionAtLowPitch(t){return this._orthographicProjectionAtLowPitch!==t&&(this._orthographicProjectionAtLowPitch=t,this._calcMatrices(),!0)}setMercatorFromTransition(){const t=this.projection.name;this.mercatorFromTransition=!0,this.projectionOptions={name:"mercator"},this.projection=dg({name:"mercator"});const n=t!==this.projection.name;return n&&this._calcMatrices(),n}get minZoom(){return this._minZoom}set minZoom(t){this._minZoom!==t&&(this._minZoom=t,this.zoom=Math.max(this.zoom,t))}get maxZoom(){return this._maxZoom}set maxZoom(t){this._maxZoom!==t&&(this._maxZoom=t,this.zoom=Math.min(this.zoom,t))}get minPitch(){return this._minPitch}set minPitch(t){this._minPitch!==t&&(this._minPitch=t,this.pitch=Math.max(this.pitch,t))}get maxPitch(){return this._maxPitch}set maxPitch(t){this._maxPitch!==t&&(this._maxPitch=t,this.pitch=Math.min(this.pitch,t))}get renderWorldCopies(){return this._renderWorldCopies&&!0===this.projection.supportsWorldCopies}set renderWorldCopies(t){void 0===t?t=!0:null===t&&(t=!1),this._renderWorldCopies=t}get worldSize(){return this.tileSize*this.scale}get cameraWorldSizeForFog(){const t=Math.max(this._camera.getDistanceToElevation(this._averageElevation),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(t))}get cameraWorldSize(){const t=Math.max(this._camera.getDistanceToElevation(this._averageElevation,!0),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(t))}get pixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.worldSize)}get cameraPixelsPerMeter(){return Ln(1,this.center.lat)*this.cameraWorldSizeForFog}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new it(this.width,this.height)}get bearing(){return Rr(this.rotation,-180,180)}set bearing(t){this.rotation=t}get rotation(){return-this.angle/Math.PI*180}set rotation(t){const n=-t*Math.PI/180;this.angle!==n&&(this._unmodified=!1,this.angle=n,this._calcMatrices(),this.rotationMatrix=Nh.create(),Nh.rotate(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(t){const n=ne(t,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==n&&(this._unmodified=!1,this._pitch=n,this._calcMatrices())}get aspect(){return this.width/this.height}get fov(){return this._fov/Math.PI*180}get fovX(){return this._fov}get fovY(){const t=1/Math.tan(.5*this.fovX);return 2*Math.atan(1/this.aspect/t)}set fov(t){t=Math.max(.01,Math.min(60,t)),this._fov!==t&&(this._unmodified=!1,this._fov=Oe(t),this._calcMatrices())}get averageElevation(){return this._averageElevation}set averageElevation(t){this._averageElevation=t,this._calcFogMatrices(),this._distanceTileDataCache={}}get zoom(){return this._zoom}set zoom(t){const n=Math.min(Math.max(t,this.minZoom),this.maxZoom);this._zoom!==n&&(this._unmodified=!1,this._setZoom(n),this._updateSeaLevelZoom(),this._constrain(),this._calcMatrices())}_setZoom(t){this._zoom=t,this.scale=this.zoomScale(t),this.tileZoom=Math.floor(t),this.zoomFraction=t-this.tileZoom}_updateCameraOnTerrain(){const t=this.elevation?this.elevation.getAtPoint(this.locationCoordinate(this.center),Number.NEGATIVE_INFINITY):Number.NEGATIVE_INFINITY,n=this.elevation&&t===Number.NEGATIVE_INFINITY&&this.elevation.visibleDemTiles.length>0&&this.elevation.exaggeration()>0&&this._centerAltitudeValidForExaggeration;if(!this._elevation||t===Number.NEGATIVE_INFINITY&&(!n||!this._centerAltitude))return this._centerAltitude=0,this._seaLevelZoom=null,void(this._centerAltitudeValidForExaggeration=void 0);const r=this._elevation;n||this._centerAltitude&&this._centerAltitudeValidForExaggeration&&r.exaggeration()&&this._centerAltitudeValidForExaggeration!==r.exaggeration()?(this._centerAltitude=this._centerAltitude/this._centerAltitudeValidForExaggeration*r.exaggeration(),this._centerAltitudeValidForExaggeration=r.exaggeration()):(this._centerAltitude=t||0,this._centerAltitudeValidForExaggeration=r.exaggeration()),this._updateSeaLevelZoom()}_updateSeaLevelZoom(){void 0!==this._centerAltitudeValidForExaggeration&&(this._seaLevelZoom=this._zoomFromMercatorZ((this.pixelsPerMeter*this._centerAltitude+this.cameraToCenterDistance)/this.worldSize))}sampleAverageElevation(){if(!this._elevation)return 0;const t=this._elevation,n=[[.5,.2],[.3,.5],[.5,.5],[.7,.5],[.5,.8]],r=this.horizonLineFromTop();let o=0,s=0;for(let c=0;c<n.length;c++){const u=new it(n[c][0]*this.width,r+n[c][1]*(this.height-r)),d=t.pointCoordinate(u);if(!d)continue;const f=1/Math.hypot(d[0]-this._camera.position[0],d[1]-this._camera.position[1]);o+=d[3]*f,s+=f}return 0===s?NaN:o/s}get center(){return this._center}set center(t){t.lat===this._center.lat&&t.lng===this._center.lng||(this._unmodified=!1,this._center=t,this._terrainEnabled()&&("ground"===this.cameraElevationReference?this._updateCameraOnTerrain():this._updateZoomFromElevation()),this._constrain(),this._calcMatrices())}_updateZoomFromElevation(){if(null==this._seaLevelZoom||!this._elevation)return;const t=this._seaLevelZoom,n=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center)),r=this.pixelsPerMeter/this.worldSize*n,o=this._mercatorZfromZoom(t),s=this._mercatorZfromZoom(this._maxZoom),c=Math.max(o-r,s);this._setZoom(this._zoomFromMercatorZ(c))}get padding(){return this._edgeInsets.toJSON()}set padding(t){this._edgeInsets.equals(t)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,t,1),this._calcMatrices())}computeZoomRelativeTo(t){const n=this.rayIntersectionCoordinate(this.pointRayIntersection(this.centerPoint,t.toAltitude()));let r;r=t.z<this._camera.position[2]?[n.x,n.y,n.z]:[t.x,t.y,t.z];const o=Z.length(Z.sub([],this._camera.position,r));return ne(this._zoomFromMercatorZ(o),this._minZoom,this._maxZoom)}setFreeCameraOptions(t){if(!this.height||!t.position&&!t.orientation)return;this._updateCameraState();let n=!1;if(t.orientation&&!ki.exactEquals(t.orientation,this._camera.orientation)&&(n=this._setCameraOrientation(t.orientation)),t.position){const r=[t.position.x,t.position.y,t.position.z];Z.exactEquals(r,this._camera.position)||(this._setCameraPosition(r),n=!0)}n&&(this._updateStateFromCamera(),this.recenterOnTerrain())}getFreeCameraOptions(){this._updateCameraState();const t=this._camera.position,n=new nw;return n.position=new Qe(t[0],t[1],t[2]),n.orientation=this._camera.orientation,n._elevation=this.elevation,n._renderWorldCopies=this.renderWorldCopies,n}_setCameraOrientation(t){if(!ki.length(t))return!1;ki.normalize(t,t);const n=Z.transformQuat([],[0,0,-1],t),r=Z.transformQuat([],[0,-1,0],t);if(r[2]<0)return!1;const o=d0(n,r);return!!o&&(this._camera.orientation=o,!0)}_setCameraPosition(t){const n=this.zoomScale(this.minZoom)*this.tileSize,r=this.zoomScale(this.maxZoom)*this.tileSize,o=this.cameraToCenterDistance;t[2]=ne(t[2],o/r,o/n),this._camera.position=t}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}get fovAboveCenter(){return this._fov*(.5+this.centerOffset.y/this.height)}isPaddingEqual(t){return this._edgeInsets.equals(t)}interpolatePadding(t,n,r){this._unmodified=!1,this._edgeInsets.interpolate(t,n,r),this._constrain(),this._calcMatrices()}coveringZoomLevel(t){const n=(t.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/t.tileSize));return Math.max(0,n)}getVisibleUnwrappedCoordinates(t){const n=[new Of(0,t)];if(this.renderWorldCopies){const r=this.pointCoordinate(new it(0,0)),o=this.pointCoordinate(new it(this.width,0)),s=this.pointCoordinate(new it(this.width,this.height)),c=this.pointCoordinate(new it(0,this.height)),u=Math.floor(Math.min(r.x,o.x,s.x,c.x)),d=Math.floor(Math.max(r.x,o.x,s.x,c.x)),f=1;for(let m=u-f;m<=d+f;m++)0!==m&&n.push(new Of(m,t))}return n}isLODDisabled(t){return(!t||this.pitch<=60)&&this._edgeInsets.top<=this._edgeInsets.bottom&&!this._elevation&&!this.projection.isReprojectedInTileSpace}extendTileCoverForShadows(t,n,r){let o=[];if(0===n[0]&&0===n[1])return o;for(const c of t){const u=c.canonical,d=c.overscaledZ,f=c.wrap,m=1<<u.z,g=u.x+1<m,y=u.x>0,v=u.y+1<m,x=u.y>0,w=c.wrap-(y?0:1),E=c.wrap+(g?0:1),M=y?u.x-1:m-1,D=g?u.x+1:0;n[0]<0?(o.push(new nn(d,E,u.z,D,u.y)),n[1]<0&&v&&(o.push(new nn(d,f,u.z,u.x,u.y+1)),o.push(new nn(d,E,u.z,D,u.y+1))),n[1]>0&&x&&(o.push(new nn(d,f,u.z,u.x,u.y-1)),o.push(new nn(d,E,u.z,D,u.y-1)))):n[0]>0?(o.push(new nn(d,w,u.z,M,u.y)),n[1]<0&&v&&(o.push(new nn(d,f,u.z,u.x,u.y+1)),o.push(new nn(d,w,u.z,M,u.y+1))),n[1]>0&&x&&(o.push(new nn(d,f,u.z,u.x,u.y-1)),o.push(new nn(d,w,u.z,M,u.y-1)))):n[1]<0&&v?o.push(new nn(d,f,u.z,u.x,u.y+1)):x&&o.push(new nn(d,f,u.z,u.x,u.y-1))}if(o.length>1){o.sort((d,f)=>d.overscaledZ-f.overscaledZ||d.wrap-f.wrap||d.canonical.z-f.canonical.z||d.canonical.x-f.canonical.x||d.canonical.y-f.canonical.y);let c=0,u=0;for(;u<o.length;)o[u].equals(o[c])?++u:o[++c]=o[u++];o.length=c+1}const s=[];for(const c of o)o.some(u=>c.isChildOf(u))||s.push(c);return o=s.filter(c=>!t.some(u=>!!(c.overscaledZ<r&&u.isChildOf(c))||c.equals(u)||c.isChildOf(u))),o}coveringTiles(t){let n=this.coveringZoomLevel(t);const r=n,o=this.elevation&&this.elevation.exaggeration(),s=o&&!t.isTerrainDEM,c="mercator"===this.projection.name;if(void 0!==t.minzoom&&n<t.minzoom)return[];void 0!==t.maxzoom&&n>t.maxzoom&&(n=t.maxzoom);const u=this.locationCoordinate(this.center),d=this.center.lat,f=1<<n,m=[f*u.x,f*u.y,0],g="globe"===this.projection.name,y=!g,v=aa.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,n,y),x=g?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),w=f*Ln(1,this.center.lat),E=this._camera.position[2]/Ln(1,this.center.lat),M=[f*x.x,f*x.y,E*(y?1:w)],D=g||o,A=this.cameraToCenterDistance/t.tileSize*(t.roundZoom?1:.502),P=this.isLODDisabled(!0)?n:0;let C;if(this._elevation&&t.isTerrainDEM)C=1e4*this._elevation.exaggeration();else if(this._elevation){const Y=this._elevation.getMinMaxForVisibleTiles();C=Y?Y.max:this._centerAltitude}else C=this._centerAltitude;const R=t.isTerrainDEM?-C:this._elevation?this._elevation.getMinElevationBelowMSL():0,k=this.projection.isReprojectedInTileSpace?Eg(this):1,N=Y=>{const ct=new Qe(Y.x+25e-6,Y.y,Y.z),dt=new Qe(Y.x,Y.y+25e-6,Y.z),ht=Y.toLngLat(),_t=ct.toLngLat(),vt=dt.toLngLat(),xt=this.locationCoordinate(ht),mt=this.locationCoordinate(_t),Ct=this.locationCoordinate(vt),Ut=Math.hypot(mt.x-xt.x,mt.y-xt.y),Gt=Math.hypot(Ct.x-xt.x,Ct.y-xt.y);return Math.sqrt(Ut*Gt)*k/25e-6},z=Y=>{const J=C,ct=R;return{aabb:tp(this,f,0,0,0,Y,ct,J,this.projection),zoom:0,x:0,y:0,minZ:ct,maxZ:J,wrap:Y,fullyVisible:!1}},B=[];let U=[];const $=n,W=t.reparseOverscaled?r:n,V=Y=>Y*Y,K=V((E-this._centerAltitude)*w),Q=Y=>{if(!this._elevation||!Y.tileID||!c)return;const J=this._elevation.getMinMaxForTile(Y.tileID),ct=Y.aabb;J?(ct.min[2]=J.min,ct.max[2]=J.max,ct.center[2]=(ct.min[2]+ct.max[2])/2):(Y.shouldSplit=ot(Y),Y.shouldSplit||(ct.min[2]=ct.max[2]=ct.center[2]=this._centerAltitude))},ot=Y=>{if(Y.zoom<P)return!0;if(Y.zoom===$)return!1;if(null!=Y.shouldSplit)return Y.shouldSplit;const J=Y.aabb.distanceX(M),ct=Y.aabb.distanceY(M);let dt=K,ht=1;if(g){dt=V(Y.aabb.distanceZ(M));const xt=Math.pow(2,Y.zoom),mt=xr((Y.y+1)/xt),Ct=xr(Y.y/xt),Ut=Math.min(Math.max(d,mt),Ct),Gt=Vf(Ut)/Vf(d);if(ht=Ut===d?1/Math.max(1,this._mercatorScaleRatio-.3):Math.min(1,Gt/this._mercatorScaleRatio),this.zoom<=zf&&Y.zoom===$-1&&Gt>=.9)return!0}else if(s&&(dt=V(Y.aabb.distanceZ(M)*w)),this.projection.isReprojectedInTileSpace&&r<=5){const xt=Math.pow(2,Y.zoom),mt=N(new Qe((Y.x+.5)/xt,(Y.y+.5)/xt));ht=mt>.85?1:mt}const _t=J*J+ct*ct+dt;return _t<V((1<<$-Y.zoom)*A*ht*((xt,mt)=>{if(mt*V(.707)<xt)return 1;const Ct=Math.sqrt(mt/xt);return Ct/(1.4144271570014144+(Math.pow(1.1,Ct-1.4144271570014144+1)-1)/(1.1-1)-1)})(Math.max(dt,K),_t))};if(this.renderWorldCopies)for(let Y=1;Y<=3;Y++)B.push(z(-Y)),B.push(z(Y));for(B.push(z(0));B.length>0;){const Y=B.pop(),J=Y.x,ct=Y.y;let dt=Y.fullyVisible;const ht=()=>"globe"===this.projection.name&&(0===Y.y||Y.y===(1<<Y.zoom)-1);if(!dt){let _t=D?Y.aabb.intersects(v):Y.aabb.intersectsFlat(v);if(0===_t&&ht()){const vt=new xs(Y.zoom,J,ct);_t=cy(this,f,vt,!0).intersects(v)}if(0===_t)continue;dt=2===_t}if(Y.zoom!==$&&ot(Y))for(let _t=0;_t<4;_t++){const vt=(J<<1)+_t%2,xt=(ct<<1)+(_t>>1),mt={aabb:c?Y.aabb.quadrant(_t):tp(this,f,Y.zoom+1,vt,xt,Y.wrap,Y.minZ,Y.maxZ,this.projection),zoom:Y.zoom+1,x:vt,y:xt,wrap:Y.wrap,fullyVisible:dt,tileID:void 0,shouldSplit:void 0,minZ:Y.minZ,maxZ:Y.maxZ};s&&!g&&(mt.tileID=new nn(Y.zoom+1===$?W:Y.zoom+1,Y.wrap,Y.zoom+1,vt,xt),Q(mt)),B.push(mt)}else{const _t=Y.zoom===$?W:Y.zoom;if(t.minzoom&&t.minzoom>_t)continue;if(!dt){let Ct=D?Y.aabb.intersectsPrecise(v):Y.aabb.intersectsPreciseFlat(v);if(0===Ct&&ht()){const Ut=new xs(Y.zoom,J,ct);Ct=cy(this,f,Ut,!0).intersectsPrecise(v)}if(0===Ct)continue}const vt=m[0]-(.5+J+(Y.wrap<<Y.zoom))*(1<<n-Y.zoom),xt=m[1]-.5-ct,mt=Y.tileID?Y.tileID:new nn(_t,Y.wrap,Y.zoom,J,ct);U.push({tileID:mt,distanceSq:vt*vt+xt*xt})}}if(this.fogCullDistSq){const Y=this.fogCullDistSq,J=this.horizonLineFromTop();U=U.filter(ct=>{const dt=[0,0,0,1],ht=[et,et,0,1],_t=this.calculateFogTileMatrix(ct.tileID.toUnwrapped());En.transformMat4(dt,dt,_t),En.transformMat4(ht,ht,_t);const vt=function(Ct,Ut,Gt){let Yt=0;for(let te=0;te<2;++te)Ct[te]>0&&(Yt+=(Ct[te]-0)*(Ct[te]-0)),Ut[te]<0&&(Yt+=(0-Ut[te])*(0-Ut[te]));return Yt}(En.min([],dt,ht),En.max([],dt,ht));if(0===vt)return!0;let xt=!1;const mt=this._elevation;if(mt&&vt>Y&&0!==J){const Ct=this.calculateProjMatrix(ct.tileID.toUnwrapped());let Ut;t.isTerrainDEM||(Ut=mt.getMinMaxForTile(ct.tileID)),Ut||(Ut={min:R,max:C});const Gt=function(te){const Me=Math.round((te+45+360)%360/90)%4;return nh[Me]}(this.rotation),Yt=[Gt[0]*et,Gt[1]*et,Ut.max];Z.transformMat4(Yt,Yt,Ct),xt=(1-Yt[1])*this.height*.5<J}return vt<Y||xt})}return U.sort((Y,J)=>Y.distanceSq-J.distanceSq).map(Y=>Y.tileID)}resize(t,n){this.width=t,this.height=n,this.pixelsToGLUnits=[2/t,-2/n],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(t){return Math.pow(2,t)}scaleZoom(t){return Math.log(t)/Math.LN2}project(t){const n=ne(t.lat,-Ar,Ar),r=this.projection.project(t.lng,n);return new it(r.x*this.worldSize,r.y*this.worldSize)}unproject(t){return this.projection.unproject(t.x/this.worldSize,t.y/this.worldSize)}get point(){return this.project(this.center)}get pointMerc(){return this.point._div(this.worldSize)}get pixelsPerMeterRatio(){return this.pixelsPerMeter/Ln(1,this.center.lat)/this.worldSize}setLocationAtPoint(t,n){let r,o;const s=this.centerPoint;if("globe"===this.projection.name){const u=this.worldSize;r=(n.x-s.x)/u,o=(n.y-s.y)/u}else{const u=this.pointCoordinate(n),d=this.pointCoordinate(s);r=u.x-d.x,o=u.y-d.y}const c=this.locationCoordinate(t);this.setLocation(new Qe(c.x-r,c.y-o))}setLocation(t){this.center=this.coordinateLocation(t),this.projection.wrap&&(this.center=this.center.wrap())}locationPoint(t){return this.projection.locationPoint(this,t)}locationPoint3D(t){return this.projection.locationPoint(this,t,!0)}pointLocation(t){return this.coordinateLocation(this.pointCoordinate(t))}pointLocation3D(t){return this.coordinateLocation(this.pointCoordinate3D(t))}locationCoordinate(t,n){const r=n?Ln(n,t.lat):void 0,o=this.projection.project(t.lng,t.lat);return new Qe(o.x,o.y,r)}coordinateLocation(t){return this.projection.unproject(t.x,t.y)}pointRayIntersection(t,n){const r=n??this._centerAltitude,o=[t.x,t.y,0,1],s=[t.x,t.y,1,1];En.transformMat4(o,o,this.pixelMatrixInverse),En.transformMat4(s,s,this.pixelMatrixInverse);const c=s[3];En.scale(o,o,1/o[3]),En.scale(s,s,1/c);const u=o[2],d=s[2];return{p0:o,p1:s,t:u===d?0:(r-u)/(d-u)}}screenPointToMercatorRay(t){const n=[t.x,t.y,0,1],r=[t.x,t.y,1,1];return En.transformMat4(n,n,this.pixelMatrixInverse),En.transformMat4(r,r,this.pixelMatrixInverse),En.scale(n,n,1/n[3]),En.scale(r,r,1/r[3]),n[2]=Ln(n[2],this._center.lat)*this.worldSize,r[2]=Ln(r[2],this._center.lat)*this.worldSize,En.scale(n,n,1/this.worldSize),En.scale(r,r,1/this.worldSize),new Rm([n[0],n[1],n[2]],Z.normalize([],Z.sub([],r,n)))}rayIntersectionCoordinate(t){const{p0:n,p1:r,t:o}=t,s=Ln(n[2],this._center.lat),c=Ln(r[2],this._center.lat);return new Qe(le(n[0],r[0],o)/this.worldSize,le(n[1],r[1],o)/this.worldSize,le(s,c,o))}pointCoordinate(t,n=this._centerAltitude){return this.projection.pointCoordinate(this,t.x,t.y,n)}pointCoordinate3D(t){if(!this.elevation)return this.pointCoordinate(t);let n=this.projection.pointCoordinate3D(this,t.x,t.y);if(n)return new Qe(n[0],n[1],n[2]);let r=0,o=this.horizonLineFromTop();if(t.y>o)return this.pointCoordinate(t);const s=.02*o,c=t.clone();for(let u=0;u<10&&o-r>s;u++){c.y=le(r,o,.66);const d=this.projection.pointCoordinate3D(this,c.x,c.y);d?(o=c.y,n=d):r=c.y}return n?new Qe(n[0],n[1],n[2]):this.pointCoordinate(t)}isPointAboveHorizon(t){return this.projection.isPointAboveHorizon(this,t)}isPointOnSurface(t){if(t.y<0||t.y>this.height||t.x<0||t.x>this.width)return!1;if(this.elevation||this.zoom>=yc)return!this.isPointAboveHorizon(t);const n=this.pointCoordinate(t);return n.y>=0&&n.y<=1}_coordinatePoint(t,n){const r=n&&this.elevation?this.elevation.getAtPointOrZero(t,this._centerAltitude):this._centerAltitude,o=[t.x*this.worldSize,t.y*this.worldSize,r+t.toAltitude(),1];return En.transformMat4(o,o,this.pixelMatrix),o[3]>0?new it(o[0]/o[3],o[1]/o[3]):new it(Number.MAX_VALUE,Number.MAX_VALUE)}_getBoundsNonRectangular(){const{top:t,left:n}=this._edgeInsets,r=this.height-this._edgeInsets.bottom,o=this.width-this._edgeInsets.right,s=this.pointLocation3D(new it(n,t)),c=this.pointLocation3D(new it(o,t)),u=this.pointLocation3D(new it(o,r)),d=this.pointLocation3D(new it(n,r));let f=Math.min(s.lng,c.lng,u.lng,d.lng),m=Math.max(s.lng,c.lng,u.lng,d.lng),g=Math.min(s.lat,c.lat,u.lat,d.lat),y=Math.max(s.lat,c.lat,u.lat,d.lat);const v=Math.pow(2,-this.zoom)/16*270,x="globe"===this.projection.name?1:4,w=(E,M,D,A,P)=>{const C=(E+D)/2,R=(M+A)/2,k=new it(C,R),{lng:N,lat:z}=this.pointLocation3D(k),B=Math.max(0,f-N,g-z,N-m,z-y);f=Math.min(f,N),m=Math.max(m,N),g=Math.min(g,z),y=Math.max(y,z),(P<x||B>v)&&(w(E,M,C,R,P+1),w(C,R,D,A,P+1))};if(w(n,t,o,t,1),w(o,t,o,r,1),w(o,r,n,r,1),w(n,r,n,t,1),"globe"===this.projection.name){const[E,M]=function(D){const A=st.identity(new Float64Array(16));st.multiply(A,D.pixelMatrix,D.globeMatrix);const P=[0,Ji,0],C=[0,Mo,0];return Z.transformMat4(P,P,A),Z.transformMat4(C,C,A),[P[0]>0&&P[0]<=D.width&&P[1]>0&&P[1]<=D.height&&!py(D,new Se(D.center.lat,90)),C[0]>0&&C[0]<=D.width&&C[1]>0&&C[1]<=D.height&&!py(D,new Se(D.center.lat,-90))]}(this);E?(y=90,m=180,f=-180):M&&(g=-90,m=180,f=-180)}return new Oi(new Se(f,g),new Se(m,y))}_getBoundsRectangular(t,n){const{top:r,left:o}=this._edgeInsets,s=this.height-this._edgeInsets.bottom,c=this.width-this._edgeInsets.right,u=new it(o,r),d=new it(c,r),f=new it(c,s),m=new it(o,s);let g=this.pointCoordinate(u,t),y=this.pointCoordinate(d,t);const v=this.pointCoordinate(f,n),x=this.pointCoordinate(m,n),w=(E,M)=>(M.y-E.y)/(M.x-E.x);return g.y>1&&y.y>=0?g=new Qe((1-x.y)/w(x,g)+x.x,1):g.y<0&&y.y<=1&&(g=new Qe(-x.y/w(x,g)+x.x,0)),y.y>1&&g.y>=0?y=new Qe((1-v.y)/w(v,y)+v.x,1):y.y<0&&g.y<=1&&(y=new Qe(-v.y/w(v,y)+v.x,0)),(new Oi).extend(this.coordinateLocation(g)).extend(this.coordinateLocation(y)).extend(this.coordinateLocation(x)).extend(this.coordinateLocation(v))}_getBoundsRectangularTerrain(){const t=this.elevation;if(!t.visibleDemTiles.length||t.isUsingMockSource())return this._getBoundsRectangular(0,0);const n=t.visibleDemTiles.reduce((r,o)=>{if(o.dem){const s=o.dem.tree;r.min=Math.min(r.min,s.minimums[0]),r.max=Math.max(r.max,s.maximums[0])}return r},{min:Number.MAX_VALUE,max:0});return this._getBoundsRectangular(n.min*t.exaggeration(),n.max*t.exaggeration())}getBounds(){return"mercator"===this.projection.name||"equirectangular"===this.projection.name?this._terrainEnabled()?this._getBoundsRectangularTerrain():this._getBoundsRectangular(0,0):this._getBoundsNonRectangular()}horizonLineFromTop(t=!0){const n=this.height/2/Math.tan(this._fov/2)/Math.tan(Math.max(this._pitch,.1))-this.centerOffset.y,r=this.height/2-n*(1-this._horizonShift);return t?Math.max(0,r):r}getMaxBounds(){return this.maxBounds}setMaxBounds(t){this.maxBounds=t,this.minLat=-Ar,this.maxLat=Ar,this.minLng=-180,this.maxLng=180,t&&(this.minLat=t.getSouth(),this.maxLat=t.getNorth(),this.minLng=t.getWest(),this.maxLng=t.getEast(),this.maxLng<this.minLng&&(this.maxLng+=360)),this.worldMinX=Br(this.minLng)*this.tileSize,this.worldMaxX=Br(this.maxLng)*this.tileSize,this.worldMinY=ui(this.maxLat)*this.tileSize,this.worldMaxY=ui(this.minLat)*this.tileSize,this._constrain()}calculatePosMatrix(t,n){return this.projection.createTileMatrix(this,n,t)}calculateDistanceTileData(t){const n=t.key,r=this._distanceTileDataCache;if(r[n])return r[n];const o=t.canonical,s=1/this.height,c=this.cameraWorldSize,u=c/this.zoomScale(o.z),d=(o.x+Math.pow(2,o.z)*t.wrap)*u,f=o.y*u,m=this.point;m.x*=c/this.worldSize,m.y*=c/this.worldSize;const g=this.angle,y=Math.sin(-g),v=-Math.cos(-g);return r[n]={bearing:[y,v],center:[(m.x-d)*s,(m.y-f)*s],scale:u/et*s},r[n]}calculateFogTileMatrix(t){const n=t.key,r=this._fogTileMatrixCache;if(r[n])return r[n];const o=this.projection.createTileMatrix(this,this.cameraWorldSizeForFog,t);return st.multiply(o,this.worldToFogMatrix,o),r[n]=new Float32Array(o),r[n]}calculateProjMatrix(t,n=!1,r=!1){const o=t.key;let s;if(s=r?this._expandedProjMatrixCache:n?this._alignedProjMatrixCache:this._projMatrixCache,s[o])return s[o];const c=this.calculatePosMatrix(t,this.worldSize);let u;return u=this.projection.isReprojectedInTileSpace?this.mercatorMatrix:r?this.expandedFarZProjMatrix:n?this.alignedProjMatrix:this.projMatrix,st.multiply(c,u,c),s[o]=new Float32Array(c),s[o]}calculatePixelsToTileUnitsMatrix(t){const n=t.tileID.key,r=this._pixelsToTileUnitsCache;if(r[n])return r[n];const o=function(s,c){const{scale:u}=s.tileTransform,d=u*et/(s.tileSize*Math.pow(2,c.zoom-s.tileID.overscaledZ+s.tileID.canonical.z));return Nh.scale(new Float32Array(4),c.inverseAdjustmentMatrix,[d,d])}(t,this);return r[n]=o,r[n]}customLayerMatrix(){return this.mercatorMatrix.slice()}globeToMercatorMatrix(){if("globe"===this.projection.name){const t=1/this.worldSize,n=st.fromScaling([],[t,t,t]);return st.multiply(n,n,this.globeMatrix),n}}recenterOnTerrain(){if(!this._elevation||"globe"===this.projection.name)return;const t=this._elevation;this._updateCameraState();const n=Ln(1,this._center.lat)*this.worldSize,r=this._computeCameraPosition(n),o=this._camera.forward(),s=Ln(1,this._center.lat);r[2]/=s,o[2]/=s,Z.normalize(o,o);const c=t.raycast(r,o,t.exaggeration());if(c){const u=Z.scaleAndAdd([],r,o,c),d=new Qe(u[0],u[1],Ln(u[2],xr(u[1]))),f=(d.z+Z.length([d.x-r[0],d.y-r[1],d.z-r[2]*s]))*this._pixelsPerMercatorPixel;this._seaLevelZoom=this._zoomFromMercatorZ(f),this._centerAltitude=d.toAltitude(),this._center=this.coordinateLocation(d),this._updateZoomFromElevation(),this._constrain(),this._calcMatrices()}}_constrainCamera(t=!1){if(!this._elevation)return;const n=this._elevation,r=Ln(1,this._center.lat)*this.worldSize,o=this._computeCameraPosition(r),s=n.getAtPointOrZero(new Qe(...o)),c=this.pixelsPerMeter/this.worldSize*s,u=this._minimumHeightOverTerrain(),d=o[2]-c;if(d<=u)if(d<0||t){const f=this.locationCoordinate(this._center,this._centerAltitude),m=[o[0],o[1],f.z-o[2]],g=Z.length(m);m[2]-=(u-d)/this._pixelsPerMercatorPixel;const y=Z.length(m);if(0===y)return;Z.scale(m,m,g/y*this._pixelsPerMercatorPixel),this._camera.position=[o[0],o[1],f.z*this._pixelsPerMercatorPixel-m[2]],this._updateStateFromCamera()}else this._isCameraConstrained=!0}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;const t="globe"===this.projection.name||this.mercatorFromTransition;if(this.projection.isReprojectedInTileSpace||t){const y=this.center;return y.lat=ne(y.lat,this.minLat,this.maxLat),(this.maxBounds||!this.renderWorldCopies&&!t)&&(y.lng=ne(y.lng,this.minLng,this.maxLng)),this.center=y,void(this._constraining=!1)}const n=this._unmodified,{x:r,y:o}=this.point;let s=0,c=r,u=o;const d=this.width/2,f=this.height/2,m=this.worldMinY*this.scale,g=this.worldMaxY*this.scale;if(o-f<m&&(u=m+f),o+f>g&&(u=g-f),g-m<this.height&&(s=Math.max(s,this.height/(g-m)),u=(g+m)/2),this.maxBounds||!this._renderWorldCopies||!this.projection.wrap){const y=this.worldMinX*this.scale,v=this.worldMaxX*this.scale,x=this.worldSize/2-(y+v)/2;c=(r+x+this.worldSize)%this.worldSize-x,c-d<y&&(c=y+d),c+d>v&&(c=v-d),v-y<this.width&&(s=Math.max(s,this.width/(v-y)),c=(v+y)/2)}c===r&&u===o||(this.center=this.unproject(new it(c,u))),s&&(this.zoom+=this.scaleZoom(s)),this._constrainCamera(),this._unmodified=n,this._constraining=!1}_minZoomForBounds(){let t=Math.max(0,this.scaleZoom(this.height/(this.worldMaxY-this.worldMinY)));return this.maxBounds&&(t=Math.max(t,this.scaleZoom(this.width/(this.worldMaxX-this.worldMinX)))),t}_maxCameraBoundsDistance(){return this._mercatorZfromZoom(this._minZoomForBounds())}_calcMatrices(){if(!this.height)return;const t=this.centerOffset,n="globe"===this.projection.name,r=this.pixelsPerMeter;"globe"===this.projection.name&&(this._mercatorScaleRatio=Ln(1,this.center.lat)/Ln(1,45));const o=zu(this.projection,this.zoom,this.width,this.height,1024);this._pixelsPerMercatorPixel=this.projection.pixelSpaceConversion(this.center.lat,this.worldSize,o),this.cameraToCenterDistance=.5/Math.tan(.5*this._fov)*this.height*this._pixelsPerMercatorPixel,this._updateCameraState(),this._farZ=this.projection.farthestPixelDistance(this),this._nearZ=this.height/50;const s="meters"===this.projection.zAxisUnit?r:1,c=this._camera.getWorldToCamera(this.worldSize,s);let u;const d=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,this._farZ);if(d[8]=2*-t.x/this.width,d[9]=2*t.y/this.height,this.isOrthographic){let z=.5*this.height/Math.tan(this._fov/2)*1*Math.tan(.5*this._fov),B=z*this.aspect,U=-B,$=-z;B-=t.x,U-=t.x,z+=t.y,$+=t.y,u=this._camera.getCameraToClipOrthographic(U,B,$,z,this._nearZ,this._farZ),((W,V,K,Q)=>{for(let ot=0;ot<16;ot++)W[ot]=x0(V[ot],K[ot],Q)})(u,u,d,b0(this.pitch>=15?1:this.pitch/15))}else u=d;const f=st.mul([],d,c);let m=st.mul([],u,c);if(this.projection.isReprojectedInTileSpace){const z=this.locationCoordinate(this.center),B=st.identity([]);st.translate(B,B,[z.x*this.worldSize,z.y*this.worldSize,0]),st.multiply(B,B,rw(this)),st.translate(B,B,[-z.x*this.worldSize,-z.y*this.worldSize,0]),st.multiply(m,m,B),st.multiply(f,f,B),this.inverseAdjustmentMatrix=function(U){const $=rw(U,!0);return Nh.invert([],[$[0],$[1],$[4],$[5]])}(this)}else this.inverseAdjustmentMatrix=[1,0,0,1];if(this.mercatorMatrix=st.scale([],m,[this.worldSize,this.worldSize,this.worldSize/s,1]),this.projMatrix=m,this.invProjMatrix=st.invert(new Float64Array(16),this.projMatrix),n){const z=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,1/0);z[8]=2*-t.x/this.width,z[9]=2*t.y/this.height,this.expandedFarZProjMatrix=st.mul([],z,c)}else this.expandedFarZProjMatrix=this.projMatrix;const g=st.invert([],u);this.frustumCorners=ry.fromInvProjectionMatrix(g,this.horizonLineFromTop(),this.height),this.cameraFrustum=aa.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,0,!n);const y=new Float32Array(16);st.identity(y),st.scale(y,y,[1,-1,1]),st.rotateX(y,y,this._pitch),st.rotateZ(y,y,this.angle);const v=st.perspective(new Float32Array(16),this._fov,this.width/this.height,this._nearZ,this._farZ);this.starsProjMatrix=st.clone(v);const x=(Math.PI/2-this._pitch)*(this.height/this._fov)*this._horizonShift;v[8]=2*-t.x/this.width,v[9]=2*(t.y+x)/this.height,this.skyboxMatrix=st.multiply(y,v,y);const w=this.point,E=w.x,M=w.y,D=this.width%2/2,A=this.height%2/2,P=Math.cos(this.angle),C=Math.sin(this.angle),R=E-Math.round(E)+P*D+C*A,k=M-Math.round(M)+P*A+C*D,N=new Float64Array(m);if(st.translate(N,N,[R>.5?R-1:R,k>.5?k-1:k,0]),this.alignedProjMatrix=N,m=st.create(),st.scale(m,m,[this.width/2,-this.height/2,1]),st.translate(m,m,[1,-1,0]),this.labelPlaneMatrix=m,m=st.create(),st.scale(m,m,[1,-1,1]),st.translate(m,m,[-1,-1,0]),st.scale(m,m,[2/this.width,2/this.height,1]),this.glCoordMatrix=m,this.pixelMatrix=st.multiply(new Float64Array(16),this.labelPlaneMatrix,f),this._calcFogMatrices(),this._distanceTileDataCache={},m=st.invert(new Float64Array(16),this.pixelMatrix),!m)throw new Error("failed to invert matrix");if(this.pixelMatrixInverse=m,"globe"===this.projection.name||this.mercatorFromTransition){this.globeMatrix=function(B){const{x:U,y:$}=B.point,{lng:W,lat:V}=B._center;return k1(U,$,B.worldSize,W,V)}(this);const z=[this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]];this.globeCenterInViewSpace=Z.transformMat4(z,z,c),this.globeRadius=this.worldSize/2/Math.PI-1}else this.globeMatrix=m;this._projMatrixCache={},this._alignedProjMatrixCache={},this._pixelsToTileUnitsCache={},this._expandedProjMatrixCache={}}_calcFogMatrices(){this._fogTileMatrixCache={};const t=this.cameraWorldSizeForFog,n=this.cameraPixelsPerMeter,r=this._camera.position,o=1/this.height/this._pixelsPerMercatorPixel,s=[t,t,n];Z.scale(s,s,o),Z.scale(r,r,-1),Z.multiply(r,r,s);const c=st.create();st.translate(c,c,r),st.scale(c,c,s),this.mercatorFogMatrix=c,this.worldToFogMatrix=this._camera.getWorldToCameraPosition(t,n,o)}_computeCameraPosition(t){const n=(t=t||this.pixelsPerMeter)/this.pixelsPerMeter,r=this._camera.forward(),o=this.point,s=this._mercatorZfromZoom(this._seaLevelZoom?this._seaLevelZoom:this._zoom)*n-t/this.worldSize*this._centerAltitude;return[o.x/this.worldSize-r[0]*s,o.y/this.worldSize-r[1]*s,t/this.worldSize*this._centerAltitude-r[2]*s]}_updateCameraState(){this.height&&(this._camera.setPitchBearing(this._pitch,this.angle),this._camera.position=this._computeCameraPosition())}_translateCameraConstrained(t){const n=this._maxCameraBoundsDistance()*Math.cos(this._pitch),r=this._camera.position[2],o=t[2];let s=1;this.projection.wrap&&(this.center=this.center.wrap()),o>0&&(s=Math.min((n-r)/o,1)),this._camera.position=Z.scaleAndAdd([],this._camera.position,t,s),this._updateStateFromCamera()}_updateStateFromCamera(){const t=this._camera.position,n=this._camera.forward(),{pitch:r,bearing:o}=this._camera.getPitchBearing(),s=Ln(this._centerAltitude,this.center.lat)*this._pixelsPerMercatorPixel,c=this._mercatorZfromZoom(this._maxZoom)*Math.cos(Oe(this._maxPitch)),u=Math.max((t[2]-s)/Math.cos(r),c),d=this._zoomFromMercatorZ(u);Z.scaleAndAdd(t,t,n,u),this._pitch=ne(r,Oe(this.minPitch),Oe(this.maxPitch)),this.angle=Rr(o,-Math.PI,Math.PI),this._setZoom(ne(d,this._minZoom,this._maxZoom)),this._updateSeaLevelZoom(),this._center=this.coordinateLocation(new Qe(t[0],t[1],t[2])),this._unmodified=!1,this._constrain(),this._calcMatrices()}_worldSizeFromZoom(t){return Math.pow(2,t)*this.tileSize}_mercatorZfromZoom(t){return this.cameraToCenterDistance/this._worldSizeFromZoom(t)}_minimumHeightOverTerrain(){const t=Math.min((null!=this._seaLevelZoom?this._seaLevelZoom:this._zoom)+4,this._maxZoom);return this._mercatorZfromZoom(t)}_zoomFromMercatorZ(t){return this.scaleZoom(this.cameraToCenterDistance/(t*this.tileSize))}zoomFromMercatorZAdjusted(t){let n=0,r=yc,o=0,s=1/0;for(;r-n>1e-6&&r>n;){const c=n+.5*(r-n),u=this.tileSize*Math.pow(2,c),d=this.getCameraToCenterDistance(this.projection,c,u),f=this.scaleZoom(d/(t*this.tileSize)),m=Math.abs(c-f);m<s&&(s=m,o=c),c<f?n=c:r=c}return o}_terrainEnabled(){return!(!this._elevation||!this.projection.supportsTerrain&&(nt("Terrain is not yet supported with alternate projections. Use mercator or globe to enable terrain."),1))}anyCornerOffEdge(t,n){const r=Math.min(t.x,n.x),o=Math.max(t.x,n.x),s=Math.min(t.y,n.y),c=Math.max(t.y,n.y);if(s<this.horizonLineFromTop(!1))return!0;if("mercator"!==this.projection.name)return!1;const u=[new it(r,s),new it(o,c),new it(r,c),new it(o,s)],d=this.renderWorldCopies?-3:0,f=this.renderWorldCopies?4:1;for(const m of u){const g=this.pointRayIntersection(m);if(g.t<0)return!0;const y=this.rayIntersectionCoordinate(g);if(y.x<d||y.y<0||y.x>f||y.y>1)return!0}return!1}isHorizonVisible(){return this.pitch+fr(this.fovAboveCenter)>88||this.anyCornerOffEdge(new it(0,0),new it(this.width,this.height))}zoomDeltaToMovement(t,n){const r=Z.length(Z.sub([],this._camera.position,t)),o=this._zoomFromMercatorZ(r)+n;return r-this._mercatorZfromZoom(o)}getCameraPoint(){if("globe"===this.projection.name){const t=function([n,r,o],s){const c=[n,r,o,1];En.transformMat4(c,c,s);const u=c[3]=Math.max(c[3],1e-6);return c[0]/=u,c[1]/=u,c[2]/=u,c}([this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]],this.pixelMatrix);return new it(t[0],t[1])}{const t=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new it(0,t))}}getCameraToCenterDistance(t,n=this.zoom,r=this.worldSize){const o=zu(t,n,this.width,this.height,1024),s=t.pixelSpaceConversion(this.center.lat,r,o);let c=.5/Math.tan(.5*this._fov)*this.height*s;return this.isOrthographic&&(c=x0(1,c,b0(this.pitch>=15?1:this.pitch/15))),c}getWorldToCameraMatrix(){const t=this._camera.getWorldToCamera(this.worldSize,"meters"===this.projection.zAxisUnit?this.pixelsPerMeter:1);return"globe"===this.projection.name&&st.multiply(t,t,this.globeMatrix),t}getFrustum(t){return aa.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,t,"meters"===this.projection.zAxisUnit)}}function w0(e,t,n){st.identity(e),st.rotateZ(e,e,Oe(t[2])),st.rotateX(e,e,Oe(t[0])),st.rotateY(e,e,Oe(t[1])),st.scale(e,e,n),st.multiply(e,e,[1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1])}function pp(e,t,n,r,o,s,c,u){const d=[n[0]-t[0],n[1]-t[1],0],f=[r[0]-t[0],r[1]-t[1],0];if(Z.length(d)<1e-12||Z.length(f)<1e-12)return ki.identity(e);const m=Z.cross([],d,f);Z.normalize(m,m),Z.subtract(f,r,t),d[2]=(s-o)*u,f[2]=(c-o)*u;const g=d;return Z.cross(g,d,f),Z.normalize(g,g),ki.rotationTo(e,m,g)}function E0(e,t,n=!1){const r=ri(t.zoom),o=function(s,c,u){const d=c.worldSize,f=[s[12],s[13],s[14]],m=xr(f[1]/d),g=Jo(f[0]/d),y=st.identity([]),v=Ln(1,m)*d,x=Ln(1,0)*d*Pl(m,c.zoom),w=1/hy(d);let E=x*w;if(u){const P=zu(c.projection,c.zoom,c.width,c.height,1024);E=w*c.projection.pixelSpaceConversion(c.center.lat,d,P)}const M=Ko(m,g);Z.add(M,M,Z.scale([],Z.normalize([],M),v*E*f[2]));const D=function(P){const C=[P[0],P[1],P[2]];let R=[0,1,0];const k=Z.cross([],R,C);return Z.cross(R,C,k),0===Z.squaredLength(R)&&(R=[0,1,0],Z.cross(k,C,R)),Z.normalize(k,k),Z.normalize(R,R),Z.normalize(C,C),[k[0],k[1],k[2],0,R[0],R[1],R[2],0,C[0],C[1],C[2],0,P[0],P[1],P[2],1]}(M);st.scale(y,y,[E,E,E*v]),st.translate(y,y,[-f[0],-f[1],-f[2]]);const A=st.multiply([],c.globeMatrix,D);return st.multiply(A,A,y),st.multiply(A,A,s),A}(e,t,n);return r>0?function(c,u,d){const f=(x,w,E)=>{const M=Z.length(x),D=Z.length(w),A=Al(x,w,E);return Z.scale(A,A,1/Z.length(A)*le(M,D,E))},m=f([c[0],c[1],c[2]],[u[0],u[1],u[2]],d),g=f([c[4],c[5],c[6]],[u[4],u[5],u[6]],d),y=f([c[8],c[9],c[10]],[u[8],u[9],u[10]],d),v=Al([c[12],c[13],c[14]],[u[12],u[13],u[14]],d);return[m[0],m[1],m[2],0,g[0],g[1],g[2],0,y[0],y[1],y[2],0,v[0],v[1],v[2],1]}(o,function(c,u){const d=u.worldSize,f=Ln(1,0)*d*Pl(u.center.lat,u.zoom)/hy(d),m=Ln(1,u.center.lat)*d,g=st.identity([]);return st.rotateY(g,g,Oe(u.center.lng)),st.rotateX(g,g,Oe(u.center.lat)),st.translate(g,g,[0,0,To]),st.scale(g,g,[f,f,f*m]),st.translate(g,g,[u.point.x-.5*d,u.point.y-.5*d,0]),st.multiply(g,g,c),st.multiply(g,u.globeMatrix,g)}(e,t),r):o}const Ac=[1,1,1];class hw{constructor(t,n,r,o){this.id=t,this.position=null!=n?new Se(n[0],n[1]):new Se(0,0),this.orientation=r??[0,0,0],this.nodes=o,this.uploaded=!1,this.aabb=new Bn([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),this.matrix=[]}_applyTransformations(t,n){if(st.multiply(t.matrix,n,t.matrix),t.meshes)for(const r of t.meshes){const o=Bn.applyTransform(r.aabb,t.matrix);this.aabb.encapsulate(o)}if(t.children)for(const r of t.children)this._applyTransformations(r,t.matrix)}computeBoundsAndApplyParent(){const t=st.identity([]);for(const n of this.nodes)this._applyTransformations(n,t)}_positionModelOnTerrain(t,n){const r=t.elevation;if(!r)return 0;const o=Bn.projectAabbCorners(this.aabb,this.matrix),s=Ln(1,this.position.lat)*t.worldSize,c=function(M,D){const A=[0,0,1],P=[{corners:[0,1,3,2],dotProductWithUp:0},{corners:[1,5,2,6],dotProductWithUp:0},{corners:[0,4,1,5],dotProductWithUp:0},{corners:[2,6,3,7],dotProductWithUp:0},{corners:[4,7,5,6],dotProductWithUp:0},{corners:[0,3,4,7],dotProductWithUp:0}];for(const C of P){const R=M[C.corners[0]],k=M[C.corners[1]],N=M[C.corners[2]],z=[k[0]-R[0],k[1]-R[1],D*(k[2]-R[2])],B=Z.cross(z,z,[N[0]-R[0],N[1]-R[1],D*(N[2]-R[2])]);Z.normalize(B,B),C.dotProductWithUp=Z.dot(B,A)}return P.sort((C,R)=>C.dotProductWithUp-R.dotProductWithUp),P[0].corners}(o,s),u=o[c[0]],d=o[c[1]],f=o[c[2]],m=o[c[3]],g=r.getAtPointOrZero(new Qe(u[0]/t.worldSize,u[1]/t.worldSize),0),y=r.getAtPointOrZero(new Qe(d[0]/t.worldSize,d[1]/t.worldSize),0),v=r.getAtPointOrZero(new Qe(f[0]/t.worldSize,f[1]/t.worldSize),0),x=r.getAtPointOrZero(new Qe(m[0]/t.worldSize,m[1]/t.worldSize),0),w=(g+x)/2,E=(y+v)/2;return w>E?y<v?pp(n,d,m,u,y,x,g,s):pp(n,f,u,m,v,g,x,s):g<x?pp(n,u,d,f,g,y,v,s):pp(n,m,f,d,x,v,y,s),Math.max(w,E)}computeModelMatrix(t,n,r,o,s,c,u=!1){const d=t.transform,f=d.zoom,m=d.project(this.position),g=Pl(this.position.lat,f),y=1/g;st.identity(this.matrix),st.translate(this.matrix,this.matrix,[m.x+o[0]*y,m.y+o[1]*y,o[2]]);let v=1,x=1;const w=d.worldSize;if(u){if("mercator"===d.projection.name){let A=0;d.elevation&&(A=d.elevation.getAtPointOrZero(new Qe(m.x/w,m.y/w),0));const P=En.transformMat4([],[m.x,m.y,A,1],d.projMatrix)[3]/d.cameraToCenterDistance;v=P,x=P*Pl(d.center.lat,f)}else if("globe"===d.projection.name){const A=E0(this.matrix,d),P=st.multiply([],d.projMatrix,A),C=[0,0,0,1];En.transformMat4(C,C,P);const R=C[3]/d.cameraToCenterDistance,k=ri(f),N=d.projection.pixelsPerMeter(this.position.lat,w)*Pl(this.position.lat,f),z=d.projection.pixelsPerMeter(d.center.lat,w)*Pl(d.center.lat,f);v=R/le(N,_y(d.center.lat),k),x=R*g/N,v*=z,x*=z}}else v=y;st.scale(this.matrix,this.matrix,[v,v,x]);const E=[...this.matrix],M=this.orientation,D=[];if(w0(D,[M[0]+n[0],M[1]+n[1],M[2]+n[2]],r),st.multiply(this.matrix,E,D),s&&d.elevation){let A=0;const P=[];if(c&&d.elevation){A=this._positionModelOnTerrain(d,P);const C=st.fromQuat([],P),R=st.multiply([],C,D);st.multiply(this.matrix,E,R)}else A=d.elevation.getAtPointOrZero(new Qe(m.x/w,m.y/w),0);0!==A&&(this.matrix[14]+=A)}}upload(t){if(!this.uploaded){for(const n of this.nodes)kl(n,t);for(const n of this.nodes)Ed(n);this.uploaded=!0}}destroy(){for(const t of this.nodes)Mg(t)}}function mp(e,t,n=!1){e.uploaded||(e.gfxTexture=new hr(t,e.image,n?t.gl.R8:t.gl.RGBA,{useMipmap:e.sampler.minFilter>=t.gl.NEAREST_MIPMAP_NEAREST}),e.uploaded=!0,e.image=null)}function T0(e,t,n){e.indexBuffer=t.createIndexBuffer(e.indexArray,!1,!0),e.vertexBuffer=t.createVertexBuffer(e.vertexArray,OI.members,!1,!0),e.normalArray&&(e.normalBuffer=t.createVertexBuffer(e.normalArray,ew.members,!1,!0)),e.texcoordArray&&(e.texcoordBuffer=t.createVertexBuffer(e.texcoordArray,NI.members,!1,!0)),e.colorArray&&(e.colorBuffer=t.createVertexBuffer(e.colorArray,(12===e.colorArray.bytesPerElement?kI:FI).members,!1,!0)),e.featureArray&&(e.pbrBuffer=t.createVertexBuffer(e.featureArray,zI.members,!0)),e.segments=Rn.simpleSegment(0,0,e.vertexArray.length,e.indexArray.length);const r=e.material;r.pbrMetallicRoughness.baseColorTexture&&mp(r.pbrMetallicRoughness.baseColorTexture,t),r.pbrMetallicRoughness.metallicRoughnessTexture&&mp(r.pbrMetallicRoughness.metallicRoughnessTexture,t),r.normalTexture&&mp(r.normalTexture,t),r.occlusionTexture&&mp(r.occlusionTexture,t,n),r.emissionTexture&&mp(r.emissionTexture,t)}function kl(e,t,n){if(e.meshes)for(const r of e.meshes)T0(r,t,n);if(e.children)for(const r of e.children)kl(r,t,n)}function Ed(e){if(e.meshes)for(const t of e.meshes)t.indexArray.destroy(),t.vertexArray.destroy(),t.colorArray&&t.colorArray.destroy(),t.normalArray&&t.normalArray.destroy(),t.texcoordArray&&t.texcoordArray.destroy(),t.featureArray&&t.featureArray.destroy();if(e.children)for(const t of e.children)Ed(t)}function Mg(e){if(e.meshes)for(const n of e.meshes)n.vertexBuffer&&(n.vertexBuffer.destroy(),n.indexBuffer.destroy(),n.normalBuffer&&n.normalBuffer.destroy(),n.texcoordBuffer&&n.texcoordBuffer.destroy(),n.colorBuffer&&n.colorBuffer.destroy(),n.pbrBuffer&&n.pbrBuffer.destroy(),n.segments.destroy(),n.material&&((t=n.material).pbrMetallicRoughness.baseColorTexture&&t.pbrMetallicRoughness.baseColorTexture.gfxTexture&&t.pbrMetallicRoughness.baseColorTexture.gfxTexture.destroy(),t.pbrMetallicRoughness.metallicRoughnessTexture&&t.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture&&t.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture.destroy(),t.normalTexture&&t.normalTexture.gfxTexture&&t.normalTexture.gfxTexture.destroy(),t.emissionTexture&&t.emissionTexture.gfxTexture&&t.emissionTexture.gfxTexture.destroy(),t.occlusionTexture&&t.occlusionTexture.gfxTexture&&t.occlusionTexture.gfxTexture.destroy()));var t;if(e.children)for(const n of e.children)Mg(n)}class Ig{constructor(t,n){this.feature=t,this.instancedDataOffset=n,this.instancedDataCount=0,this.rotation=[0,0,0],this.scale=[1,1,1],this.translation=[0,0,0]}}class BI{constructor(){this.instancedDataArray=new P_,this.instancesEvaluatedElevation=[],this.features=[],this.idToFeaturesIndex={}}}class jI{constructor(t){this.zoom=t.zoom,this.canonical=t.canonical,this.layers=t.layers,this.layerIds=this.layers.map(n=>n.fqid),this.projection=t.projection,this.index=t.index,this.hasZoomDependentProperties=this.layers[0].isZoomDependent(),this.stateDependentLayerIds=this.layers.filter(n=>n.isStateDependent()).map(n=>n.id),this.hasPattern=!1,this.instancesPerModel={},this.validForExaggeration=0,this.maxVerticalOffset=0,this.maxScale=0,this.maxHeight=0,this.lookupDim=this.zoom>this.canonical.z?256:this.zoom>15?75:100,this.instanceCount=0,this.terrainElevationMin=0,this.terrainElevationMax=0,this.validForDEMTile={id:null,timestamp:0}}populate(t,n,r,o){this.tileToMeter=Uf(r);const s=this.layers[0]._featureFilter.needGeometry;this.lookup=new Uint8Array(this.lookupDim*this.lookupDim);for(const{feature:c,id:u,index:d,sourceLayerIndex:f}of t){const m=Ua(c,s);if(!this.layers[0]._featureFilter.filter(new ar(this.zoom),m,r))continue;const g={id:u,sourceLayerIndex:f,index:d,geometry:s?m.geometry:ca(c,r,o),properties:c.properties,type:c.type,patterns:{}},y=this.addFeature(g,g.geometry,m);y&&n.featureIndex.insert(c,g.geometry,d,f,this.index,this.instancesPerModel[y].instancedDataArray.length)}this.lookup=null}update(t,n,r,o){for(const s in this.instancesPerModel){const c=this.instancesPerModel[s];for(const u in t)c.idToFeaturesIndex.hasOwnProperty(u)&&this.evaluate(c.features[c.idToFeaturesIndex[u]],t[u],c,!0)}this.maxHeight=0}updateZoomBasedPaintProperties(){if(!this.hasZoomDependentProperties)return!1;let t=!1;for(const n in this.instancesPerModel){const r=this.instancesPerModel[n];for(const o of r.features){const s=this.layers[0],c=o.feature,u=this.canonical,d=s.paint.get("model-rotation").evaluate(c,{},u),f=s.paint.get("model-scale").evaluate(c,{},u),m=s.paint.get("model-translation").evaluate(c,{},u);Z.exactEquals(o.rotation,d)&&Z.exactEquals(o.scale,f)&&Z.exactEquals(o.translation,m)||(this.evaluate(o,o.featureStates,r,!0),t=!0)}}return t}isEmpty(){for(const t in this.instancesPerModel)if(0!==this.instancesPerModel[t].instancedDataArray.length)return!1;return!0}uploadPending(){return!this.uploaded}upload(t){if(!this.uploaded)for(const n in this.instancesPerModel){const r=this.instancesPerModel[n];r.instancedDataArray.length<0||0===r.instancedDataArray.length||(r.instancedDataBuffer?r.instancedDataBuffer.updateData(r.instancedDataArray):r.instancedDataBuffer=t.createVertexBuffer(r.instancedDataArray,h0.members,!0,void 0,this.instanceCount))}this.uploaded=!0}destroy(){for(const t in this.instancesPerModel){const n=this.instancesPerModel[t];0!==n.instancedDataArray.length&&n.instancedDataBuffer&&n.instancedDataBuffer.destroy()}}addFeature(t,n,r){const o=this.layers[0],s=o.layout.get("model-id").evaluate(r,{},this.canonical);if(!s)return nt(`modelId is not evaluated for layer ${o.id} and it is not going to get rendered.`),s;this.instancesPerModel[s]||(this.instancesPerModel[s]=new BI);const c=this.instancesPerModel[s],u=c.instancedDataArray,d=new Ig(r,u.length);for(const f of n)for(const m of f){if(m.x<0||m.x>=et||m.y<0||m.y>=et)continue;const g=(this.lookupDim-1)/et,y=this.lookupDim*(m.y*g|0)+m.x*g|0;if(this.lookup){if(0!==this.lookup[y])continue;this.lookup[y]=1}this.instanceCount++;const v=u.length;u.resize(v+1),c.instancesEvaluatedElevation.push(0),u.float32[16*v]=m.x,u.float32[16*v+1]=m.y}return d.instancedDataCount=c.instancedDataArray.length-d.instancedDataOffset,d.instancedDataCount>0&&(t.id&&(c.idToFeaturesIndex[t.id]=c.features.length),c.features.push(d),this.evaluate(d,{},c,!1)),s}evaluate(t,n,r,o){const s=this.layers[0],c=t.feature,u=this.canonical,d=t.rotation=s.paint.get("model-rotation").evaluate(c,n,u),f=t.scale=s.paint.get("model-scale").evaluate(c,n,u),m=t.translation=s.paint.get("model-translation").evaluate(c,n,u),g=s.paint.get("model-color").evaluate(c,n,u);g.a=s.paint.get("model-color-mix-intensity").evaluate(c,n,u);const y=[];this.maxVerticalOffset<m[2]&&(this.maxVerticalOffset=m[2]),this.maxScale=Math.max(Math.max(this.maxScale,f[0]),Math.max(f[1],f[2])),w0(y,d,f);const v=Math.round(100*g.a)+g.b/1.05;for(let x=0;x<t.instancedDataCount;++x){const w=t.instancedDataOffset+x,E=16*w,M=r.instancedDataArray.float32;let D=0;o&&(D=M[E+6]-r.instancesEvaluatedElevation[w]);const A=0|M[E+1];M[E]=(0|M[E])+g.r/1.05,M[E+1]=A+g.g/1.05,M[E+2]=v,M[E+3]=1/(u.z>10?this.tileToMeter:Uf(u,A)),M[E+4]=m[0],M[E+5]=m[1],M[E+6]=m[2]+D,M[E+7]=y[0],M[E+8]=y[1],M[E+9]=y[2],M[E+10]=y[4],M[E+11]=y[5],M[E+12]=y[6],M[E+13]=y[8],M[E+14]=y[9],M[E+15]=y[10],r.instancesEvaluatedElevation[w]=m[2]}}}re(jI,"ModelBucket",{omit:["layers"]}),re(BI,"PerModelAttributes"),re(Ig,"ModelFeature");const VI=new gr({visibility:new Ot(H.layout_model.visibility),"model-id":new me(H.layout_model["model-id"])});var UI={paint:new gr({"model-opacity":new Ot(H.paint_model["model-opacity"]),"model-rotation":new me(H.paint_model["model-rotation"]),"model-scale":new me(H.paint_model["model-scale"]),"model-translation":new me(H.paint_model["model-translation"]),"model-color":new me(H.paint_model["model-color"]),"model-color-mix-intensity":new me(H.paint_model["model-color-mix-intensity"]),"model-type":new Ot(H.paint_model["model-type"]),"model-cast-shadows":new Ot(H.paint_model["model-cast-shadows"]),"model-receive-shadows":new Ot(H.paint_model["model-receive-shadows"]),"model-ambient-occlusion-intensity":new Ot(H.paint_model["model-ambient-occlusion-intensity"]),"model-emissive-strength":new me(H.paint_model["model-emissive-strength"]),"model-roughness":new me(H.paint_model["model-roughness"]),"model-height-based-emissive-strength-multiplier":new me(H.paint_model["model-height-based-emissive-strength-multiplier"]),"model-cutoff-fade-range":new Ot(H.paint_model["model-cutoff-fade-range"])}),layout:VI};const Dg=new Float32Array(262144),Vu=new Uint8Array(262144);function Ei(e){let t=0;if(e.meshes)for(const n of e.meshes)t=Math.max(t,n.aabb.max[2]);if(e.children)for(const n of e.children)t=Math.max(t,Ei(n));return t}const M0=["","wall","door","roof","window","lamp","logo"];class dw{constructor(t){this.node=t,this.evaluatedRMEA=[[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[.4,1,0,1],[1,0,0,1],[1,0,0,1]],this.hiddenByReplacement=!1,this.evaluatedScale=[1,1,1],this.evaluatedColor=[],this.emissionHeightBasedParams=[],this.feature={type:"Point",id:t.id,geometry:[],properties:{height:Ei(t)}}}}class fw{constructor(t,n,r,o){this.nodes=t,this.id=n,this.modelTraits|=1,this.uploaded=!1,this.hasPattern=!1,r&&(this.modelTraits|=4),this.zoom=-1,this.terrainExaggeration=1,this.projection={name:"mercator"},this.replacementUpdateTime=0,this.elevationReadFromZ=255,this.brightness=o,this.dirty=!0,this.needsUpload=!1}update(){console.log("Update 3D model bucket")}populate(){console.log("populate 3D model bucket")}uploadPending(){return!this.uploaded||this.needsUpload}upload(t){if(!this.needsUpload)return;const n=this.getNodesInfo();for(const r of n){const o=r.node;this.uploaded?this.updatePbrBuffer(o):kl(o,t,!0)}for(const r of n)Ed(r.node);this.uploaded=!0,this.needsUpload=!1}updatePbrBuffer(t){let n=!1;if(!t.meshes)return n;for(const r of t.meshes)r.pbrBuffer&&(r.pbrBuffer.updateData(r.featureArray),n=!0);return n}needsReEvaluation(t,n,r){const o=t.transform.projectionOptions,s=t.style.getBrightness(),c=this.brightness!==s;return!!(!this.uploaded||this.dirty||o.name!==this.projection.name||Td(r.paint.get("model-color").value,c)||Td(r.paint.get("model-color-mix-intensity").value,c)||Td(r.paint.get("model-roughness").value,c)||Td(r.paint.get("model-emissive-strength").value,c)||Td(r.paint.get("model-height-based-emissive-strength-multiplier").value,c))&&(this.projection=o,this.brightness=s,!0)}evaluateScale(t,n){if(t.transform.zoom===this.zoom)return;this.zoom=t.transform.zoom;const r=this.getNodesInfo(),o=this.id.canonical;for(const s of r){const c=s.feature;s.evaluatedScale=n.paint.get("model-scale").evaluate(c,{},o)}}evaluate(t){const n=this.getNodesInfo();for(const r of n){if(!r.node.meshes)continue;const o=r.feature,s=r.node.meshes&&r.node.meshes[0].featureData,c=r.evaluatedColor[2],u=r.evaluatedRMEA[2],d=this.id.canonical;if(r.hasTranslucentParts=!1,s){for(let f=0;f<M0.length;f++){const m=M0[f];m.length&&(o.properties.part=m);const g=t.paint.get("model-color").evaluate(o,{},d),y=t.paint.get("model-color-mix-intensity").evaluate(o,{},d);r.evaluatedColor[f]=[g.r,g.g,g.b,y],r.evaluatedRMEA[f][0]=t.paint.get("model-roughness").evaluate(o,{},d),r.evaluatedRMEA[f][2]=t.paint.get("model-emissive-strength").evaluate(o,{},d),r.evaluatedRMEA[f][3]=g.a,r.emissionHeightBasedParams[f]=t.paint.get("model-height-based-emissive-strength-multiplier").evaluate(o,{},d),!r.hasTranslucentParts&&g.a<1&&(r.hasTranslucentParts=!0)}delete o.properties.part,pw(r,c!==r.evaluatedColor[2]||u!==r.evaluatedRMEA[2])}r.evaluatedScale=t.paint.get("model-scale").evaluate(o,{},d),this.updatePbrBuffer(r.node)||(this.needsUpload=!0)}this.dirty=!1}elevationUpdate(t,n,r,o){const s=t.findDEMTileFor(r);if(s&&(s.tileID.canonical!==this.terrainTile||n!==this.terrainExaggeration)){if(s.dem&&s.tileID.overscaledZ!==this.elevationReadFromZ){this.elevationReadFromZ=s.tileID.overscaledZ;const c=Du.create(t,r,s);if(!c)return;4&this.modelTraits&&this.updateDEM(t,c,r,o);for(const u of this.getNodesInfo()){const d=u.node;if(!d.footprint||!d.footprint.vertices||!d.footprint.vertices.length)continue;const f=d.footprint.vertices;let m=c.getElevationAt(f[0].x,f[0].y,!0,!0);for(let g=1;g<f.length;g++)m=Math.min(m,c.getElevationAt(f[g].x,f[g].y,!0,!0));d.elevation=m}}this.terrainTile=s.tileID.canonical,this.terrainExaggeration=n}}updateDEM(t,n,r,o){let s=n._dem._modifiedForSources[o];if(void 0===s&&(n._dem._modifiedForSources[o]=[],s=n._dem._modifiedForSources[o]),s.includes(r.canonical))return;const c=n._dem.dim;s.push(r.canonical);let u=!1;for(const d of this.getNodesInfo()){const f=d.node;if(!f.footprint||!f.footprint.grid)continue;const m=f.footprint.grid,g=n.tileCoordToPixel(m.min.x,m.min.y),y=n.tileCoordToPixel(m.max.x,m.max.y),v=Math.min(Math.min(c-y.y,g.x),Math.min(g.y,c-y.x));if(v<0)continue;const x=ne(v,2,5);let w=Math.max(0,g.x-x),E=Math.max(0,g.y-x),M=Math.min(y.x+x,c-1),D=Math.min(y.y+x,c-1);for(let R=E;R<=D;++R)for(let k=w;k<=M;++k)Vu[R*c+k]=255;let A=0,P=0;for(let R=0;R<m.cellsY;++R)for(let k=0;k<m.cellsX;++k){if(!m.cells[R*m.cellsX+k])continue;const N=n.tileCoordToPixel(m.min.x+k/m.xScale,m.min.y+R/m.yScale),z=n.tileCoordToPixel(m.min.x+(k+1)/m.xScale,m.min.y+(R+1)/m.yScale);for(let B=N.y;B<=Math.min(z.y+1,c-1);++B)for(let U=N.x;U<=Math.min(z.x+1,c-1);++U)255===Vu[B*c+U]&&(Vu[B*c+U]=0,A+=n.getElevationAtPixel(U,B),P++)}const C=A/P;w=Math.max(1,g.x-x),E=Math.max(1,g.y-x),M=Math.min(y.x+x,c-2),D=Math.min(y.y+x,c-2),u=!0;for(let R=E;R<=D;++R)for(let k=w;k<=M;++k)0===Vu[R*c+k]&&(Dg[R*c+k]=n._dem.set(k,R,C));for(let R=1;R<x;++R){w=Math.max(1,g.x-R),E=Math.max(1,g.y-R),M=Math.min(y.x+R,c-2),D=Math.min(y.y+R,c-2);for(let k=E;k<=D;++k)for(let N=w;N<=M;++N){const z=k*c+N;if(255===Vu[z]){let B=0,U=0,$=-1,W=-1;for(let V=-1;V<=1;++V)for(let K=-1;K<=1;++K){const Q=(k+V)*c+N+K;if(Vu[Q]>=R)continue;const ot=Dg[Q],Y=Math.abs(ot);Y>U&&(B=ot,U=Y,$=K,W=V)}if(U>.1){const V=1-(R+.5*Math.abs($*W))/x;let K=n._dem.get(N,k)+B*V;const Q=n._dem.get(N+$,k+W),ot=n._dem.get(N-$,k-W,!0);(K-Q)*(K-ot)>0&&(K=(Q+ot)/2),Dg[z]=n._dem.set(N,k,K),Vu[z]=R}}}}}u&&(n._demTile.needsDEMTextureUpload=!0,n._dem._timestamp=De.now())}getNodesInfo(){if(!this.nodesInfo){this.nodesInfo=[];for(const t of this.nodes)this.nodesInfo.push(new dw(t));this.freeNodes()}return this.nodesInfo}freeNodes(){if(this.nodes){for(const t of this.nodes)Mg(t);this.nodes.splice(0,this.nodes.length)}}destroy(){this.freeNodes();const t=this.getNodesInfo();for(const n of t)Ed(n.node),Mg(n.node)}isEmpty(){return!this.nodes.length}updateReplacement(t,n){if(n.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=n.updateTime;const r=n.getReplacementRegionsForTile(t.toUnwrapped()),o=this.getNodesInfo();for(let s=0;s<this.nodesInfo.length;s++){const c=o[s].node;o[s].hiddenByReplacement=!!c.footprint&&!r.find(u=>u.footprint===c.footprint)}}getHeightAtTileCoord(t,n){const r=this.getNodesInfo(),o=[];for(let s=0;s<this.nodesInfo.length;s++){const c=r[s],u=c.node.meshes[0];if(t<u.aabb.min[0]||n<u.aabb.min[1]||t>u.aabb.max[0]||n>u.aabb.max[1])continue;const d=(t-u.aabb.min[0])/(u.aabb.max[0]-u.aabb.min[0])*64|0,f=64*Math.min(63,(n-u.aabb.min[1])/(u.aabb.max[1]-u.aabb.min[1])*64|0)+Math.min(63,d);if(!(u.heightmap[f]<0&&c.node.footprint))return c.hiddenByReplacement?void 0:{height:u.heightmap[f],maxHeight:c.feature.properties.height,hidden:!1,verticalScale:c.evaluatedScale[2]};if(c.node.footprint.grid.query(new it(t,n),new it(t,n),o),o.length>0)return{height:void 0,maxHeight:c.feature.properties.height,hidden:c.hiddenByReplacement,verticalScale:c.evaluatedScale[2]}}}}function Td(e,t){return!e.isLightConstant&&t}function GI(e,t,n,r,o,s,c,u){let d=(61440&t|(61440&t)>>4)>>8,f=(3840&t|(3840&t)>>4)>>4,m=240&t|(240&t)>>4;n[3]>0&&(d=le(d,255*n[0],n[3]),f=le(f,255*n[1],n[3]),m=le(m,255*n[2],n[3]));const g=d<<8|f,y=m<<8|Math.floor(255*r[3]),v=function(R){const k=ne(R,0,2);return Math.min(Math.round(.5*k*255),255)}(r[2])<<8|15*r[0]<<4|15*r[1],x=ne(o[0],0,1),w=ne(o[1],0,1),E=ne(o[2],0,1),M=ne(o[3],0,1);let D,A,P,C;if(x!==w&&c!==s&&w!==x){const R=c-s;A=1/(R*(w-x)),P=-(s+R*x)/(R*(w-x));const k=ne(o[4],-1,1);C=Math.pow(10,k),D=255*E<<8|255*M}else D=65535,A=0,P=1,C=1;if(e.emplaceBack(g,y,v,D,A,P,C),u){const R=u.length;u.clear();for(let k=0;k<R;k++)u.emplaceBack(g,y,v,D,A,P,C)}}function pw(e,t){const n=e.node;let r=0;for(const o of n.meshes){if(n.lights&&n.lightMeshIndex===r||!o.featureData)continue;o.featureArray=new mc,o.featureArray.reserve(o.featureData.length);let s=t;for(const c of o.featureData){let u;const d=65535&c,f=(15&d)<8?15&d:0,m=c>>16&65535,g=e.evaluatedRMEA[f],y=e.evaluatedColor[f],v=e.emissionHeightBasedParams[f];if(s&&2===f&&n.lights&&(u=new mc,u.resize(10*n.lights.length)),GI(o.featureArray,m,y,g,v,o.aabb.min[2],o.aabb.max[2],u),u&&s){s=!1;const x=n.meshes[n.lightMeshIndex];x.featureArray=u,x.featureArray._trim()}}o.featureArray._trim(),r++}}re(fw,"Tiled3dModelBucket",{omit:["layers"]}),re(dw,"Tiled3dModelFeature");class mw{constructor(){this._updateTime=0,this._sourceIds=[],this._activeRegions=[],this._prevRegions=[]}clear(){this._activeRegions.length>0&&++this._updateTime,this._activeRegions=[],this._prevRegions=[]}get updateTime(){return this._updateTime}getReplacementRegionsForTile(t){const n=I0(new it(0,0),new it(et,et),t),r=[];for(const o of this._activeRegions){if(o.hiddenByOverlap||!_w(n,o))continue;const s=$I(o.min,o.max,t);r.push({min:s.min,max:s.max,sourceId:this._sourceIds[o.priority],footprint:o.footprint,footprintTileId:o.tileId})}return r}setSources(t){this._setSources(t.map(n=>({getSourceId:()=>n.cache.id,getFootprints:()=>{const r=[];for(const o of n.cache.getVisibleCoordinates()){const s=n.cache.getTile(o).buckets[n.layer];if(s)for(const c of s.getNodesInfo()){const u=c.node;u.footprint&&r.push({footprint:u.footprint,id:o.toUnwrapped()})}}return r}})))}_addSource(t){const n=t.getFootprints();if(0!==n.length){for(const r of n){if(!r.footprint)continue;const o=I0(r.footprint.min,r.footprint.max,r.id);this._activeRegions.push({min:o.min,max:o.max,hiddenByOverlap:!1,priority:this._sourceIds.length,tileId:r.id,footprint:r.footprint})}this._sourceIds.push(t.getSourceId())}}_computeReplacement(){this._activeRegions.sort((n,r)=>n.priority-r.priority||Fl(n.min,r.min)||Fl(n.max,r.max));let t=this._activeRegions.length!==this._prevRegions.length;if(!t){let n=0,r=0;for(;!t&&n!==this._activeRegions.length;){const o=this._activeRegions[n],s=this._prevRegions[r];t=o.priority!==s.priority||!gw(o,s),++n,++r}}if(t){++this._updateTime;const n=r=>{const o=this._activeRegions;if(r>=o.length)return r;const s=o[r].priority;for(;r<o.length&&o[r].priority===s;)++r;return r};if(this._sourceIds.length>1){let r=0,o=n(r);for(;r!==o;){let s=r;const c=r;for(;s!==o;){const u=this._activeRegions[s];u.hiddenByOverlap=!1;for(let d=0;d<c;d++){const f=this._activeRegions[d];if(!f.hiddenByOverlap&&_w(u,f)&&(u.hiddenByOverlap=HI(u.footprint,u.tileId,f.footprint,f.tileId),u.hiddenByOverlap))break}++s}r=o,o=n(r)}}}}_setSources(t){[this._prevRegions,this._activeRegions]=[this._activeRegions,[]],this._sourceIds=[];for(let n=t.length-1;n>=0;n--)this._addSource(t[n]);this._computeReplacement()}}function Fl(e,t){return e.x-t.x||e.y-t.y}function gw(e,t){return 0===Fl(e.min,t.min)&&0===Fl(e.max,t.max)}function _w(e,t){return!(e.min.x>t.max.x||e.max.x<t.min.x||e.min.y>t.max.y||e.max.y<t.min.y)}function I0(e,t,n){const r=1/et,o=1/(1<<n.canonical.z),s=(t.x*r+n.canonical.x)*o+n.wrap,c=(t.y*r+n.canonical.y)*o;return{min:new it((e.x*r+n.canonical.x)*o+n.wrap,(e.y*r+n.canonical.y)*o),max:new it(s,c)}}function $I(e,t,n){const r=1<<n.canonical.z,o=((t.x-n.wrap)*r-n.canonical.x)*et,s=(t.y*r-n.canonical.y)*et;return{min:new it(((e.x-n.wrap)*r-n.canonical.x)*et,(e.y*r-n.canonical.y)*et),max:new it(o,s)}}function D0(e,t,n,r,o,s,c){const u=e.indices,d=e.vertices,f=[];for(let m=r;m<r+o;m+=3){const g=t[n[m+0]+s],y=t[n[m+1]+s],v=t[n[m+2]+s],x=Math.min(g.x,y.x,v.x),w=Math.max(g.x,y.x,v.x),E=Math.min(g.y,y.y,v.y),M=Math.max(g.y,y.y,v.y);f.length=0,e.grid.query(new it(x,E),new it(w,M),f);for(let D=0;D<f.length;D++){const A=f[D];if(Hf(d[u[3*A+0]],d[u[3*A+1]],d[u[3*A+2]],g,y,v,c))return!0}}return!1}function HI(e,t,n,r){if(!e||!n)return!1;let o=e.vertices;if(!t.canonical.equals(r.canonical)||t.wrap!==r.wrap){if(n.vertices.length<e.vertices.length)return HI(n,r,e,t);const s=t.canonical,c=r.canonical,u=Math.pow(2,c.z-s.z);o=e.vertices.map(d=>new it(d.x*s.x*et*u-c.x*et,d.y*s.y*et*u-c.y*et))}return D0(n,o,e.indices,0,e.indices.length,0,0)}const yw=jy.types,vw=["fill-extrusion-base","fill-extrusion-height","fill-extrusion-color","fill-extrusion-pattern","fill-extrusion-flood-light-wall-radius"],Ja=["fill-extrusion-flood-light-ground-radius"],qI=Math.pow(2,13),ZI=Math.pow(2,15)-1,fa=new it(0,1),Ti=2147483648;function Io(e,t,n,r,o,s,c,u){e.emplaceBack((t<<1)+c,(n<<1)+s,(Math.floor(r*qI)<<1)+o,Math.round(u))}function gp(e,t,n,r,o,s){e.emplaceBack(t.x,t.y,(n.x<<1)+r,(n.y<<1)+o,s)}function Md(e,t,n){e.emplaceBack(t.x,t.y,t.z,16384*n[0],16384*n[1],16384*n[2])}class xw{constructor(){this.vertexOffset=0,this.vertexCount=0,this.indexOffset=0,this.indexCount=0}}class bw{constructor(){this.centroidXY=new it(0,0),this.vertexArrayOffset=0,this.vertexCount=0,this.groundVertexArrayOffset=0,this.groundVertexCount=0,this.flags=0,this.footprintSegIdx=-1,this.footprintSegLen=0,this.polygonSegIdx=-1,this.polygonSegLen=0,this.min=new it(Number.MAX_VALUE,Number.MAX_VALUE),this.max=new it(-Number.MAX_VALUE,-Number.MAX_VALUE),this.height=0}span(){return new it(this.max.x-this.min.x,this.max.y-this.min.y)}}class ww{constructor(){this.acc=new it(0,0),this.accCount=0,this.centroidDataIndex=0}startRing(t,n){t.min.x===Number.MAX_VALUE&&(t.min.x=t.max.x=n.x,t.min.y=t.max.y=n.y)}appendEdge(t,n,r){this.accCount++,this.acc._add(n);let o=!!this.borders;n.x<t.min.x?(t.min.x=n.x,o=!0):n.x>t.max.x&&(t.max.x=n.x,o=!0),n.y<t.min.y?(t.min.y=n.y,o=!0):n.y>t.max.y&&(t.max.y=n.y,o=!0),((0===n.x||n.x===et)&&n.x===r.x)!=((0===n.y||n.y===et)&&n.y===r.y)&&this.processBorderOverlap(n,r),o&&this.checkBorderIntersection(n,r)}checkBorderIntersection(t,n){n.x<0!=t.x<0&&this.addBorderIntersection(0,le(n.y,t.y,(0-n.x)/(t.x-n.x))),n.x>et!=t.x>et&&this.addBorderIntersection(1,le(n.y,t.y,(et-n.x)/(t.x-n.x))),n.y<0!=t.y<0&&this.addBorderIntersection(2,le(n.x,t.x,(0-n.y)/(t.y-n.y))),n.y>et!=t.y>et&&this.addBorderIntersection(3,le(n.x,t.x,(et-n.y)/(t.y-n.y)))}addBorderIntersection(t,n){this.borders||(this.borders=[[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE]]);const r=this.borders[t];n<r[0]&&(r[0]=n),n>r[1]&&(r[1]=n)}processBorderOverlap(t,n){if(t.x===n.x){if(t.y===n.y)return;const r=0===t.x?0:1;this.addBorderIntersection(r,n.y),this.addBorderIntersection(r,t.y)}else{const r=0===t.y?2:3;this.addBorderIntersection(r,n.x),this.addBorderIntersection(r,t.x)}}centroid(){return 0===this.accCount?new it(0,0):new it(Math.floor(Math.max(0,this.acc.x)/this.accCount),Math.floor(Math.max(0,this.acc.y)/this.accCount))}intersectsCount(){return this.borders?this.borders.reduce((t,n)=>t+ +(n[0]!==Number.MAX_VALUE),0):0}}function Ew(e,t){const n=e.add(t)._unit(),r=ne(e.x*n.x+e.y*n.y,-1,1);var o,s,c;return o=Math.acos(r),Math.min(4,Math.max(-4,Math.tan(o)))/4*ZI*((s=e).x*(c=t).y-s.y*c.x<0?-1:1)}const S0=[e=>e.x<0,e=>e.x>et,e=>e.y<0,e=>e.y>et];function _p(e,t,n,r){const o=[4];if(0===r)return o;n._mult(r);const s=e.sub(n),c=t.sub(n),u=[e,t,s,c];for(let d=0;d<4;d++)for(const f of u)if(S0[d](f)){o.push(d);break}return o}class Tw{constructor(t){this.vertexArray=new om,this.indexArray=new Kr,this.programConfigurations=new _c(t.layers,t.zoom,n=>Ja.includes(n)),this._segments=new Rn,this.hiddenByLandmarkVertexArray=new _f,this._segmentToGroundQuads={},this._segmentToGroundQuads[0]=[],this._segmentToRegionTriCounts={},this._segmentToRegionTriCounts[0]=[0,0,0,0,0],this.regionSegments={},this.regionSegments[4]=new Rn}getDefaultSegment(){return this.regionSegments[4]}hasData(){return 0!==this.vertexArray.length}addData(t,n,r,o=!1){const s=t.length;if(s>2){let c=Math.max(0,this._segments.get().length-1);const u=this._segments._prepareSegment(4*s,this.vertexArray.length,2*this._segmentToGroundQuads[c].length);let d;c!==this._segments.get().length-1&&(c++,this._segmentToGroundQuads[c]=[],this._segmentToRegionTriCounts[c]=[0,0,0,0,0]);{const f=t[0],m=t[1];d=Ew(f.sub(t[s-1])._perp()._unit(),m.sub(f)._perp()._unit())}for(let f=0;f<s;f++){const m=f===s-1?0:f+1,g=t[f],y=t[m],v=t[m===s-1?0:m+1],x=y.sub(g)._perp()._unit(),w=Ew(x,v.sub(y)._perp()._unit()),E=d,M=w;if(Sg(g,y,n)||o&&yp(g,n)&&yp(y,n)){d=w;continue}const D=u.vertexLength;gp(this.vertexArray,g,y,1,1,E),gp(this.vertexArray,g,y,1,0,E),gp(this.vertexArray,g,y,0,1,M),gp(this.vertexArray,g,y,0,0,M),u.vertexLength+=4;const A=_p(g,y,x,r);for(const P of A)this._segmentToGroundQuads[c].push({id:D,region:P}),this._segmentToRegionTriCounts[c][P]+=2,u.primitiveLength+=2;d=w}}}prepareBorderSegments(){if(!this.hasData())return;const t=this._segments.get(),n=t.length;for(let r=0;r<n;r++)this._segmentToGroundQuads[r].sort((o,s)=>o.region-s.region);for(let r=0;r<n;r++){const o=this._segmentToGroundQuads[r],s=t[r],c=this._segmentToRegionTriCounts[r];c.reduce((d,f)=>d+f,0);let u=0;for(let d=0;d<=4;d++){const f=c[d];if(0!==f){let m=this.regionSegments[d];m||(m=this.regionSegments[d]=new Rn);const g={vertexOffset:s.vertexOffset,primitiveOffset:s.primitiveOffset+u,vertexLength:s.vertexLength,primitiveLength:f};m.get().push(g)}u+=f}for(let d=0;d<o.length;d++){const f=o[d].id;this.indexArray.emplaceBack(f,f+1,f+3),this.indexArray.emplaceBack(f,f+3,f+2)}}this._segmentToGroundQuads=null,this._segmentToRegionTriCounts=null,this._segments.destroy(),this._segments=null}addPaintPropertiesData(t,n,r,o,s,c){this.hasData()&&this.programConfigurations.populatePaintArrays(this.vertexArray.length,t,n,r,o,s,c)}upload(t){this.hasData()&&(this.vertexBuffer=t.createVertexBuffer(this.vertexArray,VM.members),this.indexBuffer=t.createIndexBuffer(this.indexArray))}uploadPaintProperties(t){this.hasData()&&this.programConfigurations.upload(t)}update(t,n,r,o,s,c){this.hasData()&&this.programConfigurations.updatePaintArrays(t,n,r,o,s,c)}updateHiddenByLandmark(t){if(!this.hasData())return;const n=t.groundVertexCount+t.groundVertexArrayOffset;if(0===t.groundVertexCount)return;const r=t.flags&Ti?1:0;for(let o=t.groundVertexArrayOffset;o<n;++o)this.hiddenByLandmarkVertexArray.emplace(o,r);this._needsHiddenByLandmarkUpdate=!0}uploadHiddenByLandmark(t){this.hasData()&&this._needsHiddenByLandmarkUpdate&&(!this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexArray.length>0?this.hiddenByLandmarkVertexBuffer=t.createVertexBuffer(this.hiddenByLandmarkVertexArray,J1.members,!0):this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.updateData(this.hiddenByLandmarkVertexArray),this._needsHiddenByLandmarkUpdate=!1)}destroy(){if(this.vertexBuffer){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.destroy(),this._segments&&this._segments.destroy(),this.programConfigurations.destroy();for(let t=0;t<=4;t++){const n=this.regionSegments[t];n&&n.destroy()}}}}class Id{constructor(t){this.zoom=t.zoom,this.canonical=t.canonical,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(n=>n.fqid),this.index=t.index,this.hasPattern=!1,this.edgeRadius=0,this.projection=t.projection,this.activeReplacements=[],this.replacementUpdateTime=0,this.centroidData=[],this.footprintIndices=new Kr,this.footprintVertices=new Xo,this.footprintSegments=[],this.layoutVertexArray=new nu,this.centroidVertexArray=new xf,this.indexArray=new Kr,this.programConfigurations=new _c(t.layers,t.zoom,n=>vw.includes(n)),this.segments=new Rn,this.stateDependentLayerIds=this.layers.filter(n=>n.isStateDependent()).map(n=>n.id),this.groundEffect=new Tw(t),this.maxHeight=0,this.partLookup={},this.triangleSubSegments=[],this.polygonSegments=[]}populate(t,n,r,o){this.features=[],this.hasPattern=Y1("fill-extrusion",this.layers,n),this.featuresOnBorder=[],this.borderFeatureIndices=[[],[],[],[]],this.borderDoneWithNeighborZ=[-1,-1,-1,-1],this.tileToMeter=Uf(r),this.edgeRadius=this.layers[0].layout.get("fill-extrusion-edge-radius")/this.tileToMeter;for(const{feature:s,id:c,index:u,sourceLayerIndex:d}of t){const f=this.layers[0]._featureFilter.needGeometry,m=Ua(s,f);if(!this.layers[0]._featureFilter.filter(new ar(this.zoom),m,r))continue;const g={id:c,sourceLayerIndex:d,index:u,geometry:f?m.geometry:ca(s,r,o),properties:s.properties,type:s.type,patterns:{}},y=this.layoutVertexArray.length;this.hasPattern?this.features.push(Fy("fill-extrusion",this.layers,g,this.zoom,n)):this.addFeature(g,g.geometry,u,r,{},n.availableImages,o,n.brightness),n.featureIndex.insert(s,g.geometry,u,d,this.index,y)}this.sortBorders(),"mercator"===this.projection.name&&this.splitToSubtiles(),this.groundEffect.prepareBorderSegments(),this.polygonSegments.length=0}addFeatures(t,n,r,o,s,c){for(const u of this.features){const{geometry:d}=u;this.addFeature(u,d,u.index,n,r,o,s,c)}this.sortBorders(),"mercator"===this.projection.name&&this.splitToSubtiles()}update(t,n,r,o,s){const c=0!==Object.keys(t).length;if(c&&!this.stateDependentLayers.length)return;const u=c?this.stateDependentLayers:this.layers;this.programConfigurations.updatePaintArrays(t,n,u,r,o,s),this.groundEffect.update(t,n,u,r,o,s)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(t){this.uploaded||(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,GM),this.indexBuffer=t.createIndexBuffer(this.indexArray),this.layoutVertexExtArray&&(this.layoutVertexExtBuffer=t.createVertexBuffer(this.layoutVertexExtArray,UM.members,!0)),this.groundEffect.upload(t)),this.groundEffect.uploadPaintProperties(t),this.programConfigurations.upload(t),this.uploaded=!0}uploadCentroid(t){this.groundEffect.uploadHiddenByLandmark(t),this.needsCentroidUpdate&&(!this.centroidVertexBuffer&&this.centroidVertexArray.length>0?this.centroidVertexBuffer=t.createVertexBuffer(this.centroidVertexArray,K1.members,!0):this.centroidVertexBuffer&&this.centroidVertexBuffer.updateData(this.centroidVertexArray),this.needsCentroidUpdate=!1)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.centroidVertexBuffer&&this.centroidVertexBuffer.destroy(),this.layoutVertexExtBuffer&&this.layoutVertexExtBuffer.destroy(),this.groundEffect.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(t,n,r,o,s,c,u,d){const f=this.layers[0].paint.get("fill-extrusion-flood-light-ground-radius").evaluate(t,{})/this.tileToMeter,m=[new it(0,0),new it(et,et)],g=u.projection,y="globe"===g.name,v="Polygon"===yw[t.type],x=new ww;x.centroidDataIndex=this.centroidData.length;const w=new bw,E=this.layers[0].paint.get("fill-extrusion-base").evaluate(t,{},o)<=0,M=this.layers[0].paint.get("fill-extrusion-height").evaluate(t,{},o);w.height=M,w.vertexArrayOffset=this.layoutVertexArray.length,w.groundVertexArrayOffset=this.groundEffect.vertexArray.length,y&&!this.layoutVertexExtArray&&(this.layoutVertexExtArray=new ru);const D=ky(n,500);for(let N=D.length-1;N>=0;N--){const z=D[N];(0===z.length||(A=z[0]).every(B=>B.x<=0)||A.every(B=>B.x>=et)||A.every(B=>B.y<=0)||A.every(B=>B.y>=et))&&D.splice(N,1)}var A;let P;if(y)P=R0(D,m,o);else{P=[];for(const N of D)P.push({polygon:N,bounds:m})}const C=v?this.edgeRadius:0,R=C>0&&this.zoom<17,k=(N,z)=>{if(0===N.length)return!1;const B=N[N.length-1];return z.x===B.x&&z.y===B.y};for(const{polygon:N,bounds:z}of P){let B=0,U=0;for(const K of N)v&&!K[0].equals(K[K.length-1])&&K.push(K[0]),U+=v?K.length-1:K.length;const $=this.segments.prepareSegment((v?5:4)*U,this.layoutVertexArray,this.indexArray);w.footprintSegIdx<0&&(w.footprintSegIdx=this.footprintSegments.length),w.polygonSegIdx<0&&(w.polygonSegIdx=this.polygonSegments.length);const W={triangleArrayOffset:this.indexArray.length,triangleCount:0,triangleSegIdx:this.segments.segments.length-1},V=new xw;if(V.vertexOffset=this.footprintVertices.length,V.indexOffset=3*this.footprintIndices.length,V.ringIndices=[],v){const K=[],Q=[];B=$.vertexLength;for(let Y=0;Y<N.length;Y++){const J=N[Y];J.length&&0!==Y&&Q.push(K.length/2);const ct=[];let dt,ht;dt=J[1].sub(J[0])._perp()._unit(),V.ringIndices.push(J.length-1);for(let _t=1;_t<J.length;_t++){const vt=J[_t],xt=J[_t===J.length-1?1:_t+1],mt=vt.clone();if(C){ht=xt.sub(vt)._perp()._unit();const Ct=dt.add(ht)._unit(),Ut=C*Math.min(4,1/(dt.x*Ct.x+dt.y*Ct.y));mt.x+=Ut*Ct.x,mt.y+=Ut*Ct.y,mt.x=Math.round(mt.x),mt.y=Math.round(mt.y),dt=ht}!E||0!==C&&!R||k(ct,mt)||ct.push(mt),Io(this.layoutVertexArray,mt.x,mt.y,0,0,1,1,0),$.vertexLength++,this.footprintVertices.emplaceBack(vt.x,vt.y),K.push(vt.x,vt.y),y&&Md(this.layoutVertexExtArray,g.projectTilePoint(mt.x,mt.y,o),g.upVector(o,mt.x,mt.y))}E&&(0===C||R)&&(0!==ct.length&&k(ct,ct[0])&&ct.pop(),this.groundEffect.addData(ct,z,f))}const ot=Xf(K,Q);for(let Y=0;Y<ot.length;Y+=3)this.footprintIndices.emplaceBack(V.vertexOffset+ot[Y+0],V.vertexOffset+ot[Y+1],V.vertexOffset+ot[Y+2]),this.indexArray.emplaceBack(B+ot[Y],B+ot[Y+2],B+ot[Y+1]),$.primitiveLength++;V.indexCount+=ot.length,V.vertexCount+=this.footprintVertices.length-V.vertexOffset}for(let K=0;K<N.length;K++){const Q=N[K];x.startRing(w,Q[0]);let ot=Q.length>4&&Iw(Q[Q.length-2],Q[0],Q[1]),Y=C?WI(Q[Q.length-2],Q[0],Q[1],C):0;const J=[];let ct,dt,ht;dt=Q[1].sub(Q[0])._perp()._unit();let _t=!0;for(let vt=1,xt=0;vt<Q.length;vt++){let mt=Q[vt-1],Ct=Q[vt];const Ut=Q[vt===Q.length-1?1:vt+1];if(x.appendEdge(w,Ct,mt),Sg(Ct,mt,z)){C&&(dt=Ut.sub(Ct)._perp()._unit(),_t=!_t);continue}const Gt=Ct.sub(mt)._perp(),Yt=Gt.x/(Math.abs(Gt.x)+Math.abs(Gt.y)),te=Gt.y>0?1:0,Me=mt.dist(Ct);if(xt+Me>32768&&(xt=0),C){ht=Ut.sub(Ct)._perp()._unit();let Ie=C0(mt,Ct,Ut,Mw(dt,ht),C);isNaN(Ie)&&(Ie=0);const we=Ct.sub(mt)._unit();mt=mt.add(we.mult(Y))._round(),Ct=Ct.add(we.mult(-Ie))._round(),Y=Ie,dt=ht,E&&this.zoom>=17&&(k(J,mt)||J.push(mt),k(J,Ct)||J.push(Ct))}const ue=$.vertexLength,dn=Q.length>4&&Iw(mt,Ct,Ut);let Ye=A0(xt,ot,_t);if(Io(this.layoutVertexArray,mt.x,mt.y,Yt,te,0,0,Ye),Io(this.layoutVertexArray,mt.x,mt.y,Yt,te,0,1,Ye),xt+=Me,Ye=A0(xt,dn,!_t),ot=dn,Io(this.layoutVertexArray,Ct.x,Ct.y,Yt,te,0,0,Ye),Io(this.layoutVertexArray,Ct.x,Ct.y,Yt,te,0,1,Ye),$.vertexLength+=4,this.indexArray.emplaceBack(ue+0,ue+1,ue+2),this.indexArray.emplaceBack(ue+1,ue+3,ue+2),$.primitiveLength+=2,C){const Ie=B+(1===vt?Q.length-2:vt-2),we=1===vt?B:Ie+1;if(this.indexArray.emplaceBack(ue+1,Ie,ue+3),this.indexArray.emplaceBack(Ie,we,ue+3),$.primitiveLength+=2,void 0===ct&&(ct=ue),!Sg(Ut,Q[vt],z)){const fe=vt===Q.length-1?ct:$.vertexLength;this.indexArray.emplaceBack(ue+2,ue+3,fe),this.indexArray.emplaceBack(ue+3,fe+1,fe),this.indexArray.emplaceBack(ue+3,we,fe+1),$.primitiveLength+=3}_t=!_t}if(y){const Ie=this.layoutVertexExtArray,we=g.projectTilePoint(mt.x,mt.y,o),fe=g.projectTilePoint(Ct.x,Ct.y,o),Ke=g.upVector(o,mt.x,mt.y),rn=g.upVector(o,Ct.x,Ct.y);Md(Ie,we,Ke),Md(Ie,we,Ke),Md(Ie,fe,rn),Md(Ie,fe,rn)}}v&&(B+=Q.length-1),E&&C&&this.zoom>=17&&(0!==J.length&&k(J,J[0])&&J.pop(),this.groundEffect.addData(J,z,f,C>0))}this.footprintSegments.push(V),W.triangleCount=this.indexArray.length-W.triangleArrayOffset,this.polygonSegments.push(W),++w.footprintSegLen,++w.polygonSegLen}if(w.vertexCount=this.layoutVertexArray.length-w.vertexArrayOffset,w.groundVertexCount=this.groundEffect.vertexArray.length-w.groundVertexArrayOffset,0!==w.vertexCount){if(w.centroidXY=x.borders?fa:this.encodeCentroid(x,w),this.centroidData.push(w),x.borders){this.featuresOnBorder.push(x);const N=this.featuresOnBorder.length-1;for(let z=0;z<x.borders.length;z++)x.borders[z][0]!==Number.MAX_VALUE&&this.borderFeatureIndices[z].push(N)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,r,s,c,o,d),this.groundEffect.addPaintPropertiesData(t,r,s,c,o,d),this.maxHeight=Math.max(this.maxHeight,M)}}sortBorders(){for(let t=0;t<this.borderFeatureIndices.length;t++)this.borderFeatureIndices[t].sort((n,r)=>this.featuresOnBorder[n].borders[t][0]-this.featuresOnBorder[r].borders[t][0])}splitToSubtiles(){const t=[];for(let u=0;u<this.centroidData.length;u++){const d=this.centroidData[u],f=+(d.min.y+d.max.y>et),m=2*f+(+(d.min.x+d.max.x>et)^f);for(let g=0;g<d.polygonSegLen;g++){const y=d.polygonSegIdx+g;t.push({centroidIdx:u,subtile:m,polygonSegmentIdx:y,triangleSegmentIdx:this.polygonSegments[y].triangleSegIdx})}}const n=new Kr;t.sort((u,d)=>u.triangleSegmentIdx===d.triangleSegmentIdx?u.subtile-d.subtile:u.triangleSegmentIdx-d.triangleSegmentIdx);let r=0,o=0,s=0;for(const u of t){if(u.triangleSegmentIdx!==r)break;s++}const c=t.length;for(;o!==t.length;){r=t[o].triangleSegmentIdx;let u=0,d=o,f=o;for(let m=d;m<s&&t[m].subtile===u;m++)f++;for(;d!==s;){const m=t[d];u=m.subtile;const g=this.centroidData[m.centroidIdx].min.clone(),y=this.centroidData[m.centroidIdx].max.clone(),v={vertexOffset:this.segments.segments[r].vertexOffset,primitiveOffset:n.length,vertexLength:this.segments.segments[r].vertexLength,primitiveLength:0,sortKey:void 0,vaos:{}};for(let x=d;x<f;x++){const w=t[x],E=this.polygonSegments[w.polygonSegmentIdx],M=this.centroidData[w.centroidIdx].min,D=this.centroidData[w.centroidIdx].max,A=this.indexArray.uint16;for(let P=E.triangleArrayOffset;P<E.triangleArrayOffset+E.triangleCount;P++)n.emplaceBack(A[3*P],A[3*P+1],A[3*P+2]);v.primitiveLength+=E.triangleCount,g.x=Math.min(g.x,M.x),g.y=Math.min(g.y,M.y),y.x=Math.max(y.x,D.x),y.y=Math.max(y.y,D.y)}v.primitiveLength>0&&this.triangleSubSegments.push({segment:v,min:g,max:y}),d=f;for(let x=d;x<s&&t[x].subtile===t[d].subtile;x++)f++}o=s;for(let m=o;m<c&&t[m].triangleSegmentIdx===t[o].triangleSegmentIdx;m++)s++}n._trim(),this.indexArray=n}getVisibleSegments(t,n,r){let o=0,s=0;const c=1<<t.canonical.z;if(n){const w=n.getMinMaxForTile(t);w&&(o=w.min,s=w.max)}s+=this.maxHeight;const u=t.toUnwrapped();let d;const f=[u.canonical.x/c+u.wrap,u.canonical.y/c],m=[(u.canonical.x+1)/c+u.wrap,(u.canonical.y+1)/c],g=new Rn,y=(w,E,M)=>[w[0]*(1-M[0])+E[0]*M[0],w[1]*(1-M[1])+E[1]*M[1]],v=[],x=[];for(const w of this.triangleSubSegments){v[0]=w.min.x/et,v[1]=w.min.y/et,x[0]=w.max.x/et,x[1]=w.max.y/et;const E=y(f,m,v),M=y(f,m,x);if(0===new Bn([E[0],E[1],o],[M[0],M[1],s]).intersectsPrecise(r)){d&&(g.segments.push(d),d=void 0);continue}const D=w.segment;d&&d.vertexOffset!==D.vertexOffset&&(g.segments.push(d),d=void 0),d?(d.vertexLength+=D.vertexLength,d.primitiveLength+=D.primitiveLength):d={vertexOffset:D.vertexOffset,primitiveLength:D.primitiveLength,vertexLength:D.vertexLength,primitiveOffset:D.primitiveOffset,sortKey:void 0,vaos:{}}}return d&&g.segments.push(d),g}encodeCentroid(t,n){const r=t.centroid(),o=n.span(),s=Math.min(7,Math.round(o.x*this.tileToMeter/10)),c=Math.min(7,Math.round(o.y*this.tileToMeter/10));return new it(ne(r.x,1,et-1)<<3|s,ne(r.y,1,et-1)<<3|c)}showCentroid(t){const n=this.centroidData[t.centroidDataIndex];n.flags&=Ti,n.centroidXY.x=0,n.centroidXY.y=0,this.writeCentroidToBuffer(n)}writeCentroidToBuffer(t){this.groundEffect.updateHiddenByLandmark(t);const n=t.vertexArrayOffset,r=t.vertexCount+t.vertexArrayOffset,o=t.flags&Ti?fa:t.centroidXY,s=this.centroidVertexArray.geta_centroid_pos0(n);if(this.centroidVertexArray.geta_centroid_pos1(n)!==o.y||s!==o.x){for(let c=n;c<r;++c)this.centroidVertexArray.emplace(c,o.x,o.y);this.needsCentroidUpdate=!0}}createCentroidsBuffer(){this.centroidVertexArray.resize(this.layoutVertexArray.length),this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const t of this.centroidData)this.writeCentroidToBuffer(t)}updateReplacement(t,n){if(n.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=n.updateTime;const r=n.getReplacementRegionsForTile(t.toUnwrapped());if(function(s,c){if(s.length!==c.length)return!1;for(let u=0;u<s.length;u++)if(s[u].sourceId!==c[u].sourceId||!gw(s[u],c[u]))return!1;return!0}(this.activeReplacements,r))return;if(this.activeReplacements=r,0===this.centroidVertexArray.length)this.createCentroidsBuffer();else for(const s of this.centroidData)s.flags&=2147483647;const o=[];for(const s of this.activeReplacements){const c=Math.pow(2,s.footprintTileId.canonical.z-t.canonical.z);for(const u of this.centroidData)if(!(u.flags&Ti||s.min.x>u.max.x||u.min.x>s.max.x||s.min.y>u.max.y||u.min.y>s.max.y))for(let d=0;d<u.footprintSegLen;d++){const f=this.footprintSegments[u.footprintSegIdx+d];if(o.length=0,XI(this.footprintVertices,f.vertexOffset,f.vertexCount,s.footprintTileId.canonical,t.canonical,o),D0(s.footprint,o,this.footprintIndices.uint16,f.indexOffset,f.indexCount,-f.vertexOffset,-c)){u.flags|=Ti;break}}}for(const s of this.centroidData)this.writeCentroidToBuffer(s);this.borderDoneWithNeighborZ=[-1,-1,-1,-1]}footprintContainsPoint(t,n,r){let o=!1;for(let s=0;s<r.footprintSegLen;s++){const c=this.footprintSegments[r.footprintSegIdx+s];let u=0;for(const d of c.ringIndices){for(let f=u,m=d+u-1;f<d+u;m=f++){const g=this.footprintVertices.int16[2*(f+c.vertexOffset)+0],y=this.footprintVertices.int16[2*(f+c.vertexOffset)+1],v=this.footprintVertices.int16[2*(m+c.vertexOffset)+1];y>n!=v>n&&t<(this.footprintVertices.int16[2*(m+c.vertexOffset)+0]-g)*(n-y)/(v-y)+g&&(o=!o)}u=d}}return o}getHeightAtTileCoord(t,n){let r=Number.NEGATIVE_INFINITY,o=!0;const s=4*(t+et)*et+(n+et);if(this.partLookup.hasOwnProperty(s)){const c=this.partLookup[s];return c?{height:c.height,hidden:!!(c.flags&Ti)}:void 0}for(const c of this.centroidData)t>c.max.x||c.min.x>t||n>c.max.y||c.min.y>n||this.footprintContainsPoint(t,n,c)&&c&&c.height>r&&(r=c.height,this.partLookup[s]=c,o=!!(c.flags&Ti));if(r!==Number.NEGATIVE_INFINITY)return{height:r,hidden:o};this.partLookup[s]=void 0}}function Mw(e,t){const n=e.add(t)._unit();return e.x*n.x+e.y*n.y}function WI(e,t,n,r){const o=t.sub(e)._perp()._unit(),s=n.sub(t)._perp()._unit();return C0(e,t,n,Mw(o,s),r)}function C0(e,t,n,r,o){const s=Math.sqrt(1-r*r);return Math.min(e.dist(t)/3,t.dist(n)/3,o*s/r)}function Sg(e,t,n){return e.x<n[0].x&&t.x<n[0].x||e.x>n[1].x&&t.x>n[1].x||e.y<n[0].y&&t.y<n[0].y||e.y>n[1].y&&t.y>n[1].y}function yp(e,t){return e.x<t[0].x||e.x>t[1].x||e.y<t[0].y||e.y>t[1].y}function Iw(e,t,n){if(e.x<0||e.x>=et||t.x<0||t.x>=et||n.x<0||n.x>=et)return!1;const r=n.sub(t),o=r.perp(),s=e.sub(t);return(r.x*s.x+r.y*s.y)/Math.sqrt((r.x*r.x+r.y*r.y)*(s.x*s.x+s.y*s.y))>-.866&&o.x*s.x+o.y*s.y<0}function A0(e,t,n){const r=t?2|e:-3&e;return n?1|r:-2&r}function P0(){const e=Math.PI/32,t=Math.tan(e),n=jf;return n*Math.sqrt(1+2*t*t)-n}function R0(e,t,n){const r=1<<n.z,o=Jo(n.x/r),s=Jo((n.x+1)/r),c=xr(n.y/r),u=xr((n.y+1)/r);return function(d,f,m,g,y=0,v){const x=[];if(!d.length||!m||!g)return x;const w=(R,k)=>{for(const N of R)x.push({polygon:N,bounds:k})},E=Math.ceil(Math.log2(m)),M=Math.ceil(Math.log2(g)),D=E-M,A=[];for(let R=0;R<Math.abs(D);R++)A.push(D>0?0:1);for(let R=0;R<Math.min(E,M);R++)A.push(0),A.push(1);let P=d;if(P=Kf(P,f[0].y-y,f[1].y+y,1),P=Kf(P,f[0].x-y,f[1].x+y,0),!P.length)return x;const C=[];for(A.length?C.push({polygons:P,bounds:f,depth:0}):w(P,f);C.length;){const R=C.pop(),k=R.depth,N=A[k],z=R.bounds[0],B=R.bounds[1],U=0===N?z.x:z.y,$=0===N?B.x:B.y,W=v?v(N,U,$):.5*(U+$),V=Kf(R.polygons,U-y,W+y,N),K=Kf(R.polygons,W-y,$+y,N);if(V.length){const Q=[z,new it(0===N?W:B.x,1===N?W:B.y)];A.length>k+1?C.push({polygons:V,bounds:Q,depth:k+1}):w(V,Q)}if(K.length){const Q=[new it(0===N?W:z.x,1===N?W:z.y),B];A.length>k+1?C.push({polygons:K,bounds:Q,depth:k+1}):w(K,Q)}}return x}(e,t,Math.ceil((s-o)/11.25),Math.ceil((c-u)/11.25),1,(d,f,m)=>{if(0===d)return.5*(f+m);{const g=xr((n.y+f/et)/r);return(ui(.5*(xr((n.y+m/et)/r)+g))*r-n.y)*et}})}function XI(e,t,n,r,o,s){const c=Math.pow(2,r.z-o.z);for(let u=0;u<n;u++){let d=e.int16[2*(u+t)+0],f=e.int16[2*(u+t)+1];d=(d+o.x*et)*c-r.x*et,f=(f+o.y*et)*c-r.y*et,s.push(new it(d,f))}}re(Id,"FillExtrusionBucket",{omit:["layers","features"]}),re(bw,"PartData"),re(xw,"FootprintSegment"),re(ww,"BorderCentroidData"),re(Tw,"GroundEffect");const YI=new gr({visibility:new Ot(H["layout_fill-extrusion"].visibility),"fill-extrusion-edge-radius":new Ot(H["layout_fill-extrusion"]["fill-extrusion-edge-radius"])});var Dw={paint:new gr({"fill-extrusion-opacity":new Ot(H["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new me(H["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new Ot(H["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new Ot(H["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new me(H["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-height":new me(H["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new me(H["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-vertical-gradient":new Ot(H["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"]),"fill-extrusion-ambient-occlusion-intensity":new Ot(H["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-intensity"]),"fill-extrusion-ambient-occlusion-radius":new Ot(H["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-radius"]),"fill-extrusion-ambient-occlusion-wall-radius":new Ot(H["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-wall-radius"]),"fill-extrusion-ambient-occlusion-ground-radius":new Ot(H["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-radius"]),"fill-extrusion-ambient-occlusion-ground-attenuation":new Ot(H["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-attenuation"]),"fill-extrusion-flood-light-color":new Ot(H["paint_fill-extrusion"]["fill-extrusion-flood-light-color"]),"fill-extrusion-flood-light-intensity":new Ot(H["paint_fill-extrusion"]["fill-extrusion-flood-light-intensity"]),"fill-extrusion-flood-light-wall-radius":new me(H["paint_fill-extrusion"]["fill-extrusion-flood-light-wall-radius"]),"fill-extrusion-flood-light-ground-radius":new me(H["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-radius"]),"fill-extrusion-flood-light-ground-attenuation":new Ot(H["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-attenuation"]),"fill-extrusion-vertical-scale":new Ot(H["paint_fill-extrusion"]["fill-extrusion-vertical-scale"]),"fill-extrusion-rounded-roof":new Ot(H["paint_fill-extrusion"]["fill-extrusion-rounded-roof"]),"fill-extrusion-cutoff-fade-range":new Ot(H["paint_fill-extrusion"]["fill-extrusion-cutoff-fade-range"]),"fill-extrusion-emissive-strength":new Ot(H["paint_fill-extrusion"]["fill-extrusion-emissive-strength"])}),layout:YI};class Pc extends it{constructor(t,n,r){super(t,n),this.z=r}}function Dd(e,t){return e.x*t.x+e.y*t.y}function L0(e,t){if(1===e.length){let n=0;const r=t[n++];let o;for(;!o||r.equals(o);)if(o=t[n++],!o)return 1/0;for(;n<t.length;n++){const s=t[n],c=e[0],u=o.sub(r),d=s.sub(r),f=c.sub(r),m=Dd(u,u),g=Dd(u,d),y=Dd(d,d),v=Dd(f,u),x=Dd(f,d),w=m*y-g*g,E=(y*v-g*x)/w,M=(m*x-g*v)/w,D=r.z*(1-E-M)+o.z*E+s.z*M;if(isFinite(D))return D}return 1/0}{let n=1/0;for(const r of t)n=Math.min(n,r.z);return n}}function O0(e,t,n,r,o,s,c,u){const d=c*o.getElevationAt(e,t,!0,!0),f=0!==s[0],m=f?0===s[1]?c*(s[0]/7-450):c*function(g,y,v){const x=Math.floor(y[0]/8),w=Math.floor(y[1]/8),E=10*(y[0]-8*x),M=10*(y[1]-8*w),D=g.getElevationAt(x,w,!0,!0),A=g.getMeterToDEM(v),P=Math.floor(.5*(E*A-1)),C=Math.floor(.5*(M*A-1)),R=g.tileCoordToPixel(x,w),k=2*P+1,N=2*C+1,z=(Y=k,J=N,[(K=g).getElevationAtPixel(Q=R.x-P,ot=R.y-C,!0),K.getElevationAtPixel(Q+J,ot,!0),K.getElevationAtPixel(Q,ot+J,!0),K.getElevationAtPixel(Q+Y,ot+J,!0)]),B=Math.abs(z[0]-z[1]),U=Math.abs(z[2]-z[3]),$=Math.abs(z[0]-z[2])+Math.abs(z[1]-z[3]),W=Math.min(.25,.5*A*(B+U)/k),V=Math.min(.25,.5*A*$/N);var K,Q,ot,Y,J;return D+Math.max(W*E,V*M)}(o,s,u):d;return{base:d+(0===n)?-1:n,top:f?Math.max(m+r,d+n+2):d+r}}const Sw=new gr({"line-cap":new me(H.layout_line["line-cap"]),"line-join":new me(H.layout_line["line-join"]),"line-miter-limit":new Ot(H.layout_line["line-miter-limit"]),"line-round-limit":new Ot(H.layout_line["line-round-limit"]),"line-sort-key":new me(H.layout_line["line-sort-key"]),visibility:new Ot(H.layout_line.visibility)});var k0={paint:new gr({"line-opacity":new me(H.paint_line["line-opacity"]),"line-color":new me(H.paint_line["line-color"]),"line-translate":new Ot(H.paint_line["line-translate"]),"line-translate-anchor":new Ot(H.paint_line["line-translate-anchor"]),"line-width":new me(H.paint_line["line-width"]),"line-gap-width":new me(H.paint_line["line-gap-width"]),"line-offset":new me(H.paint_line["line-offset"]),"line-blur":new me(H.paint_line["line-blur"]),"line-dasharray":new me(H.paint_line["line-dasharray"]),"line-pattern":new me(H.paint_line["line-pattern"]),"line-gradient":new ff(H.paint_line["line-gradient"]),"line-trim-offset":new Ot(H.paint_line["line-trim-offset"]),"line-emissive-strength":new Ot(H.paint_line["line-emissive-strength"]),"line-border-width":new me(H.paint_line["line-border-width"]),"line-border-color":new me(H.paint_line["line-border-color"])}),layout:Sw};const Cw=(e,t,n,r,o,s,c)=>{const u=e.transform,d=u.calculatePixelsToTileUnitsMatrix(t);return{u_matrix:Pw(e,t,n,r),u_pixels_to_tile_units:d,u_device_pixel_ratio:s,u_units_to_pixels:[1/u.pixelsToGLUnits[0],1/u.pixelsToGLUnits[1]],u_dash_image:0,u_gradient_image:1,u_image_height:o,u_texsize:Lw(n)&&t.lineAtlasTexture?t.lineAtlasTexture.size:[0,0],u_tile_units_to_pixels:F0(t,e.transform),u_alpha_discard_threshold:0,u_trim_offset:c,u_emissive_strength:n.paint.get("line-emissive-strength")}},Aw=(e,t,n,r,o)=>{const s=e.transform;return{u_matrix:Pw(e,t,n,r),u_texsize:t.imageAtlasTexture?t.imageAtlasTexture.size:[0,0],u_pixels_to_tile_units:s.calculatePixelsToTileUnitsMatrix(t),u_device_pixel_ratio:o,u_image:0,u_tile_units_to_pixels:F0(t,s),u_units_to_pixels:[1/s.pixelsToGLUnits[0],1/s.pixelsToGLUnits[1]],u_alpha_discard_threshold:0}};function F0(e,t){return 1/Bu(e,1,t.tileZoom)}function Pw(e,t,n,r){return e.translatePosMatrix(r||t.tileID.projMatrix,t,n.paint.get("line-translate"),n.paint.get("line-translate-anchor"))}const Rw=e=>{const t=[];Lw(e)&&t.push("RENDER_LINE_DASH"),e.paint.get("line-gradient")&&t.push("RENDER_LINE_GRADIENT");const n=e.paint.get("line-trim-offset");return 0===n[0]&&0===n[1]||t.push("RENDER_LINE_TRIM_OFFSET"),0!==e.paint.get("line-border-width").constantOr(1)&&t.push("RENDER_LINE_BORDER"),t};function Lw(e){const t=e.paint.get("line-dasharray").value;return t.value||"constant"!==t.kind}const Ow=new class extends me{possiblyEvaluate(e,t){return t=new ar(Math.floor(t.zoom),{now:t.now,fadeDuration:t.fadeDuration,transition:t.transition}),super.possiblyEvaluate(e,t)}evaluate(e,t,n,r){return t=Wt({},t,{zoom:Math.floor(t.zoom)}),super.evaluate(e,t,n,r)}}(k0.paint.properties["line-width"].specification);function kw(e,t){return t>0?t+2*e:e}Ow.useIntegerZoom=!0;const KI=new gr({visibility:new Ot(H.layout_background.visibility)});var JI={paint:new gr({"background-color":new Ot(H.paint_background["background-color"]),"background-pattern":new Ot(H.paint_background["background-pattern"]),"background-opacity":new Ot(H.paint_background["background-opacity"]),"background-emissive-strength":new Ot(H.paint_background["background-emissive-strength"])}),layout:KI};const QI=new gr({visibility:new Ot(H.layout_raster.visibility)});var tD={paint:new gr({"raster-opacity":new Ot(H.paint_raster["raster-opacity"]),"raster-color":new ff(H.paint_raster["raster-color"]),"raster-color-mix":new Ot(H.paint_raster["raster-color-mix"]),"raster-color-range":new Ot(H.paint_raster["raster-color-range"]),"raster-hue-rotate":new Ot(H.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new Ot(H.paint_raster["raster-brightness-min"]),"raster-brightness-max":new Ot(H.paint_raster["raster-brightness-max"]),"raster-saturation":new Ot(H.paint_raster["raster-saturation"]),"raster-contrast":new Ot(H.paint_raster["raster-contrast"]),"raster-resampling":new Ot(H.paint_raster["raster-resampling"]),"raster-fade-duration":new Ot(H.paint_raster["raster-fade-duration"]),"raster-emissive-strength":new Ot(H.paint_raster["raster-emissive-strength"]),"raster-array-band":new Ot(H.paint_raster["raster-array-band"]),"raster-elevation":new Ot(H.paint_raster["raster-elevation"])}),layout:QI};function Fw(e,t,n,r,o,s,c,u){const d=[e,n,o,t,r,s,1,1,1],f=[c,u,1],m=fo.adjoint([],d),[g,y,v]=Z.transformMat3(f,f,fo.transpose(m,m));return fo.multiply(d,[g,0,0,0,y,0,0,0,v],d)}class $s extends ye{constructor(t,n,r,o){super(),this.id=t,this.dispatcher=r,this.coordinates=n.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.onNorthPole=!1,this.onSouthPole=!1,this.setEventedParent(o),this.options=n,this._dirty=!1}load(t,n){if(this._loaded=n||!1,this.fire(new Mt("dataloading",{dataType:"source"})),this.url=this.options.url,!this.url)return t&&(this.coordinates=t),this._loaded=!0,void this._finishLoading();this._imageRequest=xe(this.map._requestManager.transformRequest(this.url,yt.Image),(r,o)=>{if(this._imageRequest=null,this._loaded=!0,r)this.fire(new Tt(r));else if(o){const{HTMLImageElement:s}=ft;this.image=o instanceof s?De.getImageData(o):o,this._dirty=!0,this.width=this.image.width,this.height=this.image.height,t&&(this.coordinates=t),this._finishLoading()}})}loaded(){return this._loaded}updateImage(t){return t.url?(this._imageRequest&&t.url!==this.options.url&&(this._imageRequest.cancel(),this._imageRequest=null),this.options.url=t.url,this.load(t.coordinates,this._loaded),this):this}setTexture(t){if(!(t.handle instanceof WebGLTexture))throw new Error("The provided handle is not a WebGLTexture instance");return this.texture=new hd(this.map.painter.context,t.handle),this.width=t.dimensions[0],this.height=t.dimensions[1],this._dirty=!1,this._loaded=!0,this._finishLoading(),this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new Mt("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(t){this.map=t,this.load()}onRemove(){this._imageRequest&&(this._imageRequest.cancel(),this._imageRequest=null),!this.texture||this.texture instanceof hd||this.texture.destroy()}setCoordinates(t){if(this.coordinates=t,this._boundsArray=void 0,!t.length)return this;this.onNorthPole=!1,this.onSouthPole=!1;let n=t[0][1],r=t[0][1];for(const s of t)s[1]>r&&(r=s[1]),s[1]<n&&(n=s[1]);const o=(r+n)/2;if(o>Ar?this.onNorthPole=!0:o<-Ar&&(this.onSouthPole=!0),!this.onNorthPole&&!this.onSouthPole){const s=t.map(Qe.fromLngLat);this.tileID=function(c){let u=1/0,d=1/0,f=-1/0,m=-1/0;for(const x of c)u=Math.min(u,x.x),d=Math.min(d,x.y),f=Math.max(f,x.x),m=Math.max(m,x.y);const g=Math.max(f-u,m-d),y=Math.max(0,Math.floor(-Math.log(g)/Math.LN2)),v=Math.pow(2,y);return new xs(y,Math.floor((u+f)/2*v),Math.floor((d+m)/2*v))}(s),this.minzoom=this.maxzoom=this.tileID.z}return this.fire(new Mt("data",{dataType:"source",sourceDataType:"content"})),this}_clear(){this._boundsArray=void 0}_prepareData(t){for(const d in this.tiles){const f=this.tiles[d];"loaded"!==f.state&&(f.state="loaded",f.texture=this.texture)}if(this._boundsArray)return;const n=Pu(this.tileID,this.map.transform.projection),[r,o,s,c]=this.coordinates.map(d=>{const f=n.projection.project(d[0],d[1]);return od(n,f)._round()});this.perspectiveTransform=function(d,f,m,g,y,v,x,w,E,M){const D=Fw(0,0,d,0,0,f,d,f),A=Fw(m,g,y,v,x,w,E,M);return fo.multiply(A,fo.adjoint(D,D),A),[A[6]/A[8]*d/et,A[7]/A[8]*f/et]}(this.width,this.height,r.x,r.y,o.x,o.y,c.x,c.y,s.x,s.y);const u=this._boundsArray=new nu;u.emplaceBack(r.x,r.y,0,0),u.emplaceBack(o.x,o.y,et,0),u.emplaceBack(c.x,c.y,0,et),u.emplaceBack(s.x,s.y,et,et),this.boundsBuffer&&this.boundsBuffer.destroy(),this.boundsBuffer=t.createVertexBuffer(u,yg.members),this.boundsSegments=Rn.simpleSegment(0,0,4,2)}prepare(){const t=0!==Object.keys(this.tiles).length;if(this.tileID&&!t)return;const n=this.map.painter.context,r=n.gl;!this._dirty||this.texture instanceof hd||(this.texture?this.texture.update(this.image):(this.texture=new hr(n,this.image,r.RGBA),this.texture.bind(r.LINEAR,r.CLAMP_TO_EDGE)),this._dirty=!1),t&&this._prepareData(n)}loadTile(t,n){this.tileID&&this.tileID.equals(t.tileID.canonical)?(this.tiles[String(t.tileID.wrap)]=t,t.buckets={},n(null)):(t.state="errored",n(null))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}}class eD extends xo{constructor(t){super(t,{}),this.implementation=t,t.slot&&(this.slot=t.slot)}is3D(){return"3d"===this.implementation.renderingMode}hasOffscreenPass(){return void 0!==this.implementation.prerender}isLayerDraped(t){return void 0!==this.implementation.renderToTile}shouldRedrape(){return!!this.implementation.shouldRerenderTiles&&this.implementation.shouldRerenderTiles()}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){}onAdd(t){this.implementation.onAdd&&this.implementation.onAdd(t,t.painter.context.gl)}onRemove(t){this.implementation.onRemove&&this.implementation.onRemove(t,t.painter.context.gl)}}const nD=new gr({visibility:new Ot(H.layout_sky.visibility)});var rD={paint:new gr({"sky-type":new Ot(H.paint_sky["sky-type"]),"sky-atmosphere-sun":new Ot(H.paint_sky["sky-atmosphere-sun"]),"sky-atmosphere-sun-intensity":new Ot(H.paint_sky["sky-atmosphere-sun-intensity"]),"sky-gradient-center":new Ot(H.paint_sky["sky-gradient-center"]),"sky-gradient-radius":new Ot(H.paint_sky["sky-gradient-radius"]),"sky-gradient":new ff(H.paint_sky["sky-gradient"]),"sky-atmosphere-halo-color":new Ot(H.paint_sky["sky-atmosphere-halo-color"]),"sky-atmosphere-color":new Ot(H.paint_sky["sky-atmosphere-color"]),"sky-opacity":new Ot(H.paint_sky["sky-opacity"])}),layout:nD};function N0(e,t,n){const r=[0,0,1],o=ki.identity([]);return ki.rotateY(o,o,n?-Oe(e)+Math.PI:Oe(e)),ki.rotateX(o,o,-Oe(t)),Z.transformQuat(r,r,o),Z.normalize(r,r)}var iD={paint:new gr({})};const oD={circle:class extends xo{constructor(e,t){super(e,RM,t)}createBucket(e){return new zm(e)}queryRadius(e){const t=e;return Rl("circle-radius",this,t)+Rl("circle-stroke-width",this,t)+js(this.paint.get("circle-translate"))}queryIntersectsFeature(e,t,n,r,o,s,c,u){const d=Gm(this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),s.angle,e.pixelToTileUnitsFactor),f=this.paint.get("circle-radius").evaluate(t,n)+this.paint.get("circle-stroke-width").evaluate(t,n);return $1(e,r,s,c,u,"map"===this.paint.get("circle-pitch-alignment"),"map"===this.paint.get("circle-pitch-scale"),d,f)}getProgramIds(){return["circle"]}getDefaultProgramParams(e,t){const n=G1(this);return{config:new lu(this,t),defines:n,overrideFog:!1}}},heatmap:class extends xo{createBucket(e){return new Iy(e)}constructor(e,t){super(e,Hm,t),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(e){"heatmap-color"===e&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=qm({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}queryRadius(e){return Rl("heatmap-radius",this,e)}queryIntersectsFeature(e,t,n,r,o,s,c,u){const d=this.paint.get("heatmap-radius").evaluate(t,n);return $1(e,r,s,c,u,!0,!0,new it(0,0),d)}hasOffscreenPass(){return 0!==this.paint.get("heatmap-opacity")&&"none"!==this.visibility}getProgramIds(){return["heatmap","heatmapTexture"]}getDefaultProgramParams(e,t){return"heatmap"===e?{config:new lu(this,t),overrideFog:!1}:{}}},hillshade:class extends xo{constructor(e,t){super(e,Sy,t)}hasOffscreenPass(){return 0!==this.paint.get("hillshade-exaggeration")&&"none"!==this.visibility}getProgramIds(){return["hillshade","hillshadePrepare"]}getDefaultProgramParams(e,t){return{overrideFog:!1}}},fill:class extends xo{constructor(e,t){super(e,Hh,t)}getProgramIds(){const e=this.paint.get("fill-pattern"),t=e&&e.constantOr(1),n=[t?"fillPattern":"fill"];return this.paint.get("fill-antialias")&&n.push(t&&!this.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline"),n}getDefaultProgramParams(e,t){return{config:new lu(this,t),overrideFog:!1}}recalculate(e,t){super.recalculate(e,t);const n=this.paint._values["fill-outline-color"];"constant"===n.value.kind&&void 0===n.value.value&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(e){return new Eu(e)}queryRadius(){return js(this.paint.get("fill-translate"))}queryIntersectsFeature(e,t,n,r,o,s){return!e.queryGeometry.isAboveHorizon&&AM(_u(e.tilespaceGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),s.angle,e.pixelToTileUnitsFactor),r)}isTileClipped(){return!0}},"fill-extrusion":class extends xo{constructor(e,t){super(e,Dw,t),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(e){return new Id(e)}queryRadius(){return js(this.paint.get("fill-extrusion-translate"))}is3D(){return!0}hasShadowPass(){return!0}cutoffRange(){return this.paint.get("fill-extrusion-cutoff-fade-range")}canCastShadows(){return!0}getProgramIds(){return[this.paint.get("fill-extrusion-pattern").constantOr(1)?"fillExtrusionPattern":"fillExtrusion"]}queryIntersectsFeature(e,t,n,r,o,s,c,u,d){const f=Gm(this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),s.angle,e.pixelToTileUnitsFactor),m=this.paint.get("fill-extrusion-height").evaluate(t,n),g=this.paint.get("fill-extrusion-base").evaluate(t,n),y=[0,0],v=u&&s.elevation,x=s.elevation?s.elevation.exaggeration():1,w=e.tile.getBucket(this);if(v&&w instanceof Id){const P=w.centroidVertexArray,C=d+1;C<P.length&&(y[0]=P.geta_centroid_pos0(C),y[1]=P.geta_centroid_pos1(C))}if(0===y[0]&&1===y[1])return!1;"globe"===s.projection.name&&(r=R0([r],[new it(0,0),new it(et,et)],e.tileID.canonical).map(P=>P.polygon).flat());const E=v?u:null,[M,D]=(C=r,R=g,k=m,N=f,z=c,B=E,U=y,$=x,W=s.center.lat,"globe"===(P=s).projection.name?function(K,Q,ot,Y,J,ct,dt,ht,_t,vt,xt){const mt=[],Ct=[],Ut=K.projection.upVectorScale(xt,K.center.lat,K.worldSize).metersToTile,Gt=[0,0,0,1],Yt=[0,0,0,1],te=(ue,dn,Ye,Ie)=>{ue[0]=dn,ue[1]=Ye,ue[2]=Ie,ue[3]=1},Me=P0();ot>0&&(ot+=Me),Y+=Me;for(const ue of Q){const dn=[],Ye=[];for(const Ie of ue){const we=Ie.x+J.x,fe=Ie.y+J.y,Ke=K.projection.projectTilePoint(we,fe,xt),rn=K.projection.upVector(xt,Ie.x,Ie.y);let Be=ot,yn=Y;if(dt){const Ir=O0(we,fe,ot,Y,dt,ht,_t,vt);Be+=Ir.base,yn+=Ir.top}0!==ot?te(Gt,Ke.x+rn[0]*Ut*Be,Ke.y+rn[1]*Ut*Be,Ke.z+rn[2]*Ut*Be):te(Gt,Ke.x,Ke.y,Ke.z),te(Yt,Ke.x+rn[0]*Ut*yn,Ke.y+rn[1]*Ut*yn,Ke.z+rn[2]*Ut*yn),Z.transformMat4(Gt,Gt,ct),Z.transformMat4(Yt,Yt,ct),dn.push(new Pc(Gt[0],Gt[1],Gt[2])),Ye.push(new Pc(Yt[0],Yt[1],Yt[2]))}mt.push(dn),Ct.push(Ye)}return[mt,Ct]}(P,C,R,k,N,z,B,U,$,W,e.tileID.canonical):B?function(K,Q,ot,Y,J,ct,dt,ht,_t){const vt=[],xt=[],mt=[0,0,0,1];for(const Ct of K){const Ut=[],Gt=[];for(const Yt of Ct){const te=Yt.x+Y.x,Me=Yt.y+Y.y,ue=O0(te,Me,Q,ot,ct,dt,ht,_t);mt[0]=te,mt[1]=Me,mt[2]=ue.base,mt[3]=1,En.transformMat4(mt,mt,J),mt[3]=Math.max(mt[3],1e-5);const dn=new Pc(mt[0]/mt[3],mt[1]/mt[3],mt[2]/mt[3]);mt[0]=te,mt[1]=Me,mt[2]=ue.top,mt[3]=1,En.transformMat4(mt,mt,J),mt[3]=Math.max(mt[3],1e-5);const Ye=new Pc(mt[0]/mt[3],mt[1]/mt[3],mt[2]/mt[3]);Ut.push(dn),Gt.push(Ye)}vt.push(Ut),xt.push(Gt)}return[vt,xt]}(C,R,k,N,z,B,U,$,W):function(K,Q,ot,Y,J){const ct=[],dt=[],ht=J[8]*Q,_t=J[9]*Q,vt=J[10]*Q,xt=J[11]*Q,mt=J[8]*ot,Ct=J[9]*ot,Ut=J[10]*ot,Gt=J[11]*ot;for(const Yt of K){const te=[],Me=[];for(const ue of Yt){const dn=ue.x+Y.x,Ye=ue.y+Y.y,Ie=J[0]*dn+J[4]*Ye+J[12],we=J[1]*dn+J[5]*Ye+J[13],fe=J[2]*dn+J[6]*Ye+J[14],Ke=J[3]*dn+J[7]*Ye+J[15],rn=Ie+ht,Be=we+_t,yn=fe+vt,Ir=Math.max(Ke+xt,1e-5),Sn=Ie+mt,Zn=we+Ct,Vr=fe+Ut,br=Math.max(Ke+Gt,1e-5);te.push(new Pc(rn/Ir,Be/Ir,yn/Ir)),Me.push(new Pc(Sn/br,Zn/br,Vr/br))}ct.push(te),dt.push(Me)}return[ct,dt]}(C,R,k,N,z)),A=e.queryGeometry;var P,C,R,k,N,z,B,U,$,W;return function(P,C,R){let k=1/0;AM(R,C)&&(k=L0(R,C[0]));for(let N=0;N<C.length;N++){const z=C[N],B=P[N];for(let U=0;U<z.length-1;U++){const $=z[U],W=[$,z[U+1],B[U+1],B[U],$];xy(R,W)&&(k=Math.min(k,L0(R,W)))}}return k!==1/0&&k}(M,D,A.isPointQuery()?A.screenBounds:A.screenGeometry)}},line:class extends xo{constructor(e,t){super(e,k0,t),this.gradientVersion=0}_handleSpecialPaintPropertyUpdate(e){if("line-gradient"===e){const t=this._transitionablePaint._values["line-gradient"].value.expression;this.stepInterpolant=t._styleExpression&&t._styleExpression.expression instanceof u_,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}widthExpression(){return this._transitionablePaint._values["line-width"].value.expression}recalculate(e,t){super.recalculate(e,t),this.paint._values["line-floorwidth"]=Ow.possiblyEvaluate(this._transitioningPaint._values["line-width"].value,e)}createBucket(e){return new _g(e)}getProgramIds(){return[this.paint.get("line-pattern").constantOr(1)?"linePattern":"line"]}getDefaultProgramParams(e,t){const n=Rw(this);return{config:new lu(this,t),defines:n,overrideFog:!1}}queryRadius(e){const t=e,n=kw(Rl("line-width",this,t),Rl("line-gap-width",this,t)),r=Rl("line-offset",this,t);return n/2+Math.abs(r)+js(this.paint.get("line-translate"))}queryIntersectsFeature(e,t,n,r,o,s){if(e.queryGeometry.isAboveHorizon)return!1;const c=_u(e.tilespaceGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),s.angle,e.pixelToTileUnitsFactor),u=e.pixelToTileUnitsFactor/2*kw(this.paint.get("line-width").evaluate(t,n),this.paint.get("line-gap-width").evaluate(t,n)),d=this.paint.get("line-offset").evaluate(t,n);return d&&(r=function(f,m){const g=[],y=new it(0,0);for(let v=0;v<f.length;v++){const x=f[v],w=[];for(let E=0;E<x.length;E++){const M=x[E],D=x[E+1],A=0===E?y:M.sub(x[E-1])._unit()._perp(),P=E===x.length-1?y:D.sub(M)._unit()._perp(),C=A._add(P)._unit();C._mult(1/(C.x*P.x+C.y*P.y)),w.push(C._mult(m)._add(M))}g.push(w)}return g}(r,d*e.pixelToTileUnitsFactor)),function(f,m,g){for(let y=0;y<m.length;y++){const v=m[y];if(f.length>=3)for(let x=0;x<v.length;x++)if(wc(f,v[x]))return!0;if(by(f,v,g))return!0}return!1}(c,r,u)}isTileClipped(){return!0}},symbol:ap,background:class extends xo{constructor(e,t){super(e,JI,t)}getProgramIds(){return[this.paint.get("background-pattern")?"backgroundPattern":"background"]}getDefaultProgramParams(e,t){return{overrideFog:!1}}},raster:class extends xo{constructor(e,t){super(e,tD,t),this._updateColorRamp()}getProgramIds(){return["raster"]}hasColorMap(){return!!this._transitionablePaint._values["raster-color"].value.value}isLayerDraped(e){return!(e&&e._source instanceof $s)||!e._source.onNorthPole&&!e._source.onSouthPole&&0===this.paint.get("raster-elevation")}_handleSpecialPaintPropertyUpdate(e){"raster-color"!==e&&"raster-color-range"!==e||this._updateColorRamp()}_updateColorRamp(){if(!this.hasColorMap())return;const e=this._transitionablePaint._values["raster-color"].value.expression,[t,n]=this._transitionablePaint._values["raster-color-range"].value.expression.evaluate({zoom:0});this.colorRamp=qm({expression:e,evaluationKey:"rasterValue",image:this.colorRamp,clips:[{start:t,end:n}],resolution:256}),this.colorRampTexture=null}},sky:class extends xo{constructor(e,t){super(e,rD,t),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(e){"sky-gradient"===e?this._updateColorRamp():"sky-atmosphere-sun"!==e&&"sky-atmosphere-halo-color"!==e&&"sky-atmosphere-color"!==e&&"sky-atmosphere-sun-intensity"!==e||(this._skyboxInvalidated=!0)}_updateColorRamp(){this.colorRamp=qm({expression:this._transitionablePaint._values["sky-gradient"].value.expression,evaluationKey:"skyRadialProgress"}),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}needsSkyboxCapture(e){if(this._skyboxInvalidated||!this.skyboxTexture||!this.skyboxGeometry)return!0;if(!this.paint.get("sky-atmosphere-sun")){const t=e.style.light.properties.get("position");return this._lightPosition.azimuthal!==t.azimuthal||this._lightPosition.polar!==t.polar}return!1}getCenter(e,t){if("atmosphere"===this.paint.get("sky-type")){const r=this.paint.get("sky-atmosphere-sun"),o=!r,s=e.style.light,c=s.properties.get("position");return o&&"viewport"===s.properties.get("anchor")&&nt("The sun direction is attached to a light with viewport anchor, lighting may behave unexpectedly."),o?N0(c.azimuthal,90-c.polar,t):N0(r[0],90-r[1],t)}const n=this.paint.get("sky-gradient-center");return N0(n[0],90-n[1],t)}isSky(){return!0}markSkyboxValid(e){this._skyboxInvalidated=!1,this._lightPosition=e.style.light.properties.get("position")}hasOffscreenPass(){return!0}getProgramIds(){const e=this.paint.get("sky-type");return"atmosphere"===e?["skyboxCapture","skybox"]:"gradient"===e?["skyboxGradient"]:null}},slot:class extends xo{constructor(e,t){super(e,iD)}},model:class extends xo{constructor(e,t){super(e,UI,t)}createBucket(e){return new jI(e)}getProgramIds(){return["model"]}is3D(){return!0}hasShadowPass(){return!0}canCastShadows(){return!0}hasLightBeamPass(){return!0}cutoffRange(){return this.paint.get("model-cutoff-fade-range")}queryRadius(){return 0}queryIntersectsFeature(){return!1}_handleOverridablePaintPropertyUpdate(e,t,n){return!(!this.layout||t.isDataDriven()||n.isDataDriven()||"model-color"!==e&&"model-color-mix-intensity"!==e&&"model-rotation"!==e&&"model-scale"!==e&&"model-translation"!==e&&"model-emissive-strength"!==e)}_isPropertyZoomDependent(e){const t=this._transitionablePaint._values[e];return null!=t&&null!=t.value&&null!=t.value.expression&&t.value.expression instanceof vl}isZoomDependent(){return this._isPropertyZoomDependent("model-scale")||this._isPropertyZoomDependent("model-rotation")||this._isPropertyZoomDependent("model-translation")}}};function Cg(e,t){return"custom"===e.type?new eD(e):new oD[e.type](e,t)}function Nw(e){const{userImage:t}=e;return!!(t&&t.render&&t.render())&&(e.data.replace(new Uint8Array(t.data.buffer)),!0)}class zw extends ye{constructor(){super(),this.images={},this.updatedImages={},this.callbackDispatchedThisFrame={},this.loaded={},this.requestors=[],this.patterns={},this.atlasImage={},this.atlasTexture={},this.dirty=!0}createScope(t){this.images[t]={},this.loaded[t]=!1,this.updatedImages[t]={},this.patterns[t]={},this.callbackDispatchedThisFrame[t]={},this.atlasImage[t]=new $r({width:1,height:1})}isLoaded(){for(const t in this.loaded)if(!this.loaded[t])return!1;return!0}setLoaded(t,n){if(this.loaded[n]!==t&&(this.loaded[n]=t,t)){for(const{ids:r,callback:o}of this.requestors)this._notify(r,n,o);this.requestors=[]}}hasImage(t,n){return!!this.getImage(t,n)}getImage(t,n){return this.images[n][t]}addImage(t,n,r){this._validate(t,r)&&(this.images[n][t]=r)}_validate(t,n){let r=!0;return this._validateStretch(n.stretchX,n.data&&n.data.width)||(this.fire(new Tt(new Error(`Image "${t}" has invalid "stretchX" value`))),r=!1),this._validateStretch(n.stretchY,n.data&&n.data.height)||(this.fire(new Tt(new Error(`Image "${t}" has invalid "stretchY" value`))),r=!1),this._validateContent(n.content,n)||(this.fire(new Tt(new Error(`Image "${t}" has invalid "content" value`))),r=!1),r}_validateStretch(t,n){if(!t)return!0;let r=0;for(const o of t){if(o[0]<r||o[1]<o[0]||n<o[1])return!1;r=o[1]}return!0}_validateContent(t,n){return!(t&&(4!==t.length||t[0]<0||n.data.width<t[0]||t[1]<0||n.data.height<t[1]||t[2]<0||n.data.width<t[2]||t[3]<0||n.data.height<t[3]||t[2]<t[0]||t[3]<t[1]))}updateImage(t,n,r){r.version=this.images[n][t].version+1,this.images[n][t]=r,this.updatedImages[n][t]=!0}removeImage(t,n){const r=this.images[n][t];delete this.images[n][t],delete this.patterns[n][t],r.userImage&&r.userImage.onRemove&&r.userImage.onRemove()}listImages(t){return Object.keys(this.images[t])}getImages(t,n,r){let o=!0;const s=!!this.loaded[n];if(!s)for(const c of t)this.images[n][c]||(o=!1);s||o?this._notify(t,n,r):this.requestors.push({ids:t,scope:n,callback:r})}getUpdatedImages(t){return this.updatedImages[t]}_notify(t,n,r){const o={};for(const s of t){this.images[n][s]||this.fire(new Mt("styleimagemissing",{id:s}));const c=this.images[n][s];c?o[s]={data:c.data.clone(),pixelRatio:c.pixelRatio,sdf:c.sdf,version:c.version,stretchX:c.stretchX,stretchY:c.stretchY,content:c.content,hasRenderCallback:!(!c.userImage||!c.userImage.render)}:nt(`Image "${s}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`)}r(null,o)}getPixelSize(t){const{width:n,height:r}=this.atlasImage[t];return{width:n,height:r}}getPattern(t,n){const r=this.patterns[n][t],o=this.getImage(t,n);if(!o)return null;if(r&&r.position.version===o.version)return r.position;if(r)r.position.version=o.version;else{const s={w:o.data.width+2,h:o.data.height+2,x:0,y:0},c=new Jy(s,o);this.patterns[n][t]={bin:s,position:c}}return this._updatePatternAtlas(n),this.patterns[n][t].position}bind(t,n){const r=t.gl;let o=this.atlasTexture[n];o?this.dirty&&(o.update(this.atlasImage[n]),this.dirty=!1):(o=new hr(t,this.atlasImage[n],r.RGBA),this.atlasTexture[n]=o),o.bind(r.LINEAR,r.CLAMP_TO_EDGE)}_updatePatternAtlas(t){const n=[];for(const c in this.patterns[t])n.push(this.patterns[t][c].bin);const{w:r,h:o}=ag(n),s=this.atlasImage[t];s.resize({width:r||1,height:o||1});for(const c in this.patterns[t]){const{bin:u}=this.patterns[t][c],d=u.x+1,f=u.y+1,m=this.images[t][c].data,g=m.width,y=m.height;$r.copy(m,s,{x:0,y:0},{x:d,y:f},{width:g,height:y}),$r.copy(m,s,{x:0,y:y-1},{x:d,y:f-1},{width:g,height:1}),$r.copy(m,s,{x:0,y:0},{x:d,y:f+y},{width:g,height:1}),$r.copy(m,s,{x:g-1,y:0},{x:d-1,y:f},{width:1,height:y}),$r.copy(m,s,{x:0,y:0},{x:d+g,y:f},{width:1,height:y})}this.dirty=!0}beginFrame(){for(const t in this.images)this.callbackDispatchedThisFrame[t]={}}dispatchRenderCallbacks(t,n){for(const r of t){if(this.callbackDispatchedThisFrame[n][r])continue;this.callbackDispatchedThisFrame[n][r]=!0;const o=this.images[n][r];Nw(o)&&this.updateImage(r,n,o)}}}const Bw=new gr({anchor:new Ot(H.light.anchor),position:new class{constructor(e){this.specification=e}possiblyEvaluate(e,t){return Jt(e.expression.evaluate(t))}interpolate(e,t,n){return{x:le(e.x,t.x,n),y:le(e.y,t.y,n),z:le(e.z,t.z,n),azimuthal:le(e.azimuthal,t.azimuthal,n),polar:le(e.polar,t.polar,n)}}}(H.light.position),color:new Ot(H.light.color),intensity:new Ot(H.light.intensity)});class z0 extends ye{constructor(t,n="flat"){super(),this._transitionable=new df(Bw),this.setLight(t,n),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(t,n,r={}){this._validate(JT,t,r)||(this._transitionable.setTransitionOrValue(t),this.id=n)}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}_validate(t,n,r){return(!r||!1!==r.validate)&&uf(this,t.call(bl,Wt({value:n,style:{glyphs:!0,sprite:!0},styleSpec:H})))}}const jw=new gr({source:new Ot(H.terrain.source),exaggeration:new Ot(H.terrain.exaggeration)});let Vw=class extends ye{constructor(e,t,n,r){super(),this.scope=n,this._transitionable=new df(jw,r),this._transitionable.setTransitionOrValue(e,r),this._transitioning=this._transitionable.untransitioned(),this.drapeRenderMode=t}get(){return this._transitionable.serialize()}set(e,t){this._transitionable.setTransitionOrValue(e,t)}updateTransitions(e){this._transitioning=this._transitionable.transitioned(e,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(e){this.properties=this._transitioning.possiblyEvaluate(e)}getExaggeration(e){return this._transitioning.possiblyEvaluate(new ar(e)).get("exaggeration")}isZoomDependent(){const e=this._transitionable._values.exaggeration;return null!=e&&null!=e.value&&null!=e.value.expression&&e.value.expression instanceof vl}};const B0=45,j0=65,Rc=.05;function vp(e,t,n,r){const o=Ro(B0,j0,n),[s,c]=V0(e,r);let u=1-Math.min(1,Math.exp((t-s)/(c-s)*-6));return u*=u*u,u=Math.min(1,1.00747*u),u*o*e.alpha}function V0(e,t){const n=.5/Math.tan(.5*t);return[e.range[0]+n,e.range[1]+n]}function Lc(e,t,n,r,o){const s=Z.transformMat4([],[t,n,r],o.mercatorFogMatrix);return vp(e,Z.length(s),o.pitch,o._fov)}function Uw(e,t,n,r,o,s,c){const u=[[n,r,0],[o,r,0],[o,s,0],[n,s,0]];let d=Number.MAX_VALUE,f=-Number.MAX_VALUE;for(const m of u){const g=Z.transformMat4([],m,t),y=Z.length(g);d=Math.min(d,y),f=Math.max(f,y)}return[vp(e,d,c.pitch,c._fov),vp(e,f,c.pitch,c._fov)]}const sD=new gr({range:new Ot(H.fog.range),color:new Ot(H.fog.color),"high-color":new Ot(H.fog["high-color"]),"space-color":new Ot(H.fog["space-color"]),"horizon-blend":new Ot(H.fog["horizon-blend"]),"star-intensity":new Ot(H.fog["star-intensity"]),"vertical-range":new Ot(H.fog["vertical-range"])});class Sd extends ye{constructor(t,n){super(),this._transitionable=new df(sD),this.set(t),this._transitioning=this._transitionable.untransitioned(),this._transform=n}get state(){const t=this._transform,n="globe"===t.projection.name,r=ri(t.zoom),o=this.properties.get("range"),s=[.5,3];return{range:n?[le(s[0],o[0],r),le(s[1],o[1],r)]:o,horizonBlend:this.properties.get("horizon-blend"),alpha:this.properties.get("color").a}}get(){return this._transitionable.serialize()}set(t,n={}){if(this._validate(ms,t,n))return;const r=Wt({},t);for(const o of Object.keys(H.fog))void 0===r[o]&&(r[o]=H.fog[o].default);this._transitionable.setTransitionOrValue(r)}getOpacity(t){if(!this._transform.projection.supportsFog)return 0;const n=this.properties&&this.properties.get("color")||1;return("globe"===this._transform.projection.name?1:Ro(B0,j0,t))*n.a}getOpacityAtLatLng(t,n){return this._transform.projection.supportsFog?function(r,o,s){const c=Qe.fromLngLat(o),u=s.elevation?s.elevation.getAtPointOrZero(c):0;return Lc(r,c.x,c.y,u,s)}(this.state,t,n):0}getOpacityForTile(t){if(!this._transform.projection.supportsFog)return[1,1];const n=this._transform.calculateFogTileMatrix(t.toUnwrapped());return Uw(this.state,n,0,0,et,et,this._transform)}getOpacityForBounds(t,n,r,o,s){return this._transform.projection.supportsFog?Uw(this.state,t,n,r,o,s,this._transform):[1,1]}getFovAdjustedRange(t){return this._transform.projection.supportsFog?V0(this.state,t):[0,1]}isVisibleOnFrustum(t){if(!this._transform.projection.supportsFog)return!1;const n=[4,5,6,7];for(const r of n){const o=t.points[r];let s;if(o[2]>=0)s=o;else{const c=t.points[r-4];s=ve(c,o,c[2]/(c[2]-o[2]))}if(Lc(this.state,s[0],s[1],0,this._transform)>=Rc)return!0}return!1}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}_validate(t,n,r){return(!r||!1!==r.validate)&&uf(this,t.call(bl,Wt({value:n,style:{glyphs:!0,sprite:!0},styleSpec:H})))}}class kC{constructor(t){this._callback=t,this._triggered=!1,typeof MessageChannel<"u"&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout(()=>{this._triggered=!1,this._callback()},0))}remove(){this._channel=void 0,this._callback=()=>{}}}class Do{constructor(){this.tasks={},this.taskQueue=[],ei(["process"],this),this.invoker=new kC(this.process),this.nextId=0}add(t,n){const r=this.nextId++,o=function({type:s,isSymbolTile:c,zoom:u}){return u=u||0,"message"===s?0:"maybePrepare"!==s||c?"parseTile"!==s||c?"parseTile"===s&&c?300-u:"maybePrepare"===s&&c?400-u:500:200-u:100-u}(n);if(0===o){Pt();try{t()}finally{}return{cancel:()=>{}}}return this.tasks[r]={fn:t,metadata:n,priority:o,id:r},this.taskQueue.push(r),this.invoker.trigger(),{cancel:()=>{delete this.tasks[r]}}}process(){Pt();try{if(this.taskQueue=this.taskQueue.filter(r=>!!this.tasks[r]),!this.taskQueue.length)return;const t=this.pick();if(null===t)return;const n=this.tasks[t];if(delete this.tasks[t],this.taskQueue.length&&this.invoker.trigger(),!n)return;n.fn()}finally{}}pick(){let t=null,n=1/0;for(let o=0;o<this.taskQueue.length;o++){const s=this.tasks[this.taskQueue[o]];s.priority<n&&(n=s.priority,t=o)}if(null===t)return null;const r=this.taskQueue[t];return this.taskQueue.splice(t,1),r}remove(){this.invoker.remove()}}class aD{constructor(t,n,r){this.target=t,this.parent=n,this.mapId=r,this.callbacks={},this.cancelCallbacks={},ei(["receive"],this),this.target.addEventListener("message",this.receive,!1),this.scheduler=new Do}send(t,n,r,o,s=!1,c){const u=Math.round(1e18*Math.random()).toString(36).substring(0,10);r&&(r.metadata=c,this.callbacks[u]=r);const d=new Set;return this.target.postMessage({id:u,type:t,hasCallback:!!r,targetMapId:o,mustQueue:s,sourceMapId:this.mapId,data:Sh(n,d)},d),{cancel:()=>{r&&delete this.callbacks[u],this.target.postMessage({id:u,type:"<cancel>",targetMapId:o,sourceMapId:this.mapId})}}}receive(t){const n=t.data,r=n.id;if(r&&(!n.targetMapId||this.mapId===n.targetMapId))if("<cancel>"===n.type){const o=this.cancelCallbacks[r];delete this.cancelCallbacks[r],o&&o.cancel()}else if(n.mustQueue||Pt()){const o=this.callbacks[r];this.cancelCallbacks[r]=this.scheduler.add(()=>this.processTask(r,n),o&&o.metadata||{type:"message"})}else this.processTask(r,n)}processTask(t,n){if("<response>"===n.type){const r=this.callbacks[t];delete this.callbacks[t],r&&(n.error?r(Qc(n.error)):r(null,Qc(n.data)))}else{const r=new Set,o=n.hasCallback?(c,u)=>{delete this.cancelCallbacks[t],this.target.postMessage({id:t,type:"<response>",sourceMapId:this.mapId,error:c?Sh(c):null,data:Sh(u,r)},r)}:c=>{},s=Qc(n.data);if(this.parent[n.type])this.parent[n.type](n.sourceMapId,s,o);else if(this.parent.getWorkerSource){const c=n.type.split(".");this.parent.getWorkerSource(n.sourceMapId,c[0],s.source,s.scope)[c[1]](s,o)}else o(new Error(`Could not find function ${n.type}`))}}remove(){this.scheduler.remove(),this.target.removeEventListener("message",this.receive,!1)}}let xp=(()=>{class e{constructor(n,r){this.workerPool=n,this.actors=[],this.currentActor=0,this.id=Dr();const o=this.workerPool.acquire(this.id);for(let s=0;s<o.length;s++){const c=new e.Actor(o[s],r,this.id);c.name=`Worker ${s}`,this.actors.push(c)}this.ready=!1,this.broadcast("checkIfReady",null,()=>{this.ready=!0})}broadcast(n,r,o){mo(this.actors,(s,c)=>{s.send(n,r,c)},o=o||function(){})}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach(n=>{n.remove()}),this.actors=[],this.workerPool.release(this.id)}}return e.Actor=aD,e})();class U0 extends ye{constructor(t,n,r,o){super(),this.scope=r,this._options=t,this.properties=new eu(n),this._transitionable=new df(n,new Map(o)),this._transitionable.setTransitionOrValue(t.properties),this._transitioning=this._transitionable.untransitioned()}updateConfig(t){this._transitionable.setTransitionOrValue(this._options.properties,new Map(t))}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}get(){return this._options.properties=this._transitionable.serialize(),this._options}set(t,n){this._options=t,this._transitionable.setTransitionOrValue(t.properties,n)}shadowsEnabled(){return!!this.properties&&!0===this.properties.get("cast-shadows")}}const FC=new gr({color:new Ot(H.properties_light_ambient.color),intensity:new Ot(H.properties_light_ambient.intensity)}),jr=new gr({direction:new class{constructor(e){this.specification=e}possiblyEvaluate(e,t){return function([n,r]){const o=Jt([1,n,r]);return{x:o.x,y:o.y,z:o.z}}(e.expression.evaluate(t))}interpolate(e,t,n){return{x:le(e.x,t.x,n),y:le(e.y,t.y,n),z:le(e.z,t.z,n)}}}(H.properties_light_directional.direction),color:new Ot(H.properties_light_directional.color),intensity:new Ot(H.properties_light_directional.intensity),"cast-shadows":new Ot(H.properties_light_directional["cast-shadows"]),"shadow-intensity":new Ot(H.properties_light_directional["shadow-intensity"])});class G0{constructor(t,n,r,o){this.screenBounds=t,this.cameraPoint=n,this._screenRaycastCache={},this._cameraRaycastCache={},this.isAboveHorizon=r,this.screenGeometry=this.bufferedScreenGeometry(0),this.screenGeometryMercator=this._bufferedScreenMercator(0,o)}static createFromScreenPoints(t,n){let r,o;if(t instanceof it||"number"==typeof t[0]){const s=it.convert(t);r=[s],o=n.isPointAboveHorizon(s)}else{const s=it.convert(t[0]),c=it.convert(t[1]);r=[s,c],o=xa(s,c).every(u=>n.isPointAboveHorizon(u))}return new G0(r,n.getCameraPoint(),o,n)}isPointQuery(){return 1===this.screenBounds.length}bufferedScreenGeometry(t){return xa(this.screenBounds[0],1===this.screenBounds.length?this.screenBounds[0]:this.screenBounds[1],t)}bufferedCameraGeometry(t){const n=this.screenBounds[0],r=1===this.screenBounds.length?this.screenBounds[0].add(new it(1,1)):this.screenBounds[1],o=xa(n,r,0,!1);return this.cameraPoint.y>r.y&&(this.cameraPoint.x>n.x&&this.cameraPoint.x<r.x?o.splice(3,0,this.cameraPoint):this.cameraPoint.x>=r.x?o[2]=this.cameraPoint:this.cameraPoint.x<=n.x&&(o[3]=this.cameraPoint)),function(s,c){const u=[];for(let d=0;d<s.length;d++){const f=Rr(d-1,-1,s.length-1),m=Rr(d+1,-1,s.length-1),g=s[d],y=s[m],v=s[f].sub(g).unit(),x=y.sub(g).unit(),w=x.angleWithSep(v.x,v.y),E=v.add(x).unit().mult(-1*c/Math.sin(w/2));u.push(g.add(E))}return u}(o,t)}bufferedCameraGeometryGlobe(t){const n=this.screenBounds[0],r=1===this.screenBounds.length?this.screenBounds[0].add(new it(1,1)):this.screenBounds[1],o=xa(n,r,t),s=this.cameraPoint.clone();switch(3*((s.y>n.y)+(s.y>r.y))+((s.x>n.x)+(s.x>r.x))){case 0:o[0]=s,o[4]=s.clone();break;case 1:o.splice(1,0,s);break;case 2:o[1]=s;break;case 3:o.splice(4,0,s);break;case 5:o.splice(2,0,s);break;case 6:o[3]=s;break;case 7:o.splice(3,0,s);break;case 8:o[2]=s}return o}containsTile(t,n,r,o=0){const s=t.queryPadding/n._pixelsPerMercatorPixel+1,c=r?this._bufferedCameraMercator(s,n):this._bufferedScreenMercator(s,n);let u=t.tileID.wrap+(c.unwrapped?o:0);const d=c.polygon.map(E=>od(t.tileTransform,E,u));if(!Vm(d,0,0,et,et))return;u=t.tileID.wrap+(this.screenGeometryMercator.unwrapped?o:0);const f=this.screenGeometryMercator.polygon.map(E=>e0(t.tileTransform,E,u)),m=f.map(E=>new it(E[0],E[1])),g=n.getFreeCameraOptions().position||new Qe(0,0,0),y=e0(t.tileTransform,g,u),v=f.map(E=>{const M=Z.sub(E,E,y);return Z.normalize(M,M),new Rm(y,M)}),x=Bu(t,1,n.zoom)*n._pixelsPerMercatorPixel;return{queryGeometry:this,tilespaceGeometry:m,tilespaceRays:v,bufferedTilespaceGeometry:d,bufferedTilespaceBounds:(w=ol(d),w.min.x=ne(w.min.x,0,et),w.min.y=ne(w.min.y,0,et),w.max.x=ne(w.max.x,0,et),w.max.y=ne(w.max.y,0,et),w),tile:t,tileID:t.tileID,pixelToTileUnitsFactor:x};var w}_bufferedScreenMercator(t,n){const r=Uu(t);if(this._screenRaycastCache[r])return this._screenRaycastCache[r];{let o;return o="globe"===n.projection.name?this._projectAndResample(this.bufferedScreenGeometry(t),n):{polygon:this.bufferedScreenGeometry(t).map(s=>n.pointCoordinate3D(s)),unwrapped:!0},this._screenRaycastCache[r]=o,o}}_bufferedCameraMercator(t,n){const r=Uu(t);if(this._cameraRaycastCache[r])return this._cameraRaycastCache[r];{let o;return o="globe"===n.projection.name?this._projectAndResample(this.bufferedCameraGeometryGlobe(t),n):{polygon:this.bufferedCameraGeometry(t).map(s=>n.pointCoordinate3D(s)),unwrapped:!0},this._cameraRaycastCache[r]=o,o}}_projectAndResample(t,n){const r=function(s,c){const u=st.multiply([],c.pixelMatrix,c.globeMatrix),d=[0,-To,0,1],f=[0,To,0,1],m=[0,0,0,1];En.transformMat4(d,d,u),En.transformMat4(f,f,u),En.transformMat4(m,m,u);const g=new it(d[0]/d[3],d[1]/d[3]),y=new it(f[0]/f[3],f[1]/f[3]),v=wc(s,g)&&d[3]<m[3],x=wc(s,y)&&f[3]<m[3];if(!v&&!x)return null;const w=function(k,N,z){for(let B=1;B<k.length;B++){const U=bp(N.pointCoordinate3D(k[B-1]).x),$=bp(N.pointCoordinate3D(k[B]).x);if(z<0){if(U<$)return{idx:B,t:-U/($-1-U)}}else if($<U)return{idx:B,t:(1-U)/($+1-U)}}return null}(s,c,v?-1:1);if(!w)return null;const{idx:E,t:M}=w;let D=E>1?$0(s.slice(0,E),c):[],A=E<s.length?$0(s.slice(E),c):[];D=D.map(k=>new it(bp(k.x),k.y)),A=A.map(k=>new it(bp(k.x),k.y));const P=[...D];0===P.length&&P.push(A[A.length-1]);const C=le(P[P.length-1].y,(0===A.length?D[0]:A[0]).y,M);let R;return R=v?[new it(0,C),new it(0,0),new it(1,0),new it(1,C)]:[new it(1,C),new it(1,1),new it(0,1),new it(0,C)],P.push(...R),0===A.length?P.push(D[0]):P.push(...A),{polygon:P.map(k=>new Qe(k.x,k.y)),unwrapped:!1}}(t,n);if(r)return r;const o=function(s,c){let u=!1,d=-1/0,f=0;for(let g=0;g<s.length-1;g++)s[g].x>d&&(d=s[g].x,f=g);for(let g=0;g<s.length-1;g++){const y=(f+g)%(s.length-1),v=s[y],x=s[y+1];Math.abs(v.x-x.x)>.5&&(v.x<x.x?(v.x+=1,0===y&&(s[s.length-1].x+=1)):(x.x+=1,y+1===s.length-1&&(s[0].x+=1)),u=!0)}const m=Br(c.center.lng);return u&&m<Math.abs(m-1)&&s.forEach(g=>{g.x-=1}),{polygon:s,unwrapped:u}}($0(t,n).map(s=>new it(bp(s.x),s.y)),n);return{polygon:o.polygon.map(s=>new Qe(s.x,s.y)),unwrapped:o.unwrapped}}}function $0(e,t){return B1(e,n=>{const r=t.pointCoordinate3D(n);n.x=r.x,n.y=r.y},1/256)}function bp(e){return e<0?1+e%1:e%1}function Uu(e){return 100*e|0}function H0(e,t,n,r,o){const s=function(c,u){if(c)return o(c);if(u){e.url&&u.tiles&&e.tiles&&delete e.tiles;const d=to(Wt(u,e),["tiles","minzoom","maxzoom","attribution","mapbox_logo","bounds","scheme","tileSize","encoding"]);u.vector_layers&&(d.vectorLayers=u.vector_layers,d.vectorLayerIds=d.vectorLayers.map(f=>f.id)),d.tiles=t.canonicalizeTileset(d,e.url),o(null,d)}};return e.url?zt(t.transformRequest(t.normalizeSourceURL(e.url,null,n,r),yt.Source),s):De.frame(()=>s(null,e))}class Gu{constructor(t,n,r){this.bounds=Oi.convert(this.validateBounds(t)),this.minzoom=n||0,this.maxzoom=r||24}validateBounds(t){return Array.isArray(t)&&4===t.length?[Math.max(-180,t[0]),Math.max(-90,t[1]),Math.min(180,t[2]),Math.min(90,t[3])]:[-180,-90,180,90]}contains(t){const n=Math.pow(2,t.z),r=Math.floor(Br(this.bounds.getWest())*n),o=Math.floor(ui(this.bounds.getNorth())*n),s=Math.ceil(Br(this.bounds.getEast())*n),c=Math.ceil(ui(this.bounds.getSouth())*n);return t.x>=r&&t.x<s&&t.y>=o&&t.y<c}}class wp{constructor(t,n){this.width=t,this.height=n,this.nextRow=0,this.image=new Ga({width:t,height:n}),this.positions={},this.uploaded=!1}getDash(t,n){const r=this.getKey(t,n);return this.positions[r]}trim(){const t=this.width,n=this.height=Fc(this.nextRow);this.image.resize({width:t,height:n})}getKey(t,n){return t.join(",")+n}getDashRanges(t,n,r){const o=[];let s=t.length%2==1?-t[t.length-1]*r:0,c=t[0]*r,u=!0;o.push({left:s,right:c,isDash:u,zeroLength:0===t[0]});let d=t[0];for(let f=1;f<t.length;f++){u=!u;const m=t[f];s=d*r,d+=m,c=d*r,o.push({left:s,right:c,isDash:u,zeroLength:0===m})}return o}addRoundDash(t,n,r){const o=n/2;for(let s=-r;s<=r;s++){const c=this.width*(this.nextRow+r+s);let u=0,d=t[u];for(let f=0;f<this.width;f++){f/d.right>1&&(d=t[++u]);const m=Math.abs(f-d.left),g=Math.abs(f-d.right),y=Math.min(m,g);let v;const x=s/r*(o+1);if(d.isDash){const w=o-Math.abs(x);v=Math.sqrt(y*y+w*w)}else v=o-Math.sqrt(y*y+x*x);this.image.data[c+f]=Math.max(0,Math.min(255,v+128))}}}addRegularDash(t,n){for(let d=t.length-1;d>=0;--d){const f=t[d],m=t[d+1];f.zeroLength?t.splice(d,1):m&&m.isDash===f.isDash&&(m.left=f.left,t.splice(d,1))}const r=t[0],o=t[t.length-1];r.isDash===o.isDash&&(r.left=o.left-this.width,o.right=r.right+this.width);const s=this.width*this.nextRow;let c=0,u=t[c];for(let d=0;d<this.width;d++){d/u.right>1&&(u=t[++c]);const f=Math.abs(d-u.left),m=Math.abs(d-u.right),g=Math.min(f,m);this.image.data[s+d]=Math.max(0,Math.min(255,(u.isDash?g:-g)+n+128))}}addDash(t,n){const r=this.getKey(t,n);if(this.positions[r])return this.positions[r];const o="round"===n,s=o?7:0,c=2*s+1;if(this.nextRow+c>this.height)return nt("LineAtlas out of space"),null;0===t.length&&t.push(1);let u=0;for(let m=0;m<t.length;m++)t[m]<0&&(nt("Negative value is found in line dasharray, replacing values with 0"),t[m]=0),u+=t[m];if(0!==u){const m=this.width/u,g=this.getDashRanges(t,this.width,m);o?this.addRoundDash(g,m,s):this.addRegularDash(g,"square"===n?.5*m:0)}const d=this.nextRow+s;this.nextRow+=c;const f={tl:[d,s],br:[u,0]};return this.positions[r]=f,f}}re(wp,"LineAtlas");const So=1*ws;class lD{constructor(t){const n={},r=[];for(const u in t){const d=t[u],f=n[u]={};for(const m in d.glyphs){const g=d.glyphs[+m];if(!g||0===g.bitmap.width||0===g.bitmap.height)continue;const y=g.metrics.localGlyph?So:1,v={x:0,y:0,w:g.bitmap.width+2*y,h:g.bitmap.height+2*y};r.push(v),f[m]=v}}const{w:o,h:s}=ag(r),c=new Ga({width:o||1,height:s||1});for(const u in t){const d=t[u];for(const f in d.glyphs){const m=d.glyphs[+f];if(!m||0===m.bitmap.width||0===m.bitmap.height)continue;const g=n[u][f],y=m.metrics.localGlyph?So:1;Ga.copy(m.bitmap,c,{x:0,y:0},{x:g.x+y,y:g.y+y},m.bitmap)}}this.image=c,this.positions=n}}re(lD,"GlyphAtlas");class Gw{constructor(t){this.tileID=new nn(t.tileID.overscaledZ,t.tileID.wrap,t.tileID.canonical.z,t.tileID.canonical.x,t.tileID.canonical.y),this.tileZoom=t.tileZoom,this.uid=t.uid,this.zoom=t.zoom,this.canonical=t.tileID.canonical,this.pixelRatio=t.pixelRatio,this.tileSize=t.tileSize,this.source=t.source,this.scope=t.scope,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=t.showCollisionBoxes,this.collectResourceTiming=!!t.collectResourceTiming,this.promoteId=t.promoteId,this.isSymbolTile=t.isSymbolTile,this.tileTransform=Pu(t.tileID.canonical,t.projection),this.projection=t.projection,this.brightness=t.brightness,this.extraShadowCaster=!!t.extraShadowCaster}parse(t,n,r,o,s){this.status="parsing",this.data=t,this.collisionBoxArray=new Fx;const c=new Vy(Object.keys(t.layers).sort()),u=new eg(this.tileID,this.promoteId);u.bucketLayerIDs=[];const d={},f=new wp(256,256),m={featureIndex:u,iconDependencies:{},patternDependencies:{},glyphDependencies:{},lineAtlas:f,availableImages:r,brightness:this.brightness},g=n.familiesBySource[this.source];for(const D in g){const A=t.layers[D];if(!A)continue;let P=!1,C=!1,R=!1;for(const z of g[D])"symbol"===z[0].type?P=!0:C=!0,z[0].is3D()&&"model"!==z[0].type&&(R=!0);if(this.extraShadowCaster&&!R||!0===this.isSymbolTile&&!P||!1===this.isSymbolTile&&!C)continue;1===A.version&&nt(`Vector tile source "${this.source}" layer "${D}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const k=c.encode(D),N=[];for(let z=0;z<A.length;z++){const B=A.feature(z),U=u.getId(B,D);N.push({feature:B,id:U,index:z,sourceLayerIndex:k})}for(const z of g[D]){const B=z[0];(!this.extraShadowCaster||B.is3D()&&"model"!==B.type)&&(void 0!==this.isSymbolTile&&"symbol"===B.type!==this.isSymbolTile||B.minzoom&&this.zoom<Math.floor(B.minzoom)||B.maxzoom&&this.zoom>=B.maxzoom||"none"!==B.visibility&&(Ag(z,this.zoom,m.brightness,r),(d[B.id]=B.createBucket({index:u.bucketLayerIDs.length,layers:z,zoom:this.zoom,canonical:this.canonical,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:k,sourceID:this.source,projection:this.projection.spec})).populate(N,m,this.tileID.canonical,this.tileTransform),u.bucketLayerIDs.push(z.map(U=>U.id))))}}let y,v,x,w;f.trim();const E={type:"maybePrepare",isSymbolTile:this.isSymbolTile,zoom:this.zoom},M=()=>{if(y)return this.status="done",s(y);if(this.extraShadowCaster)this.status="done",s(null,{buckets:_i(d).filter(D=>!D.isEmpty()),featureIndex:u,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:m.brightness,glyphMap:null,iconMap:null,glyphPositions:null});else if(v&&x&&w){const D=new lD(v),A=new Eb(x,w);for(const P in d){const C=d[P];C instanceof ud?(Ag(C.layers,this.zoom,m.brightness,r),Ab(C,v,D.positions,x,A.iconPositions,this.showCollisionBoxes,r,this.tileID.canonical,this.tileZoom,this.projection,this.brightness)):C.hasPattern&&(C instanceof _g||C instanceof Eu||C instanceof Id)&&(Ag(C.layers,this.zoom,m.brightness,r),C.addFeatures(m,this.tileID.canonical,A.patternPositions,r,this.tileTransform,this.brightness))}this.status="done",s(null,{buckets:_i(d).filter(P=>!P.isEmpty()),featureIndex:u,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:D.image,lineAtlas:f,imageAtlas:A,brightness:m.brightness})}};if(!this.extraShadowCaster){const D=Wl(m.glyphDependencies,C=>Object.keys(C).map(Number));Object.keys(D).length?o.send("getGlyphs",{uid:this.uid,stacks:D,scope:this.scope},(C,R)=>{y||(y=C,v=R,M())},void 0,!1,E):v={};const A=Object.keys(m.iconDependencies);A.length?o.send("getImages",{icons:A,source:this.source,scope:this.scope,tileID:this.tileID,type:"icons"},(C,R)=>{y||(y=C,x=R,M())},void 0,!1,E):x={};const P=Object.keys(m.patternDependencies);P.length?o.send("getImages",{icons:P,source:this.source,scope:this.scope,tileID:this.tileID,type:"patterns"},(C,R)=>{y||(y=C,w=R,M())},void 0,!1,E):w={}}M()}}function Ag(e,t,n,r){const o=new ar(t,{brightness:n});for(const s of e)s.recalculate(o,r)}class $w{constructor(t){this.entries={},this.scheduler=t}request(t,n,r,o){const s=this.entries[t]=this.entries[t]||{callbacks:[]};if(s.result){const[c,u]=s.result;return this.scheduler?this.scheduler.add(()=>{o(c,u)},n):o(c,u),()=>{}}return s.callbacks.push(o),s.cancel||(s.cancel=r((c,u)=>{s.result=[c,u];for(const d of s.callbacks)this.scheduler?this.scheduler.add(()=>{d(c,u)},n):d(c,u);setTimeout(()=>delete this.entries[t],3e3)})),()=>{s.result||(s.callbacks=s.callbacks.filter(c=>c!==o),s.callbacks.length||(s.cancel(),delete this.entries[t]))}}}function q0(e,t,n){const r=JSON.stringify(e.request);return e.data&&(this.deduped.entries[r]={result:[null,e.data]}),this.deduped.request(r,{type:"parseTile",isSymbolTile:e.isSymbolTile,zoom:e.tileZoom},o=>{const s=$t(e.request,(c,u,d,f)=>{c?o(c):u&&o(null,{vectorTile:n?void 0:new By(new Qm(u)),rawData:u,cacheControl:d,expires:f})});return()=>{s.cancel(),o()}},t)}class Z0 extends ye{constructor(t,n,r,o){if(super(),this.id=t,this.dispatcher=r,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,Wt(this,to(n,["url","scheme","tileSize","promoteId"])),this._options=Wt({type:"vector"},n),this._collectResourceTiming=!!n.collectResourceTiming,512!==this.tileSize)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(o),this._tileWorkers={},this._deduped=new $w}load(t){this._loaded=!1,this.fire(new Mt("dataloading",{dataType:"source"}));const n=Array.isArray(this.map._language)?this.map._language.join():this.map._language,r=this.map._worldview;this._tileJSONRequest=H0(this._options,this.map._requestManager,n,r,(o,s)=>{this._tileJSONRequest=null,this._loaded=!0,o?(n&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${n}`),r&&2!==r.length&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${r}`),this.fire(new Tt(o))):s&&(Wt(this,s),s.bounds&&(this.tileBounds=new Gu(s.bounds,this.minzoom,this.maxzoom)),Xd(s.tiles,this.map._requestManager._customAccessToken),this.fire(new Mt("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new Mt("data",{dataType:"source",sourceDataType:"content"}))),t&&t(o)})}loaded(){return this._loaded}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}onAdd(t){this.map=t,this.load()}reload(){this.cancelTileJSONRequest();const t=$i(this.id,this.scope);this.load(()=>this.map.style.clearSource(t))}setTiles(t){return this._options.tiles=t,this.reload(),this}setUrl(t){return this.url=t,this._options.url=t,this.reload(),this}onRemove(){this.cancelTileJSONRequest()}serialize(){return Wt({},this._options)}loadTile(t,n){const r=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme)),o={request:this.map._requestManager.transformRequest(r,yt.Tile),data:void 0,uid:t.uid,tileID:t.tileID,tileZoom:t.tileZoom,zoom:t.tileID.overscaledZ,tileSize:this.tileSize*t.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,pixelRatio:De.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:t.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:t.isExtraShadowCaster};if(o.request.collectResourceTiming=this._collectResourceTiming,t.actor&&"expired"!==t.state)"loading"===t.state?t.reloadCallback=n:t.request=t.actor.send("reloadTile",o,s.bind(this));else if(t.actor=this._tileWorkers[r]=this._tileWorkers[r]||this.dispatcher.getActor(),this.dispatcher.ready)t.request=t.actor.send("loadTile",o,s.bind(this),void 0,!0);else{const c=q0.call({deduped:this._deduped},o,(u,d)=>{u||!d?s.call(this,u):(o.data={cacheControl:d.cacheControl,expires:d.expires,rawData:d.rawData.slice(0)},t.actor&&t.actor.send("loadTile",o,s.bind(this),void 0,!0))},!0);t.request={cancel:c}}function s(c,u){return delete t.request,t.aborted?n(null):c&&404!==c.status?n(c):(u&&u.resourceTiming&&(t.resourceTiming=u.resourceTiming),this.map._refreshExpiredTiles&&u&&t.setExpiryData(u),t.loadVectorData(u,this.map.painter),Vi(this.dispatcher),n(null),void(t.reloadCallback&&(this.loadTile(t,t.reloadCallback),t.reloadCallback=null)))}}abortTile(t){t.request&&(t.request.cancel(),delete t.request),t.actor&&t.actor.send("abortTile",{uid:t.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(t){t.actor&&t.actor.send("removeTile",{uid:t.uid,type:this.type,source:this.id,scope:this.scope}),t.destroy()}hasTransition(){return!1}afterUpdate(){this._tileWorkers={}}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class Pg extends ye{constructor(t,n,r,o){super(),this.id=t,this.dispatcher=r,this.setEventedParent(o),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=Wt({type:"raster"},n),Wt(this,to(n,["url","scheme","tileSize"]))}load(t){this._loaded=!1,this.fire(new Mt("dataloading",{dataType:"source"})),this._tileJSONRequest=H0(this._options,this.map._requestManager,null,null,(n,r)=>{this._tileJSONRequest=null,this._loaded=!0,n?this.fire(new Tt(n)):r&&(Wt(this,r),r.bounds&&(this.tileBounds=new Gu(r.bounds,this.minzoom,this.maxzoom)),Xd(r.tiles),this.fire(new Mt("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new Mt("data",{dataType:"source",sourceDataType:"content"}))),t&&t(n)})}loaded(){return this._loaded}onAdd(t){this.map=t,this.load()}reload(){this.cancelTileJSONRequest();const t=$i(this.id,this.scope);this.load(()=>this.map.style.clearSource(t))}setTiles(t){return this._options.tiles=t,this.reload(),this}setUrl(t){return this.url=t,this._options.url=t,this.reload(),this}onRemove(){this.cancelTileJSONRequest()}serialize(){return Wt({},this._options)}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}loadTile(t,n){const r=De.devicePixelRatio>=2,o=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme),r,this.tileSize);t.request=xe(this.map._requestManager.transformRequest(o,yt.Tile),(s,c,u,d)=>(delete t.request,t.aborted?(t.state="unloaded",n(null)):s?(t.state="errored",n(s)):c?(this.map._refreshExpiredTiles&&t.setExpiryData({cacheControl:u,expires:d}),t.setTexture(c,this.map.painter),t.state="loaded",Vi(this.dispatcher),void n(null)):n(null)))}abortTile(t,n){t.request&&(t.request.cancel(),delete t.request),n()}unloadTile(t,n){t.texture&&t.texture instanceof hr?(t.destroy(!0),t.texture&&t.texture instanceof hr&&this.map.painter.saveTileTexture(t.texture)):t.destroy(),n()}hasTransition(){return!1}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}function Hw(){return null!=Fp.workerClass?new Fp.workerClass:new ft.Worker(Fp.workerUrl)}const W0="mapboxgl_preloaded_worker_pool";class Cd{constructor(){this.active={}}acquire(t){if(!this.workers)for(this.workers=[];this.workers.length<Cd.workerCount;)this.workers.push(new Hw);return this.active[t]=!0,this.workers.slice()}release(t){delete this.active[t],this.workers&&0===this.numActive()&&(this.workers.forEach(n=>{n.terminate()}),this.workers=null)}isPreloaded(){return!!this.active[W0]}numActive(){return Object.keys(this.active).length}}let Ep;function Nl(){return Ep||(Ep=new Cd),Ep}Cd.workerCount=2;let Rg,X0,pa,Ad=null;function Y0(){return Pt()&&self.worker&&self.worker.dracoUrl?self.worker.dracoUrl:X0||Te.DRACO_URL}const Lg=5123,Og=5126,K0={5120:Int8Array,5121:Uint8Array,5122:Int16Array,[Lg]:Uint16Array,5125:Uint32Array,[Og]:Float32Array},Tp={5120:"DT_INT8",5121:"DT_UINT8",5122:"DT_INT16",[Lg]:"DT_UINT16",5125:"DT_UINT32",[Og]:"DT_FLOAT32"},$u={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};function qw(e,t,n){const r=n.json.bufferViews.length,o=n.buffers.length;t.bufferView=r,n.json.bufferViews[r]={buffer:o,byteLength:e.byteLength},n.buffers[o]=e}const J0="KHR_draco_mesh_compression";function cD(e,t){const n=e.extensions&&e.extensions[J0];if(!n)return;const r=new pa.Decoder,o=nv(t,n.bufferView),s=new pa.Mesh;if(!r.DecodeArrayToMesh(o,o.byteLength,s))throw new Error("Failed to decode Draco mesh");const c=t.json.accessors[e.indices],u=K0[c.componentType],d=c.count*u.BYTES_PER_ELEMENT,f=pa._malloc(d);u===Uint16Array?r.GetTrianglesUInt16Array(s,d,f):r.GetTrianglesUInt32Array(s,d,f),qw(pa.memory.buffer.slice(f,f+d),c,t),pa._free(f);for(const m of Object.keys(n.attributes)){const g=r.GetAttributeByUniqueId(s,n.attributes[m]),y=t.json.accessors[e.attributes[m]],v=Tp[y.componentType],x=y.count*$u[y.type]*K0[y.componentType].BYTES_PER_ELEMENT,w=pa._malloc(x);r.GetAttributeDataArrayForAllPoints(s,g,pa[v],x,w),qw(pa.memory.buffer.slice(w,w+x),y,t),pa._free(w)}r.destroy(),s.destroy(),delete e.extensions[J0]}const Q0=1179937895,tv=new TextDecoder("utf8");function ev(e,t){return new URL(e,t).href}function uD(e,t,n,r){return fetch(ev(e.uri,r)).then(o=>o.arrayBuffer()).then(o=>{t.buffers[n]=o})}function nv(e,t){const n=e.json.bufferViews[t];return new Uint8Array(e.buffers[n.buffer],n.byteOffset||0,n.byteLength)}function hD(e,t,n,r){if(e.uri){const o=ev(e.uri,r);return fetch(o).then(s=>s.blob()).then(s=>ft.createImageBitmap(s)).then(s=>{t.images[n]=s})}if(void 0!==e.bufferView){const o=nv(t,e.bufferView),s=new ft.Blob([o],{type:e.mimeType});return ft.createImageBitmap(s).then(c=>{t.images[n]=c})}}function Zw(e,t=0,n){const r={json:null,images:[],buffers:[]};if(new Uint32Array(e,t,1)[0]===Q0){const f=new Uint32Array(e,t);let m=2;const g=(f[m++]>>2)-3,y=f[m++]>>2;if(m++,r.json=JSON.parse(tv.decode(f.subarray(m,m+y))),m+=y,m<g){const v=f[m++];m++;const x=t+(m<<2);r.buffers[0]=e.slice(x,x+v)}}else r.json=JSON.parse(tv.decode(new Uint8Array(e,t)));const{buffers:o,images:s,meshes:c,extensionsUsed:u}=r.json;let d=Promise.resolve();if(o){const f=[];for(let m=0;m<o.length;m++){const g=o[m];g.uri?f.push(uD(g,r,m,n)):r.buffers[m]||(r.buffers[m]=null)}d=Promise.all(f)}return d.then(()=>{const f=[],m=u&&u.includes(J0);if(m&&f.push(function(){if(!pa)return Rg||(Rg=function(g){let y,v=null;function x(){y=new Uint8Array(v.buffer)}function w(){throw new Error("Unexpected Draco error.")}const E={a:{a:w,d:function(M,D,A){return y.copyWithin(M,D,D+A)},c:function(M){const D=y.length,A=Math.max(M>>>0,Math.ceil(1.2*D)),P=Math.ceil((A-D)/65536);try{return v.grow(P),x(),!0}catch{return!1}},b:w}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(g,E):g.then(M=>M.arrayBuffer()).then(M=>WebAssembly.instantiate(M,E))).then(M=>{const{Rb:D,Qb:A,P,T:C,X:R,Ja:k,La:N,Qa:z,Va:B,Wa:U,eb:$,jb:W,f:V,e:K,yb:Q,zb:ot,Ab:Y,Bb:J,Db:ct,Gb:dt}=M.instance.exports;v=K;const ht=(()=>{let _t=0,vt=0,xt=0,mt=0;return Ct=>{xt&&(D(mt),D(_t),vt+=xt,xt=_t=0),_t||(vt+=128,_t=A(vt));const Ut=Ct.length+7&-8;let Gt=_t;Ut>=vt&&(xt=Ut,Gt=mt=A(Ut));for(let Yt=0;Yt<Ct.length;Yt++)y[Gt+Yt]=Ct[Yt];return Gt}})();return x(),V(),{memory:K,_free:D,_malloc:A,Mesh:class{constructor(){this.ptr=P()}destroy(){C(this.ptr)}},Decoder:class{constructor(){this.ptr=k()}destroy(){W(this.ptr)}DecodeArrayToMesh(_t,vt,xt){const mt=ht(_t),Ct=N(this.ptr,mt,vt,xt.ptr);return!!R(Ct)}GetAttributeByUniqueId(_t,vt){return{ptr:z(this.ptr,_t.ptr,vt)}}GetTrianglesUInt16Array(_t,vt,xt){B(this.ptr,_t.ptr,vt,xt)}GetTrianglesUInt32Array(_t,vt,xt){U(this.ptr,_t.ptr,vt,xt)}GetAttributeDataArrayForAllPoints(_t,vt,xt,mt,Ct){$(this.ptr,_t.ptr,vt.ptr,xt,mt,Ct)}},DT_INT8:Q(),DT_UINT8:ot(),DT_INT16:Y(),DT_UINT16:J(),DT_UINT32:ct(),DT_FLOAT32:dt()}})}(fetch(Y0())),Rg.then(g=>{pa=g,Rg=void 0}))}()),s)for(let g=0;g<s.length;g++)f.push(hD(s[g],r,g,n));return(f.length?Promise.all(f):Promise.resolve()).then(()=>{if(m&&c)for(const{primitives:g}of c)for(const y of g)cD(y,r);return r})})}function dD(e){return fetch(e).then(t=>t.arrayBuffer()).then(t=>Zw(t,0,e))}class fD{constructor(t,n,r){if(this.triangleCount=n.length/3,this.min=new it(0,0),this.max=new it(0,0),this.xScale=0,this.yScale=0,this.cellsX=0,this.cellsY=0,this.cells=[],this.payload=[],0===this.triangleCount||0===t.length||0===r)return;const o=t.map(m=>m.x),s=t.map(m=>m.y);this.min=new it(Math.min(...o),Math.min(...s)),this.max=new it(Math.max(...o),Math.max(...s));const c=this.max.sub(this.min);c.x=Math.max(c.x,1),c.y=Math.max(c.y,1);const u=Math.max(c.x,c.y)/r;this.cellsX=Math.max(1,Math.ceil(c.x/u)),this.cellsY=Math.max(1,Math.ceil(c.y/u)),this.xScale=1/u,this.yScale=1/u;const d=[];for(let m=0;m<this.triangleCount;m++){const g=t[n[3*m+0]].sub(this.min),y=t[n[3*m+1]].sub(this.min),v=t[n[3*m+2]].sub(this.min),x=Hu(Math.floor(Math.min(g.x,y.x,v.x)),this.xScale,this.cellsX),w=Hu(Math.floor(Math.max(g.x,y.x,v.x)),this.xScale,this.cellsX),E=Hu(Math.floor(Math.min(g.y,y.y,v.y)),this.yScale,this.cellsY),M=Hu(Math.floor(Math.max(g.y,y.y,v.y)),this.yScale,this.cellsY),D=new it(0,0),A=new it(0,0),P=new it(0,0),C=new it(0,0);for(let R=E;R<=M;++R){D.y=A.y=R*u,P.y=C.y=(R+1)*u;for(let k=x;k<=w;++k)D.x=P.x=k*u,A.x=C.x=(k+1)*u,(Hf(g,y,v,D,A,C)||Hf(g,y,v,D,C,P))&&d.push({cellIdx:R*this.cellsX+k,triIdx:m})}}if(0===d.length)return;d.sort((m,g)=>m.cellIdx-g.cellIdx||m.triIdx-g.triIdx);let f=0;for(;f<d.length;){const m=d[f].cellIdx,g={start:this.payload.length,len:0};for(;f<d.length&&d[f].cellIdx===m;)++g.len,this.payload.push(d[f++].triIdx);this.cells[m]=g}}query(t,n,r){if(0===this.triangleCount||0===this.cells.length||t.x>this.max.x||this.min.x>n.x||t.y>this.max.y||this.min.y>n.y)return;this.lookup||(this.lookup=new Uint8Array(Math.ceil(this.triangleCount/8)));for(let d=0;d<this.lookup.length;d++)this.lookup[d]=0;const o=Hu(t.x-this.min.x,this.xScale,this.cellsX),s=Hu(n.x-this.min.x,this.xScale,this.cellsX),c=Hu(t.y-this.min.y,this.yScale,this.cellsY),u=Hu(n.y-this.min.y,this.yScale,this.cellsY);for(let d=c;d<=u;d++)for(let f=o;f<=s;f++){const m=this.cells[d*this.cellsX+f];if(m)for(let g=0;g<m.len;g++){const y=this.payload[m.start+g],v=Math.floor(y/8),x=1<<y%8;if(!(this.lookup[v]&x)&&(this.lookup[v]|=x,r.push(y),r.length===this.triangleCount))return}}}}function Hu(e,t,n){return Math.max(0,Math.min(n-1,Math.floor(e*t)))}function Pd(e,t){const n=e.json.bufferViews[t.bufferView];return new K0[t.componentType](e.buffers[n.buffer],(t.byteOffset||0)+(n.byteOffset||0),t.count*$u[t.type])}function Ww(e,t,n){const r=e.indices,o=e.attributes,s={};s.indexArray=new Kr;const c=t.json.accessors[r],u=c.count/3;s.indexArray.reserve(u);const d=Pd(t,c);for(let y=0;y<u;y++)s.indexArray.emplaceBack(d[3*y],d[3*y+1],d[3*y+2]);s.indexArray._trim(),s.vertexArray=new Ml;const f=t.json.accessors[o.POSITION];s.vertexArray.reserve(f.count);const m=Pd(t,f);for(let y=0;y<f.count;y++)s.vertexArray.emplaceBack(m[3*y],m[3*y+1],m[3*y+2]);if(s.vertexArray._trim(),s.aabb=new Bn(f.min,f.max),s.centroid=function(y,v){const x=[0,0,0],w=y.length;if(w>0){for(let E=0;E<w;E++){const M=3*y[E];x[0]+=v[M],x[1]+=v[M+1],x[2]+=v[M+2]}x[0]/=w,x[1]/=w,x[2]/=w}return x}(d,m),void 0!==o.COLOR_0){const y=t.json.accessors[o.COLOR_0],v=$u[y.type];if(y.componentType===Og){s.colorArray=3===v?new Ml:new Fs,s.colorArray.reserve(y.count);const x=Pd(t,y);if(3===v)for(let w=0;w<y.count;w++)s.colorArray.emplaceBack(x[3*w],x[3*w+1],x[3*w+2]);else for(let w=0;w<y.count;w++)s.colorArray.emplaceBack(x[4*w],x[4*w+1],x[4*w+2],x[4*w+3]);s.colorArray._trim()}else if(y.componentType===Lg&&4===v){s.colorArray=new Fs,s.colorArray.resize(y.count);const x=Pd(t,y),w=1/65535,E=s.colorArray.float32;for(let M=0;M<4*x.length;++M)E[M]=x[M]*w}else nt(`glTF color buffer parsing for accessor ${JSON.stringify(y)} is not supported`)}if(void 0!==o.NORMAL){s.normalArray=new Ml;const y=t.json.accessors[o.NORMAL];s.normalArray.reserve(y.count);const v=Pd(t,y);for(let x=0;x<y.count;x++)s.normalArray.emplaceBack(v[3*x],v[3*x+1],v[3*x+2]);s.normalArray._trim()}if(void 0!==o.TEXCOORD_0&&n.length>0){s.texcoordArray=new Il;const y=t.json.accessors[o.TEXCOORD_0];s.texcoordArray.reserve(y.count);const v=Pd(t,y);for(let x=0;x<y.count;x++)s.texcoordArray.emplaceBack(v[2*x],v[2*x+1]);s.texcoordArray._trim()}const g=e.material;return s.material=function(y,v){const{emissiveFactor:x=[0,0,0],alphaMode:w="OPAQUE",alphaCutoff:E=.5,normalTexture:M,occlusionTexture:D,emissiveTexture:A,doubleSided:P}=y,{baseColorFactor:C=[1,1,1,1],metallicFactor:R=1,roughnessFactor:k=1,baseColorTexture:N,metallicRoughnessTexture:z}=y.pbrMetallicRoughness||{};return{pbrMetallicRoughness:{baseColorFactor:new ke(...C),metallicFactor:R,roughnessFactor:k,baseColorTexture:N?v[N.index]:void 0,metallicRoughnessTexture:z?v[z.index]:void 0},doubleSided:P,emissiveFactor:x,alphaMode:w,alphaCutoff:E,normalTexture:M?v[M.index]:void 0,occlusionTexture:D?v[D.index]:void 0,emissionTexture:A?v[A.index]:void 0,defined:void 0===y.defined}}(void 0!==g?t.json.materials[g]:{defined:!1},n),void 0!==o._FEATURE_RGBA4444&&(s.featureData=new Uint32Array(Pd(t,t.json.accessors[o._FEATURE_RGBA4444]).buffer)),s}function Mp(e,t,n){const{matrix:r,rotation:o,translation:s,scale:c,mesh:u,extras:d,children:f}=e,m={};if(m.matrix=r||st.fromRotationTranslationScale([],o||[0,0,0,1],s||[0,0,0],c||[1,1,1]),void 0!==u){m.meshes=n[u];const g=m.anchor=[0,0];for(const y of m.meshes){const{min:v,max:x}=y.aabb;g[0]+=v[0]+x[0],g[1]+=v[1]+x[1]}g[0]=Math.floor(g[0]/m.meshes.length/2),g[1]=Math.floor(g[1]/m.meshes.length/2)}if(d&&(d.id&&(m.id=d.id),d.lights&&(m.lights=function(g){if(!g.length)return[];const y=function(M){const D=atob(M),A=new Uint8Array(D.length);for(let P=0;P<D.length;P++)A[P]=D.codePointAt(P);return A}(g),v=[],x=y.length/24,w=new Uint16Array(y.buffer),E=new Float32Array(y.buffer);for(let M=0;M<x;M++){const D=w[2*M*6]/30,A=w[2*M*6+1]/30,P=w[2*M*6+10]/100,C=E[6*M+1],R=E[6*M+2],k=E[6*M+3],N=E[6*M+4],z=k-C,B=N-R,U=Math.hypot(z,B);v.push({pos:[C+.5*z,R+.5*B,A],normal:[B/U,-z/U,0],width:U,height:D,depth:P,points:[C,R,k,N]})}return v}(d.lights))),f){const g=[];for(const y of f)g.push(Mp(t.json.nodes[y],t,n));m.children=g}return m}function pD(e){if(0===e.vertices.length||0===e.indices.length)return null;const[t,n]=[e.vertices[0].clone(),e.vertices[0].clone()];for(let c=1;c<e.vertices.length;++c){const u=e.vertices[c];t.x=Math.min(t.x,u.x),t.y=Math.min(t.y,u.y),n.x=Math.max(n.x,u.x),n.y=Math.max(n.y,u.y)}const r=Math.ceil(Math.max(n.x-t.x,n.y-t.y)/256),o=Math.max(8,r),s=new fD(e.vertices,e.indices,o);return{vertices:e.vertices,indices:e.indices,grid:s,min:t,max:n}}function mD(e){if(!e.extras||!e.extras.ground)return null;const t=e.extras.ground;if(!t||!Array.isArray(t)||0===t.length)return null;const n=t[0];if(!n||!Array.isArray(n)||0===n.length)return null;const r=[];for(const c of n){if(!Array.isArray(c)||2!==c.length)continue;const u=c[0],d=c[1];"number"==typeof u&&"number"==typeof d&&r.push(new it(u,d))}if(r.length<3)return null;r.length>1&&r[r.length-1].equals(r[0])&&r.pop();let o=0;for(let c=0;c<r.length;c++){const u=r[c],d=r[(c+1)%r.length],f=r[(c+2)%r.length];o+=(u.x-d.x)*(f.y-d.y)-(f.x-d.x)*(u.y-d.y)}o>0&&r.reverse();const s=Xf(r.flatMap(c=>[c.x,c.y]),[]);return 0===s.length?null:{vertices:r,indices:s}}function Xw(e){const t=[],n=[];let r=0;for(const o of e){r=t.length;const s=o.vertexArray.float32,c=o.indexArray.uint16;for(let u=0;u<o.vertexArray.length;u++)t.push(new it(s[3*u+0],s[3*u+1]));for(let u=0;u<3*o.indexArray.length;u++)n.push(c[u]+r)}if(n.length%3!=0)return null;for(let o=0;o<n.length;o+=3){const s=t[n[o+0]],c=t[n[o+1]],u=t[n[o+2]];(s.x-c.x)*(u.y-c.y)-(u.x-c.x)*(s.y-c.y)>0&&([n[o+1],n[o+2]]=[n[o+2],n[o+1]])}return{vertices:t,indices:n}}function qu(e){const n=function(d,f){const m=[];for(const g of d.json.meshes){const y=[];for(const v of g.primitives)y.push(Ww(v,d,f));m.push(y)}return m}(e,function(d,f){const m=[],g=ft.WebGL2RenderingContext;if(d.json.textures)for(const y of d.json.textures){const v={magFilter:g.LINEAR,minFilter:g.NEAREST,wrapS:g.REPEAT,wrapT:g.REPEAT};void 0!==y.sampler&&Object.assign(v,d.json.samplers[y.sampler]),m.push({image:f[y.source],sampler:v,uploaded:!1})}return m}(e,e.images)),{scenes:r,scene:o,nodes:s}=e.json,c=r?r[o||0].nodes:s,u=[];for(const d of c)u.push(Mp(s[d],e,n));return function(d,f,m){const g={},y=new Set;for(let v=0;v<d.length;v++){const x=m[f[v]];if(!x.extras)continue;const w=x.extras["mapbox:footprint:version"],E=x.extras["mapbox:footprint:id"];(w||E)&&y.add(v),"1.0.0"===w&&E&&(g[E]=v)}for(let v=0;v<d.length;v++){if(y.has(v))continue;const x=d[v],w=m[f[v]];if(!w.extras)continue;let E=null;x.id in g&&(E=Xw(d[g[x.id]].meshes)),E||(E=mD(w)),E&&(x.footprint=pD(E))}if(y.size>0){const v=Array.from(y.values()).sort((x,w)=>x-w);for(let x=v.length-1;x>=0;x--)d.splice(v[x],1)}}(u,c,e.json.nodes),u}function gD(e){e.heightmap=new Float32Array(4096),e.heightmap.fill(-1);const t=e.vertexArray.float32,n=e.aabb.min[0]-1,r=e.aabb.min[1]-1,o=64/(e.aabb.max[0]-n+2),s=64/(e.aabb.max[1]-r+2);for(let c=0;c<t.length;c+=3){const u=t[c+2],d=(t[c+0]-n)*o|0,f=(t[c+1]-r)*s|0;u>e.heightmap[64*f+d]&&(e.heightmap[64*f+d]=u)}}function _D(e,t){const n={};n.indexArray=new Kr,n.indexArray.reserve(4*e.length),n.vertexArray=new Ml,n.vertexArray.reserve(10*e.length),n.colorArray=new Fs,n.vertexArray.reserve(10*e.length);let r=0;for(const c of e){const u=Math.min(10,Math.max(4,1.3*c.height))*t,d=[-c.normal[1],c.normal[0],0],f=Math.min(.29,.1*c.width/c.depth),m=c.width-2*c.depth*t*(f+.01),g=Z.scaleAndAdd([],c.pos,d,m/2),y=Z.scaleAndAdd([],c.pos,d,-m/2),v=[g[0],g[1],g[2]+c.height],x=[y[0],y[1],y[2]+c.height],w=Z.scaleAndAdd([],c.normal,d,f);Z.scale(w,w,u);const E=Z.scaleAndAdd([],c.normal,d,-f);Z.scale(E,E,u),Z.add(w,g,w),Z.add(E,y,E),g[2]+=.1,y[2]+=.1,n.vertexArray.emplaceBack(w[0],w[1],w[2]),n.vertexArray.emplaceBack(E[0],E[1],E[2]),n.vertexArray.emplaceBack(g[0],g[1],g[2]),n.vertexArray.emplaceBack(y[0],y[1],y[2]),n.vertexArray.emplaceBack(v[0],v[1],v[2]),n.vertexArray.emplaceBack(x[0],x[1],x[2]),n.vertexArray.emplaceBack(g[0],g[1],g[2]),n.vertexArray.emplaceBack(y[0],y[1],y[2]),n.vertexArray.emplaceBack(w[0],w[1],w[2]),n.vertexArray.emplaceBack(E[0],E[1],E[2]);const M=m/u/2;n.colorArray.emplaceBack(-M-f,-1,M,.8),n.colorArray.emplaceBack(M+f,-1,M,.8),n.colorArray.emplaceBack(-M,0,M,1.3),n.colorArray.emplaceBack(M,0,M,1.3),n.colorArray.emplaceBack(M+f,-.8,M,.7),n.colorArray.emplaceBack(M+f,-.8,M,.7),n.colorArray.emplaceBack(0,0,M,1.3),n.colorArray.emplaceBack(0,0,M,1.3),n.colorArray.emplaceBack(M+f,-1.2,M,.8),n.colorArray.emplaceBack(M+f,-1.2,M,.8),n.indexArray.emplaceBack(6+r,4+r,8+r),n.indexArray.emplaceBack(7+r,9+r,5+r),n.indexArray.emplaceBack(0+r,1+r,2+r),n.indexArray.emplaceBack(1+r,3+r,2+r),r+=10}const o={defined:!0,emissiveFactor:[0,0,0]},s={};return s.baseColorFactor=ke.white,o.pbrMetallicRoughness=s,n.material=o,n.aabb=new Bn([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),n}re(fD,"TriangleGridIndex");const rv={vector:Z0,raster:Pg,"raster-dem":class extends Pg{constructor(e,t,n,r){super(e,t,n,r),this.type="raster-dem",this.maxzoom=22,this._options=Wt({type:"raster-dem"},t),this.encoding=t.encoding||"mapbox"}loadTile(e,t){const n=this.map._requestManager.normalizeTileURL(e.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize);function r(o,s){o&&(e.state="errored",t(o)),s&&(e.dem=s,e.dem.onDeserialize(),e.needsHillshadePrepare=!0,e.needsDEMTextureUpload=!0,e.state="loaded",t(null))}e.request=xe(this.map._requestManager.transformRequest(n,yt.Tile),function(o,s,c,u){if(delete e.request,e.aborted)e.state="unloaded",t(null);else if(o)e.state="errored",t(o);else if(s){this.map._refreshExpiredTiles&&e.setExpiryData({cacheControl:c,expires:u});const f=ft.ImageBitmap&&s instanceof ft.ImageBitmap&&ef(),m=1-(s.width-((d=s.width)<=1?1:Math.pow(2,Math.floor(Math.log(d)/Math.LN2))))/2;m<1||e.neighboringTiles||(e.neighboringTiles=this._getNeighboringTiles(e.tileID));const g=f?s:De.getImageData(s,m),y={uid:e.uid,coord:e.tileID,source:this.id,scope:this.scope,rawImageData:g,encoding:this.encoding,padding:m};e.actor&&"expired"!==e.state||(e.actor=this.dispatcher.getActor(),e.actor.send("loadDEMTile",y,r.bind(this),void 0,!0))}var d}.bind(this))}_getNeighboringTiles(e){const t=e.canonical,n=Math.pow(2,t.z),r=(t.x-1+n)%n,o=0===t.x?e.wrap-1:e.wrap,s=(t.x+1+n)%n,c=t.x+1===n?e.wrap+1:e.wrap,u={};return u[new nn(e.overscaledZ,o,t.z,r,t.y).key]={backfilled:!1},u[new nn(e.overscaledZ,c,t.z,s,t.y).key]={backfilled:!1},t.y>0&&(u[new nn(e.overscaledZ,o,t.z,r,t.y-1).key]={backfilled:!1},u[new nn(e.overscaledZ,e.wrap,t.z,t.x,t.y-1).key]={backfilled:!1},u[new nn(e.overscaledZ,c,t.z,s,t.y-1).key]={backfilled:!1}),t.y+1<n&&(u[new nn(e.overscaledZ,o,t.z,r,t.y+1).key]={backfilled:!1},u[new nn(e.overscaledZ,e.wrap,t.z,t.x,t.y+1).key]={backfilled:!1},u[new nn(e.overscaledZ,c,t.z,s,t.y+1).key]={backfilled:!1}),u}},geojson:class extends ye{constructor(e,t,n,r){super(),this.id=e,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._loaded=!1,this.actor=n.getActor(),this.setEventedParent(r),this._data=t.data,this._options=Wt({},t),this._collectResourceTiming=t.collectResourceTiming,void 0!==t.maxzoom&&(this.maxzoom=t.maxzoom),t.type&&(this.type=t.type),t.attribution&&(this.attribution=t.attribution),this.promoteId=t.promoteId;const o=et/this.tileSize;this.workerOptions=Wt({source:this.id,scope:this.scope,cluster:t.cluster||!1,geojsonVtOptions:{buffer:(void 0!==t.buffer?t.buffer:128)*o,tolerance:(void 0!==t.tolerance?t.tolerance:.375)*o,extent:et,maxZoom:this.maxzoom,lineMetrics:t.lineMetrics||!1,generateId:t.generateId||!1},superclusterOptions:{maxZoom:void 0!==t.clusterMaxZoom?t.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,t.clusterMinPoints||2),extent:et,radius:(void 0!==t.clusterRadius?t.clusterRadius:50)*o,log:!1,generateId:t.generateId||!1},clusterProperties:t.clusterProperties,filter:t.filter},t.workerOptions)}onAdd(e){this.map=e,this.setData(this._data)}setData(e){return this._data=e,this._updateWorkerData(),this}getClusterExpansionZoom(e,t){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:e,source:this.id,scope:this.scope},t),this}getClusterChildren(e,t){return this.actor.send("geojson.getClusterChildren",{clusterId:e,source:this.id,scope:this.scope},t),this}getClusterLeaves(e,t,n,r){return this.actor.send("geojson.getClusterLeaves",{source:this.id,scope:this.scope,clusterId:e,limit:t,offset:n},r),this}_updateWorkerData(){if(this._pendingLoad)return void(this._coalesce=!0);this.fire(new Mt("dataloading",{dataType:"source"})),this._loaded=!1;const e=Wt({},this.workerOptions);e.scope=this.scope;const t=this._data;"string"==typeof t?(e.request=this.map._requestManager.transformRequest(De.resolveURL(t),yt.Source),e.request.collectResourceTiming=this._collectResourceTiming):e.data=JSON.stringify(t),this._pendingLoad=this.actor.send(`${this.type}.loadData`,e,(n,r)=>{if(this._loaded=!0,this._pendingLoad=null,n)this.fire(new Tt(n));else{const o={dataType:"source",sourceDataType:this._metadataFired?"content":"metadata"};this._collectResourceTiming&&r&&r.resourceTiming&&r.resourceTiming[this.id]&&(o.resourceTiming=r.resourceTiming[this.id]),this.fire(new Mt("data",o)),this._metadataFired=!0}this._coalesce&&(this._updateWorkerData(),this._coalesce=!1)})}loaded(){return this._loaded}loadTile(e,t){const n=e.actor?"reloadTile":"loadTile";e.actor=this.actor;const r={type:this.type,uid:e.uid,tileID:e.tileID,tileZoom:e.tileZoom,zoom:e.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,scope:this.scope,pixelRatio:De.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,brightness:this.map.style&&this.map.style.getBrightness()||0};e.request=this.actor.send(n,r,(o,s)=>(delete e.request,e.destroy(),e.aborted?t(null):o?t(o):(e.loadVectorData(s,this.map.painter,"reloadTile"===n),t(null))),void 0,"loadTile"===n)}abortTile(e){e.request&&(e.request.cancel(),delete e.request),e.aborted=!0}unloadTile(e){this.actor.send("removeTile",{uid:e.uid,type:this.type,source:this.id,scope:this.scope}),e.destroy()}onRemove(){this._pendingLoad&&this._pendingLoad.cancel()}serialize(){return Wt({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}},video:class extends $s{constructor(e,t,n,r){super(e,t,n,r),this.roundZoom=!0,this.type="video",this.options=t}load(){this._loaded=!1;const e=this.options;this.urls=[];for(const t of e.urls)this.urls.push(this.map._requestManager.transformRequest(t,yt.Source).url);!function(t,n){const r=ft.document.createElement("video");r.muted=!0,r.onloadstart=function(){n(null,r)};for(let o=0;o<t.length;o++){const s=ft.document.createElement("source");Zt(t[o])||(r.crossOrigin="Anonymous"),s.src=t[o],r.appendChild(s)}}(this.urls,(t,n)=>{this._loaded=!0,t?this.fire(new Tt(t)):n&&(this.video=n,this.video.loop=!0,this.video.setAttribute("playsinline",""),this.video.addEventListener("playing",()=>{this.map.triggerRepaint()}),this.map&&this.video.play(),this._finishLoading())})}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(e){if(this.video){const t=this.video.seekable;e<t.start(0)||e>t.end(0)?this.fire(new Tt(new wt(`sources.${this.id}`,null,`Playback for this video can be set only between the ${t.start(0)} and ${t.end(0)}-second mark.`))):this.video.currentTime=e}}getVideo(){return this.video}onAdd(e){this.map||(this.map=e,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(0===Object.keys(this.tiles).length||this.video.readyState<2)return;const e=this.map.painter.context,t=e.gl;this.texture?this.video.paused||(this.texture.bind(t.LINEAR,t.CLAMP_TO_EDGE),t.texSubImage2D(t.TEXTURE_2D,0,0,0,t.RGBA,t.UNSIGNED_BYTE,this.video)):(this.texture=new hr(e,this.video,t.RGBA),this.texture.bind(t.LINEAR,t.CLAMP_TO_EDGE),this.width=this.video.videoWidth,this.height=this.video.videoHeight),this._prepareData(e)}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}},image:$s,model:class extends ye{constructor(e,t,n,r){super(),this.id=e,this.type="model",this.models=[],this._loaded=!1,this._options=t}load(){const e=[];for(const t in this._options.models){const n=this._options.models[t],r=dD(this.map._requestManager.transformRequest(n.uri,yt.Model).url).then(o=>{if(!o)return;const s=qu(o),c=new hw(t,n.position,n.orientation,s);c.computeBoundsAndApplyParent(),this.models.push(c)}).catch(o=>{this.fire(new Tt(new Error(`Could not load model ${t} from ${n.uri}: ${o.message}`)))});e.push(r)}return Promise.allSettled(e).then(()=>{this._loaded=!0,this.fire(new Mt("data",{dataType:"source",sourceDataType:"metadata"}))}).catch(t=>{this.fire(new Tt(new Error(`Could not load models: ${t.message}`)))})}onAdd(e){this.map=e,this.load()}hasTransition(){return!1}loaded(){return this._loaded}getModels(){return this.models}loadTile(e,t){}serialize(){return{type:"model"}}},"batched-model":class extends ye{constructor(e,t,n,r){super(),this.type="batched-model",this.id=e,this.tileSize=512,this._options=t,this.tiles=this._options.tiles,this.maxzoom=t.maxzoom||19,this.minzoom=t.minzoom||0,this.roundZoom=!0,this.usedInConflation=!0,this.dispatcher=n,this.reparseOverscaled=!1,this.scheme="xyz",this._loaded=!1,this.setEventedParent(r)}onAdd(e){this.map=e,this.load()}load(e){this._loaded=!1,this.fire(new Mt("dataloading",{dataType:"source"}));const t=Array.isArray(this.map._language)?this.map._language.join():this.map._language,n=this.map._worldview;this._tileJSONRequest=H0(this._options,this.map._requestManager,t,n,(r,o)=>{this._tileJSONRequest=null,this._loaded=!0,r?(t&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${t}`),n&&2!==n.length&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${n}`),this.fire(new Tt(r))):o&&(Wt(this,o),o.bounds&&(this.tileBounds=new Gu(o.bounds,this.minzoom,this.maxzoom)),Xd(o.tiles,this.map._requestManager._customAccessToken),this.fire(new Mt("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new Mt("data",{dataType:"source",sourceDataType:"content"}))),e&&e(r)})}hasTransition(){return!1}hasTile(e){return!this.tileBounds||this.tileBounds.contains(e.canonical)}loaded(){return this._loaded}loadTile(e,t){const n=this.map._requestManager.normalizeTileURL(e.tileID.canonical.url(this.tiles,this.scheme)),r={request:this.map._requestManager.transformRequest(n,yt.Tile),data:void 0,uid:e.uid,tileID:e.tileID,tileZoom:e.tileZoom,zoom:e.tileID.overscaledZ,tileSize:this.tileSize*e.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,showCollisionBoxes:this.map.showCollisionBoxes,isSymbolTile:e.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0};if(e.actor&&"expired"!==e.state)if("loading"===e.state)e.reloadCallback=t;else{if(e.buckets){const s=Object.values(e.buckets);for(const c of s)c.dirty=!0;return void(e.state="loaded")}e.request=e.actor.send("reloadTile",r,o.bind(this))}else e.actor=this.dispatcher.getActor(),e.request=e.actor.send("loadTile",r,o.bind(this),void 0,!0);function o(s,c){return e.aborted?t(null):s&&404!==s.status?t(s):(c&&(c.resourceTiming&&(e.resourceTiming=c.resourceTiming),this.map._refreshExpiredTiles&&e.setExpiryData(c),e.buckets={...e.buckets,...c.buckets}),e.state="loaded",void t(null))}}serialize(){return Wt({},this._options)}},canvas:class extends $s{constructor(e,t,n,r){super(e,t,n,r),t.coordinates?Array.isArray(t.coordinates)&&4===t.coordinates.length&&!t.coordinates.some(o=>!Array.isArray(o)||2!==o.length||o.some(s=>"number"!=typeof s))||this.fire(new Tt(new wt(`sources.${e}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new Tt(new wt(`sources.${e}`,null,'missing required property "coordinates"'))),t.animate&&"boolean"!=typeof t.animate&&this.fire(new Tt(new wt(`sources.${e}`,null,'optional "animate" property must be a boolean value'))),t.canvas?"string"==typeof t.canvas||t.canvas instanceof ft.HTMLCanvasElement||this.fire(new Tt(new wt(`sources.${e}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new Tt(new wt(`sources.${e}`,null,'missing required property "canvas"'))),this.options=t,this.animate=void 0===t.animate||t.animate}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof ft.HTMLCanvasElement?this.options.canvas:ft.document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new Tt(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}getCanvas(){return this.canvas}onAdd(e){this.map=e,this.load(),this.canvas&&this.animate&&this.play()}onRemove(){this.pause()}prepare(){let e=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,e=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,e=!0),this._hasInvalidDimensions()||0===Object.keys(this.tiles).length)return;const t=this.map.painter.context;this.texture?!e&&!this._playing||this.texture instanceof hd||this.texture.update(this.canvas,{premultiply:!0}):this.texture=new hr(t,this.canvas,t.gl.RGBA,{premultiply:!0}),this._prepareData(t)}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const e of[this.canvas.width,this.canvas.height])if(isNaN(e)||e<=0)return!0;return!1}},custom:class extends ye{constructor(e,t,n,r){super(),this.id=e,this.type="custom",this._dataType="raster",this._dispatcher=n,this._implementation=t,this.setEventedParent(r),this.scheme="xyz",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this._loaded=!1,this.roundZoom=!0,this._implementation||this.fire(new Tt(new Error(`Missing implementation for ${this.id} custom source`))),this._implementation.loadTile||this.fire(new Tt(new Error(`Missing loadTile implementation for ${this.id} custom source`))),this._implementation.bounds&&(this.tileBounds=new Gu(this._implementation.bounds,this.minzoom,this.maxzoom)),t.update=this._update.bind(this),t.clearTiles=this._clearTiles.bind(this),t.coveringTiles=this._coveringTiles.bind(this),Wt(this,to(t,["dataType","scheme","minzoom","maxzoom","tileSize","attribution","minTileCacheSize","maxTileCacheSize"]))}serialize(){return to(this,["type","scheme","minzoom","maxzoom","tileSize","attribution"])}load(){this._loaded=!0,this.fire(new Mt("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new Mt("data",{dataType:"source",sourceDataType:"content"}))}loaded(){return this._loaded}onAdd(e){this._map=e,this._loaded=!1,this.fire(new Mt("dataloading",{dataType:"source"})),this._implementation.onAdd&&this._implementation.onAdd(e),this.load()}onRemove(e){this._implementation.onRemove&&this._implementation.onRemove(e)}hasTile(e){if(this._implementation.hasTile){const{x:t,y:n,z:r}=e.canonical;return this._implementation.hasTile({x:t,y:n,z:r})}return!this.tileBounds||this.tileBounds.contains(e.canonical)}loadTile(e,t){const{x:n,y:r,z:o}=e.tileID.canonical,s=new ft.AbortController;e.request=Promise.resolve(this._implementation.loadTile({x:n,y:r,z:o},{signal:s.signal})).then(function(c){return delete e.request,e.aborted?(e.state="unloaded",t(null)):void 0===c?(e.state="errored",t(null)):null===c?(this.loadTileData(e,{width:this.tileSize,height:this.tileSize,data:null}),e.state="loaded",t(null)):(u=c)instanceof ft.ImageData||u instanceof ft.HTMLCanvasElement||u instanceof ft.ImageBitmap||u instanceof ft.HTMLImageElement?(this.loadTileData(e,c),e.state="loaded",void t(null)):(e.state="errored",t(new Error(`Can't infer data type for ${this.id}, only raster data supported at the moment`)));var u}.bind(this)).catch(c=>{20!==c.code&&(e.state="errored",t(c))}),e.request.cancel=()=>s.abort()}loadTileData(e,t){e.setTexture(t,this._map.painter)}unloadTile(e,t){if(e.texture&&e.texture instanceof hr?(e.destroy(!0),e.texture&&e.texture instanceof hr&&this._map.painter.saveTileTexture(e.texture)):e.destroy(),this._implementation.unloadTile){const{x:n,y:r,z:o}=e.tileID.canonical;this._implementation.unloadTile({x:n,y:r,z:o})}t()}abortTile(e,t){e.request&&e.request.cancel&&(e.request.cancel(),delete e.request),t()}hasTransition(){return!1}_coveringTiles(){return this._map.transform.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,roundZoom:this.roundZoom}).map(e=>({x:e.canonical.x,y:e.canonical.y,z:e.canonical.z}))}_clearTiles(){const e=$i(this.id,this.scope);this._map.style.clearSource(e)}_update(){this.fire(new Mt("data",{dataType:"source",sourceDataType:"content"}))}}},iv=function(e,t,n,r){const o=new rv[t.type](e,t,n,r);if(o.id!==e)throw new Error(`Expected Source id to be ${e} instead of ${o.id}`);return ei(["load","abort","unload","serialize","prepare"],o),o};function NC(e,t){const n=st.identity([]);return st.scale(n,n,[.5*e.width,.5*-e.height,1]),st.translate(n,n,[1,-1,0]),st.multiply(n,n,e.calculateProjMatrix(t.toUnwrapped())),Float32Array.from(n)}function yD(e,t,n,r,o,s,c,u=!1){const d=e.tilesIn(r,c,u);d.sort(Kw);const f=[];for(const g of d)f.push({wrappedTileID:g.tile.tileID.wrapped().key,queryResults:g.tile.queryRenderedFeatures(t,n,e._state,g,o,s,NC(e.transform,g.tile.tileID),u)});const m=function(g){const y={},v={};for(const x of g){const w=x.queryResults,E=x.wrappedTileID,M=v[E]=v[E]||{};for(const D in w){const A=w[D],P=M[D]=M[D]||{},C=y[D]=y[D]||[];for(const R of A)P[R.featureIndex]||(P[R.featureIndex]=!0,C.push(R))}}return y}(f);for(const g in m)m[g].forEach(y=>{const v=y.feature,x=v.layer;x&&"background"!==x.type&&"sky"!==x.type&&"slot"!==x.type&&(v.source=x.source,x["source-layer"]&&(v.sourceLayer=x["source-layer"]),v.state=void 0!==v.id?e.getFeatureState(x["source-layer"],v.id):{})});return m}function Yw(e,t){const n=e.getRenderableIds().map(s=>e.getTileByID(s)),r=[],o={};for(let s=0;s<n.length;s++){const c=n[s],u=c.tileID.canonical.key;o[u]||(o[u]=!0,c.querySourceFeatures(r,t))}return r}function Kw(e,t){const n=e.tileID,r=t.tileID;return n.overscaledZ-r.overscaledZ||n.canonical.y-r.canonical.y||n.wrap-r.wrap||n.canonical.x-r.canonical.x}class vD{constructor(t){this.style=t}processLayersChanged(){this.layers=[];for(const t in this.style._mergedLayers){const n=this.style._mergedLayers[t];if("fill-extrusion"===n.type)this.layers.push(n);else if("model"===n.type){const r=this.style.getLayerSource(n);r&&"batched-model"===r.type&&this.layers.push(n)}}}updateZOffset(t,n){this.currentBuildingBuckets=[];for(let o=0;o<this.layers.length;++o){const s=this.layers[o],c=this.style.getLayerSourceCache(s);let u=1;"fill-extrusion"===s.type&&(u=s.paint.get("fill-extrusion-opacity")>0?s.paint.get("fill-extrusion-vertical-scale"):0);let d=c?c.getTile(n):null;if(!d&&c&&n.canonical.z>c.getSource().minzoom){let f=n.scaledTo(Math.min(c.getSource().maxzoom,n.overscaledZ-1));for(;f.overscaledZ>=c.getSource().minzoom&&(d=c.getTile(f),!d&&0!==f.overscaledZ);)f=f.scaledTo(f.overscaledZ-1)}this.currentBuildingBuckets.push({bucket:d?d.getBucket(s):null,tileID:d?d.tileID:n,verticalScale:u})}t.hasAnyZOffset=!1;let r=!1;for(let o=0;o<t.symbolInstances.length;o++){const s=t.symbolInstances.get(o),c=s.zOffset,u=this._getHeightAtTileOffset(n,s.tileAnchorX,s.tileAnchorY);s.zOffset=-1!==u?u:c,r||c===s.zOffset||(r=!0),t.hasAnyZOffset||0===s.zOffset||(t.hasAnyZOffset=!0)}r&&(t.zOffsetBuffersNeedUpload=!0,t.zOffsetSortDirty=!0)}_mapCoordToOverlappingTile(t,n,r,o){let s=n,c=r;if(t.canonical.z!==o.canonical.z){const u=o.canonical,d=1/(1<<t.canonical.z-u.z);s=(n+t.canonical.x*et)*d-u.x*et|0,c=(r+t.canonical.y*et)*d-u.y*et|0}return{tileX:s,tileY:c}}_getHeightAtTileOffset(t,n,r){let o;for(let s=0;s<this.layers.length;++s){if("fill-extrusion"!==this.layers[s].type)continue;const{bucket:c,tileID:u,verticalScale:d}=this.currentBuildingBuckets[s];if(!c)continue;const{tileX:f,tileY:m}=this._mapCoordToOverlappingTile(t,n,r,u),g=c.getHeightAtTileCoord(f,m);if(g&&void 0!==g.height){if(!g.hidden)return g.height*d;o=g.height}}for(let s=0;s<this.layers.length;++s){if("model"!==this.layers[s].type)continue;const{bucket:c,tileID:u}=this.currentBuildingBuckets[s];if(!c)continue;const{tileX:d,tileY:f}=this._mapCoordToOverlappingTile(t,n,r,u),m=c.getHeightAtTileCoord(d,f);if(m&&!m.hidden)return void 0===m.height&&void 0!==o?Math.min(m.maxHeight,o)*m.verticalScale:(m.height||0)*m.verticalScale}return-1}}var Rd=["type","source","source-layer","minzoom","maxzoom","filter","layout"];function xD(e,t){const n={};for(const r in e)"ref"!==r&&(n[r]=e[r]);return Rd.forEach(r=>{r in t&&(n[r]=t[r])}),n}function ov(e){e=e.slice();const t=Object.create(null);for(let n=0;n<e.length;n++)t[e[n].id]=e[n];for(let n=0;n<e.length;n++)"ref"in e[n]&&(e[n]=xD(e[n],t[e[n].ref]));return e}const xn={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setSlot:"setSlot",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight",setTerrain:"setTerrain",setFog:"setFog",setCamera:"setCamera",setLights:"setLights",setProjection:"setProjection",addImport:"addImport",removeImport:"removeImport",setImportUrl:"setImportUrl",setImportData:"setImportData",setImportConfig:"setImportConfig"};function sv(e,t,n){n.push({command:xn.addSource,args:[e,t[e]]})}function Jw(e,t,n){t.push({command:xn.removeSource,args:[e]}),n[e]=!0}function Qw(e,t,n,r){Jw(e,n,r),sv(e,t,n)}function bD(e,t,n){let r;for(r in e[n])if(e[n].hasOwnProperty(r)&&"data"!==r&&!tn(e[n][r],t[n][r]))return!1;for(r in t[n])if(t[n].hasOwnProperty(r)&&"data"!==r&&!tn(e[n][r],t[n][r]))return!1;return!0}function Ld(e,t,n,r,o,s){let c;for(c in t=t||{},e=e||{})e.hasOwnProperty(c)&&(tn(e[c],t[c])||n.push({command:s,args:[r,c,t[c],o]}));for(c in t)t.hasOwnProperty(c)&&!e.hasOwnProperty(c)&&(tn(e[c],t[c])||n.push({command:s,args:[r,c,t[c],o]}))}function kg(e){return e.id}function Ip(e,t){return e[t.id]=t,e}class tE{constructor(t,n){this.reset(t,n)}reset(t,n){this.points=t||[],this._distances=[0];for(let r=1;r<this.points.length;r++)this._distances[r]=this._distances[r-1]+this.points[r].dist(this.points[r-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(n||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(t){if(1===this.points.length)return this.points[0];t=ne(t,0,1);let n=1,r=this._distances[n];const o=t*this.paddedLength+this.padding;for(;r<o&&n<this._distances.length;)r=this._distances[++n];const s=n-1,c=this._distances[s],u=r-c,d=u>0?(o-c)/u:0;return this.points[s].mult(1-d).add(this.points[n].mult(d))}}class eE{constructor(t,n,r){const o=this.boxCells=[],s=this.circleCells=[];this.xCellCount=Math.ceil(t/r),this.yCellCount=Math.ceil(n/r);for(let c=0;c<this.xCellCount*this.yCellCount;c++)o.push([]),s.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=t,this.height=n,this.xScale=this.xCellCount/t,this.yScale=this.yCellCount/n,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(t,n,r,o,s){this._forEachCell(n,r,o,s,this._insertBoxCell,this.boxUid++),this.boxKeys.push(t),this.bboxes.push(n),this.bboxes.push(r),this.bboxes.push(o),this.bboxes.push(s)}insertCircle(t,n,r,o){this._forEachCell(n-o,r-o,n+o,r+o,this._insertCircleCell,this.circleUid++),this.circleKeys.push(t),this.circles.push(n),this.circles.push(r),this.circles.push(o)}_insertBoxCell(t,n,r,o,s,c){this.boxCells[s].push(c)}_insertCircleCell(t,n,r,o,s,c){this.circleCells[s].push(c)}_query(t,n,r,o,s,c){if(r<0||t>this.width||o<0||n>this.height)return!s&&[];const u=[];if(t<=0&&n<=0&&this.width<=r&&this.height<=o){if(s)return!0;for(let d=0;d<this.boxKeys.length;d++)u.push({key:this.boxKeys[d],x1:this.bboxes[4*d],y1:this.bboxes[4*d+1],x2:this.bboxes[4*d+2],y2:this.bboxes[4*d+3]});for(let d=0;d<this.circleKeys.length;d++){const f=this.circles[3*d],m=this.circles[3*d+1],g=this.circles[3*d+2];u.push({key:this.circleKeys[d],x1:f-g,y1:m-g,x2:f+g,y2:m+g})}return c?u.filter(c):u}return this._forEachCell(t,n,r,o,this._queryCell,u,{hitTest:s,seenUids:{box:{},circle:{}}},c),s?u.length>0:u}_queryCircle(t,n,r,o,s){const c=t-r,u=t+r,d=n-r,f=n+r;if(u<0||c>this.width||f<0||d>this.height)return!o&&[];const m=[];return this._forEachCell(c,d,u,f,this._queryCellCircle,m,{hitTest:o,circle:{x:t,y:n,radius:r},seenUids:{box:{},circle:{}}},s),o?m.length>0:m}query(t,n,r,o,s){return this._query(t,n,r,o,!1,s)}hitTest(t,n,r,o,s){return this._query(t,n,r,o,!0,s)}hitTestCircle(t,n,r,o){return this._queryCircle(t,n,r,!0,o)}_queryCell(t,n,r,o,s,c,u,d){const f=u.seenUids,m=this.boxCells[s];if(null!==m){const y=this.bboxes;for(const v of m)if(!f.box[v]){f.box[v]=!0;const x=4*v;if(t<=y[x+2]&&n<=y[x+3]&&r>=y[x+0]&&o>=y[x+1]&&(!d||d(this.boxKeys[v]))){if(u.hitTest)return c.push(!0),!0;c.push({key:this.boxKeys[v],x1:y[x],y1:y[x+1],x2:y[x+2],y2:y[x+3]})}}}const g=this.circleCells[s];if(null!==g){const y=this.circles;for(const v of g)if(!f.circle[v]){f.circle[v]=!0;const x=3*v;if(this._circleAndRectCollide(y[x],y[x+1],y[x+2],t,n,r,o)&&(!d||d(this.circleKeys[v]))){if(u.hitTest)return c.push(!0),!0;{const w=y[x],E=y[x+1],M=y[x+2];c.push({key:this.circleKeys[v],x1:w-M,y1:E-M,x2:w+M,y2:E+M})}}}}}_queryCellCircle(t,n,r,o,s,c,u,d){const f=u.circle,m=u.seenUids,g=this.boxCells[s];if(null!==g){const v=this.bboxes;for(const x of g)if(!m.box[x]){m.box[x]=!0;const w=4*x;if(this._circleAndRectCollide(f.x,f.y,f.radius,v[w+0],v[w+1],v[w+2],v[w+3])&&(!d||d(this.boxKeys[x])))return c.push(!0),!0}}const y=this.circleCells[s];if(null!==y){const v=this.circles;for(const x of y)if(!m.circle[x]){m.circle[x]=!0;const w=3*x;if(this._circlesCollide(v[w],v[w+1],v[w+2],f.x,f.y,f.radius)&&(!d||d(this.circleKeys[x])))return c.push(!0),!0}}}_forEachCell(t,n,r,o,s,c,u,d){const f=this._convertToXCellCoord(t),m=this._convertToYCellCoord(n),g=this._convertToXCellCoord(r),y=this._convertToYCellCoord(o);for(let v=f;v<=g;v++)for(let x=m;x<=y;x++)if(s.call(this,t,n,r,o,this.xCellCount*x+v,c,u,d))return}_convertToXCellCoord(t){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(t*this.xScale)))}_convertToYCellCoord(t){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(t*this.yScale)))}_circlesCollide(t,n,r,o,s,c){const u=o-t,d=s-n,f=r+c;return f*f>u*u+d*d}_circleAndRectCollide(t,n,r,o,s,c,u){const d=(c-o)/2,f=Math.abs(t-(o+d));if(f>d+r)return!1;const m=(u-s)/2,g=Math.abs(n-(s+m));if(g>m+r)return!1;if(f<=d||g<=m)return!0;const y=f-d,v=g-m;return y*y+v*v<=r*r}}const Qa=100;class wD{constructor(t,n,r=new eE(t.width+200,t.height+200,25),o=new eE(t.width+200,t.height+200,25)){this.transform=t,this.grid=r,this.ignoredGrid=o,this.pitchfactor=Math.cos(t._pitch)*t.cameraToCenterDistance,this.screenRightBoundary=t.width+Qa,this.screenBottomBoundary=t.height+Qa,this.gridRightBoundary=t.width+200,this.gridBottomBoundary=t.height+200,this.fogState=n}placeCollisionBox(t,n,r,o,s,c,u,d){let f=r.projectedAnchorX,m=r.projectedAnchorY,g=r.projectedAnchorZ;const y=r.elevation,v=r.tileID,x=t.getProjection();if(y&&v){const[R,k,N]=x.upVector(v.canonical,r.tileAnchorX,r.tileAnchorY),z=x.upVectorScale(v.canonical,this.transform.center.lat,this.transform.worldSize).metersToTile;f+=R*y*z,m+=k*y*z,g+=N*y*z}const w=this.projectAndGetPerspectiveRatio(u,f,m,g,r.tileID,"globe"===x.name||!!y||this.transform.pitch>0,x),E=c*w.perspectiveRatio,M=(r.x1*n+o.x-r.padding)*E+w.point.x,D=(r.y1*n+o.y-r.padding)*E+w.point.y,A=(r.x2*n+o.x+r.padding)*E+w.point.x,P=(r.y2*n+o.y+r.padding)*E+w.point.y,C=w.perspectiveRatio<=.55||w.occluded;return!this.isInsideGrid(M,D,A,P)||!s&&this.grid.hitTest(M,D,A,P,d)||C?{box:[],offscreen:!1,occluded:w.occluded}:{box:[M,D,A,P],offscreen:this.isOffscreen(M,D,A,P),occluded:!1}}placeCollisionCircles(t,n,r,o,s,c,u,d,f,m,g,y,v,x,w){const E=[],M=this.transform.elevation,D=t.getProjection(),A=M?M.getAtTileOffsetFunc(w,this.transform.center.lat,this.transform.worldSize,D):null,P=new it(r.tileAnchorX,r.tileAnchorY);let{x:C,y:R,z:k}=D.projectTilePoint(P.x,P.y,w.canonical);if(A){const[ot,Y,J]=A(P);C+=ot,R+=Y,k+=J}const N="globe"===D.name,z=this.projectAndGetPerspectiveRatio(u,C,R,k,w,N||!!M||this.transform.pitch>0,D),{perspectiveRatio:B}=z,U=(g?c/B:c*B)/wi,$=da(C,R,k,d),W=z.signedDistanceFromCamera>0?aw(U,s,r.lineOffsetX*U,r.lineOffsetY*U,!1,$,P,r,o,d,{},M&&!g?A:null,g&&!!M,D,w,g):null;let V=!1,K=!1,Q=!0;if(W&&!z.occluded){const ot=.5*v*B+x,Y=new it(-100,-100),J=new it(this.screenRightBoundary,this.screenBottomBoundary),ct=new tE,{first:dt,last:ht}=W,_t=dt.path.length;let vt=[];for(let Ct=_t-1;Ct>=1;Ct--)vt.push(dt.path[Ct]);for(let Ct=1;Ct<ht.path.length;Ct++)vt.push(ht.path[Ct]);const xt=2.5*ot;f&&(vt=vt.map(([Ct,Ut,Gt],Yt)=>(A&&!N&&(Gt=A(Yt<_t-1?dt.tilePath[_t-1-Yt]:ht.tilePath[Yt-_t+2])[2]),da(Ct,Ut,Gt,f))),vt.some(Ct=>Ct[3]<=0)&&(vt=[]));let mt=[];if(vt.length>0){let Ct=1/0,Ut=-1/0,Gt=1/0,Yt=-1/0;for(const te of vt)Ct=Math.min(Ct,te[0]),Gt=Math.min(Gt,te[1]),Ut=Math.max(Ut,te[0]),Yt=Math.max(Yt,te[1]);Ut>=Y.x&&Ct<=J.x&&Yt>=Y.y&&Gt<=J.y&&(mt=[vt.map(te=>new it(te[0],te[1]))],(Ct<Y.x||Ut>J.x||Gt<Y.y||Yt>J.y)&&(mt=sg(mt,Y.x,Y.y,J.x,J.y)))}for(const Ct of mt){ct.reset(Ct,.25*ot);let Ut=0;Ut=ct.length<=.5*ot?1:Math.ceil(ct.paddedLength/xt)+1;for(let Gt=0;Gt<Ut;Gt++){const Yt=Gt/Math.max(Ut-1,1),te=ct.lerp(Yt),Me=te.x+Qa,ue=te.y+Qa;E.push(Me,ue,ot,0);const dn=Me-ot,Ye=ue-ot,Ie=Me+ot,we=ue+ot;if(Q=Q&&this.isOffscreen(dn,Ye,Ie,we),K=K||this.isInsideGrid(dn,Ye,Ie,we),!n&&this.grid.hitTestCircle(Me,ue,ot,y)&&(V=!0,!m))return{circles:[],offscreen:!1,collisionDetected:V,occluded:!1}}}}return{circles:!m&&V||!K?[]:E,offscreen:Q,collisionDetected:V,occluded:z.occluded}}queryRenderedSymbols(t){if(0===t.length||0===this.grid.keysLength()&&0===this.ignoredGrid.keysLength())return{};const n=[];let r=1/0,o=1/0,s=-1/0,c=-1/0;for(const m of t){const g=new it(m.x+Qa,m.y+Qa);r=Math.min(r,g.x),o=Math.min(o,g.y),s=Math.max(s,g.x),c=Math.max(c,g.y),n.push(g)}const u=this.grid.query(r,o,s,c).concat(this.ignoredGrid.query(r,o,s,c)),d={},f={};for(const m of u){const g=m.key;void 0===d[g.bucketInstanceId]&&(d[g.bucketInstanceId]={}),d[g.bucketInstanceId][g.featureIndex]||xy(n,[new it(m.x1,m.y1),new it(m.x2,m.y1),new it(m.x2,m.y2),new it(m.x1,m.y2)])&&(d[g.bucketInstanceId][g.featureIndex]=!0,void 0===f[g.bucketInstanceId]&&(f[g.bucketInstanceId]=[]),f[g.bucketInstanceId].push(g.featureIndex))}return f}insertCollisionBox(t,n,r,o,s){(n?this.ignoredGrid:this.grid).insert({bucketInstanceId:r,featureIndex:o,collisionGroupID:s},t[0],t[1],t[2],t[3])}insertCollisionCircles(t,n,r,o,s){const c=n?this.ignoredGrid:this.grid,u={bucketInstanceId:r,featureIndex:o,collisionGroupID:s};for(let d=0;d<t.length;d+=4)c.insertCircle(u,t[d],t[d+1],t[d+2])}projectAndGetPerspectiveRatio(t,n,r,o,s,c,u){const d=[n,r,o,1];let f=!1;o||this.transform.pitch>0?(En.transformMat4(d,d,t),this.fogState&&s&&"globe"!==u.name&&(f=function(y,v,x,w,E,M){const D=M.calculateFogTileMatrix(E),A=[v,x,w];return Z.transformMat4(A,A,D),vp(y,Z.length(A),M.pitch,M._fov)}(this.fogState,n,r,o,s.toUnwrapped(),this.transform)>.9)):v0(d,d,t);const m=d[3];return{point:new it((d[0]/m+1)/2*this.transform.width+Qa,(-d[1]/m+1)/2*this.transform.height+Qa),perspectiveRatio:Math.min(.5+this.transform.getCameraToCenterDistance(u)/m*.5,1.5),signedDistanceFromCamera:m,occluded:c&&d[2]>m||f}}isOffscreen(t,n,r,o){return r<Qa||t>=this.screenRightBoundary||o<Qa||n>this.screenBottomBoundary}isInsideGrid(t,n,r,o){return r>=0&&t<this.gridRightBoundary&&o>=0&&n<this.gridBottomBoundary}getViewportMatrix(){const t=st.identity([]);return st.translate(t,t,[-100,-100,0]),t}}function Dp(e,t,n){const r=t.createTileMatrix(e,e.worldSize,n.toUnwrapped());return st.multiply(new Float32Array(16),e.projMatrix,r)}function ED(e,t,n){if(t.projection.name===n.projection.name)return e.projMatrix;const r=n.clone();return r.setProjection(t.projection),Dp(r,t.getProjection(),e)}function Fg(e,t,n){return t.name===n.projection.name?e.projMatrix:Dp(n,t,e)}class nE{constructor(t,n,r,o){this.opacity=t?Math.max(0,Math.min(1,t.opacity+(t.placed?n:-n))):o&&r?1:0,this.placed=r}isHidden(){return 0===this.opacity&&!this.placed}}class Sp{constructor(t,n,r,o,s,c=!1){this.text=new nE(t?t.text:null,n,r,s),this.icon=new nE(t?t.icon:null,n,o,s),this.clipped=c}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class av{constructor(t,n,r,o=!1){this.text=t,this.icon=n,this.skipFade=r,this.clipped=o}}class TD{constructor(){this.invProjMatrix=st.create(),this.viewportMatrix=st.create(),this.circles=[]}}class MD{constructor(t,n,r,o,s){this.bucketInstanceId=t,this.featureIndex=n,this.sourceLayerIndex=r,this.bucketIndex=o,this.tileID=s}}class ID{constructor(t){this.crossSourceCollisions=t,this.maxGroupID=0,this.collisionGroups={}}get(t){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[t]){const n=++this.maxGroupID;this.collisionGroups[t]={ID:n,predicate:r=>r.collisionGroupID===n}}return this.collisionGroups[t]}}function rE(e,t,n,r,o){const{horizontalAlign:s,verticalAlign:c}=og(e),u=-(s-.5)*t,d=-(c-.5)*n,f=Cb(e,r);return new it(u+f[0]*o,d+f[1]*o)}function lv(e,t,n,r,o){const s=new it(e,t);return n&&s._rotate(r?o:-o),s}class iE{constructor(t,n,r,o,s,c){this.transform=t.clone(),this.projection=t.projection.name,this.collisionIndex=new wD(this.transform,s),this.buildingIndex=c,this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=n,this.retainedQueryData={},this.collisionGroups=new ID(r),this.collisionCircleArrays={},this.prevPlacement=o,o&&(o.prevPlacement=void 0),this.placedOrientations={}}getBucketParts(t,n,r,o){const s=r.getBucket(n),c=r.latestFeatureIndex;if(!s||!c||n.fqid!==s.layerIds[0])return;const u=s.layers[0].layout,d=r.collisionBoxArray,f=Math.pow(2,this.transform.zoom-r.tileID.overscaledZ),m=r.tileSize/et,g=r.tileID.toUnwrapped();this.transform.setProjection(s.projection);const y=(v=r.tileID,x=s.getProjection(),w=this.transform,x.name===this.projection?w.calculateProjMatrix(v.toUnwrapped()):Dp(w,x,v));var v,x,w;const E="map"===u.get("text-pitch-alignment"),M="map"===u.get("text-rotation-alignment");n.compileFilter();const D=n.dynamicFilter(),A=n.dynamicFilterNeedsFeature(),P=this.transform.calculatePixelsToTileUnitsMatrix(r),C=m0(y,r.tileID.canonical,E,M,this.transform,s.getProjection(),P);let R=null;if(E){const z=g0(y,r.tileID.canonical,E,M,this.transform,s.getProjection(),P);R=st.multiply([],this.transform.labelPlaneMatrix,z)}let k=null;D&&r.latestFeatureIndex&&(k={unwrappedTileID:g,dynamicFilter:D,dynamicFilterNeedsFeature:A,featureIndex:r.latestFeatureIndex}),this.retainedQueryData[s.bucketInstanceId]=new MD(s.bucketInstanceId,c,s.sourceLayerIndex,s.index,r.tileID);const N={bucket:s,layout:u,posMatrix:y,textLabelPlaneMatrix:C,labelToScreenMatrix:R,clippingData:k,scale:f,textPixelRatio:m,holdingForFade:r.holdingForFade(),collisionBoxArray:d,partiallyEvaluatedTextSize:qa(s.textSizeData,this.transform.zoom),partiallyEvaluatedIconSize:qa(s.iconSizeData,this.transform.zoom),collisionGroup:this.collisionGroups.get(s.sourceID)};if(o)for(const z of s.sortKeyRanges){const{sortKey:B,symbolInstanceStart:U,symbolInstanceEnd:$}=z;t.push({sortKey:B,symbolInstanceStart:U,symbolInstanceEnd:$,parameters:N})}else t.push({symbolInstanceStart:0,symbolInstanceEnd:s.symbolInstances.length,parameters:N})}attemptAnchorPlacement(t,n,r,o,s,c,u,d,f,m,g,y,v,x,w,E,M,D){const{textOffset0:A,textOffset1:P,crossTileID:C}=y,R=[A,P],k=rE(t,r,o,R,s),N=this.collisionIndex.placeCollisionBox(x,s,n,lv(k.x,k.y,c,u,this.transform.angle),g,d,f,m.predicate);if(E){const z=x.getSymbolInstanceIconSize(D,this.transform.zoom,y.placedIconSymbolIndex);if(0===this.collisionIndex.placeCollisionBox(x,z,E,lv(k.x,k.y,c,u,this.transform.angle),g,d,f,m.predicate).box.length)return}if(N.box.length>0){let z;return this.prevPlacement&&this.prevPlacement.variableOffsets[C]&&this.prevPlacement.placements[C]&&this.prevPlacement.placements[C].text&&(z=this.prevPlacement.variableOffsets[C].anchor),this.variableOffsets[C]={textOffset:R,width:r,height:o,anchor:t,textScale:s,prevAnchor:z},this.markUsedJustification(x,t,y,w),x.allowVerticalPlacement&&(this.markUsedOrientation(x,w,y),this.placedOrientations[C]=w),{shift:k,placedGlyphBoxes:N}}}placeLayerBucketPart(t,n,r,o){const{bucket:s,layout:c,posMatrix:u,textLabelPlaneMatrix:d,labelToScreenMatrix:f,clippingData:m,textPixelRatio:g,holdingForFade:y,collisionBoxArray:v,partiallyEvaluatedTextSize:x,partiallyEvaluatedIconSize:w,collisionGroup:E}=t.parameters,M=c.get("text-optional"),D=c.get("icon-optional"),A=c.get("text-allow-overlap"),P=c.get("icon-allow-overlap"),C="map"===c.get("text-rotation-alignment"),R="map"===c.get("text-pitch-alignment"),k="viewport-y"===c.get("symbol-z-order"),N=c.get("symbol-z-elevate");this.transform.setProjection(s.projection);let z=A&&(P||!s.hasIconData()||D),B=P&&(A||!s.hasTextData()||M);!s.collisionArrays&&v&&s.deserializeCollisionBoxes(v),r&&o&&s.updateCollisionDebugBuffers(this.transform.zoom,v);const U=($,W,V)=>{const{crossTileID:K,numVerticalGlyphVertices:Q}=$;if(m){const Ie={zoom:this.transform.zoom,pitch:this.transform.pitch};let we=null;if(m.dynamicFilterNeedsFeature){const fe=this.retainedQueryData[s.bucketInstanceId];we=m.featureIndex.loadFeature({featureIndex:$.featureIndex,bucketIndex:fe.bucketIndex,sourceLayerIndex:fe.sourceLayerIndex,layoutVertexArrayOffset:0})}if(!(0,m.dynamicFilter)(Ie,we,this.retainedQueryData[s.bucketInstanceId].tileID.canonical,new it($.tileAnchorX,$.tileAnchorY),this.transform.calculateDistanceTileData(m.unwrappedTileID)))return this.placements[K]=new av(!1,!1,!1,!0),void n.add(K)}if(n.has(K))return;if(y)return void(this.placements[K]=new av(!1,!1,!1));let ot=!1,Y=!1,J=!0,ct=!1,dt=!1,ht=null,_t={box:null,offscreen:null,occluded:null},vt={box:null,offscreen:null,occluded:null},xt=null,mt=null,Ct=null,Ut=0,Gt=0,Yt=0;V.textFeatureIndex?Ut=V.textFeatureIndex:$.useRuntimeCollisionCircles&&(Ut=$.featureIndex),V.verticalTextFeatureIndex&&(Gt=V.verticalTextFeatureIndex);const te=Ie=>{Ie.tileID=this.retainedQueryData[s.bucketInstanceId].tileID;const we=this.transform.elevation;Ie.elevation=$.zOffset+(we?we.getAtTileOffset(Ie.tileID,Ie.tileAnchorX,Ie.tileAnchorY):0)},Me=V.textBox;if(Me){te(Me);const Ie=fe=>{let Ke=er.horizontal;if(s.allowVerticalPlacement&&!fe&&this.prevPlacement){const rn=this.prevPlacement.placedOrientations[K];rn&&(this.placedOrientations[K]=rn,Ke=rn,this.markUsedOrientation(s,Ke,$))}return Ke},we=(fe,Ke)=>{if(s.allowVerticalPlacement&&Q>0&&V.verticalTextBox){for(const rn of s.writingModes)if(rn===er.vertical?(_t=Ke(),vt=_t):_t=fe(),_t&&_t.box&&_t.box.length)break}else _t=fe()};if(c.get("text-variable-anchor")){let fe=c.get("text-variable-anchor");if(this.prevPlacement&&this.prevPlacement.variableOffsets[K]){const Be=this.prevPlacement.variableOffsets[K];fe.indexOf(Be.anchor)>0&&(fe=fe.filter(yn=>yn!==Be.anchor),fe.unshift(Be.anchor))}const Ke=(Be,yn,Ir)=>{const Sn=s.getSymbolInstanceTextSize(x,$,this.transform.zoom,W),Zn=(Be.x2-Be.x1)*Sn+2*Be.padding,Vr=(Be.y2-Be.y1)*Sn+2*Be.padding,br=$.hasIconTextFit&&!P?yn:null;br&&te(br);let Yn={box:[],offscreen:!1,occluded:!1};const bn=A?2*fe.length:fe.length;for(let Ni=0;Ni<bn;++Ni){const Ul=this.attemptAnchorPlacement(fe[Ni%fe.length],Be,Zn,Vr,Sn,C,R,g,u,E,Ni>=fe.length,$,W,s,Ir,br,x,w);if(Ul&&(Yn=Ul.placedGlyphBoxes,Yn&&Yn.box&&Yn.box.length)){ot=!0,ht=Ul.shift;break}}return Yn};we(()=>Ke(Me,V.iconBox,er.horizontal),()=>{const Be=V.verticalTextBox;return Be&&te(Be),s.allowVerticalPlacement&&!(_t&&_t.box&&_t.box.length)&&Q>0&&Be?Ke(Be,V.verticalIconBox,er.vertical):{box:null,offscreen:null,occluded:null}}),_t&&(ot=_t.box,J=_t.offscreen,ct=_t.occluded);const rn=Ie(!(!_t||!_t.box));if(!ot&&this.prevPlacement){const Be=this.prevPlacement.variableOffsets[K];Be&&(this.variableOffsets[K]=Be,this.markUsedJustification(s,Be.anchor,$,rn))}}else{const fe=(Ke,rn)=>{const Be=s.getSymbolInstanceTextSize(x,$,this.transform.zoom,W),yn=this.collisionIndex.placeCollisionBox(s,Be,Ke,new it(0,0),A,g,u,E.predicate);return yn&&yn.box&&yn.box.length&&(this.markUsedOrientation(s,rn,$),this.placedOrientations[K]=rn),yn};we(()=>fe(Me,er.horizontal),()=>{const Ke=V.verticalTextBox;return s.allowVerticalPlacement&&Q>0&&Ke?(te(Ke),fe(Ke,er.vertical)):{box:null,offscreen:null,occluded:null}}),Ie(!!(_t&&_t.box&&_t.box.length))}}if(xt=_t,ot=xt&&xt.box&&xt.box.length>0,J=xt&&xt.offscreen,ct=xt&&xt.occluded,$.useRuntimeCollisionCircles){const Ie=s.text.placedSymbolArray.get($.centerJustifiedTextSymbolIndex>=0?$.centerJustifiedTextSymbolIndex:$.verticalPlacedTextSymbolIndex),we=Yh(s.textSizeData,x,Ie),fe=c.get("text-padding");mt=this.collisionIndex.placeCollisionCircles(s,A,Ie,s.lineVertexArray,s.glyphOffsetArray,we,u,d,f,r,R,E.predicate,$.collisionCircleDiameter*we/wi,fe,this.retainedQueryData[s.bucketInstanceId].tileID),ot=A||mt.circles.length>0&&!mt.collisionDetected,J=J&&mt.offscreen,ct=mt.occluded}if(V.iconFeatureIndex&&(Yt=V.iconFeatureIndex),V.iconBox){const Ie=we=>{te(we);const fe=$.hasIconTextFit&&ht?lv(ht.x,ht.y,C,R,this.transform.angle):new it(0,0),Ke=s.getSymbolInstanceIconSize(w,this.transform.zoom,$.placedIconSymbolIndex);return this.collisionIndex.placeCollisionBox(s,Ke,we,fe,P,g,u,E.predicate)};vt&&vt.box&&vt.box.length&&V.verticalIconBox?(Ct=Ie(V.verticalIconBox),Y=Ct.box.length>0):(Ct=Ie(V.iconBox),Y=Ct.box.length>0),J=J&&Ct.offscreen,dt=Ct.occluded}const ue=M||0===$.numHorizontalGlyphVertices&&0===Q,dn=D||0===$.numIconVertices;if(ue||dn?dn?ue||(Y=Y&&ot):ot=Y&&ot:Y=ot=Y&&ot,ot&&xt&&xt.box&&this.collisionIndex.insertCollisionBox(xt.box,c.get("text-ignore-placement"),s.bucketInstanceId,vt&&vt.box&&Gt?Gt:Ut,E.ID),Y&&Ct&&this.collisionIndex.insertCollisionBox(Ct.box,c.get("icon-ignore-placement"),s.bucketInstanceId,Yt,E.ID),mt&&(ot&&this.collisionIndex.insertCollisionCircles(mt.circles,c.get("text-ignore-placement"),s.bucketInstanceId,Ut,E.ID),r)){const Ie=s.bucketInstanceId;let we=this.collisionCircleArrays[Ie];void 0===we&&(we=this.collisionCircleArrays[Ie]=new TD);for(let fe=0;fe<mt.circles.length;fe+=4)we.circles.push(mt.circles[fe+0]),we.circles.push(mt.circles[fe+1]),we.circles.push(mt.circles[fe+2]),we.circles.push(mt.collisionDetected?1:0)}const Ye="globe"!==s.projection.name;z=z&&(Ye||!ct),B=B&&(Ye||!dt),this.placements[K]=new av(ot||z,Y||B,J||s.justReloaded),n.add(K)};if(N&&this.buildingIndex&&(this.buildingIndex.updateZOffset(s,this.retainedQueryData[s.bucketInstanceId].tileID),s.updateZOffset()),k){const $=s.getSortedSymbolIndexes(this.transform.angle);for(let W=$.length-1;W>=0;--W){const V=$[W];U(s.symbolInstances.get(V),V,s.collisionArrays[V])}s.hasAnyZOffset&&nt(`${s.layerIds[0]} layer symbol-z-elevate: symbols are not sorted by elevation if symbol-z-order is evaluated to viewport-y`)}else if(s.hasAnyZOffset){const $=s.getSortedIndexesByZOffset();for(let W=0;W<$.length;++W){const V=$[W];U(s.symbolInstances.get(V),V,s.collisionArrays[V])}}else for(let $=t.symbolInstanceStart;$<t.symbolInstanceEnd;$++)U(s.symbolInstances.get($),$,s.collisionArrays[$]);if(r&&s.bucketInstanceId in this.collisionCircleArrays){const $=this.collisionCircleArrays[s.bucketInstanceId];st.invert($.invProjMatrix,u),$.viewportMatrix=this.collisionIndex.getViewportMatrix()}s.justReloaded=!1}markUsedJustification(t,n,r,o){const{leftJustifiedTextSymbolIndex:s,centerJustifiedTextSymbolIndex:c,rightJustifiedTextSymbolIndex:u,verticalPlacedTextSymbolIndex:d,crossTileID:f}=r,m=cg(n),g=o===er.vertical?d:"left"===m?s:"center"===m?c:"right"===m?u:-1;s>=0&&(t.text.placedSymbolArray.get(s).crossTileID=g>=0&&s!==g?0:f),c>=0&&(t.text.placedSymbolArray.get(c).crossTileID=g>=0&&c!==g?0:f),u>=0&&(t.text.placedSymbolArray.get(u).crossTileID=g>=0&&u!==g?0:f),d>=0&&(t.text.placedSymbolArray.get(d).crossTileID=g>=0&&d!==g?0:f)}markUsedOrientation(t,n,r){const o=n===er.horizontal||n===er.horizontalOnly?n:0,s=n===er.vertical?n:0,{leftJustifiedTextSymbolIndex:c,centerJustifiedTextSymbolIndex:u,rightJustifiedTextSymbolIndex:d,verticalPlacedTextSymbolIndex:f}=r,m=t.text.placedSymbolArray;c>=0&&(m.get(c).placedOrientation=o),u>=0&&(m.get(u).placedOrientation=o),d>=0&&(m.get(d).placedOrientation=o),f>=0&&(m.get(f).placedOrientation=s)}commit(t){this.commitTime=t,this.zoomAtLastRecencyCheck=this.transform.zoom;const n=this.prevPlacement;let r=!1;this.prevZoomAdjustment=n?n.zoomAdjustment(this.transform.zoom):0;const o=n?n.symbolFadeChange(t):1,s=n?n.opacities:{},c=n?n.variableOffsets:{},u=n?n.placedOrientations:{};for(const d in this.placements){const f=this.placements[d],m=s[d];m?(this.opacities[d]=new Sp(m,o,f.text,f.icon,null,f.clipped),r=r||f.text!==m.text.placed||f.icon!==m.icon.placed):(this.opacities[d]=new Sp(null,o,f.text,f.icon,f.skipFade,f.clipped),r=r||f.text||f.icon)}for(const d in s){const f=s[d];if(!this.opacities[d]){const m=new Sp(f,o,!1,!1);m.isHidden()||(this.opacities[d]=m,r=r||f.text.placed||f.icon.placed)}}for(const d in c)this.variableOffsets[d]||!this.opacities[d]||this.opacities[d].isHidden()||(this.variableOffsets[d]=c[d]);for(const d in u)this.placedOrientations[d]||!this.opacities[d]||this.opacities[d].isHidden()||(this.placedOrientations[d]=u[d]);r?this.lastPlacementChangeTime=t:"number"!=typeof this.lastPlacementChangeTime&&(this.lastPlacementChangeTime=n?n.lastPlacementChangeTime:t)}updateLayerOpacities(t,n){const r=new Set;for(const o of n){const s=o.getBucket(t);s&&o.latestFeatureIndex&&t.fqid===s.layerIds[0]&&(this.updateBucketOpacities(s,r,o.collisionBoxArray),s.layers[0].layout.get("symbol-z-elevate")&&this.buildingIndex&&(this.buildingIndex.updateZOffset(s,o.tileID),s.updateZOffset()))}}updateBucketOpacities(t,n,r){t.hasTextData()&&t.text.opacityVertexArray.clear(),t.hasIconData()&&t.icon.opacityVertexArray.clear(),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexArray.clear(),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexArray.clear();const o=t.layers[0].layout,s=!!t.layers[0].dynamicFilter(),c=new Sp(null,0,!1,!1,!0),u=o.get("text-allow-overlap"),d=o.get("icon-allow-overlap"),f=o.get("text-variable-anchor"),m="map"===o.get("text-rotation-alignment"),g="map"===o.get("text-pitch-alignment"),y=new Sp(null,0,u&&(d||!t.hasIconData()||o.get("icon-optional")),d&&(u||!t.hasTextData()||o.get("text-optional")),!0);!t.collisionArrays&&r&&(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData())&&t.deserializeCollisionBoxes(r);const v=(w,E,M)=>{for(let D=0;D<E/4;D++)w.opacityVertexArray.emplaceBack(M)};let x=0;for(let w=0;w<t.symbolInstances.length;w++){const E=t.symbolInstances.get(w),{numHorizontalGlyphVertices:M,numVerticalGlyphVertices:D,crossTileID:A,numIconVertices:P}=E,C=n.has(A);let R=this.opacities[A];C?R=c:R||(R=y,this.opacities[A]=R),n.add(A);const k=M>0||D>0,N=P>0,z=this.placedOrientations[A],B=z===er.vertical,U=z===er.horizontal||z===er.horizontalOnly;if(!k&&!N||R.isHidden()||x++,k){const $=Ng(R.text);v(t.text,M,B?Od:$),v(t.text,D,U?Od:$);const W=R.text.isHidden(),{leftJustifiedTextSymbolIndex:V,centerJustifiedTextSymbolIndex:K,rightJustifiedTextSymbolIndex:Q,verticalPlacedTextSymbolIndex:ot}=E,Y=t.text.placedSymbolArray,J=W||B?1:0;V>=0&&(Y.get(V).hidden=J),K>=0&&(Y.get(K).hidden=J),Q>=0&&(Y.get(Q).hidden=J),ot>=0&&(Y.get(ot).hidden=W||U?1:0);const ct=this.variableOffsets[A];ct&&this.markUsedJustification(t,ct.anchor,E,z);const dt=this.placedOrientations[A];dt&&(this.markUsedJustification(t,"left",E,dt),this.markUsedOrientation(t,dt,E))}if(N){const $=Ng(R.icon),{placedIconSymbolIndex:W,verticalPlacedIconSymbolIndex:V}=E,K=t.icon.placedSymbolArray,Q=R.icon.isHidden()?1:0;W>=0&&(v(t.icon,P,B?Od:$),K.get(W).hidden=Q),V>=0&&(v(t.icon,E.numVerticalIconVertices,U?Od:$),K.get(V).hidden=Q)}if(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData()){const $=t.collisionArrays[w];if($){let W=new it(0,0),V=!0;if($.textBox||$.verticalTextBox){if(f){const Q=this.variableOffsets[A];Q?(W=rE(Q.anchor,Q.width,Q.height,Q.textOffset,Q.textScale),m&&W._rotate(g?this.transform.angle:-this.transform.angle)):V=!1}s&&(V=!R.clipped),$.textBox&&Cp(t.textCollisionBox.collisionVertexArray,R.text.placed,!V||B,W.x,W.y),$.verticalTextBox&&Cp(t.textCollisionBox.collisionVertexArray,R.text.placed,!V||U,W.x,W.y)}const K=V&&!(U||!$.verticalIconBox);$.iconBox&&Cp(t.iconCollisionBox.collisionVertexArray,R.icon.placed,K,E.hasIconTextFit?W.x:0,E.hasIconTextFit?W.y:0),$.verticalIconBox&&Cp(t.iconCollisionBox.collisionVertexArray,R.icon.placed,!K,E.hasIconTextFit?W.x:0,E.hasIconTextFit?W.y:0)}}}if(t.fullyClipped=0===x,t.sortFeatures(this.transform.angle),this.retainedQueryData[t.bucketInstanceId]&&(this.retainedQueryData[t.bucketInstanceId].featureSortOrder=t.featureSortOrder),t.hasTextData()&&t.text.opacityVertexBuffer&&t.text.opacityVertexBuffer.updateData(t.text.opacityVertexArray),t.hasIconData()&&t.icon.opacityVertexBuffer&&t.icon.opacityVertexBuffer.updateData(t.icon.opacityVertexArray),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexBuffer&&t.iconCollisionBox.collisionVertexBuffer.updateData(t.iconCollisionBox.collisionVertexArray),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexBuffer&&t.textCollisionBox.collisionVertexBuffer.updateData(t.textCollisionBox.collisionVertexArray),t.bucketInstanceId in this.collisionCircleArrays){const w=this.collisionCircleArrays[t.bucketInstanceId];t.placementInvProjMatrix=w.invProjMatrix,t.placementViewportMatrix=w.viewportMatrix,t.collisionCircleArray=w.circles,delete this.collisionCircleArrays[t.bucketInstanceId]}}symbolFadeChange(t){return 0===this.fadeDuration?1:(t-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(t){return Math.max(0,(this.transform.zoom-t)/1.5)}hasTransitions(t){return this.stale||t-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(t,n){const r=this.zoomAtLastRecencyCheck===n?1-this.zoomAdjustment(n):1;return this.zoomAtLastRecencyCheck=n,this.commitTime+this.fadeDuration*r>t}setStale(){this.stale=!0}}function Cp(e,t,n,r,o){e.emplaceBack(t?1:0,n?1:0,r||0,o||0),e.emplaceBack(t?1:0,n?1:0,r||0,o||0),e.emplaceBack(t?1:0,n?1:0,r||0,o||0),e.emplaceBack(t?1:0,n?1:0,r||0,o||0)}const DD=Math.pow(2,25),SD=Math.pow(2,24),oE=Math.pow(2,17),CD=Math.pow(2,16),AD=Math.pow(2,9),PD=Math.pow(2,8),RD=Math.pow(2,1);function Ng(e){if(0===e.opacity&&!e.placed)return 0;if(1===e.opacity&&e.placed)return 4294967295;const t=e.placed?1:0,n=Math.floor(127*e.opacity);return n*DD+t*SD+n*oE+t*CD+n*AD+t*PD+n*RD+t}const Od=0;class sE{constructor(t){this._sortAcrossTiles="viewport-y"!==t.layout.get("symbol-z-order")&&void 0!==t.layout.get("symbol-sort-key").constantOr(1),this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs=new Set,this._bucketParts=[]}continuePlacement(t,n,r,o,s){const c=this._bucketParts;for(;this._currentTileIndex<t.length;)if(n.getBucketParts(c,o,t[this._currentTileIndex],this._sortAcrossTiles),this._currentTileIndex++,s())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,c.sort((u,d)=>u.sortKey-d.sortKey));this._currentPartIndex<c.length;){const u=c[this._currentPartIndex];if(n.placeLayerBucketPart(u,this._seenCrossTileIDs,r,0===u.symbolInstanceStart),this._currentPartIndex++,s())return!0}return!1}}class cv{constructor(t,n,r,o,s,c,u,d,f){this.placement=new iE(t,s,c,u,d,f),this._currentPlacementIndex=n.length-1,this._forceFullPlacement=r,this._showCollisionBoxes=o,this._done=!1}isDone(){return this._done}continuePlacement(t,n,r,o){const s=De.now(),c=()=>{const u=De.now()-s;return!this._forceFullPlacement&&u>2};for(;this._currentPlacementIndex>=0;){const u=n[t[this._currentPlacementIndex]],d=this.placement.collisionIndex.transform.zoom;if("symbol"===u.type&&(!u.minzoom||u.minzoom<=d)&&(!u.maxzoom||u.maxzoom>d)){const f=u,m=f.layout.get("symbol-z-elevate"),g=this._inProgressLayer=this._inProgressLayer||new sE(f),y=$i(u.source,u.scope);if(g.continuePlacement(m?o[y]:r[y],this.placement,this._showCollisionBoxes,u,c))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(t){return this.placement.commit(t),this.placement}}const aE=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class zg{static from(t){if(!(t instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[n,r]=new Uint8Array(t,0,2);if(219!==n)throw new Error("Data does not appear to be in a KDBush format.");const o=r>>4;if(1!==o)throw new Error(`Got v${o} data when expected v1.`);const s=aE[15&r];if(!s)throw new Error("Unrecognized array type.");const[c]=new Uint16Array(t,2,1),[u]=new Uint32Array(t,4,1);return new zg(u,c,s,t)}constructor(t,n=64,r=Float64Array,o){if(isNaN(t)||t<0)throw new Error(`Unpexpected numItems value: ${t}.`);this.numItems=+t,this.nodeSize=Math.min(Math.max(+n,2),65535),this.ArrayType=r,this.IndexArrayType=t<65536?Uint16Array:Uint32Array;const s=aE.indexOf(this.ArrayType),c=2*t*this.ArrayType.BYTES_PER_ELEMENT,u=t*this.IndexArrayType.BYTES_PER_ELEMENT,d=(8-u%8)%8;if(s<0)throw new Error(`Unexpected typed array class: ${r}.`);o&&o instanceof ArrayBuffer?(this.data=o,this.ids=new this.IndexArrayType(this.data,8,t),this.coords=new this.ArrayType(this.data,8+u+d,2*t),this._pos=2*t,this._finished=!0):(this.data=new ArrayBuffer(8+c+u+d),this.ids=new this.IndexArrayType(this.data,8,t),this.coords=new this.ArrayType(this.data,8+u+d,2*t),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+s]),new Uint16Array(this.data,2,1)[0]=n,new Uint32Array(this.data,4,1)[0]=t)}add(t,n){const r=this._pos>>1;return this.ids[r]=r,this.coords[this._pos++]=t,this.coords[this._pos++]=n,r}finish(){const t=this._pos>>1;if(t!==this.numItems)throw new Error(`Added ${t} items when expected ${this.numItems}.`);return Ap(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(t,n,r,o){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:s,coords:c,nodeSize:u}=this,d=[0,s.length-1,0],f=[];for(;d.length;){const m=d.pop()||0,g=d.pop()||0,y=d.pop()||0;if(g-y<=u){for(let E=y;E<=g;E++){const M=c[2*E],D=c[2*E+1];M>=t&&M<=r&&D>=n&&D<=o&&f.push(s[E])}continue}const v=y+g>>1,x=c[2*v],w=c[2*v+1];x>=t&&x<=r&&w>=n&&w<=o&&f.push(s[v]),(0===m?t<=x:n<=w)&&(d.push(y),d.push(v-1),d.push(1-m)),(0===m?r>=x:o>=w)&&(d.push(v+1),d.push(g),d.push(1-m))}return f}within(t,n,r){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:o,coords:s,nodeSize:c}=this,u=[0,o.length-1,0],d=[],f=r*r;for(;u.length;){const m=u.pop()||0,g=u.pop()||0,y=u.pop()||0;if(g-y<=c){for(let E=y;E<=g;E++)cE(s[2*E],s[2*E+1],t,n)<=f&&d.push(o[E]);continue}const v=y+g>>1,x=s[2*v],w=s[2*v+1];cE(x,w,t,n)<=f&&d.push(o[v]),(0===m?t-r<=x:n-r<=w)&&(u.push(y),u.push(v-1),u.push(1-m)),(0===m?t+r>=x:n+r>=w)&&(u.push(v+1),u.push(g),u.push(1-m))}return d}}function Ap(e,t,n,r,o,s){if(o-r<=n)return;const c=r+o>>1;lE(e,t,c,r,o,s),Ap(e,t,n,r,c-1,1-s),Ap(e,t,n,c+1,o,1-s)}function lE(e,t,n,r,o,s){for(;o>r;){if(o-r>600){const f=o-r+1,m=n-r+1,g=Math.log(f),y=.5*Math.exp(2*g/3),v=.5*Math.sqrt(g*y*(f-y)/f)*(m-f/2<0?-1:1);lE(e,t,n,Math.max(r,Math.floor(n-m*y/f+v)),Math.min(o,Math.floor(n+(f-m)*y/f+v)),s)}const c=t[2*n+s];let u=r,d=o;for(Pp(e,t,r,n),t[2*o+s]>c&&Pp(e,t,r,o);u<d;){for(Pp(e,t,u,d),u++,d--;t[2*u+s]<c;)u++;for(;t[2*d+s]>c;)d--}t[2*r+s]===c?Pp(e,t,r,d):(d++,Pp(e,t,d,o)),d<=n&&(r=d+1),n<=d&&(o=d-1)}}function Pp(e,t,n,r){zl(e,n,r),zl(t,2*n,2*r),zl(t,2*n+1,2*r+1)}function zl(e,t,n){const r=e[t];e[t]=e[n],e[n]=r}function cE(e,t,n,r){const o=e-n,s=t-r;return o*o+s*s}const uv=512/et/2;class zC{constructor(t,n,r){this.tileID=t,this.bucketInstanceId=r,this.index=new zg(n.length,16,Int32Array),this.keys=[],this.crossTileIDs=[];const o=t.canonical.x*et,s=t.canonical.y*et;for(let c=0;c<n.length;c++){const{key:u,crossTileID:d,tileAnchorX:f,tileAnchorY:m}=n.get(c),g=Math.floor((o+f)*uv),y=Math.floor((s+m)*uv);this.index.add(g,y),this.keys.push(u),this.crossTileIDs.push(d)}this.index.finish()}findMatches(t,n,r){const o=this.tileID.canonical.z<n.canonical.z?1:Math.pow(2,this.tileID.canonical.z-n.canonical.z),s=uv/Math.pow(2,n.canonical.z-this.tileID.canonical.z),c=n.canonical.x*et,u=n.canonical.y*et;for(let d=0;d<t.length;d++){const f=t.get(d);if(f.crossTileID)continue;const{key:m,tileAnchorX:g,tileAnchorY:y}=f,v=Math.floor((c+g)*s),x=Math.floor((u+y)*s),w=this.index.range(v-o,x-o,v+o,x+o);for(const E of w){const M=this.crossTileIDs[E];if(this.keys[E]===m&&!r.has(M)){r.add(M),f.crossTileID=M;break}}}}}class hv{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class dv{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(t){const n=Math.round((t-this.lng)/360);if(0!==n)for(const r in this.indexes){const o=this.indexes[r],s={};for(const c in o){const u=o[c];u.tileID=u.tileID.unwrapTo(u.tileID.wrap+n),s[u.tileID.key]=u}this.indexes[r]=s}this.lng=t}addBucket(t,n,r){if(this.indexes[t.overscaledZ]&&this.indexes[t.overscaledZ][t.key]){if(this.indexes[t.overscaledZ][t.key].bucketInstanceId===n.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(t.overscaledZ,this.indexes[t.overscaledZ][t.key])}for(let s=0;s<n.symbolInstances.length;s++)n.symbolInstances.get(s).crossTileID=0;this.usedCrossTileIDs[t.overscaledZ]||(this.usedCrossTileIDs[t.overscaledZ]=new Set);const o=this.usedCrossTileIDs[t.overscaledZ];for(const s in this.indexes){const c=this.indexes[s];if(Number(s)>t.overscaledZ)for(const u in c){const d=c[u];d.tileID.isChildOf(t)&&d.findMatches(n.symbolInstances,t,o)}else{const u=c[t.scaledTo(Number(s)).key];u&&u.findMatches(n.symbolInstances,t,o)}}for(let s=0;s<n.symbolInstances.length;s++){const c=n.symbolInstances.get(s);c.crossTileID||(c.crossTileID=r.generate(),o.add(c.crossTileID))}return void 0===this.indexes[t.overscaledZ]&&(this.indexes[t.overscaledZ]={}),this.indexes[t.overscaledZ][t.key]=new zC(t,n.symbolInstances,n.bucketInstanceId),!0}removeBucketCrossTileIDs(t,n){for(const r of n.crossTileIDs)this.usedCrossTileIDs[t].delete(r)}removeStaleBuckets(t){let n=!1;for(const r in this.indexes){const o=this.indexes[r];for(const s in o)t[o[s].bucketInstanceId]||(this.removeBucketCrossTileIDs(r,o[s]),delete o[s],n=!0)}return n}}class LD{constructor(){this.layerIndexes={},this.crossTileIDs=new hv,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(t,n,r,o){let s=this.layerIndexes[t.fqid];void 0===s&&(s=this.layerIndexes[t.fqid]=new dv);let c=!1;const u={};"globe"!==o.name&&s.handleWrapJump(r);for(const d of n){const f=d.getBucket(t);f&&t.fqid===f.layerIds[0]&&(f.bucketInstanceId||(f.bucketInstanceId=++this.maxBucketInstanceId),s.addBucket(d.tileID,f,this.crossTileIDs)&&(c=!0),u[f.bucketInstanceId]=!0)}return s.removeStaleBuckets(u)&&(c=!0),c}pruneUnusedLayers(t){const n={};t.forEach(r=>{n[r]=!0});for(const r in this.layerIndexes)n[r]||delete this.layerIndexes[r]}}var fv="\n#define EPSILON 0.0000001\n#define PI 3.141592653589793\n#ifdef RENDER_CUTOFF\nfloat cutoff_opacity(vec4 cutoff_params,float depth) {float near=cutoff_params.x;float far=cutoff_params.y;float cutoffStart=cutoff_params.z;float cutoffEnd=cutoff_params.w-0.0001;float linearDepth=(depth-near)/(far-near);return clamp((linearDepth-cutoffStart)/(cutoffEnd-cutoffStart),0.0,1.0);}\n#endif",uE="in highp vec3 a_pos_3f;uniform lowp mat4 u_matrix;out highp vec3 v_uv;void main() {const mat3 half_neg_pi_around_x=mat3(1.0,0.0, 0.0,0.0,0.0,-1.0,0.0,1.0, 0.0);v_uv=half_neg_pi_around_x*a_pos_3f;vec4 pos=u_matrix*vec4(a_pos_3f,1.0);gl_Position=pos.xyww;}",hE="\n#define ELEVATION_SCALE 7.0\n#define ELEVATION_OFFSET 450.0\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_tl_up;uniform vec3 u_tile_tr_up;uniform vec3 u_tile_br_up;uniform vec3 u_tile_bl_up;uniform float u_tile_up_scale;vec3 elevationVector(vec2 pos) {vec2 uv=pos/EXTENT;vec3 up=normalize(mix(\nmix(u_tile_tl_up,u_tile_tr_up,uv.xxx),mix(u_tile_bl_up,u_tile_br_up,uv.xxx),uv.yyy));return up*u_tile_up_scale;}\n#else\nvec3 elevationVector(vec2 pos) { return vec3(0,0,1); }\n#endif\n#ifdef TERRAIN\nuniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;uniform vec2 u_dem_tl;uniform vec2 u_dem_tl_prev;uniform float u_dem_scale;uniform float u_dem_scale_prev;uniform float u_dem_size;uniform float u_dem_lerp;uniform float u_exaggeration;uniform float u_meter_to_dem;uniform mat4 u_label_plane_matrix_inv;uniform sampler2D u_depth;uniform vec2 u_depth_size_inv;vec4 tileUvToDemSample(vec2 uv,float dem_size,float dem_scale,vec2 dem_tl) {vec2 pos=dem_size*(uv*dem_scale+dem_tl)+1.0;vec2 f=fract(pos);return vec4((pos-f+0.5)/(dem_size+2.0),f);}float currentElevation(vec2 apos) {\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nvec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale+u_dem_tl)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem,pos).r;\n#else\nfloat dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale,u_dem_tl);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(dd,0)).r;float bl=texture(u_dem,pos+vec2(0,dd)).r;float br=texture(u_dem,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);\n#endif\n}float prevElevation(vec2 apos) {\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nvec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale_prev+u_dem_tl_prev)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem_prev,pos).r;\n#else\nfloat dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale_prev,u_dem_tl_prev);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem_prev,pos).r;float tr=texture(u_dem_prev,pos+vec2(dd,0)).r;float bl=texture(u_dem_prev,pos+vec2(0,dd)).r;float br=texture(u_dem_prev,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);\n#endif\n}\n#ifdef TERRAIN_VERTEX_MORPHING\nfloat elevation(vec2 apos) {\n#ifdef ZERO_EXAGGERATION\nreturn 0.0;\n#endif\nfloat nextElevation=currentElevation(apos);float prevElevation=prevElevation(apos);return mix(prevElevation,nextElevation,u_dem_lerp);}\n#else\nfloat elevation(vec2 apos) {\n#ifdef ZERO_EXAGGERATION\nreturn 0.0;\n#endif\nreturn currentElevation(apos);}\n#endif\nhighp float unpack_depth(highp vec4 rgba_depth)\n{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}bool isOccluded(vec4 frag) {vec3 coord=frag.xyz/frag.w;float depth=unpack_depth(texture(u_depth,(coord.xy+1.0)*0.5));return coord.z > depth+0.0005;}float occlusionFade(vec4 frag) {vec3 coord=frag.xyz/frag.w;vec3 df=vec3(5.0*u_depth_size_inv,0.0);vec2 uv=0.5*coord.xy+0.5;vec4 depth=vec4(\nunpack_depth(texture(u_depth,uv-df.xz)),unpack_depth(texture(u_depth,uv+df.xz)),unpack_depth(texture(u_depth,uv-df.zy)),unpack_depth(texture(u_depth,uv+df.zy))\n);return dot(vec4(0.25),vec4(1.0)-clamp(300.0*(vec4(coord.z-0.001)-depth),0.0,1.0));}vec4 fourSample(vec2 pos,vec2 off) {float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(off.x,0.0)).r;float bl=texture(u_dem,pos+vec2(0.0,off.y)).r;float br=texture(u_dem,pos+off).r;return vec4(tl,tr,bl,br);}float flatElevation(vec2 pack) {vec2 apos=floor(pack/8.0);vec2 span=10.0*(pack-apos*8.0);vec2 uvTex=(apos-vec2(1.0,1.0))/8190.0;float size=u_dem_size+2.0;float dd=1.0/size;vec2 pos=u_dem_size*(uvTex*u_dem_scale+u_dem_tl)+1.0;vec2 f=fract(pos);pos=(pos-f+0.5)*dd;vec4 h=fourSample(pos,vec2(dd));float z=mix(mix(h.x,h.y,f.x),mix(h.z,h.w,f.x),f.y);vec2 w=floor(0.5*(span*u_meter_to_dem-1.0));vec2 d=dd*w;h=fourSample(pos-d,2.0*d+vec2(dd));vec4 diff=abs(h.xzxy-h.ywzw);vec2 slope=min(vec2(0.25),u_meter_to_dem*0.5*(diff.xz+diff.yw)/(2.0*w+vec2(1.0)));vec2 fix=slope*span;float base=z+max(fix.x,fix.y);return u_exaggeration*base;}float elevationFromUint16(float word) {return u_exaggeration*(word/ELEVATION_SCALE-ELEVATION_OFFSET);}\n#else\nfloat elevation(vec2 pos) { return 0.0; }bool isOccluded(vec4 frag) { return false; }float occlusionFade(vec4 frag) { return 1.0; }\n#endif",Bg="#ifdef FOG\nuniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump mat4 u_fog_matrix;out vec3 v_fog_pos;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}vec3 fog_position(vec3 pos) {return (u_fog_matrix*vec4(pos,1.0)).xyz;}vec3 fog_position(vec2 pos) {return fog_position(vec3(pos,0.0));}float fog(vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));return opacity*fog_horizon_blending(pos/depth);}\n#endif",jg="highp vec3 hash(highp vec2 p) {highp vec3 p3=fract(p.xyx*vec3(443.8975,397.2973,491.1871));p3+=dot(p3,p3.yxz+19.19);return fract((p3.xxy+p3.yzz)*p3.zyx);}vec3 dither(vec3 color,highp vec2 seed) {vec3 rnd=hash(seed)+hash(seed+0.59374)-0.5;return color+rnd/255.0;}\n#ifdef FOG\nuniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump vec2 u_fog_vertical_limit;uniform mediump float u_fog_temporal_offset;in vec3 v_fog_pos;uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform highp vec2 u_viewport;uniform float u_globe_transition;uniform int u_is_globe;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}float globe_glow_progress() {highp vec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float sdf=length(closest_point-u_globe_pos)/u_globe_radius;return sdf+PI*0.5;}float fog_opacity(vec3 pos) {float depth=length(pos);return fog_opacity(fog_range(depth));}vec3 fog_apply(vec3 color,vec3 pos,float opacity_limit) {float depth=length(pos);float opacity;if (u_is_globe==1) {float glow_progress=globe_glow_progress();float t=mix(glow_progress,depth,u_globe_transition);opacity=fog_opacity(fog_range(t));} else {opacity=fog_opacity(fog_range(depth));opacity*=fog_horizon_blending(pos/depth);}return mix(color,u_fog_color.rgb,min(opacity,opacity_limit));}vec3 fog_apply(vec3 color,vec3 pos) {return fog_apply(color,pos,1.0);}vec4 fog_apply_from_vert(vec4 color,float fog_opac) {float alpha=EPSILON+color.a;color.rgb=mix(color.rgb/alpha,u_fog_color.rgb,fog_opac)*alpha;return color;}vec3 fog_apply_sky_gradient(vec3 camera_ray,vec3 sky_color) {float horizon_blend=fog_horizon_blending(normalize(camera_ray));return mix(sky_color,u_fog_color.rgb,horizon_blend);}vec4 fog_apply_premultiplied(vec4 color,vec3 pos) {float alpha=EPSILON+color.a;color.rgb=fog_apply(color.rgb/alpha,pos)*alpha;return color;}vec4 fog_apply_premultiplied(vec4 color,vec3 pos,float heightMeters) {float verticalProgress=(u_fog_vertical_limit.x > 0.0 || u_fog_vertical_limit.y > 0.0) ? smoothstep(u_fog_vertical_limit.x,u_fog_vertical_limit.y,heightMeters) : 0.0;float opacityLimit=1.0-smoothstep(0.9,1.0,fog_opacity(pos));return mix(fog_apply_premultiplied(color,pos),color,min(verticalProgress,opacityLimit));}vec3 fog_dither(vec3 color) {\n#ifdef FOG_DITHERING\nvec2 dither_seed=gl_FragCoord.xy+u_fog_temporal_offset;return dither(color,dither_seed);\n#else\nreturn color;\n#endif\n}vec4 fog_dither(vec4 color) {return vec4(fog_dither(color.rgb),color.a);}\n#endif",pv="#ifdef RASTER_ARRAY\nuniform sampler2D u_image0;uniform sampler2D u_image1;const vec4 NODATA=vec4(1);vec4 _raTexLinearCoord(vec2 texCoord,vec2 texResolution,out vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return (texCoord.xxyy+vec2(1.5,0.5).xyxy)/texResolution.xxyy;}vec2 _raTexLinearMix(vec2 fxy,vec4 colorMix,float colorOffset,vec4 t00,vec4 t10,vec4 t01,vec4 t11) {vec2 c00=t00==NODATA ? vec2(0) : vec2(colorOffset+dot(t00,colorMix),1);vec2 c10=t10==NODATA ? vec2(0) : vec2(colorOffset+dot(t10,colorMix),1);vec2 c01=t01==NODATA ? vec2(0) : vec2(colorOffset+dot(t01,colorMix),1);vec2 c11=t11==NODATA ? vec2(0) : vec2(colorOffset+dot(t11,colorMix),1);return mix(mix(c01,c11,fxy.x),mix(c00,c10,fxy.x),fxy.y);}vec2 raTexture2D_image0_linear(vec2 texCoord,vec2 texResolution,vec4 colorMix,float colorOffset) {vec2 fxy;vec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texture(u_image0,c.yz),texture(u_image0,c.xz),texture(u_image0,c.yw),texture(u_image0,c.xw)\n);}vec2 raTexture2D_image1_linear(vec2 texCoord,vec2 texResolution,vec4 colorMix,float colorOffset) {vec2 fxy;vec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texture(u_image1,c.yz),texture(u_image1,c.xz),texture(u_image1,c.yw),texture(u_image1,c.xw)\n);}vec2 raTexture2D_image0_nearest(vec2 texCoord,vec2 texResolution,vec4 colorMix,float colorOffset) {vec4 t=texture(u_image0,texCoord);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}vec2 raTexture2D_image1_nearest(vec2 texCoord,vec2 texResolution,vec4 colorMix,float colorOffset) {vec4 t=texture(u_image1,texCoord);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}\n#endif",mv="#ifdef RENDER_SHADOWS\nuniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_normal_offset;vec3 shadow_normal_offset(vec3 normal) {float tileInMeters=u_shadow_normal_offset[0];vec3 n=vec3(-normal.xy,tileInMeters*normal.z);float dotScale=min(1.0-dot(normal,u_shadow_direction),1.0)*0.5+0.5;return n*dotScale;}vec3 shadow_normal_offset_model(vec3 normal) {float dotScale=min(1.0-dot(normal,u_shadow_direction),1.0)*0.5+0.5;return normal*dotScale;}float shadow_normal_offset_multiplier0() {return u_shadow_normal_offset[1];}float shadow_normal_offset_multiplier1() {return u_shadow_normal_offset[2];}\n#endif//RENDER_SHADOWS",gv="#ifdef RENDER_SHADOWS\n#ifdef DEPTH_TEXTURE\nuniform highp sampler2D u_shadowmap_0;uniform highp sampler2D u_shadowmap_1;\n#else\nuniform sampler2D u_shadowmap_0;uniform sampler2D u_shadowmap_1;\n#endif\nuniform float u_shadow_intensity;uniform float u_shadow_map_resolution;uniform float u_shadow_texel_size;uniform highp vec3 u_shadow_normal_offset;uniform vec2 u_fade_range;uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_bias;highp float shadow_sample_1(highp vec2 uv,highp float compare) {highp float shadow_depth;\n#ifdef DEPTH_TEXTURE\nshadow_depth=texture(u_shadowmap_1,uv).r;\n#else\nshadow_depth=unpack_depth(texture(u_shadowmap_1,uv))*0.5+0.5;\n#endif\nreturn step(shadow_depth,compare);}highp float shadow_sample_0(highp vec2 uv,highp float compare) {highp float shadow_depth;\n#ifdef DEPTH_TEXTURE\nshadow_depth=texture(u_shadowmap_0,uv).r;\n#else\nshadow_depth=unpack_depth(texture(u_shadowmap_0,uv))*0.5+0.5;\n#endif\nreturn step(shadow_depth,compare);}float shadow_occlusion_1(highp vec4 pos,highp float bias) {highp vec2 uv=pos.xy;return shadow_sample_1(uv,pos.z-bias);}float shadow_occlusion_0(highp vec4 pos,highp float bias) {highp float compare0=pos.z-bias;\n#ifdef NATIVE\nhighp vec2 uv=pos.xy;highp vec4 samples=textureGather(u_shadowmap_0,uv,0);lowp vec4 stepSamples=step(samples,vec4(compare0));\n#else\nhighp vec2 uv00=pos.xy-vec2(0.5*u_shadow_texel_size);highp vec2 uv10=uv00+vec2(u_shadow_texel_size,0.0);highp vec2 uv01=uv00+vec2(0.0,u_shadow_texel_size);highp vec2 uv11=uv01+vec2(u_shadow_texel_size,0.0);lowp vec4 stepSamples=vec4(\nshadow_sample_0(uv01,compare0),shadow_sample_0(uv11,compare0),shadow_sample_0(uv10,compare0),shadow_sample_0(uv00,compare0)\n);\n#endif\nvec2 f=fract(pos.xy*u_shadow_map_resolution-vec2(0.5));lowp vec2 lerpx=mix(stepSamples.wx,stepSamples.zy,f.xx);return mix(lerpx.x,lerpx.y,f.y);}float shadow_occlusion(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,highp float bias) {\n#ifdef SHADOWS_SINGLE_CASCADE\nlight_view_pos0.xyz=light_view_pos0.xyz/light_view_pos0.w*0.5+0.5;return shadow_occlusion_0(light_view_pos0,bias);\n#else\nlight_view_pos0.xyz/=light_view_pos0.w;light_view_pos1.xyz/=light_view_pos1.w;vec4 uv=vec4(light_view_pos0.xy,light_view_pos1.xy);vec4 abs_bounds=abs(uv);if (abs_bounds.x < 1.0 && abs_bounds.y < 1.0) {light_view_pos0.xyz=light_view_pos0.xyz*0.5+0.5;return shadow_occlusion_0(light_view_pos0,bias);}if (abs_bounds.z >=1.0 || abs_bounds.w >=1.0) {return 0.0;}light_view_pos1.xyz=light_view_pos1.xyz*0.5+0.5;float occlusion1=shadow_occlusion_1(light_view_pos1,bias);return mix(occlusion1,0.0,smoothstep(u_fade_range.x,u_fade_range.y,view_depth));\n#endif\n}highp float calculate_shadow_bias(float NDotL) {\n#ifdef NORMAL_OFFSET\nreturn 0.5*u_shadow_bias.x;\n#else\nreturn 0.5*(u_shadow_bias.x+clamp(u_shadow_bias.y*tan(acos(NDotL)),0.0,u_shadow_bias.z));\n#endif\n}float shadowed_light_factor_normal(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_unbiased(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadow_occlusion(float ndotl,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=calculate_shadow_bias(ndotl);return shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);}\n#endif";const _v=[];vv(fv,_v);const Vg={"_prelude_fog.vertex.glsl":Bg,"_prelude_terrain.vertex.glsl":hE,"_prelude_shadow.vertex.glsl":mv,"_prelude_fog.fragment.glsl":jg,"_prelude_shadow.fragment.glsl":gv,"_prelude_lighting.glsl":"\n#ifdef LIGHTING_3D_MODE\nuniform mediump vec3 u_lighting_ambient_color;uniform mediump vec3 u_lighting_directional_dir;uniform mediump vec3 u_lighting_directional_color;uniform mediump vec3 u_ground_radiance;float calculate_ambient_directional_factor(vec3 normal) {float NdotL=dot(normal,u_lighting_directional_dir);const float factor_reduction_max=0.3;float dir_luminance=dot(u_lighting_directional_color,vec3(0.2126,0.7152,0.0722));float directional_factor_min=1.0-factor_reduction_max*min(dir_luminance,1.0);float ambient_directional_factor=mix(directional_factor_min,1.0,min((NdotL+1.0),1.0));const float vertical_factor_min=0.92;float vertical_factor=mix(vertical_factor_min,1.0,normal.z*0.5+0.5);return vertical_factor*ambient_directional_factor;}vec3 linearProduct(vec3 srgbIn,vec3 k) {return srgbIn*pow(k,vec3(1./2.2));}vec3 apply_lighting(vec3 color,vec3 normal,float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return linearProduct(color,ambient_contrib+directional_contrib);}vec4 apply_lighting(vec4 color,vec3 normal,float dir_factor) {return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting(vec3 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return apply_lighting(color.rgb,normal,dir_factor);}vec4 apply_lighting(vec4 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting_ground(vec3 color) {return color*u_ground_radiance;}vec4 apply_lighting_ground(vec4 color) {return vec4(apply_lighting_ground(color.rgb),color.a);}float calculate_NdotL(vec3 normal) {const float ext=0.70710678118;return (clamp(dot(normal,u_lighting_directional_dir),-ext,1.0)+ext)/(1.0+ext);}vec4 apply_lighting_with_emission_ground(vec4 color,float emissive_strength) {return mix(apply_lighting_ground(color),color,emissive_strength);}vec3 compute_flood_lighting(vec3 flood_light_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=flood_light_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);float occlusion_ramp=smoothstep(0.0,0.2,1.0-occlusion);return mix(fully_occluded_color,flood_light_color,occlusion_ramp);}vec3 compute_emissive_draped(vec3 unlit_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=unlit_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);return mix(fully_occluded_color,unlit_color,1.0-occlusion);}\n#endif//LIGHTING_3D_MODE","_prelude_raster_array.glsl":pv},Ug={};Tn("",hE),Tn(jg,Bg),Tn(gv,mv),Tn(pv,"");const dE=Tn("\nout vec4 glFragColor;highp float unpack_depth(highp vec4 rgba_depth)\n{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}highp vec4 pack_depth(highp float ndc_z) {highp float depth=ndc_z*0.5+0.5;const highp vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const highp vec4 bit_mask =vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);highp vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}\n#ifdef INDICATOR_CUTOUT\nuniform vec2 u_indicator_cutout_centers;uniform vec4 u_indicator_cutout_params;\n#endif\nvec4 applyCutout(vec4 color) {\n#ifdef INDICATOR_CUTOUT\nfloat holeMinOpacity=u_indicator_cutout_params.x;float holeRadius=max(u_indicator_cutout_params.y,0.0);float holeAspectRatio=u_indicator_cutout_params.z;float fadeStart=u_indicator_cutout_params.w;float distA=distance(vec2(gl_FragCoord.x,gl_FragCoord.y*holeAspectRatio),vec2(u_indicator_cutout_centers[0],u_indicator_cutout_centers[1]*holeAspectRatio));return color*min(smoothstep(fadeStart,holeRadius,distA)+holeMinOpacity,1.0);\n#else\nreturn color;\n#endif\n}\n#ifdef DEBUG_WIREFRAME\n#define HANDLE_WIREFRAME_DEBUG \\\nglFragColor=vec4(0.7,0.0,0.0,0.7); \\\ngl_FragDepth=gl_FragCoord.z-0.0001;\n#else\n#define HANDLE_WIREFRAME_DEBUG\n#endif\n#ifdef RENDER_CUTOFF\nuniform highp vec4 u_cutoff_params;in float v_cutoff_opacity;\n#endif","\n#define EXTENT 8192.0\n#define RAD_TO_DEG 180.0/PI\n#define DEG_TO_RAD PI/180.0\n#define GLOBE_RADIUS EXTENT/PI/2.0\nfloat wrap(float n,float min,float max) {float d=max-min;float w=mod(mod(n-min,d)+d,d)+min;return (w==min) ? max : w;}\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 mercator_tile_position(mat4 matrix,vec2 tile_anchor,vec3 tile_id,vec2 mercator_center) {\n#ifndef PROJECTED_POS_ON_VIEWPORT\nfloat tiles=tile_id.z;vec2 mercator=(tile_anchor/EXTENT+tile_id.xy)/tiles;mercator-=mercator_center;mercator.x=wrap(mercator.x,-0.5,0.5);vec4 mercator_tile=vec4(mercator.xy*EXTENT,EXTENT/(2.0*PI),1.0);mercator_tile=matrix*mercator_tile;return mercator_tile.xyz;\n#else\nreturn vec3(0.0);\n#endif\n}vec3 mix_globe_mercator(vec3 globe,vec3 mercator,float t) {return mix(globe,mercator,t);}mat3 globe_mercator_surface_vectors(vec3 pos_normal,vec3 up_dir,float zoom_transition) {vec3 normal=zoom_transition==0.0 ? pos_normal : normalize(mix(pos_normal,up_dir,zoom_transition));vec3 xAxis=normalize(vec3(normal.z,0.0,-normal.x));vec3 yAxis=normalize(cross(normal,xAxis));return mat3(xAxis,yAxis,normal);}\n#endif\nvec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(\nunpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0\n);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (tile_units_to_pixels*pos+offset)/pattern_size;}float mercatorXfromLng(float lng) {return (180.0+lng)/360.0;}float mercatorYfromLat(float lat) {return (180.0-(RAD_TO_DEG*log(tan(PI/4.0+lat/2.0*DEG_TO_RAD))))/360.0;}vec3 latLngToECEF(vec2 latLng) {latLng=DEG_TO_RAD*latLng;float cosLat=cos(latLng[0]);float sinLat=sin(latLng[0]);float cosLng=cos(latLng[1]);float sinLng=sin(latLng[1]);float sx=cosLat*sinLng*GLOBE_RADIUS;float sy=-sinLat*GLOBE_RADIUS;float sz=cosLat*cosLng*GLOBE_RADIUS;return vec3(sx,sy,sz);}\n#ifdef RENDER_CUTOFF\nuniform vec4 u_cutoff_params;out float v_cutoff_opacity;\n#endif\nconst vec4 AWAY=vec4(-1000.0,-1000.0,-1000.0,1);const float skirtOffset=24575.0;vec3 decomposeToPosAndSkirt(vec2 posWithComposedSkirt)\n{float skirt=float(posWithComposedSkirt.x >=skirtOffset);vec2 pos=posWithComposedSkirt-vec2(skirt*skirtOffset,0.0);return vec3(pos,skirt);}"),fE=fv;var yv={background:Tn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec4 u_color;uniform float u_opacity;\n#ifdef LIGHTING_3D_MODE\nin vec4 v_color;\n#endif\nvoid main() {vec4 out_color;\n#ifdef LIGHTING_3D_MODE\nout_color=v_color;\n#else\nout_color=u_color;\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_lighting.glsl"\nin vec2 a_pos;uniform mat4 u_matrix;\n#ifdef LIGHTING_3D_MODE\nuniform mediump vec4 u_color;out vec4 v_color;uniform float u_emissive_strength;\n#endif\nvoid main() {gl_Position=u_matrix*vec4(a_pos,0,1);\n#ifdef LIGHTING_3D_MODE\nv_color=apply_lighting_with_emission_ground(u_color,u_emissive_strength);\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),backgroundPattern:Tn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec2 u_pattern_tl;uniform vec2 u_pattern_br;uniform vec2 u_texsize;uniform float u_opacity;uniform float u_emissive_strength;uniform sampler2D u_image;in vec2 v_pos;void main() {vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(u_pattern_tl/u_texsize,u_pattern_br/u_texsize,imagecoord);vec4 out_color=texture(u_image,pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_pattern_size;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_pattern_size,u_tile_units_to_pixels,a_pos);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),circle:Tn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nin vec3 v_data;in float v_visibility;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump float radius\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp vec4 stroke_color\n#pragma mapbox: define mediump float stroke_width\n#pragma mapbox: define lowp float stroke_opacity\nuniform float u_emissive_strength;void main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump float radius\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp vec4 stroke_color\n#pragma mapbox: initialize mediump float stroke_width\n#pragma mapbox: initialize lowp float stroke_opacity\nvec2 extrude=v_data.xy;float extrude_length=length(extrude);lowp float antialiasblur=v_data.z;float antialiased_blur=-max(blur,antialiasblur);float opacity_t=smoothstep(0.0,antialiased_blur,extrude_length-1.0);float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(\nantialiased_blur,0.0,extrude_length-radius/(radius+stroke_width)\n);vec4 out_color=mix(color*opacity,stroke_color*stroke_opacity,color_t);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_apply_premultiplied(out_color,v_fog_pos);\n#endif\nglFragColor=out_color*(v_visibility*opacity_t);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\n}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#define NUM_VISIBILITY_RINGS 2\n#define INV_SQRT2 0.70710678\n#define ELEVATION_BIAS 0.0001\n#define NUM_SAMPLES_PER_RING 16\nuniform mat4 u_matrix;uniform mat2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;in vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;\n#endif\nout vec3 v_data;out float v_visibility;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump float radius\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp vec4 stroke_color\n#pragma mapbox: define mediump float stroke_width\n#pragma mapbox: define lowp float stroke_opacity\nvec2 calc_offset(vec2 extrusion,float radius,float stroke_width, float view_scale) {return extrusion*(radius+stroke_width)*u_extrude_scale*view_scale;}float cantilevered_elevation(vec2 pos,float radius,float stroke_width,float view_scale) {vec2 c1=pos+calc_offset(vec2(-1,-1),radius,stroke_width,view_scale);vec2 c2=pos+calc_offset(vec2(1,-1),radius,stroke_width,view_scale);vec2 c3=pos+calc_offset(vec2(1,1),radius,stroke_width,view_scale);vec2 c4=pos+calc_offset(vec2(-1,1),radius,stroke_width,view_scale);float h1=elevation(c1)+ELEVATION_BIAS;float h2=elevation(c2)+ELEVATION_BIAS;float h3=elevation(c3)+ELEVATION_BIAS;float h4=elevation(c4)+ELEVATION_BIAS;return max(h4,max(h3,max(h1,h2)));}float circle_elevation(vec2 pos) {\n#if defined(TERRAIN)\nreturn elevation(pos)+ELEVATION_BIAS;\n#else\nreturn 0.0;\n#endif\n}vec4 project_vertex(vec2 extrusion,vec4 world_center,vec4 projected_center,float radius,float stroke_width, float view_scale,mat3 surface_vectors) {vec2 sample_offset=calc_offset(extrusion,radius,stroke_width,view_scale);\n#ifdef PITCH_WITH_MAP\n#ifdef PROJECTION_GLOBE_VIEW\nreturn u_matrix*( world_center+vec4(sample_offset.x*surface_vectors[0]+sample_offset.y*surface_vectors[1],0) );\n#else\nreturn u_matrix*( world_center+vec4(sample_offset,0,0) );\n#endif\n#else\nreturn projected_center+vec4(sample_offset,0,0);\n#endif\n}float get_sample_step() {\n#ifdef PITCH_WITH_MAP\nreturn 2.0*PI/float(NUM_SAMPLES_PER_RING);\n#else\nreturn PI/float(NUM_SAMPLES_PER_RING);\n#endif\n}void main(void) {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump float radius\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp vec4 stroke_color\n#pragma mapbox: initialize mediump float stroke_width\n#pragma mapbox: initialize lowp float stroke_opacity\nvec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);vec4 world_center;mat3 surface_vectors;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 pos_normal_3=a_pos_normal_3/16384.0;surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(circle_center)*circle_elevation(circle_center);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*circle_elevation(circle_center);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,circle_center,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);world_center=vec4(pos,1);\n#else \nsurface_vectors=mat3(1.0);float height=circle_elevation(circle_center);world_center=vec4(circle_center,height,1);\n#endif\nvec4 projected_center=u_matrix*world_center;float view_scale=0.0;\n#ifdef PITCH_WITH_MAP\n#ifdef SCALE_WITH_MAP\nview_scale=1.0;\n#else\nview_scale=projected_center.w/u_camera_to_center_distance;\n#endif\n#else\n#ifdef SCALE_WITH_MAP\nview_scale=u_camera_to_center_distance;\n#else\nview_scale=projected_center.w;\n#endif\n#endif\ngl_Position=project_vertex(extrude,world_center,projected_center,radius,stroke_width,view_scale,surface_vectors);float visibility=0.0;\n#ifdef TERRAIN\nfloat step=get_sample_step();vec4 occlusion_world_center;vec4 occlusion_projected_center;\n#ifdef PITCH_WITH_MAP\nfloat cantilevered_height=cantilevered_elevation(circle_center,radius,stroke_width,view_scale);occlusion_world_center=vec4(circle_center,cantilevered_height,1);occlusion_projected_center=u_matrix*occlusion_world_center;\n#else\nocclusion_world_center=world_center;occlusion_projected_center=projected_center;\n#endif\nfor(int ring=0; ring < NUM_VISIBILITY_RINGS; ring++) {float scale=(float(ring)+1.0)/float(NUM_VISIBILITY_RINGS);for(int i=0; i < NUM_SAMPLES_PER_RING; i++) {vec2 extrusion=vec2(cos(step*float(i)),-sin(step*float(i)))*scale;vec4 frag_pos=project_vertex(extrusion,occlusion_world_center,occlusion_projected_center,radius,stroke_width,view_scale,surface_vectors);visibility+=float(!isOccluded(frag_pos));}}visibility/=float(NUM_VISIBILITY_RINGS)*float(NUM_SAMPLES_PER_RING);\n#else\nvisibility=1.0;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nvisibility=1.0;\n#endif\nv_visibility=visibility;lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);\n#ifdef FOG\nv_fog_pos=fog_position(world_center.xyz);\n#endif\n}'),clippingMask:Tn("void main() {glFragColor=vec4(1.0);}","in vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:Tn('#include "_prelude_fog.fragment.glsl"\nuniform highp float u_intensity;in vec2 v_extrude;\n#pragma mapbox: define highp float weight\n#define GAUSS_COEF 0.3989422804014327\nvoid main() {\n#pragma mapbox: initialize highp float weight\nfloat d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);glFragColor=vec4(val,1.0,1.0,1.0);\n#ifdef FOG\nif (u_is_globe==0) {glFragColor.r*=pow(1.0-fog_opacity(v_fog_pos),2.0);}\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;in vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;\n#endif\nout vec2 v_extrude;\n#pragma mapbox: define highp float weight\n#pragma mapbox: define mediump float radius\nconst highp float ZERO=1.0/255.0/16.0;\n#define GAUSS_COEF 0.3989422804014327\nvoid main(void) {\n#pragma mapbox: initialize highp float weight\n#pragma mapbox: initialize mediump float radius\nvec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 tilePos=floor(a_pos*0.5);vec3 pos;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(tilePos)*elevation(tilePos);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*elevation(tilePos);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,tilePos,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#else\npos=vec3(tilePos+extrude,elevation(tilePos));\n#endif\ngl_Position=u_matrix*vec4(pos,1);\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}'),heatmapTexture:Tn("uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;in vec2 v_pos;void main() {float t=texture(u_image,v_pos).r;vec4 color=texture(u_color_ramp,vec2(t,0.5));glFragColor=color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(0.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}","in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=vec4(a_pos,0,1);v_pos=a_pos*0.5+0.5;}"),collisionBox:Tn("in float v_placed;in float v_notUsed;void main() {vec4 red =vec4(1.0,0.0,0.0,1.0);vec4 blue=vec4(0.0,0.0,1.0,0.5);glFragColor =mix(red,blue,step(0.5,v_placed))*0.5;glFragColor*=mix(1.0,0.1,step(0.5,v_notUsed));}",'#include "_prelude_terrain.vertex.glsl"\nin vec3 a_pos;in vec2 a_anchor_pos;in vec2 a_extrude;in vec2 a_placed;in vec2 a_shift;in float a_size_scale;in vec2 a_padding;in float a_z_offset;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;out float v_placed;out float v_notUsed;void main() {vec4 projectedPoint=u_matrix*vec4(a_pos+elevationVector(a_anchor_pos)*(a_z_offset+elevation(a_anchor_pos)),1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(\n0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,1.5);gl_Position=projectedPoint;gl_Position.xy+=(a_extrude*a_size_scale+a_shift+a_padding)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}'),collisionCircle:Tn("in float v_radius;in vec2 v_extrude;in float v_perspective_ratio;in float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);glFragColor=color*alpha*opacity_t;}","in vec2 a_pos_2f;in float a_radius;in vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;out float v_radius;out vec2 v_extrude;out float v_perspective_ratio;out float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos_2f;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(\nmix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(\n0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}"),debug:Tn("uniform highp vec4 u_color;uniform sampler2D u_overlay;in vec2 v_uv;void main() {vec4 overlay_color=texture(u_overlay,v_uv);glFragColor=mix(u_color,overlay_color,overlay_color.a);}",'#include "_prelude_terrain.vertex.glsl"\nin vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;\n#endif\nout vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {float h=elevation(a_pos);v_uv=a_pos/8192.0;\n#ifdef PROJECTION_GLOBE_VIEW\ngl_Position=u_matrix*vec4(a_pos_3+elevationVector(a_pos)*h,1);\n#else\ngl_Position=u_matrix*vec4(a_pos*u_overlay_scale,h,1);\n#endif\n}'),fill:Tn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float opacity\nuniform float u_emissive_strength;void main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float opacity\nvec4 out_color=color;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nin vec2 a_pos;uniform mat4 u_matrix;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float opacity\ngl_Position=u_matrix*vec4(a_pos,0,1);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillOutline:Tn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nin vec2 v_pos;uniform float u_emissive_strength;\n#pragma mapbox: define highp vec4 outline_color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 outline_color\n#pragma mapbox: initialize lowp float opacity\nfloat dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=outline_color;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nin vec2 a_pos;uniform mat4 u_matrix;uniform vec2 u_world;out vec2 v_pos;\n#pragma mapbox: define highp vec4 outline_color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 outline_color\n#pragma mapbox: initialize lowp float opacity\ngl_Position=u_matrix*vec4(a_pos,0,1);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillOutlinePattern:Tn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec2 u_texsize;uniform sampler2D u_image;uniform float u_emissive_strength;in vec2 v_pos;in vec2 v_pos_world;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);float dist=length(v_pos_world-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=texture(u_image,pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;out vec2 v_pos;out vec2 v_pos_world;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\n#pragma mapbox: define lowp float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize lowp float pixel_ratio\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;gl_Position=u_matrix*vec4(a_pos,0,1);vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);v_pos_world=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillPattern:Tn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec2 u_texsize;uniform sampler2D u_image;in vec2 v_pos;uniform float u_emissive_strength;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);vec4 out_color=texture(u_image,pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;out vec2 v_pos;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\n#pragma mapbox: define lowp float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize lowp float pixel_ratio\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillExtrusion:Tn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nin vec4 v_color;in vec4 v_flat;\n#ifdef RENDER_SHADOWS\nin highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth;\n#endif\nuniform lowp float u_opacity;\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;in vec2 v_ao;\n#endif\n#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)\nin vec4 v_roof_color;\n#endif\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nin highp vec3 v_normal;\n#endif\nuniform vec3 u_flood_light_color;uniform highp float u_vertical_scale;uniform float u_flood_light_intensity;uniform vec3 u_ground_shadow_factor;\n#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)\nin float v_flood_radius;in float v_has_floodlight;\n#endif\nuniform float u_emissive_strength;in float v_height;void main() {\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nvec3 normal=normalize(v_normal);\n#endif\nfloat z;vec4 color=v_color;\n#ifdef ZERO_ROOF_RADIUS\nz=float(normal.z > 0.00001);\n#ifdef LIGHTING_3D_MODE\nnormal=mix(normal,vec3(0.0,0.0,1.0),z);\n#else\ncolor=mix(v_color,v_roof_color,z);\n#endif\n#endif\nfloat h=max(0.0,v_height);float ao_shade=1.0;\n#ifdef FAUX_AO\nfloat intensity=u_ao[0];float h_floors=h/(u_ao[1]*u_vertical_scale);float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);ao_shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;\n#ifdef ZERO_ROOF_RADIUS\nconcave*=(1.0-z);\n#endif\nfloat x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);ao_shade*=mix(1.0,x_shade*x_shade*x_shade,concave);\n#ifdef LIGHTING_3D_MODE\n#ifdef FLOOD_LIGHT\ncolor.rgb*=mix(ao_shade,1.0,v_has_floodlight);\n#else\ncolor.rgb*=ao_shade;\n#endif\n#else\ncolor.rgb*=ao_shade;\n#endif\n#endif\n#ifdef LIGHTING_3D_MODE\nfloat flood_radiance=0.0;\n#ifdef FLOOD_LIGHT\nflood_radiance=(1.0-min(h/v_flood_radius,1.0))*u_flood_light_intensity*v_has_floodlight;\n#endif\n#ifdef RENDER_SHADOWS\n#ifdef FLOOD_LIGHT\nfloat ndotl_unclamped=dot(normal,u_shadow_direction);float ndotl=max(0.0,ndotl_unclamped);float occlusion=ndotl_unclamped < 0.0 ? 1.0 : shadow_occlusion(ndotl,v_pos_light_view_0,v_pos_light_view_1,v_depth);vec3 litColor=apply_lighting(color.rgb,normal,(1.0-u_shadow_intensity*occlusion)*ndotl);vec3 floodLitColor=compute_flood_lighting(u_flood_light_color*u_opacity,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=mix(litColor,floodLitColor,flood_radiance);\n#else\nfloat shadowed_lighting_factor=shadowed_light_factor_normal(normal,v_pos_light_view_0,v_pos_light_view_1,v_depth);color.rgb=apply_lighting(color.rgb,normal,shadowed_lighting_factor);\n#endif\n#else\ncolor.rgb=apply_lighting(color.rgb,normal);\n#ifdef FLOOD_LIGHT\ncolor.rgb=mix(color.rgb,u_flood_light_color*u_opacity,flood_radiance);\n#endif\n#endif\ncolor.rgb=mix(color.rgb,v_flat.rgb,u_emissive_strength);color*=u_opacity;\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos,h));\n#endif\n#ifdef RENDER_CUTOFF\ncolor*=v_cutoff_opacity;\n#endif\n#ifdef INDICATOR_CUTOUT\ncolor=applyCutout(color);\n#endif\nglFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\n#include "_prelude_lighting.glsl"\n#ifdef RENDER_CUTOFF\ninvariant gl_Position;\n#endif\nuniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_edge_radius;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;\n#endif\nuniform highp float u_vertical_scale;out vec4 v_color;out vec4 v_flat;\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth;\n#endif\n#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)\nout vec4 v_roof_color;\n#endif\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nout highp vec3 v_normal;\n#endif\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;out vec2 v_ao;\n#endif\n#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)\nout float v_flood_radius;out float v_has_floodlight;\n#endif\nout float v_height;\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define highp float flood_light_wall_radius\nvoid main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize highp float flood_light_wall_radius\nbase*=u_vertical_scale;height*=u_vertical_scale;vec4 pos_nx=floor(a_pos_normal_ed*0.5);vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nv_normal=normal;\n#endif\nbase=max(0.0,base);height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nfloat ele=0.0;float h=0.0;float c_ele;vec3 pos;\n#ifdef TERRAIN\nbool flat_roof=centroid_pos.x !=0.0 && t > 0.0;ele=elevation(pos_nx.xy);c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base==0.0 ?-5.0 : base);pos=vec3(pos_nx.xy,h);\n#else\nh=t > 0.0 ? height : base;pos=vec3(pos_nx.xy,h);\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nfloat lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*h);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,pos.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*pos.z;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#endif\nfloat hidden=float(centroid_pos.x==0.0 && centroid_pos.y==1.0);gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);h=h-ele;v_height=h;\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=pos;vec3 shd_pos1=pos;\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(normal);shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\nfloat NdotL=0.0;float colorvalue=0.0;\n#ifndef LIGHTING_3D_MODE\ncolorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),NdotL);if (normal.y !=0.0) {float r=0.84;r=mix(0.7,0.98,1.0-u_lightintensity);NdotL*=(\n(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}\n#endif\n#ifdef FAUX_AO\nfloat concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;\n#ifdef TERRAIN\ntop_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);\n#endif\nv_ao=vec2(mix(concave,-concave,start),y_ground);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);\n#ifdef PROJECTION_GLOBE_VIEW\ntop_height+=u_height_lift;\n#endif\ngl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;\n#endif\n#ifdef LIGHTING_3D_MODE\n#ifdef FLOOD_LIGHT\nfloat is_wall=1.0-float(t > 0.0 && top_up_ny.y > 0.0);v_has_floodlight=float(flood_light_wall_radius > 0.0 && is_wall > 0.0);v_flood_radius=flood_light_wall_radius*u_vertical_scale;\n#endif\nv_color=vec4(color.rgb,1.0);v_flat=vec4(linearProduct(color.rgb,vec3(calculate_NdotL(normal))),1.0);\n#else\nv_color=vec4(0.0,0.0,0.0,1.0);v_color.rgb+=clamp(color.rgb*NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_color*=u_opacity;\n#endif\n#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)\nfloat roofNdotL=clamp(u_lightpos.z,0.0,1.0);roofNdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),roofNdotL);v_roof_color=vec4(0.0,0.0,0.0,1.0);v_roof_color.rgb+=clamp(color.rgb*roofNdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_roof_color*=u_opacity;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n#ifdef RENDER_CUTOFF\nv_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);\n#endif\n}'),fillExtrusionDepth:Tn("in highp float v_depth;void main() {\n#ifndef DEPTH_TEXTURE\nglFragColor=pack_depth(v_depth);\n#endif\n}",'#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_matrix;uniform float u_edge_radius;uniform float u_vertical_scale;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\nout highp float v_depth;void main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\nbase*=u_vertical_scale;height*=u_vertical_scale;vec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;base=max(0.0,base);height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nvec3 pos;\n#ifdef TERRAIN\nbool flat_roof=centroid_pos.x !=0.0 && t > 0.0;float ele=elevation(pos_nx.xy);float c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;float h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base);pos=vec3(pos_nx.xy,h);\n#else\npos=vec3(pos_nx.xy,t > 0.0 ? height : base);\n#endif\nfloat hidden=float(centroid_pos.x==0.0 && centroid_pos.y==1.0);gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);v_depth=gl_Position.z/gl_Position.w;}'),fillExtrusionPattern:Tn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec2 u_texsize;uniform sampler2D u_image;\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;in vec3 v_ao;\n#endif\n#ifdef LIGHTING_3D_MODE\nin vec3 v_normal;\n#endif\nin vec2 v_pos;in vec4 v_lighting;uniform lowp float u_opacity;\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define mediump vec4 pattern\n#pragma mapbox: define highp float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize highp float pixel_ratio\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);vec4 out_color=texture(u_image,pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting(out_color,normalize(v_normal))*u_opacity;\n#else\nout_color=out_color*v_lighting;\n#endif\n#ifdef FAUX_AO\nfloat intensity=u_ao[0];float h=max(0.0,v_ao.z);float h_floors=h/u_ao[1];float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);float shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);shade*=mix(1.0,x_shade*x_shade*x_shade,concave);out_color.rgb=out_color.rgb*shade;\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_lighting.glsl"\nuniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform float u_tile_units_to_pixels;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;\n#endif\nout vec2 v_pos;out vec4 v_lighting;\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;out vec3 v_ao;\n#endif\n#ifdef LIGHTING_3D_MODE\nout vec3 v_normal;\n#endif\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define mediump vec4 pattern\n#pragma mapbox: define highp float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize highp float pixel_ratio\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec4 pos_nx=floor(a_pos_normal_ed*0.5);mediump vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;mediump vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));float edgedistance=a_pos_normal_ed.w;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;float z=t > 0.0 ? height : base;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nfloat ele=0.0;float h=z;vec3 p;float c_ele;\n#ifdef TERRAIN\nbool flat_roof=centroid_pos.x !=0.0 && t > 0.0;ele=elevation(pos_nx.xy);c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base==0.0 ?-5.0 : base);p=vec3(pos_nx.xy,h);\n#else\np=vec3(pos_nx.xy,z);\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nfloat lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(p.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,p.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*p.z;p=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#endif\nfloat hidden=float(centroid_pos.x==0.0 && centroid_pos.y==1.0);gl_Position=mix(u_matrix*vec4(p,1),AWAY,hidden);vec2 pos=normal.z==1.0\n? pos_nx.xy\n: vec2(edgedistance,z*u_height_factor);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float NdotL=0.0;\n#ifdef LIGHTING_3D_MODE\nNdotL=calculate_NdotL(normal);\n#else\nNdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),NdotL);\n#endif\nif (normal.y !=0.0) {float r=0.84;\n#ifndef LIGHTING_3D_MODE\nr=mix(0.7,0.98,1.0-u_lightintensity);\n#endif\nNdotL*=(\n(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}\n#ifdef FAUX_AO\nfloat concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;\n#ifdef TERRAIN\ntop_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);\n#endif\nv_ao=vec3(mix(concave,-concave,start),y_ground,h-ele);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);\n#ifdef PROJECTION_GLOBE_VIEW\ntop_height+=u_height_lift;\n#endif\ngl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;\n#endif\n#ifdef LIGHTING_3D_MODE\nv_normal=normal;\n#else\nv_lighting.rgb+=clamp(NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;\n#endif \n#ifdef FOG\nv_fog_pos=fog_position(p);\n#endif\n}'),groundShadow:Tn('#include "_prelude_shadow.fragment.glsl"\nprecision highp float;uniform vec3 u_ground_shadow_factor;in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;in float v_depth;\n#ifdef FOG\nin float v_fog_opacity;\n#endif\nvoid main() {float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);vec3 shadow=mix(u_ground_shadow_factor,vec3(1.0),light);\n#ifdef RENDER_CUTOFF\nshadow=mix(vec3(1.0),shadow,cutoff_opacity(u_cutoff_params,v_depth));\n#endif\n#ifdef FOG\nshadow=mix(shadow,vec3(1.0),v_fog_opacity);\n#endif\n#ifdef INDICATOR_CUTOUT\nshadow=mix(shadow,vec3(1.0),1.0-applyCutout(vec4(1.0)).r);\n#endif\nglFragColor=vec4(shadow,1.0);}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;in vec2 a_pos;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;out float v_depth;\n#ifdef FOG\nout float v_fog_opacity;\n#endif\nvoid main() {gl_Position=u_matrix*vec4(a_pos,0.0,1.0);v_pos_light_view_0=u_light_matrix_0*vec4(a_pos,0.0,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(a_pos,0.0,1.0);v_depth=gl_Position.w;\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);v_fog_opacity=fog(v_fog_pos);\n#endif\n}'),fillExtrusionGroundEffect:Tn("uniform highp float u_ao_pass;uniform highp float u_opacity;uniform highp float u_flood_light_intensity;uniform highp vec3 u_flood_light_color;uniform highp float u_attenuation;uniform sampler2D u_fb;uniform float u_fb_size;\n#ifdef SDF_SUBPASS\nin highp vec2 v_pos;in highp vec4 v_line_segment;in highp float v_flood_light_radius_tile;in highp vec2 v_ao;float line_df(highp vec2 a,highp vec2 b,highp vec2 p) {highp vec2 ba=b-a;highp vec2 pa=p-a;highp float r=clamp(dot(pa,ba)/dot(ba,ba),0.0,1.0);return length(pa-r*ba);}\n#ifdef FOG\nin highp float v_fog;\n#endif\n#endif\nvoid main() {\n#ifdef CLEAR_SUBPASS\nvec4 color=vec4(1.0);\n#ifdef CLEAR_FROM_TEXTURE\ncolor=texture(u_fb,gl_FragCoord.xy/vec2(u_fb_size));\n#endif\nglFragColor=color;\n#else\n#ifdef SDF_SUBPASS\nhighp float d=line_df(v_line_segment.xy,v_line_segment.zw,v_pos);highp float effect_radius=mix(v_flood_light_radius_tile,v_ao.y,u_ao_pass);d/=effect_radius;d=min(d,1.0);d=1.0-pow(1.0-d,u_attenuation);highp float effect_intensity=mix(u_flood_light_intensity,v_ao.x,u_ao_pass);highp float fog=1.0;\n#ifdef FOG\nfog=v_fog;\n#endif\n#ifdef RENDER_CUTOFF\nfog*=v_cutoff_opacity;\n#endif\nglFragColor=vec4(vec3(0.0),mix(1.0,d,effect_intensity*u_opacity*fog));\n#else\nvec4 color=mix(vec4(u_flood_light_color,1.0),vec4(vec3(0.0),1.0),u_ao_pass);\n#ifdef OVERDRAW_INSPECTOR\ncolor=vec4(1.0);\n#endif\nglFragColor=color;HANDLE_WIREFRAME_DEBUG;\n#endif\n#endif\n}",'#include "_prelude_fog.vertex.glsl"\nin highp vec4 a_pos_end;in highp float a_angular_offset_factor;in highp float a_hidden_by_landmark;\n#ifdef SDF_SUBPASS\nout highp vec2 v_pos;out highp vec4 v_line_segment;out highp float v_flood_light_radius_tile;out highp vec2 v_ao;\n#ifdef FOG\nout highp float v_fog;\n#endif\n#endif\nuniform highp float u_flood_light_intensity;uniform highp mat4 u_matrix;uniform highp float u_ao_pass;uniform highp float u_meter_to_tile;uniform highp float u_edge_radius;uniform highp vec2 u_ao;\n#pragma mapbox: define highp float flood_light_ground_radius\nconst float TANGENT_CUTOFF=4.0;const float NORM=32767.0;void main() {\n#pragma mapbox: initialize highp float flood_light_ground_radius\nvec2 p=a_pos_end.xy;vec2 q=floor(a_pos_end.zw*0.5);vec2 start_bottom=a_pos_end.zw-q*2.0;float fl_ground_radius=flood_light_ground_radius;\n#ifdef FORCE_ABS_FL_GROUND_RADIUS\nfl_ground_radius=abs(flood_light_ground_radius);\n#endif\nfloat flood_radius_tile=fl_ground_radius*u_meter_to_tile;vec2 v=normalize(q-p);float ao_radius=u_ao.y/3.5;float effect_radius=mix(flood_radius_tile,ao_radius,u_ao_pass)+u_edge_radius;float angular_offset_factor=a_angular_offset_factor/NORM*TANGENT_CUTOFF;float angular_offset=angular_offset_factor*effect_radius;float top=1.0-start_bottom.y;float side=(0.5-start_bottom.x)*2.0;vec2 extrusion_parallel=v*side*mix(1.0,angular_offset,top);vec2 perp=vec2(v.y,-v.x);vec2 extrusion_perp=perp*effect_radius*top;vec3 pos=vec3(mix(q,p,start_bottom.x),0.0);pos.xy+=extrusion_parallel+extrusion_perp;\n#ifdef SDF_SUBPASS\nv_pos=pos.xy;v_line_segment=vec4(p,q)+perp.xyxy*u_edge_radius;v_flood_light_radius_tile=flood_radius_tile;v_ao=vec2(u_ao.x,ao_radius);\n#ifdef FOG\nv_fog_pos=fog_position(pos);v_fog=1.0-fog(v_fog_pos);\n#endif\n#endif\nfloat hidden_by_landmark=0.0;\n#ifdef HAS_CENTROID\nhidden_by_landmark=a_hidden_by_landmark;\n#endif\nfloat isFloodlit=float(fl_ground_radius > 0.0 && u_flood_light_intensity > 0.0);float hidden=mix(1.0-isFloodlit,isFloodlit,u_ao_pass);hidden+=hidden_by_landmark;gl_Position=mix(u_matrix*vec4(pos,1.0),AWAY,float(hidden > 0.0));\n#ifdef RENDER_CUTOFF\nv_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);\n#endif\n}'),hillshadePrepare:Tn("precision highp float;uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;float getElevation(vec2 coord) {return texture(u_image,coord).r/4.0;}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y));float b=getElevation(v_pos+vec2(0,-epsilon.y));float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y));float d=getElevation(v_pos+vec2(-epsilon.x,0));float e=getElevation(v_pos+vec2(epsilon.x,0));float f=getElevation(v_pos+vec2(-epsilon.x,epsilon.y));float g=getElevation(v_pos+vec2(0,epsilon.y));float h=getElevation(v_pos+vec2(epsilon.x,epsilon.y));float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2(\n(c+e+e+h)-(a+d+d+f),(f+g+g+h)-(a+b+b+c)\n)/pow(2.0,exaggeration+(19.2562-u_zoom));glFragColor=clamp(vec4(\nderiv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);}","uniform mat4 u_matrix;uniform vec2 u_dimension;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:Tn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;uniform float u_emissive_strength;void main() {vec4 pixel=texture(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);glFragColor=accent_color*(1.0-shade_color.a)+shade_color;\n#ifdef LIGHTING_3D_MODE\nglFragColor=apply_lighting_with_emission_ground(glFragColor,u_emissive_strength);\n#endif\n#ifdef FOG\nglFragColor=fog_dither(fog_apply_premultiplied(glFragColor,v_fog_pos));\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),line:Tn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform lowp float u_device_pixel_ratio;uniform float u_alpha_discard_threshold;uniform highp vec2 u_trim_offset;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;in highp vec4 v_uv;\n#ifdef RENDER_LINE_DASH\nuniform sampler2D u_dash_image;in vec2 v_tex;\n#endif\n#ifdef RENDER_LINE_GRADIENT\nuniform sampler2D u_gradient_image;\n#endif\nfloat luminance(vec3 c) {return (c.r+c.r+c.b+c.g+c.g+c.g)*0.1667;}uniform float u_emissive_strength;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float floorwidth\n#pragma mapbox: define lowp vec4 dash\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float border_width\n#pragma mapbox: define lowp vec4 border_color\nfloat linearstep(float edge0,float edge1,float x) {return  clamp((x-edge0)/(edge1-edge0),0.0,1.0);}void main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float floorwidth\n#pragma mapbox: initialize lowp vec4 dash\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float border_width\n#pragma mapbox: initialize lowp vec4 border_color\nfloat dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);\n#ifdef RENDER_LINE_DASH\nfloat sdfdist=texture(u_dash_image,v_tex).a;float sdfgamma=1.0/(2.0*u_device_pixel_ratio)/dash.z;alpha*=linearstep(0.5-sdfgamma/floorwidth,0.5+sdfgamma/floorwidth,sdfdist);\n#endif\nhighp vec4 out_color;\n#ifdef RENDER_LINE_GRADIENT\nout_color=texture(u_gradient_image,v_uv.xy);\n#else\nout_color=color;\n#endif\nfloat trimmed=1.0;\n#ifdef RENDER_LINE_TRIM_OFFSET\nhighp float start=v_uv[2];highp float end=v_uv[3];highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=(start+(v_uv.x)*(end-start));if (trim_end > trim_start) {if (line_progress <=trim_end && line_progress >=trim_start) {out_color=vec4(0,0,0,0);trimmed=0.0;}}\n#endif\nif (u_alpha_discard_threshold !=0.0) {if (alpha < u_alpha_discard_threshold) {discard;}}\n#ifdef RENDER_LINE_BORDER\nfloat edgeBlur=(border_width+1.0/u_device_pixel_ratio);float alpha2=clamp(min(dist-(v_width2.t-edgeBlur),v_width2.s-dist)/edgeBlur,0.0,1.0);if (alpha2 < 1.) {float smoothAlpha=smoothstep(0.6,1.0,alpha2);if (border_color.a==0.0) {    \nfloat Y=(out_color.a > 0.01) ? luminance(out_color.rgb/out_color.a) : 1.;float adjustment=(Y > 0.) ? 0.5/Y : 0.45;if (out_color.a > 0.25 && Y < 0.25) {vec3 borderColor=(Y > 0.) ? out_color.rgb : vec3(1,1,1)*out_color.a;out_color.rgb=out_color.rgb+borderColor*(adjustment*(1.0-smoothAlpha));} else {out_color.rgb*=(0.6 +0.4*smoothAlpha);}} else {out_color.rgb=mix(border_color.rgb*border_color.a*trimmed,out_color.rgb,smoothAlpha);}}\n#endif\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nout_color*=(alpha*opacity);\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#define EXTRUDE_SCALE 0.015873016\nin vec2 a_pos_normal;in vec4 a_data;\n#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)\nin highp vec4 a_packed;\n#endif\n#ifdef RENDER_LINE_DASH\nin float a_linesofar;\n#endif\nuniform mat4 u_matrix;uniform mat2 u_pixels_to_tile_units;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;out vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp vec4 v_uv;\n#ifdef RENDER_LINE_DASH\nuniform vec2 u_texsize;uniform float u_tile_units_to_pixels;out vec2 v_tex;\n#endif\n#ifdef RENDER_LINE_GRADIENT\nuniform float u_image_height;\n#endif\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float floorwidth\n#pragma mapbox: define lowp vec4 dash\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define lowp float offset\n#pragma mapbox: define mediump float width\n#pragma mapbox: define lowp float border_width\n#pragma mapbox: define lowp vec4 border_color\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float floorwidth\n#pragma mapbox: initialize lowp vec4 dash\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize lowp float offset\n#pragma mapbox: initialize mediump float width\n#pragma mapbox: initialize lowp float border_width\n#pragma mapbox: initialize lowp vec4 border_color\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*EXTRUDE_SCALE;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*EXTRUDE_SCALE*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist*u_pixels_to_tile_units,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude;\n#ifndef RENDER_TO_TEXTURE\nfloat extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;\n#else\nv_gamma_scale=1.0;\n#endif\n#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)\nfloat a_uv_x=a_packed[0];float a_split_index=a_packed[1];highp float a_clip_start=a_packed[2];highp float a_clip_end=a_packed[3];\n#ifdef RENDER_LINE_GRADIENT\nhighp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec4(a_uv_x,a_split_index*texel_height-half_texel_height,a_clip_start,a_clip_end);\n#else\nv_uv=vec4(a_uv_x,0.0,a_clip_start,a_clip_end);\n#endif\n#endif\n#ifdef RENDER_LINE_DASH\nfloat scale=dash.z==0.0 ? 0.0 : u_tile_units_to_pixels/dash.z;float height=dash.y;v_tex=vec2(a_linesofar*scale/floorwidth,(-normal.y*height+dash.x+0.5)/u_texsize.y);\n#endif\nv_width2=vec2(outset,inset);\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}'),linePattern:Tn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform lowp float u_device_pixel_ratio;uniform vec2 u_texsize;uniform float u_tile_units_to_pixels;uniform sampler2D u_image;in vec2 v_normal;in vec2 v_width2;in float v_linesofar;in float v_gamma_scale;in float v_width;\n#pragma mapbox: define lowp vec4 pattern\n#pragma mapbox: define lowp float pixel_ratio\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize lowp float pixel_ratio\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;vec2 pattern_size=vec2(display_size.x/u_tile_units_to_pixels,display_size.y);float aspect=display_size.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float x=mod(v_linesofar/pattern_size.x*aspect,1.0);float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;vec2 pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(x,y));vec4 color=texture(u_image,pos);\n#ifdef LIGHTING_3D_MODE\ncolor=apply_lighting_ground(color);\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#endif\ncolor*=(alpha*opacity);\n#ifdef INDICATOR_CUTOUT\ncolor=applyCutout(color);\n#endif\nglFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#define scale 0.015873016\nin vec2 a_pos_normal;in vec4 a_data;in float a_linesofar;uniform mat4 u_matrix;uniform vec2 u_units_to_pixels;uniform mat2 u_pixels_to_tile_units;uniform lowp float u_device_pixel_ratio;out vec2 v_normal;out vec2 v_width2;out float v_linesofar;out float v_gamma_scale;out float v_width;\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float offset\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define mediump float width\n#pragma mapbox: define lowp float floorwidth\n#pragma mapbox: define lowp vec4 pattern\n#pragma mapbox: define lowp float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float offset\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize mediump float width\n#pragma mapbox: initialize lowp float floorwidth\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize lowp float pixel_ratio\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist*u_pixels_to_tile_units,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude;\n#ifndef RENDER_TO_TEXTURE\nfloat extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;\n#else\nv_gamma_scale=1.0;\n#endif\nv_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=floorwidth;\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}'),raster:Tn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_raster_array.glsl"\nuniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;in vec2 v_pos0;in vec2 v_pos1;in float v_depth;uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;uniform float u_emissive_strength;\n#ifndef RASTER_ARRAY\nuniform sampler2D u_image0;uniform sampler2D u_image1;\n#endif\n#ifdef RASTER_COLOR\nuniform sampler2D u_color_ramp;uniform highp vec4 u_colorization_mix;uniform highp float u_colorization_offset;uniform vec2 u_texture_res;\n#endif\nvoid main() {vec4 color0,color1,color;vec2 value;\n#ifdef RASTER_COLOR\n#ifdef RASTER_ARRAY\n#ifdef RASTER_ARRAY_LINEAR\nvalue=mix(\nraTexture2D_image0_linear(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_linear(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t\n);\n#else\nvalue=mix(\nraTexture2D_image0_nearest(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_nearest(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t\n);\n#endif\nif (value.y > 0.0) value.x/=value.y;\n#else\ncolor=mix(texture(u_image0,v_pos0),texture(u_image1,v_pos1),u_fade_t);value=vec2(u_colorization_offset+dot(color.rgb,u_colorization_mix.rgb),color.a);\n#endif\ncolor=texture(u_color_ramp,vec2(value.x,0.5));if (color.a > 0.0) color.rgb/=color.a;color.a*=value.y;\n#else\ncolor0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);\n#endif\ncolor.a*=u_opacity;vec3 rgb=color.rgb;rgb=vec3(\ndot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);vec3 out_color=mix(u_high_vec,u_low_vec,rgb);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),u_emissive_strength).rgb;\n#endif\n#ifdef FOG\nhighp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));\n#endif\nglFragColor=vec4(out_color*color.a,color.a);\n#ifdef RENDER_CUTOFF\nglFragColor=glFragColor*cutoff_opacity(u_cutoff_params,v_depth);\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform vec2 u_perspective_transform;uniform vec2 u_texture_offset;uniform float u_raster_elevation;uniform vec4 u_tl_br;uniform float u_zoom_transition;uniform vec2 u_merc_center;\n#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8;\n#ifdef GLOBE_POLES\nin vec3 a_globe_pos;in vec2 a_uv;\n#elif defined(PROJECTION_GLOBE_VIEW)\nin vec2 a_pos;\n#else\nin vec2 a_pos;in vec2 a_texture_pos;\n#endif\nout vec2 v_pos0;out vec2 v_pos1;out float v_depth;void main() {vec2 uv;\n#ifdef GLOBE_POLES\nvec3 globe_pos=a_globe_pos;globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;gl_Position=u_matrix*u_globe_matrix*vec4(globe_pos   ,1.0);uv=a_uv;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(a_globe_pos,1.0)).xyz);\n#endif\n#else\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);vec2 globe_tl=vec2(u_tl_br.x,u_tl_br.y);vec2 globe_br=vec2(u_tl_br.z,u_tl_br.w);float mercatorY=mercatorYfromLat(latLng[0]);float uvY=1.0-((mercatorY-globe_br.y)/(globe_tl.y-globe_br.y));float mercatorX=mercatorXfromLng(latLng[1]);float uvX=(mercatorX-globe_br.x)/(globe_tl.x-globe_br.x);vec3 globe_pos=latLngToECEF(latLng.xy);vec2 merc_pos=vec2(mercatorX,mercatorY);uv=vec2(uvX,uvY);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition),1.0);gl_Position=u_matrix*interpolated_pos;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);\n#endif\n#else\nfloat w=1.0+dot(a_texture_pos,u_perspective_transform);gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation,w);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\nuv=a_texture_pos/8192.0;\n#endif\n#endif\nv_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;v_pos0=u_texture_offset.x+u_texture_offset.y*v_pos0;v_pos1=u_texture_offset.x+u_texture_offset.y*v_pos1;\n#ifdef RENDER_CUTOFF\nv_depth=gl_Position.z;\n#endif\n}'),symbolIcon:Tn('#include "_prelude_lighting.glsl"\nuniform sampler2D u_texture;\n#ifdef ICON_TRANSITION\nuniform float u_icon_transition;\n#endif\nin float v_fade_opacity;in vec2 v_tex_a;\n#ifdef ICON_TRANSITION\nin vec2 v_tex_b;\n#endif\nuniform mediump float u_icon_saturation;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float emissive_strength\nlowp float alpha=opacity*v_fade_opacity;vec4 out_color;\n#ifdef ICON_TRANSITION\nvec4 a=texture(u_texture,v_tex_a)*(1.0-u_icon_transition);vec4 b=texture(u_texture,v_tex_b)*u_icon_transition;out_color=(a+b)*alpha;\n#else\nout_color=texture(u_texture,v_tex_a)*alpha;\n#endif\n#ifdef SATURATION\nvec3 luma=vec3(dot(out_color.rgb,vec3(0.2126,0.7152,0.0722)));out_color.rgb=mix(luma,out_color.rgb,u_icon_saturation);\n#endif\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,emissive_strength);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_terrain.vertex.glsl"\nin vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_pixeloffset;in vec4 a_projected_pos;in float a_fade_opacity;\n#ifdef Z_OFFSET\nin float a_z_offset;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_globe_anchor;in vec3 a_globe_normal;\n#endif\n#ifdef ICON_TRANSITION\nin vec2 a_texb;\n#endif\nuniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform highp float u_camera_to_center_distance;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform float u_fade_change;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform vec2 u_texsize;uniform vec3 u_up_vector;\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;\n#endif\nout vec2 v_tex_a;\n#ifdef ICON_TRANSITION\nout vec2 v_tex_b;\n#endif\nout float v_fade_opacity;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float emissive_strength\nvec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_min_font_scale=a_pixeloffset.zw/256.0;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=elevation(tile_anchor);\n#ifdef Z_OFFSET\ne+=a_z_offset;\n#endif\nvec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nmercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos=mix_globe_mercator(a_globe_anchor+h,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;\n#else\nworld_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;\n#endif\nvec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?\ncamera_to_anchor_distance/u_camera_to_center_distance :\nu_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(\n0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjected_point;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetProjected_point=u_matrix*vec4(a_globe_anchor+displacement,1);\n#else\noffsetProjected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);\n#endif\nvec2 a=projected_point.xy/projected_point.w;vec2 b=offsetProjected_point.xy/offsetProjected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz+h,mercator_pos,u_zoom_transition);projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);\n#else\nprojected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);\n#endif\nhighp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*max(a_min_font_scale,font_scale)+a_pxoffset/16.0);\n#ifdef TERRAIN\n#ifdef PITCH_WITH_MAP_TERRAIN\nvec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);\n#endif\n#endif\nfloat occlusion_fade=occlusionFade(projected_point)*globe_occlusion_fade;float projection_transition_fade=1.0;\n#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)\nprojection_transition_fade=1.0-step(EPSILON,u_zoom_transition);\n#endif\nvec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float out_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change))*projection_transition_fade;float alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,hidden);\n#else\ngl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,hidden);\n#endif\nv_tex_a=a_tex/u_texsize;\n#ifdef ICON_TRANSITION\nv_tex_b=a_texb/u_texsize;\n#endif\nv_fade_opacity=out_fade_opacity;}'),symbolSDF:Tn('#include "_prelude_lighting.glsl"\n#define SDF_PX 8.0\nuniform sampler2D u_texture;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;uniform bool u_is_halo;in float v_draw_halo;in vec2 v_data0;in vec3 v_data1;\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\n#pragma mapbox: define lowp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\n#pragma mapbox: initialize lowp float emissive_strength\nfloat EDGE_GAMMA=0.105/u_device_pixel_ratio;vec2 tex=v_data0.xy;float gamma_scale=v_data1.x;float size=v_data1.y;float fade_opacity=v_data1[2];float fontScale=u_is_text ? size/24.0 : size;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;bool draw_halo=v_draw_halo > 0.0;if (draw_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);vec4 out_color=color*(alpha*opacity*fade_opacity);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,emissive_strength);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_terrain.vertex.glsl"\nin vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_pixeloffset;in vec4 a_projected_pos;in float a_fade_opacity;\n#ifdef Z_OFFSET\nin float a_z_offset;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_globe_anchor;in vec3 a_globe_normal;\n#endif\nuniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform bool u_is_halo;\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;\n#endif\nout float v_draw_halo;out vec2 v_data0;out vec3 v_data1;\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\n#pragma mapbox: define lowp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\n#pragma mapbox: initialize lowp float emissive_strength\nvec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=elevation(tile_anchor);\n#ifdef Z_OFFSET\ne+=a_z_offset;\n#endif\nvec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nmercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos=mix_globe_mercator(a_globe_anchor+h,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;\n#else\nworld_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;\n#endif\nvec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?\ncamera_to_anchor_distance/u_camera_to_center_distance :\nu_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(\n0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetprojected_point;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetprojected_point=u_matrix*vec4(a_globe_anchor+displacement,1);\n#else\noffsetprojected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);\n#endif\nvec2 a=projected_point.xy/projected_point.w;vec2 b=offsetprojected_point.xy/offsetprojected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz+h,mercator_pos,u_zoom_transition);projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);\n#else\nprojected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);\n#endif\nhighp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*fontScale+a_pxoffset);\n#ifdef TERRAIN\n#ifdef PITCH_WITH_MAP_TERRAIN\nvec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);\n#endif\n#endif\nfloat occlusion_fade=occlusionFade(projected_point)*globe_occlusion_fade;float projection_transition_fade=1.0;\n#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)\nprojection_transition_fade=1.0-step(EPSILON,u_zoom_transition);\n#endif\nvec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));float out_fade_opacity=interpolated_fade_opacity*projection_transition_fade;float alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,hidden);\n#else\ngl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,hidden);\n#endif\nfloat gamma_scale=gl_Position.w;v_draw_halo=(u_is_halo && float(gl_InstanceID)==0.0) ? 1.0 : 0.0;v_data0=a_tex/u_texsize;v_data1=vec3(gamma_scale,size,out_fade_opacity);}'),symbolTextAndIcon:Tn('#include "_prelude_lighting.glsl"\n#define SDF_PX 8.0\n#define SDF 1.0\n#define ICON 0.0\nuniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_halo;in float v_draw_halo;in vec4 v_data0;in vec4 v_data1;\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\n#pragma mapbox: define lowp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\n#pragma mapbox: initialize lowp float emissive_strength\nfloat fade_opacity=v_data1[2];if (v_data1.w==ICON) {vec2 tex_icon=v_data0.zw;lowp float alpha=opacity*fade_opacity;glFragColor=texture(u_texture_icon,tex_icon)*alpha;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nreturn;}vec2 tex=v_data0.xy;float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_data1.x;float size=v_data1.y;float fontScale=size/24.0;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;bool draw_halo=v_draw_halo > 0.0;if (draw_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);vec4 out_color=color*(alpha*opacity*fade_opacity);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,emissive_strength);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_terrain.vertex.glsl"\nin vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_projected_pos;in float a_fade_opacity;\n#ifdef Z_OFFSET\nin float a_z_offset;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_globe_anchor;in vec3 a_globe_normal;\n#endif\nuniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform vec2 u_texsize_icon;uniform bool u_is_halo;\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;\n#endif\nout float v_draw_halo;out vec4 v_data0;out vec4 v_data1;\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\n#pragma mapbox: define lowp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\n#pragma mapbox: initialize lowp float emissive_strength\nvec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);float is_sdf=a_size[0]-2.0*a_size_min;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=elevation(tile_anchor);\n#ifdef Z_OFFSET\ne+=a_z_offset;\n#endif\nvec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nmercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos=mix_globe_mercator(a_globe_anchor+h,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;\n#else\nworld_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;\n#endif\nvec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?\ncamera_to_anchor_distance/u_camera_to_center_distance :\nu_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(\n0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=size/24.0;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offset_projected_point=u_matrix*vec4(a_pos+vec2(1,0),0,1);vec2 a=projected_point.xy/projected_point.w;vec2 b=offset_projected_point.xy/offset_projected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz+h,mercator_pos,u_zoom_transition);projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);\n#else\nprojected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);\n#endif\nhighp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*font_scale);\n#ifdef TERRAIN\n#ifdef PITCH_WITH_MAP_TERRAIN\nvec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);\n#endif\n#endif\nfloat occlusion_fade=occlusionFade(projected_point)*globe_occlusion_fade;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));float projection_transition_fade=1.0;\n#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)\nprojection_transition_fade=1.0-step(EPSILON,u_zoom_transition);\n#endif\nfloat out_fade_opacity=interpolated_fade_opacity*projection_transition_fade;float alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,hidden);\n#else\ngl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,hidden);\n#endif\nfloat gamma_scale=gl_Position.w;v_draw_halo=(u_is_halo && float(gl_InstanceID)==0.0) ? 1.0 : 0.0;v_data0.xy=a_tex/u_texsize;v_data0.zw=a_tex/u_texsize_icon;v_data1=vec4(gamma_scale,size,out_fade_opacity,is_sdf);}'),terrainRaster:Tn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform sampler2D u_image0;in vec2 v_pos0;\n#ifdef FOG\nin float v_fog_opacity;\n#endif\n#ifdef RENDER_SHADOWS\nin vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;in float v_depth;\n#endif\nuniform vec3 u_ground_shadow_factor;void main() {vec4 image_color=texture(u_image0,v_pos0);vec4 color;\n#ifdef LIGHTING_3D_MODE\nconst vec3 normal=vec3(0.0,0.0,1.0);\n#ifdef RENDER_SHADOWS\nfloat cutoffOpacity=1.0;\n#ifdef RENDER_CUTOFF\ncutoffOpacity=cutoff_opacity(u_cutoff_params,v_depth);\n#endif\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\nvec3 unlit_base=image_color.rgb*(1.0-image_color.a);vec3 emissive_base=image_color.rgb*image_color.a;float ndotl=u_shadow_direction.z;float occlusion=ndotl < 0.0 ? 1.0 : shadow_occlusion(v_pos_light_view_0,v_pos_light_view_1,v_depth,0.0);ndotl=max(0.0,ndotl);vec3 lit=apply_lighting(unlit_base,normal,mix(1.0,(1.0-(u_shadow_intensity*occlusion))*ndotl,cutoffOpacity));vec3 emissive=compute_emissive_draped(emissive_base,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=lit+emissive;color.a=1.0;\n#else\nfloat lighting_factor=shadowed_light_factor_normal_unbiased(normal,v_pos_light_view_0,v_pos_light_view_1,v_depth);color=apply_lighting(image_color,normal,mix(1.0,lighting_factor,cutoffOpacity));\n#endif\n#else\nfloat lighting_factor=u_lighting_directional_dir.z;color=apply_lighting(image_color,normal,lighting_factor);\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\ncolor.rgb=mix(color.rgb,image_color.rgb,image_color.a);color.a=1.0;\n#endif\n#endif\n#else\ncolor=image_color;\n#endif\n#ifdef FOG\n#ifdef ZERO_EXAGGERATION\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#else\ncolor=fog_dither(fog_apply_from_vert(color,v_fog_opacity));\n#endif\n#endif\nglFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_matrix;uniform float u_skirt_height;in vec2 a_pos;out vec2 v_pos0;\n#ifdef FOG\nout float v_fog_opacity;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;out float v_depth;\n#endif\nvoid main() {vec3 decomposedPosAndSkirt=decomposeToPosAndSkirt(a_pos);float skirt=decomposedPosAndSkirt.z;vec2 decodedPos=decomposedPosAndSkirt.xy;float elevation=elevation(decodedPos)-skirt*u_skirt_height;v_pos0=decodedPos/8192.0;gl_Position=u_matrix*vec4(decodedPos,elevation,1.0);\n#ifdef FOG\n#ifdef ZERO_EXAGGERATION\nv_fog_pos=fog_position(decodedPos);\n#else\nv_fog_opacity=fog(fog_position(vec3(decodedPos,elevation)));\n#endif\n#endif\n#ifdef RENDER_SHADOWS\nvec3 pos=vec3(decodedPos,elevation);v_pos_light_view_0=u_light_matrix_0*vec4(pos,1.);v_pos_light_view_1=u_light_matrix_1*vec4(pos,1.);v_depth=gl_Position.w;\n#endif\n}'),terrainDepth:Tn("precision highp float;in float v_depth;void main() {glFragColor=pack_depth(v_depth);}",'#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_matrix;in vec2 a_pos;out float v_depth;void main() {float elevation=elevation(a_pos);gl_Position=u_matrix*vec4(a_pos,elevation,1.0);v_depth=gl_Position.z/gl_Position.w;}'),skybox:Tn('#include "_prelude_fog.fragment.glsl"\nin lowp vec3 v_uv;uniform lowp samplerCube u_cubemap;uniform lowp float u_opacity;uniform highp float u_temporal_offset;uniform highp vec3 u_sun_direction;float sun_disk(highp vec3 ray_direction,highp vec3 sun_direction) {highp float cos_angle=dot(normalize(ray_direction),sun_direction);const highp float cos_sun_angular_diameter=0.99996192306;const highp float smoothstep_delta=1e-5;return smoothstep(\ncos_sun_angular_diameter-smoothstep_delta,cos_sun_angular_diameter+smoothstep_delta,cos_angle);}float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec3 uv=v_uv;const float y_bias=0.015;uv.y+=y_bias;uv.y=pow(abs(uv.y),1.0/5.0);uv.y=map(uv.y,0.0,1.0,-1.0,1.0);vec3 sky_color=texture(u_cubemap,uv).rgb;\n#ifdef FOG\nsky_color=fog_apply_sky_gradient(v_uv.xzy,sky_color);\n#endif\nsky_color.rgb=dither(sky_color.rgb,gl_FragCoord.xy+u_temporal_offset);sky_color+=0.1*sun_disk(v_uv,u_sun_direction);glFragColor=vec4(sky_color*u_opacity,u_opacity);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\n}',uE),skyboxGradient:Tn('#include "_prelude_fog.fragment.glsl"\nin highp vec3 v_uv;uniform lowp sampler2D u_color_ramp;uniform highp vec3 u_center_direction;uniform lowp float u_radius;uniform lowp float u_opacity;uniform highp float u_temporal_offset;void main() {float progress=acos(dot(normalize(v_uv),u_center_direction))/u_radius;vec4 color=texture(u_color_ramp,vec2(progress,0.5));\n#ifdef FOG\ncolor.rgb=fog_apply_sky_gradient(v_uv.xzy,color.rgb/color.a)*color.a;\n#endif\ncolor*=u_opacity;color.rgb=dither(color.rgb,gl_FragCoord.xy+u_temporal_offset);glFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\n}',uE),skyboxCapture:Tn("\nin highp vec3 v_position;uniform highp float u_sun_intensity;uniform highp float u_luminance;uniform lowp vec3 u_sun_direction;uniform highp vec4 u_color_tint_r;uniform highp vec4 u_color_tint_m;precision highp float;\n#define BETA_R                  vec3(5.5e-6,13.0e-6,22.4e-6)\n#define BETA_M                  vec3(21e-6,21e-6,21e-6)\n#define MIE_G                   0.76\n#define DENSITY_HEIGHT_SCALE_R  8000.0\n#define DENSITY_HEIGHT_SCALE_M  1200.0\n#define PLANET_RADIUS           6360e3\n#define ATMOSPHERE_RADIUS       6420e3\n#define SAMPLE_STEPS            10\n#define DENSITY_STEPS           4\nfloat ray_sphere_exit(vec3 orig,vec3 dir,float radius) {float a=dot(dir,dir);float b=2.0*dot(dir,orig);float c=dot(orig,orig)-radius*radius;float d=sqrt(b*b-4.0*a*c);return (-b+d)/(2.0*a);}vec3 extinction(vec2 density) {return exp(-vec3(BETA_R*u_color_tint_r.a*density.x+BETA_M*u_color_tint_m.a*density.y));}vec2 local_density(vec3 point) {float height=max(length(point)-PLANET_RADIUS,0.0);float exp_r=exp(-height/DENSITY_HEIGHT_SCALE_R);float exp_m=exp(-height/DENSITY_HEIGHT_SCALE_M);return vec2(exp_r,exp_m);}float phase_ray(float cos_angle) {return (3.0/(16.0*PI))*(1.0+cos_angle*cos_angle);}float phase_mie(float cos_angle) {return (3.0/(8.0*PI))*((1.0-MIE_G*MIE_G)*(1.0+cos_angle*cos_angle))/((2.0+MIE_G*MIE_G)*pow(1.0+MIE_G*MIE_G-2.0*MIE_G*cos_angle,1.5));}vec2 density_to_atmosphere(vec3 point,vec3 light_dir) {float ray_len=ray_sphere_exit(point,light_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(DENSITY_STEPS);vec2 density_point_to_atmosphere=vec2(0.0);for (int i=0; i < DENSITY_STEPS;++i) {vec3 point_on_ray=point+light_dir*((float(i)+0.5)*step_len);density_point_to_atmosphere+=local_density(point_on_ray)*step_len;;}return density_point_to_atmosphere;}vec3 atmosphere(vec3 ray_dir,vec3 sun_direction,float sun_intensity) {vec2 density_orig_to_point=vec2(0.0);vec3 scatter_r=vec3(0.0);vec3 scatter_m=vec3(0.0);vec3 origin=vec3(0.0,PLANET_RADIUS,0.0);float ray_len=ray_sphere_exit(origin,ray_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(SAMPLE_STEPS);for (int i=0; i < SAMPLE_STEPS;++i) {vec3 point_on_ray=origin+ray_dir*((float(i)+0.5)*step_len);vec2 density=local_density(point_on_ray)*step_len;density_orig_to_point+=density;vec2 density_point_to_atmosphere=density_to_atmosphere(point_on_ray,sun_direction);vec2 density_orig_to_atmosphere=density_orig_to_point+density_point_to_atmosphere;vec3 extinction=extinction(density_orig_to_atmosphere);scatter_r+=density.x*extinction;scatter_m+=density.y*extinction;}float cos_angle=dot(ray_dir,sun_direction);float phase_r=phase_ray(cos_angle);float phase_m=phase_mie(cos_angle);vec3 beta_r=BETA_R*u_color_tint_r.rgb*u_color_tint_r.a;vec3 beta_m=BETA_M*u_color_tint_m.rgb*u_color_tint_m.a;return (scatter_r*phase_r*beta_r+scatter_m*phase_m*beta_m)*sun_intensity;}const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;vec3 uncharted2_tonemap(vec3 x) {return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;}void main() {vec3 ray_direction=v_position;ray_direction.y=pow(ray_direction.y,5.0);const float y_bias=0.015;ray_direction.y+=y_bias;vec3 color=atmosphere(normalize(ray_direction),u_sun_direction,u_sun_intensity);float white_scale=1.0748724675633854;color=uncharted2_tonemap((log2(2.0/pow(u_luminance,4.0)))*color)*white_scale;glFragColor=vec4(color,1.0);}","in highp vec3 a_pos_3f;uniform mat3 u_matrix_3f;out highp vec3 v_position;float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec4 pos=vec4(u_matrix_3f*a_pos_3f,1.0);v_position=pos.xyz;v_position.y*=-1.0;v_position.y=map(v_position.y,-1.0,1.0,0.0,1.0);gl_Position=vec4(a_pos_3f.xy,0.0,1.0);}"),globeRaster:Tn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform sampler2D u_image0;in vec2 v_pos0;\n#ifndef FOG\nuniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform vec2 u_viewport;\n#endif\nvoid main() {vec4 color;\n#ifdef CUSTOM_ANTIALIASING\nvec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);vec3 dir=normalize(ray_dir);vec3 closest_point=dot(u_globe_pos,dir)*dir;float norm_dist_from_center=1.0-length(closest_point-u_globe_pos)/u_globe_radius;const float antialias_pixel=2.0;float antialias_factor=antialias_pixel*fwidth(norm_dist_from_center);float antialias=smoothstep(0.0,antialias_factor,norm_dist_from_center);vec4 raster=texture(u_image0,v_pos0);\n#ifdef LIGHTING_3D_MODE\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\nraster=apply_lighting_with_emission_ground(raster,raster.a);color=vec4(raster.rgb*antialias,antialias);\n#else\nraster=apply_lighting_ground(raster);color=vec4(raster.rgb*antialias,raster.a*antialias);\n#endif\n#else\ncolor=vec4(raster.rgb*antialias,raster.a*antialias);\n#endif\n#else\ncolor=texture(u_image0,v_pos0);\n#ifdef LIGHTING_3D_MODE\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\ncolor=apply_lighting_with_emission_ground(color,color.a);color.a=1.0;\n#else\ncolor=apply_lighting_ground(color);\n#endif\n#endif\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#endif\nglFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_proj_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform float u_zoom_transition;uniform vec2 u_merc_center;uniform mat3 u_grid_matrix;uniform float u_skirt_height;\n#ifdef GLOBE_POLES\nin vec3 a_globe_pos;in vec2 a_uv;\n#else\nin vec2 a_pos;\n#endif\nout vec2 v_pos0;void main() {\n#ifdef GLOBE_POLES\nvec3 globe_pos=a_globe_pos;vec2 uv=a_uv;\n#else\nfloat tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float uvY=mercatorY*tiles-idy;float mercatorX=mercatorXfromLng(latLng[1]);float uvX=mercatorX*tiles-idx;vec3 globe_pos=latLngToECEF(latLng.xy);vec2 merc_pos=vec2(mercatorX,mercatorY);vec2 uv=vec2(uvX,uvY);\n#endif\nv_pos0=uv;vec2 tile_pos=uv*EXTENT;vec3 globe_derived_up_vector=normalize(globe_pos)*u_tile_up_scale;\n#ifdef GLOBE_POLES\nvec3 up_vector=globe_derived_up_vector;\n#else\nvec3 up_vector=elevationVector(tile_pos);\n#endif\nfloat height=elevation(tile_pos);globe_pos+=up_vector*height;\n#ifndef GLOBE_POLES\nglobe_pos-=globe_derived_up_vector*u_skirt_height*decomposed_pos_and_skirt.z;\n#endif\n#ifdef GLOBE_POLES\nvec4 interpolated_pos=u_globe_matrix*vec4(globe_pos,1.0);\n#else\nvec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {merc_world_pos=vec4(merc_pos,height-u_skirt_height*decomposed_pos_and_skirt.z,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition),1.0);\n#endif\ngl_Position=u_proj_matrix*interpolated_pos;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);\n#endif\n}'),globeAtmosphere:Tn('#include "_prelude_fog.fragment.glsl"\nuniform float u_transition;uniform highp float u_fadeout_range;uniform highp float u_temporal_offset;uniform vec4 u_color;uniform vec4 u_high_color;uniform vec4 u_space_color;uniform float u_horizon_angle;in highp vec3 v_ray_dir;in highp vec3 v_horizon_dir;void main() {highp vec3 dir=normalize(v_ray_dir);float globe_pos_dot_dir;\n#ifdef PROJECTION_GLOBE_VIEW\nglobe_pos_dot_dir=dot(u_globe_pos,dir);highp vec3 closest_point_forward=abs(globe_pos_dot_dir)*dir;float norm_dist_from_center=length(closest_point_forward-u_globe_pos)/u_globe_radius;if (norm_dist_from_center < 0.98) {\n#ifdef ALPHA_PASS\nglFragColor=vec4(0,0,0,0);return;\n#else\n#ifdef NATIVE\nglFragColor=vec4(1,1,1,1);\n#else\nglFragColor=vec4(0,0,0,1);\n#endif\nreturn;\n#endif\n}\n#endif\nhighp vec3 horizon_dir=normalize(v_horizon_dir);float horizon_angle_mercator=dir.y < horizon_dir.y ?\n0.0 : max(acos(clamp(dot(dir,horizon_dir),-1.0,1.0)),0.0);float horizon_angle;\n#ifdef PROJECTION_GLOBE_VIEW\nhighp vec3 closest_point=globe_pos_dot_dir*dir;highp float closest_point_to_center=length(closest_point-u_globe_pos);highp float theta=asin(clamp(closest_point_to_center/length(u_globe_pos),-1.0,1.0));horizon_angle=globe_pos_dot_dir < 0.0 ?\nPI-theta-u_horizon_angle : theta-u_horizon_angle;float angle_t=pow(u_transition,10.0);horizon_angle=mix(horizon_angle,horizon_angle_mercator,angle_t);\n#else\nhorizon_angle=horizon_angle_mercator;\n#endif\nhorizon_angle/=PI;float t=exp(-horizon_angle/u_fadeout_range);float alpha_0=u_color.a;float alpha_1=u_high_color.a;float alpha_2=u_space_color.a;vec3 color_stop_0=u_color.rgb;vec3 color_stop_1=u_high_color.rgb;vec3 color_stop_2=u_space_color.rgb;\n#ifdef ALPHA_PASS\nfloat a0=mix(alpha_2,1.0,alpha_1);float a1=mix(a0,1.0,alpha_0);float a2=mix(a0,a1,t);float a =mix(alpha_2,a2,t);glFragColor=vec4(1.0,1.0,1.0,a);\n#else\nvec3 c0=mix(color_stop_2,color_stop_1,alpha_1);vec3 c1=mix(c0,color_stop_0,alpha_0);vec3 c2=mix(c0,c1,t);vec3 c=c2;\n#ifndef NATIVE\nc=dither(c,gl_FragCoord.xy+u_temporal_offset);\n#endif\nglFragColor=vec4(c*t,t);\n#endif\n}',"in vec3 a_pos;in vec2 a_uv;uniform vec3 u_frustum_tl;uniform vec3 u_frustum_tr;uniform vec3 u_frustum_br;uniform vec3 u_frustum_bl;uniform float u_horizon;out highp vec3 v_ray_dir;out highp vec3 v_horizon_dir;void main() {v_ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,a_uv.x),mix(u_frustum_bl,u_frustum_br,a_uv.x),a_uv.y);v_horizon_dir=mix(\nmix(u_frustum_tl,u_frustum_bl,u_horizon),mix(u_frustum_tr,u_frustum_br,u_horizon),a_uv.x);gl_Position=vec4(a_pos,1.0);}"),model:Tn('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform float u_opacity;uniform vec3 u_lightcolor;uniform vec3 u_lightpos;uniform float u_lightintensity;uniform vec4 u_baseColorFactor;uniform vec4 u_emissiveFactor;uniform float u_metallicFactor;uniform float u_roughnessFactor;uniform float u_emissive_strength;in highp vec4 v_position_height;in lowp vec4 v_color_mix;\n#ifdef RENDER_SHADOWS\nin vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;in float v_depth_shadows;\n#endif\n#pragma mapbox: define-attribute highp vec3 normal_3f\n#pragma mapbox: define-attribute highp vec3 color_3f\n#pragma mapbox: define-attribute highp vec4 color_4f\n#pragma mapbox: define-attribute highp vec2 uv_2f\n#pragma mapbox: initialize-attribute highp vec3 normal_3f\n#pragma mapbox: initialize-attribute highp vec3 color_3f\n#pragma mapbox: initialize-attribute highp vec4 color_4f\n#pragma mapbox: initialize-attribute highp vec2 uv_2f\n#ifdef HAS_ATTRIBUTE_a_pbr\nin lowp vec4 v_roughness_metallic_emissive_alpha;in mediump vec4 v_height_based_emission_params;\n#endif\n#ifdef HAS_TEXTURE_u_baseColorTexture\nuniform sampler2D u_baseColorTexture;uniform bool u_baseTextureIsAlpha;uniform bool u_alphaMask;uniform float u_alphaCutoff;\n#endif\n#ifdef HAS_TEXTURE_u_metallicRoughnessTexture\nuniform sampler2D u_metallicRoughnessTexture;\n#endif\n#ifdef HAS_TEXTURE_u_occlusionTexture\nuniform sampler2D u_occlusionTexture;uniform float u_aoIntensity;\n#endif\n#ifdef HAS_TEXTURE_u_normalTexture\nuniform sampler2D u_normalTexture;\n#endif\n#ifdef HAS_TEXTURE_u_emissionTexture\nuniform sampler2D u_emissionTexture;\n#endif\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nin highp float v_depth;uniform sampler2D u_depthTexture;uniform vec2 u_inv_depth_size;bool isOccluded() {vec2 coord=gl_FragCoord.xy*u_inv_depth_size;highp float depth=unpack_depth(texture(u_depthTexture,coord));return v_depth > depth+0.0005;}\n#endif\n#define saturate(_x) clamp(_x,0.,1.)\nvec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}float calculate_NdotL(vec3 normal,vec3 lightDir) {const float ext=0.70710678118;return (clamp(dot(normal,lightDir),-ext,1.0)+ext)/(1.0+ext);}vec3 getDiffuseShadedColor(vec3 albedo,vec3 normal,vec3 lightDir,vec3 lightColor)\n{\n#ifdef LIGHTING_3D_MODE\nvec3 transformed_normal=vec3(-normal.xy,normal.z);float lighting_factor;\n#ifdef RENDER_SHADOWS\nlighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);\n#else\nlighting_factor=saturate(dot(transformed_normal,u_lighting_directional_dir));\n#endif\nreturn apply_lighting(albedo,transformed_normal,lighting_factor);\n#else\nvec3 n=normal;float colorvalue=((albedo.x*0.2126)+(albedo.y*0.7152))+(albedo.z*0.0722);vec3 c=vec3(0.03,0.03,0.03);float directional=clamp(dot(n,vec3(lightDir)),0.0,1.0);directional=mix(1.0-u_lightintensity,max((1.0-colorvalue)+u_lightintensity,1.0),directional);vec3 c3=c+clamp((albedo*directional)*lightColor,mix(vec3(0.0),vec3(0.3),vec3(1.0)-lightColor),vec3(1.0));return c3;\n#endif\n}vec4 getBaseColor() {vec4 albedo=u_baseColorFactor;\n#ifdef HAS_ATTRIBUTE_a_color_3f\nalbedo*=vec4(color_3f,1.0);\n#endif\n#ifdef HAS_ATTRIBUTE_a_pbr\n#else\n#ifdef HAS_ATTRIBUTE_a_color_4f\nalbedo*=color_4f;\n#endif\n#endif\n#if defined (HAS_TEXTURE_u_baseColorTexture) && defined (HAS_ATTRIBUTE_a_uv_2f)\nvec4 texColor=texture(u_baseColorTexture,uv_2f);if(u_alphaMask) {if (texColor.w < u_alphaCutoff) {discard;}}\n#ifdef UNPREMULT_TEXTURE_IN_SHADER\nif(texColor.w > 0.0) {texColor.rgb/=texColor.w;}texColor.w=1.0;\n#endif\ntexColor.rgb=sRGBToLinear(texColor.rgb);if(u_baseTextureIsAlpha) {if (texColor.w < 0.5) {discard;}albedo*=mix(vec4(texColor.rgb,texColor.a),vec4(texColor.a),float(u_baseTextureIsAlpha));} else {albedo*=texColor;}\n#endif\nreturn vec4(mix(albedo.rgb,v_color_mix.rgb,v_color_mix.a),albedo.a);}highp mat3 cotangentFrame(highp vec3 N,highp vec3 p,highp vec2 uv ) {\n#ifdef HAS_TEXTURE_u_normalTexture\nhighp vec3 dp1=vec3(dFdx(p.x),dFdx(p.y),dFdx(p.z));highp vec3 dp2=vec3(dFdy(p.x),dFdy(p.y),dFdy(p.z));highp vec2 duv1=vec2(dFdx(uv.x),dFdx(uv.y));highp vec2 duv2=vec2(dFdy(uv.x),dFdy(uv.y));highp vec3 dp2perp=cross( dp2,N );highp vec3 dp1perp=cross( N,dp1 );highp vec3 T=dp2perp*duv1.x+dp1perp*duv2.x;highp vec3 B=dp2perp*duv1.y+dp1perp*duv2.y;highp float lengthT=dot(T,T);highp float lengthB=dot(B,B);highp float maxLength=max(lengthT,lengthB);highp float invmax=inversesqrt( maxLength );highp mat3 res=mat3( T*invmax,B*invmax,N );return res;\n#else\nreturn mat3(1.0);\n#endif\n}highp vec3 getNormal(){highp vec3 n;\n#ifdef HAS_ATTRIBUTE_a_normal_3f\nn=normalize(normal_3f);\n#else\nhighp vec3 fdx=vec3(dFdx(v_position_height.x),dFdx(v_position_height.y),dFdx(v_position_height.z));highp vec3 fdy=vec3(dFdy(v_position_height.x),dFdy(v_position_height.y),dFdy(v_position_height.z));n=normalize(cross(fdx,fdy))*-1.0;\n#endif\n#if defined(HAS_TEXTURE_u_normalTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)\nvec3 nMap=texture( u_normalTexture,uv_2f).xyz;nMap=normalize(2.0*nMap-vec3(1.0));highp vec3 v=normalize(-v_position_height.xyz);highp mat3 TBN=cotangentFrame(n,v,uv_2f);n=normalize(TBN*nMap);\n#endif\nreturn n;}struct Material {float perceptualRoughness;float alphaRoughness;float metallic;vec3 f90;vec4 baseColor;vec3 diffuseColor;vec3 specularColor;highp vec3 normal;};Material getPBRMaterial() {Material mat;mat.baseColor=getBaseColor();mat.perceptualRoughness=u_roughnessFactor;mat.metallic=u_metallicFactor;\n#ifdef HAS_ATTRIBUTE_a_pbr\nmat.perceptualRoughness=v_roughness_metallic_emissive_alpha.x;mat.metallic=v_roughness_metallic_emissive_alpha.y;mat.baseColor.w*=v_roughness_metallic_emissive_alpha.w;\n#endif\n#if defined(HAS_TEXTURE_u_metallicRoughnessTexture) && defined(HAS_ATTRIBUTE_a_uv_2f) \nvec4 mrSample=texture(u_metallicRoughnessTexture,uv_2f);mat.perceptualRoughness*=mrSample.g;mat.metallic*=mrSample.b;\n#endif\nconst float c_minRoughness=0.04;mat.perceptualRoughness=clamp(mat.perceptualRoughness,c_minRoughness,1.0);mat.metallic=saturate(mat.metallic);mat.alphaRoughness=mat.perceptualRoughness*mat.perceptualRoughness;const vec3 f0=vec3(0.04);mat.diffuseColor=mat.baseColor.rgb*(vec3(1.0)-f0);mat.diffuseColor*=1.0-mat.metallic;mat.specularColor=mix(f0,mat.baseColor.rgb,mat.metallic);highp float reflectance=max(max(mat.specularColor.r,mat.specularColor.g),mat.specularColor.b);highp float reflectance90=saturate(reflectance*25.0);mat.f90=vec3(reflectance90);mat.normal=getNormal();return mat;}float V_GGX(float NdotL,float NdotV,float roughness)\n{float a2=roughness*roughness;float GGXV=NdotL*sqrt(NdotV*NdotV*(1.0-a2)+a2);float GGXL=NdotV*sqrt(NdotL*NdotL*(1.0-a2)+a2);return 0.5/(GGXV+GGXL);}float V_GGXFast(float NdotL,float NdotV,float roughness) {float a=roughness;float GGXV=NdotL*(NdotV*(1.0-a)+a);float GGXL=NdotV*(NdotL*(1.0-a)+a);return 0.5/(GGXV+GGXL);}vec3 F_Schlick(vec3 specularColor,vec3 f90,float VdotH)\n{return specularColor+(f90-specularColor)*pow(clamp(1.0-VdotH,0.0,1.0),5.0);}vec3 F_SchlickFast(vec3 specularColor,float VdotH)\n{float x=1.0-VdotH;float x4=x*x*x*x;return specularColor+(1.0-specularColor)*x4*x;}float D_GGX(highp float NdotH,float alphaRoughness)\n{highp float a4=alphaRoughness*alphaRoughness;highp float f=(NdotH*a4-NdotH)*NdotH+1.0;return a4/(PI*f*f);}vec3 diffuseBurley(Material mat,float LdotH,float NdotL,float NdotV)\n{float f90=2.0*LdotH*LdotH*mat.alphaRoughness-0.5;return (mat.diffuseColor/PI)*(1.0+f90*pow((1.0-NdotL),5.0))*(1.0+f90*pow((1.0-NdotV),5.0));}vec3 diffuseLambertian(Material mat)\n{\n#ifdef LIGHTING_3D_MODE\nreturn mat.diffuseColor;\n#else\nreturn mat.diffuseColor/PI;\n#endif\n}vec3 EnvBRDFApprox(vec3 specularColor,float roughness,highp float NdotV)\n{vec4 c0=vec4(-1,-0.0275,-0.572,0.022);vec4 c1=vec4(1,0.0425,1.04,-0.04);highp vec4 r=roughness*c0+c1;highp float a004=min(r.x*r.x,exp2(-9.28*NdotV))*r.x+r.y;vec2 AB=vec2(-1.04,1.04)*a004+r.zw;return specularColor*AB.x+AB.y;}vec3 computeIndirectLightContribution(Material mat,float NdotV,vec3 normal)\n{vec3 env_light=vec3(0.65,0.65,0.65);\n#ifdef LIGHTING_3D_MODE\nfloat ambient_factor=calculate_ambient_directional_factor(normal);env_light=u_lighting_ambient_color*ambient_factor;\n#endif\nvec3 envBRDF=EnvBRDFApprox(mat.specularColor,mat.perceptualRoughness,NdotV);vec3 indirectSpecular= envBRDF*env_light;vec3 indirectDiffuse=mat.diffuseColor*env_light;return indirectSpecular+indirectDiffuse;}vec3 computeLightContribution(Material mat,vec3 lightPosition,vec3 lightColor)\n{highp vec3 n=mat.normal;highp vec3 v=normalize(-v_position_height.xyz);highp vec3 l=normalize(lightPosition);highp vec3 h=normalize(v+l);float NdotV=clamp(abs(dot(n,v)),0.001,1.0);float NdotL=saturate(dot(n,l));highp float NdotH=saturate(dot(n,h));float VdotH=saturate(dot(v,h));vec3 f=F_SchlickFast(mat.specularColor,VdotH);float g=V_GGXFast(NdotL,NdotV,mat.alphaRoughness);float d=D_GGX(NdotH,mat.alphaRoughness);vec3 diffuseTerm=(1.0-f)*diffuseLambertian(mat);vec3 specularTerm=f*g*d;vec3 transformed_normal=vec3(-n.xy,n.z);float lighting_factor;\n#ifdef RENDER_SHADOWS\nlighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);\n#else\nlighting_factor=NdotL;\n#endif\nvec3 directLightColor=(specularTerm+diffuseTerm)*lighting_factor*lightColor;vec3 indirectLightColor=computeIndirectLightContribution(mat,NdotV,transformed_normal);vec3 color=(saturate(directLightColor)+indirectLightColor);float intensityFactor=1.0;\n#if !defined(LIGHTING_3D_MODE)\nconst vec3 luminosityFactor=vec3(0.2126,0.7152,0.0722);float luminance=dot(diffuseTerm,luminosityFactor);intensityFactor=mix((1.0-u_lightintensity),max((1.0-luminance+u_lightintensity),1.0),NdotL);\n#endif\ncolor*=intensityFactor;return color;}void main() {\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nif (isOccluded()) {discard;}\n#endif\nvec3 lightDir=u_lightpos;vec3 lightColor=u_lightcolor;\n#ifdef LIGHTING_3D_MODE\nlightDir=u_lighting_directional_dir;lightDir.xy=-lightDir.xy;lightColor=u_lighting_directional_color;\n#endif\nvec4 finalColor;\n#ifdef DIFFUSE_SHADED\nvec3 N=getNormal();vec3 diffuse=getDiffuseShadedColor(getBaseColor().rgb,N,lightDir,lightColor);\n#ifdef HAS_TEXTURE_u_occlusionTexture\nfloat ao=(texture(u_occlusionTexture,uv_2f).r-1.0)*u_aoIntensity+1.0;diffuse*=ao;\n#endif\nfinalColor=vec4(diffuse,1.0)*u_opacity;\n#else\nMaterial mat=getPBRMaterial();vec3 color=computeLightContribution(mat,lightDir,lightColor);float ao=1.0;\n#if defined (HAS_TEXTURE_u_occlusionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)\nao=(texture(u_occlusionTexture,uv_2f).x-1.0)*u_aoIntensity+1.0;color*=ao;\n#endif\nvec4 emissive=u_emissiveFactor;\n#if defined(HAS_TEXTURE_u_emissionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)\nemissive.rgb*=sRGBToLinear(texture(u_emissionTexture,uv_2f).rgb);\n#endif\ncolor+=emissive.rgb;float opacity=mat.baseColor.w*u_opacity;\n#ifdef HAS_ATTRIBUTE_a_pbr\nfloat resEmission=v_roughness_metallic_emissive_alpha.z;resEmission*=v_height_based_emission_params.z+v_height_based_emission_params.w*pow(clamp(v_height_based_emission_params.x,0.0,1.0),v_height_based_emission_params.y);color=mix(color,v_color_mix.rgb,min(1.0,resEmission));\n#ifdef HAS_ATTRIBUTE_a_color_4f\nfloat distance=length(vec2(1.3*max(0.0,abs(color_4f.x)-color_4f.z),color_4f.y));distance+= mix(0.5,0.0,clamp(resEmission-1.0,0.0,1.0));opacity*=v_roughness_metallic_emissive_alpha.w*saturate(1.0-distance*distance);\n#endif\n#endif\nvec3 unlitColor=mat.baseColor.rgb*ao+emissive.rgb;color=mix(color,unlitColor,u_emissive_strength);color=linearTosRGB(color);color*=opacity;finalColor=vec4(color,opacity);\n#endif\n#ifdef FOG\nfinalColor=fog_dither(fog_apply_premultiplied(finalColor,v_fog_pos,v_position_height.w));\n#endif\n#ifdef RENDER_CUTOFF\nfinalColor*=v_cutoff_opacity;\n#endif\n#ifdef INDICATOR_CUTOUT\nfinalColor=applyCutout(finalColor);\n#endif\nglFragColor=finalColor;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec3 a_pos_3f;\n#pragma mapbox: define-attribute highp vec3 normal_3f\n#pragma mapbox: define-attribute highp vec2 uv_2f\n#pragma mapbox: define-attribute highp vec3 color_3f\n#pragma mapbox: define-attribute highp vec4 color_4f\n#pragma mapbox: define-attribute-vertex-shader-only highp vec4 pbr\n#pragma mapbox: define-attribute-vertex-shader-only highp vec3 heightBasedEmissiveStrength\nuniform mat4 u_matrix;uniform mat4 u_lighting_matrix;uniform vec3 u_camera_pos;uniform vec4 u_color_mix;\n#ifdef INSTANCED_ARRAYS\nin vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;\n#else\nuniform highp mat4 u_normal_matrix;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;out float v_depth_shadows;\n#endif\nout vec4 v_position_height;out lowp vec4 v_color_mix;\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nout highp float v_depth;\n#endif\n#ifdef HAS_ATTRIBUTE_a_pbr\nout lowp vec4 v_roughness_metallic_emissive_alpha;out mediump vec4 v_height_based_emission_params;\n#endif\nvec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {\n#pragma mapbox: initialize-attribute highp vec3 normal_3f\n#pragma mapbox: initialize-attribute highp vec2 uv_2f\n#pragma mapbox: initialize-attribute highp vec3 color_3f\n#pragma mapbox: initialize-attribute highp vec4 color_4f\n#pragma mapbox: initialize-attribute-custom highp vec4 pbr\n#pragma mapbox: initialize-attribute-custom highp vec3 heightBasedEmissiveStrength\nhighp mat4 normal_matrix;\n#ifdef INSTANCED_ARRAYS\nnormal_matrix=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);\n#else\nnormal_matrix=u_normal_matrix;\n#endif\nvec3 local_pos;mat3 rs;\n#ifdef MODEL_POSITION_ON_GPU\nvec3 pos_color=normal_matrix[0].xyz;vec4 translate=normal_matrix[1];vec3 pos_a=floor(pos_color);vec3 rgb=1.05*(pos_color-pos_a);float color_mix=pos_a.z/100.0;v_color_mix=vec4(sRGBToLinear(rgb),color_mix);float meter_to_tile=normal_matrix[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);rs[0].x=normal_matrix[1].w;rs[0].yz=normal_matrix[2].xy;rs[1].xy=normal_matrix[2].zw;rs[1].z=normal_matrix[3].x;rs[2].xyz=normal_matrix[3].yzw;vec4 pos_node=u_lighting_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;local_pos=pos.xyz;gl_Position=u_matrix*pos;pos.z*=meter_to_tile;v_position_height.xyz=pos.xyz-u_camera_pos;\n#else\nlocal_pos=a_pos_3f;gl_Position=u_matrix*vec4(a_pos_3f,1);v_position_height.xyz=vec3(u_lighting_matrix*vec4(a_pos_3f,1));v_color_mix=vec4(sRGBToLinear(u_color_mix.rgb),u_color_mix.a);\n#endif\nv_position_height.w=a_pos_3f.z;\n#ifdef HAS_ATTRIBUTE_a_pbr\nvec4 albedo_c=decode_color(pbr.xy);vec2 e_r_m=unpack_float(pbr.z);vec2 r_m= unpack_float(e_r_m.y*16.0);r_m.r=r_m.r*16.0;v_color_mix=vec4(albedo_c.rgb,1.0);v_roughness_metallic_emissive_alpha=vec4(vec3(r_m,e_r_m.x)/255.0,albedo_c.a);v_roughness_metallic_emissive_alpha.z*=2.0;float heightBasedRelativeIntepolation=a_pos_3f.z*heightBasedEmissiveStrength.x+heightBasedEmissiveStrength.y;v_height_based_emission_params.x=heightBasedRelativeIntepolation;v_height_based_emission_params.y=heightBasedEmissiveStrength.z;vec2 emissionMultiplierValues=unpack_float(pbr.w)/256.0;v_height_based_emission_params.z=emissionMultiplierValues.x;v_height_based_emission_params.w=emissionMultiplierValues.y-emissionMultiplierValues.x;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(local_pos);\n#endif\n#ifdef RENDER_CUTOFF\nv_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);\n#endif\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nv_depth=gl_Position.z/gl_Position.w;\n#endif\n#ifdef HAS_ATTRIBUTE_a_normal_3f\n#ifdef MODEL_POSITION_ON_GPU\nfloat x_squared_scale=dot(rs[0],rs[0]);float y_squared_scale=dot(rs[1],rs[1]);float z_squared_scale=dot(rs[2],rs[2]);vec3 squared_scale=vec3(x_squared_scale,y_squared_scale,z_squared_scale);normal_3f=rs*((u_lighting_matrix*vec4(normal_3f,0.0)).xyz/squared_scale);normal_3f=normalize(normal_3f);\n#else\nnormal_3f=vec3(normal_matrix*vec4(normal_3f,0));\n#endif\n#endif\n#ifdef HAS_ATTRIBUTE_a_pbr\n#ifdef HAS_ATTRIBUTE_a_color_4f\nv_roughness_metallic_emissive_alpha.w=clamp(color_4f.a*v_roughness_metallic_emissive_alpha.w*(v_roughness_metallic_emissive_alpha.z-1.0),0.0,1.0);\n#endif\n#endif\n#ifdef RENDER_SHADOWS\nvec3 shadow_pos=local_pos;\n#ifdef NORMAL_OFFSET\n#ifdef HAS_ATTRIBUTE_a_normal_3f\n#ifdef MODEL_POSITION_ON_GPU\nvec3 offset=shadow_normal_offset(vec3(-normal_3f.xy,normal_3f.z));shadow_pos+=offset*shadow_normal_offset_multiplier0();\n#else\nvec3 offset=shadow_normal_offset_model(normalize(normal_3f));shadow_pos+=offset*shadow_normal_offset_multiplier0();\n#endif\n#endif\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shadow_pos,1);v_pos_light_view_1=u_light_matrix_1*vec4(shadow_pos,1);v_depth_shadows=gl_Position.w;\n#endif\n}'),modelDepth:Tn("in highp float v_depth;void main() {\n#ifndef DEPTH_TEXTURE\nglFragColor=pack_depth(v_depth);\n#endif\n}","in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;\n#ifdef MODEL_POSITION_ON_GPU\n#ifdef INSTANCED_ARRAYS\nin vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;\n#else\nuniform highp mat4 u_instance;\n#endif\nuniform highp mat4 u_node_matrix;\n#endif\nvoid main() {\n#ifdef MODEL_POSITION_ON_GPU\nhighp mat4 instance;\n#ifdef INSTANCED_ARRAYS\ninstance=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);\n#else\ninstance=u_instance;\n#endif\nvec3 pos_color=instance[0].xyz;vec4 translate=instance[1];vec3 pos_a=floor(pos_color);float meter_to_tile=instance[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);mat3 rs;rs[0].x=instance[1].w;rs[0].yz=instance[2].xy;rs[1].xy=instance[2].zw;rs[1].z=instance[3].x;rs[2].xyz=instance[3].yzw;vec4 pos_node=u_node_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;gl_Position=u_matrix*pos;\n#else\ngl_Position=u_matrix*vec4(a_pos_3f,1);\n#endif\nv_depth=gl_Position.z/gl_Position.w;}"),stars:Tn("in highp vec2 v_uv;in mediump float v_intensity;float shapeCircle(in vec2 uv)\n{float beginFade=0.6;float lengthFromCenter=length(v_uv);return 1.0-clamp((lengthFromCenter-beginFade)/(1.0-beginFade),0.0,1.0);}void main() {float alpha=shapeCircle(v_uv);vec3 color=vec3(1.0,1.0,1.0);alpha*=v_intensity;glFragColor=vec4(color*alpha,alpha);HANDLE_WIREFRAME_DEBUG;}","\nin vec3 a_pos_3f;in vec2 a_uv;in float a_size_scale;in float a_fade_opacity;uniform mat4 u_matrix;uniform vec3 u_up;uniform vec3 u_right;uniform float u_intensity_multiplier;out highp vec2 v_uv;out mediump float v_intensity;void main() {v_uv=a_uv;v_intensity=a_fade_opacity*u_intensity_multiplier;vec3 pos=a_pos_3f;pos+=a_uv.x*u_right*a_size_scale;pos+=a_uv.y*u_up*a_size_scale;gl_Position=u_matrix*vec4(pos,1.0);}")};function vv(e,t){const n=e.replace(/\s*\/\/[^\n]*\n/g,"\n").split("\n");for(let r of n)if(r=r.trim(),"#"===r[0]&&r.includes("if")&&!r.includes("endif")){r=r.replace("#","").replace(/ifdef|ifndef|elif|if/g,"").replace(/!|defined|\(|\)|\|\||&&/g,"").replace(/\s+/g," ").trim();const o=r.split(" ");for(const s of o)t.includes(s)||t.push(s)}}function Tn(e,t){const n=/#include\s+"([^"]+)"/g,r=/#pragma mapbox: ([\w\-]+) ([\w]+) ([\w]+) ([\w]+)/g;let o=t.match(/(attribute(\S*)|(^\s*|;)in) (highp |mediump |lowp )?([\w]+) ([\w]+)/gm);o&&(o=o.map(f=>{const m=f.split(" ");return m[m.length-1]}),o=[...new Set(o)]);const s={},c=[],u=[];e=e.replace(n,(f,m)=>(u.push(m),"")),t=t.replace(n,(f,m)=>(c.push(m),""));let d=[..._v];vv(e,d),vv(t,d);for(const f of[...c,...u])Vg[f]||console.error(`Undefined include: ${f}`),Ug[f]||(Ug[f]=[],vv(Vg[f],Ug[f])),d=[...d,...Ug[f]];return{fragmentSource:e=e.replace(r,(f,m,g,y,v)=>(s[v]=!0,"define"===m?`\n#ifndef HAS_UNIFORM_u_${v}\nin ${g} ${y} ${v};\n#else\nuniform ${g} ${y} u_${v};\n#endif\n`:"initialize"===m?`\n#ifdef HAS_UNIFORM_u_${v}\n    ${g} ${y} ${v} = u_${v};\n#endif\n`:"define-attribute"===m?`\n#ifdef HAS_ATTRIBUTE_a_${v}\n    in ${g} ${y} ${v};\n#endif\n`:"initialize-attribute"===m?"":void 0)),vertexSource:t=t.replace(r,(f,m,g,y,v)=>{const x="float"===y?"vec2":y,w=v.match(/color/)?"color":x;return"define-attribute-vertex-shader-only"===m?`\n#ifdef HAS_ATTRIBUTE_a_${v}\nin ${g} ${y} a_${v};\n#endif\n`:s[v]?"define"===m?`\n#ifndef HAS_UNIFORM_u_${v}\nuniform lowp float u_${v}_t;\nin ${g} ${x} a_${v};\nout ${g} ${y} ${v};\n#else\nuniform ${g} ${y} u_${v};\n#endif\n`:"initialize"===m?"vec4"===w?`\n#ifndef HAS_UNIFORM_u_${v}\n    ${v} = a_${v};\n#else\n    ${g} ${y} ${v} = u_${v};\n#endif\n`:`\n#ifndef HAS_UNIFORM_u_${v}\n    ${v} = unpack_mix_${w}(a_${v}, u_${v}_t);\n#else\n    ${g} ${y} ${v} = u_${v};\n#endif\n`:"define-attribute"===m?`\n#ifdef HAS_ATTRIBUTE_a_${v}\n    in ${g} ${y} a_${v};\n    out ${g} ${y} ${v};\n#endif\n`:"initialize-attribute"===m?`\n#ifdef HAS_ATTRIBUTE_a_${v}\n    ${v} = a_${v};\n#endif\n`:void 0:"define"===m?`\n#ifndef HAS_UNIFORM_u_${v}\nuniform lowp float u_${v}_t;\nin ${g} ${x} a_${v};\n#else\nuniform ${g} ${y} u_${v};\n#endif\n`:"define-instanced"===m?"mat4"===w?`\n#ifdef INSTANCED_ARRAYS\nin vec4 a_${v}0;\nin vec4 a_${v}1;\nin vec4 a_${v}2;\nin vec4 a_${v}3;\n#else\nuniform ${g} ${y} u_${v};\n#endif\n`:`\n#ifdef INSTANCED_ARRAYS\nin ${g} ${x} a_${v};\n#else\nuniform ${g} ${y} u_${v};\n#endif\n`:"initialize-attribute-custom"===m?`\n#ifdef HAS_ATTRIBUTE_a_${v}\n    ${g} ${y} ${v} = a_${v};\n#endif\n`:"vec4"===w?`\n#ifndef HAS_UNIFORM_u_${v}\n    ${g} ${y} ${v} = a_${v};\n#else\n    ${g} ${y} ${v} = u_${v};\n#endif\n`:`\n#ifndef HAS_UNIFORM_u_${v}\n    ${g} ${y} ${v} = unpack_mix_${w}(a_${v}, u_${v}_t);\n#else\n    ${g} ${y} ${v} = u_${v};\n#endif\n`}),staticAttributes:o,usedDefines:d,vertexIncludes:c,fragmentIncludes:u}}class OD{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffers=[],this.vao=null}bind(t,n,r,o,s,c,u,d){this.context=t;let f=this.boundPaintVertexBuffers.length!==o.length;for(let g=0;!f&&g<o.length;g++)this.boundPaintVertexBuffers[g]!==o[g]&&(f=!0);let m=this.boundDynamicVertexBuffers.length!==u.length;for(let g=0;!m&&g<u.length;g++)this.boundDynamicVertexBuffers[g]!==u[g]&&(m=!0);if(!this.vao||this.boundProgram!==n||this.boundLayoutVertexBuffer!==r||f||m||this.boundIndexBuffer!==s||this.boundVertexOffset!==c)this.freshBind(n,r,o,s,c,u,d);else{t.bindVertexArrayOES.set(this.vao);for(const g of u)g&&(g.bind(),d&&g.instanceCount&&g.setVertexAttribDivisor(t.gl,n,d));s&&s.dynamicDraw&&s.bind()}}freshBind(t,n,r,o,s,c,u){const d=t.numAttributes,f=this.context,m=f.gl;this.vao&&this.destroy(),this.vao=f.gl.createVertexArray(),f.bindVertexArrayOES.set(this.vao),this.boundProgram=t,this.boundLayoutVertexBuffer=n,this.boundPaintVertexBuffers=r,this.boundIndexBuffer=o,this.boundVertexOffset=s,this.boundDynamicVertexBuffers=c,n.enableAttributes(m,t),n.bind(),n.setVertexAttribPointers(m,t,s);for(const g of r)g.enableAttributes(m,t),g.bind(),g.setVertexAttribPointers(m,t,s);for(const g of c)g&&(g.enableAttributes(m,t),g.bind(),g.setVertexAttribPointers(m,t,s),u&&g.instanceCount&&g.setVertexAttribDivisor(m,t,u));o&&o.bind(),f.currentNumAttributes=d}destroy(){this.vao&&(this.context.gl.deleteVertexArray(this.vao),this.vao=null)}}function kD(e,t){const n=Math.pow(2,t.canonical.z),r=t.canonical.y;return[new Qe(0,r/n).toLngLat().lat,new Qe(0,(r+1)/n).toLngLat().lat]}function BC(e,t,n,r,o,s,c){const u=e.context,d=u.gl,f=n.hillshadeFBO;if(!f)return;e.prepareDrawTile();const m=e.isTileAffectedByFog(t),g=e.getOrCreateProgram("hillshade",{overrideFog:m});u.activeTexture.set(d.TEXTURE0),d.bindTexture(d.TEXTURE_2D,f.colorAttachment.get());const y=((E,M,D,A)=>{const P=D.paint.get("hillshade-shadow-color"),C=D.paint.get("hillshade-highlight-color"),R=D.paint.get("hillshade-accent-color"),k=D.paint.get("hillshade-emissive-strength");let N=Oe(D.paint.get("hillshade-illumination-direction"));if("viewport"===D.paint.get("hillshade-illumination-anchor"))N-=E.transform.angle;else if(E.style&&E.style.enable3dLights()&&E.style.directionalLight){const B=E.style.directionalLight.properties.get("direction");N=Oe(ae(B.x,B.y,B.z)[1])}const z=!E.options.moving;return{u_matrix:A||E.transform.calculateProjMatrix(M.tileID.toUnwrapped(),z),u_image:0,u_latrange:kD(0,M.tileID),u_light:[D.paint.get("hillshade-exaggeration"),N],u_shadow:P,u_highlight:C,u_emissive_strength:k,u_accent:R}})(e,n,r,e.terrain?t.projMatrix:null);e.uploadCommonUniforms(u,g,t.toUnwrapped());const{tileBoundsBuffer:v,tileBoundsIndexBuffer:x,tileBoundsSegments:w}=e.getTileBoundsBuffers(n);g.draw(e,d.TRIANGLES,o,s,c,Ge.disabled,y,r.id,v,x,w)}function pE(e,t,n){if(!t.needsDEMTextureUpload)return;const r=e.context,o=r.gl;r.pixelStoreUnpackPremultiplyAlpha.set(!1),t.demTexture=t.demTexture||e.getTileTexture(n.stride);const s=n.getPixels();t.demTexture?t.demTexture.update(s,{premultiply:!1}):t.demTexture=new hr(r,s,o.R32F,{premultiply:!1}),t.needsDEMTextureUpload=!1}function FD(e,t,n){const r=e.context,o=r.gl;if(!t.dem)return;const s=t.dem;if(r.activeTexture.set(o.TEXTURE1),pE(e,t,s),!t.demTexture)return;t.demTexture.bind(o.NEAREST,o.CLAMP_TO_EDGE);const c=s.dim;r.activeTexture.set(o.TEXTURE0);let u=t.hillshadeFBO;if(!u){const y=new hr(r,{width:c,height:c,data:null},o.RGBA);y.bind(o.LINEAR,o.CLAMP_TO_EDGE),u=t.hillshadeFBO=r.createFramebuffer(c,c,!0,"renderbuffer"),u.colorAttachment.set(y.texture)}r.bindFramebuffer.set(u.framebuffer),r.viewport.set([0,0,c,c]);const{tileBoundsBuffer:d,tileBoundsIndexBuffer:f,tileBoundsSegments:m}=e.getMercatorTileBoundsBuffers(),g=[];e.linearFloatFilteringSupported()&&g.push("TERRAIN_DEM_FLOAT_FORMAT"),e.getOrCreateProgram("hillshadePrepare",{defines:g}).draw(e,o.TRIANGLES,be.disabled,$e.disabled,hn.unblended,Ge.disabled,((y,v)=>{const x=v.stride,w=st.create();return st.ortho(w,0,et,-et,0,0,1),st.translate(w,w,[0,-et,0]),{u_matrix:w,u_image:1,u_dimension:[x,x],u_zoom:y.overscaledZ}})(t.tileID,s),n.id,d,f,m),t.needsHillshadePrepare=!1}const mE=e=>({u_matrix:new Re(e),u_image0:new Ze(e),u_skirt_height:new Rt(e),u_ground_shadow_factor:new Ae(e)}),gE=(e,t,n)=>({u_matrix:e,u_image0:0,u_skirt_height:t,u_ground_shadow_factor:n}),_E=(e,t,n,r,o,s,c,u,d,f,m,g,y,v,x)=>({u_proj_matrix:Float32Array.from(e),u_globe_matrix:t,u_normalize_matrix:Float32Array.from(r),u_merc_matrix:n,u_zoom_transition:o,u_merc_center:s,u_image0:0,u_frustum_tl:c,u_frustum_tr:u,u_frustum_br:d,u_frustum_bl:f,u_globe_pos:m,u_globe_radius:g,u_viewport:y,u_grid_matrix:x?Float32Array.from(x):new Float32Array(9),u_skirt_height:v}),kd=(e,t)=>{if(t>0&&e.terrain&&nt("Cutoff is currently disabled on terrain"),t<=0||e.terrain)return{shouldRenderCutoff:!1,uniformValues:{u_cutoff_params:[0,0,0,0]}};const n=e.transform,r=Math.max(Math.abs(n._zoom-(e.minCutoffZoom-1)),1),o=n.isLODDisabled(!1)?Ro(60,45,n.pitch):Ro(30,15,n.pitch),s=n._farZ-n._nearZ,c=t*n.height,u=((1-(d=o))*(.75*n.cameraToCenterDistance)+d*(n._farZ+c))*r;var d;return{shouldRenderCutoff:o<1,uniformValues:{u_cutoff_params:[n._nearZ,n._farZ,(u-n._nearZ)/s,(u-c-n._nearZ)/s]}}};function yE(e,t){return null!=e&&null!=t&&!(!e.hasData()||!t.hasData())&&null!=e.demTexture&&null!=t.demTexture&&e.tileID.key!==t.tileID.key}const Fd=new class{constructor(){this.operations={}}newMorphing(e,t,n,r,o){if(e in this.operations){const s=this.operations[e];s.to.tileID.key!==n.tileID.key&&(s.queued=n)}else this.operations[e]={startTime:r,phase:0,duration:o,from:t,to:n,queued:null}}getMorphValuesForProxy(e){if(!(e in this.operations))return null;const t=this.operations[e];return{from:t.from,to:t.to,phase:t.phase}}update(e){for(const t in this.operations){const n=this.operations[t];for(n.phase=(e-n.startTime)/n.duration;n.phase>=1||!this._validOp(n);)if(!this._nextOp(n,e)){delete this.operations[t];break}}}_nextOp(e,t){return!!e.queued&&(e.from=e.to,e.to=e.queued,e.queued=null,e.phase=0,e.startTime=t,!0)}_validOp(e){return e.from.hasData()&&e.to.hasData()}},vE={0:null,1:"TERRAIN_VERTEX_MORPHING"};function xE(e,t,n){if(0===t)return 0;const r=t<1&&514===n?.25/t:1;return 6*Math.pow(1.5,22-e)*Math.max(t,1)*r}function ND(e,t){const n=1<<e.z;return!t&&(0===e.x||e.x===n-1)||0===e.y||e.y===n-1}const xv=e=>({u_matrix:e});function Nd(e,t,n,r,o){if(o>0){const s=De.now(),c=(s-e.timeAdded)/o,u=t?(s-t.timeAdded)/o:-1,d=n.getSource(),f=r.coveringZoomLevel({tileSize:d.tileSize,roundZoom:d.roundZoom}),m=!t||Math.abs(t.tileID.overscaledZ-f)>Math.abs(e.tileID.overscaledZ-f),g=m&&e.refreshedUponExpiration?1:ne(m?c:1-u,0,1);return e.refreshedUponExpiration&&c>=1&&(e.refreshedUponExpiration=!1),t?{opacity:1,mix:1-g}:{opacity:g,mix:0}}return{opacity:1,mix:0}}class bE extends ha{constructor(t){const n={type:"raster-dem",maxzoom:t.transform.maxZoom},r=new xp(Nl(),null),o=iv("mock-dem",n,r,t.style);super("mock-dem",o,!1),o.setEventedParent(this),this._sourceLoaded=!0}_loadTile(t,n){t.state="loaded",n(null)}}class wE extends ha{constructor(t){const n=iv("proxy",{type:"geojson",maxzoom:t.transform.maxZoom},new xp(Nl(),null),t.style);super("proxy",n,!1),n.setEventedParent(this),this.map=this.getSource().map=t,this.used=this._sourceLoaded=!0,this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}update(t,n,r){if(t.freezeTileCoverage)return;this.transform=t;const o=t.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled}).reduce((s,c)=>{if(s[c.key]="",!this._tiles[c.key]){const u=new Ya(c,this._source.tileSize*c.overscaleFactor(),t.tileZoom);u.state="loaded",this._tiles[c.key]=u}return s},{});for(const s in this._tiles)s in o||(this.freeFBO(s),this._tiles[s].unloadVectorData(),delete this._tiles[s])}freeFBO(t){const n=this.proxyCachedFBO[t];if(void 0!==n){const r=Object.values(n);this.renderCachePool.push(...r),delete this.proxyCachedFBO[t]}}deallocRenderCache(){this.renderCache.forEach(t=>t.fb.destroy()),this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}}class bv extends nn{constructor(t,n,r){super(t.overscaledZ,t.wrap,t.canonical.z,t.canonical.x,t.canonical.y),this.proxyTileKey=n,this.projMatrix=r}}class EE extends tg{constructor(t,n){super(),this.painter=t,this.terrainTileForTile={},this.prevTerrainTileForTile={};const[r,o,s]=function(d){const f=new Xo,m=new Kr,g=131;f.reserve(17161),m.reserve(33800);const y=et/128,v=et+y/2,x=v+y;for(let E=-y;E<x;E+=y)for(let M=-y;M<x;M+=y){const D=M<0||M>v||E<0||E>v?24575:0,A=ne(Math.round(M),0,et),P=ne(Math.round(E),0,et);f.emplaceBack(A+D,P)}const w=(E,M)=>{const D=M*g+E;m.emplaceBack(D+1,D,D+g),m.emplaceBack(D+g,D+g+1,D+1)};for(let E=1;E<129;E++)for(let M=1;M<129;M++)w(M,E);return[0,129].forEach(E=>{for(let M=0;M<130;M++)w(M,E),w(E,M)}),[f,m,32768]}(),c=t.context;this.gridBuffer=c.createVertexBuffer(r,Cl.members),this.gridIndexBuffer=c.createIndexBuffer(o),this.gridSegments=Rn.simpleSegment(0,0,r.length,o.length),this.gridNoSkirtSegments=Rn.simpleSegment(0,0,r.length,s),this.proxyCoords=[],this.proxiedCoords={},this._visibleDemTiles=[],this._drapedRenderBatches=[],this._sourceTilesOverlap={},this.proxySourceCache=new wE(n.map),this.orthoMatrix=st.create(),st.ortho(this.orthoMatrix,"globe"===this.painter.transform.projection.name?.015:0,et,0,et,0,1);const u=c.gl;this._overlapStencilMode=new $e({func:u.GEQUAL,mask:255},0,255,u.KEEP,u.KEEP,u.REPLACE),this._previousZoom=t.transform.zoom,this.pool=[],this._findCoveringTileCache={},this._tilesDirty={},this.style=n,this._useVertexMorphing=!0,this._exaggeration=1,this._mockSourceCache=new bE(n.map),this._pendingGroundEffectLayers=[]}set style(t){t.on("data",this._onStyleDataEvent.bind(this)),this._style=t,this._style.map.on("moveend",()=>{this._clearLineLayersFromRenderCache()})}update(t,n,r){if(t&&t.terrain){this._style!==t&&(this.style=t,this._evaluationZoom=void 0);const o=t.terrain.properties,s=0===t.terrain.drapeRenderMode,c=t.terrain.isZoomDependent();this._previousUpdateTimestamp=this.enabled?this._updateTimestamp:void 0,this._updateTimestamp=De.now();const u=t.terrain&&t.terrain.scope,d=o.get("source"),f=s?this._mockSourceCache:t.getSourceCache(d,u);if(!f)return void nt(`Couldn't find terrain source "${d}".`);if(this.sourceCache=f,this._exaggeration=c?this.calculateExaggeration(n):o.get("exaggeration"),!n.projection.requiresDraping&&c&&0===this._exaggeration)return void this._disable();this.enabled=!0;const m=()=>{this.sourceCache.used&&nt(`Raster DEM source '${this.sourceCache.id}' is used both for terrain and as layer source.\nThis leads to lower resolution of hillshade. For full hillshade resolution but higher memory consumption, define another raster DEM source.`);const g=this.getScaledDemTileSize();this.sourceCache.update(n,g,!0),this.resetTileLookupCache(this.sourceCache.id)};this.sourceCache.usedForTerrain||(this.resetTileLookupCache(this.sourceCache.id),this.sourceCache.usedForTerrain=!0,m(),this._initializing=!0),m(),n.updateElevation(!0,r),this.resetTileLookupCache(this.proxySourceCache.id),this.proxySourceCache.update(n),this._emptyDEMTextureDirty=!0,this._previousZoom=n.zoom}else this._disable()}calculateExaggeration(t){const n=this._previousCameraAltitude,r=t.getFreeCameraOptions().position.z/t.pixelsPerMeter*t.worldSize;this._previousCameraAltitude=r;const o=null!=n?r-n:Number.MAX_VALUE;if(Math.abs(o)<2)return this._exaggeration;const s=t.zoom,c=this._style.terrain;if(!this._previousUpdateTimestamp)return c.getExaggeration(s);let u=s-this._previousZoom;const d=this._previousUpdateTimestamp;let f=s;null!=this._evaluationZoom&&(f=this._evaluationZoom,Math.abs(s-f)>.5&&(u=.5*(s-f+u)),u*o<0&&(f+=u)),this._evaluationZoom=f;const m=c.getExaggeration(f),g=m===c.getExaggeration(Math.max(0,f-.1));if(g&&Math.abs(m-this._exaggeration)<.01)return m;let y=Math.min(.1,.00375*(this._updateTimestamp-d));return(g||m<.1||Math.abs(u)<1e-4)&&(y=Math.min(.2,4*y)),le(this._exaggeration,m,y)}resetTileLookupCache(t){this._findCoveringTileCache[t]={}}getScaledDemTileSize(){return this.sourceCache.getSource().tileSize/128*this.proxySourceCache.getSource().tileSize}_onStyleDataEvent(t){t.coord&&"source"===t.dataType?this._clearRenderCacheForTile(t.sourceCacheId,t.coord):"style"===t.dataType&&(this.invalidateRenderCache=!0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this._previousCameraAltitude=void 0)}_disable(){if(this.enabled&&(this.enabled=!1,this._sharedDepthStencil=void 0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this.proxySourceCache.deallocRenderCache(),this._style))for(const t in this._style._mergedSourceCaches)this._style._mergedSourceCaches[t].usedForTerrain=!1}destroy(){this._disable(),this._emptyDEMTexture&&this._emptyDEMTexture.destroy(),this._emptyDepthBufferTexture&&this._emptyDepthBufferTexture.destroy(),this.pool.forEach(t=>t.fb.destroy()),this.pool=[],this._depthFBO&&(this._depthFBO.destroy(),this._depthFBO=void 0,this._depthTexture=void 0),this.framebufferCopyTexture&&this.framebufferCopyTexture.destroy()}_source(){return this.enabled?this.sourceCache:null}isUsingMockSource(){return this.sourceCache===this._mockSourceCache}exaggeration(){return this._exaggeration}get visibleDemTiles(){return this._visibleDemTiles}get drapeBufferSize(){const t=2*this.proxySourceCache.getSource().tileSize;return[t,t]}set useVertexMorphing(t){this._useVertexMorphing=t}updateTileBinding(t){if(!this.enabled)return;this.prevTerrainTileForTile=this.terrainTileForTile;const n=this.proxySourceCache,r=this.painter.transform;this._initializing&&(this._initializing=0===r._centerAltitude&&-1===this.getAtPointOrZero(Qe.fromLngLat(r.center),-1),this._emptyDEMTextureDirty=!this._initializing);const o=this.proxyCoords=n.getIds().map(d=>{const f=n.getTileByID(d).tileID;return f.projMatrix=r.calculateProjMatrix(f.toUnwrapped()),f});!function(d,f){const m=f.transform.pointCoordinate(f.transform.getCameraPoint()),g=new it(m.x,m.y);d.sort((y,v)=>{if(v.overscaledZ-y.overscaledZ)return v.overscaledZ-y.overscaledZ;const x=new it(y.canonical.x+(1<<y.canonical.z)*y.wrap,y.canonical.y),w=new it(v.canonical.x+(1<<v.canonical.z)*v.wrap,v.canonical.y),E=g.mult(1<<y.canonical.z);return E.x-=.5,E.y-=.5,E.distSqr(x)-E.distSqr(w)})}(o,this.painter);const s=this.proxyToSource||{};this.proxyToSource={},o.forEach(d=>{this.proxyToSource[d.key]={}}),this.terrainTileForTile={};const c=this._style._mergedSourceCaches;for(const d in c){const f=c[d];if(!f.used||(f!==this.sourceCache&&this.resetTileLookupCache(f.id),this._setupProxiedCoordsForOrtho(f,t[d],s),f.usedForTerrain))continue;const m=t[d];f.getSource().reparseOverscaled&&this._assignTerrainTiles(m)}this.proxiedCoords[n.id]=o.map(d=>new bv(d,d.key,this.orthoMatrix)),this._assignTerrainTiles(o),this._prepareDEMTextures(),this._setupDrapedRenderBatches(),this._initFBOPool(),this._setupRenderCache(s),this.renderingToTexture=!1;const u={};this._visibleDemTiles=[];for(const d of this.proxyCoords){const f=this.terrainTileForTile[d.key];if(!f)continue;const m=f.tileID.key;m in u||(this._visibleDemTiles.push(f),u[m]=m)}}_assignTerrainTiles(t){this._initializing||t.forEach(n=>{if(this.terrainTileForTile[n.key])return;const r=this._findTileCoveringTileID(n,this.sourceCache);r&&(this.terrainTileForTile[n.key]=r)})}_prepareDEMTextures(){const t=this.painter.context,n=t.gl;for(const r in this.terrainTileForTile){const o=this.terrainTileForTile[r],s=o.dem;!s||o.demTexture&&!o.needsDEMTextureUpload||(t.activeTexture.set(n.TEXTURE1),pE(this.painter,o,s))}}_prepareDemTileUniforms(t,n,r,o){if(!n||null==n.demTexture)return!1;const s=t.tileID.canonical,c=Math.pow(2,n.tileID.canonical.z-s.z),u=o||"";return r[`u_dem_tl${u}`]=[s.x*c%1,s.y*c%1],r[`u_dem_scale${u}`]=c,!0}get emptyDEMTexture(){return!this._emptyDEMTextureDirty&&this._emptyDEMTexture?this._emptyDEMTexture:this._updateEmptyDEMTexture()}get emptyDepthBufferTexture(){const t=this.painter.context,n=t.gl;if(!this._emptyDepthBufferTexture){const r=new $r({width:1,height:1},Uint8Array.of(255,255,255,255));this._emptyDepthBufferTexture=new hr(t,r,n.RGBA,{premultiply:!1})}return this._emptyDepthBufferTexture}_getLoadedAreaMinimum(){let t=0;const n=this._visibleDemTiles.reduce((r,o)=>{if(!o.dem)return r;const s=o.dem.tree.minimums[0];return s>0&&t++,r+s},0);return t?n/t:0}_updateEmptyDEMTexture(){const t=this.painter.context,n=t.gl;t.activeTexture.set(n.TEXTURE2);const r=this._getLoadedAreaMinimum(),[o,s]=(()=>{const u=new FM({width:1,height:1},new Float32Array([r]));return[n.R32F,u]})();this._emptyDEMTextureDirty=!1;let c=this._emptyDEMTexture;return c?c.update(s,{premultiply:!1}):c=this._emptyDEMTexture=new hr(t,s,o,{premultiply:!1}),c}setupElevationDraw(t,n,r){const o=this.painter.context,s=o.gl,c={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_exaggeration:0};c.u_exaggeration=this.exaggeration();let u=null,d=null,f=1;if(r&&r.morphing&&this._useVertexMorphing){const y=r.morphing.srcDemTile,v=r.morphing.dstDemTile;f=r.morphing.phase,y&&v&&(this._prepareDemTileUniforms(t,y,c,"_prev")&&(d=y),this._prepareDemTileUniforms(t,v,c)&&(u=v))}const m=y=>y&&y.demTexture&&this.painter.linearFloatFilteringSupported()?s.LINEAR:s.NEAREST,g=y=>{c.u_dem_size=1===y.size[0]?1:y.size[0]-2};if(d&&u)o.activeTexture.set(s.TEXTURE2),u.demTexture.bind(m(u),s.CLAMP_TO_EDGE),o.activeTexture.set(s.TEXTURE4),d.demTexture.bind(m(d),s.CLAMP_TO_EDGE),u.demTexture&&g(u.demTexture),c.u_dem_lerp=f;else{u=this.terrainTileForTile[t.tileID.key],o.activeTexture.set(s.TEXTURE2);const y=this._prepareDemTileUniforms(t,u,c)?u.demTexture:this.emptyDEMTexture;y.bind(m(u),s.CLAMP_TO_EDGE),g(y)}if(o.activeTexture.set(s.TEXTURE3),r&&r.useDepthForOcclusion?(this._depthTexture&&this._depthTexture.bind(s.NEAREST,s.CLAMP_TO_EDGE),this._depthFBO&&(c.u_depth_size_inv=[1/this._depthFBO.width,1/this._depthFBO.height])):(this.emptyDepthBufferTexture.bind(s.NEAREST,s.CLAMP_TO_EDGE),c.u_depth_size_inv=[1,1]),r&&r.useMeterToDem&&u){const y=(1<<u.tileID.canonical.z)*Ln(1,this.painter.transform.center.lat)*this.sourceCache.getSource().tileSize;c.u_meter_to_dem=y}if(r&&r.labelPlaneMatrixInv&&(c.u_label_plane_matrix_inv=r.labelPlaneMatrixInv),n.setTerrainUniformValues(o,c),"globe"===this.painter.transform.projection.name){const y=this.globeUniformValues(this.painter.transform,t.tileID.canonical,r&&r.useDenormalizedUpVectorScale);n.setGlobeUniformValues(o,y)}}globeUniformValues(t,n,r){const o=t.projection;return{u_tile_tl_up:o.upVector(n,0,0),u_tile_tr_up:o.upVector(n,et,0),u_tile_br_up:o.upVector(n,et,et),u_tile_bl_up:o.upVector(n,0,et),u_tile_up_scale:r?Bf(1):o.upVectorScale(n,t.center.lat,t.worldSize).metersToTile}}renderToBackBuffer(t){const n=this.painter,r=this.painter.context;0!==t.length&&(r.bindFramebuffer.set(null),r.viewport.set([0,0,n.width,n.height]),n.gpuTimingDeferredRenderStart(),this.renderingToTexture=!1,function(o,s,c,u,d){if("globe"===o.transform.projection.name)!function(f,m,g,y,v){const x=f.context,w=x.gl;let E,M;const D=f.transform,A=jh(f,x,D),P=(W,V)=>{if(M===V)return;const K=[vE[V],"PROJECTION_GLOBE_VIEW"];A&&K.push("CUSTOM_ANTIALIASING");const Q=f.isTileAffectedByFog(W);E=f.getOrCreateProgram("globeRaster",{defines:K,overrideFog:Q}),M=V},C=f.colorModeForRenderPass(),R=new be(w.LEQUAL,be.ReadWrite,f.depthRangeFor3D);Fd.update(v);const k=F1(D),N=[Br(D.center.lng),ui(D.center.lat)],z=f.globeSharedBuffers,B=[D.width*De.devicePixelRatio,D.height*De.devicePixelRatio],U=Float32Array.from(D.globeMatrix),$={useDenormalizedUpVectorScale:!0};{const W=f.transform,V=xE(W.zoom,m.exaggeration(),m.sourceCache._source.tileSize);M=-1;const K=w.TRIANGLES;for(const Q of y){const ot=g.getTile(Q),Y=$e.disabled,J=m.prevTerrainTileForTile[Q.key],ct=m.terrainTileForTile[Q.key];yE(J,ct)&&Fd.newMorphing(Q.key,J,ct,v,250),x.activeTexture.set(w.TEXTURE0),ot.texture&&ot.texture.bind(w.LINEAR,w.CLAMP_TO_EDGE);const dt=Fd.getMorphValuesForProxy(Q.key),ht=dt?1:0;dt&&lr($,{morphing:{srcDemTile:dt.from,dstDemTile:dt.to,phase:ls(dt.phase)}});const _t=la(Q.canonical),vt=N1(_t.getCenter().lat),xt=dy(Q.canonical,_t,vt,W.worldSize/W._pixelsPerMercatorPixel),mt=mu(bs(Q.canonical)),Ct=_E(W.expandedFarZProjMatrix,U,k,mt,ri(W.zoom),N,W.frustumCorners.TL,W.frustumCorners.TR,W.frustumCorners.BR,W.frustumCorners.BL,W.globeCenterInViewSpace,W.globeRadius,B,V,xt);if(P(Q,ht),E&&(m.setupElevationDraw(ot,E,$),f.uploadCommonUniforms(x,E,Q.toUnwrapped()),z)){const[Ut,Gt,Yt]=z.getGridBuffers(vt,0!==V);E.draw(f,K,R,Y,C,Ge.backCCW,Ct,"globe_raster",Ut,Gt,Yt)}}}if(z&&(f.renderDefaultNorthPole||f.renderDefaultSouthPole)){const W=["GLOBE_POLES","PROJECTION_GLOBE_VIEW"];A&&W.push("CUSTOM_ANTIALIASING"),E=f.getOrCreateProgram("globeRaster",{defines:W});for(const V of y){const{x:K,y:Q,z:ot}=V.canonical,Y=0===Q,J=Q===(1<<ot)-1,[ct,dt,ht,_t]=z.getPoleBuffers(ot,!1);if(_t&&(Y||J)){const vt=g.getTile(V);x.activeTexture.set(w.TEXTURE0),vt.texture&&vt.texture.bind(w.LINEAR,w.CLAMP_TO_EDGE);let xt=Va(ot,K,D);const mt=mu(bs(V.canonical)),Ct=(Ut,Gt)=>Ut.draw(f,w.TRIANGLES,R,$e.disabled,C,Ge.disabled,_E(D.expandedFarZProjMatrix,xt,xt,mt,0,N,D.frustumCorners.TL,D.frustumCorners.TR,D.frustumCorners.BR,D.frustumCorners.BL,D.globeCenterInViewSpace,D.globeRadius,B,0),"globe_pole_raster",Gt,ht,_t);m.setupElevationDraw(vt,E,$),f.uploadCommonUniforms(x,E,V.toUnwrapped()),Y&&f.renderDefaultNorthPole&&Ct(E,ct),J&&f.renderDefaultSouthPole&&(xt=st.scale(st.create(),xt,[1,-1,1]),Ct(E,dt))}}}}(o,s,c,u,d);else{const f=o.context,m=f.gl;let g,y;const v=o.shadowRenderer,x=kd(o,o.longestCutoffRange),w=C=>{if(y===C)return;const R=[];R.push(vE[C]),x.shouldRenderCutoff&&R.push("RENDER_CUTOFF"),g=o.getOrCreateProgram("terrainRaster",{defines:R}),y=C},E=o.colorModeForRenderPass(),M=new be(m.LEQUAL,be.ReadWrite,o.depthRangeFor3D);Fd.update(d);const D=o.transform,A=xE(D.zoom,s.exaggeration(),s.sourceCache._source.tileSize);let P=[0,0,0];if(v){const C=o.style.directionalLight,R=o.style.ambientLight;C&&R&&(P=HE(C,R))}{y=-1;const C=m.TRIANGLES,[R,k]=[s.gridIndexBuffer,s.gridSegments];for(const N of u){const z=c.getTile(N),B=$e.disabled,U=s.prevTerrainTileForTile[N.key],$=s.terrainTileForTile[N.key];yE(U,$)&&Fd.newMorphing(N.key,U,$,d,250),f.activeTexture.set(m.TEXTURE0),z.texture&&z.texture.bind(m.LINEAR,m.CLAMP_TO_EDGE);const W=Fd.getMorphValuesForProxy(N.key),V=W?1:0;let K;W&&(K={morphing:{srcDemTile:W.from,dstDemTile:W.to,phase:ls(W.phase)}});const Q=gE(N.projMatrix,ND(N.canonical,D.renderWorldCopies)?A/10:A,P);if(w(V),!g)continue;s.setupElevationDraw(z,g,K);const ot=N.toUnwrapped();v&&v.setupShadows(ot,g),o.uploadCommonUniforms(f,g,ot,null,x),g.draw(o,C,M,B,E,Ge.backCCW,Q,"terrain_raster",s.gridBuffer,R,k)}}}}(n,this,this.proxySourceCache,t,this._updateTimestamp),this.renderingToTexture=!0,n.gpuTimingDeferredRenderEnd(),t.splice(0,t.length))}renderBatch(t){if(0===this._drapedRenderBatches.length)return t+1;this.renderingToTexture=!0;const n=this.painter,r=this.painter.context,o=this.proxySourceCache,s=this.proxiedCoords[o.id],c=this._drapedRenderBatches.shift(),u=n.style.order,d=[];let f=0;for(const m of s){const g=o.getTileByID(m.proxyTileKey),y=o.proxyCachedFBO[m.key]?o.proxyCachedFBO[m.key][t]:void 0,v=void 0!==y?o.renderCache[y]:this.pool[f++],x=void 0!==y;if(g.texture=v.tex,x&&!v.dirty){d.push(g.tileID);continue}let w;r.bindFramebuffer.set(v.fb.framebuffer),this.renderedToTile=!1,v.dirty&&(r.clear({color:ke.transparent,stencil:0}),v.dirty=!1);for(let E=c.start;E<=c.end;++E){const M=n.style._mergedLayers[u[E]];if(M.isHidden(n.transform.zoom))continue;const D=n.style.getLayerSourceCache(M),A=D?this.proxyToSource[m.key][D.id]:[m];if(!A)continue;const P=A;r.viewport.set([0,0,v.fb.width,v.fb.height]),w!==(D?D.id:null)&&(this._setupStencil(v,A,M,D),w=D?D.id:null),n.renderLayer(n,D,M,P)}if(0===this._drapedRenderBatches.length)for(const E of this._pendingGroundEffectLayers){const M=n.style._mergedLayers[u[E]];if(M.isHidden(n.transform.zoom))continue;const D=n.style.getLayerSourceCache(M),A=D?this.proxyToSource[m.key][D.id]:[m];if(!A)continue;const P=A;r.viewport.set([0,0,v.fb.width,v.fb.height]),w!==(D?D.id:null)&&(this._setupStencil(v,A,M,D),w=D?D.id:null),n.renderLayer(n,D,M,P)}this.renderedToTile?(v.dirty=!0,d.push(g.tileID)):x||--f,5===f&&(f=0,this.renderToBackBuffer(d))}return this.renderToBackBuffer(d),this.renderingToTexture=!1,r.bindFramebuffer.set(null),r.viewport.set([0,0,n.width,n.height]),c.end+1}postRender(){}isLayerOrderingCorrect(t){const n=t.order.length;let r=-1,o=n;for(let s=0;s<n;++s)this._style.isLayerDraped(t._mergedLayers[t.order[s]])?r=Math.max(r,s):o=Math.min(o,s);return o>r}getMinElevationBelowMSL(){let t=0;return this._visibleDemTiles.filter(n=>n.dem).forEach(n=>{t=Math.min(t,n.dem.tree.minimums[0])}),0===t?t:(t-30)*this._exaggeration}raycast(t,n,r){if(!this._visibleDemTiles)return null;const o=this._visibleDemTiles.filter(s=>s.dem).map(s=>{const c=s.tileID,u=1<<c.overscaledZ,{x:d,y:f}=c.canonical,m=d/u,g=(d+1)/u,y=f/u,v=(f+1)/u;return{minx:m,miny:y,maxx:g,maxy:v,t:s.dem.tree.raycastRoot(m,y,g,v,t,n,r),tile:s}});o.sort((s,c)=>(null!==s.t?s.t:Number.MAX_VALUE)-(null!==c.t?c.t:Number.MAX_VALUE));for(const s of o){if(null==s.t)return null;const c=s.tile.dem.tree.raycast(s.minx,s.miny,s.maxx,s.maxy,t,n,r);if(null!=c)return c}return null}_createFBO(){const t=this.painter.context,n=t.gl,r=this.drapeBufferSize;t.activeTexture.set(n.TEXTURE0);const o=new hr(t,{width:r[0],height:r[1],data:null},n.RGBA);o.bind(n.LINEAR,n.CLAMP_TO_EDGE);const s=t.createFramebuffer(r[0],r[1],!0,null);return s.colorAttachment.set(o.texture),s.depthAttachment=new RI(t,s.framebuffer),void 0===this._sharedDepthStencil?(this._sharedDepthStencil=t.createRenderbuffer(t.gl.DEPTH_STENCIL,r[0],r[1]),this._stencilRef=0,s.depthAttachment.set(this._sharedDepthStencil),t.clear({stencil:0})):s.depthAttachment.set(this._sharedDepthStencil),t.extTextureFilterAnisotropic&&n.texParameterf(n.TEXTURE_2D,t.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,t.extTextureFilterAnisotropicMax),{fb:s,tex:o,dirty:!1}}_initFBOPool(){for(;this.pool.length<Math.min(5,this.proxyCoords.length);)this.pool.push(this._createFBO())}_shouldDisableRenderCache(){if(this._style.hasLightTransitions())return!0;for(const t in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[t].hasTransition())return!0;return this._style.order.some(t=>{const n=this._style._mergedLayers[t],r=n.isHidden(this.painter.transform.zoom);return"custom"===n.type?!r&&n.shouldRedrape():!r&&n.hasTransition()})}_clearLineLayersFromRenderCache(){let t=!1;for(const r of this._style.getSources())if(r instanceof Z0){t=!0;break}if(!t)return;const n={};for(let r=0;r<this._style.order.length;++r){const o=this._style._mergedLayers[this._style.order[r]],s=this._style.getLayerSourceCache(o);if(s&&!n[s.id]&&!o.isHidden(this.painter.transform.zoom)&&"line"===o.type&&o.widthExpression()instanceof vl){n[s.id]=!0;for(const c of this.proxyCoords){const u=this.proxyToSource[c.key][s.id];if(u)for(const d of u)this._clearRenderCacheForTile(s.id,d)}}}}_clearRasterLayersFromRenderCache(){let t=!1;for(const r in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[r]._source instanceof Pg){t=!0;break}if(!t)return;const n={};for(let r=0;r<this._style.order.length;++r){const o=this._style._mergedLayers[this._style.order[r]],s=this._style.getLayerSourceCache(o);if(!s||n[s.id]||o.isHidden(this.painter.transform.zoom)||"raster"!==o.type)continue;const c=o.paint.get("raster-fade-duration");for(const u of this.proxyCoords){const d=this.proxyToSource[u.key][s.id];if(d)for(const f of d){const m=Nd(s.getTile(f),s.findLoadedParent(f,0),s,this.painter.transform,c);(1!==m.opacity||0!==m.mix)&&this._clearRenderCacheForTile(s.id,f)}}}}_setupDrapedRenderBatches(){const t=this._style.order,n=t.length;if(0===n)return;const r=[];this._pendingGroundEffectLayers=[];let o,s=0,c=this._style._mergedLayers[t[s]];for(;!this._style.isLayerDraped(c)&&c.isHidden(this.painter.transform.zoom)&&++s<n;)c=this._style._mergedLayers[t[s]];for(;s<n;++s){const u=this._style._mergedLayers[t[s]];u.isHidden(this.painter.transform.zoom)||(this._style.isLayerDraped(u)?void 0===o&&(o=s):("fill-extrusion"===u.type&&this._pendingGroundEffectLayers.push(s),void 0!==o&&(r.push({start:o,end:s-1}),o=void 0)))}if(void 0!==o&&r.push({start:o,end:s-1}),0!==r.length){const u=r[r.length-1];this._pendingGroundEffectLayers.every(f=>f>u.end)||nt("fill-extrusion with flood lighting and/or ground ambient occlusion should be moved to be on top of all draped layers.")}this._drapedRenderBatches=r}_setupRenderCache(t){const n=this.proxySourceCache;if(this._shouldDisableRenderCache()||this.invalidateRenderCache){if(this.invalidateRenderCache=!1,n.renderCache.length>n.renderCachePool.length){const c=Object.values(n.proxyCachedFBO);n.proxyCachedFBO={};for(let u=0;u<c.length;++u){const d=Object.values(c[u]);n.renderCachePool.push(...d)}}return}this._clearRasterLayersFromRenderCache();const r=this.proxyCoords,o=this._tilesDirty;for(let c=r.length-1;c>=0;c--){const u=r[c];if(n.getTileByID(u.key),void 0!==n.proxyCachedFBO[u.key]){const d=t[u.key],f=this.proxyToSource[u.key];let m=0;for(const g in f){const y=f[g],v=d[g];if(!v||v.length!==y.length||y.some((x,w)=>x!==v[w]||o[g]&&o[g].hasOwnProperty(x.key))){m=-1;break}++m}for(const g in n.proxyCachedFBO[u.key])n.renderCache[n.proxyCachedFBO[u.key][g]].dirty=m<0||m!==Object.values(d).length}}const s=[...this._drapedRenderBatches];s.sort((c,u)=>u.end-u.start-(c.end-c.start));for(const c of s)for(const u of r){if(n.proxyCachedFBO[u.key])continue;let d=n.renderCachePool.pop();void 0===d&&n.renderCache.length<50&&(d=n.renderCache.length,n.renderCache.push(this._createFBO())),void 0!==d&&(n.proxyCachedFBO[u.key]={},n.proxyCachedFBO[u.key][c.start]=d,n.renderCache[d].dirty=!0)}this._tilesDirty={}}_setupStencil(t,n,r,o){if(!o||!this._sourceTilesOverlap[o.id])return void(this._overlapStencilType&&(this._overlapStencilType=!1));const s=this.painter.context,c=s.gl;if(n.length<=1)return void(this._overlapStencilType=!1);let u;if(r.isTileClipped())u=n.length,this._overlapStencilMode.test={func:c.EQUAL,mask:255},this._overlapStencilType="Clip";else{if(!(n[0].overscaledZ>n[n.length-1].overscaledZ))return void(this._overlapStencilType=!1);u=1,this._overlapStencilMode.test={func:c.GREATER,mask:255},this._overlapStencilType="Mask"}this._stencilRef+u>255&&(s.clear({stencil:0}),this._stencilRef=0),this._stencilRef+=u,this._overlapStencilMode.ref=this._stencilRef,r.isTileClipped()&&this._renderTileClippingMasks(n,this._overlapStencilMode.ref)}clipOrMaskOverlapStencilType(){return"Clip"===this._overlapStencilType||"Mask"===this._overlapStencilType}stencilModeForRTTOverlap(t){return this.renderingToTexture&&this._overlapStencilType?("Clip"===this._overlapStencilType&&(this._overlapStencilMode.ref=this.painter._tileClippingMaskIDs[t.key]),this._overlapStencilMode):$e.disabled}_renderTileClippingMasks(t,n){const r=this.painter,o=this.painter.context,s=o.gl;r._tileClippingMaskIDs={},o.setColorMode(hn.disabled),o.setDepthMode(be.disabled);const c=r.getOrCreateProgram("clippingMask");for(const u of t){const d=r._tileClippingMaskIDs[u.key]=--n;c.draw(r,s.TRIANGLES,be.disabled,new $e({func:s.ALWAYS,mask:0},d,255,s.KEEP,s.KEEP,s.REPLACE),hn.disabled,Ge.disabled,xv(u.projMatrix),"$clipping",r.tileExtentBuffer,r.quadTriangleIndexBuffer,r.tileExtentSegments)}}pointCoordinate(t){const n=this.painter.transform;if(t.x<0||t.x>n.width||t.y<0||t.y>n.height)return null;const r=[t.x,t.y,1,1];En.transformMat4(r,r,n.pixelMatrixInverse),En.scale(r,r,1/r[3]),r[0]/=n.worldSize,r[1]/=n.worldSize;const o=n._camera.position,s=Ln(1,n.center.lat),c=[o[0],o[1],o[2]/s,0],u=Z.subtract([],r.slice(0,3),c);Z.normalize(u,u);const d=this.raycast(c,u,this._exaggeration);return null!==d&&d?(Z.scaleAndAdd(c,c,u,d),c[3]=c[2],c[2]*=s,c):null}drawDepth(){const t=this.painter,n=t.context,r=this.proxySourceCache,o=Math.ceil(t.width),s=Math.ceil(t.height);if(!this._depthFBO||this._depthFBO.width===o&&this._depthFBO.height===s||(this._depthFBO.destroy(),this._depthFBO=void 0,this._depthTexture=void 0),!this._depthFBO){const c=n.gl,u=n.createFramebuffer(o,s,!0,"renderbuffer");n.activeTexture.set(c.TEXTURE0);const d=new hr(n,{width:o,height:s,data:null},c.RGBA);d.bind(c.NEAREST,c.CLAMP_TO_EDGE),u.colorAttachment.set(d.texture);const f=n.createRenderbuffer(n.gl.DEPTH_COMPONENT16,o,s);u.depthAttachment.set(f),this._depthFBO=u,this._depthTexture=d}n.bindFramebuffer.set(this._depthFBO.framebuffer),n.viewport.set([0,0,o,s]),function(c,u,d,f){if("globe"===c.transform.projection.name)return;const m=c.context,g=m.gl;m.clear({depth:1});const y=c.getOrCreateProgram("terrainDepth"),v=new be(g.LESS,be.ReadWrite,c.depthRangeFor3D);for(const x of f){const w=d.getTile(x),E=gE(x.projMatrix,0,[0,0,0]);u.setupElevationDraw(w,y),y.draw(c,g.TRIANGLES,v,$e.disabled,hn.unblended,Ge.backCCW,E,"terrain_depth",u.gridBuffer,u.gridIndexBuffer,u.gridNoSkirtSegments)}}(t,this,r,this.proxyCoords)}_setupProxiedCoordsForOrtho(t,n,r){if(t.getSource()instanceof $s)return this._setupProxiedCoordsForImageSource(t,n,r);this._findCoveringTileCache[t.id]=this._findCoveringTileCache[t.id]||{};const o=this.proxiedCoords[t.id]=[],s=this.proxyCoords;for(let u=0;u<s.length;u++){const d=s[u],f=this._findTileCoveringTileID(d,t);if(f){const m=this._createProxiedId(d,f,r[d.key]&&r[d.key][t.id]);o.push(m),this.proxyToSource[d.key][t.id]=[m]}}let c=!1;for(let u=0;u<n.length;u++){const d=t.getTile(n[u]);if(!d||!d.hasData())continue;const f=this._findTileCoveringTileID(d.tileID,this.proxySourceCache);if(f&&f.tileID.canonical.z!==d.tileID.canonical.z){const m=this.proxyToSource[f.tileID.key][t.id],g=this._createProxiedId(f.tileID,d,r[f.tileID.key]&&r[f.tileID.key][t.id]);m?m.splice(m.length-1,0,g):this.proxyToSource[f.tileID.key][t.id]=[g],o.push(g),c=!0}}this._sourceTilesOverlap[t.id]=c}_setupProxiedCoordsForImageSource(t,n,r){if(!t.getSource().loaded())return;const o=this.proxiedCoords[t.id]=[],s=this.proxyCoords,c=t.getSource(),u=c.tileID;if(!u)return;const d=new it(u.x,u.y)._div(1<<u.z),f=c.coordinates.map(Qe.fromLngLat).reduce((g,y)=>(g.min.x=Math.min(g.min.x,y.x-d.x),g.min.y=Math.min(g.min.y,y.y-d.y),g.max.x=Math.max(g.max.x,y.x-d.x),g.max.y=Math.max(g.max.y,y.y-d.y),g),{min:new it(Number.MAX_VALUE,Number.MAX_VALUE),max:new it(-Number.MAX_VALUE,-Number.MAX_VALUE)}),m=(g,y)=>{const v=g.wrap+g.canonical.x/(1<<g.canonical.z),x=g.canonical.y/(1<<g.canonical.z),w=et/(1<<g.canonical.z),E=y.wrap+y.canonical.x/(1<<y.canonical.z),M=y.canonical.y/(1<<y.canonical.z);return v+w<E+f.min.x||v>E+f.max.x||x+w<M+f.min.y||x>M+f.max.y};for(let g=0;g<s.length;g++){const y=s[g];for(let v=0;v<n.length;v++){const x=t.getTile(n[v]);if(!x||!x.hasData()||m(y,x.tileID))continue;const w=this._createProxiedId(y,x,r[y.key]&&r[y.key][t.id]),E=this.proxyToSource[y.key][t.id];E?E.push(w):this.proxyToSource[y.key][t.id]=[w],o.push(w)}}}_createProxiedId(t,n,r){let o=this.orthoMatrix;if(r){const s=r.find(c=>c.key===n.tileID.key);if(s)return s}if(n.tileID.key!==t.key){const s=t.canonical.z-n.tileID.canonical.z;let c,u,d;o=st.create();const f=n.tileID.wrap-t.wrap<<t.overscaledZ;s>0?(c=et>>s,u=c*((n.tileID.canonical.x<<s)-t.canonical.x+f),d=c*((n.tileID.canonical.y<<s)-t.canonical.y)):(c=et<<-s,u=et*(n.tileID.canonical.x-(t.canonical.x+f<<-s)),d=et*(n.tileID.canonical.y-(t.canonical.y<<-s))),st.ortho(o,0,c,0,c,0,1),st.translate(o,o,[u,d,0])}return new bv(n.tileID,t.key,o)}_findTileCoveringTileID(t,n){let r=n.getTile(t);if(r&&r.hasData())return r;const o=this._findCoveringTileCache[n.id],s=o[t.key];if(r=s?n.getTileByID(s):null,r&&r.hasData()||null===s)return r;let c=r?r.tileID:t,u=c.overscaledZ;const d=n.getSource().minzoom,f=[];if(!s){const g=n.getSource().maxzoom;if(t.canonical.z>=g){const y=t.canonical.z-g;n.getSource().reparseOverscaled?(u=Math.max(t.canonical.z+2,n.transform.tileZoom),c=new nn(u,t.wrap,g,t.canonical.x>>y,t.canonical.y>>y)):0!==y&&(u=g,c=new nn(u,t.wrap,g,t.canonical.x>>y,t.canonical.y>>y))}c.key!==t.key&&(f.push(c.key),r=n.getTile(c))}const m=g=>{f.forEach(y=>{o[y]=g}),f.length=0};for(u-=1;u>=d&&(!r||!r.hasData());u--){r&&m(r.tileID.key);const g=c.calculateScaledKey(u);if(r=n.getTileByID(g),r&&r.hasData())break;const y=o[g];if(null===y)break;void 0===y?f.push(g):r=n.getTileByID(y)}return m(r?r.tileID.key:null),r&&r.hasData()?r:null}findDEMTileFor(t){return this.enabled?this._findTileCoveringTileID(t,this.sourceCache):null}prepareDrawTile(){this.renderedToTile=!0}_clearRenderCacheForTile(t,n){let r=this._tilesDirty[t];r||(r=this._tilesDirty[t]={}),r[n.key]=!0}}function TE(e,t,n){const r=function(u,d,f){const m=Z.dot(d,u),g=Z.dot(f,[.2126,.7152,.0722]),y=(x,w,E)=>(1-E)*x+E*w,v=y(1-.3*Math.min(g,1),1,Math.min(m+1,1));return y(.92,1,Math.asin(ne(d[2],-1,1))/Math.PI+.5)*v}(e,[0,0,1],t),o=[0,0,0];Z.scale(o,n.slice(0,3),r);const s=[0,0,0];Z.scale(s,t.slice(0,3),e[2]);const c=[0,0,0];return Z.add(c,o,s),Fn(c)}const zD=["fill","fillOutline","fillPattern","line","linePattern","background","backgroundPattern","hillshade","raster"],BD=["stars","fillExtrusion","fillExtrusionGroundEffect","model","symbolSDF","symbolIcon","symbolTextAndIcon"];class jD{static cacheKey(t,n,r,o){let s=`${n}${o?o.cacheKey:""}`;for(const c of r)t.usedDefines.includes(c)&&(s+=`/${c}`);return s}constructor(t,n,r,o,s,c){const u=t.gl;this.program=u.createProgram(),this.configuration=o,this.name=n,this.fixedDefines=[...c];const d=o?o.getBinderAttributes():[],f=(r.staticAttributes||[]).concat(d);let m=o?o.defines():[];m=m.concat(c.map(E=>`#define ${E}`));const g="#version 300 es\n";let y=g+m.concat("precision mediump float;",fE,dE.fragmentSource).join("\n");for(const E of r.fragmentIncludes)y+=`\n${Vg[E]}`;y+=`\n${r.fragmentSource}`;let v=g+m.concat("precision highp float;",fE,dE.vertexSource).join("\n");for(const E of r.vertexIncludes)v+=`\n${Vg[E]}`;v+=`\n${r.vertexSource}`;const x=u.createShader(u.FRAGMENT_SHADER);if(u.isContextLost())return void(this.failedToCreate=!0);u.shaderSource(x,y),u.compileShader(x),u.attachShader(this.program,x);const w=u.createShader(u.VERTEX_SHADER);if(u.isContextLost())this.failedToCreate=!0;else{u.shaderSource(w,v),u.compileShader(w),u.attachShader(this.program,w),this.attributes={},this.numAttributes=f.length;for(let E=0;E<this.numAttributes;E++)if(f[E]){const M=f[E].startsWith("a_")?f[E]:`a_${f[E]}`;u.bindAttribLocation(this.program,E,M),this.attributes[M]=E}u.linkProgram(this.program),u.deleteShader(w),u.deleteShader(x),this.fixedUniforms=s(t),this.binderUniforms=o?o.getUniforms(t):[],c.includes("TERRAIN")&&(this.terrainUniforms={u_dem:new Ze(E=t),u_dem_prev:new Ze(E),u_dem_tl:new Ve(E),u_dem_scale:new Rt(E),u_dem_tl_prev:new Ve(E),u_dem_scale_prev:new Rt(E),u_dem_size:new Rt(E),u_dem_lerp:new Rt(E),u_exaggeration:new Rt(E),u_depth:new Ze(E),u_depth_size_inv:new Ve(E),u_meter_to_dem:new Rt(E),u_label_plane_matrix_inv:new Re(E)}),c.includes("GLOBE")&&(this.globeUniforms=(E=>({u_tile_tl_up:new Ae(E),u_tile_tr_up:new Ae(E),u_tile_br_up:new Ae(E),u_tile_bl_up:new Ae(E),u_tile_up_scale:new Rt(E)}))(t)),c.includes("FOG")&&(this.fogUniforms=(E=>({u_fog_matrix:new Re(E),u_fog_range:new Ve(E),u_fog_color:new Ri(E),u_fog_horizon_blend:new Rt(E),u_fog_vertical_limit:new Ve(E),u_fog_temporal_offset:new Rt(E),u_frustum_tl:new Ae(E),u_frustum_tr:new Ae(E),u_frustum_br:new Ae(E),u_frustum_bl:new Ae(E),u_globe_pos:new Ae(E),u_globe_radius:new Rt(E),u_globe_transition:new Rt(E),u_is_globe:new Ze(E),u_viewport:new Ve(E)}))(t)),c.includes("RENDER_CUTOFF")&&(this.cutoffUniforms=(E=>({u_cutoff_params:new Ri(E)}))(t)),c.includes("LIGHTING_3D_MODE")&&(this.lightsUniforms=(E=>({u_lighting_ambient_color:new Ae(E),u_lighting_directional_dir:new Ae(E),u_lighting_directional_color:new Ae(E),u_ground_radiance:new Ae(E)}))(t)),c.includes("RENDER_SHADOWS")&&(this.shadowUniforms=(E=>({u_light_matrix_0:new Re(E),u_light_matrix_1:new Re(E),u_fade_range:new Ve(E),u_shadow_normal_offset:new Ae(E),u_shadow_intensity:new Rt(E),u_shadow_texel_size:new Rt(E),u_shadow_map_resolution:new Rt(E),u_shadow_direction:new Ae(E),u_shadow_bias:new Ae(E),u_shadowmap_0:new Ze(E),u_shadowmap_1:new Ze(E)}))(t))}var E}setTerrainUniformValues(t,n){if(!this.terrainUniforms)return;const r=this.terrainUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const o in n)r[o]&&r[o].set(this.program,o,n[o])}}setGlobeUniformValues(t,n){if(!this.globeUniforms)return;const r=this.globeUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const o in n)r[o]&&r[o].set(this.program,o,n[o])}}setFogUniformValues(t,n){if(!this.fogUniforms)return;const r=this.fogUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const o in n)r[o].set(this.program,o,n[o])}}setCutoffUniformValues(t,n){if(!this.cutoffUniforms)return;const r=this.cutoffUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const o in n)r[o].set(this.program,o,n[o])}}setLightsUniformValues(t,n){if(!this.lightsUniforms)return;const r=this.lightsUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const o in n)r[o].set(this.program,o,n[o])}}setShadowUniformValues(t,n){if(this.failedToCreate||!this.shadowUniforms)return;const r=this.shadowUniforms;t.program.set(this.program);for(const o in n)r[o].set(this.program,o,n[o])}_drawDebugWireframe(t,n,r,o,s,c,u,d,f,m){const g=t.options.wireframe;if(!1===g.terrain&&!1===g.layers2D&&!1===g.layers3D)return;const y=t.context;if(!(()=>!(!g.terrain||"terrainRaster"!==this.name&&"globeRaster"!==this.name)||!(!g.layers2D||t._terrain&&t._terrain.renderingToTexture||!zD.includes(this.name))||!(!g.layers3D||!BD.includes(this.name)))())return;const v=y.gl,x=t.wireframeDebugCache.getLinesFromTrianglesBuffer(t.frameCounter,s,y);if(!x)return;const w=[...this.fixedDefines];w.push("DEBUG_WIREFRAME");const E=t.getOrCreateProgram(this.name,{config:this.configuration,defines:w});y.program.set(E.program);const M=(P,C,R)=>{if(C[P]&&R[P])for(const k in C[P])R[P][k]&&R[P][k].set(R.program,k,C[P][k].current)};f&&f.setUniforms(E.program,y,E.binderUniforms,u,{zoom:d}),M("fixedUniforms",this,E),M("terrainUniforms",this,E),M("globeUniforms",this,E),M("fogUniforms",this,E),M("lightsUniforms",this,E),M("shadowUniforms",this,E),x.bind(),y.setColorMode(new hn([v.ONE,v.ONE_MINUS_SRC_ALPHA,v.ZERO,v.ONE],ke.transparent,[!0,!0,!0,!1])),y.setDepthMode(new be(n.func===v.LESS?v.LEQUAL:n.func,be.ReadOnly,n.range)),y.setStencilMode($e.disabled);const D=3*c.primitiveLength*2,A=3*c.primitiveOffset*2*2;m&&m>1?v.drawElementsInstanced(v.LINES,D,v.UNSIGNED_SHORT,A,m):v.drawElements(v.LINES,D,v.UNSIGNED_SHORT,A),s.bind(),y.program.set(this.program),y.setDepthMode(n),y.setStencilMode(r),y.setColorMode(o)}draw(t,n,r,o,s,c,u,d,f,m,g,y,v,x,w,E){const M=t.context,D=M.gl;if(this.failedToCreate)return;M.program.set(this.program),M.setDepthMode(r),M.setStencilMode(o),M.setColorMode(s),M.setCullFace(c);for(const C of Object.keys(this.fixedUniforms))this.fixedUniforms[C].set(this.program,C,u[C]);x&&x.setUniforms(this.program,M,this.binderUniforms,y,{zoom:v});const A={[D.LINES]:2,[D.TRIANGLES]:3,[D.LINE_STRIP]:1}[n],P=E&&E>0?1:void 0;for(const C of g.get()){const R=C.vaos||(C.vaos={});(R[d]||(R[d]=new OD)).bind(M,this,f,x?x.getPaintVertexBuffers():[],m,C.vertexOffset,w||[],P),E&&E>1?D.drawElementsInstanced(n,C.primitiveLength*A,D.UNSIGNED_SHORT,C.primitiveOffset*A*2,E):D.drawElements(n,C.primitiveLength*A,D.UNSIGNED_SHORT,C.primitiveOffset*A*2),n===D.TRIANGLES&&this._drawDebugWireframe(t,r,o,s,m,C,y,v,x,E)}}}function VD(e,t){const n=Math.pow(2,t.tileID.overscaledZ),r=t.tileSize*Math.pow(2,e.transform.tileZoom)/n,o=r*(t.tileID.canonical.x+t.tileID.wrap*n),s=r*t.tileID.canonical.y;return{u_image:0,u_texsize:t.imageAtlasTexture?t.imageAtlasTexture.size:[0,0],u_tile_units_to_pixels:1/Bu(t,1,e.transform.tileZoom),u_pixel_coord_upper:[o>>16,s>>16],u_pixel_coord_lower:[65535&o,65535&s]}}const UD=st.create(),ME=(e,t,n,r,o,s,c,u,d,f,m,g,y,v,x,w)=>{const E=t.style.light,M=E.properties.get("position"),D=[M.x,M.y,M.z],A=fo.create();"viewport"===E.properties.get("anchor")&&(fo.fromRotation(A,-t.transform.angle),Z.transformMat3(D,D,A));const P=E.properties.get("color"),C=t.transform,R={u_matrix:e,u_lightpos:D,u_lightintensity:E.properties.get("intensity"),u_lightcolor:[P.r,P.g,P.b],u_vertical_gradient:+n,u_opacity:r,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:UD,u_merc_center:[0,0],u_up_dir:[0,0,0],u_height_lift:0,u_ao:o,u_edge_radius:s,u_flood_light_color:g,u_vertical_scale:y,u_flood_light_intensity:v,u_ground_shadow_factor:x,u_emissive_strength:w};return"globe"===C.projection.name&&(R.u_tile_id=[c.canonical.x,c.canonical.y,1<<c.canonical.z],R.u_zoom_transition=d,R.u_inv_rot_matrix=m,R.u_merc_center=f,R.u_up_dir=C.projection.upVector(new xs(0,0,0),f[0]*et,f[1]*et),R.u_height_lift=u),R},GD=(e,t,n)=>({u_matrix:e,u_edge_radius:t,u_vertical_scale:n}),$D=(e,t,n,r,o,s,c,u,d,f,m,g,y,v)=>{const x=ME(e,t,n,r,o,s,c,d,f,m,g,y,v,1,[0,0,0],0),w={u_height_factor:-Math.pow(2,c.overscaledZ)/u.tileSize/8};return Wt(x,VD(t,u),w)},IE=(e,t)=>({u_matrix:e,u_emissive_strength:t}),zd=(e,t,n,r)=>Wt(IE(e,t),VD(n,r)),HD=(e,t,n)=>({u_matrix:e,u_world:n,u_emissive_strength:t}),wv=(e,t,n,r,o)=>Wt(zd(e,t,n,r),{u_world:o}),qD=(e,t,n,r)=>{const o=et/n.tileSize;return{u_matrix:e,u_camera_to_center_distance:t.getCameraToCenterDistance(r),u_extrude_scale:[t.pixelsToGLUnits[0]/o,t.pixelsToGLUnits[1]/o]}},ZD=(e,t,n=1)=>({u_matrix:e,u_color:t,u_overlay:0,u_overlay_scale:n}),WD=st.create(),jC=(e,t,n,r,o,s,c)=>{const u=e.transform,d="globe"===u.projection.name,f=d?O1(u.zoom,t.canonical)*u._pixelsPerMercatorPixel:Bu(n,1,s),m={u_matrix:t.projMatrix,u_extrude_scale:f,u_intensity:c,u_inv_rot_matrix:WD,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0]};if(d){m.u_inv_rot_matrix=r,m.u_merc_center=o,m.u_tile_id=[t.canonical.x,t.canonical.y,1<<t.canonical.z],m.u_zoom_transition=ri(u.zoom);const g=o[0]*et,y=o[1]*et;m.u_up_dir=u.projection.upVector(new xs(0,0,0),g,y)}return m},tl=(e,t,n,r,o,s,c,u,d,f,m,g,y,v,x,w,E,M,D,A,P,C)=>{return{u_matrix:e,u_normalize_matrix:t,u_globe_matrix:n,u_merc_matrix:r,u_grid_matrix:o,u_tl_parent:s,u_scale_parent:m,u_fade_t:g.mix,u_opacity:g.opacity*y.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:y.paint.get("raster-brightness-min"),u_brightness_high:y.paint.get("raster-brightness-max"),u_saturation_factor:(k=y.paint.get("raster-saturation"),k>0?1-1/(1.001-k):-k),u_contrast_factor:(R=y.paint.get("raster-contrast"),R>0?1/(1-R):1+R),u_spin_weights:XD(y.paint.get("raster-hue-rotate")),u_perspective_transform:v,u_raster_elevation:x,u_tl_br:c,u_zoom_transition:u,u_merc_center:d,u_cutoff_params:f,u_colorization_mix:YD(E,D),u_colorization_offset:KD(M,D),u_color_ramp:w,u_texture_offset:[P/(A+2*P),A/(A+2*P)],u_texture_res:[A+2*P,A+2*P],u_emissive_strength:C};var R,k};function XD(e){e*=Math.PI/180;const t=Math.sin(e),n=Math.cos(e);return[(2*n+1)/3,(-Math.sqrt(3)*t-n+1)/3,(Math.sqrt(3)*t-n+1)/3]}function YD([e,t,n,r],[o,s]){if(o===s)return[0,0,0,0];const c=259/257/(s-o);return[e*c,t*c,n*c,r*c]}function KD(e,[t,n]){return t===n?0:((e-t)/(n-t)*259-1)/257}const Rp=st.create(),Ev=(e,t,n,r,o,s,c,u,d,f,m,g,y,v,x,w,E,M)=>{const D=o.transform,A={u_is_size_zoom_constant:+("constant"===e||"source"===e),u_is_size_feature_constant:+("constant"===e||"camera"===e),u_size_t:t?t.uSizeT:0,u_size:t?t.uSize:0,u_camera_to_center_distance:D.getCameraToCenterDistance(w),u_rotate_symbol:+n,u_aspect_ratio:D.width/D.height,u_fade_change:o.options.fadeDuration?o.symbolFadeChange:1,u_matrix:s,u_label_plane_matrix:c,u_coord_matrix:u,u_is_text:+d,u_pitch_with_map:+r,u_texsize:f,u_texture:0,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:Rp,u_merc_center:[0,0],u_camera_forward:[0,0,0],u_ecef_origin:[0,0,0],u_tile_matrix:Rp,u_up_vector:[0,-1,0],u_icon_transition:M||0,u_icon_saturation:E};return"globe"===w.name&&(A.u_tile_id=[m.canonical.x,m.canonical.y,1<<m.canonical.z],A.u_zoom_transition=g,A.u_inv_rot_matrix=v,A.u_merc_center=y,A.u_camera_forward=D._camera.forward(),A.u_ecef_origin=function(P,C){const R=[0,0,0],k=mu(bs(C.canonical));return Z.transformMat4(R,R,k),Z.transformMat4(R,R,P),R}(D.globeMatrix,m.toUnwrapped()),A.u_tile_matrix=Float32Array.from(D.globeMatrix),A.u_up_vector=x),A},DE=(e,t,n,r,o,s,c,u,d,f,m,g,y,v,x,w,E)=>Wt(Ev(e,t,n,r,o,s,c,u,d,f,g,y,v,x,w,E,1),{u_gamma_scale:r?o.transform.getCameraToCenterDistance(E)*Math.cos(o.terrain?0:o.transform._pitch):1,u_device_pixel_ratio:De.devicePixelRatio,u_is_halo:+m,undefined:void 0}),SE=(e,t,n,r,o,s,c,u,d,f,m,g,y,v,x,w)=>Wt(DE(e,t,n,r,o,s,c,u,!0,d,!0,m,g,y,v,x,w),{u_texsize_icon:f,u_texture_icon:1}),Gg=(e,t,n,r)=>({u_matrix:e,u_emissive_strength:t,u_opacity:n,u_color:r}),JD=(e,t,n,r,o,s,c)=>Wt(function(u,d,f,m){const g=f.imageManager.getPattern(u.toString(),d),{width:y,height:v}=f.imageManager.getPixelSize(d),x=Math.pow(2,m.tileID.overscaledZ),w=m.tileSize*Math.pow(2,f.transform.tileZoom)/x,E=w*(m.tileID.canonical.x+m.tileID.wrap*x),M=w*m.tileID.canonical.y;return{u_image:0,u_pattern_tl:g.tl,u_pattern_br:g.br,u_texsize:[y,v],u_pattern_size:g.displaySize,u_tile_units_to_pixels:1/Bu(m,1,f.transform.tileZoom),u_pixel_coord_upper:[E>>16,M>>16],u_pixel_coord_lower:[65535&E,65535&M]}}(o,s,r,c),{u_matrix:e,u_emissive_strength:t,u_opacity:n}),rs={BaseColor:5,MetallicRoughness:6,Normal:7,Occlusion:8,Emission:9,ShadowMap0:10},$g=(e,t,n,r,o,s,c,u,d,f,m,g,y=[0,0,0])=>{const v=r.style.light,x=v.properties.get("position"),w=[-x.x,-x.y,x.z],E=fo.create();"viewport"===v.properties.get("anchor")&&(fo.fromRotation(E,-r.transform.angle),Z.transformMat3(w,w,E));const M="MASK"===f.alphaMode,D=v.properties.get("color"),A=g.paint.get("model-ambient-occlusion-intensity"),P=g.paint.get("model-color").constantOr(ke.white),C=g.paint.get("model-color-mix-intensity").constantOr(0);return{u_matrix:e,u_lighting_matrix:t,u_normal_matrix:n,u_lightpos:w,u_lightintensity:v.properties.get("intensity"),u_lightcolor:[D.r,D.g,D.b],u_camera_pos:y,u_opacity:o,u_baseTextureIsAlpha:0,u_alphaMask:+M,u_alphaCutoff:f.alphaCutoff,u_baseColorFactor:[s.r,s.g,s.b,s.a],u_emissiveFactor:[c[0],c[1],c[2],1],u_metallicFactor:u,u_roughnessFactor:d,u_baseColorTexture:rs.BaseColor,u_metallicRoughnessTexture:rs.MetallicRoughness,u_normalTexture:rs.Normal,u_occlusionTexture:rs.Occlusion,u_emissionTexture:rs.Emission,u_color_mix:[P.r,P.g,P.b,C],u_aoIntensity:A,u_emissive_strength:m}},CE=new Float32Array(16),AE=(e,t=CE,n=CE)=>({u_matrix:e,u_instance:t,u_node_matrix:n}),PE={fillExtrusion:e=>({u_matrix:new Re(e),u_lightpos:new Ae(e),u_lightintensity:new Rt(e),u_lightcolor:new Ae(e),u_vertical_gradient:new Rt(e),u_opacity:new Rt(e),u_edge_radius:new Rt(e),u_ao:new Ve(e),u_tile_id:new Ae(e),u_zoom_transition:new Rt(e),u_inv_rot_matrix:new Re(e),u_merc_center:new Ve(e),u_up_dir:new Ae(e),u_height_lift:new Rt(e),u_flood_light_color:new Ae(e),u_vertical_scale:new Rt(e),u_flood_light_intensity:new Rt(e),u_ground_shadow_factor:new Ae(e),u_emissive_strength:new Rt(e)}),fillExtrusionDepth:e=>({u_matrix:new Re(e),u_edge_radius:new Rt(e),u_vertical_scale:new Rt(e)}),fillExtrusionPattern:e=>({u_matrix:new Re(e),u_lightpos:new Ae(e),u_lightintensity:new Rt(e),u_lightcolor:new Ae(e),u_vertical_gradient:new Rt(e),u_height_factor:new Rt(e),u_edge_radius:new Rt(e),u_ao:new Ve(e),u_tile_id:new Ae(e),u_zoom_transition:new Rt(e),u_inv_rot_matrix:new Re(e),u_merc_center:new Ve(e),u_up_dir:new Ae(e),u_height_lift:new Rt(e),u_image:new Ze(e),u_texsize:new Ve(e),u_pixel_coord_upper:new Ve(e),u_pixel_coord_lower:new Ve(e),u_tile_units_to_pixels:new Rt(e),u_opacity:new Rt(e)}),fillExtrusionGroundEffect:e=>({u_matrix:new Re(e),u_opacity:new Rt(e),u_ao_pass:new Rt(e),u_meter_to_tile:new Rt(e),u_ao:new Ve(e),u_flood_light_intensity:new Rt(e),u_flood_light_color:new Ae(e),u_attenuation:new Rt(e),u_edge_radius:new Rt(e),u_fb:new Ze(e),u_fb_size:new Rt(e)}),fill:e=>({u_matrix:new Re(e),u_emissive_strength:new Rt(e)}),fillPattern:e=>({u_matrix:new Re(e),u_emissive_strength:new Rt(e),u_image:new Ze(e),u_texsize:new Ve(e),u_pixel_coord_upper:new Ve(e),u_pixel_coord_lower:new Ve(e),u_tile_units_to_pixels:new Rt(e)}),fillOutline:e=>({u_matrix:new Re(e),u_emissive_strength:new Rt(e),u_world:new Ve(e)}),fillOutlinePattern:e=>({u_matrix:new Re(e),u_emissive_strength:new Rt(e),u_world:new Ve(e),u_image:new Ze(e),u_texsize:new Ve(e),u_pixel_coord_upper:new Ve(e),u_pixel_coord_lower:new Ve(e),u_tile_units_to_pixels:new Rt(e)}),circle:e=>({u_camera_to_center_distance:new Rt(e),u_extrude_scale:new Hx(e),u_device_pixel_ratio:new Rt(e),u_matrix:new Re(e),u_inv_rot_matrix:new Re(e),u_merc_center:new Ve(e),u_tile_id:new Ae(e),u_zoom_transition:new Rt(e),u_up_dir:new Ae(e),u_emissive_strength:new Rt(e)}),collisionBox:e=>({u_matrix:new Re(e),u_camera_to_center_distance:new Rt(e),u_extrude_scale:new Ve(e)}),collisionCircle:e=>({u_matrix:new Re(e),u_inv_matrix:new Re(e),u_camera_to_center_distance:new Rt(e),u_viewport_size:new Ve(e)}),debug:e=>({u_color:new ia(e),u_matrix:new Re(e),u_overlay:new Ze(e),u_overlay_scale:new Rt(e)}),clippingMask:e=>({u_matrix:new Re(e)}),heatmap:e=>({u_extrude_scale:new Rt(e),u_intensity:new Rt(e),u_matrix:new Re(e),u_inv_rot_matrix:new Re(e),u_merc_center:new Ve(e),u_tile_id:new Ae(e),u_zoom_transition:new Rt(e),u_up_dir:new Ae(e)}),heatmapTexture:e=>({u_image:new Ze(e),u_color_ramp:new Ze(e),u_opacity:new Rt(e)}),hillshade:e=>({u_matrix:new Re(e),u_image:new Ze(e),u_latrange:new Ve(e),u_light:new Ve(e),u_shadow:new ia(e),u_highlight:new ia(e),u_emissive_strength:new Rt(e),u_accent:new ia(e)}),hillshadePrepare:e=>({u_matrix:new Re(e),u_image:new Ze(e),u_dimension:new Ve(e),u_zoom:new Rt(e)}),line:e=>({u_matrix:new Re(e),u_pixels_to_tile_units:new Hx(e),u_device_pixel_ratio:new Rt(e),u_units_to_pixels:new Ve(e),u_dash_image:new Ze(e),u_gradient_image:new Ze(e),u_image_height:new Rt(e),u_texsize:new Ve(e),u_tile_units_to_pixels:new Rt(e),u_alpha_discard_threshold:new Rt(e),u_trim_offset:new Ve(e),u_emissive_strength:new Rt(e)}),linePattern:e=>({u_matrix:new Re(e),u_texsize:new Ve(e),u_pixels_to_tile_units:new Hx(e),u_device_pixel_ratio:new Rt(e),u_image:new Ze(e),u_units_to_pixels:new Ve(e),u_tile_units_to_pixels:new Rt(e),u_alpha_discard_threshold:new Rt(e)}),raster:e=>({u_matrix:new Re(e),u_normalize_matrix:new Re(e),u_globe_matrix:new Re(e),u_merc_matrix:new Re(e),u_grid_matrix:new $x(e),u_tl_parent:new Ve(e),u_scale_parent:new Rt(e),u_fade_t:new Rt(e),u_opacity:new Rt(e),u_image0:new Ze(e),u_image1:new Ze(e),u_brightness_low:new Rt(e),u_brightness_high:new Rt(e),u_saturation_factor:new Rt(e),u_contrast_factor:new Rt(e),u_spin_weights:new Ae(e),u_perspective_transform:new Ve(e),u_raster_elevation:new Rt(e),u_tl_br:new Ri(e),u_zoom_transition:new Rt(e),u_merc_center:new Ve(e),u_cutoff_params:new Ri(e),u_colorization_mix:new Ri(e),u_colorization_offset:new Rt(e),u_color_ramp:new Ze(e),u_texture_offset:new Ve(e),u_texture_res:new Ve(e),u_emissive_strength:new Rt(e)}),symbolIcon:e=>({u_is_size_zoom_constant:new Ze(e),u_is_size_feature_constant:new Ze(e),u_size_t:new Rt(e),u_size:new Rt(e),u_camera_to_center_distance:new Rt(e),u_rotate_symbol:new Ze(e),u_aspect_ratio:new Rt(e),u_fade_change:new Rt(e),u_matrix:new Re(e),u_label_plane_matrix:new Re(e),u_coord_matrix:new Re(e),u_is_text:new Ze(e),u_pitch_with_map:new Ze(e),u_texsize:new Ve(e),u_tile_id:new Ae(e),u_zoom_transition:new Rt(e),u_inv_rot_matrix:new Re(e),u_merc_center:new Ve(e),u_camera_forward:new Ae(e),u_tile_matrix:new Re(e),u_up_vector:new Ae(e),u_ecef_origin:new Ae(e),u_texture:new Ze(e),u_icon_transition:new Rt(e),u_icon_saturation:new Rt(e)}),symbolSDF:e=>({u_is_size_zoom_constant:new Ze(e),u_is_size_feature_constant:new Ze(e),u_size_t:new Rt(e),u_size:new Rt(e),u_camera_to_center_distance:new Rt(e),u_rotate_symbol:new Ze(e),u_aspect_ratio:new Rt(e),u_fade_change:new Rt(e),u_matrix:new Re(e),u_label_plane_matrix:new Re(e),u_coord_matrix:new Re(e),u_is_text:new Ze(e),u_pitch_with_map:new Ze(e),u_texsize:new Ve(e),u_texture:new Ze(e),u_gamma_scale:new Rt(e),u_device_pixel_ratio:new Rt(e),u_tile_id:new Ae(e),u_zoom_transition:new Rt(e),u_inv_rot_matrix:new Re(e),u_merc_center:new Ve(e),u_camera_forward:new Ae(e),u_tile_matrix:new Re(e),u_up_vector:new Ae(e),u_ecef_origin:new Ae(e),u_is_halo:new Ze(e)}),symbolTextAndIcon:e=>({u_is_size_zoom_constant:new Ze(e),u_is_size_feature_constant:new Ze(e),u_size_t:new Rt(e),u_size:new Rt(e),u_camera_to_center_distance:new Rt(e),u_rotate_symbol:new Ze(e),u_aspect_ratio:new Rt(e),u_fade_change:new Rt(e),u_matrix:new Re(e),u_label_plane_matrix:new Re(e),u_coord_matrix:new Re(e),u_is_text:new Ze(e),u_pitch_with_map:new Ze(e),u_texsize:new Ve(e),u_texsize_icon:new Ve(e),u_texture:new Ze(e),u_texture_icon:new Ze(e),u_gamma_scale:new Rt(e),u_device_pixel_ratio:new Rt(e),u_is_halo:new Ze(e)}),background:e=>({u_matrix:new Re(e),u_emissive_strength:new Rt(e),u_opacity:new Rt(e),u_color:new ia(e)}),backgroundPattern:e=>({u_matrix:new Re(e),u_emissive_strength:new Rt(e),u_opacity:new Rt(e),u_image:new Ze(e),u_pattern_tl:new Ve(e),u_pattern_br:new Ve(e),u_texsize:new Ve(e),u_pattern_size:new Ve(e),u_pixel_coord_upper:new Ve(e),u_pixel_coord_lower:new Ve(e),u_tile_units_to_pixels:new Rt(e)}),terrainRaster:mE,terrainDepth:mE,skybox:e=>({u_matrix:new Re(e),u_sun_direction:new Ae(e),u_cubemap:new Ze(e),u_opacity:new Rt(e),u_temporal_offset:new Rt(e)}),skyboxGradient:e=>({u_matrix:new Re(e),u_color_ramp:new Ze(e),u_center_direction:new Ae(e),u_radius:new Rt(e),u_opacity:new Rt(e),u_temporal_offset:new Rt(e)}),skyboxCapture:e=>({u_matrix_3f:new $x(e),u_sun_direction:new Ae(e),u_sun_intensity:new Rt(e),u_color_tint_r:new Ri(e),u_color_tint_m:new Ri(e),u_luminance:new Rt(e)}),globeRaster:e=>({u_proj_matrix:new Re(e),u_globe_matrix:new Re(e),u_normalize_matrix:new Re(e),u_merc_matrix:new Re(e),u_zoom_transition:new Rt(e),u_merc_center:new Ve(e),u_image0:new Ze(e),u_grid_matrix:new $x(e),u_skirt_height:new Rt(e),u_frustum_tl:new Ae(e),u_frustum_tr:new Ae(e),u_frustum_br:new Ae(e),u_frustum_bl:new Ae(e),u_globe_pos:new Ae(e),u_globe_radius:new Rt(e),u_viewport:new Ve(e)}),globeAtmosphere:e=>({u_frustum_tl:new Ae(e),u_frustum_tr:new Ae(e),u_frustum_br:new Ae(e),u_frustum_bl:new Ae(e),u_horizon:new Rt(e),u_transition:new Rt(e),u_fadeout_range:new Rt(e),u_color:new Ri(e),u_high_color:new Ri(e),u_space_color:new Ri(e),u_temporal_offset:new Rt(e),u_horizon_angle:new Rt(e)}),model:e=>({u_matrix:new Re(e),u_lighting_matrix:new Re(e),u_normal_matrix:new Re(e),u_lightpos:new Ae(e),u_lightintensity:new Rt(e),u_lightcolor:new Ae(e),u_camera_pos:new Ae(e),u_opacity:new Rt(e),u_baseColorFactor:new Ri(e),u_emissiveFactor:new Ri(e),u_metallicFactor:new Rt(e),u_roughnessFactor:new Rt(e),u_baseTextureIsAlpha:new Ze(e),u_alphaMask:new Ze(e),u_alphaCutoff:new Rt(e),u_baseColorTexture:new Ze(e),u_metallicRoughnessTexture:new Ze(e),u_normalTexture:new Ze(e),u_occlusionTexture:new Ze(e),u_emissionTexture:new Ze(e),u_color_mix:new Ri(e),u_aoIntensity:new Rt(e),u_emissive_strength:new Rt(e)}),modelDepth:e=>({u_matrix:new Re(e),u_instance:new Re(e),u_node_matrix:new Re(e)}),groundShadow:e=>({u_matrix:new Re(e),u_ground_shadow_factor:new Ae(e)}),stars:e=>({u_matrix:new Re(e),u_up:new Ae(e),u_right:new Ae(e),u_intensity_multiplier:new Rt(e)})};let Ms;function RE(e,t,n,r,o,s,c){const u=e.context,d=u.gl,f=e.transform,m=e.getOrCreateProgram("collisionBox"),g=[];let y=0,v=0;for(let P=0;P<r.length;P++){const C=r[P],R=t.getTile(C),k=R.getBucket(n);if(!k)continue;const N=ED(C,k,f);let z=N;0===o[0]&&0===o[1]||(z=e.translatePosMatrix(N,R,o,s));const B=c?k.textCollisionBox:k.iconCollisionBox,U=k.collisionCircleArray;if(U.length>0){const $=st.create(),W=z;st.mul($,k.placementInvProjMatrix,f.glCoordMatrix),st.mul($,$,k.placementViewportMatrix),g.push({circleArray:U,circleOffset:v,transform:W,invTransform:$,projection:k.getProjection()}),y+=U.length/4,v=y}B&&(e.terrain&&e.terrain.setupElevationDraw(R,m),m.draw(e,d.LINES,be.disabled,$e.disabled,e.colorModeForRenderPass(),Ge.disabled,qD(z,f,R,k.getProjection()),n.id,B.layoutVertexBuffer,B.indexBuffer,B.segments,null,f.zoom,null,[B.collisionVertexBuffer,B.collisionVertexBufferExt]))}if(!c||!g.length)return;const x=e.getOrCreateProgram("collisionCircle"),w=new pc;w.resize(4*y),w._trim();let E=0;for(const P of g)for(let C=0;C<P.circleArray.length/4;C++){const R=4*C,k=P.circleArray[R+0],N=P.circleArray[R+1],z=P.circleArray[R+2],B=P.circleArray[R+3];w.emplace(E++,k,N,z,B,0),w.emplace(E++,k,N,z,B,1),w.emplace(E++,k,N,z,B,2),w.emplace(E++,k,N,z,B,3)}(!Ms||Ms.length<2*y)&&(Ms=function(P){const C=2*P,R=new Kr;R.resize(C),R._trim();for(let k=0;k<C;k++){const N=6*k;R.uint16[N+0]=4*k+0,R.uint16[N+1]=4*k+1,R.uint16[N+2]=4*k+2,R.uint16[N+3]=4*k+2,R.uint16[N+4]=4*k+3,R.uint16[N+5]=4*k+0}return R}(y));const M=u.createIndexBuffer(Ms,!0),D=u.createVertexBuffer(w,db.members,!0);for(const P of g){const C={u_matrix:P.transform,u_inv_matrix:P.invTransform,u_camera_to_center_distance:(A=f).getCameraToCenterDistance(P.projection),u_viewport_size:[A.width,A.height]};x.draw(e,d.TRIANGLES,be.disabled,$e.disabled,e.colorModeForRenderPass(),Ge.disabled,C,n.id,D,M,Rn.simpleSegment(0,2*P.circleOffset,P.circleArray.length,P.circleArray.length/2),null,f.zoom)}var A;D.destroy(),M.destroy()}const LE=st.create();function OE({width:e,height:t,anchor:n,textOffset:r,textScale:o},s){const{horizontalAlign:c,verticalAlign:u}=og(n),d=-(c-.5)*e,f=-(u-.5)*t,m=Cb(n,r);return new it((d/o+m[0])*s,(f/o+m[1])*s)}function kE(e,t,n,r,o,s,c,u,d,f,m){const g=e.text.placedSymbolArray,y=e.text.dynamicLayoutVertexArray,v=e.icon.dynamicLayoutVertexArray,x={},w=e.getProjection(),E=Fg(u,w,s),M=s.elevation,D=w.upVectorScale(u.canonical,s.center.lat,s.worldSize).metersToTile;y.clear();for(let A=0;A<g.length;A++){const P=g.get(A),{tileAnchorX:C,tileAnchorY:R,numGlyphs:k}=P,N=P.hidden||!P.crossTileID||e.allowVerticalPlacement&&!P.placedOrientation?null:r[P.crossTileID];if(N){let z=0,B=0,U=0;if(M){const ct=M?M.getAtTileOffset(u,C,R):0,[dt,ht,_t]=w.upVector(u.canonical,C,R);z=ct*dt*D,B=ct*ht*D,U=ct*_t*D}let[$,W,V,K]=da(P.projectedAnchorX+z,P.projectedAnchorY+B,P.projectedAnchorZ+U,n?E:c);const Q=_0(s.getCameraToCenterDistance(w),K);let ot=o.evaluateSizeForFeature(e.textSizeData,f,P)*Q/wi;n&&(ot*=e.tilePixelRatio/d);const Y=OE(N,ot);n?(({x:$,y:W,z:V}=w.projectTilePoint(C+Y.x,R+Y.y,u.canonical)),[$,W,V]=da($+z,W+B,V+U,c)):(t&&Y._rotate(-s.angle),$+=Y.x,W+=Y.y,V=0);const J=e.allowVerticalPlacement&&P.placedOrientation===er.vertical?Math.PI/2:0;for(let ct=0;ct<k;ct++)cd(y,$,W,V,J);m&&P.associatedIconIndex>=0&&(x[P.associatedIconIndex]={x:$,y:W,z:V,angle:J})}else ju(k,y)}if(m){v.clear();const A=e.icon.placedSymbolArray;for(let P=0;P<A.length;P++){const C=A.get(P),{numGlyphs:R}=C,k=x[P];if(C.hidden||!k)ju(R,v);else{const{x:N,y:z,z:B,angle:U}=k;for(let $=0;$<R;$++)cd(v,N,z,B,U)}}e.icon.dynamicLayoutVertexBuffer.updateData(v)}e.text.dynamicLayoutVertexBuffer.updateData(y)}function Tv(e,t,n){return n.iconsInText&&t?"symbolTextAndIcon":e?"symbolSDF":"symbolIcon"}function Mv(e,t,n,r,o,s,c,u,d,f,m,g,y){const v=e.context,x=v.gl,w=e.transform,E="map"===u,M="map"===d,D=E&&"point"!==n.layout.get("symbol-placement"),A=E&&!M&&!D,P=void 0!==n.layout.get("symbol-sort-key").constantOr(1);let C=!1;const R=e.depthModeForSublayer(0,be.ReadOnly),k=[Br(w.center.lng),ui(w.center.lat)],N=n.layout.get("text-variable-anchor"),z="globe"===w.projection.name,B=[],U=[0,-1,0];let $=U;!z&&!w.mercatorFromTransition||E||($=function(W){const V=W._camera.getWorldToCamera(W.worldSize,1),K=st.multiply([],V,W.globeMatrix);st.invert(K,K);const Q=[0,0,0],ot=[0,1,0,0];return En.transformMat4(ot,ot,K),Q[0]=ot[0],Q[1]=ot[1],Q[2]=ot[2],Z.normalize(Q,Q),Q}(w));for(const W of r){const V=t.getTile(W),K=V.getBucket(n);if(!K||"mercator"===K.projection.name&&z)continue;const Q=o?K.text:K.icon;if(!Q||K.fullyClipped||!Q.segments.get().length)continue;const ot=Q.programConfigurations.get(n.id),Y=o||K.sdfIcons,J=o?K.textSizeData:K.iconSizeData,ct=M||0!==w.pitch,dt=qa(J,w.zoom);let ht,_t,vt,xt,mt=[0,0],Ct=null;if(o)_t=V.glyphAtlasTexture?V.glyphAtlasTexture:null,vt=x.LINEAR,ht=V.glyphAtlasTexture?V.glyphAtlasTexture.size:[0,0],K.iconsInText&&(mt=V.imageAtlasTexture?V.imageAtlasTexture.size:[0,0],Ct=V.imageAtlasTexture?V.imageAtlasTexture:null,xt=ct||e.options.rotating||e.options.zooming||"composite"===J.kind||"camera"===J.kind?x.LINEAR:x.NEAREST);else{const Yn=1!==n.layout.get("icon-size").constantOr(0)||K.iconsNeedLinear;_t=V.imageAtlasTexture?V.imageAtlasTexture:null,vt=Y||e.options.rotating||e.options.zooming||Yn||ct?x.LINEAR:x.NEAREST,ht=V.imageAtlasTexture?V.imageAtlasTexture.size:[0,0]}const Ut="globe"===K.projection.name,Gt=Ut?$:U,Yt=Ut?ri(w.zoom):0,te=Fg(W,K.getProjection(),w),Me=w.calculatePixelsToTileUnitsMatrix(V),ue=fp(te,V.tileID.canonical,M,E,w,K.getProjection(),Me),dn=e.terrain&&M&&D?st.invert(st.create(),ue):LE,Ye=g0(te,V.tileID.canonical,M,E,w,K.getProjection(),Me),Ie=N&&K.hasTextData(),we=K.hasIconTextFit()&&Ie&&K.hasIconData();if(D){const Yn=w.elevation,bn=Yn?Yn.getAtTileOffsetFunc(W,w.center.lat,w.worldSize,K.getProjection()):null,Ni=m0(te,V.tileID.canonical,M,E,w,K.getProjection(),Me);sw(K,te,e,o,Ni,Ye,M,f,bn,W)}const fe=D||o&&N||we,Ke=e.translatePosMatrix(te,V,s,c),rn=fe?LE:ue,Be=e.translatePosMatrix(Ye,V,s,c,!0),yn=K.getProjection().createInversionMatrix(w,W.canonical),Ir=n.paint.get("icon-image-cross-fade").constantOr(0),Sn=[];e.terrainRenderModeElevated()&&M&&Sn.push("PITCH_WITH_MAP_TERRAIN"),Ut&&(Sn.push("PROJECTION_GLOBE_VIEW"),fe&&Sn.push("PROJECTED_POS_ON_VIEWPORT")),Ir>0&&Sn.push("ICON_TRANSITION"),Q.zOffsetVertexBuffer&&Sn.push("Z_OFFSET");const Zn=Y&&0!==n.paint.get(o?"text-halo-width":"icon-halo-width").constantOr(1);let Vr;Y?Vr=K.iconsInText?SE(J.kind,dt,A,M,e,Ke,rn,Be,ht,mt,W,Yt,k,yn,Gt,K.getProjection()):DE(J.kind,dt,A,M,e,Ke,rn,Be,o,ht,!0,W,Yt,k,yn,Gt,K.getProjection()):(m<1&&Sn.push("SATURATION"),Vr=Ev(J.kind,dt,A,M,e,Ke,rn,Be,o,ht,W,Yt,k,yn,Gt,K.getProjection(),m,Ir));const br={program:e.getOrCreateProgram(Tv(Y,o,K),{config:ot,defines:Sn}),buffers:Q,uniformValues:Vr,atlasTexture:_t,atlasTextureIcon:Ct,atlasInterpolation:vt,atlasInterpolationIcon:xt,isSDF:Y,hasHalo:Zn,tile:V,labelPlaneMatrixInv:dn};if(P&&K.canOverlap){C=!0;const Yn=Q.segments.get();for(const bn of Yn)B.push({segments:new Rn([bn]),sortKey:bn.sortKey,state:br})}else B.push({segments:Q.segments,sortKey:0,state:br})}C&&B.sort((W,V)=>W.sortKey-V.sortKey);for(const W of B){const V=W.state;if(e.terrain&&e.terrain.setupElevationDraw(V.tile,V.program,{useDepthForOcclusion:w.depthOcclusionForSymbolsAndCircles,labelPlaneMatrixInv:V.labelPlaneMatrixInv}),v.activeTexture.set(x.TEXTURE0),V.atlasTexture&&V.atlasTexture.bind(V.atlasInterpolation,x.CLAMP_TO_EDGE),V.atlasTextureIcon&&(v.activeTexture.set(x.TEXTURE1),V.atlasTextureIcon&&V.atlasTextureIcon.bind(V.atlasInterpolationIcon,x.CLAMP_TO_EDGE)),e.uploadCommonLightUniforms(e.context,V.program),V.hasHalo){const K=V.uniformValues;K.u_is_halo=1,Iv(V.buffers,W.segments,n,e,V.program,R,g,y,K,2),K.u_is_halo=0}else{if(V.isSDF){const K=V.uniformValues;V.hasHalo&&(K.u_is_halo=1,Iv(V.buffers,W.segments,n,e,V.program,R,g,y,K,1)),K.u_is_halo=0}Iv(V.buffers,W.segments,n,e,V.program,R,g,y,V.uniformValues,1)}}}function Iv(e,t,n,r,o,s,c,u,d,f){const m=[e.dynamicLayoutVertexBuffer,e.opacityVertexBuffer,e.iconTransitioningVertexBuffer,e.globeExtVertexBuffer,e.zOffsetVertexBuffer];o.draw(r,r.context.gl.TRIANGLES,s,c,u,Ge.disabled,d,n.id,e.layoutVertexBuffer,e.indexBuffer,t,n.paint,r.transform.zoom,e.programConfigurations.get(n.id),m,f)}function Dv(e,t,n,r,o,s,c){const u=e.context.gl,d=n.paint.get("fill-pattern"),f=d&&d.constantOr(1);let m,g,y,v,x;c?(g=f&&!n.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",m=u.LINES):(g=f?"fillPattern":"fill",m=u.TRIANGLES);for(const w of r){const E=t.getTile(w);if(f&&!E.patternsLoaded())continue;const M=E.getBucket(n);if(!M)continue;e.prepareDrawTile();const D=M.programConfigurations.get(n.id),A=e.isTileAffectedByFog(w),P=e.getOrCreateProgram(g,{config:D,overrideFog:A});f&&(e.context.activeTexture.set(u.TEXTURE0),E.imageAtlasTexture&&E.imageAtlasTexture.bind(u.LINEAR,u.CLAMP_TO_EDGE),D.updatePaintBuffers());const C=d.constantOr(null);if(C&&E.imageAtlas){const N=E.imageAtlas.patternPositions[C.toString()];N&&D.setConstantPatternPositions(N)}const R=e.translatePosMatrix(w.projMatrix,E,n.paint.get("fill-translate"),n.paint.get("fill-translate-anchor")),k=n.paint.get("fill-emissive-strength");if(c){v=M.indexBuffer2,x=M.segments2;const N=e.terrain&&e.terrain.renderingToTexture?e.terrain.drapeBufferSize:[u.drawingBufferWidth,u.drawingBufferHeight];y="fillOutlinePattern"===g&&f?wv(R,k,e,E,N):HD(R,k,N)}else v=M.indexBuffer,x=M.segments,y=f?zd(R,k,e,E):IE(R,k);e.uploadCommonUniforms(e.context,P,w.toUnwrapped()),P.draw(e,m,o,e.stencilModeForClipping(w),s,Ge.disabled,y,n.id,M.layoutVertexBuffer,v,x,n.paint,e.transform.zoom,D,void 0)}}function Lp(e,t,n,r,o,s,c,u){n.resetLayerRenderingStats();const d=e.context,f=d.gl,m=e.transform,g=n.paint.get("fill-extrusion-pattern"),y=g.constantOr(1),v=n.paint.get("fill-extrusion-opacity"),x=e.style.enable3dLights(),w=n.paint.get(x&&!y?"fill-extrusion-ambient-occlusion-wall-radius":"fill-extrusion-ambient-occlusion-radius"),E=[n.paint.get("fill-extrusion-ambient-occlusion-intensity"),w],M=n.layout.get("fill-extrusion-edge-radius"),D=M>0&&!n.paint.get("fill-extrusion-rounded-roof"),A=D?0:M,P="globe"===m.projection.name?P0():0,C="globe"===m.projection.name,R=C?ri(m.zoom):0,k=[Br(m.center.lng),ui(m.center.lat)],N=n.paint.get("fill-extrusion-flood-light-color").toArray01().slice(0,3),z=n.paint.get("fill-extrusion-flood-light-intensity"),B=n.paint.get("fill-extrusion-vertical-scale"),U=kd(e,n.paint.get("fill-extrusion-cutoff-fade-range")),$=n.paint.get("fill-extrusion-emissive-strength"),W=[];let V;C&&W.push("PROJECTION_GLOBE_VIEW"),E[0]>0&&W.push("FAUX_AO"),D&&W.push("ZERO_ROOF_RADIUS"),u&&W.push("HAS_CENTROID"),z>0&&W.push("FLOOD_LIGHT"),U.shouldRenderCutoff&&W.push("RENDER_CUTOFF");const K="shadow"===e.renderPass,Q=e.shadowRenderer,ot=K&&!!Q;e.shadowRenderer&&(e.shadowRenderer.useNormalOffset=!0);let Y=[0,0,0];if(Q){const dt=e.style.directionalLight,ht=e.style.ambientLight;dt&&ht&&(Y=HE(dt,ht)),V=W.concat(["SHADOWS_SINGLE_CASCADE"])}const J=ot?"fillExtrusionDepth":y?"fillExtrusionPattern":"fillExtrusion",ct=n.getLayerRenderingStats();for(const dt of r){const ht=t.getTile(dt),_t=ht.getBucket(n);if(!_t||_t.projection.name!==m.projection.name)continue;let vt=!1;Q&&(vt=0===Q.getMaxCascadeForTile(dt.toUnwrapped()));const xt=e.isTileAffectedByFog(dt),mt=_t.programConfigurations.get(n.id),Ct=e.getOrCreateProgram(J,{config:mt,defines:vt?V:W,overrideFog:xt});if(e.terrain&&e.terrain.setupElevationDraw(ht,Ct,{useMeterToDem:!0}),!_t.centroidVertexBuffer){const ue=Ct.attributes.a_centroid_pos;void 0!==ue&&f.vertexAttrib2f(ue,0,0)}!K&&Q&&Q.setupShadows(ht.tileID.toUnwrapped(),Ct,"vector-tile",ht.tileID.overscaledZ),y&&(e.context.activeTexture.set(f.TEXTURE0),ht.imageAtlasTexture&&ht.imageAtlasTexture.bind(f.LINEAR,f.CLAMP_TO_EDGE),mt.updatePaintBuffers());const Ut=g.constantOr(null);if(Ut&&ht.imageAtlas){const ue=ht.imageAtlas.patternPositions[Ut.toString()];ue&&mt.setConstantPatternPositions(ue)}const Gt=n.paint.get("fill-extrusion-vertical-gradient");let Yt;if(K&&Q){if(Av(ht.tileID,_t,e))continue;const ue=Q.calculateShadowPassMatrixFromTile(ht.tileID.toUnwrapped());Yt=GD(ue,A,B)}else{const ue=e.translatePosMatrix(dt.expandedProjMatrix,ht,n.paint.get("fill-extrusion-translate"),n.paint.get("fill-extrusion-translate-anchor")),dn=m.projection.createInversionMatrix(m,dt.canonical);Yt=y?$D(ue,e,Gt,v,E,A,dt,ht,P,R,k,dn,N,B):ME(ue,e,Gt,v,E,A,dt,P,R,k,dn,N,B,z,Y,$)}e.uploadCommonUniforms(d,Ct,dt.toUnwrapped(),null,U);let te=_t.segments;if("mercator"===m.projection.name&&!K&&(te=_t.getVisibleSegments(ht.tileID,e.terrain,e.transform.getFrustum(0)),!te.get().length))continue;if(ct)if(K)for(const ue of te.get())ct.numRenderedVerticesInShadowPass+=ue.primitiveLength;else for(const ue of te.get())ct.numRenderedVerticesInTransparentPass+=ue.primitiveLength;const Me=[];(e.terrain||u)&&Me.push(_t.centroidVertexBuffer),C&&Me.push(_t.layoutVertexExtBuffer),Ct.draw(e,d.gl.TRIANGLES,o,s,c,Ge.backCCW,Yt,n.id,_t.layoutVertexBuffer,_t.indexBuffer,te,n.paint,e.transform.zoom,mt,Me)}e.shadowRenderer&&(e.shadowRenderer.useNormalOffset=!1)}function Bd(e,t,n,r,o,s,c,u,d,f,m,g,y,v,x,w,E,M,D){const A=e.context,P=A.gl,C=e.transform,R=e.transform.zoom,k=[],N=kd(e,n.paint.get("fill-extrusion-cutoff-fade-range"));"clear"===f?(k.push("CLEAR_SUBPASS"),D&&(k.push("CLEAR_FROM_TEXTURE"),A.activeTexture.set(P.TEXTURE0),D.bind(P.LINEAR,P.CLAMP_TO_EDGE))):"sdf"===f&&k.push("SDF_SUBPASS"),E&&k.push("HAS_CENTROID"),N.shouldRenderCutoff&&k.push("RENDER_CUTOFF");const z=n.layout.get("fill-extrusion-edge-radius"),B=(U,$,W,V,K)=>{const Q=$.programConfigurations.get(n.id),ot=e.isTileAffectedByFog(U),Y=e.getOrCreateProgram("fillExtrusionGroundEffect",{config:Q,defines:k,overrideFog:ot}),J={u_matrix:V,u_opacity:m,u_ao_pass:d?1:0,u_meter_to_tile:K,u_ao:[g,y*K],u_flood_light_intensity:v,u_flood_light_color:x,u_attenuation:w,u_edge_radius:R>=17?0:z*K,u_fb:0,u_fb_size:D?D.size[0]:0},ct=[];E&&ct.push($.hiddenByLandmarkVertexBuffer),e.uploadCommonUniforms(A,Y,U.toUnwrapped(),null,N),Y.draw(e,A.gl.TRIANGLES,o,s,c,u,J,n.id,$.vertexBuffer,$.indexBuffer,W,n.paint,R,Q,ct)};for(const U of r){const $=t.getTile(U),W=$.getBucket(n);if(!W||W.projection.name!==C.projection.name||!W.groundEffect||W.groundEffect&&!W.groundEffect.hasData())continue;const V=W.groundEffect,K=1/W.tileToMeter;{const Q=e.translatePosMatrix(U.projMatrix,$,n.paint.get("fill-extrusion-translate"),n.paint.get("fill-extrusion-translate-anchor")),ot=V.getDefaultSegment();B(U,V,ot,Q,K)}if(M)for(let Q=0;Q<4;Q++){const ot=ny[Q](U),Y=t.getTile(ot);if(!Y)continue;const J=Y.getBucket(n);if(!J||J.projection.name!==C.projection.name||!J.groundEffect||J.groundEffect&&!J.groundEffect.hasData())continue;const ct=J.groundEffect;let dt,ht;0===Q?(dt=[-et,0,0],ht=1):1===Q?(dt=[et,0,0],ht=0):2===Q?(dt=[0,-et,0],ht=3):(dt=[0,et,0],ht=2);const _t=ct.regionSegments[ht];if(!_t)continue;const vt=new Float32Array(16);st.translate(vt,U.projMatrix,dt),B(U,ct,_t,e.translatePosMatrix(vt,$,n.paint.get("fill-extrusion-translate"),n.paint.get("fill-extrusion-translate-anchor")),K)}}}function QD(e,t,n,r,o,s,c){0===r.centroidVertexArray.length&&r.createCentroidsBuffer();const u=s?s.findDEMTileFor(n):null;if(!(u&&u.dem||c))return;const d=M=>{const D=t.getSource().minzoom,A=C=>{const R=t.getTileByID(C);if(R&&R.hasData())return R.getBucket(o)},P=[0,-1,1];for(const C of P){if(M.overscaledZ+C<D)continue;const R=A(M.calculateScaledKey(M.overscaledZ+C));if(R)return R}},f=[0,0,0],m=(M,D)=>(f[0]=Math.min(M.min.y,D.min.y),f[1]=Math.max(M.max.y,D.max.y),f[2]=et-D.min.x>M.max.x?D.min.x-et:M.max.x,f),g=(M,D)=>(f[0]=Math.min(M.min.x,D.min.x),f[1]=Math.max(M.max.x,D.max.x),f[2]=et-D.min.y>M.max.y?D.min.y-et:M.max.y,f),y=[(M,D)=>m(M,D),(M,D)=>m(D,M),(M,D)=>g(M,D),(M,D)=>g(D,M)],v=(M,D,A,P,C,R,k)=>{if(!s)return 0;const N=[[R?A:M,R?M:A,0],[R?A:D,R?D:A,0]],z=k<0?et+k:k,B=[R?z:(M+D)/2,R?(M+D)/2:z,0];return 0===A&&k<0||0!==A&&k>0?s.getForTilePoints(C,[B],!0,P):N.push(B),s.getForTilePoints(n,N,!0,u),Math.max(N[0][2],N[1][2],B[2])/s.exaggeration()};for(let M=0;M<4;M++){const D=r.borderFeatureIndices[M];if(0===D.length)continue;const A=ny[M](n),P=d(A);if(!(P&&P instanceof Id)||r.borderDoneWithNeighborZ[M]===P.canonical.z)continue;0===P.centroidVertexArray.length&&P.createCentroidsBuffer();const C=s?s.findDEMTileFor(A):null;if(!(C&&C.dem||c))continue;const R=(M<2?1:5)-M,k=P.borderDoneWithNeighborZ[R]!==r.canonical.z,N=P.borderFeatureIndices[R];let z=0;if(r.canonical.z!==P.canonical.z){for(const B of D)r.showCentroid(r.featuresOnBorder[B]);if(k)for(const B of N)P.showCentroid(P.featuresOnBorder[B]);r.borderDoneWithNeighborZ[M]=P.canonical.z,P.borderDoneWithNeighborZ[R]=r.canonical.z}for(const B of D){const U=r.featuresOnBorder[B],$=r.centroidData[U.centroidDataIndex],W=U.borders[M];let V;for(;z<N.length;){V=P.featuresOnBorder[N[z]];const K=V.borders[R];if(K[1]>W[0]+3||K[0]>W[0]-3)break;P.showCentroid(V),z++}if(V&&z<N.length){const K=z;let Q=0;for(;!(V.borders[R][0]>W[1]-3)&&(Q++,++z!==N.length);)V=P.featuresOnBorder[N[z]];if(V=P.featuresOnBorder[N[K]],Q>1){const J=V.borders[R];Math.abs(W[0]-J[0])<3&&Math.abs(W[1]-J[1])<3&&(Q=1,z=K+1)}else if(0===Q){r.showCentroid(U);continue}const ot=P.centroidData[V.centroidDataIndex];c&&1===Q&&(((w=$).flags|(E=ot).flags)&Ti?(w.flags|=Ti,E.flags|=Ti):(w.flags&=2147483647,E.flags&=2147483647));let Y=new it(0,0);if(Q>1)z=K;else if(C&&C.dem&&!(U.intersectsCount()>1||V.intersectsCount()>1)){const J=y[M]($,ot),ct=M%2?et-1:0;x=v(J[0],Math.min(et-1,J[1]),ct,C,A,M<2,J[2]),Y=new it(Math.ceil(7*(x+450)),0)}$.centroidXY=ot.centroidXY=Y,r.writeCentroidToBuffer($),P.writeCentroidToBuffer(ot)}else r.showCentroid(U)}r.borderDoneWithNeighborZ[M]=P.canonical.z,P.borderDoneWithNeighborZ[R]=r.canonical.z}var x,w,E;(r.needsCentroidUpdate||!r.centroidVertexBuffer&&0!==r.centroidVertexArray.length)&&r.uploadCentroid(e)}const Sv=[1,0,0],Cv=[0,1,0],FE=[0,0,1];function Av(e,t,n){const r=n.transform,o=n.shadowRenderer;if(!o)return!0;const s=e.toUnwrapped(),c=r.tileSize*o._cascades[n.currentShadowCascade].scale;let u=t.maxHeight;if(r.elevation){const w=r.elevation.getMinMaxForTile(e);w&&(u+=w.max)}const d=[...o.shadowDirection];d[2]=-d[2];const f=o.computeSimplifiedTileShadowVolume(s,u,c,d);if(!f)return!1;const m=[Sv,Cv,FE,d,[d[0],0,d[2]],[0,d[1],d[2]]],g="globe"===r.projection.name,y=r.scaleZoom(c),v=aa.fromInvProjectionMatrix(r.invProjMatrix,r.worldSize,y,!g),x=o.getCurrentCascadeFrustum();return 0===v.intersectsPrecise(f.vertices,f.planes,m)||0===x.intersectsPrecise(f.vertices,f.planes,m)}function Pv(e){const t=e._nearZ,n=e.projection.farthestPixelDistance(e),r=n-t,o=.2*e.height,s=t+o;return[t,n,(s-o-t)/r,(s-t)/r]}const tS=new ke(1,0,0,1),eS=new ke(0,1,0,1),nS=new ke(0,0,1,1),rS=new ke(1,0,1,1),NE=new ke(0,1,1,1);function Rv(e,t,n){const r=e.context,o=e.transform,s=r.gl,c="globe"===o.projection.name,u=c?["PROJECTION_GLOBE_VIEW"]:[];let d=n.projMatrix;if(c&&ri(o.zoom)>0){const B=km(R1(n.canonical,o));d=st.multiply(new Float32Array(16),o.globeMatrix,B),st.multiply(d,o.projMatrix,d)}const f=e.getOrCreateProgram("debug",{defines:u}),m=t.getTileByID(n.key);e.terrain&&e.terrain.setupElevationDraw(m,f);const g=be.disabled,y=$e.disabled,v=e.colorModeForRenderPass(),x="$debug";r.activeTexture.set(s.TEXTURE0),e.emptyTexture.bind(s.LINEAR,s.CLAMP_TO_EDGE),c?m._makeGlobeTileDebugBuffers(e.context,o):m._makeDebugTileBoundsBuffers(e.context,o.projection);const w=m._tileDebugBuffer||e.debugBuffer,E=m._tileDebugIndexBuffer||e.debugIndexBuffer,M=m._tileDebugSegments||e.debugSegments;f.draw(e,s.LINE_STRIP,g,y,v,Ge.disabled,ZD(d,ke.red),x,w,E,M,null,null,null,[m._globeTileDebugBorderBuffer]);const D=m.latestRawTileData,A=Math.floor((D&&D.byteLength||0)/1024),P=t.getTile(n).tileSize,C=512/Math.min(P,512)*(n.overscaledZ/o.zoom)*.5;let R=n.canonical.toString();n.overscaledZ!==n.canonical.z&&(R+=` => ${n.overscaledZ}`),R+=` ${A}kb`,function(B,U){B.initDebugOverlayCanvas();const $=B.debugOverlayCanvas,W=B.context.gl,V=B.debugOverlayCanvas.getContext("2d");V.clearRect(0,0,$.width,$.height),V.shadowColor="white",V.shadowBlur=2,V.lineWidth=1.5,V.strokeStyle="white",V.textBaseline="top",V.font="bold 36px Open Sans, sans-serif",V.fillText(U,5,5),V.strokeText(U,5,5),B.debugOverlayTexture.update($),B.debugOverlayTexture.bind(W.LINEAR,W.CLAMP_TO_EDGE)}(e,R);const k=m._tileDebugTextBuffer||e.debugBuffer,N=m._tileDebugTextIndexBuffer||e.quadTriangleIndexBuffer,z=m._tileDebugTextSegments||e.debugSegments;f.draw(e,s.TRIANGLES,g,y,hn.alphaBlended,Ge.disabled,ZD(d,ke.transparent,C),x,k,N,z,null,null,null,[m._globeTileDebugTextBuffer])}function zE(e,t,n,r){Hg(e,0,t+n/2,e.transform.width,n,r)}function BE(e,t,n,r){Hg(e,t-n/2,0,n,e.transform.height,r)}function Hg(e,t,n,r,o,s){const c=e.context,u=c.gl;u.enable(u.SCISSOR_TEST),u.scissor(t*De.devicePixelRatio,n*De.devicePixelRatio,r*De.devicePixelRatio,o*De.devicePixelRatio),c.clear({color:s}),u.disable(u.SCISSOR_TEST)}const iS=Ce([{name:"a_pos_3f",components:3,type:"Float32"}]),{members:oS}=iS;function Bl(e,t,n,r){e.emplaceBack(t,n,r)}class Lv{constructor(t){this.vertexArray=new Ml,this.indices=new Kr,Bl(this.vertexArray,-1,-1,1),Bl(this.vertexArray,1,-1,1),Bl(this.vertexArray,-1,1,1),Bl(this.vertexArray,1,1,1),Bl(this.vertexArray,-1,-1,-1),Bl(this.vertexArray,1,-1,-1),Bl(this.vertexArray,-1,1,-1),Bl(this.vertexArray,1,1,-1),this.indices.emplaceBack(5,1,3),this.indices.emplaceBack(3,7,5),this.indices.emplaceBack(6,2,0),this.indices.emplaceBack(0,4,6),this.indices.emplaceBack(2,6,7),this.indices.emplaceBack(7,3,2),this.indices.emplaceBack(5,4,0),this.indices.emplaceBack(0,1,5),this.indices.emplaceBack(0,2,3),this.indices.emplaceBack(3,1,0),this.indices.emplaceBack(7,6,4),this.indices.emplaceBack(4,5,7),this.vertexBuffer=t.createVertexBuffer(this.vertexArray,oS),this.indexBuffer=t.createIndexBuffer(this.indices),this.segment=Rn.simpleSegment(0,0,36,12)}}function jd(e,t,n,r,o,s){const c=e.context.gl,u=t.paint.get("sky-atmosphere-color"),d=t.paint.get("sky-atmosphere-halo-color"),f=t.paint.get("sky-atmosphere-sun-intensity"),m={u_matrix_3f:fo.fromMat4(fo.create(),r),u_sun_direction:o,u_sun_intensity:f,u_color_tint_r:[(x=u).r,x.g,x.b,x.a],u_color_tint_m:[(w=d).r,w.g,w.b,w.a],u_luminance:5e-5};var x,w;c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_CUBE_MAP_POSITIVE_X+s,t.skyboxTexture,0),n.draw(e,c.TRIANGLES,be.disabled,$e.disabled,hn.unblended,Ge.frontCW,m,"skyboxCapture",t.skyboxGeometry.vertexBuffer,t.skyboxGeometry.indexBuffer,t.skyboxGeometry.segment)}const jE=Ce([{type:"Float32",name:"a_pos",components:3},{type:"Float32",name:"a_uv",components:2}]);class sS{constructor(t){const n=new ou;n.emplaceBack(-1,1,1,0,0),n.emplaceBack(1,1,1,1,0),n.emplaceBack(1,-1,1,1,1),n.emplaceBack(-1,-1,1,0,1);const r=new Kr;r.emplaceBack(0,1,2),r.emplaceBack(2,3,0),this.vertexBuffer=t.createVertexBuffer(n,jE.members),this.indexBuffer=t.createIndexBuffer(r),this.segments=Rn.simpleSegment(0,0,4,2)}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy()}}const Co=Ce([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_size_scale",components:1},{type:"Float32",name:"a_fade_opacity",components:1}]);class Vd{constructor(){this.colorModeAlphaBlendedWriteRGB=new hn([1,771,1,771],ke.transparent,[!0,!0,!0,!1]),this.colorModeWriteAlpha=new hn([1,0,1,0],ke.transparent,[!1,!1,!1,!0])}update(t){const n=t.context;if(!this.atmosphereBuffer){this.atmosphereBuffer=new sS(n);const r=100,o=200,s=function(m){const g=lx(30),y=[];for(let v=0;v<16e3;++v){const x=2*Math.PI*g(),w=Math.acos(1-2*g())-.5*Math.PI;y.push(Z.fromValues(Math.cos(w)*Math.cos(x),Math.cos(w)*Math.sin(x),Math.sin(w)))}return y}(),c=lx(300),u=new A_,d=new Kr;let f=0;for(let m=0;m<s.length;++m){const g=Z.scale([],s[m],200),y=Math.max(0,1+.01*r*(1*c()-.5)),v=Math.max(0,1+.01*o*(1*c()-.5));u.emplaceBack(g[0],g[1],g[2],-1,-1,y,v),u.emplaceBack(g[0],g[1],g[2],1,-1,y,v),u.emplaceBack(g[0],g[1],g[2],1,1,y,v),u.emplaceBack(g[0],g[1],g[2],-1,1,y,v),d.emplaceBack(f+0,f+1,f+2),d.emplaceBack(f+0,f+2,f+3),f+=4}this.starsVx=n.createVertexBuffer(u,Co.members),this.starsIdx=n.createIndexBuffer(d),this.starsSegments=Rn.simpleSegment(0,0,u.length,d.length)}}destroy(){this.atmosphereBuffer&&this.atmosphereBuffer.destroy(),this.starsVx&&this.starsVx.destroy(),this.starsIdx&&this.starsIdx.destroy()}drawAtmosphereGlow(t,n){const r=t.context,o=r.gl,s=t.transform,c=new be(o.LEQUAL,be.ReadOnly,[0,1]),u=ri(s.zoom),d=n.properties.get("color").toArray01(),f=n.properties.get("high-color").toArray01(),m=n.properties.get("space-color").toArray01PremultipliedAlpha(),g=5e-4,y=ne((n.properties.get("horizon-blend")-0)/1*.2495+g,5e-4,.25),v=jh(t,r,s)&&y===g?s.worldSize/(2*Math.PI*1.025)-1:s.globeRadius,x=t.frameCounter/1e3%1,w=Z.length(s.globeCenterInViewSpace),E=Math.sqrt(Math.pow(w,2)-Math.pow(v,2)),M=Math.acos(E/w),D=A=>{const P="globe"===s.projection.name?["PROJECTION_GLOBE_VIEW","FOG"]:["FOG"];A&&P.push("ALPHA_PASS");const C=t.getOrCreateProgram("globeAtmosphere",{defines:P}),R={u_frustum_tl:s.frustumCorners.TL,u_frustum_tr:s.frustumCorners.TR,u_frustum_br:s.frustumCorners.BR,u_frustum_bl:s.frustumCorners.BL,u_horizon:s.frustumCorners.horizon,u_transition:u,u_fadeout_range:y,u_color:d,u_high_color:f,u_space_color:m,u_temporal_offset:x,u_horizon_angle:M};t.uploadCommonUniforms(r,C);const k=this.atmosphereBuffer;k&&C.draw(t,o.TRIANGLES,c,$e.disabled,A?this.colorModeWriteAlpha:this.colorModeAlphaBlendedWriteRGB,Ge.backCW,R,A?"atmosphere_glow_alpha":"atmosphere_glow",k.vertexBuffer,k.indexBuffer,k.segments)};D(!1),D(!0)}drawStars(t,n){const r=ne(n.properties.get("star-intensity"),0,1);if(0===r)return;const o=t.context,s=o.gl,c=t.transform,u=t.getOrCreateProgram("stars"),d=ki.identity([]);ki.rotateX(d,d,-c._pitch),ki.rotateZ(d,d,-c.angle),ki.rotateX(d,d,Oe(c._center.lat)),ki.rotateY(d,d,-Oe(c._center.lng));const f=st.fromQuat(new Float32Array(16),d),m=st.multiply([],c.starsProjMatrix,f),g=fo.fromMat4([],f),y=fo.invert([],g),v=[0,1,0];Z.transformMat3(v,v,y),Z.scale(v,v,.15);const x=[1,0,0];Z.transformMat3(x,x,y),Z.scale(x,x,.15);const w=(M=v,D=x,A=r,{u_matrix:Float32Array.from(m),u_up:M,u_right:D,u_intensity_multiplier:A});var M,D,A;t.uploadCommonUniforms(o,u),this.starsVx&&this.starsIdx&&u.draw(t,s.TRIANGLES,be.disabled,$e.disabled,this.colorModeAlphaBlendedWriteRGB,Ge.disabled,w,"atmosphere_stars",this.starsVx,this.starsIdx,this.starsSegments)}}function VE(e,t){const n=[...e],r=t.cameraWorldSizeForFog/t.worldSize,o=st.identity([]);return st.scale(o,o,[r,r,1]),st.multiply(n,o,n),st.multiply(n,t.worldToFogMatrix,n),n}function Ov(e,t,n,r){const o=n.material,s=r.context,{baseColorTexture:c,metallicRoughnessTexture:u}=o.pbrMetallicRoughness,{normalTexture:d,occlusionTexture:f,emissionTexture:m}=o;function g(y,v,x){if(y&&(e.push(v),s.activeTexture.set(s.gl.TEXTURE0+x),y.gfxTexture)){const{minFilter:w,magFilter:E,wrapS:M,wrapT:D}=y.sampler;y.gfxTexture.bindExtraParam(w,E,M,D)}}g(c,"HAS_TEXTURE_u_baseColorTexture",rs.BaseColor),g(u,"HAS_TEXTURE_u_metallicRoughnessTexture",rs.MetallicRoughness),g(d,"HAS_TEXTURE_u_normalTexture",rs.Normal),g(f,"HAS_TEXTURE_u_occlusionTexture",rs.Occlusion),g(m,"HAS_TEXTURE_u_emissionTexture",rs.Emission),n.texcoordBuffer&&(e.push("HAS_ATTRIBUTE_a_uv_2f"),t.push(n.texcoordBuffer)),n.colorBuffer&&(e.push(12===n.colorBuffer.itemSize?"HAS_ATTRIBUTE_a_color_3f":"HAS_ATTRIBUTE_a_color_4f"),t.push(n.colorBuffer)),n.normalBuffer&&(e.push("HAS_ATTRIBUTE_a_normal_3f"),t.push(n.normalBuffer)),n.pbrBuffer&&(e.push("HAS_ATTRIBUTE_a_pbr"),e.push("HAS_ATTRIBUTE_a_heightBasedEmissiveStrength"),t.push(n.pbrBuffer)),"OPAQUE"!==o.alphaMode&&"MASK"!==o.alphaMode||e.push("UNPREMULT_TEXTURE_IN_SHADER"),o.defined||e.push("DIFFUSE_SHADED"),e.push("USE_STANDARD_DERIVATIVES")}function kv(e,t,n,r,o,s){const c=n.paint.get("model-opacity"),u=t.context,d=new be(t.context.gl.LEQUAL,be.ReadWrite,t.depthRangeFor3D),f=t.transform,m=e.mesh,g=m.material,y=g.pbrMetallicRoughness,v=t.style.fog;let x;x="pixels"===t.transform.projection.zAxisUnit?[...e.nodeModelMatrix]:st.multiply([],r.zScaleMatrix,e.nodeModelMatrix),st.multiply(x,r.negCameraPosMatrix,x);const w=st.invert([],x);st.transpose(w,w);const E=n.paint.get("model-emissive-strength").constantOr(0),M=$g(new Float32Array(e.worldViewProjection),new Float32Array(x),new Float32Array(w),t,c,y.baseColorFactor,g.emissiveFactor,y.metallicFactor,y.roughnessFactor,g,E,n),D={defines:[]},A=[];Ov(D.defines,A,m,t);const P=t.shadowRenderer;P&&(P.useNormalOffset=!1);let C=null;if(v){const N=VE(e.nodeModelMatrix,t.transform);if(C=new Float32Array(N),"globe"!==f.projection.name){const z=m.aabb.min,B=m.aabb.max,[U,$]=v.getOpacityForBounds(N,z[0],z[1],B[0],B[1]);D.overrideFog=U>=Rc||$>=Rc}}const R=kd(t,n.paint.get("model-cutoff-fade-range"));R.shouldRenderCutoff&&D.defines.push("RENDER_CUTOFF");const k=t.getOrCreateProgram("model",D);t.uploadCommonUniforms(u,k,null,C,R),"shadow"!==t.renderPass&&P&&P.setupShadowsFromMatrix(e.nodeModelMatrix,k),k.draw(t,u.gl.TRIANGLES,d,o,s,m.material.doubleSided?Ge.disabled:Ge.backCCW,M,n.id,m.vertexBuffer,m.indexBuffer,m.segments,n.paint,t.transform.zoom,void 0,A)}function aS(e,t,n,r,o,s,c){let u;u="globe"===e.projection.name?E0(n,e):[...n],st.multiply(u,u,t.matrix);const d=st.multiply([],r,u);if(t.meshes)for(const f of t.meshes){if("BLEND"!==f.material.alphaMode){c.push({mesh:f,depth:0,modelIndex:o,worldViewProjection:d,nodeModelMatrix:u});continue}const m=Z.transformMat4([],f.centroid,d);m[2]>0&&s.push({mesh:f,depth:m[2],modelIndex:o,worldViewProjection:d,nodeModelMatrix:u})}if(t.children)for(const f of t.children)aS(e,f,n,r,o,s,c)}function qg(e,t,n,r){const o=n.shadowRenderer;if(!o)return;const s=o.getShadowPassDepthMode(),c=o.getShadowPassColorMode(),u=o.calculateShadowPassMatrixFromMatrix(t),d=AE(u);n.getOrCreateProgram("modelDepth",{defines:["DEPTH_TEXTURE"]}).draw(n,n.context.gl.TRIANGLES,s,$e.disabled,c,Ge.backCCW,d,r.id,e.vertexBuffer,e.indexBuffer,e.segments,r.paint,n.transform.zoom,void 0,void 0)}function UE(e,t,n){const r=t.updateZoomBasedPaintProperties(),o=function(s,c,u){let d,f,m,g=s.terrain?s.terrain.exaggeration():0;if(s.terrain&&g>0){const y=s.terrain,v=y.findDEMTileFor(u);v&&v.dem?d=Du.create(y,u,v):g=0}if(0===g&&(c.terrainElevationMin=0,c.terrainElevationMax=0),g===c.validForExaggeration&&(0===g||d&&d._demTile&&d._demTile.tileID===c.validForDEMTile.id&&d._dem._timestamp===c.validForDEMTile.timestamp))return!1;for(const y in c.instancesPerModel){const v=c.instancesPerModel[y];for(let x=0;x<v.instancedDataArray.length;++x){const w=(d?g*d.getElevationAt(0|v.instancedDataArray.float32[16*x],0|v.instancedDataArray.float32[16*x+1],!0,!0):0)+v.instancesEvaluatedElevation[x];v.instancedDataArray.float32[16*x+6]=w,f=f?Math.min(c.terrainElevationMin,w):w,m=m?Math.max(c.terrainElevationMax,w):w}}return c.terrainElevationMin=f||0,c.terrainElevationMax=m||0,c.validForExaggeration=g,c.validForDEMTile=d&&d._demTile?{id:d._demTile.tileID,timestamp:d._dem._timestamp}:{id:void 0,timestamp:0},!0}(e,t,n);(r||o)&&(t.uploaded=!1,t.upload(e.context))}const jl={shadowUniformsInitialized:!1,useSingleShadowCascade:!1,tileMatrix:new Float64Array(16),shadowTileMatrix:new Float32Array(16),aabb:new Bn([0,0,0],[et,et,0])};function VC(e,t){const n=1<<e.canonical.z,r=t.getFreeCameraOptions().position,o=t.elevation,s=e.canonical.x/n,c=(e.canonical.x+1)/n,u=e.canonical.y/n,d=(e.canonical.y+1)/n;let f=t._centerAltitude;if(o){const v=o.getMinMaxForTile(e);v&&v.max>f&&(f=v.max)}const m=ne(r.x,s,c)-r.x,g=ne(r.y,u,d)-r.y,y=Ln(f,t.center.lat)-r.z;return t._zoomFromMercatorZ(Math.sqrt(m*m+g*g+y*y))}function lS(e,t,n,r,o,s,c){const u=e.context,d="shadow"===e.renderPass,f=e.shadowRenderer,m=d&&f?f.getShadowPassDepthMode():new be(u.gl.LEQUAL,be.ReadWrite,e.depthRangeFor3D),g=e.isTileAffectedByFog(s);if(n.meshes)for(const y of n.meshes){const v=["MODEL_POSITION_ON_GPU"],x=[];let w,E,M;r.instancedDataArray.length>20&&v.push("INSTANCED_ARRAYS");const D=kd(e,t.paint.get("model-cutoff-fade-range"));if(D.shouldRenderCutoff&&v.push("RENDER_CUTOFF"),d&&f)w=e.getOrCreateProgram("modelDepth",{defines:v}),E=AE(c.shadowTileMatrix,c.shadowTileMatrix,Float32Array.from(n.matrix)),M=f.getShadowPassColorMode();else{Ov(v,x,y,e),w=e.getOrCreateProgram("model",{defines:v,overrideFog:g});const P=y.material,C=P.pbrMetallicRoughness,R=t.paint.get("model-opacity"),k=t.paint.get("model-emissive-strength").constantOr(0);E=$g(s.expandedProjMatrix,Float32Array.from(n.matrix),new Float32Array(16),e,R,C.baseColorFactor,P.emissiveFactor,C.metallicFactor,C.roughnessFactor,P,k,t,o),f&&(c.shadowUniformsInitialized?w.setShadowUniformValues(u,f.getShadowUniformValues()):(f.setupShadows(s.toUnwrapped(),w,"model-tile",s.overscaledZ),c.shadowUniformsInitialized=!0)),M=D.shouldRenderCutoff||R<1||"OPAQUE"!==P.alphaMode?hn.alphaBlended:hn.unblended}e.uploadCommonUniforms(u,w,s.toUnwrapped(),null,D);const A=y.material.doubleSided?Ge.disabled:Ge.backCCW;if(r.instancedDataArray.length>20)x.push(r.instancedDataBuffer),w.draw(e,u.gl.TRIANGLES,m,$e.disabled,M,A,E,t.id,y.vertexBuffer,y.indexBuffer,y.segments,t.paint,e.transform.zoom,void 0,x,r.instancedDataArray.length);else{const P=d?"u_instance":"u_normal_matrix";for(let C=0;C<r.instancedDataArray.length;++C)E[P]=new Float32Array(r.instancedDataArray.arrayBuffer,64*C,16),w.draw(e,u.gl.TRIANGLES,m,$e.disabled,M,A,E,t.id,y.vertexBuffer,y.indexBuffer,y.segments,t.paint,e.transform.zoom,void 0,x)}}if(n.children)for(const y of n.children)lS(e,t,y,r,o,s,c)}const Op=[1,-1,1];function cS(e,t,n,r){if(!n.modelManager)return!0;const o=n.modelManager;if(!n.shadowRenderer)return!0;const s=n.shadowRenderer,c=t.aabb;let u=!0,d=e.maxHeight;if(0===d){let m=0;for(const g in e.instancesPerModel){const y=o.getModel(g,r);y?m=Math.max(m,Math.max(Math.max(y.aabb.max[0],y.aabb.max[1]),y.aabb.max[2])):u=!1}d=e.maxScale*m*1.41+e.maxVerticalOffset,u&&(e.maxHeight=d)}c.max[2]=d,c.min[2]+=e.terrainElevationMin,c.max[2]+=e.terrainElevationMax,Z.transformMat4(c.min,c.min,t.tileMatrix),Z.transformMat4(c.max,c.max,t.tileMatrix);const f=c.intersects(s.getCurrentCascadeFrustum());return 0===n.currentShadowCascade&&(e.isInsideFirstShadowMapFrustum=2===f),0===f}class Fv{}class uS{constructor(){this._storage=new Map}getLinesFromTrianglesBuffer(t,n,r){{const g=this._storage.get(n.id);if(g)return g.lastUsedFrameIdx=t,g.buf}const o=r.gl,s=o.getBufferParameter(o.ELEMENT_ARRAY_BUFFER,o.BUFFER_SIZE),c=new ArrayBuffer(s),u=new Int16Array(c);o.getBufferSubData(o.ELEMENT_ARRAY_BUFFER,0,new Int16Array(c));const d=new Tl;for(let g=0;g<s/2;g+=3){const y=u[g],v=u[g+1],x=u[g+2];d.emplaceBack(y,v),d.emplaceBack(v,x),d.emplaceBack(x,y)}const f=r.bindVertexArrayOES.current,m=new Fv;return m.buf=new Fu(r,d),m.lastUsedFrameIdx=t,this._storage.set(n.id,m),r.bindVertexArrayOES.set(f),m.buf}update(t){for(const[n,r]of this._storage)t-r.lastUsedFrameIdx>30&&(r.buf.destroy(),this._storage.delete(n))}destroy(){for(const[t,n]of this._storage)n.buf.destroy(),this._storage.delete(t)}}const Nv={symbol:function(e,t,n,r,o){if("translucent"!==e.renderPass)return;const s=$e.disabled,c=e.colorModeForRenderPass();n.layout.get("text-variable-anchor")&&function(u,d,f,m,g,y,v){const x=d.transform,w="map"===g,E="map"===y;for(const M of u){const D=m.getTile(M),A=D.getBucket(f);if(!A||!A.text||!A.text.segments.get().length)continue;const P=qa(A.textSizeData,x.zoom),C=Fg(M,A.getProjection(),x),R=x.calculatePixelsToTileUnitsMatrix(D),k=fp(C,D.tileID.canonical,E,w,x,A.getProjection(),R),N=A.hasIconTextFit()&&A.hasIconData();if(P){const z=Math.pow(2,x.zoom-D.tileID.overscaledZ);kE(A,w,E,v,fb,x,k,M,z,P,N)}}}(r,e,n,t,n.layout.get("text-rotation-alignment"),n.layout.get("text-pitch-alignment"),o),0!==n.paint.get("icon-opacity").constantOr(1)&&Mv(e,t,n,r,!1,n.paint.get("icon-translate"),n.paint.get("icon-translate-anchor"),n.layout.get("icon-rotation-alignment"),n.layout.get("icon-pitch-alignment"),n.layout.get("icon-keep-upright"),n.paint.get("icon-color-saturation"),s,c),0!==n.paint.get("text-opacity").constantOr(1)&&Mv(e,t,n,r,!0,n.paint.get("text-translate"),n.paint.get("text-translate-anchor"),n.layout.get("text-rotation-alignment"),n.layout.get("text-pitch-alignment"),n.layout.get("text-keep-upright"),n.paint.get("icon-color-saturation"),s,c),t.map.showCollisionBoxes&&(RE(e,t,n,r,n.paint.get("text-translate"),n.paint.get("text-translate-anchor"),!0),RE(e,t,n,r,n.paint.get("icon-translate"),n.paint.get("icon-translate-anchor"),!1))},circle:function(e,t,n,r){if("translucent"!==e.renderPass)return;const o=n.paint.get("circle-opacity"),s=n.paint.get("circle-stroke-width"),c=n.paint.get("circle-stroke-opacity"),u=void 0!==n.layout.get("circle-sort-key").constantOr(1),d=n.paint.get("circle-emissive-strength");if(0===o.constantOr(1)&&(0===s.constantOr(1)||0===c.constantOr(1)))return;const f=e.context,m=f.gl,g=e.transform,y=e.depthModeForSublayer(0,be.ReadOnly),v=$e.disabled,x=e.colorModeForDrapableLayerRenderPass(d),w="globe"===g.projection.name,E=[Br(g.center.lng),ui(g.center.lat)],M=[];for(let A=0;A<r.length;A++){const P=r[A],C=t.getTile(P),R=C.getBucket(n);if(!R||R.projection.name!==g.projection.name)continue;const k=R.programConfigurations.get(n.id),N=G1(n),z=e.isTileAffectedByFog(P);w&&N.push("PROJECTION_GLOBE_VIEW");const B=e.getOrCreateProgram("circle",{config:k,defines:N,overrideFog:z}),U=R.layoutVertexBuffer,$=R.globeExtVertexBuffer,W=R.indexBuffer,V=g.projection.createInversionMatrix(g,P.canonical),K={programConfiguration:k,program:B,layoutVertexBuffer:U,globeExtVertexBuffer:$,indexBuffer:W,uniformValues:Uh(e,P,C,V,E,n),tile:C};if(u){const Q=R.segments.get();for(const ot of Q)M.push({segments:new Rn([ot]),sortKey:ot.sortKey,state:K})}else M.push({segments:R.segments,sortKey:0,state:K})}u&&M.sort((A,P)=>A.sortKey-P.sortKey);const D={useDepthForOcclusion:g.depthOcclusionForSymbolsAndCircles};for(const A of M){const{programConfiguration:P,program:C,layoutVertexBuffer:R,globeExtVertexBuffer:k,indexBuffer:N,uniformValues:z,tile:B}=A.state,U=A.segments;e.terrain&&e.terrain.setupElevationDraw(B,C,D),e.uploadCommonUniforms(f,C,B.tileID.toUnwrapped()),C.draw(e,m.TRIANGLES,y,v,x,Ge.disabled,z,n.id,R,N,U,n.paint,g.zoom,P,[k])}},heatmap:function(e,t,n,r){if(0!==n.paint.get("heatmap-opacity"))if("offscreen"===e.renderPass){const o=e.context,s=o.gl,c=$e.disabled,u=new hn([s.ONE,s.ONE,s.ONE,s.ONE],ke.transparent,[!0,!0,!0,!0]);(function(v,x,w,E){const M=v.gl,D=x.width*E,A=x.height*E;v.activeTexture.set(M.TEXTURE1),v.viewport.set([0,0,D,A]);let P=w.heatmapFbo;if(!P||P&&(P.width!==D||P.height!==A)){P&&P.destroy();const C=M.createTexture();M.bindTexture(M.TEXTURE_2D,C),M.texParameteri(M.TEXTURE_2D,M.TEXTURE_WRAP_S,M.CLAMP_TO_EDGE),M.texParameteri(M.TEXTURE_2D,M.TEXTURE_WRAP_T,M.CLAMP_TO_EDGE),M.texParameteri(M.TEXTURE_2D,M.TEXTURE_MIN_FILTER,M.LINEAR),M.texParameteri(M.TEXTURE_2D,M.TEXTURE_MAG_FILTER,M.LINEAR),P=w.heatmapFbo=v.createFramebuffer(D,A,!0,null),function(R,k,N,z,B,U){const $=R.gl;$.texImage2D($.TEXTURE_2D,0,R.extRenderToTextureHalfFloat?$.RGBA16F:$.RGBA,B,U,0,$.RGBA,R.extRenderToTextureHalfFloat?$.HALF_FLOAT:$.UNSIGNED_BYTE,null),z.colorAttachment.set(N)}(v,0,C,P,D,A)}else M.bindTexture(M.TEXTURE_2D,P.colorAttachment.get()),v.bindFramebuffer.set(P.framebuffer)})(o,e,n,"globe"===e.transform.projection.name?.5:.25),o.clear({color:ke.transparent});const d=e.transform,f="globe"===d.projection.name,m=f?["PROJECTION_GLOBE_VIEW"]:[],g=f?Ge.frontCCW:Ge.disabled,y=[Br(d.center.lng),ui(d.center.lat)];for(let v=0;v<r.length;v++){const x=r[v];if(t.hasRenderableParent(x))continue;const w=t.getTile(x),E=w.getBucket(n);if(!E||E.projection.name!==d.projection.name)continue;const M=e.isTileAffectedByFog(x),D=E.programConfigurations.get(n.id),A=e.getOrCreateProgram("heatmap",{config:D,defines:m,overrideFog:M}),{zoom:P}=e.transform;e.terrain&&e.terrain.setupElevationDraw(w,A),e.uploadCommonUniforms(o,A,x.toUnwrapped());const C=d.projection.createInversionMatrix(d,x.canonical);A.draw(e,s.TRIANGLES,be.disabled,c,u,g,jC(e,x,w,C,y,P,n.paint.get("heatmap-intensity")),n.id,E.layoutVertexBuffer,E.indexBuffer,E.segments,n.paint,e.transform.zoom,D,f?[E.globeExtVertexBuffer]:null)}o.viewport.set([0,0,e.width,e.height])}else"translucent"===e.renderPass&&(e.context.setColorMode(e.colorModeForRenderPass()),function(o,s){const c=o.context,u=c.gl,d=s.heatmapFbo;if(!d)return;c.activeTexture.set(u.TEXTURE0),u.bindTexture(u.TEXTURE_2D,d.colorAttachment.get()),c.activeTexture.set(u.TEXTURE1);let f=s.colorRampTexture;f||(f=s.colorRampTexture=new hr(c,s.colorRamp,u.RGBA)),f.bind(u.LINEAR,u.CLAMP_TO_EDGE),o.getOrCreateProgram("heatmapTexture").draw(o,u.TRIANGLES,be.disabled,$e.disabled,o.colorModeForRenderPass(),Ge.disabled,{u_image:0,u_color_ramp:1,u_opacity:s.paint.get("heatmap-opacity")},s.id,o.viewportBuffer,o.quadTriangleIndexBuffer,o.viewportSegments,s.paint,o.transform.zoom)}(e,n))},line:function(e,t,n,r){if("translucent"!==e.renderPass)return;const o=n.paint.get("line-opacity"),s=n.paint.get("line-width");if(0===o.constantOr(1)||0===s.constantOr(1))return;const c=n.paint.get("line-emissive-strength"),u=e.depthModeForSublayer(0,be.ReadOnly),d=e.colorModeForDrapableLayerRenderPass(c),f=e.terrain&&e.terrain.renderingToTexture?1:De.devicePixelRatio,m=n.paint.get("line-dasharray"),g=m.constantOr(1),y=n.layout.get("line-cap"),v=n.paint.get("line-pattern"),x=v.constantOr(1),w=n.paint.get("line-pattern").constantOr(1),E=1!==n.paint.get("line-opacity").constantOr(1);let M=!w&&E;const D=n.paint.get("line-gradient"),A=x?"linePattern":"line",P=e.context,C=P.gl,R=Rw(n);e.terrain&&e.terrain.clipOrMaskOverlapStencilType()&&(M=!1);for(const k of r){const N=t.getTile(k);if(x&&!N.patternsLoaded())continue;const z=N.getBucket(n);if(!z)continue;e.prepareDrawTile();const B=z.programConfigurations.get(n.id),U=e.isTileAffectedByFog(k),$=e.getOrCreateProgram(A,{config:B,defines:R,overrideFog:U}),W=v.constantOr(null);if(W&&N.imageAtlas){const dt=N.imageAtlas.patternPositions[W.toString()];dt&&B.setConstantPatternPositions(dt)}const V=m.constantOr(null),K=y.constantOr(null);if(!x&&V&&K&&N.lineAtlas){const dt=N.lineAtlas.getDash(V,K);dt&&B.setConstantPatternPositions(dt)}let[Q,ot]=n.paint.get("line-trim-offset");("round"===K||"square"===K)&&Q!==ot&&(0===Q&&(Q-=1),1===ot&&(ot+=1));const Y=e.terrain?k.projMatrix:null,J=x?Aw(e,N,n,Y,f):Cw(e,N,n,Y,z.lineClipsArray.length,f,[Q,ot]);if(D){const dt=z.gradients[n.id];let ht=dt.texture;if(n.gradientVersion!==dt.version){let _t=256;if(n.stepInterpolant){const vt=t.getSource().maxzoom,xt=k.canonical.z===vt?Math.ceil(1<<e.transform.maxZoom-k.canonical.z):1;_t=ne(Fc(z.maxLineLength/et*1024*xt),256,P.maxTextureSize)}dt.gradient=qm({expression:n.gradientExpression(),evaluationKey:"lineProgress",resolution:_t,image:dt.gradient||void 0,clips:z.lineClipsArray}),dt.texture?dt.texture.update(dt.gradient):dt.texture=new hr(P,dt.gradient,C.RGBA),dt.version=n.gradientVersion,ht=dt.texture}P.activeTexture.set(C.TEXTURE1),ht.bind(n.stepInterpolant?C.NEAREST:C.LINEAR,C.CLAMP_TO_EDGE)}g&&(P.activeTexture.set(C.TEXTURE0),N.lineAtlasTexture&&N.lineAtlasTexture.bind(C.LINEAR,C.REPEAT),B.updatePaintBuffers()),x&&(P.activeTexture.set(C.TEXTURE0),N.imageAtlasTexture&&N.imageAtlasTexture.bind(C.LINEAR,C.CLAMP_TO_EDGE),B.updatePaintBuffers()),e.uploadCommonUniforms(P,$,k.toUnwrapped());const ct=dt=>{$.draw(e,C.TRIANGLES,u,dt,d,Ge.disabled,J,n.id,z.layoutVertexBuffer,z.indexBuffer,z.segments,n.paint,e.transform.zoom,B,[z.layoutVertexBuffer2])};if(M){const dt=e.stencilModeForClipping(k).ref;0===dt&&e.terrain&&P.clear({stencil:0});const ht={func:C.EQUAL,mask:255};J.u_alpha_discard_threshold=.8,ct(new $e(ht,dt,255,C.KEEP,C.KEEP,C.INVERT)),J.u_alpha_discard_threshold=0,ct(new $e(ht,dt,255,C.KEEP,C.KEEP,C.KEEP))}else ct(e.stencilModeForClipping(k))}M&&(e.resetStencilClippingMasks(),e.terrain&&P.clear({stencil:0}))},fill:function(e,t,n,r){const o=n.paint.get("fill-color"),s=n.paint.get("fill-opacity");if(0===s.constantOr(1))return;const c=n.paint.get("fill-emissive-strength"),u=e.colorModeForDrapableLayerRenderPass(c),d=n.paint.get("fill-pattern"),f=e.opaquePassEnabledForLayer()&&!d.constantOr(1)&&1===o.constantOr(ke.transparent).a&&1===s.constantOr(0)?"opaque":"translucent";if(e.renderPass===f){const m=e.depthModeForSublayer(1,"opaque"===e.renderPass?be.ReadWrite:be.ReadOnly);Dv(e,t,n,r,m,u,!1)}if("translucent"===e.renderPass&&n.paint.get("fill-antialias")){const m=e.depthModeForSublayer(n.getPaintProperty("fill-outline-color")?2:0,be.ReadOnly);Dv(e,t,n,r,m,u,!0)}},"fill-extrusion":function(e,t,n,r){const o=n.paint.get("fill-extrusion-opacity"),s=e.context,c=s.gl,u=e.terrain,d=u&&u.renderingToTexture,f=n.paint.get("fill-extrusion-cutoff-fade-range");if(0===o)return;const m=e.conflationActive&&e.layerUsedInConflation(n,t.getSource());if(m&&function(g,y,v,x){for(const w of x){const E=y.getTile(w).getBucket(v);E&&(E.updateReplacement(w,g.replacementSource),E.uploadCentroid(g.context))}}(e,t,n,r),u||m)for(const g of r){const y=t.getTile(g).getBucket(n);y&&QD(e.context,t,g,y,n,u,m)}if("shadow"===e.renderPass&&e.shadowRenderer){const g=e.shadowRenderer;if(u&&o<.65&&n._transitionablePaint._values["fill-extrusion-opacity"].value.expression instanceof vl)return;const y=g.getShadowPassDepthMode(),v=g.getShadowPassColorMode();Lp(e,t,n,r,y,$e.disabled,v,m)}else if("translucent"===e.renderPass){const g=!n.paint.get("fill-extrusion-pattern").constantOr(1);if(!d){const y=new be(e.context.gl.LEQUAL,be.ReadWrite,e.depthRangeFor3D);0===f&&1===o&&g?Lp(e,t,n,r,y,$e.disabled,hn.unblended,m):(Lp(e,t,n,r,y,$e.disabled,hn.disabled,m),Lp(e,t,n,r,y,e.stencilModeFor3D(),e.colorModeForRenderPass(),m),e.resetStencilClippingMasks())}if(e.style.enable3dLights()&&g&&(!u&&"globe"!==e.transform.projection.name||d)){const y=n.paint.get("fill-extrusion-opacity"),v=n.paint.get("fill-extrusion-ambient-occlusion-intensity"),x=n.paint.get("fill-extrusion-ambient-occlusion-ground-radius"),w=n.paint.get("fill-extrusion-flood-light-intensity"),E=n.paint.get("fill-extrusion-flood-light-color").toArray01().slice(0,3),M=v>0&&x>0,D=w>0,A=(C,R,k)=>(1-k)*C+k*R,P=C=>{const R=e.depthModeForSublayer(1,be.ReadOnly,c.LEQUAL,!0),k=n.paint.get(C?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),N=A(.1,3,k),z=e._showOverdrawInspector;if(!z){const B=new $e({func:c.ALWAYS,mask:255},255,255,c.KEEP,c.KEEP,c.REPLACE),U=new hn([c.ONE,c.ONE,c.ONE,c.ONE],ke.transparent,[!1,!1,!1,!0],c.MIN);Bd(e,t,n,r,R,B,U,Ge.disabled,C,"sdf",y,v,x,w,E,N,m,!1)}{const B=z?$e.disabled:new $e({func:c.EQUAL,mask:255},255,255,c.KEEP,c.DECR,c.DECR),U=z?e.colorModeForRenderPass():new hn([c.ONE_MINUS_DST_ALPHA,c.DST_ALPHA,c.ONE,c.ONE],ke.transparent,[!0,!0,!0,!0]);Bd(e,t,n,r,R,B,U,Ge.disabled,C,"color",y,v,x,w,E,N,m,!1)}};if(d){const C=(R,k,N)=>{const z=e.depthModeForSublayer(1,be.ReadOnly,c.LEQUAL,!1),B=n.paint.get(R?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),U=A(.1,3,B);{const $=new hn([c.ONE,c.ONE,c.ONE,c.ONE],ke.transparent,[!1,!1,!1,!0]);Bd(e,t,n,r,z,$e.disabled,$,Ge.disabled,R,"clear",y,v,x,w,E,U,m,k)}{const $=new $e({func:c.ALWAYS,mask:255},255,255,c.KEEP,c.KEEP,c.REPLACE),W=new hn([c.ONE,c.ONE,c.ONE,c.ONE],ke.transparent,[!1,!1,!1,!0],c.MIN);Bd(e,t,n,r,z,$,W,Ge.disabled,R,"sdf",y,v,x,w,E,U,m,k)}{const $=R?c.ZERO:c.ONE_MINUS_DST_ALPHA,W=new $e({func:c.EQUAL,mask:255},255,255,c.KEEP,c.DECR,c.DECR),V=new hn([$,c.DST_ALPHA,c.ONE_MINUS_DST_ALPHA,c.ZERO],ke.transparent,[!0,!0,!0,!0]);Bd(e,t,n,r,z,W,V,Ge.disabled,R,"color",y,v,x,w,E,U,m,k)}{const $=new hn([c.ONE,c.ONE,c.ONE,R?c.ZERO:c.ONE],ke.transparent,[!1,!1,!1,!0],R?c.FUNC_ADD:c.MAX);Bd(e,t,n,r,z,$e.disabled,$,Ge.disabled,R,"clear",y,v,x,w,E,U,m,k,N)}};if(M||D){let R;if(e.prepareDrawTile(),u){const k=u.drapeBufferSize[0],N=u.drapeBufferSize[1];R=u.framebufferCopyTexture,R&&(!R||R.size[0]===k&&R.size[1]===N)||(R&&R.destroy(),R=u.framebufferCopyTexture=new hr(s,new $r({width:k,height:N}),c.RGBA)),R.bind(c.LINEAR,c.CLAMP_TO_EDGE),c.copyTexImage2D(c.TEXTURE_2D,0,c.RGBA,0,0,k,N,0)}M&&C(!0,!1,R),D&&C(!1,!0,R)}}else M&&P(!0),D&&P(!1)}}},hillshade:function(e,t,n,r){if("offscreen"!==e.renderPass&&"translucent"!==e.renderPass||e.style.disableElevatedTerrain)return;const o=e.context,s=e.terrain&&e.terrain.renderingToTexture,[c,u]="translucent"!==e.renderPass||s?[{},r]:e.stencilConfigForOverlap(r);for(const d of u){const f=t.getTile(d);if(f.needsHillshadePrepare&&"offscreen"===e.renderPass)FD(e,f,n);else if("translucent"===e.renderPass){const m=e.depthModeForSublayer(0,be.ReadOnly),g=n.paint.get("hillshade-emissive-strength"),y=e.colorModeForDrapableLayerRenderPass(g),v=s&&e.terrain?e.terrain.stencilModeForRTTOverlap(d):c[d.overscaledZ];BC(e,d,f,n,m,v,y)}}o.viewport.set([0,0,e.width,e.height]),e.resetStencilClippingMasks()},raster:function(e,t,n,r,o,s){if("translucent"!==e.renderPass||0===n.paint.get("raster-opacity"))return;const c=e.context,u=c.gl,d=t.getSource(),f=function(k,N,z){const B=k.paint.get("raster-color"),U=[],$=k.paint.get("raster-resampling"),W=k.paint.get("raster-color-mix"),V=k.paint.get("raster-color-range"),K=[W[0],W[1],W[2],0],Q=W[3],ot="nearest"===$?z.NEAREST:z.LINEAR;if(B&&U.push("RASTER_COLOR"),B){N.activeTexture.set(z.TEXTURE2);let Y=k.colorRampTexture;Y||(Y=k.colorRampTexture=new hr(N,k.colorRamp,z.RGBA)),Y.bind(z.LINEAR,z.CLAMP_TO_EDGE)}return{mix:K,range:V,offset:Q,defines:U,resampling:ot}}(n,c,u),m=f.defines,g="globe"===e.transform.projection.name;let y=!1;if(d instanceof $s&&!r.length){if(!g)return;if(d.onNorthPole)y=!0,m.push("GLOBE_POLES");else{if(!d.onSouthPole)return;y=!0,m.push("GLOBE_POLES")}}const v=n.paint.get("raster-emissive-strength"),x=e.colorModeForDrapableLayerRenderPass(v),w=e.terrain&&e.terrain.renderingToTexture,E=d instanceof $s&&0!==n.paint.get("raster-elevation"),M=!e.options.moving,D="nearest"===n.paint.get("raster-resampling")?u.NEAREST:u.LINEAR;if(y){const k=t.getSource();if(!(k instanceof $s))return;const N=k.texture;if(!N)return;const z=e.globeSharedBuffers;if(!z)return;const B=new be(u.LEQUAL,be.ReadWrite,e.depthRangeFor3D),U=Float32Array.from(e.transform.expandedFarZProjMatrix);let $=Va(0,0,e.transform);const W=Float32Array.from(mu(bs(new xs(0,0,0)))),V={opacity:1,mix:0};e.terrain&&e.terrain.prepareDrawTile(),c.activeTexture.set(u.TEXTURE0),N.bind(D,u.CLAMP_TO_EDGE),c.activeTexture.set(u.TEXTURE1),N.bind(D,u.CLAMP_TO_EDGE),N.useMipmap&&c.extTextureFilterAnisotropic&&e.transform.pitch>20&&u.texParameterf(u.TEXTURE_2D,c.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,c.extTextureFilterAnisotropicMax);const[K,Q,ot,Y]=z.getPoleBuffers(0,!0);let J;k.onNorthPole?(J=K,e.renderDefaultNorthPole=!1):($=st.scale(st.create(),$,[1,-1,1]),J=Q,e.renderDefaultSouthPole=!1);const ct=(ht=U,_t=W,vt=$,xt=V,mt=n,Ct=k.perspectiveTransform||[0,0],Ut=n.paint.get("raster-elevation"),Yt=f.mix,te=f.offset,Me=f.range,ue=v,tl(ht,_t,vt,new Float32Array(16),new Float32Array(9),[0,0],[0,0,0,0],0,[0,0],[0,0,0,0],1,xt,mt,Ct||[0,0],Ut,2,Yt,te,Me,1,0,ue)),dt=e.getOrCreateProgram("raster",{defines:f.defines});return e.uploadCommonUniforms(c,dt,null),void dt.draw(e,u.TRIANGLES,B,$e.disabled,x,Ge.disabled,ct,n.id,J,ot,Y)}var ht,_t,vt,xt,mt,Ct,Ut,Yt,te,Me,ue;if(!r.length)return;const[A,P]=d instanceof $s||w?[{},r]:e.stencilConfigForOverlap(r),C=P[P.length-1].overscaledZ,R=E&&g;R&&f.defines.push("PROJECTION_GLOBE_VIEW"),E&&f.defines.push("RENDER_CUTOFF");for(const k of P){const N=k.toUnwrapped(),z=t.getTile(k);if(w&&(!z||!z.hasData())||!z.texture)continue;let B,U;w?(B=be.disabled,U=k.projMatrix):E?(B=new be(u.LEQUAL,be.ReadWrite,e.depthRangeFor3D),U=g?Float32Array.from(e.transform.expandedFarZProjMatrix):e.transform.calculateProjMatrix(N,M)):(B=e.depthModeForSublayer(k.overscaledZ-C,1===n.paint.get("raster-opacity")?be.ReadWrite:be.ReadOnly,u.LESS),U=e.transform.calculateProjMatrix(N,M));const $=e.terrain&&w?e.terrain.stencilModeForRTTOverlap(k):A[k.overscaledZ],W=s?0:n.paint.get("raster-fade-duration");z.registerFadeDuration(W);const V=t.findLoadedParent(k,0),K=Nd(z,V,t,e.transform,W);let Q,ot;e.terrain&&e.terrain.prepareDrawTile(),c.activeTexture.set(u.TEXTURE0),z.texture&&z.texture.bind(D,u.CLAMP_TO_EDGE),c.activeTexture.set(u.TEXTURE1),V?(V.texture&&V.texture.bind(D,u.CLAMP_TO_EDGE),Q=Math.pow(2,V.tileID.overscaledZ-z.tileID.overscaledZ),ot=[z.tileID.canonical.x*Q%1,z.tileID.canonical.y*Q%1]):z.texture&&z.texture.bind(D,u.CLAMP_TO_EDGE),z.texture&&z.texture.useMipmap&&c.extTextureFilterAnisotropic&&e.transform.pitch>20&&u.texParameterf(u.TEXTURE_2D,c.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,c.extTextureFilterAnisotropicMax);const Y=e.transform,J=d instanceof $s?d.perspectiveTransform:[0,0],ct=E?Pv(Y):[0,0,0,0];let dt,ht,_t,vt,xt,mt;if(R&&d instanceof $s&&d.coordinates.length>3){dt=Float32Array.from(mu(bs(new xs(0,0,0)))),ht=Float32Array.from(Y.globeMatrix),_t=Float32Array.from(F1(Y)),vt=[Br(Y.center.lng),ui(Y.center.lat)],mt=[Br(d.coordinates[1][0]),ui(d.coordinates[1][1]),Br(d.coordinates[3][0]),ui(d.coordinates[3][1])];const Yt=new Oi(d.coordinates[1],d.coordinates[3]);xt=Float32Array.from(dy(new xs(0,0,0),Yt,0,Y.worldSize/e.transform._pixelsPerMercatorPixel))}else dt=new Float32Array(16),ht=new Float32Array(9),_t=new Float32Array(16),vt=[0,0],xt=new Float32Array(16),mt=[0,0,0,0];const Ct=tl(U,dt,ht,_t,xt,ot||[0,0],mt,ri(e.transform.zoom),vt,ct,Q||1,K,n,J,E?n.paint.get("raster-elevation"):0,2,f.mix,f.offset,f.range,1,0,v),Ut=e.isTileAffectedByFog(k),Gt=e.getOrCreateProgram("raster",{defines:f.defines,overrideFog:Ut});if(e.uploadCommonUniforms(c,Gt,N),d instanceof $s){if(w||!g)d.boundsBuffer&&d.boundsSegments&&Gt.draw(e,u.TRIANGLES,B,$e.disabled,x,Ge.disabled,Ct,n.id,d.boundsBuffer,e.quadTriangleIndexBuffer,d.boundsSegments);else if(e.globeSharedBuffers){const[Yt,te,Me]=e.globeSharedBuffers.getGridBuffers(0,!1);Gt.draw(e,u.TRIANGLES,B,$e.disabled,x,Ge.frontCCW,Ct,n.id,Yt,te,Me),Gt.draw(e,u.TRIANGLES,B,$e.disabled,x,Ge.backCCW,Ct,n.id,Yt,te,Me)}}else{const{tileBoundsBuffer:Yt,tileBoundsIndexBuffer:te,tileBoundsSegments:Me}=e.getTileBoundsBuffers(z);Gt.draw(e,u.TRIANGLES,B,$,x,Ge.disabled,Ct,n.id,Yt,te,Me)}}e.resetStencilClippingMasks()},background:function(e,t,n,r){const o=n.paint.get("background-color"),s=n.paint.get("background-opacity"),c=n.paint.get("background-emissive-strength");if(0===s)return;const u=e.context,d=u.gl,f=e.transform,m=f.tileSize,g=n.paint.get("background-pattern");if(e.isPatternMissing(g,n.scope))return;const y=!g&&1===o.a&&1===s&&e.opaquePassEnabledForLayer()?"opaque":"translucent";if(e.renderPass!==y)return;const v=$e.disabled,x=e.depthModeForSublayer(0,"opaque"===y?be.ReadWrite:be.ReadOnly),w=e.colorModeForDrapableLayerRenderPass(c),E=g?"backgroundPattern":"background";let M,D=r;D||(M=e.getBackgroundTiles(),D=Object.values(M).map(A=>A.tileID)),g&&(u.activeTexture.set(d.TEXTURE0),e.imageManager.bind(e.context,n.scope));for(const A of D){const P=e.isTileAffectedByFog(A),C=e.getOrCreateProgram(E,{overrideFog:P}),R=A.toUnwrapped(),k=r?A.projMatrix:e.transform.calculateProjMatrix(R);e.prepareDrawTile();const N=t?t.getTile(A):M?M[A.key]:new Ya(A,m,f.zoom,e),z=g?JD(k,c,s,e,g,n.scope,{tileID:A,tileSize:m}):Gg(k,c,s,o);e.uploadCommonUniforms(u,C,R);const{tileBoundsBuffer:B,tileBoundsIndexBuffer:U,tileBoundsSegments:$}=e.getTileBoundsBuffers(N);C.draw(e,d.TRIANGLES,x,v,w,Ge.disabled,z,n.id,B,U,$)}},sky:function(e,t,n){const r=e._atmosphere?ri(e.transform.zoom):1,o=n.paint.get("sky-opacity")*r;if(0===o)return;const s=e.context,c=n.paint.get("sky-type"),u=new be(s.gl.LEQUAL,be.ReadOnly,[0,1]),d=e.frameCounter/1e3%1;"atmosphere"===c?"offscreen"===e.renderPass?n.needsSkyboxCapture(e)&&(function(f,m,g,y){const v=f.context,x=v.gl;let w=m.skyboxFbo;if(!w){w=m.skyboxFbo=v.createFramebuffer(32,32,!0,null),m.skyboxGeometry=new Lv(v),m.skyboxTexture=v.gl.createTexture(),x.bindTexture(x.TEXTURE_CUBE_MAP,m.skyboxTexture),x.texParameteri(x.TEXTURE_CUBE_MAP,x.TEXTURE_WRAP_S,x.CLAMP_TO_EDGE),x.texParameteri(x.TEXTURE_CUBE_MAP,x.TEXTURE_WRAP_T,x.CLAMP_TO_EDGE),x.texParameteri(x.TEXTURE_CUBE_MAP,x.TEXTURE_MIN_FILTER,x.LINEAR),x.texParameteri(x.TEXTURE_CUBE_MAP,x.TEXTURE_MAG_FILTER,x.LINEAR);for(let A=0;A<6;++A)x.texImage2D(x.TEXTURE_CUBE_MAP_POSITIVE_X+A,0,x.RGBA,32,32,0,x.RGBA,x.UNSIGNED_BYTE,null)}v.bindFramebuffer.set(w.framebuffer),v.viewport.set([0,0,32,32]);const E=m.getCenter(f,!0),M=f.getOrCreateProgram("skyboxCapture"),D=new Float64Array(16);st.identity(D),st.rotateY(D,D,.5*-Math.PI),jd(f,m,M,D,E,0),st.identity(D),st.rotateY(D,D,.5*Math.PI),jd(f,m,M,D,E,1),st.identity(D),st.rotateX(D,D,.5*-Math.PI),jd(f,m,M,D,E,2),st.identity(D),st.rotateX(D,D,.5*Math.PI),jd(f,m,M,D,E,3),st.identity(D),jd(f,m,M,D,E,4),st.identity(D),st.rotateY(D,D,Math.PI),jd(f,m,M,D,E,5),v.viewport.set([0,0,f.width,f.height])}(e,n),n.markSkyboxValid(e)):"sky"===e.renderPass&&function(f,m,g,y,v){const x=f.context,w=x.gl,E=f.transform,M=f.getOrCreateProgram("skybox");x.activeTexture.set(w.TEXTURE0),w.bindTexture(w.TEXTURE_CUBE_MAP,m.skyboxTexture);const D={u_matrix:E.skyboxMatrix,u_sun_direction:m.getCenter(f,!1),u_cubemap:0,u_opacity:y,u_temporal_offset:v};f.uploadCommonUniforms(x,M),M.draw(f,w.TRIANGLES,g,$e.disabled,f.colorModeForRenderPass(),Ge.backCW,D,"skybox",m.skyboxGeometry.vertexBuffer,m.skyboxGeometry.indexBuffer,m.skyboxGeometry.segment)}(e,n,u,o,d):"gradient"===c&&"sky"===e.renderPass&&function(f,m,g,y,v){const x=f.context,w=x.gl,E=f.transform,M=f.getOrCreateProgram("skyboxGradient");m.skyboxGeometry||(m.skyboxGeometry=new Lv(x)),x.activeTexture.set(w.TEXTURE0);let D=m.colorRampTexture;D||(D=m.colorRampTexture=new hr(x,m.colorRamp,w.RGBA)),D.bind(w.LINEAR,w.CLAMP_TO_EDGE);const A=(k=y,N=v,{u_matrix:E.skyboxMatrix,u_color_ramp:0,u_center_direction:m.getCenter(f,!1),u_radius:Oe(m.paint.get("sky-gradient-radius")),u_opacity:k,u_temporal_offset:N});var k,N;f.uploadCommonUniforms(x,M),M.draw(f,w.TRIANGLES,g,$e.disabled,f.colorModeForRenderPass(),Ge.backCW,A,"skyboxGradient",m.skyboxGeometry.vertexBuffer,m.skyboxGeometry.indexBuffer,m.skyboxGeometry.segment)}(e,n,u,o,d)},debug:function(e,t,n){for(let r=0;r<n.length;r++)Rv(e,t,n[r])},custom:function(e,t,n,r){const o=e.context,s=n.implementation;if(!e.transform.projection.unsupportedLayers||!e.transform.projection.unsupportedLayers.includes("custom")||e.terrain&&(e.terrain.renderingToTexture||"offscreen"===e.renderPass)&&n.isLayerDraped(t)){if("offscreen"===e.renderPass){const c=s.prerender;if(c){if(e.setCustomLayerDefaults(),o.setColorMode(e.colorModeForRenderPass()),"globe"===e.transform.projection.name){const u=e.transform.pointMerc;c.call(s,o.gl,e.transform.customLayerMatrix(),e.transform.getProjection(),e.transform.globeToMercatorMatrix(),ri(e.transform.zoom),[u.x,u.y],e.transform.pixelsPerMeterRatio)}else c.call(s,o.gl,e.transform.customLayerMatrix());o.setDirty(),e.setBaseState()}}else if("translucent"===e.renderPass){if(e.terrain&&e.terrain.renderingToTexture){const u=s.renderToTile;if(u){const d=r[0].canonical,f=new Qe(d.x+r[0].wrap*(1<<d.z),d.y,d.z);o.setDepthMode(be.disabled),o.setStencilMode($e.disabled),o.setColorMode(e.colorModeForRenderPass()),e.setCustomLayerDefaults(),u.call(s,o.gl,f),o.setDirty(),e.setBaseState()}return}e.setCustomLayerDefaults(),o.setColorMode(e.colorModeForRenderPass()),o.setStencilMode($e.disabled);const c="3d"===s.renderingMode?new be(e.context.gl.LEQUAL,be.ReadWrite,e.depthRangeFor3D):e.depthModeForSublayer(0,be.ReadOnly);if(o.setDepthMode(c),"globe"===e.transform.projection.name){const u=e.transform.pointMerc;s.render(o.gl,e.transform.customLayerMatrix(),e.transform.getProjection(),e.transform.globeToMercatorMatrix(),ri(e.transform.zoom),[u.x,u.y],e.transform.pixelsPerMeterRatio)}else s.render(o.gl,e.transform.customLayerMatrix());o.setDirty(),e.setBaseState(),o.bindFramebuffer.set(null)}}else nt("Custom layers are not yet supported with this projection. Use mercator or globe to enable usage of custom layers.")},model:function(e,t,n,r){if("opaque"===e.renderPass)return;const o=n.paint.get("model-opacity");if(0===o)return;const s=n.paint.get("model-cast-shadows");if("shadow"===e.renderPass&&(!s||e.terrain&&o<.65&&n._transitionablePaint._values["model-opacity"].value.expression instanceof vl))return;const c=e.shadowRenderer,u=n.paint.get("model-receive-shadows");c&&(c.useNormalOffset=!0,u||(c.enabled=!1));const d=()=>{c&&(c.useNormalOffset=!0,u||(c.enabled=!0))},f=t.getSource();if("light-beam"===e.renderPass&&"batched-model"!==f.type)return;if("vector"===f.type||"geojson"===f.type)return function(M,D,A,P){const C=M.transform;if("mercator"!==C.projection.name)return void nt(`Drawing 3D models for ${C.projection.name} projection is not yet implemented`);const R=C.getFreeCameraOptions().position;if(!M.modelManager)return;const k=M.modelManager,N=M.shadowRenderer;if(!A._unevaluatedLayout._values.hasOwnProperty("model-id"))return;const z=A._unevaluatedLayout._values["model-id"],B={...A.layout.get("model-id").parameters};for(const U of P){const $=D.getTile(U).getBucket(A);if(!$||$.projection.name!==C.projection.name)continue;const W=VC(U,C);B.zoom=W;const V=z.possiblyEvaluate(B);if(UE(M,$,U),jl.shadowUniformsInitialized=!1,jl.useSingleShadowCascade=!!N&&0===N.getMaxCascadeForTile(U.toUnwrapped()),"shadow"===M.renderPass&&N){if(1===M.currentShadowCascade&&$.isInsideFirstShadowMapFrustum)continue;const ot=C.calculatePosMatrix(U.toUnwrapped(),C.worldSize);if(jl.tileMatrix.set(ot),jl.shadowTileMatrix=Float32Array.from(N.calculateShadowPassMatrixFromMatrix(ot)),jl.aabb.min.fill(0),jl.aabb.max[0]=jl.aabb.max[1]=et,jl.aabb.max[2]=0,cS($,jl,M,A.scope))continue}const K=1<<U.canonical.z,Q=[((R.x-U.wrap)*K-U.canonical.x)*et,(R.y*K-U.canonical.y)*et,R.z*K*et];for(let ot in $.instancesPerModel){const Y=$.instancesPerModel[ot];Y.features.length>0&&(ot=V.evaluate(Y.features[0].feature,{}));const J=k.getModel(ot,A.scope);if(J&&J.uploaded)for(const ct of J.nodes)lS(M,A,ct,Y,Q,U,jl)}}}(e,t,n,r),void d();if(!f.loaded())return;if("batched-model"===f.type)return function(M,D,A,P){const C=M.context,R=M.transform,k=M.style.fog,N=M.shadowRenderer;if("mercator"!==R.projection.name)return void nt(`Drawing 3D landmark models for ${R.projection.name} projection is not yet implemented`);const z=M.transform.getFreeCameraOptions().position,B=Z.scale([],[z.x,z.y,z.z],M.transform.worldSize);Z.negate(B,B);const U=st.identity([]),$=Pl(R.center.lat,R.zoom),W=st.fromScaling([],[1,1,1/$]);st.translate(U,U,B);const V=A.paint.get("model-opacity"),K=new be(C.gl.LEQUAL,be.ReadWrite,M.depthRangeFor3D),Q=new be(C.gl.LEQUAL,be.ReadOnly,M.depthRangeFor3D),ot=function(Y,J){for(const ct of P){const dt=D.getTile(ct).getBucket(A);if(!dt||!dt.uploaded)continue;let ht=!1;N&&(ht=0===N.getMaxCascadeForTile(ct.toUnwrapped()));const _t=R.calculatePosMatrix(ct.toUnwrapped(),R.worldSize),vt=dt.modelTraits;for(const xt of dt.getNodesInfo()){if(xt.hiddenByReplacement||!xt.node.meshes)continue;const mt=xt.node,Ct="light-beam"===M.renderPass,Ut=[..._t],Gt=xt.evaluatedScale;let Yt=0;M.terrain&&mt.elevation&&(Yt=mt.elevation*M.terrain.exaggeration()),st.translate(Ut,Ut,[(mt.anchor?mt.anchor[0]:0)*(Gt[0]-1),(mt.anchor?mt.anchor[1]:0)*(Gt[1]-1),Yt]),Gt!==Ac&&st.scale(Ut,Ut,Gt),st.multiply(Ut,Ut,mt.matrix);const te=st.multiply([],W,Ut);st.multiply(te,U,te);const Me=st.invert([],te);st.transpose(Me,Me),st.scale(Me,Me,Op);const ue=st.multiply([],R.expandedFarZProjMatrix,Ut);for(let dn=0;dn<mt.meshes.length;++dn){const Ye=mt.meshes[dn],Ie=dn===mt.lightMeshIndex;if(Ie){if(!Ct&&!M.terrain&&M.shadowRenderer){M.currentLayer<M.firstLightBeamLayer&&(M.firstLightBeamLayer=M.currentLayer);continue}}else if(Ct)continue;const we={defines:[]},fe=[];Ov(we.defines,fe,Ye,M),4&vt||we.defines.push("DIFFUSE_SHADED"),ht&&we.defines.push("SHADOWS_SINGLE_CASCADE");const Ke="shadow"===M.renderPass;if(Ke){qg(Ye,Ut,M,A);continue}let rn=null;if(k){const Vr=VE(Ut,M.transform);if(rn=new Float32Array(Vr),"globe"!==R.projection.name){const br=Ye.aabb.min,Yn=Ye.aabb.max,[bn,Ni]=k.getOpacityForBounds(Vr,br[0],br[1],Yn[0],Yn[1]);we.overrideFog=bn>=Rc||Ni>=Rc}}const Be=M.getOrCreateProgram("model",we);!Ke&&N&&(N.useNormalOffset=!!Ye.normalBuffer,N.setupShadowsFromMatrix(Ut,Be,N.useNormalOffset)),M.uploadCommonUniforms(C,Be,ct.toUnwrapped(),rn);const yn=Ye.material,Ir=yn.pbrMetallicRoughness;Ir.metallicFactor=.9,Ir.roughnessFactor=.5;const Sn=0,Zn=$g(new Float32Array(ue),new Float32Array(te),new Float32Array(Me),M,V,Ir.baseColorFactor,yn.emissiveFactor,Ir.metallicFactor,Ir.roughnessFactor,yn,Sn,A);Be.draw(M,C.gl.TRIANGLES,J&&!Ie?K:Q,$e.disabled,Y?Ie||V<1||xt.hasTranslucentParts?hn.alphaBlended:hn.unblended:hn.disabled,Ge.backCCW,Zn,A.id,Ye.vertexBuffer,Ye.indexBuffer,Ye.segments,A.paint,M.transform.zoom,void 0,fe)}}}};(function(Y,J,ct,dt){const ht=Y.terrain?Y.terrain.exaggeration():0,_t=Y.transform.zoom;for(const vt of dt){const xt=J.getTile(vt).getBucket(ct);xt&&(Y.conflationActive&&xt.updateReplacement(vt,Y.replacementSource),xt.evaluateScale(Y,ct),Y.terrain&&ht>0&&xt.elevationUpdate(Y.terrain,ht,vt,ct.source),xt.needsReEvaluation(Y,_t,ct)&&xt.evaluate(ct))}})(M,D,A,P),1===V?ot(!0,!0):(ot(!1,!0),ot(!0,!1))}(e,t,n,r),void d();const m=f.getModels(),g=[],y=e.transform.getFreeCameraOptions().position,v=Z.scale([],[y.x,y.y,y.z],e.transform.worldSize);Z.negate(v,v);const x=[],w=[];let E=0;for(const M of m){const D=n.paint.get("model-rotation").constantOr(null),A=n.paint.get("model-scale").constantOr(null),P=n.paint.get("model-translation").constantOr(null);M.computeModelMatrix(e,D,A,P,!0,!0,!1);const C=st.identity([]),R=Pl(M.position.lat,e.transform.zoom),k=st.fromScaling([],[1,1,1/R]);st.translate(C,C,v),g.push({zScaleMatrix:k,negCameraPosMatrix:C});for(const N of M.nodes)aS(e.transform,N,M.matrix,e.transform.expandedFarZProjMatrix,E,x,w);E++}if(x.sort((M,D)=>D.depth-M.depth),"shadow"!==e.renderPass){if(1===o)for(const M of w)kv(M,e,n,g[M.modelIndex],$e.disabled,e.colorModeForRenderPass());else{for(const M of w)kv(M,e,n,g[M.modelIndex],$e.disabled,hn.disabled);for(const M of w)kv(M,e,n,g[M.modelIndex],e.stencilModeFor3D(),e.colorModeForRenderPass());e.resetStencilClippingMasks()}for(const M of x)kv(M,e,n,g[M.modelIndex],$e.disabled,e.colorModeForRenderPass());d()}else{for(const M of w)qg(M.mesh,M.nodeModelMatrix,e,n);for(const M of x)qg(M.mesh,M.nodeModelMatrix,e,n);d()}}},GE={modelUpload:function(e,t,n){const r=t.getSource();if(!r.loaded())return;if("vector"===r.type||"geojson"===r.type)return void(e.modelManager&&e.modelManager.upload(e,n));if("batched-model"===r.type)return;const o=r.getModels();for(const s of o)s.upload(e.context)}};class hS{constructor(t,n,r){this.context=new LI(t,n),this.transform=r,this._tileTextures={},this.frameCopies=[],this.loadTimeStamps=[],this.setup(),this.numSublayers=ha.maxUnderzooming+ha.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.deferredRenderGpuTimeQueries=[],this.gpuTimers={},this.frameCounter=0,this._backgroundTiles={},this.conflationActive=!1,this.replacementSource=new mw,this.longestCutoffRange=0,this.minCutoffZoom=0,this._fogVisible=!1,this._cachedTileFogOpacities={},this._shadowRenderer=new dS(this),this._wireframeDebugCache=new uS,this.renderDefaultNorthPole=!0,this.renderDefaultSouthPole=!0}updateTerrain(t,n){const r=!!t&&!!t.terrain&&this.transform.projection.supportsTerrain;if(!(r||this._terrain&&this._terrain.enabled))return;this._terrain||(this._terrain=new EE(this,t));const o=this._terrain;this.transform.elevation=r?o:null,o.update(t,this.transform,n),this.transform.elevation&&!o.enabled&&(this.transform.elevation=null)}_updateFog(t){const n=t.fog;if(!n||"globe"===this.transform.projection.name||n.getOpacity(this.transform.pitch)<1||n.properties.get("horizon-blend")<.03)return void(this.transform.fogCullDistSq=null);const[r,o]=n.getFovAdjustedRange(this.transform._fov);if(r>o)return void(this.transform.fogCullDistSq=null);const s=r+.78*(o-r);this.transform.fogCullDistSq=s*s}get terrain(){return this.transform._terrainEnabled()&&this._terrain&&this._terrain.enabled?this._terrain:null}get shadowRenderer(){return this._shadowRenderer&&this._shadowRenderer.enabled?this._shadowRenderer:null}get wireframeDebugCache(){return this._wireframeDebugCache}resize(t,n){if(this.width=t*De.devicePixelRatio,this.height=n*De.devicePixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const r of this.style.order)this.style._mergedLayers[r].resize()}setup(){const t=this.context,n=new Xo;n.emplaceBack(0,0),n.emplaceBack(et,0),n.emplaceBack(0,et),n.emplaceBack(et,et),this.tileExtentBuffer=t.createVertexBuffer(n,Cl.members),this.tileExtentSegments=Rn.simpleSegment(0,0,4,2);const r=new Xo;r.emplaceBack(0,0),r.emplaceBack(et,0),r.emplaceBack(0,et),r.emplaceBack(et,et),this.debugBuffer=t.createVertexBuffer(r,Cl.members),this.debugSegments=Rn.simpleSegment(0,0,4,5);const o=new Xo;o.emplaceBack(-1,-1),o.emplaceBack(1,-1),o.emplaceBack(-1,1),o.emplaceBack(1,1),this.viewportBuffer=t.createVertexBuffer(o,Cl.members),this.viewportSegments=Rn.simpleSegment(0,0,4,2);const s=new nu;s.emplaceBack(0,0,0,0),s.emplaceBack(et,0,et,0),s.emplaceBack(0,et,0,et),s.emplaceBack(et,et,et,et),this.mercatorBoundsBuffer=t.createVertexBuffer(s,yg.members),this.mercatorBoundsSegments=Rn.simpleSegment(0,0,4,2);const c=new Kr;c.emplaceBack(0,1,2),c.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=t.createIndexBuffer(c);const u=new hm;for(const f of[0,1,3,2,0])u.emplaceBack(f);this.debugIndexBuffer=t.createIndexBuffer(u),this.emptyTexture=new hr(t,new $r({width:1,height:1},Uint8Array.of(0,0,0,0)),t.gl.RGBA),this.identityMat=st.create();const d=this.context.gl;this.stencilClearMode=new $e({func:d.ALWAYS,mask:0},0,255,d.ZERO,d.ZERO,d.ZERO),this.loadTimeStamps.push(ft.performance.now())}getMercatorTileBoundsBuffers(){return{tileBoundsBuffer:this.mercatorBoundsBuffer,tileBoundsIndexBuffer:this.quadTriangleIndexBuffer,tileBoundsSegments:this.mercatorBoundsSegments}}getTileBoundsBuffers(t){return t._makeTileBoundsBuffers(this.context,this.transform.projection),t._tileBoundsBuffer?{tileBoundsBuffer:t._tileBoundsBuffer,tileBoundsIndexBuffer:t._tileBoundsIndexBuffer,tileBoundsSegments:t._tileBoundsSegments}:this.getMercatorTileBoundsBuffers()}clearStencil(){const t=this.context.gl;this.nextStencilID=1,this.currentStencilSource=void 0,this._tileClippingMaskIDs={},this.getOrCreateProgram("clippingMask").draw(this,t.TRIANGLES,be.disabled,this.stencilClearMode,hn.disabled,Ge.disabled,xv(this.identityMat),"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}resetStencilClippingMasks(){this.terrain||(this.currentStencilSource=void 0,this._tileClippingMaskIDs={})}_renderTileClippingMasks(t,n,r){if(!n||this.currentStencilSource===n.id||!t.isTileClipped()||!r||0===r.length)return;if(this._tileClippingMaskIDs&&!this.terrain){let u=!1;for(const d of r)if(void 0===this._tileClippingMaskIDs[d.key]){u=!0;break}if(!u)return}this.currentStencilSource=n.id;const o=this.context,s=o.gl;this.nextStencilID+r.length>256&&this.clearStencil(),o.setColorMode(hn.disabled),o.setDepthMode(be.disabled);const c=this.getOrCreateProgram("clippingMask");this._tileClippingMaskIDs={};for(const u of r){const d=n.getTile(u),f=this._tileClippingMaskIDs[u.key]=this.nextStencilID++,{tileBoundsBuffer:m,tileBoundsIndexBuffer:g,tileBoundsSegments:y}=this.getTileBoundsBuffers(d);c.draw(this,s.TRIANGLES,be.disabled,new $e({func:s.ALWAYS,mask:0},f,255,s.KEEP,s.KEEP,s.REPLACE),hn.disabled,Ge.disabled,xv(u.projMatrix),"$clipping",m,g,y)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const t=this.nextStencilID++,n=this.context.gl;return new $e({func:n.NOTEQUAL,mask:255},t,255,n.KEEP,n.KEEP,n.REPLACE)}stencilModeForClipping(t){if(this.terrain)return this.terrain.stencilModeForRTTOverlap(t);const n=this.context.gl;return new $e({func:n.EQUAL,mask:255},this._tileClippingMaskIDs[t.key],0,n.KEEP,n.KEEP,n.REPLACE)}stencilConfigForOverlap(t){const n=this.context.gl,r=t.sort((c,u)=>u.overscaledZ-c.overscaledZ),o=r[r.length-1].overscaledZ,s=r[0].overscaledZ-o+1;if(s>1){this.currentStencilSource=void 0,this.nextStencilID+s>256&&this.clearStencil();const c={};for(let u=0;u<s;u++)c[u+o]=new $e({func:n.GEQUAL,mask:255},u+this.nextStencilID,255,n.KEEP,n.KEEP,n.REPLACE);return this.nextStencilID+=s,[c,r]}return[{[o]:$e.disabled},r]}colorModeForRenderPass(){const t=this.context.gl;return this._showOverdrawInspector?new hn([t.CONSTANT_COLOR,t.ONE,t.CONSTANT_COLOR,t.ONE],new ke(.125,.125,.125,0),[!0,!0,!0,!0]):"opaque"===this.renderPass?hn.unblended:hn.alphaBlended}colorModeForDrapableLayerRenderPass(t){const n=this.context.gl;return(()=>this.style&&this.style.enable3dLights()&&this.terrain&&this.terrain.renderingToTexture)()&&"translucent"===this.renderPass?new hn([n.ONE,n.ONE_MINUS_SRC_ALPHA,n.CONSTANT_ALPHA,n.ONE_MINUS_SRC_ALPHA],new ke(0,0,0,void 0===t?0:t),[!0,!0,!0,!0]):this.colorModeForRenderPass()}depthModeForSublayer(t,n,r,o=!1){if(!this.opaquePassEnabledForLayer()&&!o)return be.disabled;const s=1-((1+this.currentLayer)*this.numSublayers+t)*this.depthEpsilon;return new be(r||this.context.gl.LEQUAL,n,[s,s])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}render(t,n){this._wireframeDebugCache.update(this.frameCounter),this.style=t,this.options=n;const r=this.style._mergedLayers,o=this.style.order,s=o.map(C=>r[C]),c=this.style._mergedSourceCaches;this.imageManager=t.imageManager,this.modelManager=t.modelManager,this.symbolFadeChange=t.placement.symbolFadeChange(De.now()),this.imageManager.beginFrame();let u=0,d=!1;for(const C in c){const R=c[C];R.used&&(R.prepare(this.context),R.getSource().usedInConflation&&++u)}const f={},m={},g={},y={},v={};for(const C in c){const R=c[C];f[C]=R.getVisibleCoordinates(),m[C]=f[C].slice().reverse(),g[C]=R.getVisibleCoordinates(!0).reverse(),y[C]=R.getShadowCasterCoordinates(),v[C]=R.sortCoordinatesByDistance(f[C])}const x=C=>{const R=this.style.getLayerSourceCache(C);return R&&R.used?R.getSource():null};if(u){const C=[];for(const R of s)this.layerUsedInConflation(R,x(R))&&C.push(R);if(C&&C.length>1){const R=[];for(const k of C){const N=this.style.getLayerSourceCache(k);N&&N.used&&N.getSource().usedInConflation&&R.push({layer:k.fqid,cache:N})}this.replacementSource.setSources(R),d=!0}}d||this.replacementSource.clear(),this.conflationActive=d,this.minCutoffZoom=0,this.longestCutoffRange=0;for(const C of s){const R=C.cutoffRange();if(this.longestCutoffRange=Math.max(R,this.longestCutoffRange),R>0){const k=x(C);k&&(this.minCutoffZoom=Math.max(k.minzoom,this.minCutoffZoom)),C.minzoom&&(this.minCutoffZoom=Math.max(C.minzoom,this.minCutoffZoom))}}this.opaquePassCutoff=1/0;for(let C=0;C<s.length;C++)if(s[C].is3D()){this.opaquePassCutoff=C;break}const w=this.style&&this.style.fog;w?(this._fogVisible=0!==w.getOpacity(this.transform.pitch),this._fogVisible&&"globe"!==this.transform.projection.name&&(this._fogVisible=w.isVisibleOnFrustum(this.transform.cameraFrustum))):this._fogVisible=!1,this._cachedTileFogOpacities={},this.terrain&&(this.terrain.updateTileBinding(g),this.opaquePassCutoff=0);const E=this._shadowRenderer;if(E){E.updateShadowParameters(this.transform,this.style.directionalLight);for(const C in c)for(const R of f[C]){let k={min:0,max:0};this.terrain&&(k=this.terrain.getMinMaxForTile(R)||k),E.addShadowReceiver(R.toUnwrapped(),k.min,k.max)}}"globe"!==this.transform.projection.name||this.globeSharedBuffers||(this.globeSharedBuffers=new bC(this.context));for(const C of s){if(C.isHidden(this.transform.zoom))continue;const R=t.getLayerSourceCache(C);this.uploadLayer(this,C,R)}if(this.style.fog&&this.transform.projection.supportsFog?(this._atmosphere||(this._atmosphere=new Vd),this._atmosphere.update(this)):this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),!Yl.has(this.context.gl))return;this.renderPass="offscreen";for(const C of s){const R=t.getLayerSourceCache(C);if(!C.hasOffscreenPass()||C.isHidden(this.transform.zoom))continue;const k=R?m[R.id]:void 0;("custom"===C.type||"raster"===C.type||C.isSky()||k&&k.length)&&this.renderLayer(this,R,C,k)}this.depthRangeFor3D=[0,1-(s.length+2)*this.numSublayers*this.depthEpsilon];const M=this.terrain;M&&(this.style.hasSymbolLayers()||this.style.hasCircleLayers())&&!this.transform.isOrthographic&&M.drawDepth(),this._shadowRenderer&&(this.renderPass="shadow",this._shadowRenderer.drawShadowPass(this.style,y)),this.context.bindFramebuffer.set(null),this.context.viewport.set([0,0,this.width,this.height]);const D="globe"===this.transform.projection.name||this.transform.isHorizonVisible(),A=(()=>{if(n.showOverdrawInspector)return ke.black;if(this.style.fog&&this.transform.projection.supportsFog&&!D){const C=this.style.fog.properties.get("color").toArray01();return new ke(...C)}if(this.style.fog&&this.transform.projection.supportsFog&&D){const C=this.style.fog.properties.get("space-color").toArray01();return new ke(...C)}return ke.transparent})();if(this.context.clear({color:A,depth:1}),this.clearStencil(),this._showOverdrawInspector=n.showOverdrawInspector,this.renderPass="opaque",this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&D&&this._atmosphere.drawStars(this,this.style.fog),!this.terrain)for(this.currentLayer=o.length-1;this.currentLayer>=0;this.currentLayer--){const C=s[this.currentLayer],R=t.getLayerSourceCache(C);if(C.isSky())continue;const k=R?(C.is3D()?v:m)[R.id]:void 0;this._renderTileClippingMasks(C,R,k),this.renderLayer(this,R,C,k)}if(this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&D&&this._atmosphere.drawAtmosphereGlow(this,this.style.fog),this.renderPass="sky",(!this._atmosphere||ri(this.transform.zoom)>0)&&("globe"===this.transform.projection.name||this.transform.isHorizonVisible()))for(this.currentLayer=0;this.currentLayer<o.length;this.currentLayer++){const C=s[this.currentLayer],R=t.getLayerSourceCache(C);C.isSky()&&this.renderLayer(this,R,C,R?m[R.id]:void 0)}this.renderPass="translucent",this.currentLayer=0,this.firstLightBeamLayer=Number.MAX_SAFE_INTEGER;let P=0;for(E&&(P=E.getShadowCastingLayerCount());this.currentLayer<o.length;){const C=s[this.currentLayer],R=t.getLayerSourceCache(C);if(C.isSky()){++this.currentLayer;continue}if(M&&this.style.isLayerDraped(C)){if(C.isHidden(this.transform.zoom)){++this.currentLayer;continue}this.currentLayer=M.renderBatch(this.currentLayer);continue}let k;if(R&&(k=("symbol"===C.type?g:C.is3D()?v:m)[R.id]),this._renderTileClippingMasks(C,R,R?f[R.id]:void 0),this.renderLayer(this,R,C,k),!M&&E&&P>0&&C.hasShadowPass()&&0==--P&&(E.drawGroundShadows(),this.firstLightBeamLayer<=this.currentLayer)){const N=this.currentLayer;for(this.renderPass="light-beam",this.currentLayer=this.firstLightBeamLayer;this.currentLayer<=N;this.currentLayer++){const z=s[this.currentLayer];if(!z.hasLightBeamPass())continue;const B=t.getLayerSourceCache(z);this.renderLayer(this,B,z,B?m[B.id]:void 0)}this.currentLayer=N,this.renderPass="translucent"}++this.currentLayer}if(this.terrain&&this.terrain.postRender(),this.options.showTileBoundaries||this.options.showQueryGeometry||this.options.showTileAABBs){let C=null;s.forEach(R=>{const k=t.getLayerSourceCache(R);k&&!R.isHidden(this.transform.zoom)&&k.getVisibleCoordinates().length&&(!C||C.getSource().maxzoom<k.getSource().maxzoom)&&(C=k)}),C&&this.options.showTileBoundaries&&Nv.debug(this,C,C.getVisibleCoordinates())}this.options.showPadding&&function(C){const R=C.transform.padding;zE(C,C.transform.height-(R.top||0),3,tS),zE(C,R.bottom||0,3,eS),BE(C,R.left||0,3,nS),BE(C,C.transform.width-(R.right||0),3,rS);const k=C.transform.centerPoint;var N,z,B,U;Hg(N=C,(z=k.x)-1,(B=C.transform.height-k.y)-10,2,20,U=NE),Hg(N,z-10,B-1,20,2,U)}(this),this.context.setDefault(),this.frameCounter=(this.frameCounter+1)%Number.MAX_SAFE_INTEGER,this.tileLoaded&&this.options.speedIndexTiming&&(this.loadTimeStamps.push(ft.performance.now()),this.saveCanvasCopy()),d||(this.conflationActive=!1)}uploadLayer(t,n,r){this.gpuTimingStart(n),(!t.transform.projection.unsupportedLayers||!t.transform.projection.unsupportedLayers.includes(n.type)||t.terrain&&"custom"===n.type)&&GE[`${n.type}Upload`]&&GE[`${n.type}Upload`](t,r,n.scope),this.gpuTimingEnd()}renderLayer(t,n,r,o){r.isHidden(this.transform.zoom)||("background"===r.type||"sky"===r.type||"custom"===r.type||"model"===r.type||"raster"===r.type||o&&o.length)&&(this.id=r.id,this.gpuTimingStart(r),(!t.transform.projection.unsupportedLayers||!t.transform.projection.unsupportedLayers.includes(r.type)||t.terrain&&"custom"===r.type)&&Nv[r.type](t,n,r,o,this.style.placement.variableOffsets,this.options.isInitialLoad),this.gpuTimingEnd())}gpuTimingStart(t){if(!this.options.gpuTiming)return;const n=this.context.extTimerQuery,r=this.context.gl;let o=this.gpuTimers[t.id];o||(o=this.gpuTimers[t.id]={calls:0,cpuTime:0,query:r.createQuery()}),o.calls++,r.beginQuery(n.TIME_ELAPSED_EXT,o.query)}gpuTimingDeferredRenderStart(){if(this.options.gpuTimingDeferredRender){const t=this.context.extTimerQuery,n=this.context.gl,r=n.createQuery();this.deferredRenderGpuTimeQueries.push(r),n.beginQuery(t.TIME_ELAPSED_EXT,r)}}gpuTimingDeferredRenderEnd(){this.options.gpuTimingDeferredRender&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}gpuTimingEnd(){this.options.gpuTiming&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}collectGpuTimers(){const t=this.gpuTimers;return this.gpuTimers={},t}collectDeferredRenderGpuQueries(){const t=this.deferredRenderGpuTimeQueries;return this.deferredRenderGpuTimeQueries=[],t}queryGpuTimers(t){const n={};for(const r in t){const o=t[r],s=this.context.extTimerQuery,c=s.getQueryParameter(o.query,this.context.gl.QUERY_RESULT)/1e6;s.deleteQueryEXT(o.query),n[r]=c}return n}queryGpuTimeDeferredRender(t){if(!this.options.gpuTimingDeferredRender)return 0;const n=this.context.extTimerQuery,r=this.context.gl;let o=0;for(const s of t)o+=n.getQueryParameter(s,r.QUERY_RESULT)/1e6,n.deleteQueryEXT(s);return o}translatePosMatrix(t,n,r,o,s){if(!r[0]&&!r[1])return t;const c=s?"map"===o?this.transform.angle:0:"viewport"===o?-this.transform.angle:0;if(c){const f=Math.sin(c),m=Math.cos(c);r=[r[0]*m-r[1]*f,r[0]*f+r[1]*m]}const u=[s?r[0]:Bu(n,r[0],this.transform.zoom),s?r[1]:Bu(n,r[1],this.transform.zoom),0],d=new Float32Array(16);return st.translate(d,t,u),d}saveTileTexture(t){const n=t.size[0],r=this._tileTextures[n];r?r.push(t):this._tileTextures[n]=[t]}getTileTexture(t){const n=this._tileTextures[t];return n&&n.length>0?n.pop():null}isPatternMissing(t,n){return null===t||void 0!==t&&!this.imageManager.getPattern(t.toString(),n)}terrainRenderModeElevated(){return this.style&&!!this.style.getTerrain()&&!!this.terrain&&!this.terrain.renderingToTexture}linearFloatFilteringSupported(){return null!=this.context.extTextureFloatLinear}currentGlobalDefines(t,n,r){const o=void 0===r?this.terrain&&this.terrain.renderingToTexture:r,s=this.terrain&&0===this.terrain.exaggeration(),c=[];return this.style&&this.style.enable3dLights()&&("globeRaster"===t||"terrainRaster"===t?(c.push("LIGHTING_3D_MODE"),c.push("LIGHTING_3D_ALPHA_EMISSIVENESS")):o||c.push("LIGHTING_3D_MODE")),"shadow"===this.renderPass?this._shadowMapDebug||c.push("DEPTH_TEXTURE"):this.shadowRenderer&&(this.shadowRenderer.useNormalOffset?c.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"):c.push("RENDER_SHADOWS","DEPTH_TEXTURE")),this.terrainRenderModeElevated()&&(c.push("TERRAIN"),this.linearFloatFilteringSupported()&&c.push("TERRAIN_DEM_FLOAT_FORMAT"),s&&c.push("ZERO_EXAGGERATION")),"globe"===this.transform.projection.name&&c.push("GLOBE"),!this._fogVisible||o||void 0!==n&&!n||c.push("FOG","FOG_DITHERING"),o&&c.push("RENDER_TO_TEXTURE"),this._showOverdrawInspector&&c.push("OVERDRAW_INSPECTOR"),c}getOrCreateProgram(t,n){this.cache=this.cache||{};const r=n&&n.defines||[],o=n&&n.config,s=this.currentGlobalDefines(t,n&&n.overrideFog,n&&n.overrideRtt).concat(r),c=jD.cacheKey(yv[t],t,s,o);return this.cache[c]||(this.cache[c]=new jD(this.context,t,yv[t],o,PE[t],s)),this.cache[c]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.frontFace.setDefault(),this.context.cullFaceSide.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const t=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(t.FUNC_ADD)}initDebugOverlayCanvas(){null==this.debugOverlayCanvas&&(this.debugOverlayCanvas=ft.document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new hr(this.context,this.debugOverlayCanvas,this.context.gl.RGBA))}destroy(){this._terrain&&this._terrain.destroy(),this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),this.globeSharedBuffers&&this.globeSharedBuffers.destroy(),this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy(),this._wireframeDebugCache.destroy()}prepareDrawTile(){this.terrain&&this.terrain.prepareDrawTile()}uploadCommonLightUniforms(t,n){if(this.style.enable3dLights()){const r=this.style.directionalLight,o=this.style.ambientLight;if(r&&o){const s=((c,u)=>{const d=c.properties.get("direction"),f=c.properties.get("color").toArray01(),m=c.properties.get("intensity"),g=u.properties.get("color").toArray01(),y=u.properties.get("intensity"),v=[d.x,d.y,d.z],x=Jn(g,y),w=Jn(f,m);return{u_lighting_ambient_color:x,u_lighting_directional_dir:v,u_lighting_directional_color:w,u_ground_radiance:TE(v,w,x)}})(r,o);n.setLightsUniformValues(t,s)}}}uploadCommonUniforms(t,n,r,o,s){if(this.uploadCommonLightUniforms(t,n),this.terrain&&this.terrain.renderingToTexture)return;const c=this.style.fog;if(c){const u=c.getOpacity(this.transform.pitch),d=((f,m,g,y,v,x,w,E,M,D,A,P)=>{const C=f.transform,R=m.properties.get("color").toArray01();R[3]=y;const k=f.frameCounter/1e3%1,[N,z]=m.properties.get("vertical-range");return{u_fog_matrix:g?C.calculateFogTileMatrix(g):P||f.identityMat,u_fog_range:m.getFovAdjustedRange(C._fov),u_fog_color:R,u_fog_horizon_blend:m.properties.get("horizon-blend"),u_fog_vertical_limit:[Math.min(N,z),z],u_fog_temporal_offset:k,u_frustum_tl:v,u_frustum_tr:x,u_frustum_br:w,u_frustum_bl:E,u_globe_pos:M,u_globe_radius:D,u_viewport:A,u_globe_transition:ri(C.zoom),u_is_globe:+("globe"===C.projection.name)}})(this,c,r,u,this.transform.frustumCorners.TL,this.transform.frustumCorners.TR,this.transform.frustumCorners.BR,this.transform.frustumCorners.BL,this.transform.globeCenterInViewSpace,this.transform.globeRadius,[this.transform.width*De.devicePixelRatio,this.transform.height*De.devicePixelRatio],o);n.setFogUniformValues(t,d)}s&&n.setCutoffUniformValues(t,s.uniformValues)}setTileLoadedFlag(t){this.tileLoaded=t}saveCanvasCopy(){const t=this.canvasCopy();t&&(this.frameCopies.push(t),this.tileLoaded=!1)}canvasCopy(){const t=this.context.gl,n=t.createTexture();return t.bindTexture(t.TEXTURE_2D,n),t.copyTexImage2D(t.TEXTURE_2D,0,t.RGBA,0,0,t.drawingBufferWidth,t.drawingBufferHeight,0),n}getCanvasCopiesAndTimestamps(){return{canvasCopies:this.frameCopies,timeStamps:this.loadTimeStamps}}averageElevationNeedsEasing(){if(!this.transform._elevation)return!1;const t=this.style&&this.style.fog;return!!t&&0!==t.getOpacity(this.transform.pitch)}getBackgroundTiles(){const t=this._backgroundTiles,n=this._backgroundTiles={},r=this.transform.coveringTiles({tileSize:512});for(const o of r)n[o.key]=t[o.key]||new Ya(o,512,this.transform.tileZoom,this);return n}clearBackgroundTiles(){this._backgroundTiles={}}layerUsedInConflation(t,n){return!(!t.is3D()||t.minzoom&&t.minzoom>this.transform.zoom||"building"!==t.sourceLayer&&(!n||"batched-model"!==n.type))}isTileAffectedByFog(t){if(!this.style||!this.style.fog)return!1;if("globe"===this.transform.projection.name)return!0;let n=this._cachedTileFogOpacities[t.key];return n||(this._cachedTileFogOpacities[t.key]=n=this.style.fog.getOpacityForTile(t)),n[0]>=Rc||n[1]>=Rc}}const Zu=2048;class zv{constructor(t,n){this.aabb=t,this.lastCascade=n}}class $E{add(t,n){const r=this.receivers[t.key];void 0!==r?(r.aabb.min[0]=Math.min(r.aabb.min[0],n.min[0]),r.aabb.min[1]=Math.min(r.aabb.min[1],n.min[1]),r.aabb.min[2]=Math.min(r.aabb.min[2],n.min[2]),r.aabb.max[0]=Math.max(r.aabb.max[0],n.max[0]),r.aabb.max[1]=Math.max(r.aabb.max[1],n.max[1]),r.aabb.max[2]=Math.max(r.aabb.max[2],n.max[2])):this.receivers[t.key]=new zv(n,null)}clear(){this.receivers={}}get(t){return this.receivers[t.key]}computeRequiredCascades(t,n,r){const o=Bn.fromPoints(t.points);let s=0;for(const c in this.receivers){const u=this.receivers[c];if(!u||!o.intersectsAabb(u.aabb))continue;u.aabb.min=o.closestPoint(u.aabb.min),u.aabb.max=o.closestPoint(u.aabb.max);const d=u.aabb.getCorners();for(let f=0;f<r.length;f++){let m=!0;for(const g of d){const y=[g[0]*n,g[1]*n,g[2]];if(Z.transformMat4(y,y,r[f].matrix),y[0]<-1||y[0]>1||y[1]<-1||y[1]>1){m=!1;break}}if(u.lastCascade=f,s=Math.max(s,f),m)break}}return s+1}}class dS{constructor(t){this.painter=t,this._enabled=!1,this._shadowLayerCount=0,this._numCascadesToRender=0,this._cascades=[],this._groundShadowTiles=[],this._receivers=new $E,this._depthMode=new be(t.context.gl.LEQUAL,be.ReadWrite,[0,1]),this._uniformValues={u_light_matrix_0:new Float32Array(16),u_light_matrix_1:new Float32Array(16),u_shadow_intensity:0,u_fade_range:[0,0],u_shadow_normal_offset:[1,1,1],u_shadow_texel_size:1,u_shadow_map_resolution:1,u_shadow_direction:[0,0,1],u_shadow_bias:[36e-5,.0012,.012],u_shadowmap_0:0,u_shadowmap_1:0},this.useNormalOffset=!1}destroy(){for(const t of this._cascades)t.texture.destroy(),t.framebuffer.destroy();this._cascades=[]}updateShadowParameters(t,n){const r=this.painter;if(this._enabled=!1,this._shadowLayerCount=0,this._receivers.clear(),!n||!n.properties)return;const o=n.properties.get("shadow-intensity");if(!n.shadowsEnabled()||o<=0||(this._shadowLayerCount=r.style.order.reduce((v,x)=>{const w=r.style._mergedLayers[x];return v+(w.hasShadowPass()&&!w.isHidden(t.zoom)?1:0)},0),this._enabled=this._shadowLayerCount>0,!this._enabled))return;const s=r.context,c=Zu,u=Zu;if(0===this._cascades.length)for(let v=0;v<2;++v){const x=r._shadowMapDebug,w=s.gl,E=s.createFramebuffer(c,u,x,"texture"),M=new hr(s,{width:c,height:u,data:null},w.DEPTH_COMPONENT);if(E.depthAttachment.set(M.texture),x){const D=new hr(s,{width:c,height:u,data:null},w.RGBA);E.colorAttachment.set(D.texture)}this._cascades.push({framebuffer:E,texture:M,matrix:[],far:0,boundingSphereRadius:0,frustum:new aa,scale:0})}this.shadowDirection=Zg(n);let d=0;if(t.elevation){const v=t.elevation,x=[1e4,-1e4];v.visibleDemTiles.filter(w=>w.dem).forEach(w=>{const E=w.dem.tree;x[0]=Math.min(x[0],E.minimums[0]),x[1]=Math.max(x[1],E.maximums[0])}),1e4!==x[0]&&(d=(x[1]-x[0])*v.exaggeration())}const f=1.5*t.cameraToCenterDistance,m=3*f,g=new Float64Array(16);for(let v=0;v<2;++v){const x=this._cascades[v];let w=t.height/50,E=1;0===v?E=f:(w=f,E=m);const[M,D]=qE(t,this.shadowDirection,w,E,Zu,d);x.scale=t.scale,x.matrix=M,x.boundingSphereRadius=D,st.invert(g,x.matrix),x.frustum=aa.fromInvProjectionMatrix(g,1,0,!0),x.far=E}this._uniformValues.u_fade_range=[.75*this._cascades[1].far,this._cascades[1].far],this._uniformValues.u_shadow_intensity=o,this._uniformValues.u_shadow_direction=[this.shadowDirection[0],this.shadowDirection[1],this.shadowDirection[2]],this._uniformValues.u_shadow_texel_size=.00048828125,this._uniformValues.u_shadow_map_resolution=Zu,this._uniformValues.u_shadowmap_0=rs.ShadowMap0,this._uniformValues.u_shadowmap_1=rs.ShadowMap0+1,this._groundShadowTiles=r.transform.coveringTiles({tileSize:512,renderWorldCopies:!0});const y=r.transform.elevation;for(const v of this._groundShadowTiles){let x={min:0,max:0};if(y){const w=y.getMinMaxForTile(v);w&&(x=w)}this.addShadowReceiver(v.toUnwrapped(),x.min,x.max)}}get enabled(){return this._enabled}set enabled(t){this._enabled=t}drawShadowPass(t,n){if(!this._enabled)return;const r=this.painter,o=r.context;this._numCascadesToRender=this._receivers.computeRequiredCascades(r.transform.getFrustum(0),r.transform.worldSize,this._cascades),o.viewport.set([0,0,Zu,Zu]);for(let s=0;s<this._numCascadesToRender;++s){r.currentShadowCascade=s,o.bindFramebuffer.set(this._cascades[s].framebuffer.framebuffer),o.clear({color:ke.white,depth:1});for(const c of t.order){const u=t._mergedLayers[c];if(!u.hasShadowPass()||u.isHidden(r.transform.zoom))continue;const d=t.getLayerSourceCache(u),f=d?n[d.id]:void 0;("model"===u.type||f&&f.length)&&r.renderLayer(r,d,u,f)}}r.currentShadowCascade=0}drawGroundShadows(){if(!this._enabled)return;const t=this.painter,n=t.style,r=t.context,o=n.directionalLight,s=n.ambientLight;if(!o||!s)return;const c=[],u=kd(t,t.longestCutoffRange);u.shouldRenderCutoff&&c.push("RENDER_CUTOFF");const d=HE(o,s),f=new be(r.gl.LEQUAL,be.ReadOnly,t.depthRangeFor3D);for(const m of this._groundShadowTiles){const g=m.toUnwrapped(),y=t.isTileAffectedByFog(m),v=t.getOrCreateProgram("groundShadow",{defines:c,overrideFog:y});this.setupShadows(g,v),t.uploadCommonUniforms(r,v,g,null,u);const x={u_matrix:t.transform.calculateProjMatrix(g),u_ground_shadow_factor:d};v.draw(t,r.gl.TRIANGLES,f,$e.disabled,hn.multiply,Ge.disabled,x,"ground_shadow",t.tileExtentBuffer,t.quadTriangleIndexBuffer,t.tileExtentSegments,{},t.transform.zoom,null,null)}}getShadowPassColorMode(){return this.painter._shadowMapDebug?hn.unblended:hn.disabled}getShadowPassDepthMode(){return this._depthMode}getShadowCastingLayerCount(){return this._shadowLayerCount}calculateShadowPassMatrixFromTile(t){const n=this.painter.transform,r=n.calculatePosMatrix(t,n.worldSize);return st.multiply(r,this._cascades[this.painter.currentShadowCascade].matrix,r),Float32Array.from(r)}calculateShadowPassMatrixFromMatrix(t){return st.multiply(t,this._cascades[this.painter.currentShadowCascade].matrix,t),Float32Array.from(t)}setupShadows(t,n,r,o=0){if(!this._enabled)return;const s=this.painter.transform,c=this.painter.context,u=c.gl,d=this._uniformValues,f=new Float64Array(16),m=s.calculatePosMatrix(t,s.worldSize);for(let g=0;g<2;g++)st.multiply(f,this._cascades[g].matrix,m),d[0===g?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(f),c.activeTexture.set(u.TEXTURE0+rs.ShadowMap0+g),this._cascades[g].texture.bind(u.NEAREST,u.CLAMP_TO_EDGE);if(this.useNormalOffset=!!r,this.useNormalOffset){const g=Uf(t.canonical),y=2/s.tileSize*et/Zu,v=y*this._cascades[0].boundingSphereRadius,x=y*this._cascades[1].boundingSphereRadius,w=("vector-tile"===r?1:3)/Math.pow(2,o-t.canonical.z-(1-s.zoom+Math.floor(s.zoom)));d.u_shadow_normal_offset=[g,v*w,x*w],d.u_shadow_bias=[6e-5,.0012,.012]}else d.u_shadow_bias=[36e-5,.0012,.012];n.setShadowUniformValues(c,d)}setupShadowsFromMatrix(t,n,r=!1){if(!this._enabled)return;const o=this.painter.context,s=o.gl,c=this._uniformValues,u=new Float64Array(16);for(let d=0;d<2;d++)st.multiply(u,this._cascades[d].matrix,t),c[0===d?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(u),o.activeTexture.set(s.TEXTURE0+rs.ShadowMap0+d),this._cascades[d].texture.bind(s.NEAREST,s.CLAMP_TO_EDGE);this.useNormalOffset=r,r?(c.u_shadow_normal_offset=[1,5,5],c.u_shadow_bias=[6e-5,.0012,.012]):c.u_shadow_bias=[36e-5,.0012,.012],n.setShadowUniformValues(o,c)}getShadowUniformValues(){return this._uniformValues}getCurrentCascadeFrustum(){return this._cascades[this.painter.currentShadowCascade].frustum}computeSimplifiedTileShadowVolume(t,n,r,o){if(o[2]>=0)return{};const s=function(d,f,m){const g=m/(1<<d.canonical.z);return new Bn([d.canonical.x*g+d.wrap*m,d.canonical.y*g+d.wrap*m,0],[(d.canonical.x+1)*g+d.wrap*m,(d.canonical.y+1)*g+d.wrap*m,f])}(t,n,r).getCorners(),c=n/-o[2];o[0]<0?(Z.add(s[0],s[0],[o[0]*c,0,0]),Z.add(s[3],s[3],[o[0]*c,0,0])):o[0]>0&&(Z.add(s[1],s[1],[o[0]*c,0,0]),Z.add(s[2],s[2],[o[0]*c,0,0])),o[1]<0?(Z.add(s[0],s[0],[0,o[1]*c,0]),Z.add(s[1],s[1],[0,o[1]*c,0])):o[1]>0&&(Z.add(s[2],s[2],[0,o[1]*c,0]),Z.add(s[3],s[3],[0,o[1]*c,0]));const u={};return u.vertices=s,u.planes=[Wu(s[1],s[0],s[4]),Wu(s[2],s[1],s[5]),Wu(s[3],s[2],s[6]),Wu(s[0],s[3],s[7])],u}addShadowReceiver(t,n,r){this._receivers.add(t,Bn.fromTileIdAndHeight(t,n,r))}getMaxCascadeForTile(t){const n=this._receivers.get(t);return n&&n.lastCascade?n.lastCascade:0}}function Wu(e,t,n){const r=Z.sub([],n,t),o=Z.sub([],e,t),s=Z.cross([],r,o),c=Z.length(s);return 0===c?[0,0,1,0]:(Z.scale(s,s,1/c),[s[0],s[1],s[2],-Z.dot(s,t)])}function Zg(e){const t=e.properties.get("direction"),n=ae(t.x,t.y,t.z);n[2]=ne(n[2],0,75);const r=Jt([n[0],n[1],n[2]]);return Z.fromValues(r.x,r.y,r.z)}function HE(e,t){const n=e.properties.get("color"),r=e.properties.get("intensity"),o=e.properties.get("direction"),s=[o.x,o.y,o.z],c=t.properties.get("color"),u=t.properties.get("intensity"),d=Math.max(Z.dot([0,0,1],s),0),f=[0,0,0];Z.scale(f,c.toArray01Linear().slice(0,3),u);const m=[0,0,0];return Z.scale(m,n.toArray01Linear().slice(0,3),d*r),Fn([f[0]>0?f[0]/(f[0]+m[0]):0,f[1]>0?f[1]/(f[1]+m[1]):0,f[2]>0?f[2]/(f[2]+m[2]):0])}function qE(e,t,n,r,o,s){const c=e.zoom,u=e.scale,d=e.worldSize,f=1/d,m=e.aspect,g=Math.sqrt(1+m*m)*Math.tan(.5*e.fovX),y=g*g,v=r-n,x=r+n;let w,E;y>v/x?(w=r,E=r*g):(w=.5*x*(1+y),E=.5*Math.sqrt(v*v+2*(r*r+n*n)*y+x*x*y*y));const M=e.projection.pixelsPerMeter(e.center.lat,d),D=e._camera.getCameraToWorldMercator(),A=[0,0,-w*f];Z.transformMat4(A,A,D);let P=E*f;const C=e._edgeInsets;if(!(0===C.left&&0===C.top&&0===C.right&&0===C.bottom||C.left===C.right&&C.top===C.bottom)){const dt=e._camera.getWorldToCamera(e.worldSize,"meters"===e.projection.zAxisUnit?M:1),ht=e._camera.getCameraToClipPerspective(e._fov,e.width/e.height,n,r);ht[8]=2*-e.centerOffset.x/e.width,ht[9]=2*e.centerOffset.y/e.height;const _t=new Float64Array(16);st.mul(_t,ht,dt);const vt=new Float64Array(16);st.invert(vt,_t);const xt=aa.fromInvProjectionMatrix(vt,d,c,!0);for(const mt of xt.points){const Ct=((R=mt)[0]/=u,R[1]/=u,R[2]=Ln(R[2],e._center.lat),R);P=Math.max(P,Z.len(Z.subtract([],A,Ct)))}}var R;P*=o/(o-1);const k=Math.acos(t[2]),N=Math.atan2(-t[0],-t[1]),z=new wg;z.position=A,z.setPitchBearing(k,N);const B=z.getWorldToCamera(d,M),U=P*d,$=Math.min(e._mercatorZfromZoom(17)*d*-2,-2*U),W=z.getCameraToClipOrthographic(-U,U,-U,U,$,(U+s*M)/t[2]),V=new Float64Array(16);st.multiply(V,W,B);const K=Z.fromValues(Math.floor(1e6*A[0])/1e6*d,Math.floor(1e6*A[1])/1e6*d,0),Q=.5*o,ot=[0,0,0];Z.transformMat4(ot,K,V),Z.scale(ot,ot,Q);const Y=[Math.floor(ot[0]),Math.floor(ot[1]),Math.floor(ot[2])],J=[0,0,0];Z.sub(J,ot,Y),Z.scale(J,J,-1/Q);const ct=new Float64Array(16);return st.identity(ct),st.translate(ct,ct,J),st.multiply(V,ct,V),[V,U]}class fS extends ye{constructor(t){super(),this.requestManager=t,this.models={"":{}},this.numModelsLoading={}}loadModel(t,n){return dD(this.requestManager.transformRequest(n,yt.Model).url).then(r=>{if(!r)return;const o=qu(r),s=new hw(t,void 0,void 0,o);return s.computeBoundsAndApplyParent(),s}).catch(r=>{this.fire(new Tt(new Error(`Could not load model ${t} from ${n}: ${r.message}`)))})}load(t,n){this.models[n]||(this.models[n]={});const r=Object.keys(t);this.numModelsLoading[n]=(this.numModelsLoading[n]||0)+r.length;const o=[];for(const s of r)o.push(this.loadModel(s,t[s]));Promise.allSettled(o).then(s=>{for(let c=0;c<s.length;c++){const{status:u,value:d}=s[c];"fulfilled"===u&&d&&(this.models[n][r[c]]=d)}this.numModelsLoading[n]-=r.length,this.fire(new Mt("data",{dataType:"style"}))}).catch(s=>{this.fire(new Tt(new Error(`Could not load models: ${s.message}`)))})}isLoaded(){for(const t in this.numModelsLoading)if(this.numModelsLoading[t]>0)return!1;return!0}hasModel(t,n){return!!this.getModel(t,n)}getModel(t,n){return this.models[n]||(this.models[n]={}),this.models[n][t]}addModel(t,n,r){this.models[r]||(this.models[r]={}),this.hasModel(t,r)&&this.removeModel(t,r),this.load({[t]:this.requestManager.normalizeModelURL(n)},r)}addModels(t,n){const r={};for(const o in t)r[o]=this.requestManager.normalizeModelURL(t[o]);this.load(r,n)}removeModel(t,n){this.models[n]||(this.models[n]={});const r=this.models[n][t];delete this.models[n][t],r.destroy()}listModels(t){return this.models[t]||(this.models[t]={}),Object.keys(this.models[t])}upload(t,n){this.models[n]||(this.models[n]={});for(const r in this.models[n])this.models[n][r].upload(t.context)}}const Ud=(e,t)=>uf(e,t&&t.filter(n=>"source.canvas"!==n.identifier)),Gd=to(xn,["addLayer","removeLayer","setLights","setPaintProperty","setLayoutProperty","setSlot","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData","setTerrain","setFog","setProjection","setCamera","addImport","removeImport","setImportUrl","setImportData","setImportConfig"]),pS=to(xn,["setCenter","setZoom","setBearing","setPitch"]),Bv={version:8,layers:[],sources:{}},Wg={duration:300,delay:0},UC=new Set(["fill","line","background","hillshade","raster"]);class ma extends ye{constructor(t,n={}){super(),this.map=t,this.scope=n.scope||"",this.fragments=[],this.importDepth=n.importDepth||0,this.importsCache=n.importsCache||new Map,this.resolvedImports=n.resolvedImports||new Set,this.transition=Wt({},Wg),this._buildingIndex=new vD(this),this.crossTileSymbolIndex=new LD,this._mergedOrder=[],this._drapedFirstOrder=[],this._mergedLayers={},this._mergedSourceCaches={},this._mergedOtherSourceCaches={},this._mergedSymbolSourceCaches={},this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this._changes=n.styleChanges||new oM,this.dispatcher=n.dispatcher?n.dispatcher:new xp(Nl(),this),n.imageManager?this.imageManager=n.imageManager:(this.imageManager=new zw,this.imageManager.setEventedParent(this)),this.imageManager.createScope(this.scope),this.glyphManager=n.glyphManager?n.glyphManager:new ed(t._requestManager,n.localFontFamily?2:n.localIdeographFontFamily?1:0,n.localFontFamily||n.localIdeographFontFamily),n.modelManager?this.modelManager=n.modelManager:(this.modelManager=new fS(t._requestManager),this.modelManager.setEventedParent(this)),this._layers={},this._serializedLayers={},this._sourceCaches={},this._otherSourceCaches={},this._symbolSourceCaches={},this._loaded=!1,this._precompileDone=!1,this._shouldPrecompile=!1,this._availableImages=[],this._order=[],this._markersNeedUpdate=!1,this.options=new Map,this._configDependentLayers=new Set,this._config=n.config,this.dispatcher.broadcast("setReferrer",kt());const r=this;this._rtlTextPluginCallback=ma.registerForPluginStateChange(o=>{r.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:o.pluginStatus,pluginURL:o.pluginURL},(s,c)=>{if(nm(s),c&&c.every(u=>u))for(const u in r._sourceCaches){const d=r._sourceCaches[u],f=d.getSource().type;"vector"!==f&&"geojson"!==f||d.reload()}})}),this.on("data",o=>{if("source"!==o.dataType||"metadata"!==o.sourceDataType)return;const s=this.getOwnSource(o.sourceId);if(s&&s.vectorLayerIds)for(const c in this._layers){const u=this._layers[c];u.source===s.id&&this._validateLayer(u)}})}loadURL(t,n={}){this.fire(new Mt("dataloading",{dataType:"style"}));const r="boolean"==typeof n.validate?n.validate:!mn(t);t=this.map._requestManager.normalizeStyleURL(t,n.accessToken),this.resolvedImports.add(t);const o=this.importsCache.get(t);if(o)return this._load(o,r);const s=this.map._requestManager.transformRequest(t,yt.Style);this._request=zt(s,(c,u)=>{if(this._request=null,c)this.fire(new Tt(c));else if(u)return this.importsCache.set(t,u),this._load(u,r)})}loadJSON(t,n={}){this.fire(new Mt("dataloading",{dataType:"style"})),this._request=De.frame(()=>{this._request=null,this._load(t,!1!==n.validate)})}loadEmpty(){this.fire(new Mt("dataloading",{dataType:"style"})),this._load(Bv,!1)}_loadImports(t,n){if(this.importDepth>=4)return nt("Style doesn't support nesting deeper than 5"),Promise.resolve();const r=[];for(const o of t){const s=this._createFragmentStyle(o),c=new Promise(d=>{s.once("style.import.load",d),s.once("error",d)}).then(()=>this.mergeAll());if(r.push(c),this.resolvedImports.has(o.url)){s.loadEmpty();continue}const u=o.data||this.importsCache.get(o.url);u?s.loadJSON(u,{validate:n}):o.url?s.loadURL(o.url,{validate:n}):s.loadEmpty(),this.fragments.push({style:s,id:o.id,config:o.config})}return Promise.allSettled(r)}_createFragmentStyle(t){const n=this.scope?$i(t.id,this.scope):t.id,r=new ma(this.map,{scope:n,styleChanges:this._changes,importDepth:this.importDepth+1,importsCache:this.importsCache,resolvedImports:new Set(this.resolvedImports),dispatcher:this.dispatcher,imageManager:this.imageManager,glyphManager:this.glyphManager,modelManager:this.modelManager,config:t.config});return r.setEventedParent(this.map,{style:r}),r}_reloadImports(){this.mergeAll(),this._updateMapProjection(),this.map._triggerCameraUpdate(this.camera),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options});const t=this.isRootStyle();this._shouldPrecompile=t,this.fire(new Mt(t?"style.load":"style.import.load"))}_load(t,n){const r=t.schema;if(this.isRootStyle()&&(t.fragment||r&&!1!==t.fragment)){const c=Wt({},Bv,{imports:[{id:"basemap",data:t,url:""}]});return void this._load(c,n)}if(this.setConfig(this._config,r),n&&Ud(this,bl(t)))return;this._loaded=!0,this.stylesheet=q(t);for(const c in t.sources)this.addSource(c,t.sources[c],{validate:!1,isInitialLoad:!0});t.sprite?this._loadSprite(t.sprite):(this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0})),this.glyphManager.setURL(t.glyphs,this.scope);const o=ov(this.stylesheet.layers);if(this._order=o.map(c=>c.id),this.stylesheet.light&&nt("The `light` root property is deprecated, prefer using `lights` with `flat` light type instead."),this.stylesheet.lights)if(1===this.stylesheet.lights.length&&"flat"===this.stylesheet.lights[0].type){const c=this.stylesheet.lights[0];this.light=new z0(c.properties,c.id)}else this.setLights(this.stylesheet.lights);this.light||(this.light=new z0(this.stylesheet.light)),this._layers={},this._serializedLayers={};for(const c of o){const u=Cg(c,this.options);u.setScope(this.scope),u.isConfigDependent&&this._configDependentLayers.add(u.fqid),u.setEventedParent(this,{layer:{id:u.id}}),this._layers[u.id]=u,this._serializedLayers[u.id]=u.serialize();const d=this.getOwnLayerSourceCache(u),f=!!this.directionalLight&&this.directionalLight.shadowsEnabled();d&&u.canCastShadows()&&f&&(d.castsShadows=!0)}this.stylesheet.models&&this.modelManager.addModels(this.stylesheet.models,this.scope);const s=this.stylesheet.terrain;s&&(void 0===this.disableElevatedTerrain&&(this.disableElevatedTerrain=De.hasCanvasFingerprintNoise()),this.disableElevatedTerrain?nt("Terrain and hillshade are disabled because of Canvas2D limitations when fingerprinting protection is enabled (e.g. in private browsing mode)."):this.terrainSetForDrapingOnly()||this._createTerrain(s,1)),this.stylesheet.fog&&this._createFog(this.stylesheet.fog),this.stylesheet.transition&&this.setTransition(this.stylesheet.transition),this.fire(new Mt("data",{dataType:"style"})),t.imports?this._loadImports(t.imports,n).then(()=>this._reloadImports()):this._reloadImports()}isRootStyle(){return 0===this.importDepth}mergeAll(){let t,n,r,o,s,c,u,d;this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(f=>{if(f.stylesheet){if(null!=f.light&&(t=f.light),f.stylesheet.lights)for(const m of f.stylesheet.lights)"ambient"===m.type&&null!=f.ambientLight&&(n=f.ambientLight),"directional"===m.type&&null!=f.directionalLight&&(r=f.directionalLight);o=this._prioritizeTerrain(o,f.terrain,f.stylesheet.terrain),f.stylesheet.fog&&null!=f.fog&&(s=f.fog),null!=f.stylesheet.camera&&(d=f.stylesheet.camera),null!=f.stylesheet.projection&&(c=f.stylesheet.projection),null!=f.stylesheet.transition&&(u=f.stylesheet.transition)}}),this.light=t,this.ambientLight=n,this.directionalLight=r,this.fog=s,null===o?delete this.terrain:this.terrain=o,this.camera=d||{"camera-projection":"perspective"},this.projection=c||{name:"mercator"},this.transition=Wt({},Wg,u),this.mergeSources(),this.mergeLayers()}forEachFragmentStyle(t){const n=r=>{for(const o of r.fragments)n(o.style);t(r)};n(this)}_prioritizeTerrain(t,n,r){const o=t&&0===t.drapeRenderMode;return null===r?n&&0===n.drapeRenderMode?n:o?t:null:null!=n&&(!t||o||n&&1===n.drapeRenderMode)?n:t}mergeTerrain(){let t;this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(n=>{t=this._prioritizeTerrain(t,n.terrain,n.stylesheet.terrain)}),null===t?delete this.terrain:this.terrain=t}mergeProjection(){let t;this.forEachFragmentStyle(n=>{null!=n.stylesheet.projection&&(t=n.stylesheet.projection)}),this.projection=t||{name:"mercator"}}mergeSources(){const t={},n={},r={};this.forEachFragmentStyle(o=>{for(const s in o._sourceCaches){const c=$i(s,o.scope);t[c]=o._sourceCaches[s]}for(const s in o._otherSourceCaches){const c=$i(s,o.scope);n[c]=o._otherSourceCaches[s]}for(const s in o._symbolSourceCaches){const c=$i(s,o.scope);r[c]=o._symbolSourceCaches[s]}}),this._mergedSourceCaches=t,this._mergedOtherSourceCaches=n,this._mergedSymbolSourceCaches=r}mergeLayers(){const t={},n=[],r={};this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this.forEachFragmentStyle(s=>{for(const c of s._order){const u=s._layers[c];if("slot"===u.type){const d=pf(c);if(t[d])continue;t[d]=[]}u.slot&&t[u.slot]?t[u.slot].push(u):n.push(u)}}),this._mergedOrder=[];const o=(s=[])=>{for(const c of s)if("slot"===c.type){const u=pf(c.id);t[u]&&o(t[u])}else{const u=$i(c.id,c.scope);this._mergedOrder.push(u),r[u]=c,c.is3D()&&(this._has3DLayers=!0),"circle"===c.type&&(this._hasCircleLayers=!0),"symbol"===c.type&&(this._hasSymbolLayers=!0)}};o(n),this._mergedLayers=r,this.updateDrapeFirstLayers(),this._buildingIndex.processLayersChanged()}terrainSetForDrapingOnly(){return!!this.terrain&&0===this.terrain.drapeRenderMode}getCamera(){return this.stylesheet.camera}setCamera(t){return this.stylesheet.camera=Wt({},this.stylesheet.camera,t),this.camera=this.stylesheet.camera,this}setProjection(t){t?this.stylesheet.projection=t:delete this.stylesheet.projection,this.mergeProjection(),this._updateMapProjection()}applyProjectionUpdate(){this._loaded&&(this.dispatcher.broadcast("setProjection",this.map.transform.projectionOptions),this.map.transform.projection.requiresDraping?this.getTerrain()||this.stylesheet.terrain||this.setTerrainForDraping():this.terrainSetForDrapingOnly()&&this.setTerrain(null))}_updateMapProjection(){this.isRootStyle()&&(this.map._useExplicitProjection?this.applyProjectionUpdate():this.map._prioritizeAndUpdateProjection(null,this.projection))}_loadSprite(t){this._spriteRequest=function(n,r,o){let s,c,u;const d=De.devicePixelRatio>1?"@2x":"";let f=zt(r.transformRequest(r.normalizeSpriteURL(n,d,".json"),yt.SpriteJSON),(y,v)=>{f=null,u||(u=y,s=v,g())}),m=xe(r.transformRequest(r.normalizeSpriteURL(n,d,".png"),yt.SpriteImage),(y,v)=>{m=null,u||(u=y,c=v,g())});function g(){if(u)o(u);else if(s&&c){const y=De.getImageData(c),v={};for(const x in s){const{width:w,height:E,x:M,y:D,sdf:A,pixelRatio:P,stretchX:C,stretchY:R,content:k}=s[x],N=new $r({width:w,height:E});$r.copy(y,N,{x:M,y:D},{x:0,y:0},{width:w,height:E}),v[x]={data:N,pixelRatio:P,sdf:A,stretchX:C,stretchY:R,content:k}}o(null,v)}}return{cancel(){f&&(f.cancel(),f=null),m&&(m.cancel(),m=null)}}}(t,this.map._requestManager,(n,r)=>{if(this._spriteRequest=null,n)this.fire(new Tt(n));else if(r)for(const o in r)this.imageManager.addImage(o,this.scope,r[o]);this.imageManager.setLoaded(!0,this.scope),this._availableImages=this.imageManager.listImages(this.scope),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages}),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new Mt("data",{dataType:"style"}))})}_validateLayer(t){const n=this.getOwnSource(t.source);if(!n)return;const r=t.sourceLayer;r&&("geojson"===n.type||n.vectorLayerIds&&-1===n.vectorLayerIds.indexOf(r))&&this.fire(new Tt(new Error(`Source layer "${r}" does not exist on source "${n.id}" as specified by style layer "${t.id}"`)))}loaded(){if(!this._loaded||Object.keys(this._changes.getUpdatedSourceCaches()).length)return!1;for(const t in this._sourceCaches)if(!this._sourceCaches[t].loaded())return!1;if(!this.imageManager.isLoaded()||!this.modelManager.isLoaded())return!1;for(const{style:t}of this.fragments)if(!t.loaded())return!1;return!0}_serializeImports(){if(this.stylesheet.imports)return this.stylesheet.imports.map((t,n)=>{const r=this.fragments[n];return r&&r.style&&(t.data=r.style.serialize()),t})}_serializeSources(){const t={};for(const n in this._sourceCaches){const r=this._sourceCaches[n].getSource();t[r.id]||(t[r.id]=r.serialize())}return t}_serializeLayers(t){const n=[];for(const r of t){const o=this._layers[r];o&&"custom"!==o.type&&n.push(o.serialize())}return n}hasLightTransitions(){return!(!this.light||!this.light.hasTransition())||!(!this.ambientLight||!this.ambientLight.hasTransition())||!(!this.directionalLight||!this.directionalLight.hasTransition())}hasFogTransition(){return!!this.fog&&this.fog.hasTransition()}hasTransitions(){if(this.hasLightTransitions()||this.hasFogTransition())return!0;for(const t in this._sourceCaches)if(this._sourceCaches[t].hasTransition())return!0;for(const t in this._layers)if(this._layers[t].hasTransition())return!0;return!1}get order(){return this.terrain?this._drapedFirstOrder:this._mergedOrder}isLayerDraped(t){return!!this.terrain&&("function"==typeof t.isLayerDraped?t.isLayerDraped(this.getLayerSourceCache(t)):UC.has(t.type))}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading")}_checkLayer(t){const n=this.getOwnLayer(t);if(n)return n;this.fire(new Tt(new Error(`The layer '${t}' does not exist in the map's style.`)))}_checkSource(t){const n=this.getOwnSource(t);if(n)return n;this.fire(new Tt(new Error(`The source '${t}' does not exist in the map's style.`)))}update(t){if(!this._loaded)return;this.ambientLight&&this.ambientLight.recalculate(t),this.directionalLight&&this.directionalLight.recalculate(t);const n=this.calculateLightsBrightness();t.brightness=n||0,n!==this._brightness&&(this._brightness=n,this.dispatcher.broadcast("setBrightness",n));const r=this._changes.isDirty();if(this._changes.isDirty()){const s=this._changes.getLayerUpdatesByScope();for(const c in s){const{updatedIds:u,removedIds:d}=s[c];(u||d)&&this._updateWorkerLayers(c,u,d)}this.updateSourceCaches(),this._updateTilesForChangedImages(),this.updateLayers(t),this.light&&this.light.updateTransitions(t),this.ambientLight&&this.ambientLight.updateTransitions(t),this.directionalLight&&this.directionalLight.updateTransitions(t),this.fog&&this.fog.updateTransitions(t),this._changes.reset()}const o={};for(const s in this._mergedSourceCaches){const c=this._mergedSourceCaches[s];o[s]=c.used,c.used=!1}for(const s of this._mergedOrder){const c=this._mergedLayers[s];if(c.recalculate(t,this._availableImages),!c.isHidden(t.zoom)){const u=this.getLayerSourceCache(c);u&&(u.used=!0)}if(!this._precompileDone&&this._shouldPrecompile)for(let u=c.minzoom||0;u<(c.maxzoom||25.5);u++){const d=this.map.painter;if(d){const f=c.getProgramIds();if(!f)continue;for(const m of f){const g=c.getDefaultProgramParams(m,t.zoom);g&&(d.style=this,this.fog&&(d._fogVisible=!0,g.overrideFog=!0,d.getOrCreateProgram(m,g)),d._fogVisible=!1,g.overrideFog=!1,d.getOrCreateProgram(m,g),(this.stylesheet.terrain||this.stylesheet.projection&&"globe"===this.stylesheet.projection.name)&&(g.overrideRtt=!0,d.getOrCreateProgram(m,g)))}}}}this._shouldPrecompile&&(this._precompileDone=!0);for(const s in o){const c=this._mergedSourceCaches[s];o[s]!==c.used&&c.getSource().fire(new Mt("data",{sourceDataType:"visibility",dataType:"source",sourceId:c.getSource().id}))}this.light&&this.light.recalculate(t),this.terrain&&this.terrain.recalculate(t),this.fog&&this.fog.recalculate(t),this.z=t.zoom,this._markersNeedUpdate&&(this._updateMarkersOpacity(),this._markersNeedUpdate=!1),r&&this.fire(new Mt("data",{dataType:"style"}))}_updateTilesForChangedImages(){const t=this._changes.getUpdatedImages();if(t.length){for(const n in this._sourceCaches)this._sourceCaches[n].reloadTilesForDependencies(["icons","patterns"],t);this._changes.resetUpdatedImages()}}_updateWorkerLayers(t,n,r){const o=this.getFragmentStyle(t);o&&this.dispatcher.broadcast("updateLayers",{layers:n?o._serializeLayers(n):[],scope:t,removedIds:r||[],options:o.options})}setState(t){if(this._checkLoaded(),Ud(this,bl(t)))return!1;(t=q(t)).layers=ov(t.layers);const n=function(o,s){if(!o)return[{command:xn.setStyle,args:[s]}];let c=[];try{if(!tn(o.version,s.version))return[{command:xn.setStyle,args:[s]}];tn(o.center,s.center)||c.push({command:xn.setCenter,args:[s.center]}),tn(o.zoom,s.zoom)||c.push({command:xn.setZoom,args:[s.zoom]}),tn(o.bearing,s.bearing)||c.push({command:xn.setBearing,args:[s.bearing]}),tn(o.pitch,s.pitch)||c.push({command:xn.setPitch,args:[s.pitch]}),tn(o.sprite,s.sprite)||c.push({command:xn.setSprite,args:[s.sprite]}),tn(o.glyphs,s.glyphs)||c.push({command:xn.setGlyphs,args:[s.glyphs]}),tn(o.imports,s.imports)||function(g=[],y=[],v){y=y||[];const x=(g=g||[]).map(kg),w=y.map(kg),E=g.reduce(Ip,{}),M=y.reduce(Ip,{}),D=x.slice();let A,P,C,R;for(A=0,P=0;A<x.length;A++)C=x[A],M.hasOwnProperty(C)?P++:(v.push({command:xn.removeImport,args:[C]}),D.splice(D.indexOf(C,P),1));for(A=0,P=0;A<w.length;A++)C=w[w.length-1-A],D[D.length-1-A]!==C&&(E.hasOwnProperty(C)?(v.push({command:xn.removeImport,args:[C]}),D.splice(D.lastIndexOf(C,D.length-P),1)):P++,R=D[D.length-A],v.push({command:xn.addImport,args:[M[C],R]}),D.splice(D.length-A,0,C));for(const k of y){const N=E[k.id];if(!N||tn(N,k))continue;tn(N.config,k.config)||v.push({command:xn.setImportConfig,args:[k.id,k.config]}),tn(N.url,k.url)||v.push({command:xn.setImportUrl,args:[k.id,k.url]});const z=k.data;tn(N&&N.data,z)||v.push({command:xn.setImportData,args:[k.id,z]})}}(o.imports,s.imports,c),tn(o.transition,s.transition)||c.push({command:xn.setTransition,args:[s.transition]}),tn(o.light,s.light)||c.push({command:xn.setLight,args:[s.light]}),tn(o.fog,s.fog)||c.push({command:xn.setFog,args:[s.fog]}),tn(o.projection,s.projection)||c.push({command:xn.setProjection,args:[s.projection]}),tn(o.lights,s.lights)||c.push({command:xn.setLights,args:[s.lights]}),tn(o.camera,s.camera)||c.push({command:xn.setCamera,args:[s.camera]});const u={},d=[];!function(g,y,v,x){let w;for(w in y=y||{},g=g||{})g.hasOwnProperty(w)&&(y.hasOwnProperty(w)||Jw(w,v,x));for(w in y){if(!y.hasOwnProperty(w))continue;const E=y[w];g.hasOwnProperty(w)?tn(g[w],E)||("geojson"===g[w].type&&"geojson"===E.type&&bD(g,y,w)?v.push({command:xn.setGeoJSONSourceData,args:[w,E.data]}):Qw(w,y,v,x)):sv(w,y,v)}}(o.sources,s.sources,d,u);const f=[];o.layers&&o.layers.forEach(g=>{g.source&&u[g.source]?c.push({command:xn.removeLayer,args:[g.id]}):f.push(g)});let m=o.terrain;m&&u[m.source]&&(c.push({command:xn.setTerrain,args:[void 0]}),m=void 0),c=c.concat(d),tn(m,s.terrain)||c.push({command:xn.setTerrain,args:[s.terrain]}),function(g,y,v){y=y||[];const x=(g=g||[]).map(kg),w=y.map(kg),E=g.reduce(Ip,{}),M=y.reduce(Ip,{}),D=x.slice(),A=Object.create(null);let P,C,R,k,N,z,B;for(P=0,C=0;P<x.length;P++)R=x[P],M.hasOwnProperty(R)?C++:(v.push({command:xn.removeLayer,args:[R]}),D.splice(D.indexOf(R,C),1));for(P=0,C=0;P<w.length;P++)R=w[w.length-1-P],D[D.length-1-P]!==R&&(E.hasOwnProperty(R)?(v.push({command:xn.removeLayer,args:[R]}),D.splice(D.lastIndexOf(R,D.length-C),1)):C++,z=D[D.length-P],v.push({command:xn.addLayer,args:[M[R],z]}),D.splice(D.length-P,0,R),A[R]=!0);for(P=0;P<w.length;P++)if(R=w[P],k=E[R],N=M[R],!A[R]&&!tn(k,N))if(tn(k.source,N.source)&&tn(k["source-layer"],N["source-layer"])&&tn(k.type,N.type)){for(B in Ld(k.layout,N.layout,v,R,null,xn.setLayoutProperty),Ld(k.paint,N.paint,v,R,null,xn.setPaintProperty),tn(k.slot,N.slot)||v.push({command:xn.setSlot,args:[R,N.slot]}),tn(k.filter,N.filter)||v.push({command:xn.setFilter,args:[R,N.filter]}),tn(k.minzoom,N.minzoom)&&tn(k.maxzoom,N.maxzoom)||v.push({command:xn.setLayerZoomRange,args:[R,N.minzoom,N.maxzoom]}),k)k.hasOwnProperty(B)&&"layout"!==B&&"paint"!==B&&"filter"!==B&&"metadata"!==B&&"minzoom"!==B&&"maxzoom"!==B&&"slot"!==B&&(0===B.indexOf("paint.")?Ld(k[B],N[B],v,R,B.slice(6),xn.setPaintProperty):tn(k[B],N[B])||v.push({command:xn.setLayerProperty,args:[R,B,N[B]]}));for(B in N)N.hasOwnProperty(B)&&!k.hasOwnProperty(B)&&"layout"!==B&&"paint"!==B&&"filter"!==B&&"metadata"!==B&&"minzoom"!==B&&"maxzoom"!==B&&"slot"!==B&&(0===B.indexOf("paint.")?Ld(k[B],N[B],v,R,B.slice(6),xn.setPaintProperty):tn(k[B],N[B])||v.push({command:xn.setLayerProperty,args:[R,B,N[B]]}))}else v.push({command:xn.removeLayer,args:[R]}),z=D[D.lastIndexOf(R)+1],v.push({command:xn.addLayer,args:[N,z]})}(f,s.layers,c)}catch(u){console.warn("Unable to compute style diff:",u),c=[{command:xn.setStyle,args:[s]}]}return c}(this.serialize(),t).filter(o=>!(o.command in pS));if(0===n.length)return!1;const r=n.filter(o=>!(o.command in Gd));if(r.length>0)throw new Error(`Unimplemented: ${r.map(o=>o.command).join(", ")}.`);return n.forEach(o=>{this[o.command].apply(this,o.args)}),this.stylesheet=t,this.mergeAll(),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),!0}addImage(t,n){return this.getImage(t)?this.fire(new Tt(new Error("An image with this name already exists."))):(this.imageManager.addImage(t,this.scope,n),this._afterImageUpdated(t),this)}updateImage(t,n){this.imageManager.updateImage(t,this.scope,n)}getImage(t){return this.imageManager.getImage(t,this.scope)}removeImage(t){return this.getImage(t)?(this.imageManager.removeImage(t,this.scope),this._afterImageUpdated(t),this):this.fire(new Tt(new Error("No image with this name exists.")))}_afterImageUpdated(t){this._availableImages=this.imageManager.listImages(this.scope),this._changes.updateImage(t),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages}),this.fire(new Mt("data",{dataType:"style"}))}listImages(){return this._checkLoaded(),this._availableImages.slice()}addModel(t,n,r={}){return this._checkLoaded(),this._validate(Ix,`models.${t}`,n,null,r)||(this.modelManager.addModel(t,n,this.scope),this._changes.setDirty()),this}hasModel(t){return this.modelManager.hasModel(t,this.scope)}removeModel(t){return this.hasModel(t)?(this.modelManager.removeModel(t,this.scope),this):this.fire(new Tt(new Error("No model with this ID exists.")))}listModels(){return this._checkLoaded(),this.modelManager.listModels(this.scope)}addSource(t,n,r={}){if(this._checkLoaded(),void 0!==this.getOwnSource(t))throw new Error(`There is already a source with ID "${t}".`);if(!n.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(n).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(n.type)>=0&&this._validate(Wo,`sources.${t}`,n,null,r))return;this.map&&this.map._collectResourceTiming&&(n.collectResourceTiming=!0);const o=iv(t,n,this.dispatcher,this);o.scope=this.scope,o.setEventedParent(this,()=>({isSourceLoaded:this._isSourceCacheLoaded(o.id),source:o.serialize(),sourceId:o.id}));const s=c=>{const u=(c?"symbol:":"other:")+o.id,d=$i(u,this.scope),f=this._sourceCaches[u]=new ha(d,o,c);(c?this._symbolSourceCaches:this._otherSourceCaches)[o.id]=f,f.onAdd(this.map)};s(!1),"vector"!==n.type&&"geojson"!==n.type||s(!0),o.onAdd&&o.onAdd(this.map),r.isInitialLoad||(this.mergeSources(),this._changes.setDirty())}removeSource(t){this._checkLoaded();const n=this.getOwnSource(t);if(!n)throw new Error("There is no source with this ID");for(const o in this._layers)if(this._layers[o].source===t)return this.fire(new Tt(new Error(`Source "${t}" cannot be removed while layer "${o}" is using it.`)));if(this.terrain&&this.terrain.scope===this.scope&&this.terrain.get().source===t)return this.fire(new Tt(new Error(`Source "${t}" cannot be removed while terrain is using it.`)));const r=this.getOwnSourceCaches(t);for(const o of r){const s=pf(o.id);delete this._sourceCaches[s],this._changes.discardSourceCacheUpdate(o.id),o.fire(new Mt("data",{sourceDataType:"metadata",dataType:"source",sourceId:o.getSource().id})),o.setEventedParent(null),o.clearTiles()}return delete this._otherSourceCaches[t],delete this._symbolSourceCaches[t],this.mergeSources(),n.setEventedParent(null),n.onRemove&&n.onRemove(this.map),this._changes.setDirty(),this}setGeoJSONSourceData(t,n){this._checkLoaded(),this.getOwnSource(t).setData(n),this._changes.setDirty()}getOwnSource(t){const n=this.getOwnSourceCache(t);return n&&n.getSource()}getOwnSources(){const t=[];for(const n in this._otherSourceCaches){const r=this.getOwnSourceCache(n);r&&t.push(r.getSource())}return t}setLights(t){if(this._checkLoaded(),!t)return delete this.ambientLight,void delete this.directionalLight;const n=this._getTransitionParameters();for(const o of t){if(this._validate(Mx,"lights",o))return;switch(o.type){case"ambient":if(this.ambientLight){const s=this.ambientLight;s.set(o),s.updateTransitions(n)}else this.ambientLight=new U0(o,FC,this.scope,this.options);break;case"directional":if(this.directionalLight){const s=this.directionalLight;s.set(o),s.updateTransitions(n)}else this.directionalLight=new U0(o,jr,this.scope,this.options)}}const r=new ar(this.z||0,n);this.ambientLight&&this.ambientLight.recalculate(r),this.directionalLight&&this.directionalLight.recalculate(r),this._brightness=this.calculateLightsBrightness(),this.dispatcher.broadcast("setBrightness",this._brightness)}calculateLightsBrightness(){const t=this.directionalLight,n=this.ambientLight;if(!t||!n)return;const r=g=>.2126*(g[0]<=.03928?g[0]/12.92:Math.pow((g[0]+.055)/1.055,2.4))+.7152*(g[1]<=.03928?g[1]/12.92:Math.pow((g[1]+.055)/1.055,2.4))+.0722*(g[2]<=.03928?g[2]/12.92:Math.pow((g[2]+.055)/1.055,2.4)),o=t.properties.get("color").toArray01(),s=t.properties.get("intensity"),c=t.properties.get("direction"),u=1-ae(c.x,c.y,c.z)[2]/90,d=r(o)*s*u,f=n.properties.get("color").toArray01(),m=n.properties.get("intensity");return(d+r(f)*m)/2}getBrightness(){return this._brightness}getLights(){if(!this.enable3dLights())return null;const t=[];return this.directionalLight&&t.push(this.directionalLight.get()),this.ambientLight&&t.push(this.ambientLight.get()),t}enable3dLights(){return!!this.ambientLight&&!!this.directionalLight}getFragmentStyle(t){if(!t)return this;if(S_(t)){const n=function(s){const c=s.indexOf("\x1f");return c>=0?s.slice(c+1):""}(t),r=this.fragments.find(({id:s})=>s===n);if(!r)throw new Error(`Style import not found: ${t}`);const o=pf(t);return r.style.getFragmentStyle(o)}{const n=this.fragments.find(({id:r})=>r===t);if(!n)throw new Error(`Style import not found: ${t}`);return n.style}}getConfigProperty(t,n){const r=this.getFragmentStyle(t);if(!r)return null;const o=r.options.get(n),s=o?o.value||o.default:null;return s?s.serialize():null}setConfigProperty(t,n,r){const o=yl(r);if("success"!==o.result)return void Ud(this,o.value);const s=o.value.expression,c=this.getFragmentStyle(t);if(!c)return;const u=c.options.get(n);u&&(c.options.set(n,{...u,value:s}),c.updateConfigDependencies())}setConfig(t,n){if(this._config=t,t||n)if(n){this.options.clear();for(const r in n){let o,s;const c=yl(n[r].default);if("success"===c.result&&(o=c.value.expression),t&&void 0!==t[r]){const y=yl(t[r]);"success"===y.result&&(s=y.value.expression)}const{minValue:u,maxValue:d,stepValue:f,type:m,values:g}=n[r];o?this.options.set(r,{default:o,value:s,minValue:u,maxValue:d,stepValue:f,type:m,values:g}):this.fire(new Tt(new Error(`No schema defined for config option "${r}".`)))}}else this.fire(new Tt(new Error("Attempting to set config for a style without schema.")))}updateConfigDependencies(){for(const t of this._configDependentLayers){const n=this.getLayer(t);n&&(n.possiblyEvaluateVisibility(),this._updateLayer(n))}this.ambientLight&&this.ambientLight.scope===this.scope&&this.ambientLight.updateConfig(this.options),this.directionalLight&&this.directionalLight.scope===this.scope&&this.directionalLight.updateConfig(this.options),this._changes.setDirty()}addLayer(t,n,r={}){this._checkLoaded();const o=t.id;if(this._layers[o])return void this.fire(new Tt(new Error(`Layer with id "${o}" already exists on this map`)));let s;if("custom"===t.type){if(Ud(this,function(m){const g=[],y=m.id;return void 0===y&&g.push({message:`layers.${y}: missing required property "id"`}),void 0===m.render&&g.push({message:`layers.${y}: missing required method "render"`}),m.renderingMode&&"2d"!==m.renderingMode&&"3d"!==m.renderingMode&&g.push({message:`layers.${y}: property "renderingMode" must be either "2d" or "3d"`}),g}(t)))return;s=Cg(t,this.options)}else{if("object"==typeof t.source&&(this.addSource(o,t.source),t=Wt(t=q(t),{source:o})),this._validate(QT,`layers.${o}`,t,{arrayIndex:-1},r))return;s=Cg(t,this.options),this._validateLayer(s),s.setEventedParent(this,{layer:{id:o}}),this._serializedLayers[s.id]=s.serialize()}s.isConfigDependent&&this._configDependentLayers.add(s.fqid),s.setScope(this.scope);let c=this._order.length;if(n){const m=this._order.indexOf(n);if(-1===m)return void this.fire(new Tt(new Error(`Layer with id "${n}" does not exist on this map.`)));s.slot===this._layers[n].slot?c=m:nt(`Layer with id "${n}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(c,0,o),this._layerOrderChanged=!0,this._layers[o]=s;const u=this.getOwnLayerSourceCache(s),d=!!this.directionalLight&&this.directionalLight.shadowsEnabled();u&&s.canCastShadows()&&d&&(u.castsShadows=!0);const f=this._changes.getRemovedLayer(s);if(f&&s.source&&u&&"custom"!==s.type){this._changes.discardLayerRemoval(s);const m=$i(s.source,s.scope);f.type!==s.type?this._changes.updateSourceCache(m,"clear"):(this._changes.updateSourceCache(m,"reload"),u.pause())}this._updateLayer(s),s.onAdd&&s.onAdd(this.map),s.scope=this.scope,this.mergeLayers()}moveLayer(t,n){this._checkLoaded();const r=this._checkLayer(t);if(!r||t===n)return;const o=this._order.indexOf(t);this._order.splice(o,1);let s=this._order.length;if(n){const c=this._order.indexOf(n);if(-1===c)return void this.fire(new Tt(new Error(`Layer with id "${n}" does not exist on this map.`)));r.slot===this._layers[n].slot?s=c:nt(`Layer with id "${n}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(s,0,t),this._changes.setDirty(),this._layerOrderChanged=!0,this.mergeLayers()}removeLayer(t){this._checkLoaded();const n=this._checkLayer(t);if(!n)return;n.setEventedParent(null);const r=this._order.indexOf(t);this._order.splice(r,1),delete this._layers[t],delete this._serializedLayers[t],this._changes.setDirty(),this._layerOrderChanged=!0,this._configDependentLayers.delete(n.fqid),this._changes.removeLayer(n);const o=this.getOwnLayerSourceCache(n);if(o&&o.castsShadows){let s=!1;for(const c in this._layers)if(this._layers[c].source===n.source&&this._layers[c].canCastShadows()){s=!0;break}o.castsShadows=s}n.onRemove&&n.onRemove(this.map),this.mergeLayers()}getOwnLayer(t){return this._layers[t]}hasLayer(t){return t in this._mergedLayers}hasLayerType(t){for(const n in this._layers)if(this._layers[n].type===t)return!0;return!1}setLayerZoomRange(t,n,r){this._checkLoaded();const o=this._checkLayer(t);o&&(o.minzoom===n&&o.maxzoom===r||(null!=n&&(o.minzoom=n),null!=r&&(o.maxzoom=r),this._updateLayer(o)))}setSlot(t,n){this._checkLoaded();const r=this._checkLayer(t);r&&r.slot!==n&&(r.slot=n,this._updateLayer(r))}setFilter(t,n,r={}){this._checkLoaded();const o=this._checkLayer(t);if(o&&!tn(o.filter,n))return null==n?(o.filter=void 0,void this._updateLayer(o)):void(this._validate(w_,`layers.${o.id}.filter`,n,{layerType:o.type},r)||(o.filter=q(n),this._updateLayer(o)))}getFilter(t){const n=this._checkLayer(t);if(n)return q(n.filter)}setLayoutProperty(t,n,r,o={}){this._checkLoaded();const s=this._checkLayer(t);s&&(tn(s.getLayoutProperty(n),r)||(s.setLayoutProperty(n,r,o),s.isConfigDependent&&this._configDependentLayers.add(s.fqid),this._updateLayer(s)))}getLayoutProperty(t,n){const r=this._checkLayer(t);if(r)return r.getLayoutProperty(n)}setPaintProperty(t,n,r,o={}){this._checkLoaded();const s=this._checkLayer(t);if(!s||tn(s.getPaintProperty(n),r))return;const c=s.setPaintProperty(n,r,o);s.isConfigDependent&&this._configDependentLayers.add(s.fqid),c&&this._updateLayer(s),this._changes.updatePaintProperties(s)}getPaintProperty(t,n){const r=this._checkLayer(t);if(r)return r.getPaintProperty(n)}setFeatureState(t,n){this._checkLoaded();const r=t.source,o=t.sourceLayer,s=this._checkSource(r);if(!s)return;const c=s.type;if("geojson"===c&&o)return void this.fire(new Tt(new Error("GeoJSON sources cannot have a sourceLayer parameter.")));if("vector"===c&&!o)return void this.fire(new Tt(new Error("The sourceLayer parameter must be provided for vector source types.")));void 0===t.id&&this.fire(new Tt(new Error("The feature id parameter must be provided.")));const u=this.getOwnSourceCaches(r);for(const d of u)d.setFeatureState(o,t.id,n)}removeFeatureState(t,n){this._checkLoaded();const r=t.source,o=this._checkSource(r);if(!o)return;const s=o.type,c="vector"===s?t.sourceLayer:void 0;if("vector"===s&&!c)return void this.fire(new Tt(new Error("The sourceLayer parameter must be provided for vector source types.")));if(n&&"string"!=typeof t.id&&"number"!=typeof t.id)return void this.fire(new Tt(new Error("A feature id is required to remove its specific state property.")));const u=this.getOwnSourceCaches(r);for(const d of u)d.removeFeatureState(c,t.id,n)}getFeatureState(t){this._checkLoaded();const n=t.source,r=t.sourceLayer,o=this._checkSource(n);if(o){if("vector"!==o.type||r)return void 0===t.id&&this.fire(new Tt(new Error("The feature id parameter must be provided."))),this.getOwnSourceCaches(n)[0].getFeatureState(r,t.id);this.fire(new Tt(new Error("The sourceLayer parameter must be provided for vector source types.")))}}setTransition(t){return this.stylesheet.transition=Wt({},this.stylesheet.transition,t),this.transition=this.stylesheet.transition,this}getTransition(){return Wt({},this.stylesheet.transition)}serialize(){this._checkLoaded();const t=this.getTerrain(),n=t&&this.terrain&&this.terrain.scope===this.scope?t:this.stylesheet.terrain;return St({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,imports:this._serializeImports(),schema:this.stylesheet.schema,camera:this.stylesheet.camera,light:this.stylesheet.light,lights:this.stylesheet.lights,terrain:n,fog:this.stylesheet.fog,center:this.stylesheet.center,zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,projection:this.stylesheet.projection,sources:this._serializeSources(),layers:this._serializeLayers(this._order)},r=>void 0!==r)}_updateLayer(t){this._changes.updateLayer(t);const n=this.getLayerSourceCache(t),r=$i(t.source,t.scope),o=this._changes.getUpdatedSourceCaches();t.source&&!o[r]&&n&&"raster"!==n.getSource().type&&(this._changes.updateSourceCache(r,"reload"),n.pause()),t.invalidateCompiledFilter()}_flattenAndSortRenderedFeatures(t){const n=u=>"fill-extrusion"===this._mergedLayers[u].type,r=this.order,o={},s=[];for(let u=r.length-1;u>=0;u--){const d=r[u];if(n(d)){o[d]=u;for(const f of t){const m=f[d];if(m)for(const g of m)s.push(g)}}}s.sort((u,d)=>d.intersectionZ-u.intersectionZ);const c=[];for(let u=r.length-1;u>=0;u--){const d=r[u];if(n(d))for(let f=s.length-1;f>=0;f--){const m=s[f].feature;if(o[m.layer.id]<u)break;c.push(m),s.pop()}else for(const f of t){const m=f[d];if(m)for(const g of m)c.push(g.feature)}}return c}queryRenderedFeatures(t,n,r){n&&n.filter&&this._validate(w_,"queryRenderedFeatures.filter",n.filter,null,n),n.scope=this.scope,n.availableImages=this._availableImages,n.serializedLayers=this._serializedLayers;const o={};if(n&&n.layers){if(!Array.isArray(n.layers))return this.fire(new Tt(new Error("parameters.layers must be an Array."))),[];for(const f of n.layers){const m=this._mergedLayers[f];if(!m)return this.fire(new Tt(new Error(`The layer '${f}' does not exist in the map's style and cannot be queried for features.`))),[];o[m.source]=!0}}const s=[],c=n.serializedLayers||{},u=n&&n.layers?n.layers.some(f=>{const m=this.getLayer(f);return m&&m.is3D()}):this.has3DLayers(),d=G0.createFromScreenPoints(t,r);for(const f in this._mergedSourceCaches){const m=this._mergedSourceCaches[f].getSource();if(!m||m.scope!==n.scope)continue;const g=this._mergedSourceCaches[f].getSource().id;n.layers&&!o[g]||s.push(yD(this._mergedSourceCaches[f],this._mergedLayers,c,d,n,r,u,!!this.map._showQueryGeometry))}return this.placement&&s.push(function(f,m,g,y,v,x,w){const E={},M=x.queryRenderedSymbols(y),D=[];for(const A of Object.keys(M).map(Number))D.push(w[A]);D.sort(Kw);for(const A of D){const P=A.featureIndex.lookupSymbolFeatures(M[A.bucketInstanceId],m,A.bucketIndex,A.sourceLayerIndex,v.filter,v.layers,v.availableImages,f);for(const C in P){const R=E[C]=E[C]||[],k=P[C];k.sort((N,z)=>{const B=A.featureSortOrder;if(B){const U=B.indexOf(N.featureIndex);return B.indexOf(z.featureIndex)-U}return z.featureIndex-N.featureIndex});for(const N of k)R.push(N)}}for(const A in E)E[A].forEach(P=>{const C=P.feature,R=g(f[A]);if(!R)return;const k=R.getFeatureState(C.layer["source-layer"],C.id);C.source=C.layer.source,C.layer["source-layer"]&&(C.sourceLayer=C.layer["source-layer"]),C.state=k});return E}(this._mergedLayers,c,this.getLayerSourceCache.bind(this),d.screenGeometry,n,this.placement.collisionIndex,this.placement.retainedQueryData)),this._flattenAndSortRenderedFeatures(s)}querySourceFeatures(t,n){n&&n.filter&&this._validate(w_,"querySourceFeatures.filter",n.filter,null,n);const r=this.getOwnSourceCaches(t);let o=[];for(const s of r)o=o.concat(Yw(s,n));return o}addSourceType(t,n,r){return ma.getSourceType(t)?r(new Error(`A source type called "${t}" already exists.`)):(ma.setSourceType(t,n),n.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:t,url:n.workerSourceURL},r):r(null,null))}getFlatLight(){return this.light.getLight()}setFlatLight(t,n,r={}){this._checkLoaded();const o=this.light.getLight();let s=!1;for(const u in t)if(!tn(t[u],o[u])){s=!0;break}if(!s)return;const c=this._getTransitionParameters();this.light.setLight(t,n,r),this.light.updateTransitions(c)}getTerrain(){return this.terrain&&1===this.terrain.drapeRenderMode?this.terrain.get():null}setTerrainForDraping(){this.setTerrain({source:"",exaggeration:0},0)}setTerrain(t,n=1){if(this._checkLoaded(),!t)return delete this.terrain,null===t?this.stylesheet.terrain=null:delete this.stylesheet.terrain,this._force3DLayerUpdate(),void(this._markersNeedUpdate=!0);let r=t;const o=null==t.source;if(1===n){if("object"==typeof r.source){const u="terrain-dem-src";this.addSource(u,r.source),r=q(r),r=Wt(r,{source:u})}const s=Wt({},r),c={};if(this.terrain&&o){s.source=this.terrain.get().source;const u=this.terrain?this.getFragmentStyle(this.terrain.scope):null;u&&(c.style=u.serialize())}if(this._validate(Dh,"terrain",s,c))return}if(!this.terrain||this.terrain.scope!==this.scope&&!o||this.terrain&&n!==this.terrain.drapeRenderMode){if(!r)return;this._createTerrain(r,n),this.fire(new Mt("data",{dataType:"style"}))}else{const s=this.terrain,c=s.get();for(const u of Object.keys(H.terrain))!r.hasOwnProperty(u)&&H.terrain[u].default&&(r[u]=H.terrain[u].default);for(const u in t)if(!tn(t[u],c[u])){s.set(t,this.options),this.stylesheet.terrain=t;const d=this._getTransitionParameters({duration:0});s.updateTransitions(d),this.fire(new Mt("data",{dataType:"style"}));break}}this.mergeTerrain(),this.updateDrapeFirstLayers(),this._markersNeedUpdate=!0}_createFog(t){const n=this.fog=new Sd(t,this.map.transform);this.stylesheet.fog=n.get();const r=this._getTransitionParameters({duration:0});n.updateTransitions(r)}_updateMarkersOpacity(){0!==this.map._markers.length&&this.map._requestDomTask(()=>{for(const t of this.map._markers)t._evaluateOpacity()})}getFog(){return this.fog?this.fog.get():null}setFog(t){if(this._checkLoaded(),!t)return delete this.fog,delete this.stylesheet.fog,void(this._markersNeedUpdate=!0);if(this.fog){const n=this.fog;if(!tn(n.get(),t)){n.set(t),this.stylesheet.fog=n.get();const r=this._getTransitionParameters({duration:0});n.updateTransitions(r)}}else this._createFog(t);this._markersNeedUpdate=!0}_getTransitionParameters(t){return{now:De.now(),transition:Wt(this.transition,t)}}updateDrapeFirstLayers(){if(!this.terrain)return;const t=[],n=[];for(const r in this._mergedLayers)this.isLayerDraped(this._mergedLayers[r])?t.push(r):n.push(r);this._drapedFirstOrder=[],this._drapedFirstOrder.push(...t),this._drapedFirstOrder.push(...n)}_createTerrain(t,n){const r=this.terrain=new Vw(t,n,this.scope,this.options);1===n&&(this.stylesheet.terrain=t),this.mergeTerrain(),this.updateDrapeFirstLayers(),this._force3DLayerUpdate();const o=this._getTransitionParameters({duration:0});r.updateTransitions(o)}_force3DLayerUpdate(){for(const t in this._layers){const n=this._layers[t];"fill-extrusion"===n.type&&this._updateLayer(n)}}_forceSymbolLayerUpdate(){for(const t in this._layers){const n=this._layers[t];"symbol"===n.type&&this._updateLayer(n)}}_validate(t,n,r,o,s={}){if(s&&!1===s.validate)return!1;const c=Wt({},this.serialize());return Ud(this,t.call(bl,Wt({key:n,style:c,value:r,styleSpec:H},o)))}_remove(){this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),Px.off("pluginStateChange",this._rtlTextPluginCallback);for(const t in this._mergedLayers)this._mergedLayers[t].setEventedParent(null);for(const t in this._mergedSourceCaches)this._mergedSourceCaches[t].clearTiles(),this._mergedSourceCaches[t].setEventedParent(null);this.setEventedParent(null),delete this.fog,delete this.terrain,delete this.ambientLight,delete this.directionalLight,this.isRootStyle()&&(this.imageManager.setEventedParent(null),this.modelManager.setEventedParent(null),this.dispatcher.remove())}clearSource(t){const n=this.getSourceCaches(t);for(const r of n)r.clearTiles()}clearSources(){for(const t in this._mergedSourceCaches)this._mergedSourceCaches[t].clearTiles()}reloadSource(t){const n=this.getSourceCaches(t);for(const r of n)r.resume(),r.reload()}reloadSources(){for(const t of this.getSources())t.reload&&t.reload()}updateSources(t){let n;this.directionalLight&&(n=Zg(this.directionalLight));for(const r in this._mergedSourceCaches)this._mergedSourceCaches[r].update(t,void 0,void 0,n)}_generateCollisionBoxes(){for(const t in this._sourceCaches){const n=this._sourceCaches[t];n.resume(),n.reload()}}_updatePlacement(t,n,r,o,s=!1){let c=!1,u=!1;const d={},f={};for(const m of this._mergedOrder){const g=this._mergedLayers[m];if("symbol"!==g.type)continue;const y=$i(g.source,g.scope);let v=d[y];if(!v){const w=this.getLayerSourceCache(g);if(!w)continue;const E=w.getRenderableIds(!0).map(M=>w.getTileByID(M));f[y]=E.slice(),v=d[y]=E.sort((M,D)=>D.tileID.overscaledZ-M.tileID.overscaledZ||(M.tileID.isLessThan(D.tileID)?-1:1))}const x=this.crossTileSymbolIndex.addLayer(g,v,t.center.lng,t.projection);c=c||x}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._mergedOrder),s=s||this._layerOrderChanged||0===r,this._layerOrderChanged&&this.fire(new Mt("neworder")),(s||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(De.now(),t.zoom))&&(this.pauseablePlacement=new cv(t,this._mergedOrder,s,n,r,o,this.placement,this.fog&&t.projection.supportsFog?this.fog.state:null,this._buildingIndex),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._mergedOrder,this._mergedLayers,d,f),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(De.now()),u=!0),c&&this.pauseablePlacement.placement.setStale()),u||c)for(const m of this._mergedOrder){const g=this._mergedLayers[m];"symbol"===g.type&&this.placement.updateLayerOpacities(g,d[$i(g.source,g.scope)])}return!this.pauseablePlacement.isDone()||this.placement.hasTransitions(De.now())}_releaseSymbolFadeTiles(){for(const t in this._sourceCaches)this._sourceCaches[t].releaseSymbolFadeTiles()}addImport(t){this._checkLoaded();const n=this.stylesheet.imports=this.stylesheet.imports||[];return-1!==n.findIndex(({id:o})=>o===t.id)?this.fire(new Tt(new Error(`Import with id '${t.id}' already exists in the map's style.`))):(n.push(t),this._loadImports([t],!0),this)}setImportUrl(t,n){this._checkLoaded();const r=this.stylesheet.imports||[],o=this.getImportIndex(t);if(-1===o)return this;r[o].url=n;const s=this.fragments[o];return s.style=this._createFragmentStyle(r[o]),s.style.on("style.import.load",()=>this.mergeAll()),s.style.loadURL(n),this}setImportData(t,n){this._checkLoaded();const r=this.getImportIndex(t),o=this.stylesheet.imports||[];return-1===r?this:n?(this.fragments[r].style.setState(n),this._reloadImports(),this):(delete o[r].data,this.setImportUrl(t,o[r].url))}setImportConfig(t,n){this._checkLoaded();const r=this.getImportIndex(t),o=this.stylesheet.imports||[];if(-1===r)return this;n?o[r].config=n:delete o[r].config;const s=this.fragments[r],c=s.style.stylesheet&&s.style.stylesheet.schema;return s.config=n,s.style.setConfig(n,c),s.style.updateConfigDependencies(),this}removeImport(t){this._checkLoaded();const n=this.stylesheet.imports||[],r=this.getImportIndex(t);return-1===r||(n.splice(r,1),this.fragments[r].style._remove(),this.fragments.splice(r,1),this._reloadImports()),this}getImportIndex(t){const n=(this.stylesheet.imports||[]).findIndex(r=>r.id===t);return-1===n&&this.fire(new Tt(new Error(`Import '${t}' does not exist in the map's style and cannot be updated.`))),n}getLayer(t){return this._mergedLayers[t]}getSources(){const t=[];for(const n in this._mergedOtherSourceCaches){const r=this._mergedOtherSourceCaches[n];r&&t.push(r.getSource())}return t}getSource(t,n){const r=this.getSourceCache(t,n);return r&&r.getSource()}getLayerSource(t){const n=this.getLayerSourceCache(t);return n&&n.getSource()}getSourceCache(t,n){const r=$i(t,n);return this._mergedOtherSourceCaches[r]}getLayerSourceCache(t){const n=$i(t.source,t.scope);return"symbol"===t.type?this._mergedSymbolSourceCaches[n]:this._mergedOtherSourceCaches[n]}getSourceCaches(t){const n=[];return this._mergedOtherSourceCaches[t]&&n.push(this._mergedOtherSourceCaches[t]),this._mergedSymbolSourceCaches[t]&&n.push(this._mergedSymbolSourceCaches[t]),n}updateSourceCaches(){const t=this._changes.getUpdatedSourceCaches();for(const n in t){const r=t[n];"reload"===r?this.reloadSource(n):"clear"===r&&this.clearSource(n)}}updateLayers(t){const n=this._changes.getUpdatedPaintProperties();for(const r of n){const o=this.getLayer(r);o&&o.updateTransitions(t)}}getImages(t,n,r){this.imageManager.getImages(n.icons,n.scope,r),this._updateTilesForChangedImages();const o=s=>{s&&s.setDependencies(n.tileID.key,n.type,n.icons)};o(this._otherSourceCaches[n.source]),o(this._symbolSourceCaches[n.source])}getGlyphs(t,n,r){this.glyphManager.getGlyphs(n.stacks,n.scope,r)}getResource(t,n,r){return jt(n,r)}getOwnSourceCache(t){return this._otherSourceCaches[t]}getOwnLayerSourceCache(t){return"symbol"===t.type?this._symbolSourceCaches[t.source]:this._otherSourceCaches[t.source]}getOwnSourceCaches(t){const n=[];return this._otherSourceCaches[t]&&n.push(this._otherSourceCaches[t]),this._symbolSourceCaches[t]&&n.push(this._symbolSourceCaches[t]),n}_isSourceCacheLoaded(t){const n=this.getOwnSourceCaches(t);return 0===n.length?(this.fire(new Tt(new Error(`There is no source with ID '${t}'`))),!1):n.every(r=>r.loaded())}has3DLayers(){return this._has3DLayers}hasSymbolLayers(){return this._hasSymbolLayers}hasCircleLayers(){return this._hasCircleLayers}_clearWorkerCaches(){this.dispatcher.broadcast("clearCaches")}destroy(){this._clearWorkerCaches(),this.terrainSetForDrapingOnly()&&(delete this.terrain,delete this.stylesheet.terrain)}}function mS(e,t){let n=!1,r=null;const o=()=>{r=null,n&&(e(),r=setTimeout(o,t),n=!1)};return()=>(n=!0,r||o(),r)}ma.getSourceType=function(e){return rv[e]},ma.setSourceType=function(e,t){rv[e]=t},ma.registerForPluginStateChange=function(e){return e({pluginStatus:ni,pluginURL:ka}),Px.on("pluginStateChange",e),e};class gS{constructor(t){this._hashName=t&&encodeURIComponent(t),ei(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=mS(this._updateHashUnthrottled.bind(this),300)}addTo(t){return this._map=t,ft.addEventListener("hashchange",this._onHashChange,!1),t.on("moveend",this._updateHash),this}remove(){return this._map?(this._map.off("moveend",this._updateHash),ft.removeEventListener("hashchange",this._onHashChange,!1),clearTimeout(this._updateHash()),this._map=void 0,this):this}getHashString(){const t=this._map;if(!t)return"";const n=ZE(t);if(this._hashName){const r=this._hashName;let o=!1;const s=ft.location.hash.slice(1).split("&").map(c=>{const u=c.split("=")[0];return u===r?(o=!0,`${u}=${n}`):c}).filter(c=>c);return o||s.push(`${r}=${n}`),`#${s.join("&")}`}return`#${n}`}_getCurrentHash(){const t=ft.location.hash.replace("#","");if(this._hashName){let n;return t.split("&").map(r=>r.split("=")).forEach(r=>{r[0]===this._hashName&&(n=r)}),(n&&n[1]||"").split("/")}return t.split("/")}_onHashChange(){const t=this._map;if(!t)return!1;const n=this._getCurrentHash();if(n.length>=3&&!n.some(r=>isNaN(r))){const r=t.dragRotate.isEnabled()&&t.touchZoomRotate.isEnabled()?+(n[3]||0):t.getBearing();return t.jumpTo({center:[+n[2],+n[1]],zoom:+n[0],bearing:r,pitch:+(n[4]||0)}),!0}return!1}_updateHashUnthrottled(){const t=ft.location.href.replace(/(#.+)?$/,this.getHashString());ft.history.replaceState(ft.history.state,null,t)}}function ZE(e,t){const n=e.getCenter(),r=Math.round(100*e.getZoom())/100,o=Math.ceil((r*Math.LN2+Math.log(512/360/.5))/Math.LN10),s=Math.pow(10,o),c=Math.round(n.lng*s)/s,u=Math.round(n.lat*s)/s,d=e.getBearing(),f=e.getPitch();let m=t?`/${c}/${u}/${r}`:`${r}/${u}/${c}`;return(d||f)&&(m+="/"+Math.round(10*d)/10),f&&(m+=`/${Math.round(f)}`),m}const Xg={linearity:.3,easing:Ds(0,0,.3,1)},WE=Wt({deceleration:2500,maxSpeed:1400},Xg),XE=Wt({deceleration:20,maxSpeed:1400},Xg),_S=Wt({deceleration:1e3,maxSpeed:360},Xg),YE=Wt({deceleration:1e3,maxSpeed:90},Xg);class KE{constructor(t){this._map=t,this.clear()}clear(){this._inertiaBuffer=[]}record(t){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:De.now(),settings:t})}_drainInertiaBuffer(){const t=this._inertiaBuffer,n=De.now();for(;t.length>0&&n-t[0].time>160;)t.shift()}_onMoveEnd(t){if(this._map._prefersReducedMotion()||(this._drainInertiaBuffer(),this._inertiaBuffer.length<2))return;const n={zoom:0,bearing:0,pitch:0,pan:new it(0,0),pinchAround:void 0,around:void 0};for(const{settings:s}of this._inertiaBuffer)n.zoom+=s.zoomDelta||0,n.bearing+=s.bearingDelta||0,n.pitch+=s.pitchDelta||0,s.panDelta&&n.pan._add(s.panDelta),s.around&&(n.around=s.around),s.pinchAround&&(n.pinchAround=s.pinchAround);const r=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,o={};if(n.pan.mag()){const s=Kg(n.pan.mag(),r,Wt({},WE,t||{}));o.offset=n.pan.mult(s.amount/n.pan.mag()),o.center=this._map.transform.center,Yg(o,s)}if(n.zoom){const s=Kg(n.zoom,r,XE);o.zoom=this._map.transform.zoom+s.amount,Yg(o,s)}if(n.bearing){const s=Kg(n.bearing,r,_S);o.bearing=this._map.transform.bearing+ne(s.amount,-179,179),Yg(o,s)}if(n.pitch){const s=Kg(n.pitch,r,YE);o.pitch=this._map.transform.pitch+s.amount,Yg(o,s)}if(o.zoom||o.bearing){const s=void 0===n.pinchAround?n.around:n.pinchAround;o.around=s?this._map.unproject(s):this._map.getCenter()}return this.clear(),o.noMoveStart=!0,o}}function Yg(e,t){(!e.duration||e.duration<t.duration)&&(e.duration=t.duration,e.easing=t.easing)}function Kg(e,t,n){const{maxSpeed:r,linearity:o,deceleration:s}=n,c=ne(e*o/(t/1e3),-r,r),u=Math.abs(c)/(s*o);return{easing:n.easing,duration:1e3*u,amount:c*(u/2)}}class is extends Mt{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,n,r,o={}){const s=Et(n.getCanvasContainer(),r);super(t,Wt({point:s,lngLat:n.unproject(s),originalEvent:r},o)),this._defaultPrevented=!1,this.target=n}}class Jg extends Mt{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,n,r){const o="touchend"===t?r.changedTouches:r.touches,s=Xt(n.getCanvasContainer(),o),c=s.map(d=>n.unproject(d)),u=s.reduce((d,f,m,g)=>d.add(f.div(g.length)),new it(0,0));super(t,{points:s,point:u,lngLats:c,lngLat:n.unproject(u),originalEvent:r}),this._defaultPrevented=!1}}class JE extends Mt{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,n,r){super(t,{originalEvent:r}),this._defaultPrevented=!1}}class QE{constructor(t,n){this._map=t,this._clickTolerance=n.clickTolerance}reset(){this._mousedownPos=void 0}wheel(t){return this._firePreventable(new JE(t.type,this._map,t))}mousedown(t,n){return this._mousedownPos=n,this._firePreventable(new is(t.type,this._map,t))}mouseup(t){this._map.fire(new is(t.type,this._map,t))}preclick(t){const n=Wt({},t);n.type="preclick",this._map.fire(new is(n.type,this._map,n))}click(t,n){this._mousedownPos&&this._mousedownPos.dist(n)>=this._clickTolerance||(this.preclick(t),this._map.fire(new is(t.type,this._map,t)))}dblclick(t){return this._firePreventable(new is(t.type,this._map,t))}mouseover(t){this._map.fire(new is(t.type,this._map,t))}mouseout(t){this._map.fire(new is(t.type,this._map,t))}touchstart(t){return this._firePreventable(new Jg(t.type,this._map,t))}touchmove(t){this._map.fire(new Jg(t.type,this._map,t))}touchend(t){this._map.fire(new Jg(t.type,this._map,t))}touchcancel(t){this._map.fire(new Jg(t.type,this._map,t))}_firePreventable(t){if(this._map.fire(t),t.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class tT{constructor(t){this._map=t}reset(){this._delayContextMenu=!1,this._contextMenuEvent=void 0}mousemove(t){this._map.fire(new is(t.type,this._map,t))}mousedown(){this._delayContextMenu=!0}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new is("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(t){this._delayContextMenu?this._contextMenuEvent=t:this._map.fire(new is(t.type,this._map,t)),this._map.listens("contextmenu")&&t.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class eT{constructor(t,n){this._map=t,this._el=t.getCanvasContainer(),this._container=t.getContainer(),this._clickTolerance=n.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(t,n){this.isEnabled()&&t.shiftKey&&0===t.button&&(tt(),this._startPos=this._lastPos=n,this._active=!0)}mousemoveWindow(t,n){if(!this._active)return;const r=n,o=this._startPos,s=this._lastPos;if(!o||!s||s.equals(r)||!this._box&&r.dist(o)<this._clickTolerance)return;this._lastPos=r,this._box||(this._box=jn("div","mapboxgl-boxzoom",this._container),this._container.classList.add("mapboxgl-crosshair"),this._fireEvent("boxzoomstart",t));const c=Math.min(o.x,r.x),u=Math.max(o.x,r.x),d=Math.min(o.y,r.y),f=Math.max(o.y,r.y);this._map._requestDomTask(()=>{this._box&&(this._box.style.transform=`translate(${c}px,${d}px)`,this._box.style.width=u-c+"px",this._box.style.height=f-d+"px")})}mouseupWindow(t,n){if(!this._active)return;const r=this._startPos,o=n;if(r&&0===t.button){if(this.reset(),gt(),r.x!==o.x||r.y!==o.y)return this._map.fire(new Mt("boxzoomend",{originalEvent:t})),{cameraAnimation:s=>s.fitScreenCoordinates(r,o,this._map.getBearing(),{linear:!1})};this._fireEvent("boxzoomcancel",t)}}keydown(t){this._active&&27===t.keyCode&&(this.reset(),this._fireEvent("boxzoomcancel",t))}blur(){this.reset()}reset(){this._active=!1,this._container.classList.remove("mapboxgl-crosshair"),this._box&&(this._box.remove(),this._box=null),lt(),delete this._startPos,delete this._lastPos}_fireEvent(t,n){return this._map.fire(new Mt(t,{originalEvent:n}))}}function jv(e,t){const n={};for(let r=0;r<e.length;r++)n[e[r].identifier]=t[r];return n}class yS{constructor(t){this.reset(),this.numTouches=t.numTouches}reset(){this.centroid=void 0,this.startTime=0,this.touches={},this.aborted=!1}touchstart(t,n,r){(this.centroid||r.length>this.numTouches)&&(this.aborted=!0),this.aborted||(0===this.startTime&&(this.startTime=t.timeStamp),r.length===this.numTouches&&(this.centroid=function(o){const s=new it(0,0);for(const c of o)s._add(c);return s.div(o.length)}(n),this.touches=jv(r,n)))}touchmove(t,n,r){if(this.aborted||!this.centroid)return;const o=jv(r,n);for(const s in this.touches){const c=o[s];(!c||c.dist(this.touches[s])>30)&&(this.aborted=!0)}}touchend(t,n,r){if((!this.centroid||t.timeStamp-this.startTime>500)&&(this.aborted=!0),0===r.length){const o=!this.aborted&&this.centroid;if(this.reset(),o)return o}}}class nT{constructor(t){this.singleTap=new yS(t),this.numTaps=t.numTaps,this.reset()}reset(){this.lastTime=1/0,this.lastTap=void 0,this.count=0,this.singleTap.reset()}touchstart(t,n,r){this.singleTap.touchstart(t,n,r)}touchmove(t,n,r){this.singleTap.touchmove(t,n,r)}touchend(t,n,r){const o=this.singleTap.touchend(t,n,r);if(o){const s=t.timeStamp-this.lastTime<500,c=!this.lastTap||this.lastTap.dist(o)<30;if(s&&c||this.reset(),this.count++,this.lastTime=t.timeStamp,this.lastTap=o,this.count===this.numTaps)return this.reset(),o}}}class rT{constructor(){this._zoomIn=new nT({numTouches:1,numTaps:2}),this._zoomOut=new nT({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(t,n,r){this._zoomIn.touchstart(t,n,r),this._zoomOut.touchstart(t,n,r)}touchmove(t,n,r){this._zoomIn.touchmove(t,n,r),this._zoomOut.touchmove(t,n,r)}touchend(t,n,r){const o=this._zoomIn.touchend(t,n,r),s=this._zoomOut.touchend(t,n,r);return o?(this._active=!0,t.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:c=>c.easeTo({duration:300,zoom:c.getZoom()+1,around:c.unproject(o)},{originalEvent:t})}):s?(this._active=!0,t.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:c=>c.easeTo({duration:300,zoom:c.getZoom()-1,around:c.unproject(s)},{originalEvent:t})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}const GC={0:1,2:2};class iT{constructor(t){this.reset(),this._clickTolerance=t.clickTolerance||1}blur(){this.reset()}reset(){this._active=!1,this._moved=!1,this._lastPoint=void 0,this._eventButton=void 0}_correctButton(t,n){return!1}_move(t,n){return{}}mousedown(t,n){if(this._lastPoint)return;const r=ce(t);this._correctButton(t,r)&&(this._lastPoint=n,this._eventButton=r)}mousemoveWindow(t,n){const r=this._lastPoint;if(r)if(t.preventDefault(),null!=this._eventButton&&function(o,s){const c=GC[s];return void 0===o.buttons||(o.buttons&c)!==c}(t,this._eventButton))this.reset();else if(this._moved||!(n.dist(r)<this._clickTolerance))return this._moved=!0,this._lastPoint=n,this._move(r,n)}mouseupWindow(t){this._lastPoint&&ce(t)===this._eventButton&&(this._moved&&gt(),this.reset())}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class $C extends iT{mousedown(t,n){super.mousedown(t,n),this._lastPoint&&(this._active=!0)}_correctButton(t,n){return 0===n&&!t.ctrlKey}_move(t,n){return{around:n,panDelta:n.sub(t)}}}class vS extends iT{_correctButton(t,n){return 0===n&&t.ctrlKey||2===n}_move(t,n){const r=.8*(n.x-t.x);if(r)return this._active=!0,{bearingDelta:r}}contextmenu(t){t.preventDefault()}}class xS extends iT{_correctButton(t,n){return 0===n&&t.ctrlKey||2===n}_move(t,n){const r=-.5*(n.y-t.y);if(r)return this._active=!0,{pitchDelta:r}}contextmenu(t){t.preventDefault()}}class HC{constructor(t,n){this._map=t,this._el=t.getCanvasContainer(),this._minTouches=1,this._clickTolerance=n.clickTolerance||1,this.reset(),ei(["_addTouchPanBlocker","_showTouchPanBlockerAlert"],this)}reset(){this._active=!1,this._touches={},this._sum=new it(0,0)}touchstart(t,n,r){return this._calculateTransform(t,n,r)}touchmove(t,n,r){if(this._active&&!(r.length<this._minTouches)){if(this._map._cooperativeGestures&&!this._map.isMoving()){if(1===r.length&&!Ee())return void this._showTouchPanBlockerAlert();"hidden"!==this._alertContainer.style.visibility&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}return t.cancelable&&t.preventDefault(),this._calculateTransform(t,n,r)}}touchend(t,n,r){this._calculateTransform(t,n,r),this._active&&r.length<this._minTouches&&this.reset()}touchcancel(){this.reset()}_calculateTransform(t,n,r){r.length>0&&(this._active=!0);const o=jv(r,n),s=new it(0,0),c=new it(0,0);let u=0;for(const f in o){const m=o[f],g=this._touches[f];g&&(s._add(m),c._add(m.sub(g)),u++,o[f]=m)}if(this._touches=o,u<this._minTouches||!c.mag())return;const d=c.div(u);return this._sum._add(d),this._sum.mag()<this._clickTolerance?void 0:{around:s.div(u),panDelta:d}}enable(){this._enabled=!0,this._map._cooperativeGestures&&(this._addTouchPanBlocker(),this._el.classList.add("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page"))}disable(){this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove(),this._el.classList.remove("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page")),this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}_addTouchPanBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=jn("div","mapboxgl-touch-pan-blocker",this._map._container),this._alertContainer.textContent=this._map._getUIString("TouchPanBlocker.Message"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showTouchPanBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","null")},500)}}class oT{constructor(){this.reset()}reset(){this._active=!1,this._firstTwoTouches=void 0}_start(t){}_move(t,n,r){return{}}touchstart(t,n,r){this._firstTwoTouches||r.length<2||(this._firstTwoTouches=[r[0].identifier,r[1].identifier],this._start([n[0],n[1]]))}touchmove(t,n,r){const o=this._firstTwoTouches;if(!o)return;t.preventDefault();const[s,c]=o,u=Vv(r,n,s),d=Vv(r,n,c);if(!u||!d)return;const f=this._aroundCenter?null:u.add(d).div(2);return this._move([u,d],f,t)}touchend(t,n,r){if(!this._firstTwoTouches)return;const[o,s]=this._firstTwoTouches,c=Vv(r,n,o),u=Vv(r,n,s);c&&u||(this._active&&gt(),this.reset())}touchcancel(){this.reset()}enable(t){this._enabled=!0,this._aroundCenter=!!t&&"center"===t.around}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}function Vv(e,t,n){for(let r=0;r<e.length;r++)if(e[r].identifier===n)return t[r]}function bS(e,t){return Math.log(e/t)/Math.LN2}class wS extends oT{reset(){super.reset(),this._distance=0,this._startDistance=0}_start(t){this._startDistance=this._distance=t[0].dist(t[1])}_move(t,n){const r=this._distance;if(this._distance=t[0].dist(t[1]),this._active||!(Math.abs(bS(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:bS(this._distance,r),pinchAround:n}}}function Qg(e,t){return 180*e.angleWith(t)/Math.PI}class ES extends oT{reset(){super.reset(),this._minDiameter=0,this._startVector=void 0,this._vector=void 0}_start(t){this._startVector=this._vector=t[0].sub(t[1]),this._minDiameter=t[0].dist(t[1])}_move(t,n){const r=this._vector;if(this._vector=t[0].sub(t[1]),r&&(this._active||!this._isBelowThreshold(this._vector)))return this._active=!0,{bearingDelta:Qg(this._vector,r),pinchAround:n}}_isBelowThreshold(t){this._minDiameter=Math.min(this._minDiameter,t.mag());const n=25/(Math.PI*this._minDiameter)*360,r=this._startVector;if(!r)return!1;const o=Qg(t,r);return Math.abs(o)<n}}function Uv(e){return Math.abs(e.y)>Math.abs(e.x)}class Vl extends oT{constructor(t){super(),this._map=t}reset(){super.reset(),this._valid=void 0,this._firstMove=void 0,this._lastPoints=void 0}_start(t){this._lastPoints=t,Uv(t[0].sub(t[1]))&&(this._valid=!1)}_move(t,n,r){const o=this._lastPoints;if(!o)return;const s=t[0].sub(o[0]),c=t[1].sub(o[1]);return this._map._cooperativeGestures&&!Ee()&&r.touches.length<3||(this._valid=this.gestureBeginsVertically(s,c,r.timeStamp),!this._valid)?void 0:(this._lastPoints=t,this._active=!0,{pitchDelta:(s.y+c.y)/2*-.5})}gestureBeginsVertically(t,n,r){if(void 0!==this._valid)return this._valid;const o=t.mag()>=2,s=n.mag()>=2;if(!o&&!s)return;if(!o||!s)return null==this._firstMove&&(this._firstMove=r),r-this._firstMove<100&&void 0;const c=t.y>0==n.y>0;return Uv(t)&&Uv(n)&&c}}const TS={panStep:100,bearingStep:15,pitchStep:10};class qC{constructor(){const t=TS;this._panStep=t.panStep,this._bearingStep=t.bearingStep,this._pitchStep=t.pitchStep,this._rotationDisabled=!1}blur(){this.reset()}reset(){this._active=!1}keydown(t){if(t.altKey||t.ctrlKey||t.metaKey)return;let n=0,r=0,o=0,s=0,c=0;switch(t.keyCode){case 61:case 107:case 171:case 187:n=1;break;case 189:case 109:case 173:n=-1;break;case 37:t.shiftKey?r=-1:(t.preventDefault(),s=-1);break;case 39:t.shiftKey?r=1:(t.preventDefault(),s=1);break;case 38:t.shiftKey?o=1:(t.preventDefault(),c=-1);break;case 40:t.shiftKey?o=-1:(t.preventDefault(),c=1);break;default:return}return this._rotationDisabled&&(r=0,o=0),{cameraAnimation:u=>{const d=u.getZoom();u.easeTo({duration:300,easeId:"keyboardHandler",easing:ZC,zoom:n?Math.round(d)+n*(t.shiftKey?2:1):d,bearing:u.getBearing()+r*this._bearingStep,pitch:u.getPitch()+o*this._pitchStep,offset:[-s*this._panStep,-c*this._panStep],center:u.getCenter()},{originalEvent:t})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function ZC(e){return e*(2-e)}const sT=4.000244140625;class MS{constructor(t,n){this._map=t,this._el=t.getCanvasContainer(),this._handler=n,this._delta=0,this._lastDelta=0,this._defaultZoomRate=.01,this._wheelZoomRate=.0022222222222222222,ei(["_onTimeout","_addScrollZoomBlocker","_showBlockerAlert"],this)}setZoomRate(t){this._defaultZoomRate=t}setWheelZoomRate(t){this._wheelZoomRate=t}isEnabled(){return!!this._enabled}isActive(){return this._active||void 0!==this._finishTimeout}isZooming(){return!!this._zooming}enable(t){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!t&&"center"===t.around,this._map._cooperativeGestures&&this._addScrollZoomBlocker())}disable(){this.isEnabled()&&(this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove()))}wheel(t){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!(t.ctrlKey||t.metaKey||this.isZooming()||Ee()))return void this._showBlockerAlert();"hidden"!==this._alertContainer.style.visibility&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}let n=t.deltaMode===ft.WheelEvent.DOM_DELTA_LINE?40*t.deltaY:t.deltaY;const r=De.now(),o=r-(this._lastWheelEventTime||0);this._lastWheelEventTime=r,0!==n&&n%sT==0?this._type="wheel":0!==n&&Math.abs(n)<4?this._type="trackpad":o>400?(this._type=null,this._lastValue=n,this._timeout=setTimeout(this._onTimeout,40,t)):this._type||(this._type=Math.abs(o*n)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,n+=this._lastValue)),t.shiftKey&&n&&(n/=4),this._type&&(this._lastWheelEvent=t,this._delta-=n,this._active||this._start(t)),t.preventDefault()}_onTimeout(t){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(t)}_start(t){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const n=Et(this._el,t);this._aroundPoint=this._aroundCenter?this._map.transform.centerPoint:n,this._aroundCoord=this._map.transform.pointCoordinate3D(this._aroundPoint),this._targetZoom=void 0,this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;const t=this._map.transform;"wheel"===this._type&&t.projection.wrap&&(t._center.lng>=180||t._center.lng<=-180)&&(this._prevEase=null,this._easing=null,this._lastWheelEvent=null,this._lastWheelEventTime=0);const n=()=>t._terrainEnabled()&&this._aroundCoord?t.computeZoomRelativeTo(this._aroundCoord):t.zoom;if(0!==this._delta){const f="wheel"===this._type&&Math.abs(this._delta)>sT?this._wheelZoomRate:this._defaultZoomRate;let m=2/(1+Math.exp(-Math.abs(this._delta*f)));this._delta<0&&0!==m&&(m=1/m);const g=n(),y=Math.pow(2,g),v="number"==typeof this._targetZoom?t.zoomScale(this._targetZoom):y;this._targetZoom=Math.min(t.maxZoom,Math.max(t.minZoom,t.scaleZoom(v*m))),"wheel"===this._type&&(this._startZoom=g,this._easing=this._smoothOutEasing(200)),this._lastDelta=this._delta,this._delta=0}const r="number"==typeof this._targetZoom?this._targetZoom:n(),o=this._startZoom,s=this._easing;let c,u=!1;if("wheel"===this._type&&o&&s){const f=Math.min((De.now()-this._lastWheelEventTime)/200,1);c=le(o,r,s(f)),f<1?this._frameId||(this._frameId=!0):u=!0}else c=r,u=!0;this._active=!0,u&&(this._active=!1,this._finishTimeout=setTimeout(()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout},200));let d=c-n();return d*this._lastDelta<0&&(d=0),{noInertia:!0,needsRenderFrame:!u,zoomDelta:d,around:this._aroundPoint,aroundCoord:this._aroundCoord,originalEvent:this._lastWheelEvent}}_smoothOutEasing(t){let n=Tr;if(this._prevEase){const r=this._prevEase,o=(De.now()-r.start)/r.duration,s=r.easing(o+.01)-r.easing(o),c=.27/Math.sqrt(s*s+1e-4)*.01;n=Ds(c,Math.sqrt(.0729-c*c),.25,1)}return this._prevEase={start:De.now(),duration:t,easing:n},n}blur(){this.reset()}reset(){this._active=!1}_addScrollZoomBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=jn("div","mapboxgl-scroll-zoom-blocker",this._map._container),this._alertContainer.textContent=/(Mac|iPad)/i.test(ft.navigator.userAgent)?this._map._getUIString("ScrollZoomBlocker.CmdMessage"):this._map._getUIString("ScrollZoomBlocker.CtrlMessage"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","null")},200)}}class IS{constructor(t,n){this._clickZoom=t,this._tapZoom=n}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class WC{constructor(){this.reset()}reset(){this._active=!1}blur(){this.reset()}dblclick(t,n){return t.preventDefault(),{cameraAnimation:r=>{r.easeTo({duration:300,zoom:r.getZoom()+(t.shiftKey?-1:1),around:r.unproject(n)},{originalEvent:t})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class DS{constructor(){this._tap=new nT({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,this._swipePoint=void 0,this._swipeTouch=0,this._tapTime=0,this._tap.reset()}touchstart(t,n,r){this._swipePoint||(this._tapTime&&t.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?r.length>0&&(this._swipePoint=n[0],this._swipeTouch=r[0].identifier):this._tap.touchstart(t,n,r))}touchmove(t,n,r){if(this._tapTime){if(this._swipePoint){if(r[0].identifier!==this._swipeTouch)return;const o=n[0],s=o.y-this._swipePoint.y;return this._swipePoint=o,t.preventDefault(),this._active=!0,{zoomDelta:s/128}}}else this._tap.touchmove(t,n,r)}touchend(t,n,r){this._tapTime?this._swipePoint&&0===r.length&&this.reset():this._tap.touchend(t,n,r)&&(this._tapTime=t.timeStamp)}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class XC{constructor(t,n,r){this._el=t,this._mousePan=n,this._touchPan=r}enable(t){this._inertiaOptions=t||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("mapboxgl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("mapboxgl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class SS{constructor(t,n,r){this._pitchWithRotate=t.pitchWithRotate,this._mouseRotate=n,this._mousePitch=r}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class kp{constructor(t,n,r,o){this._el=t,this._touchZoom=n,this._touchRotate=r,this._tapDragZoom=o,this._rotationDisabled=!1,this._enabled=!0}enable(t){this._touchZoom.enable(t),this._rotationDisabled||this._touchRotate.enable(t),this._tapDragZoom.enable(),this._el.classList.add("mapboxgl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("mapboxgl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}const Xu=e=>e.zoom||e.drag||e.pitch||e.rotate;class CS extends Mt{}class AS{constructor(){this.constants=[1,1,.01],this.radius=0}setup(t,n){const r=Z.sub([],n,t);this.radius=Z.length(r[2]<0?Z.div([],r,this.constants):[r[0],r[1],0])}projectRay(t){Z.div(t,t,this.constants),Z.normalize(t,t),Z.mul(t,t,this.constants);const n=Z.scale([],t,this.radius);if(n[2]>0){const r=Z.scale([],[0,0,1],Z.dot(n,[0,0,1])),o=Z.scale([],Z.normalize([],[n[0],n[1],0]),this.radius),s=Z.add([],n,Z.scale([],Z.sub([],Z.add([],o,r),n),2));n[0]=s[0],n[1]=s[1]}return n}}function t_(e){return e.panDelta&&e.panDelta.mag()||e.zoomDelta||e.bearingDelta||e.pitchDelta}class PS{constructor(t,n){this._map=t,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new KE(t),this._bearingSnap=n.bearingSnap,this._previousActiveHandlers={},this._trackingEllipsoid=new AS,this._dragOrigin=null,this._eventsInProgress={},this._addDefaultHandlers(n),ei(["handleEvent","handleWindowEvent"],this);const r=this._el;this._listeners=[[r,"touchstart",{passive:!0}],[r,"touchmove",{passive:!1}],[r,"touchend",void 0],[r,"touchcancel",void 0],[r,"mousedown",void 0],[r,"mousemove",void 0],[r,"mouseup",void 0],[ft.document,"mousemove",{capture:!0}],[ft.document,"mouseup",void 0],[r,"mouseover",void 0],[r,"mouseout",void 0],[r,"dblclick",void 0],[r,"click",void 0],[r,"keydown",{capture:!1}],[r,"keyup",void 0],[r,"wheel",{passive:!1}],[r,"contextmenu",void 0],[ft,"blur",void 0]];for(const[o,s,c]of this._listeners)o.addEventListener(s,o===ft.document?this.handleWindowEvent:this.handleEvent,c)}destroy(){for(const[t,n,r]of this._listeners)t.removeEventListener(n,t===ft.document?this.handleWindowEvent:this.handleEvent,r)}_addDefaultHandlers(t){const n=this._map,r=n.getCanvasContainer();this._add("mapEvent",new QE(n,t));const o=n.boxZoom=new eT(n,t);this._add("boxZoom",o);const s=new rT,c=new WC;n.doubleClickZoom=new IS(c,s),this._add("tapZoom",s),this._add("clickZoom",c);const u=new DS;this._add("tapDragZoom",u);const d=n.touchPitch=new Vl(n);this._add("touchPitch",d);const f=new vS(t),m=new xS(t);n.dragRotate=new SS(t,f,m),this._add("mouseRotate",f,["mousePitch"]),this._add("mousePitch",m,["mouseRotate"]);const g=new $C(t),y=new HC(n,t);n.dragPan=new XC(r,g,y),this._add("mousePan",g),this._add("touchPan",y,["touchZoom","touchRotate"]);const v=new ES,x=new wS;n.touchZoomRotate=new kp(r,x,v,u),this._add("touchRotate",v,["touchPan","touchZoom"]),this._add("touchZoom",x,["touchPan","touchRotate"]),this._add("blockableMapEvent",new tT(n));const w=n.scrollZoom=new MS(n,this);this._add("scrollZoom",w,["mousePan"]);const E=n.keyboard=new qC;this._add("keyboard",E);for(const M of["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"])t.interactive&&t[M]&&n[M].enable(t[M])}_add(t,n,r){this._handlers.push({handlerName:t,handler:n,allowed:r}),this._handlersById[t]=n}stop(t){if(!this._updatingCamera){for(const{handler:n}of this._handlers)n.reset();this._inertia.clear(),this._fireEvents({},{},t),this._changes=[],this._originalZoom=void 0}}isActive(){for(const{handler:t}of this._handlers)if(t.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!Xu(this._eventsInProgress)||this.isZooming()}_isDragging(){return!!this._eventsInProgress.drag}_blockedByActive(t,n,r){for(const o in t)if(o!==r&&(!n||n.indexOf(o)<0))return!0;return!1}handleWindowEvent(t){this.handleEvent(t,`${t.type}Window`)}_getMapTouches(t){const n=[];for(const r of t)this._el.contains(r.target)&&n.push(r);return n}handleEvent(t,n){this._updatingCamera=!0;const r="renderFrame"===t.type,o=r?void 0:t,s={needsRenderFrame:!1},c={},u={},d=t.touches?this._getMapTouches(t.touches):void 0,f=d?Xt(this._el,d):r?void 0:Et(this._el,t);for(const{handlerName:y,handler:v,allowed:x}of this._handlers){if(!v.isEnabled())continue;let w;this._blockedByActive(u,x,y)?v.reset():v[n||t.type]&&(w=v[n||t.type](t,f,d),this.mergeHandlerResult(s,c,w,y,o),w&&w.needsRenderFrame&&this._triggerRenderFrame()),(w||v.isActive())&&(u[y]=v)}const m={};for(const y in this._previousActiveHandlers)u[y]||(m[y]=o);this._previousActiveHandlers=u,(Object.keys(m).length||t_(s))&&(this._changes.push([s,c,m]),this._triggerRenderFrame()),(Object.keys(u).length||t_(s))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:g}=s;g&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],g(this._map))}mergeHandlerResult(t,n,r,o,s){if(!r)return;Wt(t,r);const c={handlerName:o,originalEvent:r.originalEvent||s};void 0!==r.zoomDelta&&(n.zoom=c),void 0!==r.panDelta&&(n.drag=c),void 0!==r.pitchDelta&&(n.pitch=c),void 0!==r.bearingDelta&&(n.rotate=c)}_applyChanges(){const t={},n={},r={};for(const[o,s,c]of this._changes)o.panDelta&&(t.panDelta=(t.panDelta||new it(0,0))._add(o.panDelta)),o.zoomDelta&&(t.zoomDelta=(t.zoomDelta||0)+o.zoomDelta),o.bearingDelta&&(t.bearingDelta=(t.bearingDelta||0)+o.bearingDelta),o.pitchDelta&&(t.pitchDelta=(t.pitchDelta||0)+o.pitchDelta),void 0!==o.around&&(t.around=o.around),void 0!==o.aroundCoord&&(t.aroundCoord=o.aroundCoord),void 0!==o.pinchAround&&(t.pinchAround=o.pinchAround),o.noInertia&&(t.noInertia=o.noInertia),Wt(n,s),Wt(r,c);this._updateMapTransform(t,n,r),this._changes=[]}_updateMapTransform(t,n,r){const o=this._map,s=o.transform,c=D=>[D.x,D.y,D.z];if((D=>{const A=this._eventsInProgress.drag;return A&&!this._handlersById[A.handlerName].isActive()})()&&!t_(t)){const D=s.zoom;s.cameraElevationReference="sea",null!=this._originalZoom&&s._orthographicProjectionAtLowPitch&&"globe"!==s.projection.name&&0===s.pitch?(s.cameraElevationReference="ground",s.zoom=this._originalZoom):(s.recenterOnTerrain(),s.cameraElevationReference="ground"),D!==s.zoom&&this._map._update(!0)}if(s._isCameraConstrained&&o._stop(!0),!t_(t))return void this._fireEvents(n,r,!0);let{panDelta:u,zoomDelta:d,bearingDelta:f,pitchDelta:m,around:g,aroundCoord:y,pinchAround:v}=t;s._isCameraConstrained&&(d>0&&(d=0),s._isCameraConstrained=!1),void 0!==v&&(g=v),(d||(D=>n[D]&&!this._eventsInProgress[D])("drag"))&&g&&(this._dragOrigin=c(s.pointCoordinate3D(g)),this._originalZoom=s.zoom,this._trackingEllipsoid.setup(s._camera.position,this._dragOrigin)),s.cameraElevationReference="sea",o._stop(!0),g=g||o.transform.centerPoint,f&&(s.bearing+=f),m&&(s.pitch+=m),s._updateCameraState();const x=[0,0,0];if(u)if("mercator"===s.projection.name){const D=this._trackingEllipsoid.projectRay(s.screenPointToMercatorRay(g).dir),A=this._trackingEllipsoid.projectRay(s.screenPointToMercatorRay(g.sub(u)).dir);x[0]=A[0]-D[0],x[1]=A[1]-D[1]}else{const D=s.pointCoordinate(g);if("globe"===s.projection.name){u=u.rotate(-s.angle);const A=s._pixelsPerMercatorPixel/s.worldSize;x[0]=-u.x*yy(xr(D.y))*A,x[1]=-u.y*yy(s.center.lat)*A}else{const A=s.pointCoordinate(g.sub(u));D&&A&&(x[0]=A.x-D.x,x[1]=A.y-D.y)}}const w=s.zoom,E=[0,0,0];if(d){const D=c(y||s.pointCoordinate3D(g)),A={dir:Z.normalize([],Z.sub([],D,s._camera.position))};if(A.dir[2]<0){const P=s.zoomDeltaToMovement(D,d);Z.scale(E,A.dir,P)}}const M=Z.add(x,x,E);s._translateCameraConstrained(M),d&&Math.abs(s.zoom-w)>1e-4&&s.recenterOnTerrain(),s.cameraElevationReference="ground",this._map._update(),t.noInertia||this._inertia.record(t),this._fireEvents(n,r,!0)}_fireEvents(t,n,r){const o=Xu(this._eventsInProgress),s=Xu(t),c={};for(const m in t){const{originalEvent:g}=t[m];this._eventsInProgress[m]||(c[`${m}start`]=g),this._eventsInProgress[m]=t[m]}!o&&s&&this._fireEvent("movestart",s.originalEvent);for(const m in c)this._fireEvent(m,c[m]);s&&this._fireEvent("move",s.originalEvent);for(const m in t){const{originalEvent:g}=t[m];this._fireEvent(m,g)}const u={};let d;for(const m in this._eventsInProgress){const{handlerName:g,originalEvent:y}=this._eventsInProgress[m];this._handlersById[g].isActive()||(delete this._eventsInProgress[m],d=n[g]||y,u[`${m}end`]=d)}for(const m in u)this._fireEvent(m,u[m]);const f=Xu(this._eventsInProgress);if(r&&(o||s)&&!f){this._updatingCamera=!0;const m=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),g=y=>0!==y&&-this._bearingSnap<y&&y<this._bearingSnap;m?(g(m.bearing||this._map.getBearing())&&(m.bearing=0),this._map.easeTo(m,{originalEvent:d})):(this._map.fire(new Mt("moveend",{originalEvent:d})),g(this._map.getBearing())&&this._map.resetNorth()),this._updatingCamera=!1}}_fireEvent(t,n){this._map.fire(new Mt(t,n?{originalEvent:n}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add(t=>{this._frameId=void 0,this.handleEvent(new CS("renderFrame",{timeStamp:t})),this._applyChanges()})}_triggerRenderFrame(){void 0===this._frameId&&(this._frameId=this._requestFrame())}}const aT="map.setFreeCameraOptions(...) and map.getFreeCameraOptions() are not yet supported for non-mercator projections.";class RS extends ye{constructor(t,n){super(),this._moving=!1,this._zooming=!1,this.transform=t,this._bearingSnap=n.bearingSnap,this._respectPrefersReducedMotion=!1!==n.respectPrefersReducedMotion,ei(["_renderFrameCallback"],this)}getCenter(){return new Se(this.transform.center.lng,this.transform.center.lat)}setCenter(t,n){return this.jumpTo({center:t},n)}panBy(t,n,r){return t=it.convert(t).mult(-1),this.panTo(this.transform.center,Wt({offset:t},n),r)}panTo(t,n,r){return this.easeTo(Wt({center:t},n),r)}getZoom(){return this.transform.zoom}setZoom(t,n){return this.jumpTo({zoom:t},n),this}zoomTo(t,n,r){return this.easeTo(Wt({zoom:t},n),r)}zoomIn(t,n){return this.zoomTo(this.getZoom()+1,t,n),this}zoomOut(t,n){return this.zoomTo(this.getZoom()-1,t,n),this}getBearing(){return this.transform.bearing}setBearing(t,n){return this.jumpTo({bearing:t},n),this}getPadding(){return this.transform.padding}setPadding(t,n){return this.jumpTo({padding:t},n),this}rotateTo(t,n,r){return this.easeTo(Wt({bearing:t},n),r)}resetNorth(t,n){return this.rotateTo(0,Wt({duration:1e3},t),n),this}resetNorthPitch(t,n){return this.easeTo(Wt({bearing:0,pitch:0,duration:1e3},t),n),this}snapToNorth(t,n){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(t,n):this}getPitch(){return this.transform.pitch}setPitch(t,n){return this.jumpTo({pitch:t},n),this}cameraForBounds(t,n){t=Oi.convert(t);const r=n&&n.bearing||0,o=n&&n.pitch||0,s=t.getNorthWest(),c=t.getSouthEast();return this._cameraForBounds(this.transform,s,c,r,o,n)}_extendCameraOptions(t){const n={top:0,bottom:0,right:0,left:0};if("number"==typeof(t=Wt({padding:n,offset:[0,0],maxZoom:this.transform.maxZoom},t)).padding){const r=t.padding;t.padding={top:r,bottom:r,right:r,left:r}}return t.padding=Wt(n,t.padding),t}_minimumAABBFrustumDistance(t,n){const r=n.max[0]-n.min[0],o=n.max[1]-n.min[1];return r/o>t.aspect?r/(2*Math.tan(.5*t.fovX)*t.aspect):o/(2*Math.tan(.5*t.fovY)*t.aspect)}_cameraForBoundsOnGlobe(t,n,r,o,s,c){const u=t.clone(),d=this._extendCameraOptions(c);u.bearing=o,u.pitch=s;const f=Se.convert(n),m=Se.convert(r),g=.5*(f.lat+m.lat),y=.5*(f.lng+m.lng),v=Ko(g,y),x=Z.normalize([],v),w=Z.normalize([],Z.cross([],x,[0,1,0])),E=Z.cross([],w,x),M=[w[0],w[1],w[2],0,E[0],E[1],E[2],0,x[0],x[1],x[2],0,0,0,0,1],D=[v,Ko(f.lat,f.lng),Ko(m.lat,f.lng),Ko(m.lat,m.lng),Ko(f.lat,m.lng),Ko(g,f.lng),Ko(g,m.lng),Ko(f.lat,y),Ko(m.lat,y)];let A=Bn.fromPoints(D.map(J=>[Z.dot(w,J),Z.dot(E,J),Z.dot(x,J)]));const P=Z.transformMat4([],A.center,M);0===Z.squaredLength(P)&&Z.set(P,0,0,1),Z.normalize(P,P),Z.scale(P,P,To),u.center=function([J,ct,dt]){const ht=Math.hypot(J,ct,dt),_t=Math.atan2(J,dt),vt=.5*Math.PI-Math.acos(-ct/ht);return new Se(fr(_t),fr(vt))}(P);const C=u.getWorldToCameraMatrix(),R=st.invert(new Float64Array(16),C);A=Bn.applyTransform(A,st.multiply([],C,M)),Z.transformMat4(P,P,C);const k=.5*(A.max[2]-A.min[2]),N=this._minimumAABBFrustumDistance(u,A),z=Z.scale([],[0,0,1],k),B=Z.add(z,P,z),U=N+(0===u.pitch?0:Z.distance(P,B)),$=u.globeCenterInViewSpace,W=Z.sub([],P,[$[0],$[1],$[2]]);Z.normalize(W,W),Z.scale(W,W,U);const V=Z.add([],P,W);Z.transformMat4(V,V,R);const K=jf/To,Q=Z.length(V),ot=Ln(Math.max(Q*K-jf,Number.EPSILON),0),Y=Math.min(u.zoomFromMercatorZAdjusted(ot),d.maxZoom);return Y>.5*(zf+yc)?(u.setProjection({name:"mercator"}),u.zoom=Y,this._cameraForBounds(u,n,r,o,s,c)):{center:u.center,zoom:Y,bearing:o,pitch:s}}queryTerrainElevation(t,n){const r=this.transform.elevation;return r?(n=Wt({},{exaggerated:!0},n),r.getAtPoint(Qe.fromLngLat(t),null,n.exaggerated)):null}_cameraForBounds(t,n,r,o,s,c){if("globe"===t.projection.name)return this._cameraForBoundsOnGlobe(t,n,r,o,s,c);const u=t.clone(),d=this._extendCameraOptions(c),f=u.padding;u.bearing=o,u.pitch=s;const m=Se.convert(n),g=Se.convert(r),y=new Se(m.lng,g.lat),v=new Se(g.lng,m.lat),x=u.project(m),w=u.project(g),E=this.queryTerrainElevation(m),M=this.queryTerrainElevation(g),D=this.queryTerrainElevation(y),A=this.queryTerrainElevation(v),P=[[x.x,x.y,Math.min(E||0,M||0,D||0,A||0)],[w.x,w.y,Math.max(E||0,M||0,D||0,A||0)]];let C=Bn.fromPoints(P);const R=u.getWorldToCameraMatrix(),k=st.invert(new Float64Array(16),R);C=Bn.applyTransform(C,R);const N=Z.sub([],C.max,C.min),z=f.left||0,B=f.right||0,U=f.bottom||0,$=f.top||0,{left:W,right:V,top:K,bottom:Q}=d.padding,ot=.5*(z+B),Y=.5*($+U),J=Math.min(u.scaleZoom(u.scale*Math.min((u.width-(z+B+W+V))/N[0],(u.height-(U+$+Q+K))/N[1])),d.maxZoom),ct=u.scale/u.zoomScale(J);C=new Bn([C.min[0]-(W+ot)*ct,C.min[1]-(Q+Y)*ct,C.min[2]],[C.max[0]+(V+ot)*ct,C.max[1]+(K+Y)*ct,C.max[2]]);const dt=.5*N[2],ht=this._minimumAABBFrustumDistance(u,C),_t=[0,0,1,0];En.transformMat4(_t,_t,R),En.normalize(_t,_t);const vt=Z.scale([],_t,ht+dt),xt=Z.add([],C.center,vt),mt=("number"==typeof d.offset.x&&"number"==typeof d.offset.y?new it(d.offset.x,d.offset.y):it.convert(d.offset)).rotate(-Oe(o));C.center[0]-=mt.x*ct,C.center[1]+=mt.y*ct,Z.transformMat4(C.center,C.center,k),Z.transformMat4(xt,xt,k);const Ct=[C.center[0],C.center[1],xt[2]*u.pixelsPerMeter];Z.scale(Ct,Ct,1/u.worldSize);const Ut=Jo(Ct[0]),Gt=xr(Ct[1]),Yt=Math.min(u._zoomFromMercatorZ(Ct[2]),d.maxZoom),te=new Se(Ut,Gt);return u.mercatorFromTransition&&Yt<.5*(zf+yc)?(u.setProjection({name:"globe"}),u.zoom=Yt,this._cameraForBounds(u,n,r,o,s,c)):{center:te,zoom:Yt,bearing:o,pitch:s}}fitBounds(t,n,r){const o=this.cameraForBounds(t,n);return this._fitInternal(o,n,r)}fitScreenCoordinates(t,n,r,o,s){const c=it.convert(t),u=it.convert(n),d=new it(Math.min(c.x,u.x),Math.min(c.y,u.y)),f=new it(Math.max(c.x,u.x),Math.max(c.y,u.y));if("mercator"===this.transform.projection.name&&this.transform.anyCornerOffEdge(c,u))return this;const m=this.transform.pointLocation3D(d),g=this.transform.pointLocation3D(f),y=this.transform.pointLocation3D(new it(d.x,f.y)),v=this.transform.pointLocation3D(new it(f.x,d.y)),x=[Math.min(m.lng,g.lng,y.lng,v.lng),Math.min(m.lat,g.lat,y.lat,v.lat)],w=[Math.max(m.lng,g.lng,y.lng,v.lng),Math.max(m.lat,g.lat,y.lat,v.lat)],E=o&&o.pitch?o.pitch:this.getPitch(),M=this._cameraForBounds(this.transform,x,w,r,E,o);return this._fitInternal(M,o,s)}_fitInternal(t,n,r){return t?(delete(n=Wt(t,n)).padding,n.linear?this.easeTo(n,r):this.flyTo(n,r)):this}jumpTo(t,n){this.stop();const r=t.preloadOnly?this.transform.clone():this.transform;let o=!1,s=!1,c=!1;return"zoom"in t&&r.zoom!==+t.zoom&&(o=!0,r.zoom=+t.zoom),void 0!==t.center&&(r.center=Se.convert(t.center)),"bearing"in t&&r.bearing!==+t.bearing&&(s=!0,r.bearing=+t.bearing),"pitch"in t&&r.pitch!==+t.pitch&&(c=!0,r.pitch=+t.pitch),null==t.padding||r.isPaddingEqual(t.padding)||(r.padding=t.padding),t.preloadOnly?(this._preloadTiles(r),this):(this.fire(new Mt("movestart",n)).fire(new Mt("move",n)),o&&this.fire(new Mt("zoomstart",n)).fire(new Mt("zoom",n)).fire(new Mt("zoomend",n)),s&&this.fire(new Mt("rotatestart",n)).fire(new Mt("rotate",n)).fire(new Mt("rotateend",n)),c&&this.fire(new Mt("pitchstart",n)).fire(new Mt("pitch",n)).fire(new Mt("pitchend",n)),this.fire(new Mt("moveend",n)))}getFreeCameraOptions(){return this.transform.projection.supportsFreeCamera||nt(aT),this.transform.getFreeCameraOptions()}setFreeCameraOptions(t,n){const r=this.transform;if(!r.projection.supportsFreeCamera)return nt(aT),this;this.stop();const o=r.zoom,s=r.pitch,c=r.bearing;r.setFreeCameraOptions(t);const u=o!==r.zoom,d=s!==r.pitch,f=c!==r.bearing;return this.fire(new Mt("movestart",n)).fire(new Mt("move",n)),u&&this.fire(new Mt("zoomstart",n)).fire(new Mt("zoom",n)).fire(new Mt("zoomend",n)),f&&this.fire(new Mt("rotatestart",n)).fire(new Mt("rotate",n)).fire(new Mt("rotateend",n)),d&&this.fire(new Mt("pitchstart",n)).fire(new Mt("pitch",n)).fire(new Mt("pitchend",n)),this.fire(new Mt("moveend",n)),this}easeTo(t,n){this._stop(!1,t.easeId),(!1===(t=Wt({offset:[0,0],duration:500,easing:Tr},t)).animate||this._prefersReducedMotion(t))&&(t.duration=0);const r=this.transform,o=this.getZoom(),s=this.getBearing(),c=this.getPitch(),u=this.getPadding(),d="zoom"in t?+t.zoom:o,f="bearing"in t?this._normalizeBearing(t.bearing,s):s,m="pitch"in t?+t.pitch:c,g="padding"in t?t.padding:r.padding,y=it.convert(t.offset);let v,x,w;if("globe"===r.projection.name){const z=Qe.fromLngLat(r.center),B=y.rotate(-r.angle);z.x+=B.x/r.worldSize,z.y+=B.y/r.worldSize;const U=z.toLngLat(),$=Se.convert(t.center||U);this._normalizeCenter($),v=r.centerPoint.add(B),x=new it(z.x,z.y).mult(r.worldSize),w=new it(Br($.lng),ui($.lat)).mult(r.worldSize).sub(x)}else{v=r.centerPoint.add(y);const z=r.pointLocation(v),B=Se.convert(t.center||z);this._normalizeCenter(B),x=r.project(z),w=r.project(B).sub(x)}const E=r.zoomScale(d-o);let M,D;t.around&&(M=Se.convert(t.around),D=r.locationPoint(M));const A=this._zooming||d!==o,P=this._rotating||s!==f,C=this._pitching||m!==c,R=!r.isPaddingEqual(g),k=z=>B=>{if(A&&(z.zoom=le(o,d,B)),P&&(z.bearing=le(s,f,B)),C&&(z.pitch=le(c,m,B)),R&&(z.interpolatePadding(u,g,B),v=z.centerPoint.add(y)),M)z.setLocationAtPoint(M,D);else{const U=z.zoomScale(z.zoom-o),$=d>o?Math.min(2,E):Math.max(.5,E),W=Math.pow($,1-B),V=z.unproject(x.add(w.mult(B*W)).mult(U));z.setLocationAtPoint(z.renderWorldCopies?V.wrap():V,v)}return t.preloadOnly||this._fireMoveEvents(n),z};if(t.preloadOnly){const z=this._emulate(k,t.duration,r);return this._preloadTiles(z),this}const N={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=A,this._rotating=P,this._pitching=C,this._padding=R,this._easeId=t.easeId,this._prepareEase(n,t.noMoveStart,N),this._ease(k(r),z=>{"sea"===r.cameraElevationReference&&r.recenterOnTerrain(),this._afterEase(n,z)},t),this}_prepareEase(t,n,r={}){this._moving=!0,this.transform.cameraElevationReference="sea",this.transform._orthographicProjectionAtLowPitch&&0===this.transform.pitch&&"globe"!==this.transform.projection.name&&(this.transform.cameraElevationReference="ground"),n||r.moving||this.fire(new Mt("movestart",t)),this._zooming&&!r.zooming&&this.fire(new Mt("zoomstart",t)),this._rotating&&!r.rotating&&this.fire(new Mt("rotatestart",t)),this._pitching&&!r.pitching&&this.fire(new Mt("pitchstart",t))}_fireMoveEvents(t){this.fire(new Mt("move",t)),this._zooming&&this.fire(new Mt("zoom",t)),this._rotating&&this.fire(new Mt("rotate",t)),this._pitching&&this.fire(new Mt("pitch",t))}_afterEase(t,n){if(this._easeId&&n&&this._easeId===n)return;this._easeId=void 0,this.transform.cameraElevationReference="ground";const r=this._zooming,o=this._rotating,s=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,r&&this.fire(new Mt("zoomend",t)),o&&this.fire(new Mt("rotateend",t)),s&&this.fire(new Mt("pitchend",t)),this.fire(new Mt("moveend",t))}flyTo(t,n){if(this._prefersReducedMotion(t)){const J=to(t,["center","zoom","bearing","pitch","around"]);return this.jumpTo(J,n)}this.stop(),t=Wt({offset:[0,0],speed:1.2,curve:1.42,easing:Tr},t);const r=this.transform,o=this.getZoom(),s=this.getBearing(),c=this.getPitch(),u=this.getPadding(),d="zoom"in t?ne(+t.zoom,r.minZoom,r.maxZoom):o,f="bearing"in t?this._normalizeBearing(t.bearing,s):s,m="pitch"in t?+t.pitch:c,g="padding"in t?t.padding:r.padding,y=r.zoomScale(d-o),v=it.convert(t.offset);let x=r.centerPoint.add(v);const w=r.pointLocation(x),E=Se.convert(t.center||w);this._normalizeCenter(E);const M=r.project(w),D=r.project(E).sub(M);let A=t.curve;const P=Math.max(r.width,r.height),C=P/y,R=D.mag();if("minZoom"in t){const J=ne(Math.min(t.minZoom,o,d),r.minZoom,r.maxZoom),ct=P/r.zoomScale(J-o);A=Math.sqrt(ct/R*2)}const k=A*A;function N(J){const ct=(C*C-P*P+(J?-1:1)*k*k*R*R)/(2*(J?C:P)*k*R);return Math.log(Math.sqrt(ct*ct+1)-ct)}function z(J){return(Math.exp(J)-Math.exp(-J))/2}function B(J){return(Math.exp(J)+Math.exp(-J))/2}const U=N(0);let $=function(J){return B(U)/B(U+A*J)},W=function(J){return P*((B(U)*(z(ct=U+A*J)/B(ct))-z(U))/k)/R;var ct},V=(N(1)-U)/A;if(Math.abs(R)<1e-6||!isFinite(V)){if(Math.abs(P-C)<1e-6)return this.easeTo(t,n);const J=C<P?-1:1;V=Math.abs(Math.log(C/P))/A,W=function(){return 0},$=function(ct){return Math.exp(J*A*ct)}}t.duration="duration"in t?+t.duration:1e3*V/("screenSpeed"in t?+t.screenSpeed/A:+t.speed),t.maxDuration&&t.duration>t.maxDuration&&(t.duration=0);const K=s!==f,Q=m!==c,ot=!r.isPaddingEqual(g),Y=J=>ct=>{const dt=ct*V,ht=1/$(dt);J.zoom=1===ct?d:o+J.scaleZoom(ht),K&&(J.bearing=le(s,f,ct)),Q&&(J.pitch=le(c,m,ct)),ot&&(J.interpolatePadding(u,g,ct),x=J.centerPoint.add(v));const _t=1===ct?E:J.unproject(M.add(D.mult(W(dt))).mult(ht));return J.setLocationAtPoint(J.renderWorldCopies?_t.wrap():_t,x),J._updateCameraOnTerrain(),t.preloadOnly||this._fireMoveEvents(n),J};if(t.preloadOnly){const J=this._emulate(Y,t.duration,r);return this._preloadTiles(J),this}return this._zooming=!0,this._rotating=K,this._pitching=Q,this._padding=ot,this._prepareEase(n,!1),this._ease(Y(r),()=>this._afterEase(n),t),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_stop(t,n){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),this._easeFrameId=void 0,this._onEaseFrame=void 0),this._onEaseEnd){const r=this._onEaseEnd;this._onEaseEnd=void 0,r.call(this,n)}if(!t){const r=this.handlers;r&&r.stop(!1)}return this}_ease(t,n,r){!1===r.animate||0===r.duration?(t(1),n()):(this._easeStart=De.now(),this._easeOptions=r,this._onEaseFrame=t,this._onEaseEnd=n,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_renderFrameCallback(){const t=Math.min((De.now()-this._easeStart)/this._easeOptions.duration,1),n=this._onEaseFrame;n&&n(this._easeOptions.easing(t)),t<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()}_normalizeBearing(t,n){t=Rr(t,-180,180);const r=Math.abs(t-n);return Math.abs(t-360-n)<r&&(t-=360),Math.abs(t+360-n)<r&&(t+=360),t}_normalizeCenter(t){const n=this.transform;if(n.maxBounds||"globe"!==n.projection.name&&!n.renderWorldCopies)return;const r=t.lng-n.center.lng;t.lng+=r>180?-360:r<-180?360:0}_prefersReducedMotion(t){return this._respectPrefersReducedMotion&&De.prefersReducedMotion&&!(t&&t.essential)}_emulate(t,n,r){const o=Math.ceil(15*n/1e3),s=[],c=t(r.clone());for(let u=0;u<=o;u++){const d=c(u/o);s.push(d.clone())}return s}}class e_{constructor(t={}){this.options=t,ei(["_toggleAttribution","_updateEditLink","_updateData","_updateCompact"],this)}getDefaultPosition(){return"bottom-right"}onAdd(t){const n=this.options&&this.options.compact;return this._map=t,this._container=jn("div","mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=jn("button","mapboxgl-ctrl-attrib-button",this._container),jn("span","mapboxgl-ctrl-icon",this._compactButton).setAttribute("aria-hidden","true"),this._compactButton.type="button",this._compactButton.addEventListener("click",this._toggleAttribution),this._setElementTitle(this._compactButton,"ToggleAttribution"),this._innerContainer=jn("div","mapboxgl-ctrl-attrib-inner",this._container),n&&this._container.classList.add("mapboxgl-compact"),this._updateAttributions(),this._updateEditLink(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("moveend",this._updateEditLink),void 0===n&&(this._map.on("resize",this._updateCompact),this._updateCompact()),this._container}onRemove(){this._container.remove(),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("moveend",this._updateEditLink),this._map.off("resize",this._updateCompact),this._map=void 0,this._attribHTML=void 0}_setElementTitle(t,n){const r=this._map._getUIString(`AttributionControl.${n}`);t.removeAttribute("title"),t.firstElementChild&&t.firstElementChild.setAttribute("title",r)}_toggleAttribution(){this._container.classList.contains("mapboxgl-compact-show")?(this._container.classList.remove("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","false")):(this._container.classList.add("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","true"))}_updateEditLink(){let t=this._editLink;t||(t=this._editLink=this._container.querySelector(".mapbox-improve-map"));const n=[{key:"owner",value:this.styleOwner},{key:"id",value:this.styleId},{key:"access_token",value:this._map._requestManager._customAccessToken||Te.ACCESS_TOKEN}];if(t){const r=n.reduce((o,s,c)=>(s.value&&(o+=`${s.key}=${s.value}${c<n.length-1?"&":""}`),o),"?");t.href=`${Te.FEEDBACK_URL}/${r}#${ZE(this._map,!0)}`,t.rel="noopener nofollow",this._setElementTitle(t,"MapFeedback")}}_updateData(t){!t||"metadata"!==t.sourceDataType&&"visibility"!==t.sourceDataType&&"style"!==t.dataType||(this._updateAttributions(),this._updateEditLink())}_updateAttributions(){if(!this._map.style)return;let t=[];if(this._map.style.stylesheet){const o=this._map.style.stylesheet;this.styleOwner=o.owner,this.styleId=o.id}const n=this._map.style._mergedSourceCaches;for(const o in n){const s=n[o];if(s.used){const c=s.getSource();c.attribution&&t.indexOf(c.attribution)<0&&t.push(c.attribution)}}t.sort((o,s)=>o.length-s.length),t=t.filter((o,s)=>{for(let c=s+1;c<t.length;c++)if(t[c].indexOf(o)>=0)return!1;return!0}),this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?t=[...this.options.customAttribution,...t]:t.unshift(this.options.customAttribution));const r=t.join(" | ");r!==this._attribHTML&&(this._attribHTML=r,t.length?(this._innerContainer.innerHTML=r,this._container.classList.remove("mapboxgl-attrib-empty")):this._container.classList.add("mapboxgl-attrib-empty"),this._editLink=null)}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640?this._container.classList.add("mapboxgl-compact"):this._container.classList.remove("mapboxgl-compact","mapboxgl-compact-show")}}class lT{constructor(){ei(["_updateLogo","_updateCompact"],this)}onAdd(t){this._map=t,this._container=jn("div","mapboxgl-ctrl");const n=jn("a","mapboxgl-ctrl-logo");return n.target="_blank",n.rel="noopener nofollow",n.href="https://www.mapbox.com/",n.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),n.setAttribute("rel","noopener nofollow"),this._container.appendChild(n),this._container.style.display="none",this._map.on("sourcedata",this._updateLogo),this._updateLogo(),this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){this._container.remove(),this._map.off("sourcedata",this._updateLogo),this._map.off("resize",this._updateCompact)}getDefaultPosition(){return"bottom-left"}_updateLogo(t){t&&"metadata"!==t.sourceDataType||(this._container.style.display=this._logoRequired()?"block":"none")}_logoRequired(){if(!this._map.style)return!0;const t=this._map.style._sourceCaches;if(0===Object.entries(t).length)return!0;for(const n in t){const r=t[n].getSource();if(r.hasOwnProperty("mapbox_logo")&&!r.mapbox_logo)return!1}return!0}_updateCompact(){const t=this._container.children;if(t.length){const n=t[0];this._map.getCanvasContainer().offsetWidth<250?n.classList.add("mapboxgl-compact"):n.classList.remove("mapboxgl-compact")}}}class cT{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(t){const n=++this._id;return this._queue.push({callback:t,id:n,cancelled:!1}),n}remove(t){const n=this._currentlyRunning,r=n?this._queue.concat(n):this._queue;for(const o of r)if(o.id===t)return void(o.cancelled=!0)}run(t=0){const n=this._currentlyRunning=this._queue;this._queue=[];for(const r of n)if(!r.cancelled&&(r.callback(t),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}function uT(e,t,n){if(e=new Se(e.lng,e.lat),t){const r=new Se(e.lng-360,e.lat),o=new Se(e.lng+360,e.lat),s=360*Math.ceil(Math.abs(e.lng-n.center.lng)/360),c=n.locationPoint(e).distSqr(t),u=t.x<0||t.y<0||t.x>n.width||t.y>n.height;n.locationPoint(r).distSqr(t)<c&&(u||Math.abs(r.lng-n.center.lng)<s)?e=r:n.locationPoint(o).distSqr(t)<c&&(u||Math.abs(o.lng-n.center.lng)<s)&&(e=o)}for(;Math.abs(e.lng-n.center.lng)>180;){const r=n.locationPoint(e);if(r.x>=0&&r.y>=0&&r.x<=n.width&&r.y<=n.height)break;e.lng>n.center.lng?e.lng-=360:e.lng+=360}return e}const Gv={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"};class $v extends ye{constructor(t,n){if(super(),(t instanceof ft.HTMLElement||n)&&(t=Wt({element:t},n)),ei(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress","_clearFadeTimer"],this),this._anchor=t&&t.anchor||"center",this._color=t&&t.color||"#3FB1CE",this._scale=t&&t.scale||1,this._draggable=t&&t.draggable||!1,this._clickTolerance=t&&t.clickTolerance||0,this._isDragging=!1,this._state="inactive",this._rotation=t&&t.rotation||0,this._rotationAlignment=t&&t.rotationAlignment||"auto",this._pitchAlignment=t&&t.pitchAlignment&&t.pitchAlignment||"auto",this._updateMoving=()=>this._update(!0),this._occludedOpacity=t&&t.occludedOpacity||.2,t&&t.element)this._element=t.element,this._offset=it.convert(t&&t.offset||[0,0]);else{this._defaultMarker=!0,this._element=jn("div");const s=41,c=27,u=zo("svg",{display:"block",height:s*this._scale+"px",width:c*this._scale+"px",viewBox:`0 0 ${c} ${s}`},this._element),d=zo("radialGradient",{id:"shadowGradient"},zo("defs",{},u));zo("stop",{offset:"10%","stop-opacity":.4},d),zo("stop",{offset:"100%","stop-opacity":.05},d),zo("ellipse",{cx:13.5,cy:34.8,rx:10.5,ry:5.25,fill:"url(#shadowGradient)"},u),zo("path",{fill:this._color,d:"M27,13.5C27,19.07 20.25,27 14.75,34.5C14.02,35.5 12.98,35.5 12.25,34.5C6.75,27 0,19.22 0,13.5C0,6.04 6.04,0 13.5,0C20.96,0 27,6.04 27,13.5Z"},u),zo("path",{opacity:.25,d:"M13.5,0C6.04,0 0,6.04 0,13.5C0,19.22 6.75,27 12.25,34.5C13,35.52 14.02,35.5 14.75,34.5C20.25,27 27,19.07 27,13.5C27,6.04 20.96,0 13.5,0ZM13.5,1C20.42,1 26,6.58 26,13.5C26,15.9 24.5,19.18 22.22,22.74C19.95,26.3 16.71,30.14 13.94,33.91C13.74,34.18 13.61,34.32 13.5,34.44C13.39,34.32 13.26,34.18 13.06,33.91C10.28,30.13 7.41,26.31 5.02,22.77C2.62,19.23 1,15.95 1,13.5C1,6.58 6.58,1 13.5,1Z"},u),zo("circle",{fill:"white",cx:13.5,cy:13.5,r:5.5},u),this._offset=it.convert(t&&t.offset||[0,-14])}this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label","Map marker"),this._element.hasAttribute("role")||this._element.setAttribute("role","img"),this._element.classList.add("mapboxgl-marker"),this._element.addEventListener("dragstart",s=>{s.preventDefault()}),this._element.addEventListener("mousedown",s=>{s.preventDefault()});const r=this._element.classList;for(const s in Gv)r.remove(`mapboxgl-marker-anchor-${s}`);r.add(`mapboxgl-marker-anchor-${this._anchor}`);const o=t&&t.className?t.className.trim().split(/\s+/):[];r.add(...o),this._popup=null}addTo(t){return t===this._map||(this.remove(),this._map=t,t.getCanvasContainer().appendChild(this._element),t.on("move",this._updateMoving),t.on("moveend",this._update),t.on("remove",this._clearFadeTimer),t._addMarker(this),this.setDraggable(this._draggable),this._update(),t.on("click",this._onMapClick)),this}remove(){const t=this._map;return t&&(t.off("click",this._onMapClick),t.off("move",this._updateMoving),t.off("moveend",this._update),t.off("mousedown",this._addDragHandler),t.off("touchstart",this._addDragHandler),t.off("mouseup",this._onUp),t.off("touchend",this._onUp),t.off("mousemove",this._onMove),t.off("touchmove",this._onMove),t.off("remove",this._clearFadeTimer),t._removeMarker(this),this._map=void 0),this._clearFadeTimer(),this._element.remove(),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(t){return this._lngLat=Se.convert(t),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(!0),this}getElement(){return this._element}setPopup(t){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeAttribute("role"),this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),t){if(!("offset"in t.options)){const o=Math.sqrt(Math.pow(13.5,2)/2);t.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[o,-1*(24.6+o)],"bottom-right":[-o,-1*(24.6+o)],left:[13.5,-24.6],right:[-13.5,-24.6]}:this._offset}this._popup=t,t._marker=this,this._lngLat&&this._popup.setLngLat(this._lngLat),this._element.setAttribute("role","button"),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress),this._element.setAttribute("aria-expanded","false")}return this}_onKeyPress(t){const n=t.code,r=t.charCode||t.keyCode;"Space"!==n&&"Enter"!==n&&32!==r&&13!==r||this.togglePopup()}_onMapClick(t){const n=t.originalEvent.target,r=this._element;this._popup&&(n===r||r.contains(n))&&this.togglePopup()}getPopup(){return this._popup}togglePopup(){const t=this._popup;return t?(t.isOpen()?(t.remove(),this._element.setAttribute("aria-expanded","false")):this._map&&(t.addTo(this._map),this._element.setAttribute("aria-expanded","true")),this):this}_behindTerrain(){const t=this._map,n=this._pos;if(!t||!n)return!1;const r=t.unproject(n),o=t.getFreeCameraOptions();if(!o.position)return!1;const s=o.position.toLngLat();return s.distanceTo(r)<.9*s.distanceTo(this._lngLat)}_evaluateOpacity(){const t=this._map;if(!t)return;const n=this._pos;if(!n||n.x<0||n.x>t.transform.width||n.y<0||n.y>t.transform.height)return void this._clearFadeTimer();const r=t.unproject(n);let o;t._showingGlobe()&&py(t.transform,this._lngLat)?o=0:(o=1-t._queryFogOpacity(r),t.transform._terrainEnabled()&&t.getTerrain()&&this._behindTerrain()&&(o*=this._occludedOpacity)),this._element.style.opacity=`${o}`,this._element.style.pointerEvents=o>0?"auto":"none",this._popup&&this._popup._setOpacity(o),this._fadeTimer=null}_clearFadeTimer(){this._fadeTimer&&(clearTimeout(this._fadeTimer),this._fadeTimer=null)}_updateDOM(){const t=this._pos;if(!t||!this._map)return;const n=this._offset.mult(this._scale);this._element.style.transform=`\n            translate(${t.x}px,${t.y}px)\n            ${Gv[this._anchor]}\n            ${this._calculateXYTransform()} ${this._calculateZTransform()}\n            translate(${n.x}px,${n.y}px)\n        `}_calculateXYTransform(){const t=this._pos,n=this._map,r=this.getPitchAlignment();if(!n||!t||"map"!==r)return"";if(!n._showingGlobe()){const d=n.getPitch();return d?`rotateX(${d}deg)`:""}const o=fr(IM(n.transform,this._lngLat)),s=t.sub(fy(n.transform)),c=Math.abs(s.x)+Math.abs(s.y);if(0===c)return"";const u=o/c;return`rotateX(${-s.y*u}deg) rotateY(${s.x*u}deg)`}_calculateZTransform(){const t=this._pos,n=this._map;if(!n||!t)return"";let r=0;const o=this.getRotationAlignment();if("map"===o)if(n._showingGlobe()){const s=n.project(new Se(this._lngLat.lng,this._lngLat.lat+.001)),c=n.project(new Se(this._lngLat.lng,this._lngLat.lat-.001)).sub(s);r=fr(Math.atan2(c.y,c.x))-90}else r=-n.getBearing();else if("horizon"===o){const s=Ro(4,6,n.getZoom()),c=fy(n.transform);c.y+=s*n.transform.height;const u=t.sub(c),d=fr(Math.atan2(u.y,u.x));r=(d>90?d-270:d+90)*(1-s)}return r+=this._rotation,r?`rotateZ(${r}deg)`:""}_update(t){ft.cancelAnimationFrame(this._updateFrameId);const n=this._map;n&&(n.transform.renderWorldCopies&&(this._lngLat=uT(this._lngLat,this._pos,n.transform)),this._pos=n.project(this._lngLat),!0===t?this._updateFrameId=ft.requestAnimationFrame(()=>{this._element&&this._pos&&this._anchor&&(this._pos=this._pos.round(),this._updateDOM())}):this._pos=this._pos.round(),n._requestDomTask(()=>{this._map&&(this._element&&this._pos&&this._anchor&&this._updateDOM(),(n._showingGlobe()||n.getTerrain()||n.getFog())&&!this._fadeTimer&&(this._fadeTimer=setTimeout(this._evaluateOpacity.bind(this),60)))}))}getOffset(){return this._offset}setOffset(t){return this._offset=it.convert(t),this._update(),this}addClassName(t){return this._element.classList.add(t),this}removeClassName(t){return this._element.classList.remove(t),this}toggleClassName(t){return this._element.classList.toggle(t)}_onMove(t){const n=this._map;if(!n)return;const r=this._pointerdownPos,o=this._positionDelta;if(r&&o){if(!this._isDragging){const s=this._clickTolerance||n._clickTolerance;if(t.point.dist(r)<s)return;this._isDragging=!0}this._pos=t.point.sub(o),this._lngLat=n.unproject(this._pos),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none","pending"===this._state&&(this._state="active",this.fire(new Mt("dragstart"))),this.fire(new Mt("drag"))}}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1;const t=this._map;t&&(t.off("mousemove",this._onMove),t.off("touchmove",this._onMove)),"active"===this._state&&this.fire(new Mt("dragend")),this._state="inactive"}_addDragHandler(t){const n=this._map,r=this._pos;n&&r&&this._element.contains(t.originalEvent.target)&&(t.preventDefault(),this._positionDelta=t.point.sub(r),this._pointerdownPos=t.point,this._state="pending",n.on("mousemove",this._onMove),n.on("touchmove",this._onMove),n.once("mouseup",this._onUp),n.once("touchend",this._onUp))}setDraggable(t){this._draggable=!!t;const n=this._map;return n&&(t?(n.on("mousedown",this._addDragHandler),n.on("touchstart",this._addDragHandler)):(n.off("mousedown",this._addDragHandler),n.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(t){return this._rotation=t||0,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(t){return this._rotationAlignment=t||"auto",this._update(),this}getRotationAlignment(){return"auto"===this._rotationAlignment||"horizon"===this._rotationAlignment&&this._map&&!this._map._showingGlobe()?"viewport":this._rotationAlignment}setPitchAlignment(t){return this._pitchAlignment=t||"auto",this._update(),this}getPitchAlignment(){return"auto"===this._pitchAlignment?this.getRotationAlignment():this._pitchAlignment}setOccludedOpacity(t){return this._occludedOpacity=t||.2,this._update(),this}getOccludedOpacity(){return this._occludedOpacity}}const LS={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px"},OS=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function hT(e=new it(0,0),t="bottom"){if("number"==typeof e){const n=Math.round(Math.sqrt(.5*Math.pow(e,2)));switch(t){case"top":return new it(0,e);case"top-left":return new it(n,n);case"top-right":return new it(-n,n);case"bottom":return new it(0,-e);case"bottom-left":return new it(n,-n);case"bottom-right":return new it(-n,-n);case"left":return new it(e,0);case"right":return new it(-e,0)}return new it(0,0)}return e instanceof it||Array.isArray(e)?it.convert(e):it.convert(e[t]||[0,0])}class kS{constructor(t){this.jumpTo(t)}getValue(t){if(t<=this._startTime)return this._start;if(t>=this._endTime)return this._end;const n=ls((t-this._startTime)/(this._endTime-this._startTime));return this._start*(1-n)+this._end*n}isEasing(t){return t>=this._startTime&&t<=this._endTime}jumpTo(t){this._startTime=-1/0,this._endTime=-1/0,this._start=t,this._end=t}easeTo(t,n,r){this._start=this.getValue(n),this._end=t,this._startTime=n,this._endTime=n+r}}const FS={"AttributionControl.ToggleAttribution":"Toggle attribution","AttributionControl.MapFeedback":"Map feedback","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox logo","Map.Title":"Map","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScrollZoomBlocker.CtrlMessage":"Use ctrl + scroll to zoom the map","ScrollZoomBlocker.CmdMessage":"Use \u2318 + scroll to zoom the map","TouchPanBlocker.Message":"Use two fingers to move the map"},NS={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:85,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,performanceMetricsCollection:!0,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,antialias:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,minTileCacheSize:null,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",localFontFamily:null,transformRequest:null,accessToken:null,fadeDuration:300,respectPrefersReducedMotion:!0,crossSourceCollisions:!0,collectResourceTiming:!1,testMode:!1},dT={showCompass:!0,showZoom:!0,visualizePitch:!1};class Hv{constructor(t,n,r=!1){this._clickTolerance=10,this.element=n,this.mouseRotate=new vS({clickTolerance:t.dragRotate._mouseRotate._clickTolerance}),this.map=t,r&&(this.mousePitch=new xS({clickTolerance:t.dragRotate._mousePitch._clickTolerance})),ei(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),n.addEventListener("mousedown",this.mousedown),n.addEventListener("touchstart",this.touchstart,{passive:!1}),n.addEventListener("touchmove",this.touchmove),n.addEventListener("touchend",this.touchend),n.addEventListener("touchcancel",this.reset)}down(t,n){this.mouseRotate.mousedown(t,n),this.mousePitch&&this.mousePitch.mousedown(t,n),tt()}move(t,n){const r=this.map,o=this.mouseRotate.mousemoveWindow(t,n),s=o&&o.bearingDelta;if(s&&r.setBearing(r.getBearing()+s),this.mousePitch){const c=this.mousePitch.mousemoveWindow(t,n),u=c&&c.pitchDelta;u&&r.setPitch(r.getPitch()+u)}}off(){const t=this.element;t.removeEventListener("mousedown",this.mousedown),t.removeEventListener("touchstart",this.touchstart,{passive:!1}),t.removeEventListener("touchmove",this.touchmove),t.removeEventListener("touchend",this.touchend),t.removeEventListener("touchcancel",this.reset),this.offTemp()}offTemp(){lt(),ft.removeEventListener("mousemove",this.mousemove),ft.removeEventListener("mouseup",this.mouseup)}mousedown(t){this.down(Wt({},t,{ctrlKey:!0,preventDefault:()=>t.preventDefault()}),Et(this.element,t)),ft.addEventListener("mousemove",this.mousemove),ft.addEventListener("mouseup",this.mouseup)}mousemove(t){this.move(t,Et(this.element,t))}mouseup(t){this.mouseRotate.mouseupWindow(t),this.mousePitch&&this.mousePitch.mouseupWindow(t),this.offTemp()}touchstart(t){1!==t.targetTouches.length?this.reset():(this._startPos=this._lastPos=Xt(this.element,t.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>t.preventDefault()},this._startPos))}touchmove(t){1!==t.targetTouches.length?this.reset():(this._lastPos=Xt(this.element,t.targetTouches)[0],this.move({preventDefault:()=>t.preventDefault()},this._lastPos))}touchend(t){0===t.targetTouches.length&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset()}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()}}const zS={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0,showUserHeading:!1},BS={maxWidth:100,unit:"metric"},fT={kilometer:"km",meter:"m",mile:"mi",foot:"ft","nautical-mile":"nm"},Fp={version:po,supported:Jd,setRTLTextPlugin:function(e,t,n=!1){if(ni===M_||ni===Pi||ni===em)throw new Error("setRTLTextPlugin cannot be called multiple times.");ka=De.resolveURL(e),ni=M_,tu=t,I_(),n||ao()},getRTLTextPluginStatus:rm,Map:class extends RS{constructor(e){No.mark(Fo.create);const t=e;if(null!=(e=Wt({},NS,e)).minZoom&&null!=e.maxZoom&&e.minZoom>e.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(null!=e.minPitch&&null!=e.maxPitch&&e.minPitch>e.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(null!=e.minPitch&&e.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(null!=e.maxPitch&&e.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(e.antialias&&function(n){const r=n.navigator?n.navigator.userAgent:null;return!!function(o){if(null==_e){const s=o.navigator?o.navigator.userAgent:null;_e=!!o.safari||!(!s||!(/\b(iPad|iPhone|iPod)\b/.test(s)||s.match("Safari")&&!s.match("Chrome")))}return _e}(n)&&r&&(r.match("Version/15.4")||r.match("Version/15.5")||r.match(/CPU (OS|iPhone OS) (15_4|15_5) like Mac OS X/))}(ft)&&(e.antialias=!1,nt("Antialiasing is disabled for this WebGL context to avoid browser bug: https://github.com/mapbox/mapbox-gl-js/issues/11609")),super(new Tg(e.minZoom,e.maxZoom,e.minPitch,e.maxPitch,e.renderWorldCopies),e),this._interactive=e.interactive,this._minTileCacheSize=e.minTileCacheSize,this._maxTileCacheSize=e.maxTileCacheSize,this._failIfMajorPerformanceCaveat=e.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=e.preserveDrawingBuffer,this._antialias=e.antialias,this._trackResize=e.trackResize,this._bearingSnap=e.bearingSnap,this._refreshExpiredTiles=e.refreshExpiredTiles,this._fadeDuration=e.fadeDuration,this._isInitialLoad=!0,this._crossSourceCollisions=e.crossSourceCollisions,this._collectResourceTiming=e.collectResourceTiming,this._language=this._parseLanguage(e.language),this._worldview=e.worldview,this._renderTaskQueue=new cT,this._domRenderTaskQueue=new cT,this._controls=[],this._markers=[],this._popups=[],this._mapId=Dr(),this._locale=Wt({},FS,e.locale),this._clickTolerance=e.clickTolerance,this._cooperativeGestures=e.cooperativeGestures,this._performanceMetricsCollection=e.performanceMetricsCollection,this._containerWidth=0,this._containerHeight=0,this._averageElevationLastSampledAt=-1/0,this._averageElevationExaggeration=0,this._averageElevation=new kS(0),this._interactionRange=[1/0,-1/0],this._visibilityHidden=0,this._useExplicitProjection=!1,this._requestManager=new ge(e.transformRequest,e.accessToken,e.testMode),this._silenceAuthErrors=!!e.testMode,this._contextCreateOptions=e.contextCreateOptions?{...e.contextCreateOptions}:{},"string"==typeof e.container){if(this._container=ft.document.getElementById(e.container),!this._container)throw new Error(`Container '${e.container.toString()}' not found.`)}else{if(!(e.container instanceof ft.HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=e.container}if(this._container.childNodes.length>0&&nt("The map container element should be empty, otherwise the map's interactivity will be negatively impacted. If you want to display a message when WebGL is not supported, use the Mapbox GL Supported plugin instead."),e.maxBounds&&this.setMaxBounds(e.maxBounds),ei(["_onWindowOnline","_onWindowResize","_onVisibilityChange","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._setupPainter(),void 0===this.painter)throw new Error("Failed to initialize WebGL.");if(this.on("move",()=>this._update(!1)),this.on("moveend",()=>this._update(!1)),this.on("zoom",()=>this._update(!0)),void 0!==ft&&(this._fullscreenchangeEvent="onfullscreenchange"in ft.document?"fullscreenchange":"webkitfullscreenchange",ft.addEventListener("online",this._onWindowOnline,!1),ft.addEventListener("resize",this._onWindowResize,!1),ft.addEventListener("orientationchange",this._onWindowResize,!1),ft.addEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),ft.addEventListener("visibilitychange",this._onVisibilityChange,!1)),this.handlers=new PS(this,e),this._localFontFamily=e.localFontFamily,this._localIdeographFontFamily=e.localIdeographFontFamily,(e.style||!e.testMode)&&this.setStyle(e.style||Te.DEFAULT_STYLE,{localFontFamily:this._localFontFamily,localIdeographFontFamily:this._localIdeographFontFamily}),e.projection&&this.setProjection(e.projection),e.hash&&(this._hash=new gS("string"==typeof e.hash&&e.hash||void 0).addTo(this)),!this._hash||!this._hash._onHashChange()){null==t.center&&null==t.zoom||(this.transform._unmodified=!1),this.jumpTo({center:e.center,zoom:e.zoom,bearing:e.bearing,pitch:e.pitch});const n=e.bounds;n&&(this.resize(),this.fitBounds(n,Wt({},e.fitBoundsOptions,{duration:0})))}this.resize(),e.attributionControl&&this.addControl(new e_({customAttribution:e.customAttribution})),this._logoControl=new lT,this.addControl(this._logoControl,e.logoPosition),this.on("style.load",()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet)}),this.on("data",n=>{this._update("style"===n.dataType),this.fire(new Mt(`${n.dataType}data`,n))}),this.on("dataloading",n=>{this.fire(new Mt(`${n.dataType}dataloading`,n))})}_getMapId(){return this._mapId}addControl(e,t){if(void 0===t&&(t=e.getDefaultPosition?e.getDefaultPosition():"top-right"),!e||!e.onAdd)return this.fire(new Tt(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const n=e.onAdd(this);this._controls.push(e);const r=this._controlPositions[t];return-1!==t.indexOf("bottom")?r.insertBefore(n,r.firstChild):r.appendChild(n),this}removeControl(e){if(!e||!e.onRemove)return this.fire(new Tt(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const t=this._controls.indexOf(e);return t>-1&&this._controls.splice(t,1),e.onRemove(this),this}hasControl(e){return this._controls.indexOf(e)>-1}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}resize(e){if(this._updateContainerDimensions(),this._containerWidth===this.transform.width&&this._containerHeight===this.transform.height)return this;this._resizeCanvas(this._containerWidth,this._containerHeight),this.transform.resize(this._containerWidth,this._containerHeight),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight));const t=!this._moving;return t&&this.fire(new Mt("movestart",e)).fire(new Mt("move",e)),this.fire(new Mt("resize",e)),t&&this.fire(new Mt("moveend",e)),this}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()||null}setMaxBounds(e){return this.transform.setMaxBounds(Oi.convert(e)),this._update()}setMinZoom(e){if((e=e??-2)>=-2&&e<=this.transform.maxZoom)return this.transform.minZoom=e,this._update(),this.getZoom()<e?this.setZoom(e):this.fire(new Mt("zoomstart")).fire(new Mt("zoom")).fire(new Mt("zoomend")),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(e){if((e=e??22)>=this.transform.minZoom)return this.transform.maxZoom=e,this._update(),this.getZoom()>e?this.setZoom(e):this.fire(new Mt("zoomstart")).fire(new Mt("zoom")).fire(new Mt("zoomend")),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(e){if((e=e??0)<0)throw new Error("minPitch must be greater than or equal to 0");if(e>=0&&e<=this.transform.maxPitch)return this.transform.minPitch=e,this._update(),this.getPitch()<e?this.setPitch(e):this.fire(new Mt("pitchstart")).fire(new Mt("pitch")).fire(new Mt("pitchend")),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(e){if((e=e??85)>85)throw new Error("maxPitch must be less than or equal to 85");if(e>=this.transform.minPitch)return this.transform.maxPitch=e,this._update(),this.getPitch()>e?this.setPitch(e):this.fire(new Mt("pitchstart")).fire(new Mt("pitch")).fire(new Mt("pitchend")),this;throw new Error("maxPitch must be greater than or equal to minPitch")}getMaxPitch(){return this.transform.maxPitch}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(e){return this.transform.renderWorldCopies=e,this.transform.renderWorldCopies||this._forceMarkerAndPopupUpdate(!0),this._update()}getLanguage(){return this._language}_parseLanguage(e){return"auto"===e?ft.navigator.language:Array.isArray(e)?0===e.length?void 0:e.map(t=>"auto"===t?ft.navigator.language:t):e}setLanguage(e){const t=this._parseLanguage(e);if(!this.style||t===this._language)return this;this._language=t,this.style.reloadSources();for(const n of this._controls)n._setLanguage&&n._setLanguage(this._language);return this}getWorldview(){return this._worldview}setWorldview(e){return this.style&&e!==this._worldview?(this._worldview=e,this.style.reloadSources(),this):this}getProjection(){return this.transform.mercatorFromTransition?{name:"globe",center:[0,0]}:this.transform.getProjection()}_showingGlobe(){return"globe"===this.transform.projection.name}setProjection(e){return this._lazyInitEmptyStyle(),e?"string"==typeof e&&(e={name:e}):e=null,this._useExplicitProjection=!!e,this._prioritizeAndUpdateProjection(e,this.style.projection)}_updateProjectionTransition(){if("globe"!==this.getProjection().name)return;const e=this.transform,t=e.projection.name;let n;"globe"===t&&e.zoom>=yc?(e.setMercatorFromTransition(),n=!0):"mercator"===t&&e.zoom<yc&&(e.setProjection({name:"globe"}),n=!0),n&&(this.style.applyProjectionUpdate(),this.style._forceSymbolLayerUpdate())}_prioritizeAndUpdateProjection(e,t){return this._updateProjection(e||t||{name:"mercator"})}_updateProjection(e){let t;return t="globe"===e.name&&this.transform.zoom>=yc?this.transform.setMercatorFromTransition():this.transform.setProjection(e),this.style.applyProjectionUpdate(),t&&(this.painter.clearBackgroundTiles(),this.style.clearSources(),this._update(!0),this._forceMarkerAndPopupUpdate(!0)),this}project(e){return this.transform.locationPoint3D(Se.convert(e))}unproject(e){return this.transform.pointLocation3D(it.convert(e))}isMoving(){return this._moving||this.handlers&&this.handlers.isMoving()||!1}isZooming(){return this._zooming||this.handlers&&this.handlers.isZooming()||!1}isRotating(){return this._rotating||this.handlers&&this.handlers.isRotating()||!1}_isDragging(){return this.handlers&&this.handlers._isDragging()||!1}_createDelegatedListener(e,t,n){if("mouseenter"===e||"mouseover"===e){let r=!1;const o=c=>{const u=t.filter(f=>this.getLayer(f)),d=u.length?this.queryRenderedFeatures(c.point,{layers:u}):[];d.length?r||(r=!0,n.call(this,new is(e,this,c.originalEvent,{features:d}))):r=!1},s=()=>{r=!1};return{layers:new Set(t),listener:n,delegates:{mousemove:o,mouseout:s}}}if("mouseleave"===e||"mouseout"===e){let r=!1;const o=c=>{const u=t.filter(d=>this.getLayer(d));(u.length?this.queryRenderedFeatures(c.point,{layers:u}):[]).length?r=!0:r&&(r=!1,n.call(this,new is(e,this,c.originalEvent)))},s=c=>{r&&(r=!1,n.call(this,new is(e,this,c.originalEvent)))};return{layers:new Set(t),listener:n,delegates:{mousemove:o,mouseout:s}}}{const r=o=>{const s=t.filter(u=>this.getLayer(u)),c=s.length?this.queryRenderedFeatures(o.point,{layers:s}):[];c.length&&(o.features=c,n.call(this,o),delete o.features)};return{layers:new Set(t),listener:n,delegates:{[e]:r}}}}on(e,t,n){if(void 0===n)return super.on(e,t);if(Array.isArray(t)||(t=[t]),t)for(const o of t)if(!this._isValidId(o))return this;const r=this._createDelegatedListener(e,t,n);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[e]=this._delegatedListeners[e]||[],this._delegatedListeners[e].push(r);for(const o in r.delegates)this.on(o,r.delegates[o]);return this}once(e,t,n){if(void 0===n)return super.once(e,t);if(Array.isArray(t)||(t=[t]),t)for(const o of t)if(!this._isValidId(o))return this;const r=this._createDelegatedListener(e,t,n);for(const o in r.delegates)this.once(o,r.delegates[o]);return this}off(e,t,n){if(void 0===n)return super.off(e,t);t=new Set(Array.isArray(t)?t:[t]);for(const s of t)if(!this._isValidId(s))return this;const r=(s,c)=>{if(s.size!==c.size)return!1;for(const u of s)if(!c.has(u))return!1;return!0},o=this._delegatedListeners?this._delegatedListeners[e]:void 0;return o&&(s=>{for(let c=0;c<s.length;c++){const u=s[c];if(u.listener===n&&r(u.layers,t)){for(const d in u.delegates)this.off(d,u.delegates[d]);return s.splice(c,1),this}}})(o),this}queryRenderedFeatures(e,t){if(!this.style)return[];if(void 0!==t||void 0===e||e instanceof it||Array.isArray(e)||(t=e,e=void 0),e=e||[[0,0],[this.transform.width,this.transform.height]],(t=t||{}).layers&&Array.isArray(t.layers))for(const n of t.layers)if(!this._isValidId(n))return[];return this.style.queryRenderedFeatures(e,t,this.transform)}querySourceFeatures(e,t){return this._isValidId(e)?this.style.querySourceFeatures(e,t):[]}isPointOnSurface(e){const{name:t}=this.transform.projection;return"globe"!==t&&"mercator"!==t&&nt(`${t} projection does not support isPointOnSurface, this API may behave unexpectedly.`),this.transform.isPointOnSurface(it.convert(e))}setStyle(e,t){return!1!==(t=Wt({},{localIdeographFontFamily:this._localIdeographFontFamily,localFontFamily:this._localFontFamily},t)).diff&&t.localIdeographFontFamily===this._localIdeographFontFamily&&t.localFontFamily===this._localFontFamily&&this.style&&e?(this._diffStyle(e,t),this):(this._localIdeographFontFamily=t.localIdeographFontFamily,this._localFontFamily=t.localFontFamily,this._updateStyle(e,t))}_getUIString(e){const t=this._locale[e];if(null==t)throw new Error(`Missing UI string '${e}'`);return t}_updateStyle(e,t){return this.style&&(this.style.setEventedParent(null),this.style._remove(),this.style=void 0),e&&(this.style=new ma(this,t||{}),this.style.setEventedParent(this,{style:this.style}),"string"==typeof e?this.style.loadURL(e):this.style.loadJSON(e)),this._updateTerrain(),this}_lazyInitEmptyStyle(){this.style||(this.style=new ma(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}_diffStyle(e,t){if("string"==typeof e){const n=this._requestManager.normalizeStyleURL(e),r=this._requestManager.transformRequest(n,yt.Style);zt(r,(o,s)=>{o?this.fire(new Tt(o)):s&&this._updateDiff(s,t)})}else"object"==typeof e&&this._updateDiff(e,t)}_updateDiff(e,t){try{this.style.setState(e)&&this._update(!0)}catch(n){nt(`Unable to perform style diff: ${n.message||n.error||n}.  Rebuilding the style from scratch.`),this._updateStyle(e,t)}}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():(nt("There is no style added to the map."),!1)}_isValidId(e){return null==e?(this.fire(new Tt(new Error("IDs can't be empty."))),!1):!S_(e)||(this.fire(new Tt(new Error(`IDs can't contain special symbols: "${e}".`))),!1)}addSource(e,t){return this._isValidId(e)?(this._lazyInitEmptyStyle(),this.style.addSource(e,t),this._update(!0)):this}isSourceLoaded(e){return!!this._isValidId(e)&&!!this.style&&this.style._isSourceCacheLoaded(e)}areTilesLoaded(){const e=this.style&&this.style._sourceCaches;for(const t in e){const n=e[t]._tiles;for(const r in n){const o=n[r];if("loaded"!==o.state&&"errored"!==o.state)return!1}}return!0}addSourceType(e,t,n){this._lazyInitEmptyStyle(),this.style.addSourceType(e,t,n)}removeSource(e){return this._isValidId(e)?(this.style.removeSource(e),this._updateTerrain(),this._update(!0)):this}getSource(e){return this._isValidId(e)?this.style.getOwnSource(e):null}addImage(e,t,{pixelRatio:n=1,sdf:r=!1,stretchX:o,stretchY:s,content:c}={}){if(this._lazyInitEmptyStyle(),t instanceof ft.HTMLImageElement||ft.ImageBitmap&&t instanceof ft.ImageBitmap){const{width:u,height:d,data:f}=De.getImageData(t);this.style.addImage(e,{data:new $r({width:u,height:d},f),pixelRatio:n,stretchX:o,stretchY:s,content:c,sdf:r,version:0})}else if(void 0===t.width||void 0===t.height)this.fire(new Tt(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));else{const{width:u,height:d}=t,f=t;this.style.addImage(e,{data:new $r({width:u,height:d},new Uint8Array(f.data)),pixelRatio:n,stretchX:o,stretchY:s,content:c,sdf:r,version:0,userImage:f}),f.onAdd&&f.onAdd(this,e)}}updateImage(e,t){this._lazyInitEmptyStyle();const n=this.style.getImage(e);if(!n)return void this.fire(new Tt(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const r=t instanceof ft.HTMLImageElement||ft.ImageBitmap&&t instanceof ft.ImageBitmap?De.getImageData(t):t,{width:o,height:s}=r;void 0!==o&&void 0!==s?o===n.data.width&&s===n.data.height?(n.data.replace(r.data,!(t instanceof ft.HTMLImageElement||ft.ImageBitmap&&t instanceof ft.ImageBitmap)),this.style.updateImage(e,n)):this.fire(new Tt(new Error(`The width and height of the updated image (${o}, ${s})\n                must be that same as the previous version of the image\n                (${n.data.width}, ${n.data.height})`))):this.fire(new Tt(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")))}hasImage(e){return e?!!this.style&&!!this.style.getImage(e):(this.fire(new Tt(new Error("Missing required image id"))),!1)}removeImage(e){this.style.removeImage(e)}loadImage(e,t){xe(this._requestManager.transformRequest(e,yt.Image),(n,r)=>{t(n,r instanceof ft.HTMLImageElement?De.getImageData(r):r)})}listImages(){return this.style.listImages()}addModel(e,t){this._lazyInitEmptyStyle(),this.style.addModel(e,t)}hasModel(e){return e?this.style.hasModel(e):(this.fire(new Tt(new Error("Missing required model id"))),!1)}removeModel(e){this.style.removeModel(e)}listModels(){return this.style.listModels()}addLayer(e,t){return this._isValidId(e.id)?(this._lazyInitEmptyStyle(),this.style.addLayer(e,t),this._update(!0)):this}moveLayer(e,t){return this._isValidId(e)?(this.style.moveLayer(e,t),this._update(!0)):this}removeLayer(e){return this._isValidId(e)?(this.style.removeLayer(e),this._update(!0)):this}getLayer(e){return this._isValidId(e)?this.style.getOwnLayer(e):null}setLayerZoomRange(e,t,n){return this._isValidId(e)?(this.style.setLayerZoomRange(e,t,n),this._update(!0)):this}setFilter(e,t,n={}){return this._isValidId(e)?(this.style.setFilter(e,t,n),this._update(!0)):this}getFilter(e){return this._isValidId(e)?this.style.getFilter(e):null}setPaintProperty(e,t,n,r={}){return this._isValidId(e)?(this.style.setPaintProperty(e,t,n,r),this._update(!0)):this}getPaintProperty(e,t){return this._isValidId(e)?this.style.getPaintProperty(e,t):null}setLayoutProperty(e,t,n,r={}){return this._isValidId(e)?(this.style.setLayoutProperty(e,t,n,r),this._update(!0)):this}getLayoutProperty(e,t){return this._isValidId(e)?this.style.getLayoutProperty(e,t):null}getConfigProperty(e,t){return this.style.getConfigProperty(e,t)}setConfigProperty(e,t,n){return this.style.setConfigProperty(e,t,n),this._update(!0)}setLights(e){if(this._lazyInitEmptyStyle(),e&&1===e.length&&"flat"===e[0].type){const t=e[0];t.properties?this.style.setFlatLight(t.properties,t.id,{}):this.style.setFlatLight({},"flat")}else this.style.setLights(e),this.painter.terrain&&(this.painter.terrain.invalidateRenderCache=!0);return this._update(!0)}getLights(){const e=this.style.getLights()||[];return 0===e.length&&e.push({id:this.style.light.id,type:"flat",properties:this.style.getFlatLight()}),e}setLight(e,t={}){return console.log("The `map.setLight` function is deprecated, prefer using `map.setLights` with `flat` light type instead."),this.setLights([{id:"flat",type:"flat",properties:e}])}getLight(){return console.log("The `map.getLight` function is deprecated, prefer using `map.getLights` instead."),this.style.getFlatLight()}setTerrain(e){return this._lazyInitEmptyStyle(),!e&&this.transform.projection.requiresDraping?this.style.setTerrainForDraping():this.style.setTerrain(e),this._averageElevationLastSampledAt=-1/0,this._update(!0)}getTerrain(){return this.style?this.style.getTerrain():null}setFog(e){return this._lazyInitEmptyStyle(),this.style.setFog(e),this._update(!0)}getFog(){return this.style?this.style.getFog():null}setCamera(e){return this.style.setCamera(e),this._triggerCameraUpdate(e)}_triggerCameraUpdate(e){return this._update(this.transform.setOrthographicProjectionAtLowPitch("orthographic"===e["camera-projection"]))}getCamera(){return this.style.camera}_queryFogOpacity(e){return this.style&&this.style.fog?this.style.fog.getOpacityAtLatLng(Se.convert(e),this.transform):0}setFeatureState(e,t){return this._isValidId(e.source)?(this.style.setFeatureState(e,t),this._update()):this}removeFeatureState(e,t){return this._isValidId(e.source)?(this.style.removeFeatureState(e,t),this._update()):this}getFeatureState(e){return this._isValidId(e.source)?this.style.getFeatureState(e):null}_updateContainerDimensions(){if(!this._container)return;const e=this._container.getBoundingClientRect().width||400,t=this._container.getBoundingClientRect().height||300;let n,r,o,s=this._container;for(;s&&(!r||!o);){const c=ft.getComputedStyle(s).transform;c&&"none"!==c&&(n=c.match(/matrix.*\((.+)\)/)[1].split(", "),n[0]&&"0"!==n[0]&&"1"!==n[0]&&(r=n[0]),n[3]&&"0"!==n[3]&&"1"!==n[3]&&(o=n[3])),s=s.parentElement}this._containerWidth=r?Math.abs(e/r):e,this._containerHeight=o?Math.abs(t/o):t}_detectMissingCSS(){"rgb(250, 128, 114)"!==ft.getComputedStyle(this._missingCSSCanary).getPropertyValue("background-color")&&nt("This page appears to be missing CSS declarations for Mapbox GL JS, which may cause the map to display incorrectly. Please ensure your page includes mapbox-gl.css, as described in https://www.mapbox.com/mapbox-gl-js/api/.")}_setupContainer(){const e=this._container;e.classList.add("mapboxgl-map"),(this._missingCSSCanary=jn("div","mapboxgl-canary",e)).style.visibility="hidden",this._detectMissingCSS();const t=this._canvasContainer=jn("div","mapboxgl-canvas-container",e);this._canvas=jn("canvas","mapboxgl-canvas",t),this._interactive&&(t.classList.add("mapboxgl-interactive"),this._canvas.setAttribute("tabindex","0")),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region"),this._updateContainerDimensions(),this._resizeCanvas(this._containerWidth,this._containerHeight);const n=this._controlContainer=jn("div","mapboxgl-control-container",e),r=this._controlPositions={};["top-left","top-right","bottom-left","bottom-right"].forEach(o=>{r[o]=jn("div",`mapboxgl-ctrl-${o}`,n)}),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(e,t){const n=De.devicePixelRatio||1;this._canvas.width=n*Math.ceil(e),this._canvas.height=n*Math.ceil(t),this._canvas.style.width=`${e}px`,this._canvas.style.height=`${t}px`}_addMarker(e){this._markers.push(e)}_removeMarker(e){const t=this._markers.indexOf(e);-1!==t&&this._markers.splice(t,1)}_addPopup(e){this._popups.push(e)}_removePopup(e){const t=this._popups.indexOf(e);-1!==t&&this._popups.splice(t,1)}_setupPainter(){const e=Wt({},Jd.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),t=this._canvas.getContext("webgl2",e);t?(Kd(t,!0),this.painter=new hS(t,this._contextCreateOptions,this.transform),this.on("data",n=>{"source"===n.dataType&&this.painter.setTileLoadedFlag(!0)}),Pr.testSupport(t)):this.fire(new Tt(new Error("Failed to initialize WebGL")))}_contextLost(e){e.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new Mt("webglcontextlost",{originalEvent:e}))}_contextRestored(e){this._setupPainter(),this.resize(),this._update(),this.fire(new Mt("webglcontextrestored",{originalEvent:e}))}_onMapScroll(e){if(e.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}_update(e){return this.style?(this._styleDirty=this._styleDirty||e,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(e){return this._update(),this._renderTaskQueue.add(e)}_cancelRenderFrame(e){this._renderTaskQueue.remove(e)}_requestDomTask(e){!this.loaded()||this.loaded()&&!this.isMoving()?e():this._domRenderTaskQueue.add(e)}_render(e){let t;this.fire(new Mt("renderstart"));const n=this.painter.context.extTimerQuery,r=De.now(),o=this.painter.context.gl;if(this.listens("gpu-timing-frame")&&(t=o.createQuery(),o.beginQuery(n.TIME_ELAPSED_EXT,t)),this.painter.context.setDirty(),this.painter.setBaseState(),(this.isMoving()||this.isRotating()||this.isZooming())&&(this._interactionRange[0]=Math.min(this._interactionRange[0],ft.performance.now()),this._interactionRange[1]=Math.max(this._interactionRange[1],ft.performance.now())),this._renderTaskQueue.run(e),this._domRenderTaskQueue.run(e),this._removed)return;this._updateProjectionTransition();const s=this._isInitialLoad?0:this._fadeDuration;if(this.style&&this._styleDirty){this._styleDirty=!1;const d=this.transform.zoom,f=this.transform.pitch,m=De.now(),g=new ar(d,{now:m,fadeDuration:s,pitch:f,transition:this.style.transition});this.style.update(g)}this.style&&this.style.hasFogTransition()&&(this.style._markersNeedUpdate=!0,this._sourcesDirty=!0);let c=!1;if(this.style&&this._sourcesDirty?(this._sourcesDirty=!1,this.painter._updateFog(this.style),this._updateTerrain(),c=this._updateAverageElevation(r),this.style.updateSources(this.transform),this._forceMarkerAndPopupUpdate()):c=this._updateAverageElevation(r),this._placementDirty=this.style&&this.style._updatePlacement(this.painter.transform,this.showCollisionBoxes,s,this._crossSourceCollisions),this.style&&this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,wireframe:{terrain:this.showTerrainWireframe,layers2D:this.showLayers2DWireframe,layers3D:this.showLayers3DWireframe},showOverdrawInspector:this._showOverdrawInspector,showQueryGeometry:!!this._showQueryGeometry,showTileAABBs:this.showTileAABBs,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:s,isInitialLoad:this._isInitialLoad,showPadding:this.showPadding,gpuTiming:!!this.listens("gpu-timing-layer"),gpuTimingDeferredRender:!!this.listens("gpu-timing-deferred-render"),speedIndexTiming:this.speedIndexTiming}),this.fire(new Mt("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,this.fire(new Mt("load"))),this.style&&this.style.hasTransitions()&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),t){const d=De.now()-r;o.endQuery(n.TIME_ELAPSED_EXT),setTimeout(()=>{const f=o.getQueryParameter(t,o.QUERY_RESULT)/1e6;o.deleteQuery(t),this.fire(new Mt("gpu-timing-frame",{cpuTime:d,gpuTime:f})),ft.performance.mark("frame-gpu",{startTime:r,detail:{gpuTime:f}})},50)}if(this.listens("gpu-timing-layer")){const d=this.painter.collectGpuTimers();setTimeout(()=>{const f=this.painter.queryGpuTimers(d);this.fire(new Mt("gpu-timing-layer",{layerTimes:f}))},50)}if(this.listens("gpu-timing-deferred-render")){const d=this.painter.collectDeferredRenderGpuQueries();setTimeout(()=>{const f=this.painter.queryGpuTimeDeferredRender(d);this.fire(new Mt("gpu-timing-deferred-render",{gpuTime:f}))},50)}const u=this._sourcesDirty||this._styleDirty||this._placementDirty||c;if(u||this._repaint)this.triggerRepaint();else{const d=!this.isMoving()&&this.loaded();if(d&&(c=this._updateAverageElevation(r,!0)),c)this.triggerRepaint();else if(this._triggerFrame(!1),d&&(this.fire(new Mt("idle")),this._isInitialLoad=!1,this.speedIndexTiming)){const f=this._calculateSpeedIndex();this.fire(new Mt("speedindexcompleted",{speedIndex:f})),this.speedIndexTiming=!1}}!this._loaded||this._fullyLoaded||u||(this._fullyLoaded=!0,No.mark(Fo.fullLoad),this._performanceMetricsCollection&&Yd(this._requestManager._customAccessToken,{width:this.painter.width,height:this.painter.height,interactionRange:this._interactionRange,visibilityHidden:this._visibilityHidden,terrainEnabled:!!this.painter.style.getTerrain(),fogEnabled:!!this.painter.style.getFog(),projection:this.getProjection().name,zoom:this.transform.zoom,renderer:this.painter.context.renderer,vendor:this.painter.context.vendor}),this._authenticate())}_forceMarkerAndPopupUpdate(e){for(const t of this._markers)e&&!this.getRenderWorldCopies()&&(t._lngLat=t._lngLat.wrap()),t._update();for(const t of this._popups)!e||this.getRenderWorldCopies()||t._trackPointer||(t._lngLat=t._lngLat.wrap()),t._update()}_updateAverageElevation(e,t=!1){const n=o=>(this.transform.averageElevation=o,this._update(!1),!0);if(!this.painter.averageElevationNeedsEasing())return 0!==this.transform.averageElevation&&n(0);const r=this.transform.elevation&&this.transform.elevation.exaggeration()!==this._averageElevationExaggeration;if(r||(t||e-this._averageElevationLastSampledAt>500)&&!this._averageElevation.isEasing(e)){const o=this.transform.averageElevation;let s=this.transform.sampleAverageElevation();this.transform.elevation&&(this._averageElevationExaggeration=this.transform.elevation.exaggeration()),isNaN(s)?s=0:this._averageElevationLastSampledAt=e;const c=Math.abs(o-s);if(c>1){if(this._isInitialLoad||r)return this._averageElevation.jumpTo(s),n(s);this._averageElevation.easeTo(s,e,300)}else if(c>1e-4)return this._averageElevation.jumpTo(s),n(s)}return!!this._averageElevation.isEasing(e)&&n(this._averageElevation.getValue(e))}_authenticate(){yi(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,e=>{if(e&&(e.message===wn||401===e.status)){const t=this.painter.context.gl;Kd(t,!1),this._logoControl instanceof lT&&this._logoControl._updateLogo(),t&&t.clear(t.DEPTH_BUFFER_BIT|t.COLOR_BUFFER_BIT|t.STENCIL_BUFFER_BIT),this._silenceAuthErrors||this.fire(new Tt(new Error("A valid Mapbox access token is required to use Mapbox GL JS. To create an account or a new access token, visit https://account.mapbox.com/")))}}),ex(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,()=>{})}_updateTerrain(){const e=this._isDragging();this.painter.updateTerrain(this.style,e)}_calculateSpeedIndex(){const e=this.painter.canvasCopy(),t=this.painter.getCanvasCopiesAndTimestamps();t.timeStamps.push(performance.now());const n=this.painter.context.gl,r=n.createFramebuffer();function o(s){n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,s,0);const c=new Uint8Array(n.drawingBufferWidth*n.drawingBufferHeight*4);return n.readPixels(0,0,n.drawingBufferWidth,n.drawingBufferHeight,n.RGBA,n.UNSIGNED_BYTE,c),c}return n.bindFramebuffer(n.FRAMEBUFFER,r),this._canvasPixelComparison(o(e),t.canvasCopies.map(o),t.timeStamps)}_canvasPixelComparison(e,t,n){let r=n[1]-n[0];const o=e.length/4;for(let s=0;s<t.length;s++){const c=t[s];let u=0;for(let d=0;d<c.length;d+=4)c[d]===e[d]&&c[d+1]===e[d+1]&&c[d+2]===e[d+2]&&c[d+3]===e[d+3]&&(u+=1);r+=(n[s+2]-n[s+1])*(1-u/o)}return r}remove(){this._hash&&this._hash.remove();for(const t of this._controls)t.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this._domRenderTaskQueue.clear(),this.style&&this.style.destroy(),this.painter.destroy(),this.handlers&&this.handlers.destroy(),this.handlers=void 0,this.setStyle(null),void 0!==ft&&(ft.removeEventListener("resize",this._onWindowResize,!1),ft.removeEventListener("orientationchange",this._onWindowResize,!1),ft.removeEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),ft.removeEventListener("online",this._onWindowOnline,!1),ft.removeEventListener("visibilitychange",this._onVisibilityChange,!1));const e=this.painter.context.gl.getExtension("WEBGL_lose_context");e&&e.loseContext(),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvasContainer.remove(),this._controlContainer.remove(),this._missingCSSCanary.remove(),this._canvas=void 0,this._canvasContainer=void 0,this._controlContainer=void 0,this._missingCSSCanary=void 0,this._container.classList.remove("mapboxgl-map"),this._container.removeEventListener("scroll",this._onMapScroll,!1),Yl.delete(this.painter.context.gl),this._removed=!0,this.fire(new Mt("remove"))}triggerRepaint(){this._triggerFrame(!0)}_triggerFrame(e){this._renderNextFrame=this._renderNextFrame||e,this.style&&!this._frame&&(this._frame=De.frame(t=>{const n=!!this._renderNextFrame;this._frame=null,this._renderNextFrame=null,n&&this._render(t)}))}_preloadTiles(e){return mo(this.style?Object.values(this.style._sourceCaches):[],(t,n)=>t._preloadTiles(e,n),()=>{this.triggerRepaint()}),this}_onWindowOnline(){this._update()}_onWindowResize(e){this._trackResize&&this.resize({originalEvent:e})._update()}_onVisibilityChange(){"hidden"===ft.document.visibilityState&&this._visibilityHidden++}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(e){this._showTileBoundaries!==e&&(this._showTileBoundaries=e,this._update())}get showTerrainWireframe(){return!!this._showTerrainWireframe}set showTerrainWireframe(e){this._showTerrainWireframe!==e&&(this._showTerrainWireframe=e,this._update())}get showLayers2DWireframe(){return!!this._showLayers2DWireframe}set showLayers2DWireframe(e){this._showLayers2DWireframe!==e&&(this._showLayers2DWireframe=e,this._update())}get showLayers3DWireframe(){return!!this._showLayers3DWireframe}set showLayers3DWireframe(e){this._showLayers3DWireframe!==e&&(this._showLayers3DWireframe=e,this._update())}get speedIndexTiming(){return!!this._speedIndexTiming}set speedIndexTiming(e){this._speedIndexTiming!==e&&(this._speedIndexTiming=e,this._update())}get showPadding(){return!!this._showPadding}set showPadding(e){this._showPadding!==e&&(this._showPadding=e,this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(e){this._showCollisionBoxes!==e&&(this._showCollisionBoxes=e,e?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(e){this._showOverdrawInspector!==e&&(this._showOverdrawInspector=e,this._update())}get repaint(){return!!this._repaint}set repaint(e){this._repaint!==e&&(this._repaint=e,this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(e){this._vertices=e,this._update()}get showTileAABBs(){return!!this._showTileAABBs}set showTileAABBs(e){this._showTileAABBs!==e&&(this._showTileAABBs=e,e&&this._update())}_setCacheLimits(e,t){Ii=e,ji=t}get version(){return po}},NavigationControl:class{constructor(e){this.options=Wt({},dT,e),this._container=jn("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",t=>t.preventDefault()),this.options.showZoom&&(ei(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("mapboxgl-ctrl-zoom-in",t=>{this._map&&this._map.zoomIn({},{originalEvent:t})}),jn("span","mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("mapboxgl-ctrl-zoom-out",t=>{this._map&&this._map.zoomOut({},{originalEvent:t})}),jn("span","mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(ei(["_rotateCompassArrow"],this),this._compass=this._createButton("mapboxgl-ctrl-compass",t=>{const n=this._map;n&&(this.options.visualizePitch?n.resetNorthPitch({},{originalEvent:t}):n.resetNorth({},{originalEvent:t}))}),this._compassIcon=jn("span","mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}_updateZoomButtons(){const e=this._map;if(!e)return;const t=e.getZoom(),n=t===e.getMaxZoom(),r=t===e.getMinZoom();this._zoomInButton.disabled=n,this._zoomOutButton.disabled=r,this._zoomInButton.setAttribute("aria-disabled",n.toString()),this._zoomOutButton.setAttribute("aria-disabled",r.toString())}_rotateCompassArrow(){const e=this._map;if(!e)return;const t=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(e.transform.pitch*(Math.PI/180)),.5)}) rotateX(${e.transform.pitch}deg) rotateZ(${e.transform.angle*(180/Math.PI)}deg)`:`rotate(${e.transform.angle*(180/Math.PI)}deg)`;e._requestDomTask(()=>{this._compassIcon&&(this._compassIcon.style.transform=t)})}onAdd(e){return this._map=e,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),e.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&e.on("pitch",this._rotateCompassArrow),e.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new Hv(e,this._compass,this.options.visualizePitch)),this._container}onRemove(){const e=this._map;e&&(this._container.remove(),this.options.showZoom&&e.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&e.off("pitch",this._rotateCompassArrow),e.off("rotate",this._rotateCompassArrow),this._handler&&this._handler.off(),this._handler=void 0),this._map=void 0)}_createButton(e,t){const n=jn("button",e,this._container);return n.type="button",n.addEventListener("click",t),n}_setButtonTitle(e,t){if(!this._map)return;const n=this._map._getUIString(`NavigationControl.${t}`);e.setAttribute("aria-label",n),e.firstElementChild&&e.firstElementChild.setAttribute("title",n)}},GeolocateControl:class extends ye{constructor(e){super(),this.options=Wt({geolocation:ft.navigator.geolocation},zS,e),ei(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker","_updateMarkerRotation","_onDeviceOrientation"],this),this._updateMarkerRotationThrottled=mS(this._updateMarkerRotation,20),this._numberOfWatches=0}onAdd(e){return this._map=e,this._container=jn("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkGeolocationSupport(this._setupUI),this._container}onRemove(){void 0!==this._geolocationWatchID&&(this.options.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),this._container.remove(),this._map.off("zoom",this._onZoom),this._map=void 0,this._numberOfWatches=0,this._noTimeout=!1}_checkGeolocationSupport(e){const t=(n=!!this.options.geolocation)=>{this._supportsGeolocation=n,e(n)};void 0!==this._supportsGeolocation?e(this._supportsGeolocation):void 0!==ft.navigator.permissions?ft.navigator.permissions.query({name:"geolocation"}).then(n=>t("denied"!==n.state)).catch(()=>t()):t()}_isOutOfMapMaxBounds(e){const t=this._map.getMaxBounds(),n=e.coords;return!!t&&(n.longitude<t.getWest()||n.longitude>t.getEast()||n.latitude<t.getSouth()||n.latitude>t.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting")}}_onSuccess(e){if(this._map){if(this._isOutOfMapMaxBounds(e))return this._setErrorState(),this.fire(new Mt("outofmaxbounds",e)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=e,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background")}this.options.showUserLocation&&"OFF"!==this._watchState&&this._updateMarker(e),this.options.trackUserLocation&&"ACTIVE_LOCK"!==this._watchState||this._updateCamera(e),this.options.showUserLocation&&this._userLocationDotMarker.removeClassName("mapboxgl-user-location-dot-stale"),this.fire(new Mt("geolocate",e)),this._finish()}}_updateCamera(e){const t=new Se(e.coords.longitude,e.coords.latitude),n=e.coords.accuracy,r=Wt({bearing:this._map.getBearing()},this.options.fitBoundsOptions);this._map.fitBounds(t.toBounds(n),r,{geolocateSource:!0})}_updateMarker(e){if(e){const t=new Se(e.coords.longitude,e.coords.latitude);this._accuracyCircleMarker.setLngLat(t).addTo(this._map),this._userLocationDotMarker.setLngLat(t).addTo(this._map),this._accuracy=e.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()}_updateCircleRadius(){const e=this._map.transform,t=Ln(1,e._center.lat)*e.worldSize,n=Math.ceil(2*this._accuracy*t);this._circleElement.style.width=`${n}px`,this._circleElement.style.height=`${n}px`}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}_updateMarkerRotation(){this._userLocationDotMarker&&"number"==typeof this._heading?(this._userLocationDotMarker.setRotation(this._heading),this._userLocationDotMarker.addClassName("mapboxgl-user-location-show-heading")):(this._userLocationDotMarker.removeClassName("mapboxgl-user-location-show-heading"),this._userLocationDotMarker.setRotation(0))}_onError(e){if(this._map){if(this.options.trackUserLocation)if(1===e.code){this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const t=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t),void 0!==this._geolocationWatchID&&this._clearWatch()}else{if(3===e.code&&this._noTimeout)return;this._setErrorState()}"OFF"!==this._watchState&&this.options.showUserLocation&&this._userLocationDotMarker.addClassName("mapboxgl-user-location-dot-stale"),this.fire(new Mt("error",e)),this._finish()}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0}_setupUI(e){if(void 0!==this._map){if(this._container.addEventListener("contextmenu",t=>t.preventDefault()),this._geolocateButton=jn("button","mapboxgl-ctrl-geolocate",this._container),jn("span","mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",!1===e){nt("Geolocation support is not available so the GeolocateControl will be disabled.");const t=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t)}else{const t=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=jn("div","mapboxgl-user-location"),this._dotElement.appendChild(jn("div","mapboxgl-user-location-dot")),this._dotElement.appendChild(jn("div","mapboxgl-user-location-heading")),this._userLocationDotMarker=new $v({element:this._dotElement,rotationAlignment:"map",pitchAlignment:"map"}),this._circleElement=jn("div","mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new $v({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",t=>{t.geolocateSource||"ACTIVE_LOCK"!==this._watchState||t.originalEvent&&"resize"===t.originalEvent.type||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this.fire(new Mt("trackuserlocationend")))})}}_onDeviceOrientation(e){this._userLocationDotMarker&&(e.webkitCompassHeading?this._heading=e.webkitCompassHeading:!0===e.absolute&&(this._heading=-1*e.alpha),this._updateMarkerRotationThrottled())}trigger(){if(!this._setup)return nt("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new Mt("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":this._numberOfWatches--,this._noTimeout=!1,this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this.fire(new Mt("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new Mt("trackuserlocationstart"))}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"BACKGROUND":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background");break;case"BACKGROUND_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error")}if("OFF"===this._watchState&&void 0!==this._geolocationWatchID)this._clearWatch();else if(void 0===this._geolocationWatchID){let e;this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),this._numberOfWatches++,this._numberOfWatches>1?(e={maximumAge:6e5,timeout:0},this._noTimeout=!0):(e=this.options.positionOptions,this._noTimeout=!1),this._geolocationWatchID=this.options.geolocation.watchPosition(this._onSuccess,this._onError,e),this.options.showUserHeading&&this._addDeviceOrientationListener()}}else this.options.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=setTimeout(this._finish,1e4);return!0}_addDeviceOrientationListener(){const e=()=>{ft.addEventListener("ondeviceorientationabsolute"in ft?"deviceorientationabsolute":"deviceorientation",this._onDeviceOrientation)};void 0!==ft.DeviceMotionEvent&&"function"==typeof ft.DeviceMotionEvent.requestPermission?DeviceOrientationEvent.requestPermission().then(t=>{"granted"===t&&e()}).catch(console.error):e()}_clearWatch(){this.options.geolocation.clearWatch(this._geolocationWatchID),ft.removeEventListener("deviceorientation",this._onDeviceOrientation),ft.removeEventListener("deviceorientationabsolute",this._onDeviceOrientation),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},AttributionControl:e_,ScaleControl:class{constructor(e){this.options=Wt({},BS,e),this._isNumberFormatSupported=function(){try{return new Intl.NumberFormat("en",{style:"unit",unitDisplay:"short",unit:"meter"}),!0}catch{return!1}}(),ei(["_update","_setScale","setUnit"],this)}getDefaultPosition(){return"bottom-left"}_update(){const e=this.options.maxWidth||100,t=this._map,n=t._containerHeight/2,r=t._containerWidth/2-e/2,o=t.unproject([r,n]),s=t.unproject([r+e,n]),c=o.distanceTo(s);if("imperial"===this.options.unit){const u=3.2808*c;u>5280?this._setScale(e,u/5280,"mile"):this._setScale(e,u,"foot")}else"nautical"===this.options.unit?this._setScale(e,c/1852,"nautical-mile"):c>=1e3?this._setScale(e,c/1e3,"kilometer"):this._setScale(e,c,"meter")}_setScale(e,t,n){this._map._requestDomTask(()=>{const r=function(s){const c=Math.pow(10,`${Math.floor(s)}`.length-1);let u=s/c;return u=u>=10?10:u>=5?5:u>=3?3:u>=2?2:u>=1?1:function(d){const f=Math.pow(10,Math.ceil(-Math.log(d)/Math.LN10));return Math.round(d*f)/f}(u),c*u}(t),o=r/t;this._container.innerHTML=this._isNumberFormatSupported&&"nautical-mile"!==n?new Intl.NumberFormat(this._language,{style:"unit",unitDisplay:"short",unit:n}).format(r):`${r}&nbsp;${fT[n]}`,this._container.style.width=e*o+"px"})}onAdd(e){return this._map=e,this._language=e.getLanguage(),this._container=jn("div","mapboxgl-ctrl mapboxgl-ctrl-scale",e.getContainer()),this._container.dir="auto",this._map.on("move",this._update),this._update(),this._container}onRemove(){this._container.remove(),this._map.off("move",this._update),this._map=void 0}_setLanguage(e){this._language=e,this._update()}setUnit(e){this.options.unit=e,this._update()}},FullscreenControl:class{constructor(e){this._fullscreen=!1,e&&e.container&&(e.container instanceof ft.HTMLElement?this._container=e.container:nt("Full screen control 'container' must be a DOM element.")),ei(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in ft.document?this._fullscreenchange="fullscreenchange":"onwebkitfullscreenchange"in ft.document&&(this._fullscreenchange="webkitfullscreenchange")}onAdd(e){return this._map=e,this._container||(this._container=this._map.getContainer()),this._controlContainer=jn("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",nt("This device does not support fullscreen mode.")),this._controlContainer}onRemove(){this._controlContainer.remove(),this._map=null,ft.document.removeEventListener(this._fullscreenchange,this._changeIcon)}_checkFullscreenSupport(){return!(!ft.document.fullscreenEnabled&&!ft.document.webkitFullscreenEnabled)}_setupUI(){const e=this._fullscreenButton=jn("button","mapboxgl-ctrl-fullscreen",this._controlContainer);jn("span","mapboxgl-ctrl-icon",e).setAttribute("aria-hidden","true"),e.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),ft.document.addEventListener(this._fullscreenchange,this._changeIcon)}_updateTitle(){const e=this._getTitle();this._fullscreenButton.setAttribute("aria-label",e),this._fullscreenButton.firstElementChild&&this._fullscreenButton.firstElementChild.setAttribute("title",e)}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_changeIcon(){(ft.document.fullscreenElement||ft.document.webkitFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle())}_onClickFullscreen(){this._isFullscreen()?ft.document.exitFullscreen?ft.document.exitFullscreen():ft.document.webkitCancelFullScreen&&ft.document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen()}},Popup:class extends ye{constructor(e){super(),this.options=Wt(Object.create(LS),e),ei(["_update","_onClose","remove","_onMouseEvent"],this),this._classList=new Set(e&&e.className?e.className.trim().split(/\s+/):[])}addTo(e){return this._map&&this.remove(),this._map=e,this.options.closeOnClick&&e.on("preclick",this._onClose),this.options.closeOnMove&&e.on("move",this._onClose),e.on("remove",this.remove),this._update(),e._addPopup(this),this._focusFirstElement(),this._trackPointer?(e.on("mousemove",this._onMouseEvent),e.on("mouseup",this._onMouseEvent),e._canvasContainer.classList.add("mapboxgl-track-pointer")):e.on("move",this._update),this.fire(new Mt("open")),this}isOpen(){return!!this._map}remove(){this._content&&this._content.remove(),this._container&&(this._container.remove(),this._container=void 0);const e=this._map;return e&&(e.off("move",this._update),e.off("move",this._onClose),e.off("preclick",this._onClose),e.off("click",this._onClose),e.off("remove",this.remove),e.off("mousemove",this._onMouseEvent),e.off("mouseup",this._onMouseEvent),e.off("drag",this._onMouseEvent),e._canvasContainer&&e._canvasContainer.classList.remove("mapboxgl-track-pointer"),e._removePopup(this),this._map=void 0),this.fire(new Mt("close")),this}getLngLat(){return this._lngLat}setLngLat(e){this._lngLat=Se.convert(e),this._pos=null,this._trackPointer=!1,this._update();const t=this._map;return t&&(t.on("move",this._update),t.off("mousemove",this._onMouseEvent),t._canvasContainer.classList.remove("mapboxgl-track-pointer")),this}trackPointer(){this._trackPointer=!0,this._pos=null,this._update();const e=this._map;return e&&(e.off("move",this._update),e.on("mousemove",this._onMouseEvent),e.on("drag",this._onMouseEvent),e._canvasContainer.classList.add("mapboxgl-track-pointer")),this}getElement(){return this._container}setText(e){return this.setDOMContent(ft.document.createTextNode(e))}setHTML(e){const t=ft.document.createDocumentFragment(),n=ft.document.createElement("body");let r;for(n.innerHTML=e;r=n.firstChild,r;)t.appendChild(r);return this.setDOMContent(t)}getMaxWidth(){return this._container&&this._container.style.maxWidth}setMaxWidth(e){return this.options.maxWidth=e,this._update(),this}setDOMContent(e){let t=this._content;if(t)for(;t.hasChildNodes();)t.firstChild&&t.removeChild(t.firstChild);else t=this._content=jn("div","mapboxgl-popup-content",this._container||void 0);if(t.appendChild(e),this.options.closeButton){const n=this._closeButton=jn("button","mapboxgl-popup-close-button",t);n.type="button",n.setAttribute("aria-label","Close popup"),n.setAttribute("aria-hidden","true"),n.innerHTML="&#215;",n.addEventListener("click",this._onClose)}return this._update(),this._focusFirstElement(),this}addClassName(e){return this._classList.add(e),this._updateClassList(),this}removeClassName(e){return this._classList.delete(e),this._updateClassList(),this}setOffset(e){return this.options.offset=e,this._update(),this}toggleClassName(e){let t;return this._classList.delete(e)?t=!1:(this._classList.add(e),t=!0),this._updateClassList(),t}_onMouseEvent(e){this._update(e.point)}_getAnchor(e){if(this.options.anchor)return this.options.anchor;const t=this._map,n=this._container,r=this._pos;if(!t||!n||!r)return"bottom";const o=n.offsetWidth,s=n.offsetHeight,c=r.x<o/2,u=r.x>t.transform.width-o/2;if(r.y+e<s)return c?"top-left":u?"top-right":"top";if(r.y>t.transform.height-s){if(c)return"bottom-left";if(u)return"bottom-right"}return c?"left":u?"right":"bottom"}_updateClassList(){const e=this._container;if(!e)return;const t=[...this._classList];t.push("mapboxgl-popup"),this._anchor&&t.push(`mapboxgl-popup-anchor-${this._anchor}`),this._trackPointer&&t.push("mapboxgl-popup-track-pointer"),e.className=t.join(" ")}_update(e){const t=this._map,n=this._content;if(!t||!this._lngLat&&!this._trackPointer||!n)return;let r=this._container;if(r||(r=this._container=jn("div","mapboxgl-popup",t.getContainer()),this._tip=jn("div","mapboxgl-popup-tip",r),r.appendChild(n)),this.options.maxWidth&&r.style.maxWidth!==this.options.maxWidth&&(r.style.maxWidth=this.options.maxWidth),t.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=uT(this._lngLat,this._pos,t.transform)),!this._trackPointer||e){const o=this._pos=this._trackPointer&&e?e:t.project(this._lngLat),s=hT(this.options.offset),c=this._anchor=this._getAnchor(s.y),u=hT(this.options.offset,c),d=o.add(u).round();t._requestDomTask(()=>{this._container&&c&&(this._container.style.transform=`${Gv[c]} translate(${d.x}px,${d.y}px)`)})}if(!this._marker&&t._showingGlobe()){const o=py(t.transform,this._lngLat)?0:1;this._setOpacity(o)}this._updateClassList()}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const e=this._container.querySelector(OS);e&&e.focus()}_onClose(){this.remove()}_setOpacity(e){this._container&&(this._container.style.opacity=`${e}`),this._content&&(this._content.style.pointerEvents=e?"auto":"none")}},Marker:$v,Style:ma,LngLat:Se,LngLatBounds:Oi,Point:it,MercatorCoordinate:Qe,FreeCameraOptions:nw,Evented:ye,config:Te,prewarm:function(){Nl().acquire(W0)},clearPrewarmedResources:function(){const e=Ep;e&&(e.isPreloaded()&&1===e.numActive()?(e.release(W0),Ep=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},get accessToken(){return Te.ACCESS_TOKEN},set accessToken(e){Te.ACCESS_TOKEN=e},get baseApiUrl(){return Te.API_URL},set baseApiUrl(e){Te.API_URL=e},get workerCount(){return Cd.workerCount},set workerCount(e){Cd.workerCount=e},get maxParallelImageRequests(){return Te.MAX_PARALLEL_IMAGE_REQUESTS},set maxParallelImageRequests(e){Te.MAX_PARALLEL_IMAGE_REQUESTS=e},clearStorage(e){!function(t){if(!ba())return;const n=ft.caches.delete(Nn);t&&n.catch(t).then(()=>t())}(e)},workerUrl:"",workerClass:null,get dracoUrl(){return Y0()},set dracoUrl(e){X0=De.resolveURL(e),Ad||(Ad=new xp(Nl(),new ye)),Ad.broadcast("setDracoUrl",X0)},setNow:De.setNow,restoreNow:De.restoreNow};se.A=aD,se.D=Dc,se.E=et,se.F=eg,se.K=zg,se.O=nn,se.P=it,se.T=fw,se.V=jy,se.a=Zh,se.b=Uy,se.c=Cg,se.d=class extends ye{constructor(e,t,n,r,o,s){super(),this.actor=e,this.layerIndex=t,this.availableImages=n,this.loadVectorData=o||q0,this.loading={},this.loaded={},this.deduped=new $w(e.scheduler),this.isSpriteLoaded=r,this.scheduler=e.scheduler,this.brightness=s}loadTile(e,t){const n=e.uid,r=e&&e.request,o=r&&r.collectResourceTiming,s=this.loading[n]=new Gw(e);s.abort=this.loadVectorData(e,(c,u)=>{const d=!this.loading[n];if(delete this.loading[n],d||c||!u)return s.status="done",d||(this.loaded[n]=s),t(c);const f=u.rawData,m={};u.expires&&(m.expires=u.expires),u.cacheControl&&(m.cacheControl=u.cacheControl),s.vectorTile=u.vectorTile||new By(new Qm(f));const g=()=>{s.parse(s.vectorTile,this.layerIndex,this.availableImages,this.actor,(y,v)=>{if(y||!v)return t(y);const x={};if(o){const w=Ta(r);w.length>0&&(x.resourceTiming=JSON.parse(JSON.stringify(w)))}t(null,Wt({rawTileData:f.slice(0)},v,m,x))})};this.isSpriteLoaded?g():this.once("isSpriteLoaded",()=>{this.scheduler?this.scheduler.add(g,{type:"parseTile",isSymbolTile:e.isSymbolTile,zoom:e.tileZoom}):g()}),this.loaded=this.loaded||{},this.loaded[n]=s})}reloadTile(e,t){const n=this.loaded,r=e.uid,o=this;if(n&&n[r]){const s=n[r];s.showCollisionBoxes=e.showCollisionBoxes,s.projection=e.projection,s.brightness=e.brightness,s.tileTransform=Pu(e.tileID.canonical,e.projection),s.extraShadowCaster=e.extraShadowCaster;const c=(u,d)=>{const f=s.reloadCallback;f&&(delete s.reloadCallback,s.parse(s.vectorTile,o.layerIndex,this.availableImages,o.actor,f)),t(u,d)};"parsing"===s.status?s.reloadCallback=c:"done"===s.status&&(s.vectorTile?s.parse(s.vectorTile,this.layerIndex,this.availableImages,this.actor,c):c())}else t(null,void 0)}abortTile(e,t){const n=e.uid,r=this.loading[n];r&&(r.abort&&r.abort(),delete this.loading[n]),t()}removeTile(e,t){const n=this.loaded,r=e.uid;n&&n[r]&&delete n[r],t()}},se.e=yl,se.f=Ta,se.g=rr,se.h=zt,se.i=$t,se.j=function(e,t){const n=qu(e);for(const r of n){for(const o of r.meshes)gD(o);r.lights&&(r.lightMeshIndex=r.meshes.length,r.meshes.push(_D(r.lights,t)))}return n},se.k=ar,se.l=function(e){let t=0;if(new Uint32Array(e,0,1)[0]!==Q0){const n=new Uint32Array(e,0,7),[,,r,o,s,c]=n;t=n.byteLength+o+s+c+s,(r!==e.byteLength||t>=e.byteLength)&&nt("Invalid b3dm header information.")}return Zw(e,t)},se.m=dg,se.n=bi,se.o=Mt,se.p=ya,se.q=function(e){di(),oi&&oi.then(t=>{t.keys().then(n=>{for(let r=0;r<n.length-e;r++)t.delete(n[r])})})},se.r=Rd,se.s=Fp,se.t=Uf,se.v=_i,se.w=ft}),Hl(0,function(se){function ft(St){if("number"==typeof St||"boolean"==typeof St||"string"==typeof St||null==St)return JSON.stringify(St);if(Array.isArray(St)){let X="[";for(const nt of St)X+=`${ft(nt)},`;return`${X}]`}let q="{";for(const X of Object.keys(St).sort())q+=`${X}:${ft(St[X])},`;return`${q}}`}function po(St){let q="";for(const X of se.r)q+=`/${ft(St[X])}`;return q}class Po{constructor(q){this.keyCache={},this._layers={},this._layerConfigs={},q&&this.replace(q)}replace(q,X){this._layerConfigs={},this._layers={},this.update(q,[],X)}update(q,X,nt){this._options=nt;for(const Lt of q){this._layerConfigs[Lt.id]=Lt;const Jt=this._layers[Lt.id]=se.c(Lt,this._options);Jt.setScope(this.scope),Jt.compileFilter(),this.keyCache[Lt.id]&&delete this.keyCache[Lt.id]}for(const Lt of X)delete this.keyCache[Lt],delete this._layerConfigs[Lt],delete this._layers[Lt];this.familiesBySource={};const At=function(Lt,Jt){const ae={};for(let pe=0;pe<Lt.length;pe++){const _e=Jt&&Jt[Lt[pe].id]||po(Lt[pe]);Jt&&(Jt[Lt[pe].id]=_e);let Ee=ae[_e];Ee||(Ee=ae[_e]=[]),Ee.push(Lt[pe])}const Pt=[];for(const pe in ae)Pt.push(ae[pe]);return Pt}(se.v(this._layerConfigs),this.keyCache);for(const Lt of At){const Jt=Lt.map(Cn=>this._layers[Cn.id]),ae=Jt[0];if("none"===ae.visibility)continue;const Pt=ae.source||"";let pe=this.familiesBySource[Pt];pe||(pe=this.familiesBySource[Pt]={});const _e=ae.sourceLayer||"_geojsonTileLayer";let Ee=pe[_e];Ee||(Ee=pe[_e]=[]),Ee.push(Jt)}}}class Te{loadTile(q,X){const{uid:nt,encoding:At,rawImageData:Lt,padding:Jt}=q,ae=se.w.ImageBitmap&&Lt instanceof se.w.ImageBitmap?this.getImageData(Lt,Jt):Lt;X(null,new se.D(nt,ae,At,Jt<1))}getImageData(q,X){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas(q.width,q.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d",{willReadFrequently:!0})),this.offscreenCanvas.width=q.width,this.offscreenCanvas.height=q.height,this.offscreenCanvasContext.drawImage(q,0,0,q.width,q.height);const nt=this.offscreenCanvasContext.getImageData(-X,-X,q.width+2*X,q.height+2*X);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),nt}}function Pr(St,q){if(0!==St.length){Hn(St[0],q);for(var X=1;X<St.length;X++)Hn(St[X],!q)}}function Hn(St,q){for(var X=0,nt=0,At=0,Lt=St.length,Jt=Lt-1;At<Lt;Jt=At++){var ae=(St[At][0]-St[Jt][0])*(St[Jt][1]+St[At][1]),Pt=X+ae;nt+=Math.abs(X)>=Math.abs(ae)?X-Pt+ae:ae-Pt+X,X=Pt}X+nt>=0!=!!q&&St.reverse()}var Zr=se.g(function St(q,X){var nt,At=q&&q.type;if("FeatureCollection"===At)for(nt=0;nt<q.features.length;nt++)St(q.features[nt],X);else if("GeometryCollection"===At)for(nt=0;nt<q.geometries.length;nt++)St(q.geometries[nt],X);else if("Feature"===At)St(q.geometry,X);else if("Polygon"===At)Pr(q.coordinates,X);else if("MultiPolygon"===At)for(nt=0;nt<q.coordinates.length;nt++)Pr(q.coordinates[nt],X);return q});const Pe=se.V.prototype.toGeoJSON;var pn={exports:{}},Bi=se.p,il=se.a.VectorTileFeature,rr=dr;function dr(St,q){this.options=q||{},this.features=St,this.length=St.length}function ss(St,q){this.id="number"==typeof St.id?St.id:void 0,this.type=St.type,this.rawGeometry=1===St.type?[St.geometry]:St.geometry,this.properties=St.tags,this.extent=q||4096}dr.prototype.feature=function(St){return new ss(this.features[St],this.options.extent)},ss.prototype.loadGeometry=function(){var St=this.rawGeometry;this.geometry=[];for(var q=0;q<St.length;q++){for(var X=St[q],nt=[],At=0;At<X.length;At++)nt.push(new Bi(X[At][0],X[At][1]));this.geometry.push(nt)}return this.geometry},ss.prototype.bbox=function(){this.geometry||this.loadGeometry();for(var St=this.geometry,q=1/0,X=-1/0,nt=1/0,At=-1/0,Lt=0;Lt<St.length;Lt++)for(var Jt=St[Lt],ae=0;ae<Jt.length;ae++){var Pt=Jt[ae];q=Math.min(q,Pt.x),X=Math.max(X,Pt.x),nt=Math.min(nt,Pt.y),At=Math.max(At,Pt.y)}return[q,nt,X,At]},ss.prototype.toGeoJSON=il.prototype.toGeoJSON;var ql=se.b,ya=rr;function as(St){var q=new ql;return function(X,nt){for(var At in X.layers)nt.writeMessage(3,it,X.layers[At])}(St,q),q.finish()}function it(St,q){var X;q.writeVarintField(15,St.version||1),q.writeStringField(1,St.name||""),q.writeVarintField(5,St.extent||4096);var nt={keys:[],values:[],keycache:{},valuecache:{}};for(X=0;X<St.length;X++)nt.feature=St.feature(X),q.writeMessage(2,tn,nt);var At=nt.keys;for(X=0;X<At.length;X++)q.writeStringField(3,At[X]);var Lt=nt.values;for(X=0;X<Lt.length;X++)q.writeMessage(4,nh,Lt[X])}function tn(St,q){var X=St.feature;void 0!==X.id&&q.writeVarintField(1,X.id),q.writeMessage(2,va,St),q.writeVarintField(3,X.type),q.writeMessage(4,fr,X)}function va(St,q){var X=St.feature,nt=St.keys,At=St.values,Lt=St.keycache,Jt=St.valuecache;for(var ae in X.properties){var Pt=X.properties[ae],pe=Lt[ae];if(null!==Pt){void 0===pe&&(nt.push(ae),Lt[ae]=pe=nt.length-1),q.writeVarint(pe);var _e=typeof Pt;"string"!==_e&&"boolean"!==_e&&"number"!==_e&&(Pt=JSON.stringify(Pt));var Ee=_e+":"+Pt,Cn=Jt[Ee];void 0===Cn&&(At.push(Pt),Jt[Ee]=Cn=At.length-1),q.writeVarint(Cn)}}}function ti(St,q){return(q<<3)+(7&St)}function Oe(St){return St<<1^St>>31}function fr(St,q){for(var X=St.loadGeometry(),nt=St.type,At=0,Lt=0,Jt=X.length,ae=0;ae<Jt;ae++){var Pt=X[ae],pe=1;1===nt&&(pe=Pt.length),q.writeVarint(ti(1,pe));for(var _e=3===nt?Pt.length-1:Pt.length,Ee=0;Ee<_e;Ee++){1===Ee&&1!==nt&&q.writeVarint(ti(2,_e-1));var Cn=Pt[Ee].x-At,nr=Pt[Ee].y-Lt;q.writeVarint(Oe(Cn)),q.writeVarint(Oe(nr)),At+=Cn,Lt+=nr}3===nt&&q.writeVarint(ti(7,1))}}function nh(St,q){var X=typeof St;"string"===X?q.writeStringField(1,St):"boolean"===X?q.writeBooleanField(7,St):"number"===X&&(St%1!=0?q.writeDoubleField(3,St):St<0?q.writeSVarintField(6,St):q.writeVarintField(5,St))}pn.exports=as,pn.exports.fromVectorTileJs=as,pn.exports.fromGeojsonVt=function(St,q){q=q||{};var X={};for(var nt in St)X[nt]=new ya(St[nt].features,q),X[nt].name=nt,X[nt].version=q.version,X[nt].extent=q.extent;return as({layers:X})},pn.exports.GeoJSONWrapper=ya;var ls=se.g(pn.exports);const ol={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:St=>St},xa=Math.fround||(Ds=new Float32Array(1),St=>(Ds[0]=+St,Ds[0]));var Ds;const Tr=3,ne=5,Ro=6;class Rr{constructor(q){this.options=Object.assign(Object.create(ol),q),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(q){const{log:X,minZoom:nt,maxZoom:At}=this.options;X&&console.time("total time");const Lt=`prepare ${q.length} points`;X&&console.time(Lt),this.points=q;const Jt=[];for(let Pt=0;Pt<q.length;Pt++){const pe=q[Pt];if(!pe.geometry)continue;const[_e,Ee]=pe.geometry.coordinates,Cn=xa(Wt(_e)),nr=xa(to(Ee));Jt.push(Cn,nr,1/0,Pt,-1,1),this.options.reduce&&Jt.push(0)}let ae=this.trees[At+1]=this._createTree(Jt);X&&console.timeEnd(Lt);for(let Pt=At;Pt>=nt;Pt--){const pe=+Date.now();ae=this.trees[Pt]=this._createTree(this._cluster(ae,Pt)),X&&console.log("z%d: %d clusters in %dms",Pt,ae.numItems,+Date.now()-pe)}return X&&console.timeEnd("total time"),this}getClusters(q,X){let nt=((q[0]+180)%360+360)%360-180;const At=Math.max(-90,Math.min(90,q[1]));let Lt=180===q[2]?180:((q[2]+180)%360+360)%360-180;const Jt=Math.max(-90,Math.min(90,q[3]));if(q[2]-q[0]>=360)nt=-180,Lt=180;else if(nt>Lt){const Ee=this.getClusters([nt,At,180,Jt],X),Cn=this.getClusters([-180,At,Lt,Jt],X);return Ee.concat(Cn)}const ae=this.trees[this._limitZoom(X)],Pt=ae.range(Wt(nt),to(Jt),Wt(Lt),to(At)),pe=ae.data,_e=[];for(const Ee of Pt){const Cn=this.stride*Ee;_e.push(pe[Cn+ne]>1?mo(pe,Cn,this.clusterProps):this.points[pe[Cn+Tr]])}return _e}getChildren(q){const X=this._getOriginId(q),nt=this._getOriginZoom(q),At="No cluster with the specified id.",Lt=this.trees[nt];if(!Lt)throw new Error(At);const Jt=Lt.data;if(X*this.stride>=Jt.length)throw new Error(At);const ae=this.options.radius/(this.options.extent*Math.pow(2,nt-1)),Pt=Lt.within(Jt[X*this.stride],Jt[X*this.stride+1],ae),pe=[];for(const _e of Pt){const Ee=_e*this.stride;Jt[Ee+4]===q&&pe.push(Jt[Ee+ne]>1?mo(Jt,Ee,this.clusterProps):this.points[Jt[Ee+Tr]])}if(0===pe.length)throw new Error(At);return pe}getLeaves(q,X,nt){const At=[];return this._appendLeaves(At,q,X=X||10,nt=nt||0,0),At}getTile(q,X,nt){const At=this.trees[this._limitZoom(q)],Lt=Math.pow(2,q),{extent:Jt,radius:ae}=this.options,Pt=ae/Jt,pe=(nt-Pt)/Lt,_e=(nt+1+Pt)/Lt,Ee={features:[]};return this._addTileFeatures(At.range((X-Pt)/Lt,pe,(X+1+Pt)/Lt,_e),At.data,X,nt,Lt,Ee),0===X&&this._addTileFeatures(At.range(1-Pt/Lt,pe,1,_e),At.data,Lt,nt,Lt,Ee),X===Lt-1&&this._addTileFeatures(At.range(0,pe,Pt/Lt,_e),At.data,-1,nt,Lt,Ee),Ee.features.length?Ee:null}getClusterExpansionZoom(q){let X=this._getOriginZoom(q)-1;for(;X<=this.options.maxZoom;){const nt=this.getChildren(q);if(X++,1!==nt.length)break;q=nt[0].properties.cluster_id}return X}_appendLeaves(q,X,nt,At,Lt){const Jt=this.getChildren(X);for(const ae of Jt){const Pt=ae.properties;if(Pt&&Pt.cluster?Lt+Pt.point_count<=At?Lt+=Pt.point_count:Lt=this._appendLeaves(q,Pt.cluster_id,nt,At,Lt):Lt<At?Lt++:q.push(ae),q.length===nt)break}return Lt}_createTree(q){const X=new se.K(q.length/this.stride|0,this.options.nodeSize,Float32Array);for(let nt=0;nt<q.length;nt+=this.stride)X.add(q[nt],q[nt+1]);return X.finish(),X.data=q,X}_addTileFeatures(q,X,nt,At,Lt,Jt){for(const ae of q){const Pt=ae*this.stride,pe=X[Pt+ne]>1;let _e,Ee,Cn;if(pe)_e=_i(X,Pt,this.clusterProps),Ee=X[Pt],Cn=X[Pt+1];else{const Jn=this.points[X[Pt+Tr]];_e=Jn.properties;const[Fn,Nn]=Jn.geometry.coordinates;Ee=Wt(Fn),Cn=to(Nn)}const nr={type:1,geometry:[[Math.round(this.options.extent*(Ee*Lt-nt)),Math.round(this.options.extent*(Cn*Lt-At))]],tags:_e};let Lr;Lr=pe||this.options.generateId?X[Pt+Tr]:this.points[X[Pt+Tr]].id,void 0!==Lr&&(nr.id=Lr),Jt.features.push(nr)}}_limitZoom(q){return Math.max(this.options.minZoom,Math.min(Math.floor(+q),this.options.maxZoom+1))}_cluster(q,X){const{radius:nt,extent:At,reduce:Lt,minPoints:Jt}=this.options,ae=nt/(At*Math.pow(2,X)),Pt=q.data,pe=[],_e=this.stride;for(let Ee=0;Ee<Pt.length;Ee+=_e){if(Pt[Ee+2]<=X)continue;Pt[Ee+2]=X;const Cn=Pt[Ee],nr=Pt[Ee+1],Lr=q.within(Pt[Ee],Pt[Ee+1],ae),Jn=Pt[Ee+ne];let Fn=Jn;for(const Nn of Lr){const Ii=Nn*_e;Pt[Ii+2]>X&&(Fn+=Pt[Ii+ne])}if(Fn>Jn&&Fn>=Jt){let Nn,Ii=Cn*Jn,ji=nr*Jn,oi=-1;const cs=((Ee/_e|0)<<5)+(X+1)+this.points.length;for(const ba of Lr){const di=ba*_e;if(Pt[di+2]<=X)continue;Pt[di+2]=X;const Ss=Pt[di+ne];Ii+=Pt[di]*Ss,ji+=Pt[di+1]*Ss,Pt[di+4]=cs,Lt&&(Nn||(Nn=this._map(Pt,Ee,!0),oi=this.clusterProps.length,this.clusterProps.push(Nn)),Lt(Nn,this._map(Pt,di)))}Pt[Ee+4]=cs,pe.push(Ii/Fn,ji/Fn,1/0,cs,-1,Fn),Lt&&pe.push(oi)}else{for(let Nn=0;Nn<_e;Nn++)pe.push(Pt[Ee+Nn]);if(Fn>1)for(const Nn of Lr){const Ii=Nn*_e;if(!(Pt[Ii+2]<=X)){Pt[Ii+2]=X;for(let ji=0;ji<_e;ji++)pe.push(Pt[Ii+ji])}}}}return pe}_getOriginId(q){return q-this.points.length>>5}_getOriginZoom(q){return(q-this.points.length)%32}_map(q,X,nt){if(q[X+ne]>1){const Jt=this.clusterProps[q[X+Ro]];return nt?Object.assign({},Jt):Jt}const At=this.points[q[X+Tr]].properties,Lt=this.options.map(At);return nt&&Lt===At?Object.assign({},Lt):Lt}}function mo(St,q,X){return{type:"Feature",id:St[q+Tr],properties:_i(St,q,X),geometry:{type:"Point",coordinates:[(nt=St[q],360*(nt-.5)),Lo(St[q+1])]}};var nt}function _i(St,q,X){const nt=St[q+ne],At=nt>=1e4?`${Math.round(nt/1e3)}k`:nt>=1e3?Math.round(nt/100)/10+"k":nt,Lt=St[q+Ro],Jt=-1===Lt?{}:Object.assign({},X[Lt]);return Object.assign(Jt,{cluster:!0,cluster_id:St[q+Tr],point_count:nt,point_count_abbreviated:At})}function Wt(St){return St/360+.5}function to(St){const q=Math.sin(St*Math.PI/180),X=.5-.25*Math.log((1+q)/(1-q))/Math.PI;return X<0?0:X>1?1:X}function Lo(St){const q=(180-360*St)*Math.PI/180;return 360*Math.atan(Math.exp(q))/Math.PI-90}var Dr={exports:{}};Dr.exports=function(){function St(yt,It,kt,jt){for(var zt,$t=jt,Zt=kt-It>>1,Vt=kt-It,ee=yt[It],Ht=yt[It+1],xe=yt[kt],wn=yt[kt+1],ge=It+3;ge<kt;ge+=3){var mn=q(yt[ge],yt[ge+1],ee,Ht,xe,wn);if(mn>$t)zt=ge,$t=mn;else if(mn===$t){var vn=Math.abs(ge-Zt);vn<Vt&&(zt=ge,Vt=vn)}}$t>jt&&(zt-It>3&&St(yt,It,zt,jt),yt[zt+2]=$t,kt-zt>3&&St(yt,zt,kt,jt))}function q(yt,It,kt,jt,zt,$t){var Zt=zt-kt,Vt=$t-jt;if(0!==Zt||0!==Vt){var ee=((yt-kt)*Zt+(It-jt)*Vt)/(Zt*Zt+Vt*Vt);ee>1?(kt=zt,jt=$t):ee>0&&(kt+=Zt*ee,jt+=Vt*ee)}return(Zt=yt-kt)*Zt+(Vt=It-jt)*Vt}function X(yt,It,kt,jt){var zt={id:void 0===yt?null:yt,type:It,geometry:kt,tags:jt,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};return function($t){var Zt=$t.geometry,Vt=$t.type;if("Point"===Vt||"MultiPoint"===Vt||"LineString"===Vt)nt($t,Zt);else if("Polygon"===Vt||"MultiLineString"===Vt)for(var ee=0;ee<Zt.length;ee++)nt($t,Zt[ee]);else if("MultiPolygon"===Vt)for(ee=0;ee<Zt.length;ee++)for(var Ht=0;Ht<Zt[ee].length;Ht++)nt($t,Zt[ee][Ht])}(zt),zt}function nt(yt,It){for(var kt=0;kt<It.length;kt+=3)yt.minX=Math.min(yt.minX,It[kt]),yt.minY=Math.min(yt.minY,It[kt+1]),yt.maxX=Math.max(yt.maxX,It[kt]),yt.maxY=Math.max(yt.maxY,It[kt+1])}function At(yt,It,kt,jt){if(It.geometry){var zt=It.geometry.coordinates,$t=It.geometry.type,Zt=Math.pow(kt.tolerance/((1<<kt.maxZoom)*kt.extent),2),Vt=[],ee=It.id;if(kt.promoteId?ee=It.properties[kt.promoteId]:kt.generateId&&(ee=jt||0),"Point"===$t)Lt(zt,Vt);else if("MultiPoint"===$t)for(var Ht=0;Ht<zt.length;Ht++)Lt(zt[Ht],Vt);else if("LineString"===$t)Jt(zt,Vt,Zt,!1);else if("MultiLineString"===$t){if(kt.lineMetrics){for(Ht=0;Ht<zt.length;Ht++)Jt(zt[Ht],Vt=[],Zt,!1),yt.push(X(ee,"LineString",Vt,It.properties));return}ae(zt,Vt,Zt,!1)}else if("Polygon"===$t)ae(zt,Vt,Zt,!0);else{if("MultiPolygon"!==$t){if("GeometryCollection"===$t){for(Ht=0;Ht<It.geometry.geometries.length;Ht++)At(yt,{id:ee,geometry:It.geometry.geometries[Ht],properties:It.properties},kt,jt);return}throw new Error("Input data is not a valid GeoJSON object.")}for(Ht=0;Ht<zt.length;Ht++){var xe=[];ae(zt[Ht],xe,Zt,!0),Vt.push(xe)}}yt.push(X(ee,$t,Vt,It.properties))}}function Lt(yt,It){It.push(Pt(yt[0])),It.push(pe(yt[1])),It.push(0)}function Jt(yt,It,kt,jt){for(var zt,$t,Zt=0,Vt=0;Vt<yt.length;Vt++){var ee=Pt(yt[Vt][0]),Ht=pe(yt[Vt][1]);It.push(ee),It.push(Ht),It.push(0),Vt>0&&(Zt+=jt?(zt*Ht-ee*$t)/2:Math.sqrt(Math.pow(ee-zt,2)+Math.pow(Ht-$t,2))),zt=ee,$t=Ht}var xe=It.length-3;It[2]=1,St(It,0,xe,kt),It[xe+2]=1,It.size=Math.abs(Zt),It.start=0,It.end=It.size}function ae(yt,It,kt,jt){for(var zt=0;zt<yt.length;zt++){var $t=[];Jt(yt[zt],$t,kt,jt),It.push($t)}}function Pt(yt){return yt/360+.5}function pe(yt){var It=Math.sin(yt*Math.PI/180),kt=.5-.25*Math.log((1+It)/(1-It))/Math.PI;return kt<0?0:kt>1?1:kt}function _e(yt,It,kt,jt,zt,$t,Zt,Vt){if(jt/=It,$t>=(kt/=It)&&Zt<jt)return yt;if(Zt<kt||$t>=jt)return null;for(var ee=[],Ht=0;Ht<yt.length;Ht++){var xe=yt[Ht],wn=xe.geometry,ge=xe.type,mn=0===zt?xe.minX:xe.minY,vn=0===zt?xe.maxX:xe.maxY;if(mn>=kt&&vn<jt)ee.push(xe);else if(!(vn<kt||mn>=jt)){var pr=[];if("Point"===ge||"MultiPoint"===ge)Ee(wn,pr,kt,jt,zt);else if("LineString"===ge)Cn(wn,pr,kt,jt,zt,!1,Vt.lineMetrics);else if("MultiLineString"===ge)Lr(wn,pr,kt,jt,zt,!1);else if("Polygon"===ge)Lr(wn,pr,kt,jt,zt,!0);else if("MultiPolygon"===ge)for(var Mr=0;Mr<wn.length;Mr++){var si=[];Lr(wn[Mr],si,kt,jt,zt,!0),si.length&&pr.push(si)}if(pr.length){if(Vt.lineMetrics&&"LineString"===ge){for(Mr=0;Mr<pr.length;Mr++)ee.push(X(xe.id,ge,pr[Mr],xe.tags));continue}"LineString"!==ge&&"MultiLineString"!==ge||(1===pr.length?(ge="LineString",pr=pr[0]):ge="MultiLineString"),"Point"!==ge&&"MultiPoint"!==ge||(ge=3===pr.length?"Point":"MultiPoint"),ee.push(X(xe.id,ge,pr,xe.tags))}}}return ee.length?ee:null}function Ee(yt,It,kt,jt,zt){for(var $t=0;$t<yt.length;$t+=3){var Zt=yt[$t+zt];Zt>=kt&&Zt<=jt&&(It.push(yt[$t]),It.push(yt[$t+1]),It.push(yt[$t+2]))}}function Cn(yt,It,kt,jt,zt,$t,Zt){for(var Vt,ee,Ht=nr(yt),xe=0===zt?Fn:Nn,wn=yt.start,ge=0;ge<yt.length-3;ge+=3){var mn=yt[ge],vn=yt[ge+1],pr=yt[ge+2],Mr=yt[ge+3],si=yt[ge+4],ko=0===zt?mn:vn,Wr=0===zt?Mr:si,ir=!1;Zt&&(Vt=Math.sqrt(Math.pow(mn-Mr,2)+Math.pow(vn-si,2))),ko<kt?Wr>kt&&(ee=xe(Ht,mn,vn,Mr,si,kt),Zt&&(Ht.start=wn+Vt*ee)):ko>jt?Wr<jt&&(ee=xe(Ht,mn,vn,Mr,si,jt),Zt&&(Ht.start=wn+Vt*ee)):Jn(Ht,mn,vn,pr),Wr<kt&&ko>=kt&&(ee=xe(Ht,mn,vn,Mr,si,kt),ir=!0),Wr>jt&&ko<=jt&&(ee=xe(Ht,mn,vn,Mr,si,jt),ir=!0),!$t&&ir&&(Zt&&(Ht.end=wn+Vt*ee),It.push(Ht),Ht=nr(yt)),Zt&&(wn+=Vt)}var Di=yt.length-3;mn=yt[Di],vn=yt[Di+1],pr=yt[Di+2],(ko=0===zt?mn:vn)>=kt&&ko<=jt&&Jn(Ht,mn,vn,pr),Di=Ht.length-3,$t&&Di>=3&&(Ht[Di]!==Ht[0]||Ht[Di+1]!==Ht[1])&&Jn(Ht,Ht[0],Ht[1],Ht[2]),Ht.length&&It.push(Ht)}function nr(yt){var It=[];return It.size=yt.size,It.start=yt.start,It.end=yt.end,It}function Lr(yt,It,kt,jt,zt,$t){for(var Zt=0;Zt<yt.length;Zt++)Cn(yt[Zt],It,kt,jt,zt,$t,!1)}function Jn(yt,It,kt,jt){yt.push(It),yt.push(kt),yt.push(jt)}function Fn(yt,It,kt,jt,zt,$t){var Zt=($t-It)/(jt-It);return yt.push($t),yt.push(kt+(zt-kt)*Zt),yt.push(1),Zt}function Nn(yt,It,kt,jt,zt,$t){var Zt=($t-kt)/(zt-kt);return yt.push(It+(jt-It)*Zt),yt.push($t),yt.push(1),Zt}function Ii(yt,It){for(var kt=[],jt=0;jt<yt.length;jt++){var zt,$t=yt[jt],Zt=$t.type;if("Point"===Zt||"MultiPoint"===Zt||"LineString"===Zt)zt=ji($t.geometry,It);else if("MultiLineString"===Zt||"Polygon"===Zt){zt=[];for(var Vt=0;Vt<$t.geometry.length;Vt++)zt.push(ji($t.geometry[Vt],It))}else if("MultiPolygon"===Zt)for(zt=[],Vt=0;Vt<$t.geometry.length;Vt++){for(var ee=[],Ht=0;Ht<$t.geometry[Vt].length;Ht++)ee.push(ji($t.geometry[Vt][Ht],It));zt.push(ee)}kt.push(X($t.id,Zt,zt,$t.tags))}return kt}function ji(yt,It){var kt=[];kt.size=yt.size,void 0!==yt.start&&(kt.start=yt.start,kt.end=yt.end);for(var jt=0;jt<yt.length;jt+=3)kt.push(yt[jt]+It,yt[jt+1],yt[jt+2]);return kt}function oi(yt,It){if(yt.transformed)return yt;var kt,jt,zt,$t=1<<yt.z,Zt=yt.x,Vt=yt.y;for(kt=0;kt<yt.features.length;kt++){var ee=yt.features[kt],Ht=ee.geometry,xe=ee.type;if(ee.geometry=[],1===xe)for(jt=0;jt<Ht.length;jt+=2)ee.geometry.push(cs(Ht[jt],Ht[jt+1],It,$t,Zt,Vt));else for(jt=0;jt<Ht.length;jt++){var wn=[];for(zt=0;zt<Ht[jt].length;zt+=2)wn.push(cs(Ht[jt][zt],Ht[jt][zt+1],It,$t,Zt,Vt));ee.geometry.push(wn)}}return yt.transformed=!0,yt}function cs(yt,It,kt,jt,zt,$t){return[Math.round(kt*(yt*jt-zt)),Math.round(kt*(It*jt-$t))]}function ba(yt,It,kt,jt,zt){for(var $t=It===zt.maxZoom?0:zt.tolerance/((1<<It)*zt.extent),Zt={features:[],numPoints:0,numSimplified:0,numFeatures:0,source:null,x:kt,y:jt,z:It,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0},Vt=0;Vt<yt.length;Vt++){Zt.numFeatures++,di(Zt,yt[Vt],$t,zt);var ee=yt[Vt].minX,Ht=yt[Vt].minY,xe=yt[Vt].maxX,wn=yt[Vt].maxY;ee<Zt.minX&&(Zt.minX=ee),Ht<Zt.minY&&(Zt.minY=Ht),xe>Zt.maxX&&(Zt.maxX=xe),wn>Zt.maxY&&(Zt.maxY=wn)}return Zt}function di(yt,It,kt,jt){var zt=It.geometry,$t=It.type,Zt=[];if("Point"===$t||"MultiPoint"===$t)for(var Vt=0;Vt<zt.length;Vt+=3)Zt.push(zt[Vt]),Zt.push(zt[Vt+1]),yt.numPoints++,yt.numSimplified++;else if("LineString"===$t)Ss(Zt,zt,yt,kt,!1,!1);else if("MultiLineString"===$t||"Polygon"===$t)for(Vt=0;Vt<zt.length;Vt++)Ss(Zt,zt[Vt],yt,kt,"Polygon"===$t,0===Vt);else if("MultiPolygon"===$t)for(var ee=0;ee<zt.length;ee++){var Ht=zt[ee];for(Vt=0;Vt<Ht.length;Vt++)Ss(Zt,Ht[Vt],yt,kt,!0,0===Vt)}if(Zt.length){var xe=It.tags||null;if("LineString"===$t&&jt.lineMetrics){for(var wn in xe={},It.tags)xe[wn]=It.tags[wn];xe.mapbox_clip_start=zt.start/zt.size,xe.mapbox_clip_end=zt.end/zt.size}var ge={geometry:Zt,type:"Polygon"===$t||"MultiPolygon"===$t?3:"LineString"===$t||"MultiLineString"===$t?2:1,tags:xe};null!==It.id&&(ge.id=It.id),yt.features.push(ge)}}function Ss(yt,It,kt,jt,zt,$t){var Zt=jt*jt;if(jt>0&&It.size<(zt?Zt:jt))kt.numPoints+=It.length/3;else{for(var Vt=[],ee=0;ee<It.length;ee+=3)(0===jt||It[ee+2]>Zt)&&(kt.numSimplified++,Vt.push(It[ee]),Vt.push(It[ee+1])),kt.numPoints++;zt&&function(Ht,xe){for(var wn=0,ge=0,mn=Ht.length,vn=mn-2;ge<mn;vn=ge,ge+=2)wn+=(Ht[ge]-Ht[vn])*(Ht[ge+1]+Ht[vn+1]);if(wn>0===xe)for(ge=0,mn=Ht.length;ge<mn/2;ge+=2){var pr=Ht[ge],Mr=Ht[ge+1];Ht[ge]=Ht[mn-2-ge],Ht[ge+1]=Ht[mn-1-ge],Ht[mn-2-ge]=pr,Ht[mn-1-ge]=Mr}}(Vt,$t),yt.push(Vt)}}function us(yt,It){var kt=(It=this.options=function(zt,$t){for(var Zt in $t)zt[Zt]=$t[Zt];return zt}(Object.create(this.options),It)).debug;if(kt&&console.time("preprocess data"),It.maxZoom<0||It.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(It.promoteId&&It.generateId)throw new Error("promoteId and generateId cannot be used together.");var zt,$t,Zt,Vt,ee,Ht,jt=function(zt,$t){var Zt=[];if("FeatureCollection"===zt.type)for(var Vt=0;Vt<zt.features.length;Vt++)At(Zt,zt.features[Vt],$t,Vt);else At(Zt,"Feature"===zt.type?zt:{geometry:zt},$t);return Zt}(yt,It);this.tiles={},this.tileCoords=[],kt&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",It.indexMaxZoom,It.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),(zt=jt,$t=It,Zt=$t.buffer/$t.extent,Vt=zt,ee=_e(zt,1,-1-Zt,Zt,0,-1,2,$t),Ht=_e(zt,1,1-Zt,2+Zt,0,-1,2,$t),(ee||Ht)&&(Vt=_e(zt,1,-Zt,1+Zt,0,-1,2,$t)||[],ee&&(Vt=Ii(ee,1).concat(Vt)),Ht&&(Vt=Vt.concat(Ii(Ht,-1)))),jt=Vt).length&&this.splitTile(jt,0,0,0),kt&&(jt.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}function Vi(yt,It,kt){return 32*((1<<yt)*kt+It)+yt}return us.prototype.options={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0},us.prototype.splitTile=function(yt,It,kt,jt,zt,$t,Zt){for(var Vt=[yt,It,kt,jt],ee=this.options,Ht=ee.debug;Vt.length;){jt=Vt.pop(),kt=Vt.pop(),It=Vt.pop(),yt=Vt.pop();var xe=1<<It,wn=Vi(It,kt,jt),ge=this.tiles[wn];if(!ge&&(Ht>1&&console.time("creation"),ge=this.tiles[wn]=ba(yt,It,kt,jt,ee),this.tileCoords.push({z:It,x:kt,y:jt}),Ht)){Ht>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",It,kt,jt,ge.numFeatures,ge.numPoints,ge.numSimplified),console.timeEnd("creation"));var mn="z"+It;this.stats[mn]=(this.stats[mn]||0)+1,this.total++}if(ge.source=yt,zt){if(It===ee.maxZoom||It===zt)continue;var vn=1<<zt-It;if(kt!==Math.floor($t/vn)||jt!==Math.floor(Zt/vn))continue}else if(It===ee.indexMaxZoom||ge.numPoints<=ee.indexMaxPoints)continue;if(ge.source=null,0!==yt.length){Ht>1&&console.time("clipping");var pr,Mr,si,ko,Wr,ir,Di=.5*ee.buffer/ee.extent,go=.5-Di,wa=.5+Di,Ea=1+Di;pr=Mr=si=ko=null,Wr=_e(yt,xe,kt-Di,kt+wa,0,ge.minX,ge.maxX,ee),ir=_e(yt,xe,kt+go,kt+Ea,0,ge.minX,ge.maxX,ee),yt=null,Wr&&(pr=_e(Wr,xe,jt-Di,jt+wa,1,ge.minY,ge.maxY,ee),Mr=_e(Wr,xe,jt+go,jt+Ea,1,ge.minY,ge.maxY,ee),Wr=null),ir&&(si=_e(ir,xe,jt-Di,jt+wa,1,ge.minY,ge.maxY,ee),ko=_e(ir,xe,jt+go,jt+Ea,1,ge.minY,ge.maxY,ee),ir=null),Ht>1&&console.timeEnd("clipping"),Vt.push(pr||[],It+1,2*kt,2*jt),Vt.push(Mr||[],It+1,2*kt,2*jt+1),Vt.push(si||[],It+1,2*kt+1,2*jt),Vt.push(ko||[],It+1,2*kt+1,2*jt+1)}}},us.prototype.getTile=function(yt,It,kt){var jt=this.options,zt=jt.extent,$t=jt.debug;if(yt<0||yt>24)return null;var Zt=1<<yt,Vt=Vi(yt,It=(It%Zt+Zt)%Zt,kt);if(this.tiles[Vt])return oi(this.tiles[Vt],zt);$t>1&&console.log("drilling down to z%d-%d-%d",yt,It,kt);for(var ee,Ht=yt,xe=It,wn=kt;!ee&&Ht>0;)Ht--,xe=Math.floor(xe/2),wn=Math.floor(wn/2),ee=this.tiles[Vi(Ht,xe,wn)];return ee&&ee.source?($t>1&&console.log("found parent tile z%d-%d-%d",Ht,xe,wn),$t>1&&console.time("drilling down"),this.splitTile(ee.source,Ht,xe,wn,yt,It,kt),$t>1&&console.timeEnd("drilling down"),this.tiles[Vt]?oi(this.tiles[Vt],zt):null):null},function(yt,It){return new us(yt,It)}}();var _n=se.g(Dr.exports);function Fc(St,q){const X=St.tileID.canonical;if(!this._geoJSONIndex)return q(null,null);const nt=this._geoJSONIndex.getTile(X.z,X.x,X.y);if(!nt)return q(null,null);const At=new class{constructor(Jt){this.layers={_geojsonTileLayer:this},this.name="_geojsonTileLayer",this.extent=se.E,this.length=Jt.length,this._features=Jt}feature(Jt){return new class{constructor(ae){this._feature=ae,this.extent=se.E,this.type=ae.type,this.properties=ae.tags,"id"in ae&&!isNaN(ae.id)&&(this.id=parseInt(ae.id,10))}loadGeometry(){if(1===this._feature.type){const ae=[];for(const Pt of this._feature.geometry)ae.push([new se.P(Pt[0],Pt[1])]);return ae}{const ae=[];for(const Pt of this._feature.geometry){const pe=[];for(const _e of Pt)pe.push(new se.P(_e[0],_e[1]));ae.push(pe)}return ae}}toGeoJSON(ae,Pt,pe){return Pe.call(this,ae,Pt,pe)}}(this._features[Jt])}}(nt.features);let Lt=ls(At);0===Lt.byteOffset&&Lt.byteLength===Lt.buffer.byteLength||(Lt=new Uint8Array(Lt)),q(null,{vectorTile:At,rawData:Lt.buffer})}class Zl extends se.d{constructor(q,X,nt,At,Lt,Jt){super(q,X,nt,At,Fc,Jt),Lt&&(this.loadGeoJSON=Lt)}loadData(q,X){const nt=q&&q.request,At=nt&&nt.collectResourceTiming;this.loadGeoJSON(q,(Lt,Jt)=>{if(Lt||!Jt)return X(Lt);if("object"!=typeof Jt)return X(new Error(`Input data given to '${q.source}' is not a valid GeoJSON object.`));{Zr(Jt,!0);try{if(q.filter){const Pt=se.e(q.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if("error"===Pt.result)throw new Error(Pt.value.map(_e=>`${_e.key}: ${_e.message}`).join(", "));Jt={type:"FeatureCollection",features:Jt.features.filter(_e=>Pt.value.evaluate({zoom:0},_e))}}this._geoJSONIndex=q.cluster?new Rr(function({superclusterOptions:Pt,clusterProperties:pe}){if(!pe||!Pt)return Pt;const _e={},Ee={},Cn={accumulated:null,zoom:0},nr={properties:null},Lr=Object.keys(pe);for(const Jn of Lr){const[Fn,Nn]=pe[Jn],Ii=se.e(Nn),ji=se.e("string"==typeof Fn?[Fn,["accumulated"],["get",Jn]]:Fn);_e[Jn]=Ii.value,Ee[Jn]=ji.value}return Pt.map=Jn=>{nr.properties=Jn;const Fn={};for(const Nn of Lr)Fn[Nn]=_e[Nn].evaluate(Cn,nr);return Fn},Pt.reduce=(Jn,Fn)=>{nr.properties=Fn;for(const Nn of Lr)Cn.accumulated=Jn[Nn],Jn[Nn]=Ee[Nn].evaluate(Cn,nr)},Pt}(q)).load(Jt.features):_n(Jt,q.geojsonVtOptions)}catch(Pt){return X(Pt)}this.loaded={};const ae={};if(At){const Pt=se.f(nt);Pt&&(ae.resourceTiming={},ae.resourceTiming[q.source]=JSON.parse(JSON.stringify(Pt)))}X(null,ae)}})}reloadTile(q,X){const nt=this.loaded;return nt&&nt[q.uid]?super.reloadTile(q,X):this.loadTile(q,X)}loadGeoJSON(q,X){if(q.request)se.h(q.request,X);else{if("string"!=typeof q.data)return X(new Error(`Input data given to '${q.source}' is not a valid GeoJSON object.`));try{return X(null,JSON.parse(q.data))}catch{return X(new Error(`Input data given to '${q.source}' is not a valid GeoJSON object.`))}}}getClusterExpansionZoom(q,X){try{X(null,this._geoJSONIndex.getClusterExpansionZoom(q.clusterId))}catch(nt){X(nt)}}getClusterChildren(q,X){try{X(null,this._geoJSONIndex.getChildren(q.clusterId))}catch(nt){X(nt)}}getClusterLeaves(q,X){try{X(null,this._geoJSONIndex.getLeaves(q.clusterId,q.limit,q.offset))}catch(nt){X(nt)}}}class ei{constructor(q,X){this.tileID=new se.O(q.tileID.overscaledZ,q.tileID.wrap,q.tileID.canonical.z,q.tileID.canonical.x,q.tileID.canonical.y),this.tileZoom=q.tileZoom,this.uid=q.uid,this.zoom=q.zoom,this.canonical=q.tileID.canonical,this.pixelRatio=q.pixelRatio,this.tileSize=q.tileSize,this.source=q.source,this.overscaling=this.tileID.overscaleFactor(),this.projection=q.projection,this.brightness=X}parse(q,X,nt,At){this.status="parsing";const Lt=new se.O(nt.tileID.overscaledZ,nt.tileID.wrap,nt.tileID.canonical.z,nt.tileID.canonical.x,nt.tileID.canonical.y),Jt={},ae=X.familiesBySource[nt.source],Pt=new se.F(Lt,nt.promoteId);return Pt.bucketLayerIDs=[],se.l(q).then(pe=>{if(!pe)return At(new Error("Could not parse tile"));const _e=se.j(pe,1/se.t(nt.tileID.canonical)),Ee=pe.json.extensionsUsed&&pe.json.extensionsUsed.includes("MAPBOX_mesh_features"),Cn=new se.k(this.zoom,{brightness:this.brightness});for(const nr in ae)for(const Lr of ae[nr]){const Jn=Lr[0],Fn=pe.json.extensionsUsed;Jn.recalculate(Cn,[]);const Nn=new se.T(_e,Lt,Fn&&Fn.includes("MAPBOX_mesh_features"),this.brightness);Ee||(Nn.needsUpload=!0),Jt[Jn.fqid]=Nn,Nn.evaluate(Jn)}this.status="done",At(null,{buckets:Jt,featureIndex:Pt})}).catch(pe=>At(new Error(pe.message)))}}class Oo{constructor(q,X,nt,At,Lt,Jt){this.actor=q,this.layerIndex=X,this.brightness=Jt,this.loading={},this.loaded={}}loadTile(q,X){const nt=q.uid,At=this.loading[nt]=new ei(q,this.brightness);se.i(q.request,(Lt,Jt)=>{const ae=!this.loading[nt];return delete this.loading[nt],ae||Lt?(At.status="done",ae||(this.loaded[nt]=At),X(Lt)):Jt&&0!==Jt.byteLength?void At.parse(Jt,this.layerIndex,q,(Pt,pe)=>{At.status="done",this.loaded=this.loaded||{},this.loaded[nt]=At,Pt||!pe?X(Pt):X(null,pe)}):(At.status="done",this.loaded[nt]=At,X())})}reloadTile(q,X){const nt=this.loaded,At=q.uid;if(nt&&nt[At]){const Lt=nt[At];Lt.projection=q.projection,Lt.brightness=q.brightness;const Jt=(ae,Pt)=>{Lt.reloadCallback&&(delete Lt.reloadCallback,this.loadTile(q,X)),X(ae,Pt)};"parsing"===Lt.status?Lt.reloadCallback=Jt:"done"===Lt.status&&this.loadTile(q,X)}}abortTile(q,X){const nt=q.uid;this.loading[nt]&&delete this.loading[nt],X()}removeTile(q,X){const nt=this.loaded,At=q.uid;nt&&nt[At]&&delete nt[At],X()}}class Wl{constructor(q){this.self=q,this.actor=new se.A(q,this),this.layerIndexes={},this.availableImages={},this.isSpriteLoaded={},this.projections={},this.defaultProjection=se.m({name:"mercator"}),this.workerSourceTypes={vector:se.d,geojson:Zl,"batched-model":Oo},this.workerSources={},this.demWorkerSources={},this.self.registerWorkerSource=(X,nt)=>{if(this.workerSourceTypes[X])throw new Error(`Worker source with name "${X}" already registered.`);this.workerSourceTypes[X]=nt},this.self.registerRTLTextPlugin=X=>{if(se.n.isParsed())throw new Error("RTL text plugin already registered.");se.n.applyArabicShaping=X.applyArabicShaping,se.n.processBidirectionalText=X.processBidirectionalText,se.n.processStyledBidirectionalText=X.processStyledBidirectionalText}}clearCaches(q,X,nt){delete this.layerIndexes[q],delete this.availableImages[q],delete this.workerSources[q],delete this.demWorkerSources[q],nt()}checkIfReady(q,X,nt){nt()}setReferrer(q,X){this.referrer=X}spriteLoaded(q,{scope:X,isLoaded:nt}){if(this.isSpriteLoaded[q]||(this.isSpriteLoaded[q]={}),this.isSpriteLoaded[q][X]=nt,this.workerSources[q]&&this.workerSources[q][X])for(const At in this.workerSources[q][X]){const Lt=this.workerSources[q][X][At];for(const Jt in Lt)Lt[Jt]instanceof se.d&&(Lt[Jt].isSpriteLoaded=nt,Lt[Jt].fire(new se.o("isSpriteLoaded")))}}setImages(q,{scope:X,images:nt},At){if(this.availableImages[q]||(this.availableImages[q]={}),this.availableImages[q][X]=nt,this.workerSources[q]&&this.workerSources[q][X]){for(const Lt in this.workerSources[q][X]){const Jt=this.workerSources[q][X][Lt];for(const ae in Jt)Jt[ae].availableImages=nt}At()}else At()}setProjection(q,X){this.projections[q]=se.m(X)}setBrightness(q,X,nt){this.brightness=X,nt()}setLayers(q,X,nt){this.getLayerIndex(q,X.scope).replace(X.layers,X.options),nt()}updateLayers(q,X,nt){this.getLayerIndex(q,X.scope).update(X.layers,X.removedIds,X.options),nt()}loadTile(q,X,nt){X.projection=this.projections[q]||this.defaultProjection,this.getWorkerSource(q,X.type,X.source,X.scope).loadTile(X,nt)}loadDEMTile(q,X,nt){this.getDEMWorkerSource(q,X.source,X.scope).loadTile(X,nt)}reloadTile(q,X,nt){X.projection=this.projections[q]||this.defaultProjection,this.getWorkerSource(q,X.type,X.source,X.scope).reloadTile(X,nt)}abortTile(q,X,nt){this.getWorkerSource(q,X.type,X.source,X.scope).abortTile(X,nt)}removeTile(q,X,nt){this.getWorkerSource(q,X.type,X.source,X.scope).removeTile(X,nt)}removeSource(q,X,nt){if(!(this.workerSources[q]&&this.workerSources[q][X.scope]&&this.workerSources[q][X.scope][X.type]&&this.workerSources[q][X.scope][X.type][X.source]))return;const At=this.workerSources[q][X.scope][X.type][X.source];delete this.workerSources[q][X.scope][X.type][X.source],void 0!==At.removeSource?At.removeSource(X,nt):nt()}loadWorkerSource(q,X,nt){try{this.self.importScripts(X.url),nt()}catch(At){nt(At.toString())}}syncRTLPluginState(q,X,nt){try{se.n.setState(X);const At=se.n.getPluginURL();if(se.n.isLoaded()&&!se.n.isParsed()&&null!=At){this.self.importScripts(At);const Lt=se.n.isParsed();nt(Lt?void 0:new Error(`RTL Text Plugin failed to import scripts from ${At}`),Lt)}}catch(At){nt(At.toString())}}setDracoUrl(q,X){this.dracoUrl=X}getAvailableImages(q,X){this.availableImages[q]||(this.availableImages[q]={});let nt=this.availableImages[q][X];return nt||(nt=[]),nt}getLayerIndex(q,X){this.layerIndexes[q]||(this.layerIndexes[q]={});let nt=this.layerIndexes[q][X];return nt||(nt=this.layerIndexes[q][X]=new Po,nt.scope=X),nt}getWorkerSource(q,X,nt,At){return this.workerSources[q]||(this.workerSources[q]={}),this.workerSources[q][At]||(this.workerSources[q][At]={}),this.workerSources[q][At][X]||(this.workerSources[q][At][X]={}),this.isSpriteLoaded[q]||(this.isSpriteLoaded[q]={}),this.workerSources[q][At][X][nt]||(this.workerSources[q][At][X][nt]=new this.workerSourceTypes[X]({send:(Jt,ae,Pt,pe,_e,Ee)=>{this.actor.send(Jt,ae,Pt,q,_e,Ee)},scheduler:this.actor.scheduler},this.getLayerIndex(q,At),this.getAvailableImages(q,At),this.isSpriteLoaded[q][At],void 0,this.brightness)),this.workerSources[q][At][X][nt]}getDEMWorkerSource(q,X,nt){return this.demWorkerSources[q]||(this.demWorkerSources[q]={}),this.demWorkerSources[q][nt]||(this.demWorkerSources[q][nt]={}),this.demWorkerSources[q][nt][X]||(this.demWorkerSources[q][nt][X]=new Te),this.demWorkerSources[q][nt][X]}enforceCacheSizeLimit(q,X){se.q(X)}getWorkerPerformanceMetrics(q,X,nt){nt(void 0,void 0)}}return typeof WorkerGlobalScope<"u"&&typeof self<"u"&&self instanceof WorkerGlobalScope&&(self.worker=new Wl(self)),Wl}),Hl(0,function(se){return se.s}),Ur}()}},Zd=>{Zd(Zd.s=816)}]);